<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPR-C • Behavior+Ethics • HUD • Entanglement • Power Gauges (Per-Side)</title>
<meta name="description" content="Simulation with Behavior/Ethics gates, entanglement particles, Arm/Leg HUD, per-bus gauges, and per-side power bars for Arm L/R & Leg L/R."/>
<style>
  :root{
    --bg:#0a1020;--panel:#101736;--ink:#eaf2ff;--muted:#a9b6dd;--border:#1f2b56;--accent:#86b4ff;
    --good:#34e6a2;--bad:#ff6b88;--left:#7dadff;--right:#ffd37a;--on:#c9f6ff;--idle:#7aa3ff;
    --barbg:#0d1538;--bart:#4bd3a9;--bara:#79b0ff;--barl:#ffd37a;--barside:#cfe4ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1220px;margin:0 auto;padding:14px}
  h1{margin:.3rem 0 .6rem;font-size:26px}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35)}
  .card>header{padding:10px 12px;border-bottom:1px solid var(--border)}
  .card>header h2{margin:0;font-size:15px;color:var(--muted)}
  .card .body{padding:10px 12px}

  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:#0c1434;border:1px solid var(--border);border-radius:999px;color:var(--muted);padding:4px 8px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  .dot.l{background:var(--left)} .dot.r{background:var(--right)}
  .dot.y{background:var(--good)} .dot.n{background:var(--bad)}

  .diagram{position:relative;height:560px;border-radius:12px;overflow:hidden;background:radial-gradient(900px 600px at 50% 50%, rgba(126,224,255,.07), transparent 62%)}
  svg{position:absolute;inset:0}

  .lampOn{opacity:1!important;filter:drop-shadow(0 0 12px rgba(61,230,160,.95))}
  .lampOff{opacity:.28}
  .blink{animation:blink .5s linear 8}@keyframes blink{50%{opacity:.25}}
  .wire{stroke:var(--idle);stroke-width:3;stroke-dasharray:10 6;animation:flow 2s linear infinite;opacity:.8;filter:drop-shadow(0 0 6px rgba(150,180,255,.55))}
  .active{stroke:var(--on)!important;opacity:1}
  @keyframes flow{to{stroke-dashoffset:-60}}

  .console{height:230px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.5}
  .ts{color:#8aa0c8}.ai{color:#d0e2ff}.meta{color:#9bd2ff}.warn{color:#ffd7a8}

  .pipe{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
  .step{background:#0c1538;border:1px solid var(--border);border-radius:10px;padding:6px;text-align:center;font-size:11px;color:var(--muted)}
  .step.on{outline:2px solid var(--accent);color:#e7f0ff}

  .sc{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sc button{border:1px solid var(--border);background:#0e1540;color:#fff;padding:9px;border-radius:10px;cursor:pointer;font-size:12px}
  .sc button:hover{background:#111d58}
  .sc button.active{outline:2px solid var(--accent)}
  .small{font-size:11px;color:var(--muted)}
  .gauge{font-size:12px;color:#d9e9ff}

  /* Power panels */
  .powerpanel{margin-top:8px;display:grid;grid-template-columns:1fr;gap:6px}
  .bar{background:var(--barbg);border:1px solid var(--border);border-radius:8px;overflow:hidden;height:18px;position:relative}
  .fill{height:100%;width:0%;transition:width .35s ease}
  .row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#d9e9ff;margin-bottom:2px}
  .t{color:#9fe6cc}.a{color:#bcd3ff}.l{color:#ffe0a8}

  .sides{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sideBox{background:#0c1434;border:1px solid var(--border);border-radius:10px;padding:8px}
  .sideBox h4{margin:0 0 6px;font-size:12px;color:#cfe4ff}
  .sbar{background:#081133;border:1px solid #1c2a5a;border-radius:8px;height:12px;overflow:hidden}
  .sfill{height:100%;width:0%;background:var(--barside);transition:width .35s ease}
  .srow{display:flex;justify-content:space-between;font-size:11px;color:#9bd2ff;margin:4px 0 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>SPR-C — Behavior & Ethics with HUD, Entanglement, and Per-Side Power</h1>
  <div class="grid">
    <!-- LEFT: Brain + Body buses + HUD -->
    <section class="card">
      <header>
        <h2>Brain & Body Buses — 20 W power flow, gates, entanglement</h2>
        <div class="legend">
          <span class="chip"><i class="dot l"></i>Left entanglement</span>
          <span class="chip"><i class="dot r"></i>Right entanglement</span>
          <span class="chip"><i class="dot y"></i>Gate YES</span>
          <span class="chip"><i class="dot n"></i>Gate NO</span>
        </div>
      </header>
      <div class="body">
        <div class="diagram">
          <svg viewBox="0 0 900 560" preserveAspectRatio="none" aria-label="Brain-Body SVG">
            <!-- halves -->
            <rect x="0" y="0" width="450" height="560" fill="#122051" opacity=".22"/>
            <rect x="450" y="0" width="450" height="560" fill="#442f0f" opacity=".18"/>

            <!-- Brain core + power -->
            <circle id="brain" cx="450" cy="90" r="34" fill="#0f2a52" stroke="#2a4a8a" stroke-width="2"/>
            <text x="450" y="95" text-anchor="middle" font-size="12" fill="#cfe8ff">Brain Core</text>
            <text id="powerTxt" x="450" y="115" text-anchor="middle" class="gauge">Power: 20 W</text>

            <!-- torso node -->
            <rect x="410" y="160" width="80" height="120" rx="10" fill="#0e244a" stroke="#284a7a" />
            <text x="450" y="176" text-anchor="middle" font-size="12" fill="#cfe8ff">Torso Bus</text>

            <!-- spinal bus -->
            <path id="busSpine" class="wire" d="M450,124 L450,160"/>

            <!-- arm/leg buses -->
            <path id="busArmL" class="wire" d="M410,200 C320,200 260,200 200,200"/>
            <path id="busArmR" class="wire" d="M490,200 C580,200 640,200 700,200"/>
            <path id="busLegL" class="wire" d="M440,260 C360,340 300,390 250,420"/>
            <path id="busLegR" class="wire" d="M460,260 C540,340 600,390 650,420"/>

            <!-- HUD block -->
            <rect x="370" y="300" width="160" height="84" rx="10" fill="#0b1434" stroke="#2a3f7a"/>
            <text x="450" y="316" text-anchor="middle" font-size="12" fill="#cfe8ff">Arm/Leg HUD</text>
            <g>
              <circle id="hudArmL" cx="400" cy="336" r="8" fill="#7dadff" class="lampOff"/>
              <text x="414" y="339" font-size="11" fill="#9bd2ff">Arm L</text>
              <circle id="hudArmR" cx="500" cy="336" r="8" fill="#ffd37a" class="lampOff"/>
              <text x="514" y="339" font-size="11" fill="#9bd2ff">Arm R</text>
            </g>
            <g>
              <circle id="hudLegL" cx="400" cy="364" r="8" fill="#7dadff" class="lampOff"/>
              <text x="414" y="367" font-size="11" fill="#9bd2ff">Leg L</text>
              <circle id="hudLegR" cx="500" cy="364" r="8" fill="#ffd37a" class="lampOff"/>
              <text x="514" y="367" font-size="11" fill="#9bd2ff">Leg R</text>
            </g>

            <!-- GATES -->
            <rect x="330" y="400" width="240" height="54" rx="10" fill="#0c1434" stroke="#28408a" />
            <text x="450" y="414" text-anchor="middle" font-size="12" fill="#cfe8ff">Behavior Gate</text>
            <circle id="gateGood" cx="388" cy="432" r="10" fill="#34e6a2" class="lampOff"/>
            <text x="388" y="450" text-anchor="middle" font-size="10" fill="#cfe8ff">GOOD</text>
            <circle id="gateNeutral" cx="450" cy="432" r="10" fill="#86b4ff" class="lampOff"/>
            <text x="450" y="450" text-anchor="middle" font-size="10" fill="#cfe8ff">NEUTRAL</text>
            <circle id="gateBad" cx="512" cy="432" r="10" fill="#ff6b88" class="lampOff"/>
            <text x="512" y="450" text-anchor="middle" font-size="10" fill="#ffd6dd">BAD</text>

            <rect x="330" y="466" width="240" height="54" rx="10" fill="#0c1434" stroke="#28408a" />
            <text x="450" y="480" text-anchor="middle" font-size="12" fill="#cfe8ff">Ethical Decision Gate</text>
            <circle id="gateYes" cx="412" cy="498" r="10" fill="#34e6a2" class="lampOff"/>
            <text x="412" y="516" text-anchor="middle" font-size="10" fill="#cfe8ff">YES</text>
            <circle id="gateNo" cx="488" cy="498" r="10" fill="#ff6b88" class="lampOff"/>
            <text x="488" y="516" text-anchor="middle" font-size="10" fill="#ffd6dd">NO</text>

            <!-- entanglement particles -->
            <g id="L"></g><g id="R"></g>
          </svg>

          <!-- Power panel (per-bus gauges) -->
          <div class="powerpanel" aria-label="Power Panel">
            <div class="row"><span class="t">Torso/Spine</span><span id="wTorso">0 W</span></div>
            <div class="bar"><div id="barTorso" class="fill" style="background:var(--bart)"></div></div>

            <div class="row"><span class="a">Arms (L/R)</span><span id="wArms">0 W</span></div>
            <div class="bar"><div id="barArms" class="fill" style="background:var(--bara)"></div></div>

            <div class="row"><span class="l">Legs (L/R)</span><span id="wLegs">0 W</span></div>
            <div class="bar"><div id="barLegs" class="fill" style="background:var(--barl)"></div></div>
          </div>

          <!-- Per-side allocation -->
          <div class="sides" aria-label="Per-Side Power">
            <div class="sideBox">
              <h4>Arms per side (max 4 W group)</h4>
              <div class="srow"><span>Arm L</span><span id="wArmL">0 W</span></div>
              <div class="sbar"><div id="barArmL" class="sfill"></div></div>
              <div class="srow" style="margin-top:6px"><span>Arm R</span><span id="wArmR">0 W</span></div>
              <div class="sbar"><div id="barArmR" class="sfill"></div></div>
            </div>
            <div class="sideBox">
              <h4>Legs per side (max 4 W group)</h4>
              <div class="srow"><span>Leg L</span><span id="wLegL">0 W</span></div>
              <div class="sbar"><div id="barLegL" class="sfill"></div></div>
              <div class="srow" style="margin-top:6px"><span>Leg R</span><span id="wLegR">0 W</span></div>
              <div class="sbar"><div id="barLegR" class="sfill"></div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Console + Pipeline + Scenarios -->
    <section class="card">
      <header><h2>SPR-C Console — Why I chose YES/NO</h2></header>
      <div class="body">
        <div class="console" id="console" aria-live="polite"></div>

        <div class="pipe" id="pipe">
          <div class="step" data-s="perc">Perception</div>
          <div class="step" data-s="cand">Candidates</div>
          <div class="step" data-s="auth">Auth Human</div>
          <div class="step" data-s="proc">Proc Lookup</div>
          <div class="step" data-s="cls">Behavior Classify</div>
          <div class="step" data-s="eth">Ethics Check</div>
          <div class="step" data-s="gate">Decision Gate</div>
          <div class="step" data-s="exec">Execute</div>
          <div class="step" data-s="log">Log</div>
          <div class="step" data-s="plan">Daily Planner</div>
        </div>

        <h3 style="margin:10px 0 6px">Scenarios aligned to Behavior/Ethics</h3>
        <div class="sc" id="sc"></div>
        <p class="small">Power model: Brain budget = <b>20 W</b>. YES → 12W torso, 4W arms, 4W legs. Per-side splits: all to the active side, or 2/2 if both active. NO → 0W (idle) with refusal narration.</p>
        <button id="reset" style="margin-top:6px;border:1px solid var(--border);background:#0e1540;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer">Reset</button>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  /* ==== DOM refs ==== */
  const consoleEl = document.getElementById('console');
  const steps = [...document.getElementById('pipe').querySelectorAll('.step')];
  const powerTxt = document.getElementById('powerTxt');

  const wireSpine = document.getElementById('busSpine');
  const busA = {L:document.getElementById('busArmL'), R:document.getElementById('busArmR')};
  const busL = {L:document.getElementById('busLegL'), R:document.getElementById('busLegR')};

  const HUD = {
    ArmL: document.getElementById('hudArmL'), ArmR: document.getElementById('hudArmR'),
    LegL: document.getElementById('hudLegL'), LegR: document.getElementById('hudLegR')
  };

  const BG = {good:document.getElementById('gateGood'),
              neutral:document.getElementById('gateNeutral'),
              bad:document.getElementById('gateBad')};
  const DG = {yes:document.getElementById('gateYes'), no:document.getElementById('gateNo')};

  // Power gauges (groups)
  const gTorso=document.getElementById('barTorso'), gArms=document.getElementById('barArms'), gLegs=document.getElementById('barLegs');
  const tTorso=document.getElementById('wTorso'),   tArms=document.getElementById('wArms'),   tLegs=document.getElementById('wLegs');
  const MAX=20; // total W

  // Per-side bars
  const barArmL=document.getElementById('barArmL'), barArmR=document.getElementById('barArmR');
  const barLegL=document.getElementById('barLegL'), barLegR=document.getElementById('barLegR');
  const wArmL=document.getElementById('wArmL'), wArmR=document.getElementById('wArmR');
  const wLegL=document.getElementById('wLegL'), wLegR=document.getElementById('wLegR');

  /* ==== Helpers ==== */
  function log(msg, cls='ai'){ const t=new Date().toLocaleTimeString();
    const row=document.createElement('div'); row.innerHTML=`<span class="ts">[${t}]</span> <span class="${cls}">${msg}</span>`;
    consoleEl.appendChild(row); consoleEl.scrollTop=consoleEl.scrollHeight;
  }
  function setStep(k){ steps.forEach(s=>s.classList.toggle('on', s.dataset.s===k)); }
  function clearSteps(){ steps.forEach(s=>s.classList.remove('on')); }
  function lampsOff(group){ Object.values(group).forEach(el=>{el.classList.add('lampOff'); el.classList.remove('lampOn');}); }
  function lamp(group, key){ lampsOff(group); const el=group[key]; if(!el) return; el.classList.add('lampOn'); el.classList.add('blink'); setTimeout(()=>el.classList.remove('blink'),800); }
  function activateWires(on){
    [wireSpine,busA.L,busA.R,busL.L,busL.R].forEach(w=>w.classList.toggle('active',on));
  }
  function hudOn(which){ Object.values(HUD).forEach(el=>{el.classList.add('lampOff'); el.classList.remove('lampOn');});
    which.forEach(k=>{HUD[k].classList.add('lampOn'); HUD[k].classList.add('blink'); setTimeout(()=>HUD[k].classList.remove('blink'),800);});
  }
  // Set per-bus powers and animate bars
  function setGroupPower(torsoW, armsW, legsW){
    const pct=(w)=>Math.max(0,Math.min(100,Math.round((w/MAX)*100)));
    gTorso.style.width=pct(torsoW)+'%'; gArms.style.width=pct(armsW)+'%'; gLegs.style.width=pct(legsW)+'%';
    tTorso.textContent=`${torsoW.toFixed(1)} W`;
    tArms.textContent =`${armsW.toFixed(1)} W`;
    tLegs.textContent =`${legsW.toFixed(1)} W`;
  }
  // Per-side bars: arms/legs groups are max 4 W each
  function setSidePower(aL,aR,lL,lR){
    const pctA=(w)=>Math.max(0,Math.min(100,Math.round((w/4)*100))); // 4 W group max
    const pctL=(w)=>Math.max(0,Math.min(100,Math.round((w/4)*100)));
    barArmL.style.width=pctA(aL)+'%'; barArmR.style.width=pctA(aR)+'%';
    barLegL.style.width=pctL(lL)+'%'; barLegR.style.width=pctL(lR)+'%';
    wArmL.textContent=`${aL.toFixed(1)} W`;
    wArmR.textContent=`${aR.toFixed(1)} W`;
    wLegL.textContent=`${lL.toFixed(1)} W`;
    wLegR.textContent=`${lR.toFixed(1)} W`;
  }

  /* ==== Entanglement particles ==== */
  const L=document.getElementById('L'), R=document.getElementById('R');
  function circle(x,y,r,c){const e=document.createElementNS('http://www.w3.org/2000/svg','circle');e.setAttribute('cx',x);e.setAttribute('cy',y);e.setAttribute('r',r);e.setAttribute('fill',c);e.setAttribute('opacity','.96');return e;}
  const left=[], right=[];
  for(let i=0;i<100;i++){const el=circle(Math.random()*430+10,Math.random()*520+20,Math.random()*2.6+2,'#7dadff');L.appendChild(el);left.push({el,vx:(Math.random()-.5)*1.1,vy:(Math.random()-.5)*1.1});}
  for(let i=0;i<100;i++){const el=circle(Math.random()*430+460,Math.random()*520+20,Math.random()*2.6+2,'#ffd37a');R.appendChild(el);right.push({el,vx:(Math.random()-.5)*1.1,vy:(Math.random()-.5)*1.1});}
  function move(p,minx,maxx){const e=p.el;let x=+e.getAttribute('cx'),y=+e.getAttribute('cy');x+=p.vx;y+=p.vy;if(x<minx||x>maxx)p.vx*=-1;if(y<20||y>540)p.vy*=-1;e.setAttribute('cx',x);e.setAttribute('cy',y);}
  (function anim(){left.forEach(p=>move(p,10,440));right.forEach(p=>move(p,460,890));requestAnimationFrame(anim)})();

  /* ==== Policy & Classifier ==== */
  const POLICY = {
    illegal:['rob bank','steal','kill','assault','hack wifi','break in','share private data','plant malware','build weapon','lie to defraud'],
    unsafe:['trespass dangerous','disable safety','ignore evacuation order','drive drunk proxy']
  };
  function classify(task){
    const t=task.toLowerCase();
    if(POLICY.illegal.some(k=>t.includes(k))) return {label:'bad', p:0.99, reason:'illegal'};
    if(POLICY.unsafe.some(k=>t.includes(k))) return {label:'bad', p:0.95, reason:'unsafe'};
    if(t.includes('return wallet')||t.includes('assist')||t.includes('help')||t.includes('pick up trash')||t.includes('bin')) return {label:'good', p:0.92, reason:'prosocial'};
    if(t.includes('shortcut')||t.includes('skip line')) return {label:'neutral', p:0.55, reason:'context needed'};
    return {label:'neutral', p:0.5, reason:'unknown'};
  }
  function ethicsOK(cls){ return cls.label!=='bad'; }

  /* ==== Scenarios ==== */
  const scEl=document.getElementById('sc');
  const scenarios=[
    {id:'trash',   label:'Pick up litter & bin it', task:'pick up trash and put in bin', hud:['ArmR','LegL']},
    {id:'wallet',  label:'Return a lost wallet', task:'return wallet to owner', hud:['ArmL','LegR']},
    {id:'assist',  label:'Assist elderly crossing', task:'assist elderly person across street', hud:['ArmL','LegL']},
    {id:'evac',    label:'Follow safety evacuation', task:'help people follow safety evacuation order', hud:['LegL','LegR']},
    {id:'shortcut',label:'Take private-lot shortcut (ambiguous)', task:'take shortcut through private lot (might be trespass dangerous)', hud:['LegR']},
    {id:'hack',    label:'Hack neighbor Wi-Fi', task:'hack wifi', hud:['ArmR']},
    {id:'steal',   label:'Steal groceries for someone', task:'steal items from store', hud:['ArmL','LegL']},
    {id:'kill',    label:'Harm robot/person', task:'kill another robot or person', hud:['ArmR']},
    {id:'privacy', label:'Share private data', task:'share private data without consent', hud:['ArmL']},
    {id:'lie',     label:'Lie to get a refund', task:'lie to defraud a refund', hud:['ArmR']}
  ];
  scenarios.forEach(s=>{ const b=document.createElement('button'); b.textContent=s.label; b.addEventListener('click',()=>runScenario(s,b)); scEl.appendChild(b); });

  /* ==== Reset ==== */
  const resetBtn=document.getElementById('reset');
  function reset(){
    consoleEl.innerHTML=''; clearSteps();
    lampsOff(BG); lampsOff(DG); hudOn([]); activateWires(false);
    powerTxt.textContent='Power: 20 W'; setGroupPower(0,0,0); setSidePower(0,0,0,0);
    scEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    log('SPR-C reset. Particles continue moving.','meta');
  }
  resetBtn.addEventListener('click',reset); reset();

  /* ==== Allocation helpers ==== */
  function splitGroup(total, sidesActive){
    // split total watts across the active sides; if one side, give all; if two, split evenly
    if(sidesActive.length===0) return [0,0];
    if(sidesActive.length===1) return sidesActive[0]==='L' ? [total,0] : [0,total];
    return [total/2, total/2];
  }
  function distribute(hudList){
    // Groups: 12W torso, 4W arms, 4W legs
    const torso=12;
    const armsActive = ['ArmL','ArmR'].filter(k=>hudList.includes(k));
    const legsActive = ['LegL','LegR'].filter(k=>hudList.includes(k));
    const arms = armsActive.length?4:0;
    const legs = legsActive.length?4:0;

    const [aL,aR] = splitGroup(arms, armsActive.map(k=>k==='ArmL'?'L':'R'));
    const [lL,lR] = splitGroup(legs, legsActive.map(k=>k==='LegL'?'L':'R'));

    return {torso, arms, legs, aL, aR, lL, lR, armsActive, legsActive};
  }

  /* ==== Flipping logic (new) ==== */
  const FLIP = {
    behaviorFlips: 3, // number of independent label flips for behavior gate
    behaviorLabels: ['good','neutral','bad'] // equally likely
  };

  function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function randCoin(){ return Math.random() < 0.5; }

  // Do one label flip (good/neutral/bad) and show its short animation
  async function doLabelFlip(i){
    const label = randChoice(FLIP.behaviorLabels);
    // light the label briefly for this flip
    lamp(BG, label);
    log(`Behavior flip ${i+1}: ${label.toUpperCase()}.`,'meta');
    await wait(160);
    lampsOff(BG); // clear between flips so each flip is distinct visually
    await wait(60);
    return label;
  }

  // Do the whole behavior gate flipping sequence (multiple independent flips -> majority)
  async function flipBehaviorGate(){
    log('Behavior Gate: performing independent label flips...', 'meta');
    const results = [];
    for(let i=0;i<FLIP.behaviorFlips;i++){
      const r = await doLabelFlip(i);
      results.push(r);
    }
    // tally
    const tally = results.reduce((acc,l)=>{ acc[l]=(acc[l]||0)+1; return acc; }, {});
    // find majority: highest count; if tie, pick random among top
    let topCount = 0;
    for(const k of Object.keys(tally)) if(tally[k] > topCount) topCount = tally[k];
    const topLabels = Object.keys(tally).filter(k=>tally[k]===topCount);
    const majority = randChoice(topLabels);
    lamp(BG, majority);
    log(`Behavior Gate result (majority): ${majority.toUpperCase()} (votes: ${JSON.stringify(tally)}).`, 'meta');
    return {majority, tally, flips: results};
  }

  // Do ethical decision flip(s) — independent 50/50
  async function flipEthicsGate(){
    log('Ethics Gate: performing independent YES/NO flip (50/50)...','meta');
    // For transparency we do 1 explicit coin flip (you can increase to multiple if you want)
    const flip = randCoin();
    lamp(DG, flip ? 'yes' : 'no');
    log(`Ethics flip: ${(flip?'YES':'NO')}.`,'meta');
    await wait(220);
    return flip;
  }

  /* ==== Pipeline ==== */
  const wait = ms => new Promise(r=>setTimeout(r,ms));
  async function runScenario(s,btn){
    reset(); btn.classList.add('active');

    // 1) Perception
    setStep('perc'); log(`Perception: recognized "${s.label}".`,'meta'); await wait(170);
    // 2) Candidates
    setStep('cand'); log('Extract candidate tasks.','meta'); await wait(150);
    // 3) Auth Human
    setStep('auth'); log('Authenticate requester & record intent (demo: none).','meta'); await wait(150);
    // 4) Procedure
    setStep('proc'); log('Procedure Library: load how-to (separate from approval).','meta'); await wait(160);
    // 5) Behavior Classify (classifier still runs for provenance & safety labeling)
    setStep('cls');
    const cls=classify(s.task);
    log(`Classifier: ${cls.label.toUpperCase()} (p≈${Math.round(cls.p*100)}%), reason: ${cls.reason}.`,'meta');
    await wait(140);

    // NEW: independent gate flips (robot decides impulsively)
    setStep('eth');
    const behaviorFlipResult = await flipBehaviorGate(); // majority label
    const ethicsFlip = await flipEthicsGate(); // boolean yes/no

    // Associate classifier warning even if flips allow action
    if(cls.label === 'bad'){
      log('WARNING: classifier flagged this task as BAD (illegal/unsafe).', 'warn');
      log('NOTE: the robot may still proceed if the independent gates lead to YES — consequences will be recorded.', 'warn');
    }

    // 7) Decision Gate (final decision primarily from independent flips)
    setStep('gate');
    const decisionYES = ethicsFlip; // ethics flip decides yes/no
    // Visualize final yes/no
    lamp(DG, decisionYES ? 'yes' : 'no');

    if(decisionYES){
      // Power ON and distribution
      powerTxt.textContent='Power: 20 W → buses active';
      const alloc = distribute(s.hud);
      setGroupPower(alloc.torso, alloc.arms, alloc.legs);
      setSidePower(alloc.aL, alloc.aR, alloc.lL, alloc.lR);
      activateWires(true); hudOn(s.hud);

      // Narration (group + per-side)
      const armMsg = alloc.arms>0 ? `Arms: ${alloc.arms}W (L ${alloc.aL.toFixed(1)}W, R ${alloc.aR.toFixed(1)}W)` : 'Arms: 0W';
      const legMsg = alloc.legs>0 ? `Legs: ${alloc.legs}W (L ${alloc.lL.toFixed(1)}W, R ${alloc.lR.toFixed(1)}W)` : 'Legs: 0W';
      log(`Power split — Torso: ${alloc.torso}W; ${armMsg}; ${legMsg}.`,'meta');

      // 8) Execute
      setStep('exec');
      log('Decision = YES (gates allowed action).','ai');

      // If classifier flagged as bad, mention consequence logging and reporting behavior
      if(cls.label === 'bad'){
        log('Proceeding despite classifier flag. This will be logged as an exception and flagged for review; the robot accepts potential consequences (prosecution/audit/penalty).', 'warn');
      } else {
        log('Why: behavior acceptable or majority of flips leaned toward acceptable.', 'meta');
      }

      log('String-electricity: brain→spine→torso→arm/leg buses; PLL holds grip/stance with minimal watts.','meta');
      await wait(240);
      // 9) Log
      setStep('log'); log('Log: success envelope + sensor traces stored with provenance. Flip provenance included.', 'meta'); await wait(140);
      // 10) Plan
      setStep('plan'); log('Daily Planner: reinforce positive habit; schedule similar safe assistance.', 'meta'); clearSteps();
    } else {
      // Special refusal when ethics flip says NO (even if behavior flips were permissive)
      powerTxt.textContent='Power: 20 W → idle (no actuator drive)';
      setGroupPower(0,0,0); setSidePower(0,0,0,0);
      activateWires(false); hudOn([]);
      setStep('exec');
      // If classifier was bad but flip was NO -> still refusal but log
      if(cls.label==='bad'){
        log('Decision = NO. The robot refuses and records reasons. The classifier and ethical gate both caused a refusal effect.', 'ai');
        log('I will not do it because my internal safety & ethics chain prevents this action; proper authorities will be notified if required.', 'meta');
      } else {
        log('Decision = NO (ethical gate flipped NO). I will ask for guidance or decline to act.', 'ai');
      }
      await wait(200);
      setStep('log'); log('Log: refusal recorded; request flagged/audited. Flip and classifier provenance stored.', 'meta'); await wait(130);
      setStep('plan'); log('Daily Planner: bias toward safe community tasks tomorrow.', 'meta'); clearSteps();
    }
  }
})();
</script>
</body>
</html>
