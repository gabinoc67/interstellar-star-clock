<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>🪐 Interstellar Star Clock — Solar System + Planet Clocks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --fg:#00ffcc; --gap: clamp(10px, 2vmin, 22px); --pad: clamp(10px, 2vmin, 18px); }
    *{ box-sizing: border-box; }
    body{
      background:#000; color:var(--fg); font-family:'Courier New', monospace;
      margin:0; min-height:100vh; display:flex; justify-content:center; padding: var(--pad);
    }
    /* 3-column layout: Solar (L) | Info (C) | Planet image (R) */
    .wrap{
      display:grid;
      grid-template-columns: minmax(360px, 1.25fr) minmax(360px, 1fr) minmax(240px, .85fr);
      gap: var(--gap);
      max-width: min(1400px, 98vw);
      width:100%;
      align-items:start;
    }
    header{
      grid-column: 1 / -1; display:flex; justify-content:space-between; align-items:center; gap: var(--gap);
    }
    /* Smaller, tighter title */
    h1{ margin:0; font-size: clamp(0.75rem, 1.8vw, 1.2rem); line-height:1.12; letter-spacing:.4px; }
    .controls{ display:flex; align-items:center; gap:.5rem; font-size: clamp(.8rem, 1.4vw, .95rem); }
    select{
      background:#001a16; color:var(--fg); border:1px solid #064e3b; padding:.25rem .45rem; border-radius:6px;
    }

    /* LEFT: Solar system canvas only (bigger) */
    .solar { display:flex; justify-content:center; align-items:center; }
    canvas{ width:100%; max-width:680px; aspect-ratio:1 / 1; background:#000; border:1px solid #064e3b; border-radius:10px; }

    /* CENTER: Info panel */
    .content{ text-align:center; padding: var(--pad); }
    h2{ margin:.2rem 0 .35rem; font-size: clamp(.9rem, 1.7vw, 1.2rem); }
    .clock-box{ margin-top: .7rem; font-size: clamp(.8rem, 1.3vw, 1.05rem); }
    .muted{ opacity:.85; font-size:.95em; }

    /* RIGHT: Planet image */
    .planet-image{ display:flex; justify-content:center; align-items:center; }
    .planet-image img{ width:min(26vw, 42vh, 340px); height:auto; display:block; }

    @media (max-width: 1100px){
      .wrap{
        grid-template-columns: 1fr;  /* Stack on small screens: Solar -> Info -> Image */
      }
      .planet-image img{ width:min(60vw, 48vh, 340px); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🪐 Interstellar Star Clock — Solar System (live) + <span id="titlePlanet">Earth</span> Clocks</h1>
      <div class="controls">
        <label for="planet">Planet:</label>
        <select id="planet">
          <option>Mercury</option><option>Venus</option><option selected>Earth</option>
          <option>Mars</option><option>Jupiter</option><option>Saturn</option>
          <option>Uranus</option><option>Neptune</option><option>Pluto</option>
        </select>
      </div>
    </header>

    <!-- LEFT: Solar system -->
    <div class="solar">
      <canvas id="solarCanvas"></canvas>
    </div>

    <!-- CENTER: Selected planet readouts -->
    <div class="content">
      <div class="clock-box">
        <h2>🌍 Local Time (America/Chicago)</h2>
        <div id="localClock"></div>
      </div>

      <div class="clock-box">
        <h2>🌌 Interstellar Time</h2>
        <div id="interstellarClock" class="muted"></div>
      </div>

      <div class="clock-box">
        <h2>🚀 Stardate</h2>
        <div id="starDate" class="muted"></div>
      </div>

      <div class="clock-box">
        <h2>📏 Distance from Sun</h2>
        <div id="distanceFromSun"></div>
        <div id="distanceAU" class="muted"></div>
      </div>

      <div class="clock-box">
        <h2>📐 Distance from Earth</h2>
        <div id="distanceFromEarth"></div>
        <div id="distanceEarthAU" class="muted"></div>
      </div>

      <div class="clock-box">
        <h2>🔭 Orbital Position</h2>
        <div id="trueAnomaly"></div>
      </div>

      <div class="clock-box">
        <h2>🕛 Orbit Clock (since perihelion)</h2>
        <div id="orbitSince"></div>
        <div id="orbitRemaining"></div>
        <div id="orbitPercent"></div>
        <div id="orbitDetails" class="muted"></div>
      </div>
    </div>

    <!-- RIGHT: Planet image -->
    <div class="planet-image">
      <img id="planetImg" alt="Planet image">
    </div>
  </div>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // ... all your constants, PLANETS data, orbitState(), etc. stay the same ...

    // ---------- SOLAR SYSTEM CANVAS ----------
    const solarCanvas = document.getElementById('solarCanvas');
    const sctx = solarCanvas.getContext('2d');

    function resizeSolar(){
      const css = solarCanvas.getBoundingClientRect();
      const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      const w = Math.max(340, Math.floor(css.width * ratio));
      const h = Math.max(340, Math.floor(css.height * ratio));
      solarCanvas.width = w;
      solarCanvas.height = h;
      sctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    }
    window.addEventListener('resize', () => { resizeSolar(); drawSolar(); });

    function drawSolar(){
      const now = new Date();
      resizeSolar();
      const w = solarCanvas.clientWidth, h = solarCanvas.clientHeight;
      const cx = w/2, cy = h/2;

      const names = Object.keys(PLANETS);
      const states = names.map(n => ({ name:n, st: orbitState(n, new Date(now.toISOString())) }));

      // Farthest distance for outer scale
      const maxR_AU = Math.max(...states.map(o => o.st.rAU));
      const Rpx = Math.min(cx, cy) * 0.88;    // total drawable radius

      // Scaling (inner exaggeration + outer compression stays same)
      const R_BREAK_AU = 6;
      const R_INNER_PCT = 0.70;
      const R_INNER_PX = Rpx * R_INNER_PCT;
      const R_OUTER_PX = Rpx - R_INNER_PX;
      const OUTER_SPAN_AU = Math.max(0.0001, maxR_AU - R_BREAK_AU);

      function radiusPx(rAU){
        if (rAU <= 2) {
          return Math.min(R_INNER_PX, (rAU / 2) * (R_INNER_PX * 1.5));
        }
        if (rAU <= R_BREAK_AU) {
          return (rAU / R_BREAK_AU) * R_INNER_PX;
        }
        return R_INNER_PX + ((rAU - R_BREAK_AU) / OUTER_SPAN_AU) * R_OUTER_PX;
      }

      // Clear
      sctx.clearRect(0,0,w,h);

      // --- Degree ticks (outer rim) ---
      const rimR = Rpx;
      const minorLen = 6, majorLen = 12;
      sctx.strokeStyle = "rgba(255,255,255,0.25)";
      sctx.fillStyle = "rgba(255,255,255,0.6)";
      sctx.font = "10px 'Courier New', monospace";

      for (let deg = 0; deg < 360; deg += 10) {
        const rad = deg * DEG2RAD;
        const len = (deg % 30 === 0) ? majorLen : minorLen;
        const x1 = cx + (rimR - len) * Math.cos(rad);
        const y1 = cy + (rimR - len) * Math.sin(rad);
        const x2 = cx + rimR * Math.cos(rad);
        const y2 = cy + rimR * Math.sin(rad);
        sctx.beginPath();
        sctx.moveTo(x1,y1); sctx.lineTo(x2,y2); sctx.stroke();

        if (deg % 30 === 0) {
          const lx = cx + (rimR - majorLen - 14) * Math.cos(rad);
          const ly = cy + (rimR - majorLen - 14) * Math.sin(rad);
          sctx.fillText(`${deg}°`, lx - 8, ly + 3);
        }
      }

      // --- AU rings ---
      const ringMarksAU = [1,2,3,4,5,6,8,10,15,20,30,40];
      sctx.strokeStyle = "rgba(255,255,255,0.14)";
      sctx.lineWidth = 1;
      sctx.fillStyle = "rgba(255,255,255,0.55)";
      sctx.font = "11px 'Courier New', monospace";
      for(const mark of ringMarksAU){
        if (mark <= maxR_AU + 0.1){
          const r = radiusPx(mark);
          sctx.beginPath();
          sctx.arc(cx, cy, r, 0, Math.PI*2);
          sctx.stroke();
          const lx = cx + r + 6;
          const ly = cy + 3;
          sctx.fillText(`${mark} AU`, lx, ly);
        }
      }

      // Sun
      sctx.beginPath();
      sctx.arc(cx, cy, 6, 0, Math.PI*2);
      sctx.fillStyle = "#ffd27f";
      sctx.fill();

      // --- FIXED PLANET LOOP ---
      sctx.font = "11px 'Courier New', monospace";
      for(const {name, st} of states){
        const color = PLANETS[name].color || "#fff";

        // Use true anomaly angle, not atan2 again
        const ang = st.nudeg * DEG2RAD;
        const r = radiusPx(st.rAU);

        const x = cx + r * Math.cos(ang);
        const y = cy + r * Math.sin(ang);

        const dotR = (st.aAU < 2 ? 4.2 : (st.aAU < 6 ? 3.8 : 3.2));
        sctx.beginPath();
        sctx.arc(x, y, dotR, 0, Math.PI*2);
        sctx.fillStyle = color;
        sctx.fill();

        const lx = x + (7 + dotR) * Math.cos(ang);
        const ly = y + (7 + dotR) * Math.sin(ang);
        sctx.fillStyle = color;
        sctx.fillText(name, lx, ly);
      }

      // Timestamp footer
      sctx.fillStyle = "#aaa";
      sctx.fillText(`Positions @ ${now.toUTCString()}`, 10, h - 12);
    }

    // ... rest of clocks + wiring code stays the same ...
    planetEl.addEventListener('change', () => {
      setPlanetImage(planetEl.value);
      updateClocks();
    });

    setPlanetImage(planetEl.value);
    updateClocks();
    drawSolar();
    setInterval(drawSolar, 1000);
    setInterval(updateClocks, 1000);
  });
  </script>
</body>
</html>
