<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>STEM Workbench — Scientific Calculator • Word Problems • Image→Diagram</title>
<style>
  :root{
    --bg:#f7f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280;
    --accent:#4f46e5; --accent-2:#10b981; --warn:#ef4444; --amber:#f59e0b;
    --ring:#d1d5db;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; padding:24px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
    background:var(--bg); color:var(--ink);
  }
  h1{ margin:0 0 8px; font-size:clamp(22px,3vw,30px); }
  p.lead{ color:var(--muted); margin:0 0 18px; }

  /* Layout */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
  .tab-btn{
    border:1px solid var(--ring); padding:10px 14px; border-radius:999px; background:#fff; cursor:pointer; font-weight:700;
  }
  .tab-btn.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
  .panel{ display:none; }
  .panel.active{ display:block; }

  .card{ background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px;
         box-shadow:0 4px 12px rgba(0,0,0,.04); }
  .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
  .display{
    min-height:56px; padding:10px 12px; border:1px solid var(--ring); border-radius:12px; background:#f9fafb;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    display:flex; align-items:center; overflow:auto;
  }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .grid{ display:grid; gap:8px; }
  .keys{ grid-template-columns:repeat(6,1fr); }
  .btn{
    cursor:pointer; border:none; border-radius:12px; padding:10px 12px; font-weight:600;
    background:#e5e7eb; color:#111; box-shadow:0 2px 0 rgba(0,0,0,.06);
    transition:transform .05s ease, background .15s ease;
  }
  .btn:hover{ background:#dbe1e8; }
  .btn:active{ transform:translateY(1px); }
  .btn.accent{ background:var(--accent); color:#fff; }
  .btn.green{ background:var(--accent-2); color:#fff; }
  .btn.warn{ background:var(--warn); color:#fff; }
  .btn.ghost{ background:#fff; border:1px solid var(--ring); }
  .btn.span2{ grid-column:span 2; }

  .tag{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--ring);
        border-radius:999px; font-size:12px; color:var(--muted); background:#fff; }
  .switch{ display:inline-flex; gap:6px; align-items:center; }
  .switch input{ appearance:none; width:38px; height:22px; background:#d1d5db; border-radius:999px; position:relative; outline:none; cursor:pointer; }
  .switch input:checked{ background:var(--accent); }
  .switch input:before{
    content:""; position:absolute; width:18px; height:18px; top:2px; left:2px; border-radius:999px; background:#fff; transition:left .15s ease;
  }
  .switch input:checked:before{ left:18px; }

  .kv{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .kv .k{ color:var(--muted); font-size:13px; }
  .kv .v{ font-weight:700; font-family:ui-monospace, Menlo, Consolas, "Courier New"; }

  .steps{ max-height:340px; overflow:auto; border:1px solid var(--ring); border-radius:12px; padding:10px; background:#ffffff; }
  .step{ padding:8px 10px; border-radius:10px; border:1px dashed #e5e7eb; background:#fafafa; }
  .step + .step{ margin-top:8px; }
  .step .t{ font-size:12px; color:var(--muted); margin-bottom:4px; }
  .code{ background:#f3f4f6; padding:2px 6px; border-radius:6px; font-family:ui-monospace, Menlo, Consolas, "Courier New"; }
  .tiny{ font-size:12px; color:var(--muted); }

  /* Library */
  .lib-top{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  select, input[type="text"], textarea{
    padding:8px 10px; border:1px solid var(--ring); border-radius:10px; background:#fff;
  }
  textarea{ width:100%; min-height:120px; }

  .eq-list{ margin-top:12px; display:grid; gap:10px; }
  .eq-item{ border:1px solid var(--ring); border-radius:12px; padding:10px; background:#fff; }
  .eq-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .eq-title{ font-weight:700; }
  .eq-tex{ margin-top:8px; padding:8px; background:#f9fafb; border-radius:10px; overflow:auto; }

  /* Image panel */
  .img-wrap{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media (max-width:1000px){ .img-wrap{ grid-template-columns:1fr; } }
  canvas{ width:100%; max-width:100%; background:#fff; border:1px solid var(--ring); border-radius:12px; }
  .bar{ width:100%; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
  .fill{ height:8px; background:var(--accent); width:0%; }

  /* Print */
  @media print{
    body{ background:#fff; }
    .tabs, .tab-btn{ display:none !important; }
    .panel{ display:block !important; }
    .no-print{ display:none !important; }
    .steps{ max-height:none; }
  }
</style>

<!-- MathJax for LaTeX rendering -->
<script>
  window.MathJax = { tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]} };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <h1>STEM Workbench — Scientific Calculator • Word Problems • Image→Diagram</h1>
  <p class="lead">Each tool works independently and shows <b>step-by-step</b> reasoning. You can print steps from the Word-Problem and Image panels.</p>

  <!-- Tabs -->
  <div class="tabs no-print">
    <button class="tab-btn active" data-tab="calc">Scientific Calculator</button>
    <button class="tab-btn" data-tab="word">Word-Problem Solver</button>
    <button class="tab-btn" data-tab="image">Image→Diagram Analyzer</button>
  </div>

  <!-- ===================== PANEL 1: CALCULATOR ===================== -->
  <section id="calc" class="panel active">
    <div class="card" style="margin-bottom:12px">
      <div class="label">Expression</div>
      <div class="display" id="display" aria-live="polite">(empty)</div>

      <div class="row" style="margin-top:10px">
        <span class="tag">Result Label: <span class="code" id="resultLabel">—</span></span>
        <span class="tag">ANS: <span class="code" id="ansLabel">—</span></span>
        <label class="switch tag" title="Toggle Degrees / Radians">
          <input type="checkbox" id="degToggle" checked />
          <span>DEG</span>
        </label>
      </div>

      <!-- Keypad -->
      <div class="grid keys" style="margin-top:12px">
        <!-- Row 1: scientific -->
        <button class="btn" data-k="sin(">sin</button>
        <button class="btn" data-k="cos(">cos</button>
        <button class="btn" data-k="tan(">tan</button>
        <button class="btn" data-k="asin(">asin</button>
        <button class="btn" data-k="acos(">acos</button>
        <button class="btn" data-k="atan(">atan</button>

        <!-- Row 2 -->
        <button class="btn" data-k="log(">log</button>
        <button class="btn" data-k="ln(">ln</button>
        <button class="btn" data-k="sqrt(">√</button>
        <button class="btn" data-k="cbrt(">∛</button>
        <button class="btn" data-k="^">x^y</button>
        <button class="btn" id="sqBtn">x²</button>

        <!-- Row 3 -->
        <button class="btn" id="cubeBtn">x³</button>
        <button class="btn" id="factBtn">n!</button>
        <button class="btn" id="nPrBtn">nPr</button>
        <button class="btn" id="nCrBtn">nCr</button>
        <button class="btn" data-k="PI">π</button>
        <button class="btn" data-k="E">e</button>

        <!-- Row 4 -->
        <button class="btn warn" id="clearBtn">C</button>
        <button class="btn warn" id="delBtn">DEL</button>
        <button class="btn" data-k="(">(</button>
        <button class="btn" data-k=")">)</button>
        <button class="btn" id="pmBtn">±</button>
        <button class="btn" id="ansBtn">ANS</button>

        <!-- Row 5 -->
        <button class="btn" data-k="7">7</button>
        <button class="btn" data-k="8">8</button>
        <button class="btn" data-k="9">9</button>
        <button class="btn" data-k="/">÷</button>
        <button class="btn" data-k="*">×</button>
        <button class="btn accent" id="eqBtn">=</button>

        <button class="btn" data-k="4">4</button>
        <button class="btn" data-k="5">5</button>
        <button class="btn" data-k="6">6</button>
        <button class="btn" data-k="-">−</button>
        <button class="btn" data-k="+">+</button>
        <button class="btn ghost" id="classicBtn">= Classic</button>

        <button class="btn" data-k="1">1</button>
        <button class="btn" data-k="2">2</button>
        <button class="btn" data-k="3">3</button>
        <button class="btn span2" data-k="0">0</button>
        <button class="btn" data-k=".">.</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="label">Step-by-Step</div>
      <div class="steps" id="stepsBox">
        <div class="step">
          <div class="t">Info</div>
          Enter an expression and press <b>=</b>. Steps will appear here.
        </div>
      </div>
      <div style="margin-top:12px" class="kv">
        <div class="k">Angle Mode</div><div class="v" id="modeLabel">DEG</div>
        <div class="k">Last Error</div><div class="v" id="errLabel">—</div>
      </div>
    </div>

    <div class="card">
      <div class="lib-top">
        <div class="label" style="margin:0">Equation Library (with numeric demos)</div>
        <select id="catSelect" title="Select a category">
          <option value="quantum">Quantum</option>
          <option value="einstein">Einstein / Relativity</option>
          <option value="entanglement">Entanglement</option>
          <option value="photons">Photons</option>
          <option value="reality">Reality / Information</option>
          <option value="warp">Warp (Alcubierre-style)</option>
          <option value="cst">CST Time (Your Framework)</option>
          <option value="other">Other Classics</option>
        </select>
        <input id="searchBox" type="text" placeholder="Search in category…" />
        <button class="btn ghost" id="clearSearch">Clear</button>
      </div>
      <div id="eqList" class="eq-list"></div>
      <div class="tiny" style="margin-top:8px">Click “Insert Demo” to load a numeric example into the calculator.</div>
    </div>
  </section>

  <!-- ===================== PANEL 2: WORD PROBLEM ===================== -->
  <section id="word" class="panel">
    <div class="card" style="margin-bottom:12px">
      <div class="label">Write a word problem (physics/math). Examples below.</div>
      <textarea id="wpInput" placeholder="Example: A car travels 120 km at 60 km/h. How long does it take?"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn green" id="wpSolve">Solve</button>
        <button class="btn ghost" id="wpPrint">Print Steps</button>
        <span class="tiny">Supported patterns: Distance–Speed–Time, Force (F=ma), Photon energy (E=hf), Work (W=F·d), Ohm’s law (V=IR), KE (½mv²). Units allowed: m, km, s, h, m/s, km/h, kg, N, J, Hz, V, A, Ω.</span>
      </div>
    </div>

    <div class="card">
      <div class="label">Step-by-Step Solution</div>
      <div class="steps" id="wpSteps">
        <div class="step"><div class="t">Info</div>Enter a clear problem with enough information, then click <b>Solve</b>.</div>
      </div>
      <div class="kv" style="margin-top:12px">
        <div class="k">Detected Type</div><div class="v" id="wpType">—</div>
        <div class="k">Status</div><div class="v" id="wpStatus">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="label">Example Prompts</div>
      <div class="steps">
        <div class="step"><b>Distance–Speed–Time</b>: “A runner covers 10 km in 50 minutes. What is the average speed in km/h?”</div>
        <div class="step"><b>Force</b>: “Find the force on a 2 kg mass accelerating at 3 m/s^2.”</div>
        <div class="step"><b>Photon</b>: “What is the energy of a photon with frequency 5×10^14 Hz?”</div>
        <div class="step"><b>Work</b>: “How much work is done by a 50 N force over 6 m?”</div>
        <div class="step"><b>Ohm’s Law</b>: “Find current through a 200 Ω resistor with 9 V applied.”</div>
        <div class="step"><b>KE</b>: “Kinetic energy of 1000 kg car at 20 m/s?”</div>
      </div>
    </div>
  </section>

  <!-- ===================== PANEL 3: IMAGE→DIAGRAM ===================== -->
  <section id="image" class="panel">
    <div class="card" style="margin-bottom:12px">
      <div class="label">Load an image (PNG/JPG). The tool will compute edges and overlay a simple diagram grid.</div>
      <div class="row">
        <input type="file" id="imgFile" accept="image/*" />
        <button class="btn green" id="imgAnalyze">Analyze</button>
        <button class="btn ghost" id="imgPrint">Print Steps</button>
      </div>
    </div>

    <div class="img-wrap">
      <div class="card">
        <div class="label">Original</div>
        <canvas id="canvasIn" width="640" height="400"></canvas>
      </div>
      <div class="card">
        <div class="label">Edges + Diagram Overlay</div>
        <canvas id="canvasOut" width="640" height="400"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="label">Processing Steps</div>
      <div class="steps" id="imgSteps">
        <div class="step"><div class="t">Info</div>Choose an image, click <b>Analyze</b>. The pipeline: load → grayscale → blur → Sobel edges → normalize → overlay grid/annotations.</div>
      </div>
      <div style="margin-top:10px">
        <div class="row">
          <span class="tag">Progress: <span id="imgProg" class="code">0%</span></span>
        </div>
        <div class="bar" style="margin-top:6px"><div class="fill" id="imgFill"></div></div>
      </div>
    </div>
  </section>

<script>
/* =============== Tabs =============== */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const id = b.getAttribute('data-tab');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

/* ======================================================================
   PANEL 1: Calculator + Equation Library
====================================================================== */
const disp = document.getElementById('display');
const stepsBox = document.getElementById('stepsBox');
const resultLabel = document.getElementById('resultLabel');
const ansLabel = document.getElementById('ansLabel');
const modeLabel = document.getElementById('modeLabel');
const errLabel = document.getElementById('errLabel');
const degToggle = document.getElementById('degToggle');

let expr = "";
let ANS = null;

function updateDisplay(){ disp.textContent = expr || '(empty)'; }
function append(t){ expr += t; updateDisplay(); }
function del(){ expr = expr.slice(0,-1); updateDisplay(); }
function clearAll(){ expr=""; updateDisplay(); resultLabel.textContent="—"; errLabel.textContent="—"; resetSteps(); }
function setResult(v){ resultLabel.textContent = String(v); ANS = v; ansLabel.textContent = String(v); }
function rad(x){ return x * Math.PI / 180; }

function fact(n){ n=Math.floor(n); if(n<0) return NaN; let p=1; for(let i=2;i<=n;i++) p*=i; return p; }
function nPr(n,r){ n=Math.floor(n); r=Math.floor(r); if(n<0||r<0||r>n) return NaN; return fact(n)/fact(n-r); }
function nCr(n,r){ n=Math.floor(n); r=Math.floor(r); if(n<0||r<0||r>n) return NaN; return fact(n)/(fact(r)*fact(n-r)); }

function buildContext(){
  const M = Math; const deg = degToggle.checked;
  const S = (x)=> M.sin(deg? rad(x):x);
  const C = (x)=> M.cos(deg? rad(x):x);
  const T = (x)=> M.tan(deg? rad(x):x);
  const AS = (x)=> deg? (M.asin(x)*180/M.PI):M.asin(x);
  const AC = (x)=> deg? (M.acos(x)*180/M.PI):M.acos(x);
  const AT = (x)=> deg? (M.atan(x)*180/M.PI):M.atan(x);
  return {
    sin:S, cos:C, tan:T, asin:AS, acos:AC, atan:AT,
    sqrt:M.sqrt, cbrt:M.cbrt, log:(x)=> M.log10? M.log10(x) : M.log(x)/M.LN10,
    ln:M.log, exp:M.exp, pow:M.pow, abs:M.abs, floor:M.floor, ceil:M.ceil, round:M.round,
    min:M.min, max:M.max, E:M.E, PI:M.PI,
    fact, nPr, nCr,
    ANS: (ANS===null? 0 : ANS)
  };
}

/* Steps UI */
function addStep(title, before, after){
  const d = document.createElement('div');
  d.className = 'step';
  d.innerHTML = `<div class="t">${title}</div>
                 <div><span class="code">${before}</span></div>
                 <div style="margin-top:4px">→ <span class="code">${after}</span></div>`;
  stepsBox.appendChild(d);
  stepsBox.scrollTop = stepsBox.scrollHeight;
}
function resetSteps(){ stepsBox.innerHTML = '<div class="step"><div class="t">Info</div>Steps will appear here.</div>'; }

function normalizeCaret(e){ return e.replace(/\^/g, '**'); }
function replaceConstants(e, ctx){
  return e.replace(/\bPI\b/g, String(ctx.PI))
          .replace(/\bE\b/g, String(ctx.E))
          .replace(/\bANS\b/g, String(ctx.ANS));
}
function replaceFactorials(e){ return e.replace(/(\d+)\s*!/g, 'fact($1)'); }
function evalJS(exp, ctx){ const f = new Function(...Object.keys(ctx), `return (${exp});`); return f(...Object.values(ctx)); }

function evaluateWithSteps(input){
  stepsBox.innerHTML = '';
  errLabel.textContent = '—';
  modeLabel.textContent = degToggle.checked ? 'DEG' : 'RAD';
  if(!input || !input.trim()){ addStep('Empty','(empty)','0'); return 0; }
  const ok = /^[0-9+\-*/%^().,\sA-Za-z]*$/;
  if (!ok.test(input)) throw new Error('Unsupported characters in expression');

  const ctx = buildContext();
  let e = input.trim();
  addStep('Original', e, e);

  const e1 = normalizeCaret(e); if (e1 !== e) addStep('Normalize ^ → **', e, e1); e = e1;
  const e2 = replaceFactorials(e); if (e2 !== e) addStep('Factorial rewrite', e, e2); e = e2;
  const e3 = replaceConstants(e, ctx); if (e3 !== e) addStep('Constants replacement', e, e3); e = e3;

  if (/\b(a?sin|a?cos|a?tan)\s*\(/i.test(e)){
    addStep('Angle Mode', '—', degToggle.checked? 'Using Degrees' : 'Using Radians');
  }

  let safety=0;
  while (/\([^()]*\)/.test(e) && safety<200){
    safety++;
    const m = e.match(/\([^()]*\)/); if(!m) break;
    const sub = m[0]; const inside = sub.slice(1,-1);
    let val; try{ val = evalJS(inside, ctx); }catch(err){ throw new Error('Error inside parentheses: '+err.message); }
    const reduced = e.replace(sub, String(val));
    addStep('Evaluate parentheses', e, reduced);
    e = reduced;
  }
  if (safety>=200) throw new Error('Exceeded step limit (parentheses)');

  let out; try{ out = evalJS(e, ctx); }catch(err){ throw new Error('Evaluation error: '+err.message); }
  addStep('Final evaluation', e, String(out));
  return out;
}

/* Keypad wiring */
document.querySelectorAll('[data-k]').forEach(btn=>{
  btn.addEventListener('click', ()=> append(btn.getAttribute('data-k')));
});
document.getElementById('clearBtn').addEventListener('click', ()=>{ clearAll(); });
document.getElementById('delBtn').addEventListener('click', del);
document.getElementById('ansBtn').addEventListener('click', ()=>{ if(ANS!==null) append(String(ANS)); });
document.getElementById('eqBtn').addEventListener('click', ()=>{
  try{ const val = evaluateWithSteps(expr); setResult(val); }
  catch(err){ errLabel.textContent = err.message; addStep('Error', expr, err.message); }
});
document.getElementById('classicBtn').addEventListener('click', ()=>{
  try{ const val = evaluateWithSteps(expr); setResult(val); }
  catch(err){ errLabel.textContent = err.message; addStep('Error', expr, err.message); }
});
document.getElementById('sqBtn').addEventListener('click', ()=>{ append('^2'); });
document.getElementById('cubeBtn').addEventListener('click', ()=>{ append('^3'); });
document.getElementById('factBtn').addEventListener('click', ()=>{ append('!'); });
document.getElementById('nPrBtn').addEventListener('click', ()=>{ append('nPr('); });
document.getElementById('nCrBtn').addEventListener('click', ()=>{ append('nCr('); });
document.getElementById('pmBtn').addEventListener('click', ()=>{
  if (!expr) { expr = '-'; updateDisplay(); return; }
  expr = `(-1)*(${expr})`; updateDisplay();
});
window.addEventListener('keydown', (e)=>{
  if (document.getElementById('calc').classList.contains('active')){
    const k = e.key;
    if (k==='Enter'){ e.preventDefault(); document.getElementById('eqBtn').click(); return; }
    if (k==='Backspace'){ e.preventDefault(); del(); return; }
    const allowed='0123456789.+-*/()^';
    if (allowed.includes(k)){ append(k); }
  }
});
modeLabel.textContent = degToggle.checked ? 'DEG' : 'RAD';
degToggle.addEventListener('change', ()=>{ modeLabel.textContent = degToggle.checked ? 'DEG' : 'RAD'; });

/* Equation Library with demos */
const library = {
  quantum: [
    { title:"Schrödinger (time-dependent)", tex:"i\\hbar\\,\\frac{\\partial\\psi}{\\partial t}=\\hat H\\,\\psi",
      demo:{expr:"E = (2*PI)*1.054e-34*5e14", note:"Planck: E=ħω with f=5×10¹⁴ Hz (ω=2πf)"} },
    { title:"Uncertainty Principle", tex:"\\Delta x\\,\\Delta p\\ge \\frac{\\hbar}{2}",
      demo:{expr:"dx=1e-10, dp=(1.054e-34/2)/dx", note:"Given Δx=1 Å, compute minimal Δp"} },
    { title:"de Broglie Wavelength", tex:"\\lambda=\\frac{h}{p}",
      demo:{expr:"6.626e-34/(9.11e-31*1e6)", note:"Electron with v=10⁶ m/s"} },
    { title:"Lindblad (symbolic)", tex:"\\dot{\\rho}=-\\frac{i}{\\hbar}[H,\\rho]+\\sum_k (L_k\\rho L_k^{\\dagger}-\\tfrac12\\{L_k^{\\dagger}L_k,\\rho\\})" }
  ],
  einstein: [
    { title:"Einstein Field Eq. (symbolic)", tex:"G_{\\mu\\nu}+\\Lambda g_{\\mu\\nu}=\\frac{8\\pi G}{c^4}T_{\\mu\\nu}" },
    { title:"Time Dilation γ", tex:"\\gamma=\\frac{1}{\\sqrt{1-\\frac{v^2}{c^2}}}",
      demo:{expr:"1/sqrt(1-(0.8^2))", note:"v=0.8c"} },
    { title:"Relativistic KE", tex:"K=(\\gamma-1)mc^2",
      demo:{expr:"(1/sqrt(1-(0.9^2)) - 1)*1*(3e8^2)", note:"m=1 kg, v=0.9c"} }
  ],
  entanglement: [
    { title:"Von Neumann Entropy", tex:"S(\\rho)=-\\mathrm{Tr}(\\rho\\ln\\rho)" },
    { title:"CHSH Tsirelson bound", tex:"|S|\\le 2\\sqrt{2}",
      demo:{expr:"2*sqrt(2)", note:"Quantum upper bound"} }
  ],
  photons: [
    { title:"Photon Energy", tex:"E=hf=\\hbar\\omega",
      demo:{expr:"6.626e-34*5e14", note:"f=5×10¹⁴ Hz"} },
    { title:"Photon Momentum", tex:"p=\\frac{E}{c}=\\frac{h}{\\lambda}",
      demo:{expr:"(6.626e-34*5e14)/3e8", note:"p=E/c"} },
    { title:"Compton Shift", tex:"\\Delta\\lambda=\\frac{h}{m_e c}(1-\\cos\\theta)",
      demo:{expr:"(6.626e-34/(9.11e-31*3e8))*(1-cos(60))", note:"θ=60°"} }
  ],
  reality: [
    { title:"Shannon Entropy", tex:"H=-\\sum_i p_i\\log_2 p_i",
      demo:{expr:"-(0.5*log(0.5)/log(2)+0.5*log(0.5)/log(2))", note:"Fair coin"} },
    { title:"Gibbs Free Energy", tex:"G=H-TS",
      demo:{expr:"1000 - 300*2.5", note:"toy numbers"} }
  ],
  warp: [
    { title:"Alcubierre Metric (symbolic)", tex:"ds^2=-c^2dt^2+[dx-v_s f(r_s)dt]^2+dy^2+dz^2" },
    { title:"Bubble Profile (toy)", tex:"f(r_s)=\\frac{\\tanh(\\sigma(r_s+R)) - \\tanh(\\sigma(r_s-R))}{2\\tanh(\\sigma R)}",
      demo:{expr:"(tanh(10*(2+5)) - tanh(10*(2-5)))/(2*tanh(10*5))", note:"σ=10, r_s=2, R=5"} }
  ],
  cst: [
    { title:"CST Energy (1)", tex:"E_s = m\\,(c\\,CST_r)^2",
      demo:{expr:"1*(3e8*0.97)^2", note:"m=1 kg, CST_r=0.97"} },
    { title:"CST Energy (2)", tex:"E_t = \\frac{m}{\\rho}\\,(c\\,T_{cst})^2",
      demo:{expr:"(1/1000)*(3e8*0.8)^2", note:"toy numbers"} },
    { title:"CST Combined", tex:"E = \\frac{m}{\\rho}\\,(c\\,CST_r\\,T_{cst})^2",
      demo:{expr:"(1/1000)*(3e8*0.97*0.8)^2", note:"toy"} }
  ],
  other: [
    { title:"Planck Relation", tex:"E=hf", demo:{expr:"6.626e-34*1e9", note:"f=1 GHz"} },
    { title:"Boltzmann", tex:"\\langle E \\rangle \\approx k_B T", demo:{expr:"1.380649e-23*300", note:"T=300K"} },
    { title:"Length Contraction", tex:"L'=\\frac{L}{\\gamma}", demo:{expr:"10/(1/sqrt(1-(0.9^2)))", note:"L=10 m, v=0.9c"} }
  ]
};

const catSelect = document.getElementById('catSelect');
const eqList = document.getElementById('eqList');
const searchBox = document.getElementById('searchBox');
document.getElementById('clearSearch').addEventListener('click', ()=>{ searchBox.value = ""; renderList(); });

function renderList(){
  const cat = catSelect.value;
  const filter = (searchBox.value||"").toLowerCase();
  const items = (library[cat]||[]).filter(it=> !filter || it.title.toLowerCase().includes(filter));
  eqList.innerHTML = "";
  items.forEach((it)=>{
    const div = document.createElement('div');
    div.className = 'eq-item';
    div.innerHTML = `
      <div class="eq-row">
        <div class="eq-title">${it.title}</div>
        <div class="eq-actions">
          ${it.demo ? `<button class="btn green demoBtn">Insert Demo</button>` : ``}
          <button class="btn ghost showBtn">Show Formula</button>
        </div>
      </div>
      <div class="eq-tex tiny" style="display:none"><span>\\(${it.tex}\\)</span></div>
      ${it.demo ? `<div class="tiny" style="margin-top:6px; display:none">Demo: <span class="code">${it.demo.expr}</span> — ${it.demo.note||''}</div>` : ``}
    `;
    const showBtn = div.querySelector('.showBtn');
    const texBox = div.querySelector('.eq-tex');
    showBtn.addEventListener('click', async ()=>{
      texBox.style.display = texBox.style.display==='none' ? 'block' : 'none';
      if (window.MathJax) { window.MathJax.typesetPromise && window.MathJax.typesetPromise([texBox]); }
    });
    const demoBtn = div.querySelector('.demoBtn');
    if (demoBtn && it.demo){
      const noteDiv = div.querySelector('.tiny:last-child');
      demoBtn.addEventListener('click', ()=>{
        expr = it.demo.expr;
        updateDisplay();
        resetSteps();
        if (noteDiv) noteDiv.style.display = 'block';
      });
    }
    eqList.appendChild(div);
  });
  if (window.MathJax) { window.MathJax.typesetPromise && window.MathJax.typesetPromise([eqList]); }
}
catSelect.addEventListener('change', renderList);
searchBox.addEventListener('input', renderList);
renderList();

/* ======================================================================
   PANEL 2: Word-Problem Solver
   Simple pattern-based parser with units + step display + printer
====================================================================== */
const wpInput = document.getElementById('wpInput');
const wpSteps = document.getElementById('wpSteps');
const wpType = document.getElementById('wpType');
const wpStatus = document.getElementById('wpStatus');
document.getElementById('wpSolve').addEventListener('click', solveWordProblem);
document.getElementById('wpPrint').addEventListener('click', ()=> printStepsDiv(wpSteps, 'Word-Problem Steps'));

function wpAddStep(title, body){
  const d = document.createElement('div'); d.className='step';
  d.innerHTML = `<div class="t">${title}</div><div>${body}</div>`;
  wpSteps.appendChild(d); wpSteps.scrollTop = wpSteps.scrollHeight;
}
function wpReset(){ wpSteps.innerHTML=''; wpType.textContent='—'; wpStatus.textContent='—'; }

function parseNumbersUnits(text){
  // Capture numbers + units like 120 km, 60 km/h, 3 m/s^2, 9 V, 200 Ω, 2 A, 5e14 Hz
  const tokenRe = /([+-]?\d+(?:\.\d+)?(?:e[+-]?\d+)?)\s*(km\/h|m\/s\^2|m\/s|km|m|s|h|kg|N|J|Hz|V|A|Ω|ohm|Ohm|deg|°|rad)?/gi;
  let m, vals=[];
  while((m=tokenRe.exec(text))!==null){
    vals.push({value: parseFloat(m[1]), unit: (m[2]||'').toLowerCase()});
  }
  return vals;
}
function hoursToSeconds(h){ return h*3600; }
function kmToMeters(km){ return km*1000; }
function kmhToMs(kmh){ return kmhToMs.cache[kmh] ?? (kmhToMs.cache[kmh] = kmh/3.6); } kmhToMs.cache = {};
function msToKmh(ms){ return ms*3.6; }

function detectType(text){
  const t = text.toLowerCase();
  if (/ohm|Ω|\bresist|volt|current|\bamps?\b|\bvoltage\b/.test(t)) return 'ohm';
  if (/\bphoton|frequency|hz\b/.test(t)) return 'photon';
  if (/\bforce\b|m\/s\^2|\baccelerat/.test(t)) return 'force';
  if (/\bwork\b|joule| j\b/.test(t)) return 'work';
  if (/\bkinetic|ke\b/.test(t)) return 'ke';
  if (/\btravel|speed|velocity|distance|time\b/.test(t)) return 'dst';
  return 'unknown';
}

function solveWordProblem(){
  wpReset();
  const text = (wpInput.value||'').trim();
  if (!text){ wpAddStep('Error','No input provided.'); wpStatus.textContent='Wrong format'; return; }

  const type = detectType(text);
  wpType.textContent = type.toUpperCase();
  const vals = parseNumbersUnits(text);

  // Build unit map helpers
  const hasUnit = (u)=> vals.find(v=> v.unit===u);
  const valueOf = (u)=> (hasUnit(u)||{}).value;

  try{
    switch(type){
      case 'dst':{
        // distance-speed-time; support km, m, km/h, m/s, hours, seconds
        // Try to infer which variable is missing using keywords
        const askTime = /how long|how much time|time\b/.test(text);
        const askDist = /how far|distance\b/.test(text);
        const askSpeed = /speed|velocity/.test(text) && !askTime && !askDist;

        let d = valueOf('km') ?? (valueOf('m')? valueOf('m')/1000 : null);
        let v = valueOf('km/h'); if (v===undefined) v=null;
        let vms = valueOf('m/s'); if (vms===undefined) vms=null;
        let t = valueOf('h'); if (t===undefined) t=null;
        let ts = valueOf('s'); if (ts===undefined) ts=null;

        // Convert to base SI: meters & seconds
        let D = null, V = null, T = null;
        if (d!=null){ D = kmToMeters(d); wpAddStep('Given distance', `${d} km = ${D} m`); }
        if (v!=null){ V = kmhToMs(v); wpAddStep('Given speed', `${v} km/h = ${V.toFixed(3)} m/s`); }
        if (vms!=null){ V = vms; wpAddStep('Given speed', `${V} m/s`); }
        if (t!=null){ T = hoursToSeconds(t); wpAddStep('Given time', `${t} h = ${T} s`); }
        if (ts!=null){ T = ts; wpAddStep('Given time', `${T} s`); }

        // Solve for missing
        if (askTime || (D!=null && V!=null && T==null)){
          if (D==null || V==null){ wpAddStep('Missing info','Need distance and speed to compute time.'); wpStatus.textContent='Missing information'; return; }
          T = D / V; wpAddStep('Compute time', `t = d/v = ${D} / ${V.toFixed(3)} = ${T.toFixed(3)} s`);
          const hours = (T/3600); wpAddStep('Convert', `${T.toFixed(3)} s = ${hours.toFixed(3)} h`);
          wpStatus.textContent='Solved';
          break;
        }
        if (askDist || (V!=null && T!=null && D==null)){
          if (V==null || T==null){ wpAddStep('Missing info','Need speed and time to compute distance.'); wpStatus.textContent='Missing information'; return; }
          D = V*T; wpAddStep('Compute distance', `d = v*t = ${V.toFixed(3)} * ${T.toFixed(3)} = ${D.toFixed(3)} m`);
          const km = D/1000; wpAddStep('Convert', `${D.toFixed(3)} m = ${km.toFixed(3)} km`);
          wpStatus.textContent='Solved';
          break;
        }
        if (askSpeed || (D!=null && T!=null && V==null)){
          if (D==null || T==null){ wpAddStep('Missing info','Need distance and time to compute speed.'); wpStatus.textContent='Missing information'; return; }
          V = D/T; wpAddStep('Compute speed', `v = d/t = ${D.toFixed(3)} / ${T.toFixed(3)} = ${V.toFixed(3)} m/s`);
          wpAddStep('Convert', `${V.toFixed(3)} m/s = ${(msToKmh(V)).toFixed(3)} km/h`);
          wpStatus.textContent='Solved';
          break;
        }
        // If not enough keywords, still try to deduce:
        if (D!=null && V!=null && T==null){ T=D/V; wpAddStep('Compute time', `t=d/v = ${D}/${V} = ${T} s`); wpStatus.textContent='Solved'; }
        else if (V!=null && T!=null && D==null){ D=V*T; wpAddStep('Compute distance', `d=v*t = ${V}*${T} = ${D} m`); wpStatus.textContent='Solved'; }
        else if (D!=null && T!=null && V==null){ V=D/T; wpAddStep('Compute speed', `v=d/t = ${D}/${T} = ${V} m/s`); wpStatus.textContent='Solved'; }
        else { wpAddStep('Wrong format','Could not detect enough distance/speed/time info.'); wpStatus.textContent='Wrong format'; }
        break;
      }
      case 'force':{
        // F = m a
        const m = (hasUnit('kg')||{}).value;
        const a = (hasUnit('m/s^2')||{}).value;
        if (m==null || a==null){ wpAddStep('Missing info','Need mass (kg) and acceleration (m/s^2).'); wpStatus.textContent='Missing information'; return; }
        const F = m*a;
        wpAddStep('Formula','F = m·a');
        wpAddStep('Compute', `F = ${m} * ${a} = ${F} N`);
        wpStatus.textContent='Solved';
        break;
      }
      case 'photon':{
        // E = h f
        const f = (hasUnit('hz')||{}).value;
        if (f==null){ wpAddStep('Missing info','Need frequency in Hz.'); wpStatus.textContent='Missing information'; return; }
        const h = 6.626e-34;
        const E = h*f;
        wpAddStep('Formula','E = h·f');
        wpAddStep('Constants', `h = 6.626×10^-34 J·s`);
        wpAddStep('Compute', `E = ${h} * ${f} = ${E} J`);
        wpStatus.textContent='Solved';
        break;
      }
      case 'work':{
        // W = F d
        const F = (hasUnit('n')||{}).value;
        let d = (hasUnit('m')||{}).value;
        if (F==null || d==null){ wpAddStep('Missing info','Need force (N) and distance (m).'); wpStatus.textContent='Missing information'; return; }
        const W = F*d;
        wpAddStep('Formula','W = F·d');
        wpAddStep('Compute', `W = ${F} * ${d} = ${W} J`);
        wpStatus.textContent='Solved';
        break;
      }
      case 'ohm':{
        // V = I R
        const V = (hasUnit('v')||{}).value;
        const I = (hasUnit('a')||{}).value;
        let R = (hasUnit('ω')||{}).value ?? (hasUnit('ohm')||{}).value;
        // Solve whichever is missing
        wpAddStep('Formula','V = I·R');
        if (V!=null && I!=null && R==null){ const Rv=V/I; wpAddStep('Solve R', `R = V/I = ${V}/${I} = ${Rv} Ω`); wpStatus.textContent='Solved'; }
        else if (V!=null && R!=null && I==null){ const Iv=V/R; wpAddStep('Solve I', `I = V/R = ${V}/${R} = ${Iv} A`); wpStatus.textContent='Solved'; }
        else if (I!=null && R!=null && V==null){ const Vv=I*R; wpAddStep('Solve V', `V = I·R = ${I}*${R} = ${Vv} V`); wpStatus.textContent='Solved'; }
        else { wpAddStep('Missing/Wrong','Provide any two of V (V), I (A), R (Ω).'); wpStatus.textContent='Missing information'; }
        break;
      }
      case 'ke':{
        // KE = 1/2 m v^2
        const m = (hasUnit('kg')||{}).value;
        const v = (hasUnit('m/s')||{}).value;
        if (m==null || v==null){ wpAddStep('Missing info','Need mass (kg) and speed (m/s).'); wpStatus.textContent='Missing information'; return; }
        const KE = 0.5*m*v*v;
        wpAddStep('Formula','KE = ½ m v²');
        wpAddStep('Compute', `KE = 0.5 * ${m} * (${v})^2 = ${KE} J`);
        wpStatus.textContent='Solved';
        break;
      }
      default:
        wpAddStep('Wrong format','Could not recognize the problem type. Try including units and keywords (distance, speed, time, mass, acceleration, etc.).');
        wpStatus.textContent='Wrong format';
    }
  }catch(err){
    wpAddStep('Error', err.message);
    wpStatus.textContent='Error';
  }
}

/* Print helper (opens a new window with the steps content) */
function printStepsDiv(div, title){
  const w = window.open('', '_blank');
  const html = `
  <html><head><title>${title}</title>
  <style>body{font-family:system-ui;margin:20px} .step{padding:8px 10px;margin:8px 0;border:1px dashed #ccc;border-radius:8px}</style>
  </head><body>
  <h2>${title}</h2>
  ${div.innerHTML}
  <script>window.onload=()=>{window.print();}</script>
  </body></html>`;
  w.document.write(html); w.document.close();
}

/* ======================================================================
   PANEL 3: Image→Diagram — client-side Sobel edges + steps + printer
====================================================================== */
const imgFile = document.getElementById('imgFile');
const canvasIn = document.getElementById('canvasIn');
const canvasOut = document.getElementById('canvasOut');
const ctxIn = canvasIn.getContext('2d');
const ctxOut = canvasOut.getContext('2d');
const imgSteps = document.getElementById('imgSteps');
const imgProg = document.getElementById('imgProg');
const imgFill = document.getElementById('imgFill');

document.getElementById('imgAnalyze').addEventListener('click', analyzeImage);
document.getElementById('imgPrint').addEventListener('click', ()=> printStepsDiv(imgSteps, 'Image→Diagram Steps'));

function imgAddStep(title, body){
  const d = document.createElement('div'); d.className='step';
  d.innerHTML = `<div class="t">${title}</div><div>${body}</div>`;
  imgSteps.appendChild(d); imgSteps.scrollTop = imgSteps.scrollHeight;
}
function imgReset(){
  imgSteps.innerHTML='';
  imgProg.textContent='0%'; imgFill.style.width='0%';
}
function setProgress(p){
  const pct = Math.max(0, Math.min(100, Math.round(p)));
  imgProg.textContent = pct+'%'; imgFill.style.width = pct+'%';
}

function loadImageToCanvas(file){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{
      // Fit into canvas keeping aspect
      const scale = Math.min(canvasIn.width/img.width, canvasIn.height/img.height);
      const w = img.width*scale, h = img.height*scale;
      ctxIn.clearRect(0,0,canvasIn.width,canvasIn.height);
      ctxIn.drawImage(img, 0,0,w,h);
      resolve({w,h});
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}
function toGrayscale(src, w, h){
  const g = new Uint8ClampedArray(w*h);
  for (let y=0;y<h;y++){
    for (let x=0;x<w;x++){
      const i = (y*w+x)*4;
      const r=src[i], g1=src[i+1], b=src[i+2];
      g[y*w+x] = (0.299*r + 0.587*g1 + 0.114*b)|0;
    }
  }
  return g;
}
function boxBlur(gray, w, h){
  const out = new Uint8ClampedArray(w*h);
  const kernel = [1,1,1,1,1,1,1,1,1]; // 3x3
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let sum=0, k=0;
      for(let dy=-1;dy<=1;dy++){
        for(let dx=-1;dx<=1;dx++){
          sum += gray[(y+dy)*w + (x+dx)] * kernel[k++];
        }
      }
      out[y*w+x] = (sum/9)|0;
    }
  }
  return out;
}
function sobel(gray, w, h){
  const out = new Uint8ClampedArray(w*h);
  const gxK = [-1,0,1,-2,0,2,-1,0,1];
  const gyK = [-1,-2,-1,0,0,0,1,2,1];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let gx=0, gy=0, k=0;
      for(let dy=-1;dy<=1;dy++){
        for(let dx=-1;dx<=1;dx++){
          const v = gray[(y+dy)*w + (x+dx)];
          gx += v * gxK[k];
          gy += v * gyK[k];
          k++;
        }
      }
      const mag = Math.sqrt(gx*gx + gy*gy);
      out[y*w+x] = Math.max(0, Math.min(255, mag))|0;
    }
  }
  return out;
}
function normalizeToRGBA(src, w, h){
  const img = ctxOut.createImageData(w,h);
  for(let i=0;i<w*h;i++){
    const v = src[i];
    img.data[i*4+0] = v;
    img.data[i*4+1] = v;
    img.data[i*4+2] = v;
    img.data[i*4+3] = 255;
  }
  return img;
}
function overlayDiagram(w,h){
  // simple grid + crosshair
  ctxOut.strokeStyle = 'rgba(79,70,229,0.6)';
  ctxOut.lineWidth = 1;
  const step = Math.max(20, Math.min(w,h)/10);
  for(let x=0;x<=w;x+=step){ ctxOut.beginPath(); ctxOut.moveTo(x,0); ctxOut.lineTo(x,h); ctxOut.stroke(); }
  for(let y=0;y<=h;y+=step){ ctxOut.beginPath(); ctxOut.moveTo(0,y); ctxOut.lineTo(w,y); ctxOut.stroke(); }
  // mark center
  ctxOut.strokeStyle = 'rgba(16,185,129,0.9)';
  ctxOut.beginPath(); ctxOut.moveTo(w/2,0); ctxOut.lineTo(w/2,h); ctxOut.stroke();
  ctxOut.beginPath(); ctxOut.moveTo(0,h/2); ctxOut.lineTo(w,h/2); ctxOut.stroke();
}

async function analyzeImage(){
  imgReset();
  const file = imgFile.files && imgFile.files[0];
  if (!file){ imgAddStep('Error','No image selected.'); return; }
  try{
    setProgress(5);
    imgAddStep('Load','Reading image and fitting to canvas.');
    const {w,h} = await loadImageToCanvas(file);
    const src = ctxIn.getImageData(0,0,w,h).data;

    setProgress(20);
    imgAddStep('Grayscale','Converting RGB to luminance.');
    const gray = toGrayscale(src, w, h);

    setProgress(40);
    imgAddStep('Blur','3×3 box blur to reduce noise.');
    const blur = boxBlur(gray, w, h);

    setProgress(65);
    imgAddStep('Sobel edges','Computing gradient magnitude with Sobel operator.');
    const edges = sobel(blur, w, h);

    setProgress(80);
    imgAddStep('Normalize','Mapping edges to displayable grayscale.');
    const rgba = normalizeToRGBA(edges, w, h);
    ctxOut.clearRect(0,0,canvasOut.width,canvasOut.height);
    ctxOut.putImageData(rgba, 0, 0);

    setProgress(92);
    imgAddStep('Overlay diagram','Drawing grid and center crosshair.');
    overlayDiagram(w,h);

    setProgress(100);
    imgAddStep('Done','Edge field + diagram ready.');
  }catch(err){
    imgAddStep('Error', err.message);
  }
}

/* ======================================================================
   END
====================================================================== */
</script>
</body>
</html>
