<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CST Scientific Calculator — Symbols • Steps • 10 Demos</title>
<style>
  :root{
    --bg:#0b1220;--panel:#121a2e;--ink:#e8eeff;--muted:#aab4d6;--accent:#7aa7ff;--ok:#34e6a2;--warn:#ffd166;--bad:#ff6b8b;--border:#22325e;
    --btn:#182241;--btn2:#1d2750;--btnOp:#253268;--btnEq:#2b7a4b;--btnAct:#3b82f6;--chip:#0f1630;--card:#0f162c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1400px 900px at 70% 0%,#121a2e 0%,#0b1220 60%,#08101d 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:16px}
  h1{margin:0 0 8px;font-size:clamp(22px,3.2vw,32px)}
  p.lead{margin:0 0 14px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:420px 1fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .calc{background:linear-gradient(180deg,#121a2e,#0e1529);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .display{display:flex;gap:8px;align-items:center}
  .screen{flex:1;background:#0b1122;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:20px;min-height:48px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03)}
  .screen input{width:100%;background:transparent;color:var(--ink);border:0;outline:0;font-size:20px}
  .mode{display:flex;gap:8px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;user-select:none}
  .chip.active{outline:2px solid var(--accent)}

  .keypad{margin-top:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .btn{border:1px solid var(--border);background:var(--btn);color:var(--ink);padding:12px 8px;border-radius:10px;cursor:pointer;text-align:center;user-select:none}
  .btn.op{background:var(--btnOp)}
  .btn.eq{background:var(--btnEq)}
  .btn.act{background:var(--btnAct)}
  .btn:active{transform:translateY(1px)}

  .side{display:grid;gap:12px}
  .card{background:linear-gradient(180deg,#0d1427,#0a1223);border:1px solid var(--border);border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px;font-size:16px;color:#d9e4ff}
  .steps{max-height:260px;overflow:auto;line-height:1.45}
  .steps .step{background:var(--card);border:1px dashed var(--border);padding:8px;border-radius:8px;margin:6px 0;color:#cfe1ff}
  .history{max-height:124px;overflow:auto}
  .history .item{padding:6px;border-bottom:1px dashed var(--border);font-family:ui-monospace,Consolas,Menlo,monospace;color:#cfe1ff}
  .demos{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .demo{padding:10px;background:var(--chip);border:1px solid var(--border);border-radius:10px;cursor:pointer}
  .demo:hover{outline:2px solid #29417a}
  .muted{color:var(--muted)}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .actions .btn{padding:10px 12px}

  .printable{background:#fff;color:#111;padding:16px;border-radius:12px}
  .printable h2{margin:0 0 6px}
  .printable pre{white-space:pre-wrap}

  @media print{
    body{background:#fff}
    .wrap{margin:0;max-width:none}
    .grid{grid-template-columns:1fr}
    .card,.calc{box-shadow:none}
    .actions{display:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>CST Scientific Calculator</h1>
    <p class="lead">Symbols • Steps • 10 Demonstrations • Print Results. Toggle <strong>DEG/RAD</strong>, click symbols, type on keyboard, and see how each result is computed step-by-step.</p>

    <div class="grid">
      <section class="calc" aria-label="scientific calculator">
        <div class="display">
          <div class="screen"><input id="expr" aria-label="expression input" placeholder="Type or tap: e.g., sin(30) + √(3)^2 - π/4"/></div>
          <div class="mode">
            <span id="degBtn" class="chip active" role="button" tabindex="0">DEG</span>
            <span id="radBtn" class="chip" role="button" tabindex="0">RAD</span>
          </div>
        </div>
        <div class="keypad" id="keypad">
          <!-- Row 1 -->
          <div class="btn act" data-k="AC">AC</div>
          <div class="btn act" data-k="⌫">⌫</div>
          <div class="btn op" data-k="(">(</div>
          <div class="btn op" data-k=")">)</div>
          <div class="btn op" data-k=","><span>,</span></div>
          <div class="btn op" data-k="%">%</div>

          <!-- Row 2 functions -->
          <div class="btn" data-k="sin(">sin</div>
          <div class="btn" data-k="cos(">cos</div>
          <div class="btn" data-k="tan(">tan</div>
          <div class="btn" data-k="ln(">ln</div>
          <div class="btn" data-k="log(">log</div>
          <div class="btn op" data-k="^">^</div>

          <!-- Row 3 functions -->
          <div class="btn" data-k="asin(">asin</div>
          <div class="btn" data-k="acos(">acos</div>
          <div class="btn" data-k="atan(">atan</div>
          <div class="btn" data-k="sqrt(">√</div>
          <div class="btn" data-k="abs(">abs</div>
          <div class="btn" data-k="exp(">exp</div>

          <!-- Row 4 numbers/operators -->
          <div class="btn" data-k="7">7</div>
          <div class="btn" data-k="8">8</div>
          <div class="btn" data-k="9">9</div>
          <div class="btn op" data-k="/">÷</div>
          <div class="btn" data-k="pi">π</div>
          <div class="btn" data-k="e">e</div>

          <div class="btn" data-k="4">4</div>
          <div class="btn" data-k="5">5</div>
          <div class="btn" data-k="6">6</div>
          <div class="btn op" data-k="*">×</div>
          <div class="btn" data-k="^2">x²</div>
          <div class="btn" data-k="1/">1/x</div>

          <div class="btn" data-k="1">1</div>
          <div class="btn" data-k="2">2</div>
          <div class="btn" data-k="3">3</div>
          <div class="btn op" data-k="-">−</div>
          <div class="btn act" data-k="MS">MS</div>
          <div class="btn act" data-k="MR">MR</div>

          <div class="btn" data-k="0">0</div>
          <div class="btn" data-k=".">.</div>
          <div class="btn op" data-k="+">+</div>
          <div class="btn eq" data-k="=">=</div>
          <div class="btn act" data-k="M+">M+</div>
          <div class="btn act" data-k="MC">MC</div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" id="showSteps">Solve & Show Steps</button>
          <button class="btn" id="addHist">Add to History</button>
          <button class="btn" id="printBtn">Print Result</button>
          <button class="btn" id="clearBtn">Clear Results</button>
          <span class="muted">Tip: Press Enter to evaluate • Use ↑/↓ to cycle history</span>
        </div>

      </section>

      <aside class="side">
        <div class="card">
          <h3>Step-by-Step Solution</h3>
          <div id="steps" class="steps" aria-live="polite"></div>
        </div>
        <div class="card">
          <h3>History</h3>
          <div id="history" class="history"></div>
        </div>
        <div class="card">
          <h3>10 Demonstrations (click to load)</h3>
          <div class="demos" id="demos" role="list"></div>
          <p class="muted" style="margin-top:6px">Each demo auto-fills the input and shows a short explanation next to the steps.</p>
        </div>
        <div class="card">
          <h3>Printable Summary</h3>
          <div id="printArea" class="printable">
            <h2>Calculation Summary</h2>
            <div><strong>Expression:</strong> <span id="pExpr">—</span></div>
            <div><strong>Result:</strong> <span id="pRes">—</span></div>
            <div><strong>Mode:</strong> <span id="pMode">DEG</span></div>
            <h3>Steps</h3>
            <pre id="pSteps">(Run a calculation to populate this section.)</pre>
          </div>
        </div>
        <div class="card">
          <h3>Built-in Tests</h3>
          <div class="actions">
            <button class="btn" id="runTests">Run Tests</button>
          </div>
          <div id="testOutput" class="steps" style="max-height:180px"></div>
        </div>
        <div class="card">
          <h3>Symbols Palette</h3>
          <div class="demos" id="symbolsPalette"></div>
          <p class="muted" style="margin-top:6px">Click to insert a symbol at the cursor; symbols are preserved in print.</p>
        </div>
      </aside>
    </div>
  </div>

<script>
// Ensure DOM is fully loaded before accessing elements
document.addEventListener('DOMContentLoaded', function(){
(function(){
  const $ = (id)=>document.getElementById(id);
  const exprEl = $('expr');
  const stepsEl = $('steps');
  const histEl  = $('history');
  const keypad  = $('keypad');
  const degBtn  = $('degBtn');
  const radBtn  = $('radBtn');
  const printBtn= $('printBtn');
  const clearBtn= $('clearBtn');
  const runTestsBtn = $('runTests');
  const testOutput = $('testOutput');
  const showStepsBtn = $('showSteps');
  const addHistBtn = $('addHist');
  const pExpr = $('pExpr');
  const pRes  = $('pRes');
  const pMode = $('pMode');
  const pSteps= $('pSteps');
  const demosEl = $('demos');
  const paletteEl = $('symbolsPalette');

  if(!exprEl){ console.error('Calculator init failed: #expr missing'); return; }

  let DEG = true; // default mode
  let memory = 0;
  let history = [];
  let histIndex = -1;

  const demos = [
    { name:"Quadratic (x=?)", expr:"(-b + sqrt(b^2 - 4*a*c)) / (2*a)", fill:{a:1,b:-3,c:2}, note:"Quadratic formula for a=1, b=−3, c=2 → roots 1 and 2 (this is the + branch)." },
    { name:"Trig mix", expr:"sin(30) + cos(60) + tan(45)", note:"Using DEG mode: sin30=0.5, cos60=0.5, tan45=1 → total 2." },
    { name:"Log rules", expr:"ln(e^2) + log(1000) - ln(e)", note:"ln(e^2)=2, log10(1000)=3, ln(e)=1 → 2+3-1=4." },
    { name:"CST Energy", expr:"(m/rho) * (c * CSTr * TCST)^2", fill:{m:1.2,rho:0.8,c:299792458,CSTr:0.97,TCST:1.03}, note:"Your CST energy sketch: E=(m/ρ)(c·CSTᵣ·Tᴄsᴛ)² with sample parameters." },
    { name:"Vector magnitude", expr:"sqrt(3^2 + 4^2)", note:"|v| for (3,4) → 5 by Pythagoras." },
    { name:"Compound interest", expr:"P * (1 + r/n)^(n*t)", fill:{P:1000,r:0.05,n:12,t:10}, note:"Standard compounding: P(1+r/n)^{nt}." },
    { name:"Angle identity", expr:"sin(2*30)", note:"sin(60)=√3/2 ≈ 0.8660 in DEG mode." },
    { name:"Degrees↔Radians", expr:"sin(pi/6) + cos(pi/3)", note:"Using RAD mode recommended: sin(π/6)=0.5, cos(π/3)=0.5 → 1." },
    { name:"Percent & power", expr:"200 * 15% + 2^5", note:"15% interpreted as 0.15 → 30; 2^5=32; total 62." },
    { name:"Gamma-like (exp/ln)", expr:"exp(ln(5)) + ln(e)", note:"exp(ln 5)=5; ln(e)=1 → 6." }
  ];

  // Render demo buttons (accessible, resilient)
  if(demosEl){
    demosEl.innerHTML = '';
    demos.forEach((d,i)=>{
      const div=document.createElement('div');
      div.className='demo';
      div.setAttribute('role','button');
      div.setAttribute('tabindex','0');
      div.dataset.index = String(i);
      div.textContent = (i+1)+'. '+d.name;
      div.title = d.note || '';
      demosEl.appendChild(div);
    });
    // Event delegation so clicks always work even if nodes are re-rendered
    demosEl.addEventListener('click', onDemoActivate);
    demosEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ onDemoActivate(e); e.preventDefault(); }});
  }

  function onDemoActivate(e){
    const item = e.target.closest('.demo');
    if(!item || !demosEl.contains(item)) return;
    const idx = Number(item.dataset.index);
    const d = demos[idx];
    if(!d) return;
    const filled = applyFill(d.expr, d.fill||{});
    exprEl.value = filled;
    stepsEl.innerHTML = '';
    addStep('Demo loaded: '+d.name, true);
    if(d.note) addStep('Note: '+d.note, true);
    exprEl.focus();
  }

  // Symbols palette (broad coverage)
  const symbols = ['π','√','±','∑','∫','θ','λ','μ','σ','Ω','∞','≈','≤','≥','≠','×','÷','→','←','°'];
  if(paletteEl){
    symbols.forEach(sym=>{
      const b=document.createElement('div');
      b.className='demo';
      b.textContent = sym;
      b.setAttribute('role','button'); b.setAttribute('tabindex','0');
      b.addEventListener('click',()=> insertText(sym));
      b.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' ') { insertText(sym); e.preventDefault(); }});
      paletteEl.appendChild(b);
    });
  }

  function applyFill(expr, fill){
    let out = expr;
    Object.entries(fill||{}).forEach(([k,v])=>{
      const re = new RegExp('\\b'+k+'\\b','g');
      out = out.replace(re, String(v));
    });
    return out;
  }

  // Mode toggles
  function setMode(deg){
    DEG = deg; if(pMode) pMode.textContent = DEG? 'DEG':'RAD';
    if(degBtn) degBtn.classList.toggle('active',DEG); if(radBtn) radBtn.classList.toggle('active',!DEG);
  }
  if(degBtn) degBtn.onclick=()=>setMode(true);
  if(radBtn) radBtn.onclick=()=>setMode(false);

  // Keypad input (delegated)
  if(keypad) keypad.addEventListener('click', (e)=>{
    const target = e.target.closest('.btn');
    if(!target) return;
    const k = target.getAttribute('data-k');
    handleKey(k);
  });

  function insertText(t){
    const s = exprEl.selectionStart ?? exprEl.value.length;
    const e = exprEl.selectionEnd ?? exprEl.value.length;
    const v = exprEl.value;
    exprEl.value = v.slice(0,s) + t + v.slice(e);
    const pos = s + t.length;
    exprEl.setSelectionRange(pos,pos);
    exprEl.focus();
  }

  function handleKey(k){
    if(k==='AC'){ exprEl.value=''; stepsEl.innerHTML=''; return; }
    if(k==='⌫'){
      const s=exprEl.selectionStart??exprEl.value.length; const e=exprEl.selectionEnd??s;
      if(s!==e){ exprEl.value = exprEl.value.slice(0,s)+exprEl.value.slice(e); exprEl.setSelectionRange(s,s); return; }
      exprEl.value = exprEl.value.slice(0,exprEl.value.length-1); return;
    }
    if(k==='='){ compute(true); return; }
    if(k==='MS'){ memory = Number(safeCompute(exprEl.value).result ?? 0); toast('Stored: '+memory); return; }
    if(k==='MR'){ insertText(String(memory)); return; }
    if(k==='M+'){ memory += Number(safeCompute(exprEl.value).result ?? 0); toast('M = '+memory); return; }
    if(k==='MC'){ memory=0; toast('Memory cleared'); return; }

    if(k==='^2'){ insertText('^2'); return; }
    if(k==='1/'){
      // wrap last token or current selection
      const v = exprEl.value; const s=exprEl.selectionStart??v.length; const e=exprEl.selectionEnd??s;
      const sel = s!==e? v.slice(s,e) : lastToken(v);
      const start = s!==e? s : v.lastIndexOf(sel);
      exprEl.value = v.slice(0,start)+'1/('+sel+')'+v.slice(start+sel.length);
      exprEl.setSelectionRange(start+5+sel.length, start+5+sel.length);
      return;
    }
    insertText(k);
  }

  function lastToken(v){
    const m = v.match(/[a-zA-Zπe0-9_.]+(?=[^a-zA-Z0-9_.]*$)/);
    return m? m[0] : '';
  }

  // Keyboard shortcuts
  exprEl.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter'){ ev.preventDefault(); compute(true); }
    if(ev.key==='ArrowUp'){ cycleHistory(-1); ev.preventDefault(); }
    if(ev.key==='ArrowDown'){ cycleHistory(1); ev.preventDefault(); }
  });

  function cycleHistory(dir){
    if(!history.length) return;
    if(histIndex===-1) histIndex = history.length-1; else histIndex = (histIndex+dir+history.length)%history.length;
    const item = history[histIndex];
    exprEl.value = item.expr;
  }

  // Evaluate
  if(showStepsBtn) showStepsBtn.onclick=()=>compute(true);
  if(addHistBtn) addHistBtn.onclick=()=>{ addHistory(exprEl.value, safeCompute(exprEl.value).result); };

  function compute(){
    const input = (exprEl.value||'').trim();
    stepsEl.innerHTML = '';
    if(!input){ addStep('Enter an expression to evaluate.', true); return; }
    const {result, steps, error} = safeCompute(input, DEG);
    if(error){ addStep('Error: '+error, false); return; }
    addStep('Input: '+input, true);
    steps.forEach(s=> addStep(s,true));
    addStep('Result = '+result, true);
    // Printable area
    if(pExpr) pExpr.textContent = input;
    if(pRes)  pRes.textContent  = result;
    if(pSteps) pSteps.textContent = ['Input: '+input, ...steps, 'Result = '+result].join('\n');
    addHistory(input, result);
    return result;
  }

  function addStep(text){
    const div=document.createElement('div');
    div.className='step';
    div.textContent = text;
    stepsEl.appendChild(div);
    stepsEl.scrollTop = stepsEl.scrollHeight;
  }

  function addHistory(expr, res){
    if(!expr) return;
    history.push({expr,res,ts:new Date()}); histIndex = -1;
    const item=document.createElement('div'); item.className='item';
    item.textContent = expr+' = '+res;
    item.title = new Date().toLocaleString();
    item.addEventListener('click',()=>{ exprEl.value = expr; });
    histEl.prepend(item);
  }

  function toast(msg){ addStep(msg,true); }

  // Safe compute engine with symbol support + basic step logging
  function safeCompute(input, degMode=true){
    const steps=[];
    try{
      let expr = input
        .replace(/π/g,'pi')
        .replace(/×/g,'*')
        .replace(/÷/g,'/')
        .replace(/\^/g,'**')
        .replace(/√/g,'sqrt');

      // Percent: convert number% -> (number/100)
      expr = expr.replace(/(\d+(?:\.\d+)?)\s*%/g,'($1/100)');

      steps.push('Normalize: '+expr);

      // Wrap trig for DEG if needed
      const trig = ['sin','cos','tan'];
      if(degMode){
        trig.forEach(fn=>{
          const re = new RegExp('\\b'+fn+'\\(([^()]+)\\)','g');
          expr = expr.replace(re, (_,a)=> `${fn}d(${a})`);
        });
        steps.push('DEG mode: converted sin/cos/tan(x) → '+trig.map(f=>f+'d').join(', '));
      }

      // Allow names
      const scope = buildScope();

      // Try to expose interim simplifications by evaluating nested function calls progressively
      const preview = simplifyPreview(expr, scope);
      steps.push(...preview.logs);

      const fn = new Function(...Object.keys(scope), 'return ('+preview.expr+')');
      const result = fn(...Object.values(scope));
      steps.push('Evaluate: '+preview.expr+' → '+result);
      return {result: formatNumber(result), steps, normalized: preview.expr};
    }catch(err){
      return {result:null, steps, error: err.message};
    }
  }

  function buildScope(){
    const toRad = (x)=> x*Math.PI/180;
    // Trig with DEG wrappers
    const sind = (x)=> Math.sin(toRad(evalIfString(x)));
    const cosd = (x)=> Math.cos(toRad(evalIfString(x)));
    const tand = (x)=> Math.tan(toRad(evalIfString(x)));

    return {
      // constants
      pi: Math.PI, e: Math.E, c: 299792458,
      // basic math
      sqrt: Math.sqrt, abs: Math.abs, exp: Math.exp, floor: Math.floor, ceil: Math.ceil, round: Math.round,
      ln: Math.log, log: (x)=> Math.log10(evalIfString(x)),
      sin: Math.sin, cos: Math.cos, tan: Math.tan,
      asin: Math.asin, acos: Math.acos, atan: Math.atan,
      sind, cosd, tand,
      // demo identifiers
      a: undefined, b: undefined, c: undefined, rho: undefined, CSTr: undefined, TCST: undefined, m: undefined, n: undefined, t: undefined, P: undefined
    };
  }

  function evalIfString(x){ return (typeof x==='string')? Number(x): x; }

  // Attempt a human-readable simplification preview: evaluate innermost functions with numeric args
  function simplifyPreview(expr, scope){
    const logs=[]; let e = expr;
    const fnMap = ['sqrt','abs','exp','ln','log','sin','cos','tan','sind','cosd','tand','asin','acos','atan'];
    for(let k=0;k<8;k++){
      let changed=false;
      for(const fn of fnMap){
        const re = new RegExp('\\b'+fn+'\\(([-+]?\\d+(?:\\.\\d+)?)\\)','g');
        e = e.replace(re, (_,num)=>{
          try{
            const F = new Function(...Object.keys(scope), `return ${fn}(${num})`);
            const out = F(...Object.values(scope));
            logs.push(`${fn}(${num}) → ${formatNumber(out)}`);
            changed=true; return String(out);
          }catch{ return `${fn}(${num})`; }
        });
      }
      if(!changed) break;
    }
    return {expr:e, logs};
  }

  function formatNumber(x){
    if(typeof x!=='number' || !isFinite(x)) return String(x);
    const ax = Math.abs(x);
    if(ax!==0 && (ax<1e-6 || ax>=1e10)) return x.toExponential(8);
    return Number(x.toFixed(12)).toString();
  }

  // Printing (Unicode-safe via iframe srcdoc)
  function buildPrintHtml(){
    const googleFonts = '<link rel="preconnect" href="https://fonts.googleapis.com">\\n<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\\n<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Noto+Sans+Symbols+2&family=Noto+Sans+Math&display=swap" rel="stylesheet">';
    const styles = `
      <style>
        :root{ --mono: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; --sym: 'Noto Sans Math','Noto Sans Symbols 2','Noto Sans','Segoe UI Symbol','DejaVu Sans','Arial Unicode MS', system-ui, sans-serif; }
        body{font-family:var(--sym); margin:20px; color:#111}
        h2{margin:0 0 8px}
        pre{white-space:pre-wrap;background:#f7f7f9;border:1px solid #e5e7eb;border-radius:8px;padding:12px;font-family:var(--mono)}
        .meta{margin:6px 0}
        .meta strong{display:inline-block;min-width:90px}
      </style>`;
    const safe = (s)=> String(s||'').replace(/[&<>]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    return `<!doctype html><html><head><meta charset="utf-8">${googleFonts}${styles}</head><body>`+
           `<h2>Calculation Summary</h2>`+
           `<div class="meta"><strong>Expression:</strong> ${safe(pExpr?.textContent||'—')}</div>`+
           `<div class="meta"><strong>Result:</strong> ${safe(pRes?.textContent||'—')}</div>`+
           `<div class="meta"><strong>Mode:</strong> ${safe(pMode?.textContent||'DEG')}</div>`+
           `<h3>Steps</h3>`+
           `<pre>${safe(pSteps?.textContent||'')}</pre>`+
           `</body></html>`;
  }

  function printSummary(){
    const html = buildPrintHtml();
    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.srcdoc = html;
    iframe.onload = () => {
      try{ const w = iframe.contentWindow; w.focus(); w.print(); }catch(err){ console.error('Print failed:', err); }
      setTimeout(()=>{ if(iframe.parentNode) iframe.parentNode.removeChild(iframe); }, 500);
    };
    document.body.appendChild(iframe);
  }
  if(printBtn) printBtn.addEventListener('click', printSummary);

  // Clear Results
  if(clearBtn) clearBtn.addEventListener('click', ()=>{
    exprEl.value=''; stepsEl.innerHTML=''; histEl.innerHTML='';
    if(pExpr) pExpr.textContent='—'; if(pRes) pRes.textContent='—'; if(pMode) pMode.textContent = (DEG? 'DEG':'RAD');
    if(pSteps) pSteps.textContent='(Run a calculation to populate this section.)';
  });

  // ---- Built-in Tests ----
  function logTest(msg, pass){
    const d=document.createElement('div'); d.className='step';
    d.style.borderColor = pass? 'rgba(52,230,162,.4)': 'rgba(255,107,139,.5)';
    d.textContent = (pass? '✔ ' : '✘ ') + msg;
    testOutput.appendChild(d); testOutput.scrollTop = testOutput.scrollHeight;
  }

  function approxEq(a,b,eps=1e-9){ return Math.abs(a-b) <= eps*(1+Math.max(Math.abs(a),Math.abs(b))); }

  function runTests(){
    testOutput.innerHTML='';
    // 1) Trig mix in DEG
    let r1 = safeCompute('sin(30)+cos(60)+tan(45)', true).result; // DEG
    logTest('sin(30)+cos(60)+tan(45) (DEG) == 2 → '+r1, approxEq(Number(r1),2));

    // 2) Radians test
    let r2 = safeCompute('sin(pi/6)+cos(pi/3)', false).result; // RAD
    logTest('sin(pi/6)+cos(pi/3) (RAD) == 1 → '+r2, approxEq(Number(r2),1));

    // 3) Percent & power
    let r3 = safeCompute('200*15% + 2^5', true).result;
    logTest('200*15% + 2^5 == 62 → '+r3, approxEq(Number(r3),62));

    // 4) Vector magnitude
    let r4 = safeCompute('sqrt(3^2 + 4^2)', true).result;
    logTest('sqrt(3^2+4^2) == 5 → '+r4, approxEq(Number(r4),5));

    // 5) Log rules
    let r5 = safeCompute('ln(e^2) + log(1000) - ln(e)', true).result;
    logTest('ln(e^2)+log(1000)-ln(e) == 4 → '+r5, approxEq(Number(r5),4));

    // 6) Quadratic (+) with a=1,b=-3,c=2 should be 2 (plus root)
    let r6 = safeCompute('(-3 + sqrt((-3)^2 - 4*1*2)) / (2*1)', true).result;
    logTest('Quadratic (+) root == 2 → '+r6, approxEq(Number(r6),2));

    // 7) CST Energy sample — finite check
    let r7 = safeCompute('(1.2/0.8)*(299792458*0.97*1.03)^2', true).result;
    logTest('CST Energy sample is finite → '+r7, isFinite(Number(r7)));

    // 8) Symbols sample presence (visual)
    const symbolSample = 'π √ ± ∑ ∫ θ λ μ σ Ω ∞ ≈ ≤ ≥ ≠ × ÷ → ← °';
    logTest('Symbols sample present → '+symbolSample, /π/.test(symbolSample) && /√/.test(symbolSample) && /±/.test(symbolSample));
  }

  if(runTestsBtn) runTestsBtn.addEventListener('click', runTests);

})();
});
</script>
</body>
</html>
