<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1st Quantum Computer Calculator — Home Concept (No Framework)</title>
<style>
:root{
  --bg:#f7f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280;
  --accent:#4f46e5; --green:#10b981; --warn:#ef4444; --ring:#d1d5db;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
h1{font-size:28px;margin:8px 0}
.container{max-width:1200px;margin:0 auto;padding:20px}
.grid{display:grid;gap:16px}
.grid-3{grid-template-columns:1.6fr 1.2fr 1fr}
@media (max-width:1100px){.grid-3{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:16px}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.display{min-height:48px;padding:10px 12px;font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--ring);border-radius:12px;background:#f9fafb;display:flex;align-items:flex-start;overflow:auto}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;font-weight:600;background:#e5e7eb;color:#111;box-shadow:0 2px 0 rgba(0,0,0,.06)}
.btn:hover{background:#dbe1e8}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent);color:#fff}
.btn.start{background:var(--green);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.kv{display:grid;grid-template-columns:1fr 2fr;gap:8px;font-size:14px}
.k{color:var(--muted)}
.v{font-weight:700}
.input, textarea{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:12px}
.small{font-size:12px;color:var(--muted)}
.list{display:grid;gap:8px}
.example{border:1px solid var(--ring);border-radius:12px;padding:10px}
.section-title{font-weight:800;font-size:18px;margin:8px 0 6px}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px}
.hr{height:1px;background:#eee;margin:12px 0}
.gauge-wrap{width:100%}
.gauge-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;color:var(--muted)}
.gauge{width:100%;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.gauge .fill{height:8px;background:var(--accent)}
.preview{max-width:100%;max-height:200px;border:1px solid var(--ring);border-radius:12px;display:block}
.err{color:var(--warn)}
</style>
</head>
<body>
<div class="container">
  <h1>1st Quantum Computer Calculator — Home Concept</h1>
  <p class="small">
    Use any of the three inputs below. If an equation can’t be solved, please check symbols and parentheses.
    The calculator prints a full solution tape. The quantum section at the bottom is a <b>visual showcase</b> only.
  </p>

  <div class="grid grid-3">
    <!-- Left: Calculator + Word Problem -->
    <div class="grid" style="gap:16px">
      <div class="card" id="calcCard">
        <div class="section-title">1) Scientific Calculator — Step-by-Step</div>
        <div class="label">Equation</div>
        <div class="display" id="calc-print-area">
          <div id="calcOutput">
            <div><b>Input:</b> <span class="code" id="calcExpr">(empty)</span></div>
            <div id="calcResultWrap" style="margin-top:6px;display:none;"><b>Result:</b> <span class="code" id="calcResult"></span></div>
            <div id="calcStepsWrap" style="margin-top:8px;display:none;">
              <b>Step-by-step:</b>
              <ol id="calcSteps"></ol>
            </div>
            <div class="err" id="calcErr" style="margin-top:6px;display:none;"></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px" id="calcButtons"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSolve">= Solve</button>
          <button class="btn" id="btnReset">Reset Label</button>
          <button class="btn warn" id="btnClear">Clear All</button>
          <button class="btn" id="btnPrintCalc">Print Steps</button>
        </div>
        <div class="hr"></div>
        <div class="label">10 Practice Examples (click to load)</div>
        <div class="list" id="calcExamples"></div>
      </div>

      <div class="card">
        <div class="section-title">2) Write a Word Problem → Equation → Steps</div>
        <textarea class="input" rows="4" id="wpText" placeholder="Type your word problem here..."></textarea>
        <div class="row" style="margin-top:8px"><button class="btn" id="btnWpDerive">Derive Equation</button></div>
        <div class="hr"></div>
        <div class="label">Derived Equation</div>
        <div class="display"><span class="code" id="wpEqn">(none)</span></div>
        <div class="small" id="wpNote"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="btnWpSolve">= Solve</button>
          <button class="btn" id="btnPrintWp">Print Steps</button>
        </div>
        <div id="wp-print" style="margin-top:8px">
          <div id="wpResWrap" style="display:none;"><b>Result:</b> <span class="code" id="wpRes"></span></div>
          <div id="wpStepsWrap" style="margin-top:6px;display:none;"><b>Step-by-step:</b><ol id="wpSteps"></ol></div>
          <div class="err" id="wpErr" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- Middle: Upload + History -->
    <div class="grid" style="gap:16px">
      <div class="card">
        <div class="section-title">3) Upload a Diagram / Problem Statement</div>
        <input type="file" accept="image/*,.pdf" id="upFile" />
        <img class="preview" id="upPreview" alt="" style="display:none;margin-top:8px"/>
        <div class="small" id="upInfo" style="margin-top:6px"></div>
        <div class="label" style="margin-top:8px">Describe what to solve (then type the equation in the calculator)</div>
        <textarea class="input" rows="3" id="upNote" placeholder="e.g., 'Find the area of the shaded circle (r=7), then subtract the area of the triangle (base=6,height=4)'"></textarea>
        <div class="small" style="margin-top:6px">
          This panel stores your file + notes and suggests an approach. Use the calculator for step-by-step solving and printing.
        </div>
      </div>

      <div class="card">
        <div class="section-title">Recent Solves</div>
        <div class="small" id="histEmpty">No solves yet.</div>
        <div id="histList"></div>
      </div>
    </div>

    <!-- Right: How it works + Practice list -->
    <div class="grid" style="gap:16px">
      <div class="card">
        <div class="section-title">How This Calculator Works</div>
        <ol class="small">
          <li>Type an equation or derive one from a word problem.</li>
          <li>We tokenize the input (numbers, operators, functions, parentheses).</li>
          <li>We convert to RPN (shunting-yard) to respect order of operations.</li>
          <li>We evaluate the RPN stack and log each operation as a step.</li>
          <li>You can print the steps as a report (PDF or paper).</li>
        </ol>
        <div class="hr"></div>
        <div class="section-title">10 Practice Prompts</div>
        <ul class="small" id="practiceList"></ul>
      </div>

      <div class="card">
        <div class="section-title">What You’ve Invented — Home Quantum Concept</div>
        <ul class="small">
          <li>Photonic qubits (energy-encoded)</li>
          <li>Optical routing & filtering (slits/AWG coin sorter)</li>
          <li>Self-learning control (Gate Keeper + right/error memory)</li>
        </ul>
        <div class="small">Room-temperature quantum-wave computer: <b>massive parallel fibers + coherence control</b> instead of deep cryogenics.</div>
      </div>
    </div>
  </div>

  <!-- Quantum Showcase -->
  <div style="margin-top:16px" class="card">
    <div class="section-title">Internal Quantum Computer (Showcase Only)</div>
    <div class="small" style="margin-bottom:8px">
      As you add more parallel fibers, the error falls and the interference pattern stabilizes
      (<b>Gate Keeper</b> phase/energy feedback + dump path). This is a classical wave simulation (not single-photon),
      demonstrating your architecture: massive parallelism + coherence control can trade cryogenics for redundancy and feedback.
    </div>
    <div class="row">
      <button class="btn start" id="btnRunShow">Run Showcase</button>
      <span class="small">Fibers: <span id="showFibers">360</span> • Phase noise σ: <span id="showPhase">0.22</span> • Amp noise σ: <span id="showAmp">0.12</span></span>
    </div>
    <div class="hr"></div>
    <svg id="showSvg" width="640" height="240" style="background:#fff;border:1px solid #e5e7eb;border-radius:12px">
      <text x="12" y="18" font-size="12" fill="#111">
        Energy bands interleaved • number in each bar = flip (0/1) • dumped lanes faded
      </text>
    </svg>
    <div class="row" style="margin-top:8px">
      <div class="gauge-wrap" style="min-width:220px">
        <div class="gauge-label"><span>Coherence (visibility)</span><span id="gVis">0.0%</span></div>
        <div class="gauge"><div class="fill" id="gVisFill" style="width:0%"></div></div>
      </div>
      <div class="gauge-wrap" style="min-width:220px">
        <div class="gauge-label"><span>Dumped lanes</span><span id="gDump">0.0%</span></div>
        <div class="gauge"><div class="fill" id="gDumpFill" style="width:0%"></div></div>
      </div>
      <div class="kv" style="min-width:220px">
        <div class="k">Ones</div><div class="v" id="gOnes">0</div>
        <div class="k">Zeros</div><div class="v" id="gZeros">0</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="section-title">Gate Keeper’s Role in Scaling</div>
    <ul class="small">
      <li>Keeps <b>phase lock</b> across all fibers.</li>
      <li>Routes excess energy to <b>dump/ground</b> to stabilize.</li>
      <li>Averages/discards inconsistent results (decoherence).</li>
      <li>Enables continuous computation — <b>no restart</b> required.</li>
    </ul>
    <div class="section-title">Parallel Scaling Law</div>
    <div class="small">If <b>N</b> fiber lines are used and each line processes one wave computation independently, ideal throughput scales ≈ <b>N×</b> (minus control overhead).</div>
    <ul class="small">
      <li>Boost lane energy (SOA/EDFA or attenuators in reverse)</li>
      <li>Shunt excess via fast MZI + optical isolator</li>
      <li>Hold phase lock so waves combine coherently</li>
    </ul>
    <div class="section-title">Energy Balancing & Telemetry</div>
    <ul class="small">
      <li>Each fiber’s photons carry tiny energy (~10⁻²⁴ J). The Gate Keeper equalizes power using VOAs or gain elements (EDFA/SOA).</li>
      <li>Each fiber reports: <b>Phase φ</b>, <b>Amplitude A</b>, <b>Error E = φ<sub>target</sub> − φ<sub>measured</sub></b>.</li>
    </ul>
    <div class="section-title">Coherent Combination</div>
    <div class="small">We combine <i>waves</i>, not just intensities (MZI/star couplers). Constructive interference boosts correct answers; destructive cancels noise.</div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function randn(){ // Box–Muller
  var u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function printHtml(id, title){
  var node = document.getElementById(id);
  if(!node) return;
  var win = window.open("", "_blank", "width=900,height=1000");
  win.document.write('<html><head><title>'+title+'</title><style>'+
    'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;padding:20px}'+
    '.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px}'+
    '</style></head><body>'+node.innerHTML+'</body></html>');
  win.document.close(); win.focus(); win.print();
}

/* ===== Calculator: tokenizer → RPN → eval with steps ===== */
function tokenize(expr){
  var tokens=[], re=/\s*([0-9]*\.?[0-9]+|PI|E|sin|cos|tan|sqrt|ln|log|abs|min|max|floor|ceil|round|[()+\-*/^,])\s*/gi, m;
  while((m=re.exec(expr))!==null){ tokens.push(m[1]); }
  return tokens;
}
function top(arr){ return arr.length? arr[arr.length-1] : undefined; }
function toRPN(tokens){
  var out=[], stack=[], prec={ "^":4,"*":3,"/":3,"+":2,"-":2 }, rightAssoc={"^":true};
  function isFunc(t){ return /^(sin|cos|tan|sqrt|ln|log|abs|min|max|floor|ceil|round)$/i.test(t); }
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i];
    if(/^[0-9]*\.?[0-9]+$/.test(t)||t==="PI"||t==="E"){ out.push(t); }
    else if(isFunc(t)){ stack.push(t); }
    else if(t===","){ while(stack.length && top(stack)!=="(") out.push(stack.pop()); }
    else if(t==="+"||t==="-"||t==="*"||t==="/"||t==="^"){
      while(stack.length){
        var o2=top(stack);
        if((o2==="+"||o2==="-"||o2==="*"||o2==="/"||o2==="^") &&
          ((rightAssoc[t] && prec[t] < prec[o2]) || (!rightAssoc[t] && prec[t] <= prec[o2]))){
          out.push(stack.pop());
        } else break;
      }
      stack.push(t);
    } else if(t==="("){ stack.push(t); }
    else if(t===")"){
      while(stack.length && top(stack)!=="(") out.push(stack.pop());
      stack.pop();
      if(stack.length && /^(sin|cos|tan|sqrt|ln|log|abs|min|max|floor|ceil|round)$/i.test(top(stack))) out.push(stack.pop());
    }
  }
  while(stack.length) out.push(stack.pop());
  return out;
}
function evalRPNWithSteps(rpn){
  var M=Math, stack=[], steps=[];
  function show(s){ steps.push(s); }
  function op(a,b,sign){
    if(sign==="+") return a+b;
    if(sign==="-") return a-b;
    if(sign==="*") return a*b;
    if(sign==="/") return a/b;
    if(sign==="^") return Math.pow(a,b);
  }
  var map={
    sin:M.sin, cos:M.cos, tan:M.tan, sqrt:M.sqrt, ln:M.log,
    log: M.log10 ? function(x){return M.log10(x);} : function(x){return M.log(x)/Math.LN10;},
    abs:M.abs, floor:M.floor, ceil:M.ceil, round:M.round, min:M.min, max:M.max
  };
  for(var i=0;i<rpn.length;i++){
    var t=rpn[i];
    if(/^[0-9]*\.?[0-9]+$/.test(t)) stack.push(parseFloat(t));
    else if(t==="PI") stack.push(Math.PI);
    else if(t==="E") stack.push(Math.E);
    else if(t==="+"||t==="-"||t==="*"||t==="/"||t==="^"){
      var b=stack.pop(), a=stack.pop(), r=op(a,b,t); show("Compute "+a+" "+t+" "+b+" = "+r); stack.push(r);
    } else if(map[t]){
      if(t==="min"||t==="max"){ var bb=stack.pop(), aa=stack.pop(), rr=map[t](aa,bb); show(t+"("+aa+", "+bb+") = "+rr); stack.push(rr); }
      else { var a1=stack.pop(), r1=map[t](a1); show(t+"("+a1+") = "+r1); stack.push(r1); }
    } else { throw new Error("Bad token"); }
  }
  return { result: stack.pop(), steps: steps };
}
function solveExpressionStepwise(expr){
  var tokens = tokenize(expr);
  if(!tokens.length) throw new Error("Empty expression");
  var rpn = toRPN(tokens);
  return evalRPNWithSteps(rpn);
}

/* ===== Word problem helper ===== */
function deriveEquationFromText(text){
  var t=(text||"").toLowerCase();
  var nums=[], m, re=/-?\d+(\.\d+)?/g; while((m=re.exec(t))!==null) nums.push(parseFloat(m[0]));
  function has(w){ return t.indexOf(w)>-1; }
  if (has("area of a circle") || (has("circle")&&has("area"))){
    var r = nums[0]||1; return {equation:"PI*("+r+")^2", note:"Area of circle with r="+r+": A=πr²"};
  }
  if (has("perimeter of a rectangle") || (has("rectangle")&&has("perimeter"))){
    var a=nums[0]||1,b=nums[1]||1; return {equation:"2*("+(a)+"+"+(b)+")", note:"Perimeter 2(a+b) with a="+a+", b="+b};
  }
  if (has("area of a triangle") || (has("triangle")&&has("area"))){
    var base=nums[0]||1,height=nums[1]||1; return {equation:"0.5*"+base+"*"+height, note:"Area ½bh with b="+base+", h="+height};
  }
  if (has("sum")||has("add")||has("plus")){ var eq = nums.join(" + "); return {equation:eq, note:"Sum of "+nums.join(", ")}; }
  if (has("difference")||has("minus")||has("subtract")){ var eq2 = nums.join(" - "); return {equation:eq2, note:"Difference in order: "+eq2}; }
  if (has("product")||has("multiply")||has("times")){ var eq3 = nums.join(" * "); return {equation:eq3, note:"Product of "+nums.join(", ")}; }
  if (has("average")||has("mean")){ var eq4 = "("+nums.join(" + ")+")/"+(nums.length||1); return {equation:eq4, note:"Average of "+nums.join(", ")}; }
  return {equation: nums.join(" + "), note:"Parsed numbers (edit if needed)"};
}

/* ===== DOM wiring ===== */
(function(){
  // Calculator UI
  var buttons = ["7","8","9","/","sin(","cos(","4","5","6","*","tan(","sqrt(","1","2","3","-","^","(","0",".",")","+","PI","E"];
  var examples = [
    {label:"23*57 + 1024", expr:"23*57 + 1024"},
    {label:"(3^5 - 2^7) + 100", expr:"(3^5 - 2^7) + 100"},
    {label:"PI*7^2 (circle area)", expr:"PI*7^2"},
    {label:"sqrt(9^2+12^2) (hypotenuse)", expr:"sqrt(9^2+12^2)"},
    {label:"(4/3)*PI*5^3 (sphere volume)", expr:"(4/3)*PI*5^3"},
    {label:"min(25, 9) + max(2, 10)", expr:"min(25, 9) + max(2, 10)"},
    {label:"round(3.14159*100)/100", expr:"round(3.14159*100)/100"},
    {label:"(100/2)*(2*3+(100-1)*2)", expr:"(100/2)*(2*3+(100-1)*2)"},
    {label:"2*(8+15) - 3^3", expr:"2*(8+15) - 3^3"},
    {label:"log(1000) + ln(E^2)", expr:"log(1000) + ln(E^2)"}
  ];
  var practiceList = document.getElementById('practiceList');
  practiceList.innerHTML = examples.map(function(ex){ return '<li><span class="code">'+ex.expr+'</span></li>'; }).join("");

  var calcExprText = ""; // the input expression
  var calcExprEl = document.getElementById('calcExpr');
  var calcButtonsEl = document.getElementById('calcButtons');
  var calcExamplesEl = document.getElementById('calcExamples');
  var calcResultWrap = document.getElementById('calcResultWrap');
  var calcResultEl = document.getElementById('calcResult');
  var calcStepsWrap = document.getElementById('calcStepsWrap');
  var calcStepsEl = document.getElementById('calcSteps');
  var calcErrEl = document.getElementById('calcErr');

  function updateCalcExpr(){ calcExprEl.textContent = calcExprText || "(empty)"; }
  function appendToExpr(t){ calcExprText += t; updateCalcExpr(); }
  function clearCalcAll(){
    calcExprText=""; updateCalcExpr();
    calcResultWrap.style.display="none";
    calcStepsWrap.style.display="none";
    calcErrEl.style.display="none";
    calcStepsEl.innerHTML="";
  }
  function resetCalc(){ calcExprText=""; updateCalcExpr(); calcErrEl.style.display="none"; }

  // Render calc buttons
  buttons.forEach(function(b){
    var btn=document.createElement('button'); btn.className='btn'; btn.textContent=b;
    btn.addEventListener('click', function(){ appendToExpr(b); });
    calcButtonsEl.appendChild(btn);
  });

  // Render examples
  examples.forEach(function(ex){
    var div=document.createElement('div'); div.className='example';
    div.innerHTML='<div><b>'+ex.label+'</b></div><div class="small code">'+ex.expr+'</div><div class="row" style="margin-top:6px"><button class="btn">Load</button></div>';
    div.querySelector('button').addEventListener('click', function(){
      calcExprText = ex.expr; updateCalcExpr();
      calcResultWrap.style.display="none"; calcStepsWrap.style.display="none"; calcErrEl.style.display="none"; calcStepsEl.innerHTML="";
    });
    calcExamplesEl.appendChild(div);
  });

  document.getElementById('btnSolve').addEventListener('click', function(){
    calcErrEl.style.display="none";
    try{
      var res = solveExpressionStepwise(calcExprText);
      calcResultWrap.style.display="block"; calcResultEl.textContent=String(res.result);
      calcStepsWrap.style.display="block";
      calcStepsEl.innerHTML = res.steps.map(function(s){return '<li>'+s+'</li>';}).join("");
      addHistory(calcExprText, res.result, res.steps);
    }catch(e){
      calcErrEl.textContent = "Cannot solve. Please check that the equation is entered correctly.";
      calcErrEl.style.display="block";
      calcResultWrap.style.display="none"; calcStepsWrap.style.display="none"; calcStepsEl.innerHTML="";
    }
  });
  document.getElementById('btnReset').addEventListener('click', resetCalc);
  document.getElementById('btnClear').addEventListener('click', clearCalcAll);
  document.getElementById('btnPrintCalc').addEventListener('click', function(){ printHtml('calc-print-area','Calculator Steps'); });
  updateCalcExpr();

  // Word problem wiring
  var wpText = document.getElementById('wpText');
  var wpEqn = document.getElementById('wpEqn');
  var wpNote = document.getElementById('wpNote');
  var wpResWrap = document.getElementById('wpResWrap');
  var wpRes = document.getElementById('wpRes');
  var wpStepsWrap = document.getElementById('wpStepsWrap');
  var wpSteps = document.getElementById('wpSteps');
  var wpErr = document.getElementById('wpErr');

  document.getElementById('btnWpDerive').addEventListener('click', function(){
    var d = deriveEquationFromText(wpText.value||"");
    wpEqn.textContent = d.equation || "(none)";
    wpNote.textContent = d.note || "";
    wpResWrap.style.display="none"; wpStepsWrap.style.display="none"; wpErr.style.display="none"; wpSteps.innerHTML="";
  });
  document.getElementById('btnWpSolve').addEventListener('click', function(){
    wpErr.style.display="none";
    try{
      var eq = wpEqn.textContent;
      var res = solveExpressionStepwise(eq);
      wpResWrap.style.display="block"; wpRes.textContent = String(res.result);
      wpStepsWrap.style.display="block";
      wpSteps.innerHTML = res.steps.map(function(s){return '<li>'+s+'</li>';}).join("");
      addHistory(eq, res.result, res.steps);
    }catch(e){
      wpErr.textContent="Cannot solve derived equation. Edit the equation and try again.";
      wpErr.style.display="block";
      wpResWrap.style.display="none"; wpStepsWrap.style.display="none"; wpSteps.innerHTML="";
    }
  });
  document.getElementById('btnPrintWp').addEventListener('click', function(){ printHtml('wp-print','Word Problem Steps'); });

  // Upload panel
  var upFile = document.getElementById('upFile');
  var upPreview = document.getElementById('upPreview');
  var upInfo = document.getElementById('upInfo');
  upFile.addEventListener('change', function(e){
    var f = e.target.files && e.target.files[0];
    if(!f){ upPreview.style.display="none"; upInfo.textContent=""; return; }
    if(f.type && f.type.indexOf('image/')===0){
      var url=URL.createObjectURL(f); upPreview.src=url; upPreview.style.display="block";
      upInfo.textContent = "Image selected: "+f.name;
    }else{
      upPreview.style.display="none";
      upInfo.textContent = "File selected: "+f.name+" (no image preview)";
    }
  });

  // History
  var hist = [];
  var histEmpty = document.getElementById('histEmpty');
  var histList = document.getElementById('histList');
  function addHistory(expr, result, steps){
    var item = { when:(new Date()).toLocaleString(), expr:expr, result:result, steps:steps };
    hist.unshift(item); if(hist.length>20) hist.pop();
    renderHistory();
  }
  function renderHistory(){
    histEmpty.style.display = hist.length? "none":"block";
    histList.innerHTML = hist.map(function(h,idx){
      return '<div class="example">'+
        '<div class="small">'+h.when+'</div>'+
        '<div><b>Eq:</b> <span class="code">'+h.expr+'</span></div>'+
        '<div><b>Result:</b> <span class="code">'+String(h.result)+'</span></div>'+
        '<details style="margin-top:6px"><summary class="small">Steps</summary><ol>'+
        h.steps.map(function(s){return '<li>'+s+'</li>';}).join("")+
        '</ol></details></div>';
    }).join("");
  }

  // Quantum Showcase (visual only)
  var showSvg = document.getElementById('showSvg');
  var gVis = document.getElementById('gVis'), gVisFill=document.getElementById('gVisFill');
  var gDump = document.getElementById('gDump'), gDumpFill=document.getElementById('gDumpFill');
  var gOnes = document.getElementById('gOnes'), gZeros=document.getElementById('gZeros');

  function runShowcase(){
    // parameters
    var fibers=360, phaseNoise=0.22, ampNoise=0.12, dumpThresh=1.4, bands=4;
    // build lanes
    var lanes=[], i;
    for(i=0;i<fibers;i++){
      var band=i%bands, phi=randn()*phaseNoise, amp=1+randn()*ampNoise;
      lanes.push({band:band, phi:phi, amp:amp, dumped:false});
    }
    // gate keeper: phase/amp correction + dump
    var kPhi=0.6, kAmp=0.5, dumpCount=0;
    for(i=0;i<lanes.length;i++){
      var L=lanes[i];
      L.phi += kPhi*(0 - L.phi);
      L.amp += kAmp*(1 - L.amp);
      if(Math.abs(L.amp)>dumpThresh){ L.amp=0; L.dumped=true; dumpCount++; }
    }
    // flips
    var ones=0;
    for(i=0;i<lanes.length;i++){ var E=lanes[i].amp*Math.cos(lanes[i].phi); if(E>0) ones++; }
    var zeros=fibers-ones;
    // coherence proxy
    var s1=0, s2=0;
    for(i=0;i<lanes.length;i++){ s1 += Math.max(0, lanes[i].amp*Math.cos(lanes[i].phi)); }
    for(i=0;i<lanes.length;i++){ s2 += Math.max(0, lanes[i].amp*Math.cos(lanes[i].phi+Math.PI/2)); }
    var Imax=s1*s1, Imin=s2*s2;
    var visibility=(Imax - Imin) / (Imax + Imin + 1e-12);
    visibility=clamp(visibility,0,1);

    // draw
    while(showSvg.childNodes.length>1) showSvg.removeChild(showSvg.lastChild); // keep heading text
    var bandColors=["#2563eb","#10b981","#f59e0b","#ef4444"];
    var pad=12, cols=60, cellW=10, cellH=12, rowGap=18;
    for(i=0;i<lanes.length;i++){
      var L=lanes[i];
      var x = pad + (i%cols)*cellW;
      var y = 30 + Math.floor(i/cols)*rowGap;
      var rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x",x); rect.setAttribute("y",y);
      rect.setAttribute("width",8); rect.setAttribute("height",cellH);
      rect.setAttribute("rx",2); rect.setAttribute("ry",2);
      rect.setAttribute("fill", bandColors[L.band%bandColors.length]);
      rect.setAttribute("opacity", L.dumped? "0.25":"0.9");
      showSvg.appendChild(rect);
      var flip = Math.cos(L.phi)>0 ? 1:0;
      var txt=document.createElementNS("http://www.w3.org/2000/svg","text");
      txt.setAttribute("x", x+4); txt.setAttribute("y", y+10);
      txt.setAttribute("font-size","8"); txt.setAttribute("text-anchor","middle");
      txt.setAttribute("fill","#111"); txt.setAttribute("opacity", L.dumped? "0.25":"0.9");
      txt.textContent = String(flip);
      showSvg.appendChild(txt);
    }
    // gauges
    gVis.textContent=(visibility*100).toFixed(1)+"%";
    gVisFill.style.width=(visibility*100).toFixed(1)+"%";
    var dumpRate = dumpCount/fibers;
    gDump.textContent=(dumpRate*100).toFixed(1)+"%";
    gDumpFill.style.width=(dumpRate*100).toFixed(1)+"%";
    gOnes.textContent=String(ones); gZeros.textContent=String(zeros);
  }
  document.getElementById('btnRunShow').addEventListener('click', runShowcase);
})();
</script>
</body>
</html>
