<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1st Quantum Computer Calculator — Linked Simulator (No Framework)</title>
<style>
:root{
  --bg:#f7f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280;
  --accent:#4f46e5; --green:#10b981; --warn:#ef4444; --ring:#d1d5db;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
h1{font-size:28px;margin:8px 0} .container{max-width:1200px;margin:0 auto;padding:20px}
.grid{display:grid;gap:16px} .grid-3{grid-template-columns:1.6fr 1.2fr 1fr}
@media (max-width:1100px){.grid-3{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:16px}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.input, textarea{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:12px;background:#fff}
.display{min-height:48px;padding:10px 12px;font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--ring);border-radius:12px;background:#f9fafb}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;font-weight:600;background:#e5e7eb;color:#111;box-shadow:0 2px 0 rgba(0,0,0,.06)}
.btn:hover{background:#dbe1e8} .btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent);color:#fff} .btn.start{background:var(--green);color:#fff} .btn.warn{background:var(--warn);color:#fff}
.small{font-size:12px;color:var(--muted)} .example{border:1px solid var(--ring);border-radius:12px;padding:10px}
.hr{height:1px;background:#eee;margin:12px 0}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px}
.gauge-wrap{width:100%} .gauge-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;color:var(--muted)}
.gauge{width:100%;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden} .gauge .fill{height:8px;background:var(--accent)}
.err{color:var(--warn)}
.kv{display:grid;grid-template-columns:1fr 2fr;gap:8px;font-size:14px} .k{color:var(--muted)} .v{font-weight:700}
.preview{max-width:100%;max-height:200px;border:1px solid var(--ring);border-radius:12px;display:block}
.keypad{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <h1>1st Quantum Computer Calculator — Home Concept (Linked Simulator)</h1>
  <p class="small">Type into the box or click the keypad. Press <b>= Solve</b> for step-by-step. The quantum showcase below auto-links to your last solve.</p>

  <div class="grid grid-3">
    <!-- LEFT COLUMN: Calculator + Word problem -->
    <div class="grid" style="gap:16px">
      <!-- Calculator -->
      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">1) Scientific Calculator — Step-by-Step</div>

        <div class="label">Enter equation (you can type here)</div>
        <input class="input" id="calcInput" placeholder="e.g., PI*7^2 or sqrt(9^2+12^2) or 23*57+1024" />

        <div class="keypad" id="calcKeypad"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSolve">= Solve</button>
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn" id="btnPrintCalc">Print Steps</button>
          <span class="small" id="linkStatus" style="margin-left:auto"></span>
        </div>

        <div class="hr"></div>

        <div class="display" id="calc-print-area">
          <div><b>Input:</b> <span class="code" id="calcExpr">(empty)</span></div>
          <div id="calcResultWrap" style="margin-top:6px;display:none;"><b>Result:</b> <span class="code" id="calcResult"></span></div>
          <div id="calcStepsWrap" style="margin-top:8px;display:none;">
            <b>Step-by-step:</b>
            <ol id="calcSteps"></ol>
          </div>
          <div class="err" id="calcErr" style="margin-top:6px;display:none;"></div>
        </div>

        <div class="hr"></div>
        <div class="label">Quick Examples (click to load)</div>
        <div id="calcExamples"></div>
      </div>

      <!-- Word Problem -->
      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">2) Word Problem → Equation → Steps</div>
        <textarea class="input" rows="4" id="wpText" placeholder="Try: 'What is one plus one?' or 'Area of a circle radius seven'"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnWpDerive">Derive Equation</button>
          <button class="btn primary" id="btnWpSolve">= Solve</button>
          <button class="btn" id="btnPrintWp">Print Steps</button>
        </div>
        <div class="hr"></div>
        <div class="label">Derived Equation</div>
        <div class="display"><span class="code" id="wpEqn">(none)</span></div>
        <div class="small" id="wpNote"></div>
        <div id="wp-print" style="margin-top:8px">
          <div id="wpResWrap" style="display:none;"><b>Result:</b> <span class="code" id="wpRes"></span></div>
          <div id="wpStepsWrap" style="margin-top:6px;display:none;"><b>Step-by-step:</b><ol id="wpSteps"></ol></div>
          <div class="err" id="wpErr" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- MIDDLE COLUMN: Upload + History -->
    <div class="grid" style="gap:16px">
      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">3) Upload a Diagram / Problem Statement</div>
        <input type="file" accept="image/*,.pdf" id="upFile" />
        <img class="preview" id="upPreview" alt="" style="display:none;margin-top:8px"/>
        <div class="small" id="upInfo" style="margin-top:6px"></div>
        <div class="label" style="margin-top:8px">Describe what to solve</div>
        <textarea class="input" rows="3" id="upNote" placeholder="e.g., 'Find the area of the shaded circle (r=7), then subtract the triangle (base=6,height=4)'"></textarea>
        <div class="small" style="margin-top:6px">Use the calculator above to solve and print the steps.</div>
      </div>

      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">Recent Solves</div>
        <div class="small" id="histEmpty">No solves yet.</div>
        <div id="histList"></div>
      </div>
    </div>

    <!-- RIGHT COLUMN: How it works + Prompts -->
    <div class="grid" style="gap:16px">
      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">How This Calculator Works</div>
        <ol class="small">
          <li>Type an equation or derive from a word problem.</li>
          <li>Tokenizer → Shunting-yard to RPN (order of operations).</li>
          <li>Evaluate RPN and record each operation as a step.</li>
          <li>Print the whole solution tape if you want.</li>
        </ol>
        <div class="hr"></div>
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">Practice Prompts</div>
        <ul class="small" id="practiceList"></ul>
      </div>

      <div class="card">
        <div class="section-title" style="font-weight:800;font-size:18px;margin:0 0 6px">Home Quantum Concept (What You Built)</div>
        <ul class="small">
          <li>Photonic qubits (energy-encoded)</li>
          <li>Optical sorting (slits/AWG coin sorter)</li>
          <li>Gate Keeper control + right/error memory</li>
        </ul>
        <div class="small">The linked showcase below runs after each solve so you can “see” stability/coherence respond to workload.</div>
      </div>
    </div>
  </div>

  <!-- LINKED Quantum Showcase -->
  <div style="margin-top:16px" class="card">
    <div class="row">
      <div class="section-title" style="font-weight:800;font-size:18px;margin:0">Internal Quantum Computer (Showcase — Linked)</div>
      <span class="small" id="linkMsg" style="margin-left:auto;color:#10b981;display:none">Linked to last solve ✓</span>
    </div>
    <div class="small" style="margin:6px 0 8px">
      As you add more parallel fibers, error falls and interference stabilizes (<b>Gate Keeper</b> phase/energy feedback + dump path).
      This is a classical wave simulation (not single-photon) to visualize your architecture.
    </div>
    <div class="row">
      <button class="btn start" id="btnRunShow">Run Showcase Manually</button>
      <span class="small">Fibers: <span id="showFibers">360</span> • Phase noise σ: <span id="showPhase">0.22</span> • Amp noise σ: <span id="showAmp">0.12</span></span>
    </div>
    <div class="hr"></div>
    <svg id="showSvg" width="640" height="240" style="background:#fff;border:1px solid #e5e7eb;border-radius:12px">
      <text x="12" y="18" font-size="12" fill="#111">Energy bands interleaved • number = flip (0/1) • dumped lanes faded</text>
    </svg>
    <div class="row" style="margin-top:8px">
      <div class="gauge-wrap" style="min-width:220px">
        <div class="gauge-label"><span>Coherence (visibility)</span><span id="gVis">0.0%</span></div>
        <div class="gauge"><div class="fill" id="gVisFill" style="width:0%"></div></div>
      </div>
      <div class="gauge-wrap" style="min-width:220px">
        <div class="gauge-label"><span>Dumped lanes</span><span id="gDump">0.0%</span></div>
        <div class="gauge"><div class="fill" id="gDumpFill" style="width:0%"></div></div>
      </div>
      <div class="kv" style="min-width:220px">
        <div class="k">Ones</div><div class="v" id="gOnes">0</div>
        <div class="k">Zeros</div><div class="v" id="gZeros">0</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="small"><b>Gate Keeper Role:</b> phase lock • energy balance (dump to ground if high) • average/discard inconsistent paths • continuous compute.</div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function randn(){ var u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
function top(arr){ return arr.length? arr[arr.length-1] : undefined; }
function printHtml(id, title){
  var node=document.getElementById(id); if(!node) return;
  var win=window.open("","_blank","width=900,height=1000");
  win.document.write('<html><head><title>'+title+'</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;padding:20px}.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px}</style></head><body>'+node.innerHTML+'</body></html>');
  win.document.close(); win.focus(); win.print();
}

/* ========= Calculator Parser (tokens → RPN → eval with steps) ========= */
function tokenize(expr){
  var tokens=[], re=/\s*([0-9]*\.?[0-9]+|PI|E|sin|cos|tan|sqrt|ln|log|abs|min|max|floor|ceil|round|[()+\-*/^,])\s*/gi, m;
  while((m=re.exec(expr))!==null){ tokens.push(m[1]); }
  return tokens;
}
function toRPN(tokens){
  var out=[], stack=[], prec={ "^":4,"*":3,"/":3,"+":2,"-":2 }, rightAssoc={"^":true};
  function isFunc(t){ return /^(sin|cos|tan|sqrt|ln|log|abs|min|max|floor|ceil|round)$/i.test(t); }
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i];
    if(/^[0-9]*\.?[0-9]+$/.test(t)||t==="PI"||t==="E"){ out.push(t); }
    else if(isFunc(t)){ stack.push(t); }
    else if(t===","){ while(stack.length && top(stack)!=="(") out.push(stack.pop()); }
    else if(t==="+"||t==="-"||t==="*"||t==="/"||t==="^"){
      while(stack.length){
        var o2=top(stack);
        if((o2==="+"||o2==="-"||o2==="*"||o2==="/"||o2==="^") &&
           ((rightAssoc[t] && prec[t] < prec[o2]) || (!rightAssoc[t] && prec[t] <= prec[o2]))){
          out.push(stack.pop());
        } else break;
      }
      stack.push(t);
    } else if(t==="("){ stack.push(t); }
    else if(t===")"){
      while(stack.length && top(stack)!=="(") out.push(stack.pop());
      stack.pop();
      if(stack.length && isFunc(top(stack))) out.push(stack.pop());
    }
  }
  while(stack.length) out.push(stack.pop());
  return out;
}
function evalRPNWithSteps(rpn){
  var M=Math, stack=[], steps=[];
  function show(s){ steps.push(s); }
  function op(a,b,sign){
    if(sign==="+") return a+b; if(sign==="-") return a-b; if(sign==="*") return a*b;
    if(sign==="/") return a/b; if(sign==="^") return Math.pow(a,b);
  }
  var map={
    sin:M.sin, cos:M.cos, tan:M.tan, sqrt:M.sqrt, ln:M.log,
    log: M.log10 ? function(x){return M.log10(x);} : function(x){return M.log(x)/Math.LN10;},
    abs:M.abs, floor:M.floor, ceil:M.ceil, round:M.round, min:M.min, max:M.max
  };
  for(var i=0;i<rpn.length;i++){
    var t=rpn[i];
    if(/^[0-9]*\.?[0-9]+$/.test(t)) stack.push(parseFloat(t));
    else if(t==="PI") stack.push(Math.PI);
    else if(t==="E") stack.push(Math.E);
    else if(t==="+"||t==="-"||t==="*"||t==="/"||t==="^"){
      var b=stack.pop(), a=stack.pop(), r=op(a,b,t); show("Compute "+a+" "+t+" "+b+" = "+r); stack.push(r);
    } else if(map[t]){
      if(t==="min"||t==="max"){ var bb=stack.pop(), aa=stack.pop(), rr=map[t](aa,bb); show(t+"("+aa+", "+bb+") = "+rr); stack.push(rr); }
      else { var a1=stack.pop(), r1=map[t](a1); show(t+"("+a1+") = "+r1); stack.push(r1); }
    } else { throw new Error("Bad token"); }
  }
  return { result: stack.pop(), steps: steps };
}
function solveExpressionStepwise(expr){
  var tokens = tokenize(expr);
  if(!tokens.length) throw new Error("Empty expression");
  var rpn = toRPN(tokens);
  return evalRPNWithSteps(rpn);
}

/* ========= Word Problem Helper (number words + basic ops) ========= */
function wordsToEquation(text){
  var t=(text||"").toLowerCase();
  // number words → digits
  var mapNums = {
    "zero":0,"one":1,"two":2,"three":3,"four":4,"five":5,"six":6,"seven":7,"eight":8,"nine":9,
    "ten":10,"eleven":11,"twelve":12,"thirteen":13,"fourteen":14,"fifteen":15,"sixteen":16,"seventeen":17,"eighteen":18,"nineteen":19,
    "twenty":20,"thirty":30,"forty":40,"fifty":50,"sixty":60,"seventy":70,"eighty":80,"ninety":90
  };
  t = t.replace(/\b(plus|add)\b/g," + ")
       .replace(/\b(minus|subtract)\b/g," - ")
       .replace(/\b(times|multiplied by|multiply|product)\b/g," * ")
       .replace(/\b(divided by|divide|over)\b/g," / ");
  // compose two-word numbers like "twenty one"
  t = t.replace(/\b(twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)\s+(one|two|three|four|five|six|seven|eight|nine)\b/g, function(_,a,b){
    return String(mapNums[a]+mapNums[b]);
  });
  // single number words
  t = t.replace(/\b(zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)\b/g, function(m){ return String(mapNums[m]); });

  // templates
  if (/\barea\b.*\bcircle\b/.test(t) || /\bcircle\b.*\barea\b/.test(t)){
    var rMatch = t.match(/radius\s*([0-9]+)|r\s*=\s*([0-9]+)/);
    var r = rMatch ? (rMatch[1]||rMatch[2]) : (t.match(/\b([0-9]+)\b/)||[,"1"])[1];
    return { equation:"PI*("+r+")^2", note:"Area of circle r="+r };
  }
  if (/\barea\b.*\btriangle\b/.test(t)){
    var nums = (t.match(/[0-9]+/g)||["1","1"]).map(Number);
    var b = nums[0]||1, h = nums[1]||1;
    return { equation:"0.5*"+b+"*"+h, note:"Area of triangle ½bh (b="+b+", h="+h+")" };
  }
  // fallback: keep only digits and + - * /
  var cleaned = (t.match(/[0-9]+|[+\-*/()^]/g)||[]).join(" ");
  if(!cleaned) cleaned = "1+1";
  return { equation: cleaned, note:"Parsed basic arithmetic from words" };
}

/* ========= Quantum Showcase (and link) ========= */
var showSvg = null, gVis=null, gVisFill=null, gDump=null, gDumpFill=null, gOnes=null, gZeros=null, linkMsg=null, showFibersEl=null;
function runShowcase(params){
  var fibers = params.fibers||360, phaseNoise=params.phaseNoise||0.22, ampNoise=params.ampNoise||0.12, dumpThresh=1.4, bands=4;
  // lanes
  var lanes=[], i;
  for(i=0;i<fibers;i++){
    var band=i%bands, phi=randn()*phaseNoise, amp=1+randn()*ampNoise;
    lanes.push({band:band, phi:phi, amp:amp, dumped:false});
  }
  // gate keeper
  var kPhi=0.6, kAmp=0.5, dumpCount=0;
  for(i=0;i<lanes.length;i++){
    var L=lanes[i];
    L.phi += kPhi*(0 - L.phi);
    L.amp += kAmp*(1 - L.amp);
    if(Math.abs(L.amp)>dumpThresh){ L.amp=0; L.dumped=true; dumpCount++; }
  }
  // flips
  var ones=0; for(i=0;i<lanes.length;i++){ var E=lanes[i].amp*Math.cos(lanes[i].phi); if(E>0) ones++; }
  var zeros=fibers-ones;
  // coherence proxy
  var s1=0,s2=0; for(i=0;i<lanes.length;i++){ s1+=Math.max(0,lanes[i].amp*Math.cos(lanes[i].phi)); s2+=Math.max(0,lanes[i].amp*Math.cos(lanes[i].phi+Math.PI/2)); }
  var Imax=s1*s1, Imin=s2*s2, visibility=(Imax-Imin)/(Imax+Imin+1e-12); visibility=clamp(visibility,0,1);

  // draw
  while(showSvg.childNodes.length>1) showSvg.removeChild(showSvg.lastChild);
  var bandColors=["#2563eb","#10b981","#f59e0b","#ef4444"];
  var pad=12, cols=60, cellW=10, cellH=12, rowGap=18;
  for(i=0;i<lanes.length;i++){
    var L=lanes[i], x=pad+(i%cols)*cellW, y=30+Math.floor(i/cols)*rowGap;
    var rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",8); rect.setAttribute("height",cellH);
    rect.setAttribute("rx",2); rect.setAttribute("ry",2); rect.setAttribute("fill", bandColors[L.band%bandColors.length]); rect.setAttribute("opacity", L.dumped?"0.25":"0.9");
    showSvg.appendChild(rect);
    var flip = Math.cos(L.phi)>0 ? 1:0;
    var txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x", x+4); txt.setAttribute("y", y+10); txt.setAttribute("font-size","8"); txt.setAttribute("text-anchor","middle");
    txt.setAttribute("fill","#111"); txt.setAttribute("opacity", L.dumped?"0.25":"0.9"); txt.textContent=String(flip);
    showSvg.appendChild(txt);
  }
  // gauges
  gVis.textContent=(visibility*100).toFixed(1)+"%"; gVisFill.style.width=(visibility*100).toFixed(1)+"%";
  var dumpRate=dumpCount/fibers; gDump.textContent=(dumpRate*100).toFixed(1)+"%"; gDumpFill.style.width=(dumpRate*100).toFixed(1)+"%";
  gOnes.textContent=String(ones); gZeros.textContent=String(zeros);
  document.getElementById("showFibers").textContent=fibers;
  linkMsg.style.display = params.linked ? "inline" : "none";
}

/* ========= History ========= */
var hist=[], histEmpty=null, histList=null;
function addHistory(expr,result,steps){
  hist.unshift({ when:(new Date()).toLocaleString(), expr:expr, result:result, steps:steps });
  if(hist.length>20) hist.pop();
  renderHistory();
}
function renderHistory(){
  histEmpty.style.display = hist.length? "none":"block";
  var html="";
  for(var i=0;i<hist.length;i++){
    var h=hist[i], stepsHtml="";
    for(var j=0;j<h.steps.length;j++) stepsHtml += "<li>"+h.steps[j]+"</li>";
    html += '<div class="example"><div class="small">'+h.when+'</div><div><b>Eq:</b> <span class="code">'+h.expr+'</span></div><div><b>Result:</b> <span class="code">'+String(h.result)+'</span></div><details style="margin-top:6px"><summary class="small">Steps</summary><ol>'+stepsHtml+'</ol></details></div>';
  }
  histList.innerHTML = html;
}

/* ========= UI Wiring ========= */
(function(){
  // keypad
  var keypad = ["7","8","9","/","sin(","cos(","4","5","6","*","tan(","sqrt(","1","2","3","-","^","(","0",".",")","+","PI","E"];
  var calcKeypad = document.getElementById("calcKeypad");
  var calcInput = document.getElementById("calcInput");
  for(var i=0;i<keypad.length;i++){
    (function(txt){
      var b=document.createElement("button"); b.className="btn"; b.textContent=txt;
      b.addEventListener("click", function(){ calcInput.value += txt; });
      calcKeypad.appendChild(b);
    })(keypad[i]);
  }

  // examples list
  var examples = [
    "23*57 + 1024",
    "(3^5 - 2^7) + 100",
    "PI*7^2",
    "sqrt(9^2+12^2)",
    "(4/3)*PI*5^3",
    "min(25, 9) + max(2, 10)",
    "round(3.14159*100)/100",
    "(100/2)*(2*3+(100-1)*2)",
    "2*(8+15) - 3^3",
    "log(1000) + ln(E^2)"
  ];
  var calcExamples = document.getElementById("calcExamples");
  var practiceList = document.getElementById("practiceList");
  for(var e=0;e<examples.length;e++){
    var ex = examples[e];
    var div=document.createElement("div"); div.className="example";
    div.innerHTML = '<div><b>'+ex+'</b></div><div class="row" style="margin-top:6px"><button class="btn">Load</button></div>';
    (function(expr, el){ el.querySelector("button").addEventListener("click", function(){ calcInput.value = expr; }); })(ex, div);
    calcExamples.appendChild(div);
  }
  practiceList.innerHTML = examples.map(function(x){ return '<li><span class="code">'+x+'</span></li>'; }).join("");

  // calc outputs
  var calcExprEl=document.getElementById("calcExpr"), calcResWrap=document.getElementById("calcResultWrap"),
      calcResEl=document.getElementById("calcResult"), calcStepsWrap=document.getElementById("calcStepsWrap"),
      calcStepsEl=document.getElementById("calcSteps"), calcErrEl=document.getElementById("calcErr"),
      linkStatus=document.getElementById("linkStatus");

  function doSolve(expr, linkShowcase){
    calcErrEl.style.display="none";
    calcExprEl.textContent = expr || "(empty)";
    try{
      var r = solveExpressionStepwise(expr);
      calcResWrap.style.display="block"; calcResEl.textContent=String(r.result);
      calcStepsWrap.style.display="block"; calcStepsEl.innerHTML = r.steps.map(function(s){return "<li>"+s+"</li>";}).join("");
      addHistory(expr, r.result, r.steps);

      // run linked showcase with fibers scaled by expression length (min 240)
      if(linkShowcase){
        var n = Math.max(240, Math.min(960, 40 * Math.ceil((expr||"").length/4)));
        runShowcase({ fibers:n, linked:true });
        linkStatus.textContent = "Showcase linked (fibers="+n+")";
      } else {
        linkStatus.textContent = "";
      }
    }catch(e){
      calcErrEl.textContent="Cannot solve. Check symbols/parentheses."; calcErrEl.style.display="block";
      calcResWrap.style.display="none"; calcStepsWrap.style.display="none"; calcStepsEl.innerHTML="";
      linkStatus.textContent = "";
    }
  }

  document.getElementById("btnSolve").addEventListener("click", function(){ doSolve(calcInput.value, true); });
  document.getElementById("btnClear").addEventListener("click", function(){
    calcInput.value=""; calcExprEl.textContent="(empty)"; calcResWrap.style.display="none"; calcStepsWrap.style.display="none";
    calcStepsEl.innerHTML=""; calcErrEl.style.display="none"; linkStatus.textContent=""; document.getElementById("linkMsg").style.display="none";
  });
  document.getElementById("btnPrintCalc").addEventListener("click", function(){ printHtml("calc-print-area","Calculator Steps"); });

  // word problem
  var wpText=document.getElementById("wpText"), wpEqn=document.getElementById("wpEqn"), wpNote=document.getElementById("wpNote"),
      wpResWrap=document.getElementById("wpResWrap"), wpRes=document.getElementById("wpRes"),
      wpStepsWrap=document.getElementById("wpStepsWrap"), wpSteps=document.getElementById("wpSteps"), wpErr=document.getElementById("wpErr");
  document.getElementById("btnWpDerive").addEventListener("click", function(){
    var d = wordsToEquation(wpText.value||"");
    wpEqn.textContent = d.equation || "(none)";
    wpNote.textContent = d.note || "";
    wpResWrap.style.display="none"; wpStepsWrap.style.display="none"; wpErr.style.display="none"; wpSteps.innerHTML="";
    // also copy to calc input for convenience
    calcInput.value = d.equation || "";
  });
  document.getElementById("btnWpSolve").addEventListener("click", function(){
    var eq = wpEqn.textContent||"";
    try{
      var r = solveExpressionStepwise(eq);
      wpResWrap.style.display="block"; wpRes.textContent=String(r.result);
      wpStepsWrap.style.display="block"; wpSteps.innerHTML=r.steps.map(function(s){return "<li>"+s+"</li>";}).join("");
      addHistory(eq, r.result, r.steps);
      // linked showcase from word problem too
      var n = Math.max(240, Math.min(960, 40 * Math.ceil((eq||"").length/4)));
      runShowcase({ fibers:n, linked:true });
      linkStatus.textContent = "Showcase linked (fibers="+n+")";
    }catch(e){
      wpErr.textContent="Cannot solve derived equation. Edit and try again."; wpErr.style.display="block";
      wpResWrap.style.display="none"; wpStepsWrap.style.display="none"; wpSteps.innerHTML="";
    }
  });
  document.getElementById("btnPrintWp").addEventListener("click", function(){ printHtml("wp-print","Word Problem Steps"); });

  // upload
  var upFile=document.getElementById("upFile"), upPreview=document.getElementById("upPreview"), upInfo=document.getElementById("upInfo");
  upFile.addEventListener("change", function(e){
    var f=e.target.files && e.target.files[0]; if(!f){ upPreview.style.display="none"; upInfo.textContent=""; return; }
    if(f.type && f.type.indexOf("image/")===0){ var url=URL.createObjectURL(f); upPreview.src=url; upPreview.style.display="block"; upInfo.textContent="Image selected: "+f.name; }
    else { upPreview.style.display="none"; upInfo.textContent="File selected: "+f.name+" (no image preview)"; }
  });

  // history elements
  histEmpty=document.getElementById("histEmpty"); histList=document.getElementById("histList");

  // showcase controls
  showSvg=document.getElementById("showSvg"); gVis=document.getElementById("gVis"); gVisFill=document.getElementById("gVisFill");
  gDump=document.getElementById("gDump"); gDumpFill=document.getElementById("gDumpFill"); gOnes=document.getElementById("gOnes"); gZeros=document.getElementById("gZeros");
  linkMsg=document.getElementById("linkMsg"); showFibersEl=document.getElementById("showFibers");
  document.getElementById("btnRunShow").addEventListener("click", function(){ runShowcase({ fibers:360, linked:false }); });

})();
</script>
</body>
</html>
