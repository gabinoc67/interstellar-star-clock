<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audio → CSV (60s) — Minimal Panel</title>
<style>
  :root{--bg:#0b1222;--panel:#111a34;--ink:#eaf0ff;--muted:#a7b7e6;--border:#213067;--btn:#162455;--btnH:#1d2e6e;--ok:#10b981;--bad:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h1{font-size:18px;margin:0 0 12px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  button,input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--ink);cursor:pointer}
  button:hover{background:var(--btnH)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--border);border-radius:10px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  small.hint{display:block;color:var(--muted);margin-top:6px}
  .fileRow{display:flex;gap:8px;align-items:center}
  .fname{font-size:12px;color:#bcd3ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Audio → CSV Notes (60s)</h1>
    <section class="card">
      <label><strong>Audio → CSV Notes (60s)</strong></label>
      <div class="row3" style="margin-top:6px">
        <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
        <button id="btnAnalyze">2) Analyze 60s</button>
        <button id="btnExport">3) Export CSV (enriched)</button>
      </div>
      <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" hidden />
      <div class="row2" style="margin-top:8px">
        <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
        <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
      </div>
      <small class="hint">Enriched CSV headers required: <b>t,midi,vel,dur,is_bass,bar,beat,bpm,key</b>.</small>

      <div class="hr"></div>

      <label><strong>Load Enriched CSV Notes → A / B</strong></label>
      <div class="row2">
        <div>
          <div class="fileRow">
            <input id="csvA" type="file" accept=".csv"/>
          </div>
          <div class="row2" style="margin-top:6px;grid-template-columns:auto 1fr">
            <button id="btnLoadA" style="max-width:180px">Load CSV → A</button>
            <div class="fname" id="nameA">—</div>
          </div>
        </div>
        <div>
          <div class="fileRow">
            <input id="csvB" type="file" accept=".csv"/>
          </div>
          <div class="row2" style="margin-top:6px;grid-template-columns:auto 1fr">
            <button id="btnLoadB" style="max-width:180px">Load CSV → B</button>
            <div class="fname" id="nameB">—</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div id="status" class="stat"><span>Status</span><b>Ready.</b></div>
    </section>
  </div>

<script>
/* ================= Core state ================= */
let LAST_ANALYSIS = { events: [], meta: { bpm: 100, key: "C major" } };
let A = { events: [], meta: { bpm: 100, key: "C major" } };
let B = { events: [], meta: { bpm: 100, key: "C major" } };

/* ================= DOM helpers ================= */
const $ = id => document.getElementById(id);
const detKey = $("detKey"), detBPM = $("detBPM"), statusEl = $("status").lastElementChild;

/* ================= CSV helpers ================= */
function csvEscape(v){ const s=String(v); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
function toEnrichedCSV(events, bpm, key){
  const header = "t,midi,vel,dur,is_bass,bar,beat,bpm,key";
  const rows = events.map(e => [
    (e.t ?? 0).toFixed(3),
    e.midi|0,
    Math.round((e.vel ?? 0.7)*127),
    (e.dur ?? (e.isBass?0.450:0.280)).toFixed(3),
    e.isBass?1:0,
    e.bar|0,
    (e.beat ?? 1).toFixed(3),
    bpm|0,
    key
  ].map(csvEscape).join(","));
  return [header, ...rows].join("\n");
}
function parseEnrichedCSV(text){
  const lines=text.replace(/\r/g,'').trim().split('\n');
  if(!lines.length) throw new Error("Empty CSV.");
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const required=['t','midi','vel','dur','is_bass','bar','beat','bpm','key'];
  for(const k of required){ if(hdr.indexOf(k)<0) throw new Error("CSV must include: "+required.join(',')); }
  const idxs=Object.fromEntries(hdr.map((h,i)=>[h,i]));
  const out=[], meta={bpm:100,key:"C major"};
  for(let i=1;i<lines.length;i++){
    const r=lines[i].split(',');
    if(r.length<hdr.length) continue;
    const t=parseFloat(r[idxs.t]);
    const midi=parseInt(r[idxs.midi],10);
    const vel=(parseFloat(r[idxs.vel])||90)/127;
    const dur=parseFloat(r[idxs.dur]);
    const isb=+r[idxs.is_bass]===1;
    const bar=parseInt(r[idxs.bar],10);
    const beat=parseFloat(r[idxs.beat]);
    const bpm=parseInt(r[idxs.bpm],10);
    const key=(r[idxs.key]||'C major').trim();
    if(i===1){ if(Number.isFinite(bpm)) meta.bpm=bpm; meta.key=key; }
    if(Number.isFinite(t)&&Number.isFinite(midi)){
      out.push({t, midi, vel, dur, isBass:isb, bar:bar||1, beat:beat||1});
    }
  }
  out.sort((a,b)=>a.t-b.t);
  return {events:out, meta};
}

/* ================= Music/key detection (compact) ================= */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; } return best.name; }
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0;}
function acPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++)mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const minF=60,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag;lag<=Math.min(maxLag,N-2);lag++){let s=0;for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if(s>best){best=s;bestLag=lag;}}
  return bestLag? sr/bestLag : 0;
}

/* ================= Bars/beats for export ================= */
function barsBeats(t, bpm){
  const spb=60/Math.max(40,Math.min(220,bpm));
  const beat=t/spb, bar=Math.floor(beat/4)+1, beatInBar=(beat%4)+1;
  return {bar, beat:beatInBar};
}

/* ================= Analyzer (60s) ================= */
async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  statusEl.textContent="Decoding…";
  const arr=await file.arrayBuffer();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await ctx.decodeAudioData(arr.slice(0));
  const sr=buf.sampleRate, ch=buf.numberOfChannels, N=Math.min(buf.length, sr*60|0);

  // mono mix
  const mono=new Float32Array(N);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<N;i++) mono[i]+=d[i]/ch; }

  // rough onset + pitch frames
  const frame=4096, hop=2048;
  const pc=new Float32Array(12); const on=[]; const notes=[];
  let prevE=0;
  for(let st=0; st+frame<=N; st+=hop){
    const fr=mono.subarray(st,st+frame);
    let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if(dE>0.08) on.push(st);

    let f=acPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
    if(f){ const midi=Math.round(69+12*Math.log2(f/440)); pc[(midi%12+12)%12]++; notes.push({t:st/sr,midi}); }
  }

  // key
  const keyName=correlate(Array.from(pc));

  // bpm from onset deltas (median)
  const dif=[]; for(let i=1;i<on.length;i++){ const dt=(on[i]-on[i-1])/sr; if(dt>0.18&&dt<2.2) dif.push(dt); }
  let bpm=100; if(dif.length){ const s=[...dif].sort((a,b)=>a-b), m=s[Math.floor(s.length/2)]; bpm=Math.round(60/m); while(bpm<60) bpm*=2; while(bpm>180) bpm=Math.round(bpm/2); }

  // quantize into 60s range and add bar/beat for CSV
  const events=[];
  const beatLen=60/Math.max(40,Math.min(220,bpm));
  const grid=beatLen*4*0.125; // 1/8 notes
  for(const n of notes){
    const q=Math.max(0,Math.min(60,Math.round(n.t/grid)*grid));
    const {bar,beat}=barsBeats(q,bpm);
    events.push({t:q,midi:n.midi,vel:0.7,dur:0.28,isBass:n.midi<=43,bar,beat});
  }

  LAST_ANALYSIS={events, meta:{bpm, key:keyName}};
  detKey.textContent=keyName;
  detBPM.textContent=String(bpm);
  statusEl.textContent="Analysis complete — ready to export.";
}

/* ================= Wire up UI ================= */
const audioFile=$("audioFile");
$("btnLoadAudio").onclick=()=>audioFile.click();
$("btnAnalyze").onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
$("btnExport").onclick=()=>{
  const src = (LAST_ANALYSIS.events && LAST_ANALYSIS.events.length)? LAST_ANALYSIS.events : A.events;
  const meta = (LAST_ANALYSIS.events && LAST_ANALYSIS.events.length)? LAST_ANALYSIS.meta : A.meta;
  if(!src.length){ alert("Analyze 60s or load an enriched CSV first."); return; }
  const csv = toEnrichedCSV(src, meta.bpm, meta.key);
  const blob=new Blob([csv],{type:"text/csv"}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
};

/* ================= Load Enriched CSV → A/B ================= */
function showFileName(el, name){ el.textContent = name || "—"; }
$("csvA").addEventListener("change", e => showFileName($("nameA"), e.target.files?.[0]?.name || "—"));
$("csvB").addEventListener("change", e => showFileName($("nameB"), e.target.files?.[0]?.name || "—"));

async function loadCSVto(side, fileInput, nameEl){
  const f=fileInput.files?.[0]; if(!f){ alert(`Choose an enriched CSV for ${side}`); return; }
  try{
    const {events, meta}=parseEnrichedCSV(await f.text());
    if(side==='A'){ A={events, meta}; } else { B={events, meta}; }
    // Update UI from file meta
    detKey.textContent = meta.key || "C major";
    detBPM.textContent = String(meta.bpm || 100);
    showFileName(nameEl, f.name);
    statusEl.textContent = `${side} loaded: ${events.length} rows (bpm=${meta.bpm||'?'}, key=${meta.key||'?'})`;
  }catch(err){
    statusEl.textContent = "Error loading CSV.";
    alert(err.message);
  }
}
$("btnLoadA").onclick=()=>loadCSVto('A', $("csvA"), $("nameA"));
$("btnLoadB").onclick=()=>loadCSVto('B', $("csvB"), $("nameB"));
</script>
</body>
</html>
