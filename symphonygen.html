<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Orchestral Stage + Audio→CSV + CSV Dual Player (60s)</title>
<style>
  :root{
    --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758; --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --tile:#0b1738; --white:#fff; --blink:#6ee7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1280px;margin:0 auto;padding:16px;display:grid;grid-template-columns:420px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"],input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
  }
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
  .stat b{color:var(--ok)}
  #status{font-size:12px;color:#9ad1ff;margin-top:8px}
  .danger{background:#3b1220;border-color:#6b1f35}

  /* ===== Stage grid (even spacing) ===== */
  .stage{position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)}
  .stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .grid{
    display:grid;
    grid-template-rows:repeat(4,1fr);
    grid-template-columns:repeat(5,1fr);
    gap:10px;
    height:520px;
  }
  /* row 1 = back (percussion); row 4 = front (1st row strings) */
  .cell{display:flex;align-items:center;justify-content:center}
  .section{
    background:linear-gradient(180deg,#0e1b43,#0a1232); border:1px solid #20326d; border-radius:12px;
    width:100%; height:100%; min-height:110px; padding:10px; display:flex; flex-direction:column; gap:6px; justify-content:space-between;
  }
  .title{font-weight:800;color:#e4eeff;font-size:13px}
  .meta{font-size:11px;color:#9bb9ff}
  .lights{display:flex;align-items:center;gap:6px}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
  .blink{animation:blink .45s ease-out}
  @keyframes blink{
    0%{background:#0c1430;border-color:#2a3b7a}
    30%{background:var(--blink);border-color:#bfefff}
    100%{background:#0c1430;border-color:#2a3b7a}
  }
  .check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;
         display:flex;align-items:center;justify-content:center;font-weight:900}
  .checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
  .mixRow{display:flex;gap:6px}
  .btnSmall{padding:6px 8px;font-size:12px;background:#122153;border:1px solid #23438e;border-radius:8px}
  .btnSmall:hover{filter:brightness(1.1)}
  .conductor{
    position:absolute; left:50%; transform:translateX(-50%); bottom:10px;
    width:92px;height:92px;border-radius:50%; background:#0d1b44;border:2px solid #284a9b;
    display:flex;align-items:center;justify-content:center; font-weight:800; color:#cfe1ff;
    box-shadow:0 0 0 0 rgba(59,130,246,.45); animation:conPulse 1.4s ease-in-out infinite;
  }
  @keyframes conPulse{
    0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}
    70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}
    100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
  }
  small.hint{display:block;color:#a8b7e3;margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>CST — Orchestral Stage + Audio→CSV (60s) + CSV Dual Player</h1>
  <span style="font-size:12px;color:#9ad1ff">Play/Stop/Reset fixed • Even stage spacing • Soft synth (no downloads)</span>
</header>

<main>
  <!-- LEFT CONTROLS -->
  <section class="card">
    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <button id="btnAnalyze">2) Analyze 60s</button>
      <button id="btnExport">3) Export CSV</button>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV columns: <b>t,m,b</b> → time(sec), dominant MIDI, bass MIDI (0 = none). Export here, then load A/B.</small>

    <div class="hr"></div>
    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes (A/B)</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <button id="btnLoadA" style="margin-top:6px">Load CSV → A</button>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <button id="btnLoadB" style="margin-top:6px">Load CSV → B</button>
      </div>
    </div>

    <div class="hr"></div>
    <!-- MUSICALIZE -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="cinematic">Cinematic — lush</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Humanize (ms)</label>
        <input id="human" type="number" min="0" max="40" step="1" value="6"/>
      </div>
      <div>
        <label>Master Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Reverb Mix</label>
        <input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/>
      </div>
      <div>
        <label>Stereo Spread</label>
        <input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>
    <div id="status">Ready.</div>
  </section>

  <!-- RIGHT: STAGE -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Semi-circle concept • Even spacing</b></div>
      <div class="stat"><span>Conductor</span><b id="condName">Mozart</b></div>
    </div>
    <div class="grid">
      <!-- Row 1 (back): Brass + Percussion -->
      <div class="cell"><div class="section" data-sec="trumpets"><div class="title">Trumpets</div><div class="meta">Back left</div><div class="lights"><div class="dot" id="dot-trumpets"></div><div class="check" id="chk-trumpets"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpets">Mute</button><button class="btnSmall" data-solo="trumpets">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="horns"><div class="title">French Horns</div><div class="meta">Back middle</div><div class="lights"><div class="dot" id="dot-horns"></div><div class="check" id="chk-horns"></div></div><div class="mixRow"><button class="btnSmall" data-mute="horns">Mute</button><button class="btnSmall" data-solo="horns">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="perc"><div class="title">Percussion</div><div class="meta">Back center</div><div class="lights"><div class="dot" id="dot-perc"></div><div class="check" id="chk-perc"></div></div><div class="mixRow"><button class="btnSmall" data-mute="perc">Mute</button><button class="btnSmall" data-solo="perc">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombones"><div class="title">Trombones/Tuba</div><div class="meta">Back right</div><div class="lights"><div class="dot" id="dot-trombones"></div><div class="check" id="chk-trombones"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombones">Mute</button><button class="btnSmall" data-solo="trombones">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 2 (winds) -->
      <div class="cell"><div class="section" data-sec="flutes"><div class="title">Flutes/Picc.</div><div class="meta">Winds row</div><div class="lights"><div class="dot" id="dot-flutes"></div><div class="check" id="chk-flutes"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutes">Mute</button><button class="btnSmall" data-solo="flutes">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="oboes"><div class="title">Oboes</div><div class="meta">Winds row</div><div class="lights"><div class="dot" id="dot-oboes"></div><div class="check" id="chk-oboes"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboes">Mute</button><button class="btnSmall" data-solo="oboes">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="clarinets"><div class="title">Clarinets</div><div class="meta">Winds row</div><div class="lights"><div class="dot" id="dot-clarinets"></div><div class="check" id="chk-clarinets"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinets">Mute</button><button class="btnSmall" data-solo="clarinets">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassoons"><div class="title">Bassoons</div><div class="meta">Winds row</div><div class="lights"><div class="dot" id="dot-bassoons"></div><div class="check" id="chk-bassoons"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoons">Mute</button><button class="btnSmall" data-solo="bassoons">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 3 (back of strings) -->
      <div class="cell"></div>
      <div class="cell"><div class="section" data-sec="basses"><div class="title">Double Basses</div><div class="meta">Back of strings</div><div class="lights"><div class="dot" id="dot-basses"></div><div class="check" id="chk-basses"></div></div><div class="mixRow"><button class="btnSmall" data-mute="basses">Mute</button><button class="btnSmall" data-solo="basses">Solo</button></div></div></div>
      <div class="cell"></div>
      <div class="cell"><div class="section" data-sec="harp"><div class="title">Harp/Keys</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harp"></div><div class="check" id="chk-harp"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harp">Mute</button><button class="btnSmall" data-solo="harp">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 4 (front strings) -->
      <div class="cell"><div class="section" data-sec="vln1"><div class="title">1st Violins</div><div class="meta">Far left (front)</div><div class="lights"><div class="dot" id="dot-vln1"></div><div class="check" id="chk-vln1"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1">Mute</button><button class="btnSmall" data-solo="vln1">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln2"><div class="title">2nd Violins</div><div class="meta">Left-center</div><div class="lights"><div class="dot" id="dot-vln2"></div><div class="check" id="chk-vln2"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2">Mute</button><button class="btnSmall" data-solo="vln2">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="violas"><div class="title">Violas</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violas"></div><div class="check" id="chk-violas"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violas">Mute</button><button class="btnSmall" data-solo="violas">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="cellos"><div class="title">Cellos</div><div class="meta">Right-center</div><div class="lights"><div class="dot" id="dot-cellos"></div><div class="check" id="chk-cellos"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellos">Mute</button><button class="btnSmall" data-solo="cellos">Solo</button></div></div></div>
      <div class="cell"></div>
    </div>
    <div class="conductor" id="conductor">Conductor</div>
  </section>
</main>

<script>
/* ===== Names, scales, helpers ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const median=a=>{const s=[...a].sort((x,y)=>x-y),n=s.length;return n?(n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):0;}
function pcsFor(root,mode){const r=NOTE.indexOf(root);return (mode==='minor'?MINOR:MAJOR).map(pc=>(pc+r+120)%12);}
function snapToScale(m,pcs){ if(!m) return 0; const pc=((m%12)+12)%12; if(pcs.includes(pc)) return m; for(const d of [1,-1,2,-2]){const c=((pc+d)+12)%12;if(pcs.includes(c)) return m+d;} return m;}
const $=id=>document.getElementById(id);

/* ===== UI refs ===== */
const btnLoadAudio=$('btnLoadAudio'), btnAnalyze=$('btnAnalyze'), btnExport=$('btnExport'), audioFile=$('audioFile'), detKey=$('detKey'), detBPM=$('detBPM');
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const statusEl=$('status'), condNameEl=$('condName'), conductor=$('conductor');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn');

/* ===== Stage state ===== */
const SECTIONS=['vln1','vln2','violas','cellos','basses','harp','flutes','oboes','clarinets','bassoons','trumpets','horns','trombones','perc'];
const DOT={}, CHK={}, MUTE={}, SOLO={on:false,id:null};
SECTIONS.forEach(id=>{ DOT[id]=document.getElementById('dot-'+id); CHK[id]=document.getElementById('chk-'+id); MUTE[id]=false; });
document.querySelectorAll('[data-mute]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-mute'); MUTE[s]=!MUTE[s]; b.textContent=MUTE[s]?'Unmute':'Mute';});
document.querySelectorAll('[data-solo]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-solo'); if(SOLO.on&&SOLO.id===s){SOLO.on=false;SOLO.id=null;b.textContent='Solo';}else{SOLO.on=true;SOLO.id=s;document.querySelectorAll('[data-solo]').forEach(x=>x.textContent='Solo');b.textContent='Unsolo';}});

/* ===== Conductor presets ===== */
const PRESETS={
  mozart:{swing:0.06,human:5, quant:0.125, reverb:0.12, spread:0.45},
  beethoven:{swing:0.08,human:7, quant:0.125, reverb:0.16, spread:0.55},
  debussy:{swing:0.18,human:10,quant:0.0625,reverb:0.22, spread:0.65},
  stravinsky:{swing:0.04,human:8, quant:0.0625,reverb:0.14, spread:0.55},
  cinematic:{swing:0.12,human:9, quant:0.0625,reverb:0.26, spread:0.75},
};
function applyConductor(){
  const p=PRESETS[composerEl.value];
  swingEl.value=String(p.swing); humanEl.value=String(p.human); quantEl.value=String(p.quant);
  reverbMixEl.value=String(p.reverb); spreadEl.value=String(p.spread);
  condNameEl.textContent = composerEl.options[composerEl.selectedIndex].text.split(' — ')[0];
}
composerEl.onchange=applyConductor;

/* ===== Playback chain ===== */
let A={events:[]}, B={events:[]}, LAST_ANALYSIS={events:[],key:"C major",bpm:100};
let AUDIO={ctx:null, master:null, comp:null, dry:null, wet:null, convolver:null, bus:{}};
let sch=[], idx=0, timer=null, t0=0;
const LOOKAHEAD=0.25, TICK=25;

function makeHallIR(ctx){
  const len=ctx.sampleRate*2.2, ir=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0; ch<2; ch++){ const d=ir.getChannelData(ch); let x=0; for(let i=0;i<len;i++){ const n=(Math.random()*2-1)*0.5; const t=i/ctx.sampleRate; const dec=Math.exp(-t*1.5); x=0.32*n+0.68*x; d[i]=x*dec; } }
  return ir;
}
function getAudio(){
  if(!AUDIO.ctx){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const comp=ctx.createDynamicsCompressor(); comp.threshold.value=-18; comp.ratio.value=3; comp.attack.value=0.004; comp.release.value=0.2;
    const dry=ctx.createGain(), wet=ctx.createGain(); dry.gain.value=1; wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
    const conv=ctx.createConvolver(); conv.buffer=makeHallIR(ctx);
    const master=ctx.createGain(); master.gain.value=parseFloat(masterVolEl.value||"0.85");
    dry.connect(comp); conv.connect(wet); wet.connect(comp); comp.connect(master); master.connect(ctx.destination);
    AUDIO={ctx,master,comp,dry,wet,convolver:conv,bus:{}};
    // per-section buses with simple pan law
    buildBuses();
  }
  AUDIO.master.gain.value=parseFloat(masterVolEl.value||"0.85");
  AUDIO.wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
  return AUDIO.ctx;
}
function buildBuses(){
  const ctx=AUDIO.ctx, spread=parseFloat(spreadEl.value||"0.55");
  AUDIO.bus={};
  // simple pan map (-0.7 .. +0.7)
  const panTable={
    vln1:-0.7, vln2:-0.45, violas:-0.05, cellos:0.4, basses:0.65, harp:0.75,
    flutes:-0.1, oboes:0.1, clarinets:-0.2, bassoons:0.2,
    trumpets:-0.55, horns:0.0, trombones:0.55, perc:0.0
  };
  for(const id of SECTIONS){
    const g=ctx.createGain(); g.gain.value=1;
    const l=ctx.createGain(), r=ctx.createGain(), m=ctx.createChannelMerger(2);
    g.connect(l); g.connect(r); l.connect(m,0,0); r.connect(m,0,1);
    const pan=clamp((panTable[id]||0)*spread,-0.95,0.95);
    const L=clamp(0.5 - pan/2,0,1), R=clamp(0.5 + pan/2,0,1);
    l.gain.value=L; r.gain.value=R;
    m.connect(AUDIO.dry); m.connect(AUDIO.convolver);
    AUDIO.bus[id]=g;
  }
}
async function resumeAudio(){ const ctx=getAudio(); if(ctx.state==='suspended'){ try{ await ctx.resume(); }catch(_){ } } return ctx; }

function sectionPreset(sec){
  if(sec==='basses')   return {wave:'sine',      lp:520,  q:0.8, a:0.008, d:0.10, s:0.8, r:0.16};
  if(sec==='cellos')   return {wave:'triangle',  lp:1100, q:0.7, a:0.010, d:0.18, s:0.78,r:0.22};
  if(sec==='violas')   return {wave:'triangle',  lp:1600, q:0.7, a:0.010, d:0.18, s:0.74,r:0.20};
  if(sec==='vln1' || sec==='vln2') return {wave:'sine', lp:2600, q:0.6, a:0.008, d:0.14, s:0.7, r:0.18};
  if(sec==='harp')     return {wave:'sine',      lp:2800, q:0.6, a:0.004, d:0.10, s:0.0, r:0.35};
  if(sec==='flutes')   return {wave:'sine',      lp:3000, q:0.5, a:0.006, d:0.10, s:0.55,r:0.18};
  if(sec==='oboes')    return {wave:'triangle',  lp:2200, q:0.7, a:0.009, d:0.16, s:0.6, r:0.2};
  if(sec==='clarinets')return {wave:'triangle',  lp:2000, q:0.7, a:0.010, d:0.16, s:0.6, r:0.2};
  if(sec==='bassoons') return {wave:'sine',      lp:1200, q:0.8, a:0.010, d:0.18, s:0.7, r:0.22};
  if(sec==='trumpets') return {wave:'triangle',  lp:2400, q:0.9, a:0.004, d:0.12, s:0.65,r:0.22};
  if(sec==='horns')    return {wave:'sine',      lp:1800, q:0.9, a:0.008, d:0.14, s:0.7, r:0.24};
  if(sec==='trombones')return {wave:'sine',      lp:1400, q:0.9, a:0.006, d:0.16, s:0.75,r:0.26};
  if(sec==='perc')     return {wave:'noise',     lp:6000, q:0.5, a:0.001, d:0.06, s:0.0, r:0.12};
  return {wave:'sine',lp:2000,q:0.6,a:0.008,d:0.16,s:0.68,r:0.2};
}
function playSection(sec, midi, when, dur, gain){
  if(MUTE[sec] || (SOLO.on && SOLO.id!==sec)) return;
  const ctx=getAudio(), p=sectionPreset(sec);
  let src;
  if(p.wave==='noise'){
    const len=Math.max(1,Math.floor((dur+p.r)*ctx.sampleRate));
    const buf=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.06)); }
    src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
  }else{
    src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(midiHz(midi),when);
    src.start(when); src.stop(when+dur+p.r+0.05);
  }
  const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
  const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
  amp.gain.linearRampToValueAtTime(gain,when+p.a);
  amp.gain.linearRampToValueAtTime(gain*p.s,when+p.a+p.d);
  amp.gain.setValueAtTime(gain*p.s,when+dur);
  amp.gain.linearRampToValueAtTime(0.0003,when+dur+p.r);
  src.connect(biq); biq.connect(amp); amp.connect(AUDIO.bus[sec]);

  // visuals
  const dot=DOT[sec], chk=CHK[sec];
  if(dot){ dot.classList.remove('blink'); void dot.offsetWidth; dot.classList.add('blink'); }
  if(chk && !chk.classList.contains('checked')){ chk.classList.add('checked'); chk.textContent='✓'; }
}

/* ===== Mapping & schedule ===== */
function sectionFor(midi,isBass,side){
  if(isBass || midi<=43) return 'basses';
  if(midi<=55) return 'cellos';
  if(midi<=64) return 'violas';
  if(midi<=76) return side==='A'?'vln2':'violas';
  if(midi<=84) return 'vln1';
  return 'flutes'; // sparkle high
}
function musicalize(events, side){
  if(!events?.length) return [];
  const BPM=parseFloat(bpmEl.value||"100"), beat=60/clamp(BPM,40,200);
  const qDiv=parseFloat(quantEl.value||"0.125"), grid=beat*4*qDiv;
  const swing=parseFloat(swingEl.value||"0"), human=parseFloat(humanEl.value||"0")/1000;
  const pcs=pcsFor(keyRootEl.value, keyModeEl.value);
  const lastBy=new Map(); const cap=10; let lastSec=-1, perSec=0;
  const out=[];
  for(const e of events){
    let q=Math.round(e.t/grid)*grid; if(grid<=beat/2+1e-6){ const pos=Math.round(q/grid); if(pos%2===1) q+=swing*grid*0.5; }
    q=clamp(q,0,60); const sec=Math.floor(q); if(sec!==lastSec){perSec=0; lastSec=sec;}
    const m=e.m? snapToScale(e.m,pcs):0; const b=e.b? snapToScale(e.b,pcs):0;
    const push=(midi,isBass)=>{
      if(!midi) return; const last=lastBy.get(midi)||-999; if(q-last<0.08) return; if(perSec>=cap) return;
      lastBy.set(midi,q); perSec++;
      const jitter=(Math.random()*2-1)*human, dur=isBass?0.45:0.28, base=isBass?0.9:0.76;
      const vel=clamp(base*(0.9+0.2*((midi/127)-0.5)),0.25,1.0);
      out.push({t:clamp(q+jitter,0,60), midi:Math.round(midi), dur, vel, isBass, side});
    }; push(m,false); push(b,true);
  }
  return out.sort((a,b)=>a.t-b.t);
}
function buildSchedule(){
  const a=musicalize(A.events,'A'), b=musicalize(B.events,'B');
  const all=[...a,...b].sort((x,y)=>x.t-y.t);
  return all.map(e=>({...e, sec:sectionFor(e.midi,e.isBass,e.side)}));
}

/* ===== Transport ===== */
async function doPlay(){
  await resumeAudio();
  // Many browsers require a click to start audio; play/stop are both clicks so OK.
  clearInterval(timer); idx=0;
  if(!A.events.length && !B.events.length){ alert("Load a CSV into A and/or B, or analyze audio and export CSV."); return; }
  sch=buildSchedule(); if(!sch.length){ alert("No notes in 0–60s."); return; }
  t0=AUDIO.ctx.currentTime+0.06;
  timer=setInterval(tick,TICK);
  conductor.style.animationPlayState='running';
  setStatus("Playing…");
}
function tick(){
  const now=AUDIO.ctx.currentTime, horizon=now+LOOKAHEAD;
  while(idx<sch.length){
    const e=sch[idx]; const when=t0+e.t; if(when>horizon) break;
    playSection(e.sec, e.midi, when, e.dur, e.vel);
    idx++;
  }
  if(idx>=sch.length){ clearInterval(timer); timer=null; setStatus("Finished."); conductor.style.animationPlayState='paused'; }
}
function stopAll(){ if(timer){clearInterval(timer); timer=null;} idx=sch?.length||0; setStatus("Stopped."); conductor.style.animationPlayState='paused'; }

/* ===== Audio→CSV analysis ===== */
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; } return best.name; }
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0;}
function acPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++)mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const minF=60,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag;lag<=Math.min(maxLag,N-2);lag++){let s=0;for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if(s>best){best=s;bestLag=lag;}}
  return bestLag? sr/bestLag : 0;
}
function toCSV(events){ const rows=["t,m,b"]; for(const e of events){ rows.push(`${e.t.toFixed(3)},${e.m|0},${e.b|0}`);} return rows.join("\n"); }
function downloadCSV(name,text){ const blob=new Blob([text],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0); }

async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  setStatus("Decoding…");
  const arr=await file.arrayBuffer();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await ctx.decodeAudioData(arr.slice(0));
  const sr=buf.sampleRate, ch=buf.numberOfChannels, mono=new Float32Array(buf.length);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<d.length;i++) mono[i]=(mono[i]||0)+d[i]/ch; }
  const frame=4096, hop=2048, maxS=Math.min(mono.length, sr*60);
  const events=[], pc=new Float32Array(12), on=[]; let prevE=0;
  setStatus("Analyzing 60s…");
  for(let st=0; st+frame<=maxS; st+=hop){
    const fr=mono.subarray(st,st+frame);
    let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if(dE>0.08) on.push(st);
    let f=acPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
    let m=0,b=0; if(f){ m=clamp(Math.round(69+12*Math.log2(f/440)),24,96); if(f<=220) b=clamp(Math.round(69+12*Math.log2(f/440)),28,72); pc[(m%12+12)%12]++; }
    events.push({t:st/sr, m, b});
  }
  // median smoothing
  const smooth=(list,key)=>{const half=2,a=list.map(e=>e[key]||0),sm=[]; for(let i=0;i<a.length;i++){const w=[]; for(let k=Math.max(0,i-half);k<=Math.min(a.length-1,i+half);k++) if(a[k]) w.push(a[k]); sm[i]=w.length?Math.round(median(w)):0;} for(let i=0;i<list.length;i++) list[i][key]=sm[i];};
  smooth(events,'m'); smooth(events,'b');
  const keyName=correlate(Array.from(pc)); const pcs=pcsFor(keyName.split(' ')[0], keyName.toLowerCase().includes('minor')?'minor':'major');
  for(const e of events){ if(e.m) e.m=snapToScale(e.m,pcs); if(e.b) e.b=snapToScale(e.b,pcs); }
  const bpm=(()=>{ if(on.length<3) return 100; const dif=[]; for(let i=1;i<on.length;i++){const dt=(on[i]-on[i-1])/sr; if(dt>0.18&&dt<2.2) dif.push(dt);} if(!dif.length) return 100; const m=dif.sort((a,b)=>a-b)[Math.floor(dif.length/2)]; let b=Math.round(60/m); while(b<60) b*=2; while(b>180) b=Math.round(b/2); return b; })();
  LAST_ANALYSIS={events,key:keyName,bpm}; detKey.textContent=keyName; detBPM.textContent=String(bpm);
  // sync controls
  bpmEl.value=String(bpm); const [r,mo]=(keyName||'C major').split(' '); keyRootEl.value=r; keyModeEl.value=(mo||'major').toLowerCase();
  setStatus("Analysis complete → Export CSV.");
}

/* ===== Wire up ===== */
btnLoadAudio.onclick=()=>audioFile.click();
btnAnalyze.onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
btnExport.onclick=()=>{ if(!LAST_ANALYSIS.events.length){ alert("Analyze audio first."); return; } downloadCSV("notes_60s.csv", toCSV(LAST_ANALYSIS.events)); };

btnLoadA.onclick=async()=>{ const f=csvA.files?.[0]; if(!f){alert("Select CSV for A");return;} try{A.events=(await f.text()).trim().split(/\r?\n/).slice(1).map(l=>{const [t,m,b]=l.split(',');return {t:+t,m:+m,b:+b};}).filter(e=>e.t>=0&&e.t<=60);}catch(e){alert("CSV parse error");return;} setStatus(`A loaded: ${A.events.length} rows`); };
btnLoadB.onclick=async()=>{ const f=csvB.files?.[0]; if(!f){alert("Select CSV for B");return;} try{B.events=(await f.text()).trim().split(/\r?\n/).slice(1).map(l=>{const [t,m,b]=l.split(',');return {t:+t,m:+m,b:+b};}).filter(e=>e.t>=0&&e.t<=60);}catch(e){alert("CSV parse error");return;} setStatus(`B loaded: ${B.events.length} rows`); };

playBtn.onclick=doPlay;
stopBtn.onclick=stopAll;
resetBtn.onclick=()=>{
  stopAll();
  A={events:[]}; B={events:[]}; LAST_ANALYSIS={events:[],key:"C major",bpm:100};
  detKey.textContent='–'; detBPM.textContent='–';
  Object.values(CHK).forEach(x=>{x.classList.remove('checked'); x.textContent='';});
  Object.values(DOT).forEach(x=>x.classList.remove('blink'));
  setStatus("Ready.");
};

masterVolEl.oninput=()=>{ getAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); };
reverbMixEl.oninput=()=>{ getAudio(); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); };
spreadEl.oninput=()=>{ if(AUDIO.ctx){ try{AUDIO.ctx.close();}catch(_){ } AUDIO.ctx=null; } getAudio(); };

function setStatus(s){ statusEl.textContent=s; }

/* ===== Init ===== */
(function init(){
  NOTE.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; if(n==='C') o.selected=true; keyRootEl.appendChild(o); });
  applyConductor();
  conductor.style.animationPlayState='paused';
  setStatus('Ready.');
})();
</script>
</body>
</html>
