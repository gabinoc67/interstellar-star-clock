<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audio → CSV (60s) — Analyzer + Enriched CSV Panels A & B</title>
<style>
  :root{--bg:#0b1222;--panel:#111a34;--ink:#eaf0ff;--muted:#a7b7e6;--border:#213067;--btn:#162455;--btnH:#1d2e6e}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h1{font-size:18px;margin:0 0 12px}
  h2{font-size:16px;margin:0 0 10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  button,input[type="file"]{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--ink);cursor:pointer}
  button:hover{background:var(--btnH)}
  input[type="text"],input[type="number"],select{padding:8px;border-radius:8px;border:1px solid var(--border);background:#0d1a3a;color:var(--ink)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .rowAuto{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--border);border-radius:10px}
  small.hint{display:block;color:var(--muted);margin-top:6px}
  .fileRow{display:flex;gap:8px;align-items:center}
  .fname{font-size:12px;color:#bcd3ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .lights{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px}
  .lightItem{display:flex;align-items:center;gap:6px;font-size:12px;color:#cfe1ff}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #ddd;background:#0f1b3d}
  .dot.on{background:#ffffff;border-color:#ffffff}
  .panelHeader{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .metaBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .metaBox label{margin:0;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:12px;text-align:left}
  th{color:#cfe1ff;background:#0e1a3f;position:sticky;top:0}
  tbody tr:hover{background:#0c1740}
  .tight{width:86px}
  .xs{width:56px}
  .cbx{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Audio → CSV Notes (60s)</h1>

    <!-- TOP: Analyzer + Loaders + Lights -->
    <section class="card">
      <label><strong>Audio → CSV Notes (60s)</strong></label>

      <div class="row3" style="margin-top:6px">
        <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
        <button id="btnAnalyze">2) Analyze 60s</button>
        <button id="btnExport">3) Export CSV (enriched)</button>
      </div>

      <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" hidden />

      <!-- Analyzer / Export lights -->
      <div class="lights">
        <div class="lightItem"><div id="dotAnalyze" class="dot" aria-label="Analyze done"></div>Analyze done</div>
        <div class="lightItem"><div id="dotExport"  class="dot" aria-label="Export ready"></div>Export ready</div>
      </div>

      <div class="row2" style="margin-top:8px">
        <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
        <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
      </div>
      <small class="hint">Enriched CSV headers required: <b>t,midi,vel,dur,is_bass,bar,beat,bpm,key</b>.</small>

      <div class="hr"></div>

      <label><strong>Load Enriched CSV Notes → A / B</strong></label>

      <!-- A -->
      <div class="rowAuto">
        <div style="min-width:220px"><input id="csvA" type="file" accept=".csv"/></div>
        <div class="fname" id="nameA">—</div>
        <div class="lightItem"><div id="dotA" class="dot" aria-label="A loaded"></div>A loaded</div>
      </div>
      <div style="margin-top:6px">
        <button id="btnLoadA" style="min-width:180px">Load CSV → A</button>
      </div>

      <!-- B -->
      <div class="rowAuto" style="margin-top:10px">
        <div style="min-width:220px"><input id="csvB" type="file" accept=".csv"/></div>
        <div class="fname" id="nameB">—</div>
        <div class="lightItem"><div id="dotB" class="dot" aria-label="B loaded"></div>B loaded</div>
      </div>
      <div style="margin-top:6px">
        <button id="btnLoadB" style="min-width:180px">Load CSV → B</button>
      </div>

      <div class="hr"></div>

      <div class="row2">
        <div class="stat" id="status"><span>Status</span><b>Ready.</b></div>
        <button id="btnReset">Reset (clear files, lights, labels)</button>
      </div>
      <small class="hint">Reset clears page state and lights. It can’t remove a file already downloaded to your computer.</small>
    </section>
    <!-- PANEL A (editable) -->
    <section class="card" style="margin-top:14px">
      <div class="panelHeader">
        <h2>Panel A — Enriched CSV (edit)</h2>
        <div class="metaBox">
          <label>BPM <input id="metaBpmA" class="xs" type="number" min="40" max="220" step="1" value="100"/></label>
          <label>Key <input id="metaKeyA" class="tight" type="text" value="C major" /></label>
          <span style="color:#a7b7e6;font-size:12px">Rows: <b id="rowCountA">0</b></span>
        </div>
      </div>
      <div class="toolbar" style="margin:8px 0">
        <button id="btnAddRowA">Add Row</button>
        <button id="btnDeleteRowsA">Delete Selected</button>
        <button id="btnSortTA">Sort by t</button>
        <button id="btnClampTA">Clamp t to 0–60</button>
        <button id="btnApplyA">Apply Changes</button>
        <button id="btnExportA">Export CSV (A)</button>
      </div>
      <div style="overflow:auto; max-height:380px; border:1px solid var(--border); border-radius:10px">
        <table id="tableA">
          <thead>
            <tr>
              <th class="cbx"><input type="checkbox" id="chkAllA"/></th>
              <th class="xs">t</th>
              <th class="xs">midi</th>
              <th class="xs">vel</th>
              <th class="xs">dur</th>
              <th class="xs">is_bass</th>
              <th class="xs">bar</th>
              <th class="xs">beat</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PANEL B (editable) -->
    <section class="card" style="margin-top:14px">
      <div class="panelHeader">
        <h2>Panel B — Enriched CSV (edit)</h2>
        <div class="metaBox">
          <label>BPM <input id="metaBpmB" class="xs" type="number" min="40" max="220" step="1" value="100"/></label>
          <label>Key <input id="metaKeyB" class="tight" type="text" value="C major" /></label>
          <span style="color:#a7b7e6;font-size:12px">Rows: <b id="rowCountB">0</b></span>
        </div>
      </div>
      <div class="toolbar" style="margin:8px 0">
        <button id="btnAddRowB">Add Row</button>
        <button id="btnDeleteRowsB">Delete Selected</button>
        <button id="btnSortTB">Sort by t</button>
        <button id="btnClampTB">Clamp t to 0–60</button>
        <button id="btnApplyB">Apply Changes</button>
        <button id="btnExportB">Export CSV (B)</button>
      </div>
      <div style="overflow:auto; max-height:380px; border:1px solid var(--border); border-radius:10px">
        <table id="tableB">
          <thead>
            <tr>
              <th class="cbx"><input type="checkbox" id="chkAllB"/></th>
              <th class="xs">t</th>
              <th class="xs">midi</th>
              <th class="xs">vel</th>
              <th class="xs">dur</th>
              <th class="xs">is_bass</th>
              <th class="xs">bar</th>
              <th class="xs">beat</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
<script>
/* ================= Core state ================= */
let LAST_ANALYSIS = { events: [], meta: { bpm: 100, key: "C major" } };
let A = { events: [], meta: { bpm: 100, key: "C major" } };
let B = { events: [], meta: { bpm: 100, key: "C major" } };

/* ================= DOM helpers ================= */
const $ = id => document.getElementById(id);
const detKey = $("detKey"), detBPM = $("detBPM");
const statusVal = $("status").lastElementChild;

/* Lights */
const dotAnalyze = $("dotAnalyze");
const dotExport  = $("dotExport");
const dotA       = $("dotA");
const dotB       = $("dotB");
function light(el,on){ if(!el) return; el.classList.toggle("on", !!on); }
function updateExportLight(){
  const ready = (LAST_ANALYSIS.events && LAST_ANALYSIS.events.length) ||
                (A.events && A.events.length) ||
                (B.events && B.events.length);
  light(dotExport, !!ready);
}

/* ================= CSV helpers ================= */
function csvEscape(v){ const s=String(v); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
function toEnrichedCSV(events, bpm, key){
  const header = "t,midi,vel,dur,is_bass,bar,beat,bpm,key";
  const rows = events.map(e => [
    (e.t ?? 0).toFixed(3),
    e.midi|0,
    Math.round((e.vel ?? 0.7)*127),
    (e.dur ?? (e.isBass?0.450:0.280)).toFixed(3),
    e.isBass?1:0,
    e.bar|0,
    (e.beat ?? 1).toFixed(3),
    bpm|0,
    key
  ].map(csvEscape).join(","));
  return [header, ...rows].join("\n");
}
function parseEnrichedCSV(text){
  const lines=text.replace(/\r/g,'').trim().split('\n');
  if(!lines.length) throw new Error("Empty CSV.");
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const required=['t','midi','vel','dur','is_bass','bar','beat','bpm','key'];
  for(const k of required){ if(hdr.indexOf(k)<0) throw new Error("CSV must include: "+required.join(',')); }
  const idxs=Object.fromEntries(hdr.map((h,i)=>[h,i]));
  const out=[], meta={bpm:100,key:"C major"};
  for(let i=1;i<lines.length;i++){
    const r=lines[i].split(',');
    if(r.length<hdr.length) continue;
    const t=parseFloat(r[idxs.t]);
    const midi=parseInt(r[idxs.midi],10);
    const vel=(parseFloat(r[idxs.vel])||90)/127;
    const dur=parseFloat(r[idxs.dur]);
    const isb=+r[idxs.is_bass]===1;
    const bar=parseInt(r[idxs.bar],10);
    const beat=parseFloat(r[idxs.beat]);
    const bpm=parseInt(r[idxs.bpm],10);
    const key=(r[idxs.key]||'C major').trim();
    if(i===1){ if(Number.isFinite(bpm)) meta.bpm=bpm; meta.key=key; }
    if(Number.isFinite(t)&&Number.isFinite(midi)){
      out.push({t, midi, vel, dur, isBass:isb, bar:bar||1, beat:beat||1});
    }
  }
  out.sort((a,b)=>a.t-b.t);
  return {events:out, meta};
}

/* ================= Music/key detection ================= */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; } return best.name; }
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0;}
function acPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++)mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const minF=60,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag;lag<=Math.min(maxLag,N-2);lag++){let s=0;for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if(s>best){best=s;bestLag=lag;}}
  return bestLag? sr/bestLag : 0;
}

/* ================= Bars/beats for export ================= */
function barsBeats(t, bpm){
  const spb=60/Math.max(40,Math.min(220,bpm));
  const beat=t/spb, bar=Math.floor(beat/4)+1, beatInBar=(beat%4)+1;
  return {bar, beat:beatInBar};
}

/* ================= Analyzer (60s) ================= */
async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  statusVal.textContent="Decoding…";
  light(dotAnalyze,false);

  const arr=await file.arrayBuffer();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await ctx.decodeAudioData(arr.slice(0));
  const sr=buf.sampleRate, ch=buf.numberOfChannels, N=Math.min(buf.length, sr*60|0);

  const mono=new Float32Array(N);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<N;i++) mono[i]+=d[i]/ch; }

  const frame=4096, hop=2048;
  const pc=new Float32Array(12); const on=[]; const notes=[];
  let prevE=0;
  for(let st=0; st+frame<=N; st+=hop){
    const fr=mono.subarray(st,st+frame);
    let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if(dE>0.08) on.push(st);

    let f=acPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
    if(f){ const midi=Math.round(69+12*Math.log2(f/440)); pc[(midi%12+12)%12]++; notes.push({t:st/sr,midi}); }
  }

  const keyName=correlate(Array.from(pc));

  const dif=[]; for(let i=1;i<on.length;i++){ const dt=(on[i]-on[i-1])/sr; if(dt>0.18&&dt<2.2) dif.push(dt); }
  let bpm=100; if(dif.length){ const s=[...dif].sort((a,b)=>a-b), m=s[Math.floor(s.length/2)]; bpm=Math.round(60/m); while(bpm<60) bpm*=2; while(bpm>180) bpm=Math.round(bpm/2); }

  const events=[];
  const beatLen=60/Math.max(40,Math.min(220,bpm));
  const grid=beatLen*4*0.125;
  for(const n of notes){
    const q=Math.max(0,Math.min(60,Math.round(n.t/grid)*grid));
    const {bar,beat}=barsBeats(q,bpm);
    events.push({t:q,midi:n.midi,vel:0.7,dur:0.28,isBass:n.midi<=43,bar,beat});
  }

  LAST_ANALYSIS={events, meta:{bpm, key:keyName}};
  detKey.textContent=keyName;
  detBPM.textContent=String(bpm);
  statusVal.textContent="Analysis complete — ready to export.";
  light(dotAnalyze,true);
  updateExportLight();
}

/* ================= Wire up TOP UI ================= */
const audioFile=$("audioFile");
$("btnLoadAudio").onclick=()=>audioFile.click();
$("btnAnalyze").onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
$("btnExport").onclick=()=>{
  let src=null, meta=null;
  if(LAST_ANALYSIS.events.length){ src=LAST_ANALYSIS.events; meta=LAST_ANALYSIS.meta; }
  else if(A.events.length){ src=A.events; meta=A.meta; }
  else if(B.events.length){ src=B.events; meta=B.meta; }
  if(!src){ alert("Analyze 60s or load an enriched CSV first."); return; }

  const csv = toEnrichedCSV(src, meta.bpm, meta.key);
  const blob=new Blob([csv],{type:"text/csv"}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  updateExportLight();
};

/* ================= Load Enriched CSV → A/B ================= */
function showFileName(el, name){ el.textContent = name || "—"; }
$("csvA").addEventListener("change", e => showFileName($("nameA"), e.target.files?.[0]?.name || "—"));
$("csvB").addEventListener("change", e => showFileName($("nameB"), e.target.files?.[0]?.name || "—"));

async function loadCSVto(side, fileInput, nameEl, lightEl){
  const f=fileInput.files?.[0]; if(!f){ alert(`Choose an enriched CSV for ${side}`); return; }
  try{
    const {events, meta}=parseEnrichedCSV(await f.text());
    if(side==='A'){ A={events, meta}; renderPanel('A'); }
    else { B={events, meta}; renderPanel('B'); }
    detKey.textContent = meta.key || "C major";
    detBPM.textContent = String(meta.bpm || 100);
    showFileName(nameEl, f.name);
    statusVal.textContent = `${side} loaded: ${events.length} rows (bpm=${meta.bpm||'?'}, key=${meta.key||'?'})`;
    light(lightEl, true);
    updateExportLight();
  }catch(err){
    statusVal.textContent = "Error loading CSV.";
    light(lightEl, false);
    alert(err.message);
  }
}
$("btnLoadA").onclick=()=>loadCSVto('A', $("csvA"), $("nameA"), dotA);
$("btnLoadB").onclick=()=>loadCSVto('B', $("csvB"), $("nameB"), dotB);

/* ================= Editable Panels (A & B) ================= */
function rowHTML(side, e, idx){
  const chkId = `select-${side}-${idx}`;
  return `
    <tr data-i="${idx}">
      <td class="cbx"><input type="checkbox" id="${chkId}"/></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.t??0).toFixed(3)}"></td>
      <td><input class="xs" type="number" step="1" value="${e.midi|0}"></td>
      <td><input class="xs" type="number" step="1" value="${Math.round((e.vel??0.7)*127)}"></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.dur??(e.isBass?0.450:0.280)).toFixed(3)}"></td>
      <td class="cbx"><input type="checkbox" ${e.isBass?'checked':''}></td>
      <td><input class="xs" type="number" step="1" value="${e.bar|0}"></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.beat??1).toFixed(3)}"></td>
    </tr>
  `;
}
function renderPanel(side){
  const model = (side==='A')? A : B;
  (side==='A'? $("metaBpmA"): $("metaBpmB")).value = String(model.meta.bpm||100);
  (side==='A'? $("metaKeyA"): $("metaKeyB")).value = String(model.meta.key||"C major");
  (side==='A'? $("rowCountA"): $("rowCountB")).textContent = String(model.events.length);

  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  tbody.innerHTML = model.events.map((e,i)=>rowHTML(side,e,i)).join('');
}
function readPanel(side){
  const model = (side==='A')? A : B;
  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  const rows=[...tbody.querySelectorAll('tr')];
  const out=[];
  rows.forEach(tr=>{
    const inputs=[...tr.querySelectorAll('input')];
    const t   = parseFloat(inputs[1].value);
    const midi= parseInt(inputs[2].value,10);
    const vel = Math.max(0,Math.min(127, parseInt(inputs[3].value,10) || 0))/127;
    const dur = parseFloat(inputs[4].value);
    const isb = inputs[5].checked;
    const bar = parseInt(inputs[6].value,10) || 1;
    const beat= parseFloat(inputs[7].value) || 1;
    if(Number.isFinite(t) && Number.isFinite(midi)) out.push({t,midi,vel,dur,isBass:isb,bar,beat});
  });
  const bpm = parseInt((side==='A'? $("metaBpmA"): $("metaBpmB")).value,10) || 100;
  const key = (side==='A'? $("metaKeyA"): $("metaKeyB")).value || "C major";
  model.events = out.sort((a,b)=>a.t-b.t);
  model.meta = {bpm,key};
  (side==='A'? $("rowCountA"): $("rowCountB")).textContent = String(model.events.length);
  updateExportLight();
}
function addRow(side){
  const model = (side==='A')? A : B;
  model.events.push({t:0,midi:60,vel:0.7,dur:0.28,isBass:false,bar:1,beat:1});
  renderPanel(side);
}
function deleteSelected(side){
  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  const rows=[...tbody.querySelectorAll('tr')];
  const keep=[];
  rows.forEach((tr,i)=>{
    const checked = tr.querySelector('td input[type="checkbox"]').checked;
    if(!checked){
      const inputs=[...tr.querySelectorAll('input')];
      const t   = parseFloat(inputs[1].value);
      const midi= parseInt(inputs[2].value,10);
      const vel = Math.max(0,Math.min(127, parseInt(inputs[3].value,10) || 0))/127;
      const dur = parseFloat(inputs[4].value);
      const isb = inputs[5].checked;
      const bar = parseInt(inputs[6].value,10) || 1;
      const beat= parseFloat(inputs[7].value) || 1;
      if(Number.isFinite(t) && Number.isFinite(midi)) keep.push({t,midi,vel,dur,isBass:isb,bar,beat});
    }
  });
  if(side==='A'){ A.events=keep.sort((a,b)=>a.t-b.t);}
  else{ B.events=keep.sort((a,b)=>a.t-b.t);}
  renderPanel(side);
}
function sortByTime(side){
  const model = (side==='A')? A : B;
  readPanel(side);
  model.events.sort((a,b)=>a.t-b.t);
  renderPanel(side);
}
function clampTime(side){
  readPanel(side);
  const model = (side==='A')? A : B;
  model.events.forEach(e=>{ e.t = Math.max(0, Math.min(60, e.t)); });
  renderPanel(side);
}

/* Wire panel A */
$("btnAddRowA").onclick = ()=>addRow('A');
$("btnDeleteRowsA").onclick = ()=>deleteSelected('A');
$("btnSortTA").onclick = ()=>sortByTime('A');
$("btnClampTA").onclick = ()=>clampTime('A');
$("btnApplyA").onclick = ()=>{ readPanel('A'); statusVal.textContent="Applied changes to Panel A."; };
$("btnExportA").onclick = ()=>{
  readPanel('A');
  const csv = toEnrichedCSV(A.events, A.meta.bpm, A.meta.key);
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a=document.createElement('a'); a.href=url; a.download='panel_A_notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  updateExportLight();
};
$("chkAllA").onclick = (e)=>{
  $("tableA").querySelectorAll('tbody tr td input[type="checkbox"]').forEach(c=>c.checked=e.target.checked);
};

/* Wire panel B */
$("btnAddRowB").onclick = ()=>addRow('B');
$("btnDeleteRowsB").onclick = ()=>deleteSelected('B');
$("btnSortTB").onclick = ()=>sortByTime('B');
$("btnClampTB").onclick = ()=>clampTime('B');
$("btnApplyB").onclick = ()=>{ readPanel('B'); statusVal.textContent="Applied changes to Panel B."; };
$("btnExportB").onclick = ()=>{
  readPanel('B');
  const csv = toEnrichedCSV(B.events, B.meta.bpm, B.meta.key);
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a=document.createElement('a'); a.href=url; a.download='panel_B_notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  updateExportLight();
};
$("chkAllB").onclick = (e)=>{
  $("tableB").querySelectorAll('tbody tr td input[type="checkbox"]').forEach(c=>c.checked=e.target.checked);
};

/* ================= Reset ================= */
$("btnReset").onclick=()=>{
  LAST_ANALYSIS={events:[], meta:{bpm:100,key:"C major"}};
  A={events:[], meta:{bpm:100,key:"C major"}};
  B={events:[], meta:{bpm:100,key:"C major"}};

  $("audioFile").value="";
  $("csvA").value=""; $("csvB").value="";
  $("nameA").textContent="—"; $("nameB").textContent="—";

  detKey.textContent="–"; detBPM.textContent="–";

  light(dotAnalyze,false);
  light(dotExport,false);
  light(dotA,false);
  light(dotB,false);

  $("metaBpmA").value="100"; $("metaKeyA").value="C major"; $("rowCountA").textContent="0";
  $("metaBpmB").value="100"; $("metaKeyB").value="C major"; $("rowCountB").textContent="0";
  $("tableA").querySelector('tbody').innerHTML="";
  $("tableB").querySelector('tbody').innerHTML="";

  statusVal.textContent="Reset complete. Ready.";
};

/* ================= Init ================= */
renderPanel('A');
renderPanel('B');
</script>
</body>
</html>
