<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST LIVE Symphony ‚Äî 1-Minute Orchestral Follower (Emotion + Movements + Equations + Composer Mix)</title>
<meta name="description" content="Upload a song, analyze its first minute, then render a symphonic version with alternating orchestral instruments, emotions, composer style mix (two at a time), movements, and CST-phase timing."/>
<style>
  :root{
    --bg:#081022; --panel:#0f1636; --ink:#e9f1ff; --muted:#9fb2e4; --grid:#1a2658; --btn:#15235a;
    --ok:#153560; --warn:#5b3d00; --border:#274a9a; --live:#10b981; --line:#ffd54a; /* yellow playline */
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  p.sub{margin:0 0 12px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.25);overflow:hidden;margin-bottom:12px}
  .pad{padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:var(--btn);color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer;transition:.2s}
  button:disabled{opacity:.55;cursor:not-allowed}
  button:hover:not(:disabled){filter:brightness(1.08)}
  #live.live-on{background:var(--live);border-color:#0a8f68;color:#062a20;box-shadow:0 0 0 3px rgba(16,185,129,.25), 0 0 18px rgba(16,185,129,.35)}
  #live.live-on::after{content:" ‚óè"; font-weight:900}
  .status{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
  .status>div{background:#0b1333;border:1px solid var(--grid);border-radius:10px;padding:10px;min-height:54px}
  .tiny{font-size:.85rem;color:var(--muted)}
  .cols{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}
  .secTitle{font-weight:600;margin:6px 0 8px}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;align-items:center}
  .kv label{color:var(--muted)}
  input[type="range"]{width:100%}
  select, input[type="text"]{background:#0b1333;border:1px solid var(--grid);color:var(--ink);border-radius:10px;padding:8px 10px}
  #msg{display:none;margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
  .panelTitle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .instGrid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .instRow{display:flex;align-items:center;gap:8px;padding:6px 8px;background:#0b1333;border:1px solid var(--grid);border-radius:10px}
  .instRow label{flex:1}
  .tag{font-size:.75rem;color:#cde;border:1px solid #2a3f8f;border-radius:8px;padding:1px 8px}
  .help{background:#0b1333;border:1px solid var(--grid);border-radius:10px;padding:10px}
  .note{font-size:.85rem;color:#c9d6ff}

  /* Top 1-minute line */
  .lineWrap{margin-bottom:10px}
  #playline{width:100%;height:8px;display:block;background:#0b1333;border:1px solid var(--grid);border-radius:999px}

  /* WAV button (bigger + icon) */
  #export.btn-wav{
    font-weight:600; letter-spacing:.2px;
    display:inline-flex; align-items:center; gap:10px;
    padding:12px 16px; border-radius:14px;
    transform:translateZ(0);
  }
  #export.btn-wav .icon{display:inline-flex}
  #export.btn-wav .txt{white-space:nowrap}

  /* Composer Mix mini layout */
  .mixRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .inlineBtns{display:flex;gap:8px;align-items:center}

  /* Will Play list ‚Üí 2 columns */
  #willPlay{display:grid;grid-template-columns:1fr 1fr;gap:6px 14px}
</style>
</head>
<body>
<div class="wrap">
  <h1>CST LIVE Symphony ‚Äî 1-Minute Orchestral Follower</h1>
  <div class="lineWrap"><canvas id="playline" title="0 ‚Üí 60 seconds progress"></canvas></div>
  <p class="sub">Upload a song ‚Üí <b>Analyze</b> (first 60s) ‚Üí when <b>LIVE ‚Äî PLAY</b> lights, click it. Or use <b>Generate</b> to create notes without audio, or Hybrid to use analyzed tempo/energy.</p>

  <section class="card">
    <div class="pad">
      <div class="row">
        <input id="file" type="file" accept="audio/*"/>
        <button id="analyze">Analyze</button>
        <button id="live" disabled>LIVE ‚Äî PLAY</button>
        <button id="stop">Stop</button>
        <button id="reset">Reset</button>

        <!-- New generate & print controls -->
        <button id="genCompose" title="Generate 60s composition (no upload)">Generate (Compose)</button>
        <button id="genHybrid" title="Generate using analyzed tempo/energy">Generate (Hybrid)</button>

        <!-- Bigger WAV button -->
        <button id="export" class="btn-wav" title="Render the 1-minute symphony to WAV and download">
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3a1 1 0 011 1v8.586l2.293-2.293a1 1 0 111.414 1.414l-4.007 4.007a1 1 0 01-1.414 0L7.279 11.707A1 1 0 018.693 10.293L11 12.586V4a1 1 0 011-1z"/>
              <path d="M5 14a1 1 0 011-1h12a1 1 0 011 1v4.5A2.5 2.5 0 0116.5 21h-9A2.5 2.5 0 015 18.5V14z"/>
            </svg>
          </span>
          <span class="txt">Download WAV</span>
        </button>

        <button id="printNotes" title="Print all generated notes for 60s">üñ®Ô∏è Print Notes</button>
        <button id="saveSel">üíæ Save Selection</button>
        <span id="msg"></span>
      </div>

      <div class="status">
        <div><b>BPM</b><div id="bpm" class="tiny">‚Äì</div></div>
        <div><b>Length</b><div id="len" class="tiny">‚Äì</div></div>
        <div><b>Cadence</b><div id="cadOut" class="tiny">Random</div></div>
        <div><b>Emotion</b><div id="emoOut" class="tiny">Auto</div></div>
        <div><b>Composer Mix</b><div id="mixOut" class="tiny">Mozart 50% ‚Ä¢ Beethoven 50%</div></div>
        <div><b>Will Play</b><div id="willPlay" class="tiny" style="min-height:54px"></div></div>
      </div>
    </div>
    <canvas id="timeline" title="Timeline of instruments & notes" style="width:100%;height:240px;display:block;background:linear-gradient(180deg,#0b1536,#0b1230)"></canvas>
  </section>

  <section class="card">
    <div class="pad cols">
      <div>
        <div class="panelTitle">
          <div class="secTitle">Orchestration (Select/Deselect)</div>
          <div class="row">
            <button id="allOn">All On</button>
            <button id="allOff">All Off</button>
          </div>
        </div>
        <div id="instList" class="instGrid"></div>
      </div>

      <div>
        <div class="secTitle">Source & Composer Mix (exactly two)</div>
        <div class="kv">
          <label for="sourceMode">Source Mode</label>
          <select id="sourceMode">
            <option value="upload" selected>Upload (Audio)</option>
            <option value="compose">Compose (No Audio)</option>
            <option value="hybrid">Hybrid (Audio tempo, new music)</option>
          </select>

          <label for="blendMode">Blend Mode</label>
          <select id="blendMode">
            <option value="blend" selected>Blend with generator</option>
            <option value="replace">Replace generator</option>
          </select>

          <label>Composer A</label>
          <div class="mixRow">
            <select id="compA"></select>
            <select id="compB"></select>
          </div>

          <label for="compMixA">Mix A% (B=100‚àíA)</label>
          <div>
            <input id="compMixA" type="range" min="0" max="100" step="1" value="50"/>
            <div class="tiny">A = <span id="compMixAVal">50</span>% ‚Ä¢ B = <span id="compMixBVal">50</span>%</div>
          </div>

          <label>Actions</label>
          <div class="inlineBtns">
            <button id="swapAB" title="Swap Composer A and B">Swap A‚ÜîB</button>
            <button id="resetAB" title="Reset to 50/50">Reset 50/50</button>
          </div>
        </div>

        <div class="secTitle" style="margin-top:12px">Form, Emotion, Movements & Equations</div>
        <div class="kv">
          <label for="cadence">Cadence</label>
          <select id="cadence">
            <option value="random">Random (safe)</option>
            <option value="I-IV-V-I">I‚ÄìIV‚ÄìV‚ÄìI</option>
            <option value="I-vi-IV-V">I‚Äìvi‚ÄìIV‚ÄìV</option>
            <option value="ii-V-I">ii‚ÄìV‚ÄìI</option>
            <option value="I-V-vi-IV">I‚ÄìV‚Äìvi‚ÄìIV</option>
            <option value="authentic">Authentic (V‚ÄìI)</option>
            <option value="plagal">Plagal (IV‚ÄìI)</option>
            <option value="half">Half (‚Üí V)</option>
            <option value="phrygian_half">Phrygian Half (iv6‚ÄìV)</option>
            <option value="deceptive">Deceptive (V‚Äìvi)</option>
            <option value="custom">Custom‚Ä¶</option>
          </select>

          <label for="cadenceCustom">Custom (I, IV, V or degrees 0..11)</label>
          <input id="cadenceCustom" class="mono" placeholder="I, IV, V, I" disabled/>

          <label for="pace">Pace</label>
          <select id="pace">
            <option value="calm">Calm</option>
            <option value="medium" selected>Medium</option>
            <option value="urgent">Urgent</option>
          </select>

          <label for="movement">Symphony Movement</label>
          <select id="movement">
            <option value="I">I ‚Äî Allegro (sonata-like)</option>
            <option value="II">II ‚Äî Andante/Adagio</option>
            <option value="III">III ‚Äî Minuet/Scherzo</option>
            <option value="IV" selected>IV ‚Äî Finale (fast)</option>
          </select>

          <label for="tempoFactor">Tempo Factors</label>
          <select id="tempoFactor">
            <option value="intent" selected>Composer‚Äôs intent</option>
            <option value="structure">Movement structure</option>
            <option value="performance">Performance choices</option>
            <option value="exceptions">Exceptions to the rule</option>
          </select>

          <label for="emotion">Emotion</label>
          <select id="emotion">
            <option value="auto" selected>Auto (from audio)</option>
            <option value="happy">Happy</option>
            <option value="sad">Sad</option>
            <option value="angry">Angry</option>
            <option value="spooky">Spooky</option>
            <option value="calm">Calm</option>
          </select>

          <label for="emoInt">Emotion intensity</label>
          <div><input id="emoInt" type="range" min="0" max="1" step="0.05" value="0.6"/><div class="tiny">= <span id="emoIntVal">0.60</span></div></div>

          <label for="swing">Swing (1=straight)</label>
          <div><input id="swing" type="range" min="1.00" max="1.50" step="0.01" value="1.10"/><div class="tiny">= <span id="swingVal">1.10</span></div></div>

          <label for="dotTri">Dotted/Tri tilt</label>
          <div><input id="dotTri" type="range" min="-0.4" max="0.6" step="0.05" value="0.30"/><div class="tiny">= <span id="dotTriVal">0.30</span></div></div>

          <label>Voices per beat</label>
          <div>
            <input id="vmin" type="range" min="1" max="6" step="1" value="1"/> <span class="tiny" id="vminVal">1</span>
            <br/>
            <input id="vmax" type="range" min="2" max="8" step="1" value="4"/> <span class="tiny" id="vmaxVal">4</span>
            <div class="tiny">range: <span id="vb">1‚Äì4</span></div>
          </div>

          <label for="bassDepth">Bass depth</label>
          <div><input id="bassDepth" type="range" min="0.8" max="1.8" step="0.05" value="1.15"/><div class="tiny">= <span id="bassDepthVal">1.15</span></div></div>

          <label for="toneBias">Tone bias (high ‚Üî low)</label>
          <div><input id="toneBias" type="range" min="-1" max="1" step="0.1" value="0"/><div class="tiny">= <span id="toneBiasVal">0.0</span></div></div>

          <label for="percAmt">Percussion amount</label>
          <div><input id="percAmt" type="range" min="0" max="1" step="0.05" value="0.4"/><div class="tiny">= <span id="percAmtVal">0.40</span></div></div>
        </div>

        <div class="help" style="margin-top:10px">
          <b>Notes</b>
          <ul class="note">
            <li><b>Composer Mix</b> lets you pick <b>exactly two</b> styles (e.g., Mozart & Beethoven) and set A% vs B%.</li>
            <li><b>Generate</b> makes notes without playing; <b>LIVE ‚Äî PLAY</b> plays them; <b>üñ®Ô∏è Print Notes</b> prints the 60s score.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</div>
<script>
/* ========= Tiny DOM helpers ========= */
const $ = (id)=>document.getElementById(id);
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function setMsg(t,kind='ok'){ const el=$('msg'); if(!el) return; el.style.display='inline-block'; el.textContent=t; el.style.background = kind==='warn' ? '#5b3d00' : '#153560'; el.style.borderColor = kind==='warn' ? '#ffb84d' : '#274a9a'; }
function clearMsg(){ const el=$('msg'); if(!el) return; el.style.display='none'; }
function setLiveOn(on){ const b=$('live'); if(!b) return; if(on){ b.classList.add('live-on'); } else { b.classList.remove('live-on'); } }

/* ========= Top 60s progress line ========= */
const LINE = $('playline'); const LCTX = LINE.getContext('2d');
let rafId=null, playStart=0, playLen=60, lineActive=false, playTimer=null;

/* ‚úÖ Hard caps */
const MAX_ANALYZE_SECONDS = 60;
const MAX_PLAY_SECONDS    = 60;

function drawLine(p){
  const dpr=window.devicePixelRatio||1, W=LINE.clientWidth*dpr, H=LINE.clientHeight*dpr;
  LINE.width=W; LINE.height=H; LCTX.clearRect(0,0,W,H);
  LCTX.fillStyle='#0b1333'; LCTX.fillRect(0,0,W,H);
  LCTX.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--line')||'#ffd54a';
  LCTX.fillRect(0,0,Math.max(0,Math.min(W, W*p)),H);
}
function startLine(seconds){
  playLen = Math.max(1, Math.min(MAX_PLAY_SECONDS, seconds||MAX_PLAY_SECONDS));
  playStart=performance.now(); lineActive=true; loopLine();
}
function stopLine(){ lineActive=false; if(rafId) cancelAnimationFrame(rafId); drawLine(0); }
function loopLine(){
  if(!lineActive) return;
  const t=(performance.now()-playStart)/1000;
  const p=t/playLen;
  drawLine(p);
  if(t>=Math.min(playLen, MAX_PLAY_SECONDS)){ lineActive=false; try{ stopAll(); }catch(e){} return; }
  rafId=requestAnimationFrame(loopLine);
}

/* ========= Composer list & hooks ========= */
const COMPOSERS = [
  'Mozart','Beethoven','Bach','Haydn','Schubert','Chopin','Brahms','Tchaikovsky',
  'Debussy','Ravel','Stravinsky','Vivaldi','Handel','Schumann','Liszt','Mahler',
  'Prokofiev','Shostakovich','Rachmaninoff','Williams','Zimmer'
];
const composerHooks = {
  Mozart: (notes)=>{ if(Math.random()<0.35){ notes.push(notes[0]-1); } return notes; },
  Beethoven:(notes)=>{ if(Math.random()<0.40){ notes.push(notes[0]+12); } return notes; },
  Bach:   (notes)=>{ if(Math.random()<0.50){ notes.push(notes[0]+7); } return notes; },
  Haydn:  (notes)=>{ if(Math.random()<0.25){ notes.push(notes[0]+5); } return notes; },
  Schubert:(notes)=>{ if(Math.random()<0.35){ notes.push(notes[0]-12); } return notes; },
  Chopin: (notes)=>{ if(Math.random()<0.55){ notes.push(notes[0]+4); } return notes; },
  Brahms: (notes)=>{ if(Math.random()<0.45){ notes.push(notes[0]-5); } return notes; },
  Tchaikovsky:(notes)=>{ if(Math.random()<0.40){ notes.push(notes[0]+2); } return notes; },
  Debussy:(notes)=>{ if(Math.random()<0.5){ for(let i=1;i<3;i++) notes.push(notes[0]+2*i); } return notes; },
  Ravel:  (notes)=>{ if(Math.random()<0.5){ notes.push(notes[0]+11); } return notes; },
  Stravinsky:(notes)=>{ if(Math.random()<0.6){ notes.push(notes[0]+5); } return notes; },
  Vivaldi:(notes)=>{ if(Math.random()<0.45){ notes.push(notes[0]+12); } return notes; },
  Handel: (notes)=>{ if(Math.random()<0.3){ notes.push(notes[0]+7); } return notes; },
  Schumann:(notes)=>{ if(Math.random()<0.35){ notes.push(notes[0]-2); } return notes; },
  Liszt:  (notes)=>{ if(Math.random()<0.55){ notes.push(notes[0]+12); notes.push(notes[0]+19);} return notes; },
  Mahler: (notes)=>{ if(Math.random()<0.45){ notes.push(notes[0]-7); } return notes; },
  Prokofiev:(notes)=>{ if(Math.random()<0.5){ notes.push(notes[0]+1); } return notes; },
  Shostakovich:(notes)=>{ if(Math.random()<0.5){ notes.push(notes[0]-1); } return notes; },
  Rachmaninoff:(notes)=>{ if(Math.random()<0.5){ notes.push(notes[0]-12); } return notes; },
  Williams:(notes)=>{ if(Math.random()<0.45){ notes.push(notes[0]+12); } return notes; },
  Zimmer: (notes)=>{ if(Math.random()<0.6){ notes.push(notes[0]+12); } return notes; },
};
function blendedHook(A, B, wA){
  const hookA = composerHooks[A] || ((x)=>x);
  const hookB = composerHooks[B] || ((x)=>x);
  const w = clamp(wA,0,1);
  return (notes)=>{
    let base=[...notes];
    if(Math.random()<w){ base = hookA(base); if(Math.random()<1-w) base = hookB(base); }
    else { base = hookB(base); if(Math.random()<w) base = hookA(base); }
    return base;
  };
}

/* ========= Canvas timeline ========= */
const TLM = document.getElementById('timeline'); 
const CTX = TLM ? TLM.getContext('2d') : null;
function drawTimeline(score){
  if(!TLM || !CTX || !score) return;
  const dpr=window.devicePixelRatio||1; const W=TLM.clientWidth*dpr, H=TLM.clientHeight*dpr; 
  TLM.width=W; TLM.height=H; CTX.clearRect(0,0,W,H);
  const rows = Array.from(new Set(score.events.map(e=>e.inst))).concat(['perc']);
  const rh = H/rows.length;
  const colors = {}; rows.forEach((r,i)=>colors[r]=`hsl(${(i*47)%360} 70% 72%)`);
  CTX.strokeStyle="#1b2a66"; CTX.lineWidth=1;
  const beats = Math.max(1, Math.round(score.seconds/(60/score.bpm)));
  for(let i=0;i<=beats;i++){ const x=i*(W/beats); CTX.beginPath(); CTX.moveTo(x,0); CTX.lineTo(x,H); CTX.stroke(); }
  const rx = t => (t/score.seconds)*W;
  score.events.forEach(e=>{
    const ri=rows.indexOf(e.inst); if(ri<0) return; 
    const x=rx(e.time), w=(e.dur/score.seconds)*W, y=ri*rh+rh*0.2, h=rh*0.6; 
    CTX.fillStyle=colors[e.inst]; CTX.fillRect(x,y,Math.max(1.5,w),h);
  });
}

/* ========= Audio ========= */
let ACTX=null, master=null, BUS={}, scheduled=[], playing=false;
function ensureAudio(){ if(ACTX) return; ACTX = new (window.AudioContext||window.webkitAudioContext)(); master = ACTX.createGain(); master.gain.value=0.9; master.connect(ACTX.destination); }
async function unlockAudio(){ ensureAudio(); try{ await ACTX.resume(); }catch(e){} }
function makeBus(level,pan=0){ const g=ACTX.createGain(); g.gain.value=level; const p=ACTX.createStereoPanner?ACTX.createStereoPanner():null; if(p){ p.pan.value=pan; g.connect(p); p.connect(master); } else { g.connect(master); } return {g}; }
function stopAll(){
  if(playTimer){ clearTimeout(playTimer); playTimer=null; }
  if(!playing) { stopLine(); setLiveOn(false); return; }
  playing=false; setLiveOn(false); stopLine();
  const now=ACTX?ACTX.currentTime:0;
  scheduled.forEach(n=>{ try{
    if(n.g){ n.g.gain.cancelScheduledValues(now); n.g.gain.linearRampToValueAtTime(0, now+0.05); }
    (n.o||[]).forEach(o=>{ try{o.stop(now+0.06);}catch(e){} });
  }catch(e){} });
  scheduled.length=0;
}

/* ========= Orchestra ========= */
const ORCH = [
  {name:'violin', type:'bowed', role:'lead'},
  {name:'viola', type:'bowed', role:'counter'},
  {name:'cello', type:'bowed', role:'bed'},
  {name:'double_bass', label:'Double Bass', type:'bass', role:'bass'},
  {name:'harp', type:'pluck', role:'sparkle'},
  {name:'flute', type:'reed', role:'lead'},
  {name:'alto_flute', label:'Alto Flute', type:'reed', role:'bed'},
  {name:'piccolo', type:'reed', role:'sparkle'},
  {name:'oboe', type:'reed', role:'lead'},
  {name:'english_horn', label:'English Horn', type:'reed', role:'counter'},
  {name:'clarinet', type:'reed', role:'counter'},
  {name:'bass_clarinet', label:'Bass Clarinet', type:'reed', role:'bed'},
  {name:'bassoon', type:'reed', role:'bed'},
  {name:'contrabassoon', type:'reed', role:'bass'},
  {name:'horn', label:'French Horn', type:'brass', role:'bed'},
  {name:'trumpet', type:'brass', role:'lead'},
  {name:'cornet', type:'brass', role:'lead'},
  {name:'trombone', type:'brass', role:'counter'},
  {name:'bass_trombone', label:'Bass Trombone', type:'brass', role:'bass'},
  {name:'tuba', type:'brass', role:'bass'},
  {name:'euphonium', type:'brass', role:'bed'},
  {name:'timpani', type:'perc', role:'perc'},
  {name:'snare', type:'perc', role:'perc'},
  {name:'bass_drum', label:'Bass Drum', type:'perc', role:'perc'},
  {name:'cymbals', type:'perc', role:'perc'},
  {name:'triangle', type:'perc', role:'perc'},
  {name:'tambourine', type:'perc', role:'perc'},
  {name:'tam_tam', label:'Tam-tam', type:'perc', role:'perc'},
  {name:'xylophone', type:'pluck', role:'sparkle'},
  {name:'glockenspiel', type:'bell', role:'sparkle'},
  {name:'chimes', type:'bell', role:'sparkle'},
  {name:'vibraphone', type:'bell', role:'sparkle'},
  {name:'marimba', type:'pluck', role:'sparkle'},
  {name:'piano', type:'pluck', role:'bed'},
  {name:'celesta', type:'pluck', role:'sparkle'},
  {name:'harpsichord', type:'pluck', role:'sparkle'},
  {name:'organ', type:'organ', role:'bed'},
  {name:'saxophone', type:'reed', role:'counter'}
];
const ORCH_MASTER = ORCH.map(i=>i.name);
function labelOf(inst){ return inst?.label || (inst?.name||'').replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); }

/* ========= Selection & persistence ========= */
let INST_SELECTION = {}; // name -> bool
const LS_KEY='cst_orch_selection_v7_mix3';
const DEFAULT_COMP_A='Mozart', DEFAULT_COMP_B='Beethoven';

function saveAllSelections(){
  const data={
    inst:INST_SELECTION,
    cadence:$('cadence').value, cadenceCustom:$('cadenceCustom').value,
    pace:$('pace').value, movement:$('movement').value, tempoFactor:$('tempoFactor').value,
    emotion:$('emotion').value, emoInt:$('emoInt').value,
    swing:$('swing').value, dotTri:$('dotTri').value,
    vmin:$('vmin').value, vmax:$('vmax').value,
    bassDepth:$('bassDepth').value, toneBias:$('toneBias').value, percAmt:$('percAmt').value,
    sourceMode:$('sourceMode').value, blendMode:$('blendMode').value,
    compA:$('compA').value, compB:$('compB').value, compMixA:$('compMixA').value
  };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
  setMsg('All selections saved (instruments + settings + composer mix).');
}
function loadAllSelections(){
  try{
    const raw=localStorage.getItem(LS_KEY); if(!raw) return;
    const d=JSON.parse(raw)||{};
    INST_SELECTION=d.inst||INST_SELECTION;
    const ids=['cadence','cadenceCustom','pace','movement','tempoFactor','emotion','emoInt','swing','dotTri','vmin','vmax','bassDepth','toneBias','percAmt','sourceMode','blendMode','compA','compB','compMixA'];
    ids.forEach(id=>{ if($(id) && d[id]!=null){ $(id).value = d[id]; } });
    if($('cadence').value==='custom'){ $('cadenceCustom').disabled=false; }
  }catch(e){}
}

/* UI builders */
function buildInstList(){
  const box = $('instList'); if(!box) return; box.innerHTML='';
  ORCH.forEach(inst=>{
    if(!INST_SELECTION.hasOwnProperty(inst.name)) INST_SELECTION[inst.name]=true;
    const row=document.createElement('div'); row.className='instRow';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = !!INST_SELECTION[inst.name];
    cb.addEventListener('change', ()=>{ INST_SELECTION[inst.name]=cb.checked; });
    const lbl=document.createElement('label'); lbl.textContent=labelOf(inst);
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent = inst.role;
    row.appendChild(cb); row.appendChild(lbl); row.appendChild(tag);
    box.appendChild(row);
  });
}
function selectAll(v=true){ ORCH_MASTER.forEach(n=>INST_SELECTION[n]=v); buildInstList(); if(!v) setMsg('All instruments disabled. Enable a few to play.','warn'); else setMsg('All instruments enabled.'); }

/* Random 20 instruments on Analyze/Reset */
function randomize20(){
  ORCH_MASTER.forEach(n=>INST_SELECTION[n]=false);
  const pool=[...ORCH_MASTER];
  for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
  pool.slice(0, Math.min(20, pool.length)).forEach(n=>INST_SELECTION[n]=true);
  buildInstList();
}
</script>
<script>
/* ========= Analysis ========= */
let SOURCEBUF=null;
async function decodeFileToBuffer(file){ await unlockAudio(); const ab=await file.arrayBuffer(); return await ACTX.decodeAudioData(ab); }
function monoMixFirstMinute(buf){
  const maxSamp=Math.min(buf.length, Math.floor(buf.sampleRate*MAX_ANALYZE_SECONDS));
  const ch0=buf.getChannelData(0).slice(0,maxSamp);
  if(buf.numberOfChannels===1) return new Float32Array(ch0);
  const ch1=buf.getChannelData(1);
  const out=new Float32Array(maxSamp);
  for(let i=0;i<maxSamp;i++) out[i]=0.5*(ch0[i]+ch1[i]);
  return out;
}
async function energyEnvelopeAsync(x, win=2048, hop=1024, onProgress=null){
  const out=[]; let i=0; const N=x.length; const chunk=256*hop;
  while(i+win<=N){
    const end=Math.min(i+chunk, N-win);
    for(; i<=end; i+=hop){
      let s=0; for(let k=0;k<win;k++){ const v=x[i+k]; s+=v*v; }
      out.push(Math.sqrt(s/win));
    }
    if(onProgress) onProgress(out.length/(N/hop));
    await new Promise(r=>setTimeout(r,0));
  }
  return {env:out, hop};
}
function autocorrTempo(env, sr, hop){
  const fps=sr/hop; const minBPM=40, maxBPM=200;
  const minLag=Math.round(fps*60/maxBPM), maxLag=Math.round(fps*60/minBPM);
  let bestLag=minLag, bestVal=-1;
  for(let L=minLag; L<=maxLag; L++){
    let s=0; for(let i=0;i+L<env.length;i++) s += env[i]*env[i+L];
    if(s>bestVal){ bestVal=s; bestLag=L; }
  }
  const bpm=60*fps/bestLag; return Math.max(40, Math.min(200, bpm));
}
function peakPickBeats(env, sr, hop, bpm, hard=60){
  const fps=sr/hop, spb=fps*60/bpm; const beats=[]; let n=0;
  while(true){
    const center=Math.round(n*spb); if(center>=env.length) break;
    const r=Math.round(0.25*spb); let bestI=center,bestV=-1;
    for(let k=center-r; k<=center+r; k++){ if(k<0||k>=env.length) continue; const v=env[k]; if(v>bestV){bestV=v; bestI=k;} }
    const t=bestI/fps; if(t>hard) break;
    beats.push(bestI);
    n++;
  }
  return beats.map(i=>i/fps);
}

/* ========= Features / CST phase ========= */
function spectralFeatures(envSeries){
  const N=envSeries.length; if(N===0) return {arousal:0.5, brightness:0.5};
  const mean = envSeries.reduce((a,b)=>a+b,0)/N;
  const varc = envSeries.reduce((a,b)=>a+(b-mean)*(b-mean),0)/N;
  const arousal = clamp(Math.sqrt(varc)*1.8, 0, 1);
  let diff=0; for(let i=1;i<N;i++) diff += Math.abs(envSeries[i]-envSeries[i-1]);
  const brightness = clamp(diff/(N*0.02), 0, 1);
  return {arousal, brightness};
}
function pickEquationModes(){
  const opts=['phi','fourier','prime'];
  const shuffled=[...opts].sort(()=>Math.random()-0.5);
  return shuffled.slice(0, 1 + Math.floor(Math.random()*2));
}
function eqPhaseCST(modes, beatPeriod){
  let phase = 0;
  const now = new Intl.DateTimeFormat('en-US',{timeZone:'America/Chicago',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})
              .formatToParts(new Date()).reduce((a,p)=>{a[p.type]=p.value; return a;},{});
  const sec = parseInt(now.second||'0',10);
  if(modes.includes('phi')) phase += 0.618;
  phase += (sec%10)/100;
  return (phase%1)*beatPeriod;
}

/* ========= Cadences ========= */
function chordFromDegree(deg){
  const map={'I':0,'ii':2,'iii':4,'IV':5,'V':7,'vi':9,'VII':11};
  let root = map[deg];
  if(root===undefined){ const n=parseInt(deg,10); root = isNaN(n)?0:((n%12)+12)%12; }
  return [root,(root+4)%12,(root+7)%12];
}
function cadenceList(name, custom){
  if(name==='I-IV-V-I') return ['I','IV','V','I'];
  if(name==='I-vi-IV-V') return ['I','vi','IV','V'];
  if(name==='ii-V-I') return ['ii','V','I','I'];
  if(name==='I-V-vi-IV') return ['I','V','vi','IV'];
  if(name==='authentic') return ['V','I','V','I'];
  if(name==='plagal') return ['IV','I','IV','I'];
  if(name==='half') return ['I','IV','ii','V'];
  if(name==='phrygian_half') return ['ii','V','ii','V'];
  if(name==='deceptive') return ['V','vi','IV','V'];
  if(name==='custom'){ if(!custom) return ['I','IV','V','I']; return custom.split(/[,\s]+/).filter(Boolean); }
  return ['I','IV','V','I'];
}

/* ========= Emotion profiles ========= */
function emotionProfile(kind, intensity, autoFeat){
  const base = {
    leadGain:1, bedGain:1, bassGain:1, sparkGain:1, percGain:0.4,
    leadSet:['violin','flute','trumpet'],
    bedSet:['cello','horn','piano','organ'],
    bassSet:['double_bass','tuba','bass_trombone','contrabassoon'],
    sparkSet:['glockenspiel','celesta','harp','piccolo','chimes'],
    accentStrong:false, staccato:false, lowBias:0, highBias:0
  };
  const k = kind;
  if(k==='auto'){
    const a = autoFeat?.arousal ?? 0.5;
    const b = autoFeat?.brightness ?? 0.5;
    if(a>0.6 && b>0.55) return emotionProfile('happy', intensity);
    if(a>0.6 && b<0.45) return emotionProfile('angry', intensity);
    if(a<0.4 && b<0.45) return emotionProfile('sad', intensity);
    if(b<0.35) return emotionProfile('spooky', intensity);
    return emotionProfile('calm', intensity);
  }
  const out = JSON.parse(JSON.stringify(base));
  const t = clamp(intensity,0,1);
  if(k==='happy'){
    out.leadSet=['flute','violin','trumpet','clarinet'];
    out.sparkSet=['glockenspiel','celesta','chimes','harp','piccolo','vibraphone'];
    out.leadGain=1+0.2*t; out.sparkGain=1+0.35*t; out.percGain=0.35+0.3*t; out.highBias=0.3*t; out.accentStrong=true;
  }else if(k==='sad'){
    out.leadSet=['oboe','viola','cello','english_horn'];
    out.bedSet=['piano','cello','horn','clarinet'];
    out.sparkSet=['harp','celesta']; out.bassSet=['double_bass','contrabassoon'];
    out.bedGain=1+0.15*t; out.bassGain=1+0.1*t; out.sparkGain=1-0.2*t; out.percGain=0.15; out.lowBias=0.25*t;
  }else if(k==='angry'){
    out.leadSet=['trumpet','trombone','horn','saxophone'];
    out.bedSet=['trombone','horn','organ']; out.bassSet=['tuba','bass_trombone','double_bass'];
    out.sparkSet=['cymbals','tam_tam'];
    out.leadGain=1+0.35*t; out.bedGain=1+0.2*t; out.bassGain=1+0.25*t; out.sparkGain=1+0.2*t;
    out.percGain=0.5+0.4*t; out.lowBias=0.2*t; out.staccato=true; out.accentStrong=true;
  }else if(k==='spooky'){
    out.leadSet=['bass_clarinet','bassoon','viola','alto_flute'];
    out.bedSet=['cello','piano','horn']; out.bassSet=['contrabassoon','double_bass'];
    out.sparkSet=['tam_tam','triangle','marimba','vibraphone'];
    out.bassGain=1+0.2*t; out.percGain=0.25+0.25*t; out.lowBias=0.35*t; out.highBias=-0.2*t;
  }else if(k==='calm'){
    out.leadSet=['clarinet','flute','violin','alto_flute'];
    out.bedSet=['harp','cello','piano','horn']; out.bassSet=['double_bass'];
    out.sparkSet=['celesta','harp','glockenspiel','vibraphone'];
    out.bedGain=1+0.1*t; out.percGain=0.15; out.highBias=0.1*t;
  }
  return out;
}

/* ========= Helpers ========= */
function getType(instName){ const meta = ORCH.find(i=>i.name===instName); return meta?meta.type:'bowed'; }
const REG = { lead:72, bed:60, bass:36, spark:79 }; // pitch centers

/* ========= Score generator (uses blended composer hook) ‚Äî UPDATED CLAMP ========= */
function generateScore(params){
  let {
    bpm, totalSecs, energyArr, cadenceNames, swingBase, dotTri, vmin, vmax,
    bassDepth, modes, emotionKind, emoIntensity, toneBias, percAmt,
    pace, movement, tempoFactor, eqApproach,
    compA, compB, mixA, ensureAll=true
  } = params;

  // ‚úÖ Clamp to 60 seconds hard
  totalSecs = Math.min(MAX_PLAY_SECONDS, Math.max(1, totalSecs || MAX_PLAY_SECONDS));

  const wA = clamp(mixA,0,1);
  const hook = blendedHook(compA||'Mozart', compB||'Beethoven', wA);

  const features = spectralFeatures(energyArr||[]);
  const emo = emotionProfile(emotionKind, emoIntensity, features);

  /* Movement & tempo factor scalers */
  let paceScale = pace==='calm'? 1.12 : pace==='urgent'? 0.9 : 1.0;
  if(movement==='II') paceScale *= 1.18;
  if(movement==='III') paceScale *= 0.98;
  if(movement==='IV') paceScale *= 0.92;
  if(tempoFactor==='structure') paceScale *= 0.97;
  if(tempoFactor==='performance') paceScale *= (0.95 + Math.random()*0.1);
  if(tempoFactor==='exceptions') paceScale *= (0.9 + Math.random()*0.2);

  let randPush = 0.0, densityPush=1.0;
  if(eqApproach==='finite'){ randPush = -0.2; densityPush=0.95; }
  if(eqApproach==='infinite'){ randPush = +0.25; densityPush=1.1; }

  const beatPeriod0 = 60/Math.max(40,Math.min(200,bpm));
  const beatPeriod = beatPeriod0*paceScale;
  const beatsPerBar=4;
  const cstOffset = eqPhaseCST(modes, beatPeriod);
  const totalBeats = Math.max(1, Math.floor(totalSecs/beatPeriod));
  const totalBars = Math.max(1, Math.floor(totalBeats/beatsPerBar));
  const barChords = Array.from({length: totalBars}, (_,b)=> chordFromDegree(cadenceNames[b % cadenceNames.length]));

  const allowedNames = ORCH.filter(i=>INST_SELECTION[i.name]).map(i=>i.name);
  if(!allowedNames.length) return {events:[],bpm,totalSecs};

  function pickFromSet(setNames, fallbackRole){
    const filt = setNames.filter(n=>allowedNames.includes(n));
    if(filt.length) return filt[Math.floor(Math.random()*filt.length)];
    const rolePick = ORCH.filter(i=>allowedNames.includes(i.name) && i.role===fallbackRole);
    if(rolePick.length) return rolePick[Math.floor(Math.random()*rolePick.length)].name;
    return allowedNames[Math.floor(Math.random()*allowedNames.length)];
  }

  const events=[]; const last={lead:null,bass:null,bed:null,spark:null};
  const cadenceGain = 0.70;
  const emoGain = { lead:emo.leadGain, bed:emo.bedGain, bass:emo.bassGain, spark:emo.sparkGain };

  for(let b=0;b<totalBeats;b++){
    const bar = Math.floor(b/beatsPerBar);
    const inBar = b % beatsPerBar;
    const chord = barChords[Math.min(bar, barChords.length-1)];
    const [root, third, fifth] = chord;

    const tBeat = b*beatPeriod + cstOffset;
    const E = (energyArr && energyArr.length) ? energyArr[Math.min(energyArr.length-1, b)] : 0.5;

    let V = clamp(Math.round(vmin + (vmax - vmin)*E*densityPush), 1, 8);
    if(Math.random()<Math.max(0,randPush)) V = Math.min(8, V+1);
    if(modes.includes('prime')){ const isPrime = (n)=>{ if(n<2) return false; for(let k=2;k*k<=n;k++) if(n%k===0) return false; return true; }; if(isPrime(b)) V = Math.max(1, V-1); }

    let swing = +$('swing').value;
    if(modes.includes('fourier')) swing = clamp(1.0 + 0.25*Math.sin(2*Math.PI*(b/16)), 1.0, 1.5);

    const toneShift = Math.round( (emo.highBias - emo.lowBias + (+$('toneBias').value)*0.6) * 6 );

    const want=[];
    if(V>=1) want.push('lead');
    if(V>=2) want.push('bass');
    if(V>=3) want.push('bed');
    if(V>=4) want.push(Math.random()<0.6?'spark':'counter');
    if(V>=5) want.push('counter');

    // Lead
    if(want.includes('lead')){
      const inst = pickFromSet(emo.leadSet, 'lead');
      const prev=last.lead;
      const chordTones=[root,third,fifth,(root+2)%12,(root+9)%12];
      const target = (prev==null ? REG.lead+root : prev);
      let best=REG.lead+root, bestDist=1e9;
      for(const ct of chordTones){ for(let k=-2;k<=2;k++){ const m=REG.lead + (ct+12*k) + toneShift; const d=Math.abs(m-target); if(d<bestDist){bestDist=d; best=m;} } }
      const e8 = beatPeriod/2;
      const dLong = (swing/(swing+1))*e8, dShort=(1/(swing+1))*e8;
      const useSwing = (swing>1.02) && (inBar%2===0);
      let dur = (useSwing ? (Math.random()<0.5? dLong: dShort) : (Math.random()<0.3? e8 : beatPeriod));
      dur += (+$('dotTri').value)*(Math.random()<0.5 ? 0.5*e8 : -1/6*beatPeriod);
      dur = Math.max(emo.staccato?0.14:0.24, dur);
      let notes=[best];
      notes = hook(notes);
      notes.forEach((midi,idx)=>{
        const vel = (idx===0?0.68:0.48) * emoGain.lead * (emo.accentStrong && inBar===0 ? 1.15 : 1.0);
        events.push({inst, type:getType(inst), time:tBeat+(idx?0.02*idx:0), dur:dur, midi:midi, vel:vel});
      });
      last.lead=best;
    }

    // Bass
    if(want.includes('bass')){
      const inst = pickFromSet(emo.bassSet, 'bass');
      const prev=last.bass;
      const bassCand = Math.random()<0.75 ? root : fifth;
      let m = REG.bass + bassCand + toneShift;
      if(prev!=null){ const opts=[m,m-12,m+12]; m = opts.reduce((a,b)=> Math.abs(b-prev)<Math.abs(a-prev)?b:a, opts[0]); }
      const dur = beatPeriod*(Math.random()<0.6?1:2);
      events.push({inst, type:getType(inst), time:tBeat, dur:dur, midi:m, vel:0.58*(+$('bassDepth').value)*emoGain.bass});
      last.bass=m;
    }

    // Bed chords
    if(want.includes('bed')){
      const inst = pickFromSet(emo.bedSet, 'bed');
      const base = REG.bed + root + toneShift;
      [0,4,7].forEach(iv=>{
        const dd = beatPeriod*(Math.random()<0.5?2:4);
        events.push({inst, type:getType(inst), time:tBeat, dur:dd, midi:base+iv, vel:0.40*cadenceGain*emoGain.bed});
      });
      last.bed=base+4;
    }

    // Sparkle / Counter
    if(want.includes('spark') || want.includes('counter')){
      const isSpark = want.includes('spark');
      if(isSpark){
        const inst = pickFromSet(emo.sparkSet, 'sparkle');
        const base = REG.spark + root + toneShift;
        [0,4,7,12].forEach((iv,i)=>{ const tt=tBeat+i*(beatPeriod/4); events.push({inst, type:getType(inst), time:tt, dur:beatPeriod/4, midi:base+iv, vel:0.48*emoGain.spark}); });
      }else{
        const inst = pickFromSet(emo.leadSet.concat(['viola','clarinet']), 'counter');
        const prev=last.lead ?? (72+root+toneShift);
        const step=Math.random()<0.5?2:-2;
        events.push({inst, type:getType(inst), time:tBeat+0.02, dur:beatPeriod*(emo.staccato?0.6:1.0), midi:prev+step, vel:0.52*emoGain.lead});
      }
    }

    // Perc scaled by emotion/percussion amount
    const P = (+$('percAmt').value)*emo.percGain;
    if(INST_SELECTION['bass_drum'] && inBar===0 && Math.random()<0.95) PATCH.k(tBeat, 0.35+0.35*E*P);
    if(INST_SELECTION['snare'] && inBar===2) PATCH.s(tBeat+0.02, 0.22+0.18*E*P);
    if((INST_SELECTION['triangle']||INST_SELECTION['cymbals']) && Math.random()<0.25) PATCH.h(tBeat+0.01, 0.12+0.12*E*P);
  }

  /* Ensure coverage: at least 1 note per selected instrument */
  if(ensureAll){
    const used = new Set(events.map(e=>e.inst));
    const allowed = allowedNames;
    const gap = totalSecs / Math.max(1, allowed.length);
    allowed.forEach((name, idx)=>{
      if(used.has(name)) return;
      const t = Math.min(totalSecs-0.5, idx*gap + 0.1);
      const role = (ORCH.find(i=>i.name===name)?.role)||'bed';
      let midi = (role==='lead')? REG.lead : (role==='bass')? REG.bass : (role==='sparkle')? REG.spark : REG.bed;
      const vel = 0.45;
      const dur = 0.35;
      events.push({inst:name, type:getType(name), time:t, dur:dur, midi:midi, vel:vel});
    });
  }

  events.sort((a,b)=>a.time-b.time);
  return {events, bpm, seconds: totalSecs};
}

/* ========= WebAudio patches (playback) ========= */
function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }
function envGain(g,t0,a,d,sus,hold,rel,amp){
  const t1=t0+a, t2=t1+d, t3=t2+hold, t4=t3+rel;
  g.gain.setValueAtTime(0,t0);
  g.gain.linearRampToValueAtTime(amp,t1);
  g.gain.linearRampToValueAtTime(amp*sus,t2);
  g.gain.setValueAtTime(amp*sus,t3);
  g.gain.linearRampToValueAtTime(0,t4);
  return t4;
}
const PATCH = {
  bowed:(bus,m,when,dur,vel)=>{ const o=ACTX.createOscillator(); o.type='sawtooth'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2200;
    const g=ACTX.createGain(); const end=envGain(g,when,0.04,0.45,0.8,Math.max(0.05,dur-0.4),0.3,vel*0.55);
    o.connect(f); f.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  reed:(bus,m,when,dur,vel)=>{ const o=ACTX.createOscillator(); o.type='square'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2400;
    const g=ACTX.createGain(); const end=envGain(g,when,0.03,0.22,0.55,Math.max(0.05,dur-0.25),0.2,vel*0.55);
    o.connect(f); f.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  brass:(bus,m,when,dur,vel)=>{ const o=ACTX.createOscillator(); o.type='sawtooth'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1800;
    const g=ACTX.createGain(); const end=envGain(g,when,0.02,0.25,0.6,Math.max(0.05,dur-0.3),0.25,vel*0.55);
    o.connect(f); f.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  pluck:(bus,m,when,dur,vel)=>{ const o=ACTX.createOscillator(); o.type='triangle'; o.frequency.value=midiToHz(m);
    const g=ACTX.createGain(); const end=envGain(g,when,0.002,0.22,0.35,0.01,0.4,vel*0.6);
    o.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  bell:(bus,m,when,dur,vel)=>{ const o=ACTX.createOscillator(); o.type='sine'; o.frequency.value=midiToHz(m);
    const g=ACTX.createGain(); const end=envGain(g,when,0.002,0.6,0.3,0.02,1.2,vel*0.6);
    o.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  organ:(bus,m,when,dur,vel)=>{ const o1=ACTX.createOscillator(), o2=ACTX.createOscillator(); o1.type='sine'; o2.type='sine';
    o1.frequency.value=midiToHz(m); o2.frequency.value=midiToHz(m)*2;
    const g=ACTX.createGain(); const end=envGain(g,when,0.05,0.5,0.85,Math.max(0.05,dur-0.45),0.35,vel*0.55);
    o1.connect(g); o2.connect(g); g.connect(BUS[bus].g); o1.start(when); o2.start(when); o1.stop(end); o2.stop(end); scheduled.push({o:[o1,o2],g,end}); },
  bass:(bus,m,when,dur,vel,depth=1)=>{ const o=ACTX.createOscillator(); o.type='triangle'; o.frequency.value=midiToHz(m);
    const g=ACTX.createGain(); const end=envGain(g,when,0.01,0.3,0.5,Math.max(0.05,dur-0.25),0.25,vel*0.65*depth);
    o.connect(g); g.connect(BUS[bus].g); o.start(when); o.stop(end); scheduled.push({o:[o],g,end}); },
  // Perc
  k:(t,v)=>{ const o=ACTX.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(130,t); o.frequency.exponentialRampToValueAtTime(40,t+0.12); const g=ACTX.createGain(); g.gain.setValueAtTime(v*0.6,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18); o.connect(g); g.connect(BUS.perc.g); o.start(t); o.stop(t+0.2); },
  s:(t,v)=>{ const s=ACTX.createBufferSource(); const b=ACTX.createBuffer(1,ACTX.sampleRate*0.2,ACTX.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; s.buffer=b; const f=ACTX.createBiquadFilter(); f.type='highpass'; f.frequency.value=1800; const g=ACTX.createGain(); g.gain.setValueAtTime(v*0.35,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.2); s.connect(f); f.connect(g); g.connect(BUS.perc.g); s.start(t); s.stop(t+0.2); },
  h:(t,v)=>{ const s=ACTX.createBufferSource(); const b=ACTX.createBuffer(1,ACTX.sampleRate*0.08,ACTX.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; s.buffer=b; const f=ACTX.createBiquadFilter(); f.type='highpass'; f.frequency.value=5000; const g=ACTX.createGain(); g.gain.setValueAtTime(v*0.18,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.08); s.connect(f); s.connect(g); g.connect(BUS.perc.g); s.start(t); s.stop(t+0.08); }
};
function initBuses(){ ORCH_MASTER.forEach((k,i)=>{ BUS[k]=BUS[k]||makeBus(k==='perc'?0.7:0.7,(i%2?0.08:-0.08)); }); if(!BUS.perc) BUS.perc = makeBus(0.7, 0); }

/* ========= WAV render (export) ‚Äî UPDATED CLAMP ========= */
async function renderWav(score){
  await unlockAudio();
  const sr=44100;
  const len = Math.min(MAX_PLAY_SECONDS, (score && score.seconds) ? score.seconds : MAX_PLAY_SECONDS) + 2; // tail
  const ctx=new OfflineAudioContext(2, Math.ceil(len*sr), sr);
  const master=ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination);
  const B={}; ORCH_MASTER.forEach(n=>{ const g=ctx.createGain(); g.gain.value=0.8; g.connect(master); B[n]={g}; });
  function hz(m){ return 440*Math.pow(2,(m-69)/12); }
  function ev(g,t0,a,d,s,hold,rel,amp){ const t1=t0+a,t2=t1+d,t3=t2+hold,t4=t3+rel; g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(amp,t1); g.gain.linearRampToValueAtTime(amp*s,t2); g.gain.setValueAtTime(amp*s,t3); g.gain.linearRampToValueAtTime(0,t4); }
  function osc(type,f){ const o=ctx.createOscillator(); o.type=type; o.frequency.value=f; return o; }
  function add(inst,type,m,when,dur,vel){
    if(type==='bowed' || type==='reed'){ const o=osc(type==='reed'?'square':'sawtooth',hz(m)),f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value= type==='reed'?2400:2200; const g=ctx.createGain(); ev(g,when, type==='reed'?0.03:0.04, type==='reed'?0.22:0.45, type==='reed'?0.55:0.8,Math.max(0.05,dur-(type==='reed'?0.25:0.4)), type==='reed'?0.2:0.3, vel*0.55); o.connect(f); f.connect(g); g.connect(B[inst].g); o.start(when); o.stop(when+dur+0.6); }
    else if(type==='brass'){ const o=osc('sawtooth',hz(m)),f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1800; const g=ctx.createGain(); ev(g,when,0.02,0.25,0.6,Math.max(0.05,dur-0.3),0.25,vel*0.55); o.connect(f); f.connect(g); g.connect(B[inst].g); o.start(when); o.stop(when+0.4+dur); }
    else if(type==='pluck'){ const o=osc('triangle',hz(m)); const g=ctx.createGain(); ev(g,when,0.002,0.22,0.35,0.01,0.4,vel*0.6); o.connect(g); g.connect(B[inst].g); o.start(when); o.stop(when+0.5); }
    else if(type==='bell'){ const o=osc('sine',hz(m)); const g=ctx.createGain(); ev(g,when,0.002,0.6,0.3,0.02,1.2,vel*0.6); o.connect(g); g.connect(B[inst].g); o.start(when); o.stop(when+1.1); }
    else if(type==='organ'){ const o1=osc('sine',hz(m)),o2=osc('sine',hz(m)*2); const g=ctx.createGain(); ev(g,when,0.05,0.5,0.85,Math.max(0.05,dur-0.45),0.35,vel*0.55); o1.connect(g); o2.connect(g); g.connect(B[inst].g); o1.start(when); o2.start(when); o1.stop(when+0.6); o2.stop(when+0.6); }
    else if(type==='bass'){ const o=osc('triangle',hz(m)); const g=ctx.createGain(); ev(g,when,0.01,0.3,0.5,Math.max(0.05,dur-0.25),0.25,vel*0.65*(+$('bassDepth').value)); o.connect(g); g.connect(B[inst].g); o.start(when); o.stop(when+0.35); }
  }
  score.events.forEach(e=> add(e.inst,e.type,e.midi, e.time+0.05, e.dur, e.vel));
  const buf=await ctx.startRendering();
  // WAV packing
  function interleave(L,R){ const out=new Float32Array(L.length+R.length); for(let i=0,j=0;i<L.length;i++,j+=2){ out[j]=L[i]; out[j+1]=R[i]; } return out; }
  function f32To16(view,off,data){ for(let i=0;i<data.length;i++,off+=2){ let s=Math.max(-1,Math.min(1,data[i])); s=s<0?s*0x8000:s*0x7FFF; view.setInt16(off,s,true);} }
  function w(view,off,str){ for(let i=0;i<str.length;i++) view.setUint8(off+i,str.charCodeAt(i)); }
  const L=buf.getChannelData(0), R=buf.getChannelData(1), inter=interleave(L,R);
  const ab=new ArrayBuffer(44+inter.length*2), dv=new DataView(ab);
  w(dv,0,'RIFF'); dv.setUint32(4,36+inter.length*2,true); w(dv,8,'WAVE'); w(dv,12,'fmt '); dv.setUint32(16,16,true);
  dv.setUint16(20,1,true); dv.setUint16(22,2,true); dv.setUint32(24,buf.sampleRate,true); dv.setUint32(28,buf.sampleRate*4,true);
  dv.setUint16(32,4,true); dv.setUint16(34,16,true); w(dv,36,'data'); dv.setUint32(40,inter.length*2,true);
  f32To16(dv,44,inter);
  return new Blob([dv],{type:'audio/wav'});
}
function downloadWavBlob(blob, filename='CST_LIVE_Symphony.wav'){
  try{
    const navAny = /** @type {any} */ (navigator);
    if (navAny && typeof navAny.msSaveOrOpenBlob === 'function'){
      navAny.msSaveOrOpenBlob(blob, filename);
      return;
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    a.style.display = 'none';
    document.body.appendChild(a);
    requestAnimationFrame(()=>{
      a.click();
      setTimeout(()=>{
        try{ document.body.removeChild(a); }catch(e){}
        try{ URL.revokeObjectURL(url); }catch(e){}
      }, 2000);
    });
  }catch(err){
    console.error('downloadWavBlob error:', err);
    setMsg('Could not start download. Try again after Analyze/LIVE.', 'warn');
  }
}

/* ========= Printing ========= */
function midiToName(n){
  const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const pitch=((n%12)+12)%12, oct=Math.floor(n/12)-1;
  return names[pitch]+oct;
}
function printScore(score){
  if(!score || !score.events || !score.events.length){ setMsg('Nothing to print ‚Äî generate first.','warn'); return; }
  const nowCST = new Intl.DateTimeFormat('en-US',{timeZone:'America/Chicago',dateStyle:'medium',timeStyle:'medium'}).format(new Date());
  const w=window.open('','_blank','width=1000,height=800');
  const rows = score.events.slice().sort((a,b)=>a.time-b.time)
    .map(e=>`<tr><td>${e.time.toFixed(2)}s</td><td>${labelOf(ORCH.find(x=>x.name===e.inst)||{name:e.inst})}</td><td>${e.inst}</td><td>${midiToName(e.midi)} (${e.midi})</td><td>${e.dur.toFixed(2)}s</td><td>${e.vel.toFixed(2)}</td></tr>`).join('');
  w.document.write(`
    <html><head><title>60s Notes ‚Äî CST LIVE Symphony</title>
      <style>
        body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:20px}
        h1{margin:0 0 6px}
        .meta{color:#555;margin-bottom:12px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #bbb;padding:6px 8px;text-align:left;font-size:13px}
        th{background:#eee}
      </style>
    </head><body>
      <h1>Generated Notes (60 seconds)</h1>
      <div class="meta">BPM: ${score.bpm} ‚Ä¢ Length: ${score.seconds.toFixed(1)}s ‚Ä¢ Printed (CST): ${nowCST}</div>
      <table>
        <thead><tr><th>Time</th><th>Instrument</th><th>ID</th><th>Pitch</th><th>Duration</th><th>Velocity</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <script>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}
</script>
<script>
/* ========= UI state ========= */
let ANALYSIS = {bpm:null,seconds:null,beats:[],energy:[]}, SCORE=null;

/* Values live UI */
function updateVals(){
  const id = (x)=>$(x);
  if(id('swingVal')) id('swingVal').textContent=(+id('swing').value).toFixed(2);
  if(id('dotTriVal')) id('dotTriVal').textContent=(+id('dotTri').value).toFixed(2);
  if(id('vminVal')) id('vminVal').textContent=id('vmin').value;
  if(id('vmaxVal')) id('vmaxVal').textContent=id('vmax').value;
  if(id('vb')) id('vb').textContent=`${id('vmin').value}‚Äì${id('vmax').value}`;
  if(id('bassDepthVal')) id('bassDepthVal').textContent=(+id('bassDepth').value).toFixed(2);
  if(id('emoIntVal')) id('emoIntVal').textContent=(+id('emoInt').value).toFixed(2);
  if(id('toneBiasVal')) id('toneBiasVal').textContent=(+id('toneBias').value).toFixed(1);
  if(id('percAmtVal')) id('percAmtVal').textContent=(+id('percAmt').value).toFixed(2);
}
['swing','dotTri','vmin','vmax','bassDepth','emoInt','toneBias','percAmt'].forEach(id=>{
  const el=$(id); if(el) el.addEventListener('input',()=>{ updateVals(); setMsg('Settings changed ‚Äî press LIVE or Generate to apply.'); });
});
if($('cadence')) $('cadence').addEventListener('change',()=>{
  const isC=$('cadence').value==='custom'; $('cadenceCustom').disabled=!isC;
  $('cadOut').textContent=isC?'Custom':$('cadence').value.replace(/_/g,' ').replace(/-/g,'‚Äì');
  setMsg('Cadence changed ‚Äî press LIVE or Generate to apply.');
});
if($('cadenceCustom')) $('cadenceCustom').addEventListener('input',()=>{ if($('cadence').value==='custom'){ $('cadOut').textContent='Custom'; setMsg('Custom cadence updated ‚Äî press LIVE or Generate.'); } });
if($('emotion')) $('emotion').addEventListener('change',()=>{ $('emoOut').textContent=$('emotion').value.replace(/\b\w/g,m=>m.toUpperCase()); setMsg('Emotion changed ‚Äî press LIVE or Generate.'); });

/* Build Composer dropdowns and enforce two-not-same */
function buildComposerDropdowns(){
  const a=$('compA'), b=$('compB');
  a.innerHTML=''; b.innerHTML='';
  COMPOSERS.forEach(name=>{
    const o1=document.createElement('option'); o1.value=name; o1.textContent=name; a.appendChild(o1);
    const o2=document.createElement('option'); o2.value=name; o2.textContent=name; b.appendChild(o2);
  });
  a.value = a.value || 'Mozart';
  b.value = (b.value && b.value!==a.value)? b.value : 'Beethoven';
  if(a.value===b.value){
    const alt = COMPOSERS.find(n=>n!==a.value) || 'Beethoven';
    b.value = alt;
  }
}
function updateMixOut(){
  const A=$('compA').value, B=$('compB').value, aP=+$('compMixA').value|0, bP=100-aP;
  $('compMixAVal').textContent=aP; $('compMixBVal').textContent=bP;
  $('mixOut').textContent = `${A} ${aP}% ‚Ä¢ ${B} ${bP}%`;
}
['compA','compB'].forEach(id=>{
  document.addEventListener('change', (e)=>{ if(e.target && e.target.id===id){
    const A=$('compA').value, B=$('compB').value;
    if(A===B){
      const list = COMPOSERS.filter(n=>n!==A);
      if(id==='compA') $('compB').value = list[0] || 'Beethoven';
      else $('compA').value = list[0] || 'Mozart';
    }
    updateMixOut();
    setMsg('Composer mix changed ‚Äî press LIVE or Generate.');
  }});
});
if($('compMixA')) $('compMixA').addEventListener('input',()=>{ updateMixOut(); setMsg('Composer mix changed ‚Äî press LIVE or Generate.'); });

if($('swapAB')) $('swapAB').addEventListener('click', ()=>{
  const A=$('compA').value, B=$('compB').value;
  $('compA').value=B; $('compB').value=A;
  updateMixOut(); setMsg('Swapped A and B ‚Äî press LIVE or Generate.');
});
if($('resetAB')) $('resetAB').addEventListener('click', ()=>{
  $('compA').value='Mozart';
  $('compB').value='Beethoven';
  $('compMixA').value=50;
  updateMixOut(); setMsg('Reset to Mozart/Beethoven 50/50 ‚Äî press LIVE or Generate.');
});

if($('pace')) $('pace').addEventListener('change',()=> setMsg('Pace changed ‚Äî press LIVE or Generate.'));
if($('movement')) $('movement').addEventListener('change',()=> setMsg('Movement changed ‚Äî press LIVE or Generate.'));
if($('tempoFactor')) $('tempoFactor').addEventListener('change',()=> setMsg('Tempo factor changed ‚Äî press LIVE or Generate.'));
if($('allOn')) $('allOn').addEventListener('click',()=>{ selectAll(true); });
if($('allOff')) $('allOff').addEventListener('click',()=>{ selectAll(false); });
if($('saveSel')) $('saveSel').addEventListener('click', saveAllSelections);

/* Analyze */
if($('analyze')) $('analyze').addEventListener('click', async ()=>{
  clearMsg(); setLiveOn(false); stopAll(); stopLine();
  const f=$('file')?.files?.[0];
  if(!f){ setMsg('Please choose an audio file first.','warn'); return; }
  $('live')?.setAttribute('disabled','disabled'); $('live').textContent='LIVE ‚Äî WAIT (Analyzing...)';

  try{
    await unlockAudio(); initBuses();
    randomize20(); // fresh 20 instruments

    const buf = await decodeFileToBuffer(f); SOURCEBUF=buf;
    const mono = monoMixFirstMinute(buf);
    const sr = buf.sampleRate;

    const {env,hop} = await energyEnvelopeAsync(mono,2048,1024,(p)=>{ setMsg(`Analyzing‚Ä¶ ${Math.round(p*100)}%`); });
    const bpm = autocorrTempo(env,sr,hop);
    const beats = peakPickBeats(env,sr,hop,bpm,MAX_ANALYZE_SECONDS);
    const seconds = Math.min(MAX_ANALYZE_SECONDS, buf.duration);
    const fps=sr/hop;
    const beatEnergy = beats.map(t=>{ const idx=Math.max(0,Math.min(env.length-1, Math.round(t*fps))); return env[idx]; });
    const maxE = beatEnergy.reduce((a,b)=>Math.max(a,b),0.0001);
    const E = beatEnergy.map(x=> clamp(x/maxE,0,1));
    ANALYSIS={bpm:Math.round(bpm),seconds,beats,energy:E};
    $('bpm').textContent = Math.round(bpm);
    $('len').textContent = seconds.toFixed(1)+' s';
    setMsg(seconds<buf.duration?'Using first 60 seconds. Analysis complete ‚Äî press LIVE or Generate (Hybrid).':'Analysis complete ‚Äî press LIVE or Generate (Hybrid).');
    $('live')?.removeAttribute('disabled');
  }catch(err){ console.error(err); setMsg('Analyze failed. Try another file.','warn'); }
  finally{ $('live').textContent='LIVE ‚Äî PLAY'; }
});

/* Generate helpers */
function defaultBpm(){
  const pace = $('pace').value, mv=$('movement').value;
  let bpm = (pace==='calm'? 92 : pace==='urgent'? 138 : 110);
  if(mv==='II') bpm -= 12; if(mv==='IV') bpm += 8;
  return clamp(bpm, 60, 180);
}
function cadenceListFromUI(){
  let cadName=$('cadence').value||'I-IV-V-I';
  if(!cadName || cadName==='random') cadName = ['I-IV-V-I','I-vi-IV-V','ii-V-I','I-V-vi-IV','authentic','plagal','half','deceptive'][Math.floor(Math.random()*8)];
  if(cadName!=='custom') $('cadence').value=cadName;
  const cadCustom=$('cadenceCustom').value.trim()||'';
  const cadenceSeq=cadenceList(cadName, cadCustom);
  $('cadOut').textContent=(cadName==='custom'?(cadCustom||'Custom'):cadName).replace(/_/g,' ').replace(/-/g,'‚Äì');
  return cadenceSeq;
}
function buildParamsFromUI(base){
  return {
    bpm: base.bpm,
    totalSecs: base.seconds,
    energyArr: base.energy,
    cadenceNames: cadenceListFromUI(),
    swingBase:+$('swing').value,
    dotTri:+$('dotTri').value,
    vmin:+$('vmin').value,
    vmax:+$('vmax').value,
    bassDepth:+$('bassDepth').value,
    modes: pickEquationModes(),
    emotionKind: $('emotion').value,
    emoIntensity: +$('emoInt').value,
    toneBias: +$('toneBias').value,
    percAmt: +$('percAmt').value,
    pace: $('pace').value,
    movement: $('movement').value,
    tempoFactor: $('tempoFactor').value,
    eqApproach: 'focus',
    compA: $('compA').value || 'Mozart',
    compB: $('compB').value || 'Beethoven',
    mixA: (+$('compMixA').value || 50)/100
  };
}
function updateWillPlayListFromSelection(){
  const box=$('willPlay'); if(!box) return;
  const allowed = ORCH.filter(i=>INST_SELECTION[i.name]).map(i=> labelOf(i));
  box.innerHTML = allowed.map(n=>`<div>${n}</div>`).join('');
}

/* Generate (Compose) */
if($('genCompose')) $('genCompose').addEventListener('click', ()=>{
  saveAllSelections();
  const bpm = defaultBpm();
  const seconds = 60;
  const beats = Math.floor(seconds/(60/bpm));
  const energy = Array.from({length:beats}, ()=>0.5);
  const params = buildParamsFromUI({bpm, seconds, energy});
  SCORE = generateScore(params);
  if(!SCORE.events.length){ setMsg('No playable events (maybe no instruments selected).','warn'); return; }
  drawTimeline(SCORE);
  updateWillPlayListFromSelection();
  setMsg('Generated (Compose). Press LIVE ‚Äî PLAY to listen, or üñ®Ô∏è Print Notes.');
});

/* Generate (Hybrid) */
if($('genHybrid')) $('genHybrid').addEventListener('click', ()=>{
  saveAllSelections();
  if(!ANALYSIS.bpm){ setMsg('Analyze an audio file first, then Generate (Hybrid).','warn'); return; }
  const params = buildParamsFromUI({bpm:ANALYSIS.bpm, seconds:ANALYSIS.seconds, energy:ANALYSIS.energy});
  SCORE = generateScore(params);
  if(!SCORE.events.length){ setMsg('No playable events (maybe no instruments selected).','warn'); return; }
  drawTimeline(SCORE);
  updateWillPlayListFromSelection();
  setMsg('Generated (Hybrid). Press LIVE ‚Äî PLAY to listen, or üñ®Ô∏è Print Notes.');
});

/* Live play ‚Äî ‚úÖ clamp score.seconds and line to 60 */
function playScore(score){
  if(playing) return;
  // clamp at play time
  if (score && typeof score.seconds === 'number') score.seconds = Math.min(score.seconds, MAX_PLAY_SECONDS);

  const start=ACTX.currentTime+0.2; playing=true; setLiveOn(true);
  startLine(Math.min(MAX_PLAY_SECONDS, score.seconds)); scheduled.length=0;
  if(playTimer){ clearTimeout(playTimer); }
  playTimer=setTimeout(()=>{ stopAll(); }, Math.max(0, (score.seconds*1000)+120));
  score.events.forEach(ev=>{
    const w = start + ev.time;
    const t=ev.type;
    if(t==='bowed') PATCH.bowed(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='reed') PATCH.reed(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='brass') PATCH.brass(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='pluck') PATCH.pluck(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='bell') PATCH.bell(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='organ') PATCH.organ(ev.inst, ev.midi, w, ev.dur, ev.vel);
    else if(t==='bass') PATCH.bass(ev.inst, ev.midi, w, ev.dur, ev.vel, +$('bassDepth').value);
    else PATCH.bowed(ev.inst, ev.midi, w, ev.dur, ev.vel);
  });
}

/* Buttons: LIVE / Stop / Reset */
if($('live')) $('live').addEventListener('click', async ()=>{
  if($('live').hasAttribute('disabled')) return;
  await unlockAudio(); initBuses();
  if(!SCORE){
    if(!ANALYSIS.bpm){ setMsg('Analyze first (or use Generate).','warn'); return; }
    const params = buildParamsFromUI({bpm:ANALYSIS.bpm, seconds:ANALYSIS.seconds, energy:ANALYSIS.energy});
    SCORE = generateScore(params);
  }
  if(!SCORE || !SCORE.events.length){ setMsg('Nothing to play. Use Generate first.','warn'); return; }
  drawTimeline(SCORE);
  updateWillPlayListFromSelection();
  playScore(SCORE);
  clearMsg();
});
if($('stop')) $('stop').addEventListener('click', ()=>{ stopAll(); clearMsg(); });
if($('reset')) $('reset').addEventListener('click', ()=>{
  stopAll(); SCORE=null; SOURCEBUF=null; ANALYSIS={bpm:null,seconds:null,beats:[],energy:[]};
  if($('file')) $('file').value="";
  $('bpm').textContent='‚Äì'; $('len').textContent='‚Äì';
  $('live').setAttribute('disabled','disabled'); $('live').textContent='LIVE ‚Äî PLAY'; setLiveOn(false);
  randomize20();
  $('cadence').value='random'; $('cadenceCustom').value=''; $('cadenceCustom').disabled=true;
  $('compA').value='Mozart'; $('compB').value='Beethoven'; $('compMixA').value=50; updateMixOut();
  clearMsg(); drawLine(0); updateWillPlayListFromSelection();
  if(CTX && TLM){ const dpr=window.devicePixelRatio||1; TLM.width=TLM.clientWidth*dpr; TLM.height=TLM.clientHeight*dpr; CTX.clearRect(0,0,TLM.width,TLM.height); }
});

/* Export / Print */
if($('export')) $('export').addEventListener('click', async ()=>{
  if(!SCORE){ setMsg('Nothing to export. Generate then LIVE first.','warn'); return; }
  try{
    setMsg('Rendering WAV‚Ä¶ your browser will start a download when it‚Äôs ready.');
    const blob=await renderWav(SCORE);
    const bpmSafe = (SCORE?.bpm ? `${SCORE.bpm}` : (ANALYSIS?.bpm?`${ANALYSIS.bpm}`:'UNK'));
    downloadWavBlob(blob, `CST_LIVE_Symphony_${bpmSafe}BPM_1min.wav`);
  }catch(err){
    console.error('Export failed:', err);
    setMsg('Export failed. Try Analyze/Generate ‚Üí LIVE, then export again.','warn');
  }
});
if($('printNotes')) $('printNotes').addEventListener('click', ()=> printScore(SCORE));

/* ========= Init ========= */
window.addEventListener('pointerdown', unlockAudio, {once:true});
function firstVals(){ 
  $('live').setAttribute('disabled','disabled');
  ['swing','dotTri','vmin','vmax','bassDepth','emoInt','toneBias','percAmt'].forEach(id=>{ const el=$(id); if(el && el.value==null) el.value = el.getAttribute('value'); });
  (function update(){ 
    try{
      $('swingVal').textContent=(+$('swing').value).toFixed(2);
      $('dotTriVal').textContent=(+$('dotTri').value).toFixed(2);
      $('vminVal').textContent=$('vmin').value; $('vmaxVal').textContent=$('vmax').value;
      $('vb').textContent=`${$('vmin').value}‚Äì${$('vmax').value}`;
      $('bassDepthVal').textContent=(+$('bassDepth').value).toFixed(2);
      $('emoIntVal').textContent=(+$('emoInt').value).toFixed(2);
      $('toneBiasVal').textContent=(+$('toneBias').value).toFixed(1);
      $('percAmtVal').textContent=(+$('percAmt').value).toFixed(2);
    }catch(e){}
  })();
}
ensureAudio(); initBuses();
buildComposerDropdowns();
loadAllSelections();
updateMixOut();
buildInstList();
firstVals();
updateWillPlayListFromSelection();

/* resume audio on visibility */
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') unlockAudio(); });
</script>
</body>
</html>
