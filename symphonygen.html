<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI Orchestral Mixer — Preset Tokens (Classic Order)</title>
<meta name="description" content="One-minute classic-order orchestral mixer. Pick instruments and tick preset note tokens (no randomness). 3-column section mixer, beat upload or metronome."/>
<style>
  :root{
    --bg:#081022; --panel:#0f1636; --ink:#e9f1ff; --muted:#9fb2e4; --grid:#1a2658; --btn:#1b2a6b;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#6ee7ff; --accent:#93c5fd;
    --str:#8bc6ff; --ww:#b8ffda; --br:#ffd599; --pc:#ff9aa2; --pn:#d0b3ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  h1{font-size:26px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 8px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:16px}

  .row{display:grid;grid-template-columns:2.2fr 1.3fr;gap:14px}
  @media(max-width:1120px){.row{grid-template-columns:1fr}}

  .panel{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:16px}
  .controls{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:12px;margin:10px 0}
  .btn{background:var(--btn);border:1px solid var(--grid);color:var(--ink);border-radius:12px;padding:14px 16px;font-weight:800;font-size:16px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#173076}
  .btn.warn{background:#4d2f03;border-color:#7a4b07}
  input[type="file"]{
    background:#0b1432;border:1px solid var(--grid);color:var(--ink);border-radius:10px;padding:12px 12px;font-size:15px;width:100%
  }
  label{font-size:13px;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{border:1px solid var(--grid);border-radius:999px;padding:6px 12px;font-size:12px;display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.str{background:var(--str)} .dot.ww{background:var(--ww)} .dot.br{background:var(--br)} .dot.pc{background:var(--pc)} .dot.pn{background:var(--pn)}

  .timeline{height:120px;background:#0b1432;border:1px solid var(--grid);border-radius:12px;position:relative;margin-top:12px;overflow:hidden}
  .gridline{position:absolute;top:0;bottom:0;width:1px;background:#1a2658}
  .marker{position:absolute;top:0;bottom:0;width:4px;background:var(--line);box-shadow:0 0 14px var(--line)}
  .label{position:absolute;top:8px;font-size:11px;color:var(--muted)}
  .band{position:absolute;top:0;bottom:0;opacity:.16}
  .band.str{background:var(--str)} .band.ww{background:var(--ww)} .band.br{background:var(--br)} .band.pc{background:var(--pc)} .band.pn{background:var(--pn)}

  .status{display:flex;gap:14px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .lamp{width:14px;height:14px;border-radius:50%;background:#394b7a;box-shadow:0 0 0 0 transparent}
  .lamp.on{background:var(--ok);box-shadow:0 0 10px var(--ok)}

  /* Section Mixer: 3 columns */
  .meters{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:10px}
  .chan{background:#0b1432;border:1px solid var(--grid);border-radius:12px;padding:12px}
  .chan h3{margin:0 0 6px;font-size:15px}
  .tag{font-size:11px;border-radius:999px;padding:2px 8px;display:inline-block;margin-left:6px;vertical-align:1px;border:1px solid var(--grid);color:var(--muted)}
  .volrow{display:flex;gap:10px;align-items:center}
  .volrow input[type="range"]{width:100%}
  .muterow{display:flex;gap:10px;margin-top:8px}
  .muterow .btn{padding:10px 12px;font-size:14px}

  /* Preset Instrument Picker */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:1120px){.grid2{grid-template-columns:1fr}}
  .ilist{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .igroup{border:1px solid var(--grid);border-radius:10px;padding:10px}
  .igroup h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
  .irow{display:flex;align-items:center;gap:8px;margin:4px 0}
  .irow input{transform:scale(1.25)}
  .tokens{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .token{display:flex;align-items:center;gap:6px;border:1px solid var(--grid);border-radius:999px;padding:6px 10px;font-size:12px}
  .token input{transform:scale(1.15)}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Orchestral Mixer — Classic Order</h1>
  <div class="sub">Pick instruments and tick preset note tokens. It plays immediately. Classic entrances: <b>Strings 0s</b> → <b>Woodwinds 10s</b> → <b>Brass 20s</b> → <b>Percussion 35s</b> → <b>Keyboard/Harp 45s</b>.</div>

  <div class="row">
    <!-- LEFT: Transport + Timeline -->
    <div class="panel">
      <h2>Transport</h2>
      <div class="controls">
        <button id="btnPlay" class="btn">PLAY</button>
        <button id="btnStop" class="btn" disabled>STOP</button>
        <button id="btnReset" class="btn secondary">RESET</button>
        <input id="fileBeat" type="file" accept="audio/*" title="Upload a looped beat (WAV/MP3)"/>
        <button id="btnMetronome" class="btn">Use Metronome</button>
        <button id="btnLoop" class="btn" title="Loop after 60s">Loop Off</button>
      </div>
      <div class="small">Tip: upload your beat (e.g., <i>notesbeat.wav</i>). If none, press <b>Use Metronome</b> (120 BPM).</div>

      <div class="legend">
        <span class="pill"><span class="dot str"></span>Strings @ 0s</span>
        <span class="pill"><span class="dot ww"></span>Woodwinds @ 10s</span>
        <span class="pill"><span class="dot br"></span>Brass @ 20s</span>
        <span class="pill"><span class="dot pc"></span>Percussion @ 35s</span>
        <span class="pill"><span class="dot pn"></span>Keyboard/Harp @ 45s</span>
      </div>

      <div class="timeline" id="timeline">
        <div class="marker" id="playhead" style="left:0%"></div>
      </div>

      <div class="status">
        <div class="lamp" id="lampAudio"></div><span class="small">Audio Engine</span>
        <div class="lamp" id="lampBeat"></div><span class="small">Beat Loaded</span>
        <div class="lamp" id="lampPlaying"></div><span class="small">Playing</span>
        <span class="small" id="txtTime">t = 0.0s</span>
        <span class="small" id="txtMsg"></span>
      </div>
    </div>

    <!-- RIGHT: Section Mixer (3 columns) -->
    <div class="panel">
      <h2>Section Mixer</h2>
      <div class="meters">
        <div class="chan">
          <h3>Strings <span class="tag">0–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volStrings" type="range" min="0" max="1" step="0.01" value="0.9"/></div>
          <div class="muterow">
            <button id="muteStrings" class="btn">Mute</button>
            <button id="soloStrings" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Woodwinds <span class="tag">10–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volWoodwinds" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
          <div class="muterow">
            <button id="muteWoodwinds" class="btn">Mute</button>
            <button id="soloWoodwinds" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Brass <span class="tag">20–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volBrass" type="range" min="0" max="1" step="0.01" value="0.8"/></div>
          <div class="muterow">
            <button id="muteBrass" class="btn">Mute</button>
            <button id="soloBrass" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Percussion <span class="tag">35–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volPerc" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
          <div class="muterow">
            <button id="mutePerc" class="btn">Mute</button>
            <button id="soloPerc" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Keyboard/Harp <span class="tag">45–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volPiano" type="range" min="0" max="1" step="0.01" value="0.8"/></div>
          <div class="muterow">
            <button id="mutePiano" class="btn">Mute</button>
            <button id="soloPiano" class="btn">Solo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRESET INSTRUMENT PICKER -->
  <div class="panel" style="margin-top:14px">
    <h2>Pick Instruments & Tick Note Tokens (plays immediately)</h2>
    <div class="grid2">
      <!-- Instrument list (check to add/remove) -->
      <div>
        <label>Choose instrument(s):</label>
        <div class="ilist" id="ilist">
          <div class="igroup">
            <h4>Strings</h4>
            <div class="irow"><input type="checkbox" value="Violin I"> <span>Violin I</span></div>
            <div class="irow"><input type="checkbox" value="Violin II"> <span>Violin II</span></div>
            <div class="irow"><input type="checkbox" value="Viola"> <span>Viola</span></div>
            <div class="irow"><input type="checkbox" value="Cello"> <span>Cello</span></div>
            <div class="irow"><input type="checkbox" value="Double Bass"> <span>Double Bass</span></div>
            <div class="irow"><input type="checkbox" value="Harp"> <span>Harp</span></div>
          </div>

          <div class="igroup">
            <h4>Woodwinds</h4>
            <div class="irow"><input type="checkbox" value="Flute"> <span>Flute</span></div>
            <div class="irow"><input type="checkbox" value="Piccolo"> <span>Piccolo</span></div>
            <div class="irow"><input type="checkbox" value="Oboe"> <span>Oboe</span></div>
            <div class="irow"><input type="checkbox" value="English Horn"> <span>English Horn</span></div>
            <div class="irow"><input type="checkbox" value="Clarinet"> <span>Clarinet</span></div>
            <div class="irow"><input type="checkbox" value="Bass Clarinet"> <span>Bass Clarinet</span></div>
            <div class="irow"><input type="checkbox" value="Bassoon"> <span>Bassoon</span></div>
            <div class="irow"><input type="checkbox" value="Contrabassoon"> <span>Contrabassoon</span></div>
            <div class="irow"><input type="checkbox" value="Saxophone"> <span>Saxophone</span></div>
          </div>

          <div class="igroup">
            <h4>Brass</h4>
            <div class="irow"><input type="checkbox" value="Horn"> <span>French Horn</span></div>
            <div class="irow"><input type="checkbox" value="Trumpet"> <span>Trumpet</span></div>
            <div class="irow"><input type="checkbox" value="Trombone"> <span>Trombone</span></div>
            <div class="irow"><input type="checkbox" value="Bass Trombone"> <span>Bass Trombone</span></div>
            <div class="irow"><input type="checkbox" value="Tuba"> <span>Tuba</span></div>
            <div class="irow"><input type="checkbox" value="Euphonium"> <span>Euphonium</span></div>
            <div class="irow"><input type="checkbox" value="Wagner Tuba"> <span>Wagner Tuba</span></div>
          </div>

          <div class="igroup">
            <h4>Percussion</h4>
            <div class="irow"><input type="checkbox" value="Kick"> <span>Kick (K)</span></div>
            <div class="irow"><input type="checkbox" value="Snare"> <span>Snare (S)</span></div>
            <div class="irow"><input type="checkbox" value="Hi-hat"> <span>Hi-hat (H)</span></div>
            <div class="irow"><input type="checkbox" value="Timpani"> <span>Timpani</span></div>
            <div class="irow"><input type="checkbox" value="Cymbals"> <span>Cymbals</span></div>
            <div class="irow"><input type="checkbox" value="Triangle"> <span>Triangle</span></div>
            <div class="irow"><input type="checkbox" value="Glockenspiel"> <span>Glockenspiel</span></div>
            <div class="irow"><input type="checkbox" value="Xylophone"> <span>Xylophone</span></div>
            <div class="irow"><input type="checkbox" value="Tambourine"> <span>Tambourine</span></div>
            <div class="irow"><input type="checkbox" value="Gong"> <span>Gong</span></div>
            <div class="irow"><input type="checkbox" value="Chimes"> <span>Chimes</span></div>
          </div>

          <div class="igroup">
            <h4>Keyboards / Organ</h4>
            <div class="irow"><input type="checkbox" value="Piano"> <span>Piano</span></div>
            <div class="irow"><input type="checkbox" value="Celesta"> <span>Celesta</span></div>
            <div class="irow"><input type="checkbox" value="Harpsichord"> <span>Harpsichord</span></div>
            <div class="irow"><input type="checkbox" value="Organ"> <span>Organ</span></div>
          </div>
        </div>
      </div>

      <!-- Token panel for the last instrument clicked -->
      <div>
        <label>Note tokens for <b id="tokInst">—</b> (tick to enable):</label>
        <div id="tokenArea" class="tokens"></div>
        <div class="small" style="margin-top:6px">
          Format: <b>NOTE:beatOffset:durBeats</b> (e.g., C4:0:1, E4:1:1, G4:2:2). Percussion uses <b>K,S,H</b> (Kick/Snare/Hi-hat) like <b>K:0:1</b>, <b>H:0.5:0.5</b>, <b>S:1:1</b>.
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  const DURATION = 60;
  const CLASSIC_ORDER = [
    { key:'strings',   start: 0,  color:'var(--str)'},
    { key:'woodwinds', start:10,  color:'var(--ww)'},
    { key:'brass',     start:20,  color:'var(--br)'},
    { key:'perc',      start:35,  color:'var(--pc)'},
    { key:'piano',     start:45,  color:'var(--pn)'},
  ];

  const SECTION_OF = {
    // Strings
    "Violin I":"strings","Violin II":"strings","Viola":"strings","Cello":"strings","Double Bass":"strings","Harp":"piano",
    // Woodwinds
    "Flute":"woodwinds","Piccolo":"woodwinds","Oboe":"woodwinds","English Horn":"woodwinds",
    "Clarinet":"woodwinds","Bass Clarinet":"woodwinds","Bassoon":"woodwinds","Contrabassoon":"woodwinds","Saxophone":"woodwinds",
    // Brass
    "Horn":"brass","Trumpet":"brass","Trombone":"brass","Bass Trombone":"brass","Tuba":"brass","Euphonium":"brass","Wagner Tuba":"brass",
    // Perc
    "Kick":"perc","Snare":"perc","Hi-hat":"perc","Timpani":"perc","Cymbals":"perc","Triangle":"perc","Glockenspiel":"perc","Xylophone":"perc","Tambourine":"perc","Gong":"perc","Chimes":"perc",
    // Keys / Organ
    "Piano":"piano","Celesta":"piano","Harpsichord":"piano","Organ":"piano"
  };

  /* --------- STATE --------- */
  let ctx = null, master = null;
  let startTime = 0;
  let isPlaying = false;
  let loopEnabled = false;

  // Beat
  let beatBuffer = null, beatGain = null, usingMetronome = false;

  // Section gains
  const channel = {
    strings:{gain:null, muted:false, solo:false},
    woodwinds:{gain:null, muted:false, solo:false},
    brass:{gain:null, muted:false, solo:false},
    perc:{gain:null, muted:false, solo:false},
    piano:{gain:null, muted:false, solo:false},
  };

  // patterns: {instrument, section, bpm, offsetSec, vol, notes:[{name,beat,dur,_freq|null}], id}
  const patterns = [];

  /* --------- ELEMENTS --------- */
  const lampAudio = document.getElementById('lampAudio');
  const lampBeat = document.getElementById('lampBeat');
  const lampPlaying = document.getElementById('lampPlaying');
  const txtTime = document.getElementById('txtTime');
  const txtMsg = document.getElementById('txtMsg');
  const playhead = document.getElementById('playhead');
  const timeline = document.getElementById('timeline');

  const btnPlay = document.getElementById('btnPlay');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnMetronome = document.getElementById('btnMetronome');
  const btnLoop = document.getElementById('btnLoop');
  const fileBeat = document.getElementById('fileBeat');

  const volEls = {
    strings: document.getElementById('volStrings'),
    woodwinds: document.getElementById('volWoodwinds'),
    brass: document.getElementById('volBrass'),
    perc: document.getElementById('volPerc'),
    piano: document.getElementById('volPiano'),
  };

  /* --------- AUDIO SETUP --------- */
  function ensureAudio() {
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 0.95;
    master.connect(ctx.destination);

    for (const k of Object.keys(channel)) {
      const g = ctx.createGain();
      g.gain.value = parseFloat(volEls[k].value);
      g.connect(master);
      channel[k].gain = g;
      volEls[k].addEventListener('input', applyGains);
    }

    beatGain = ctx.createGain();
    beatGain.gain.value = 0.9;
    beatGain.connect(master);

    lampAudio.classList.add('on');
  }

  function setTransportState(playing){
    isPlaying = playing;
    btnStop.disabled = !playing;
  }

  /* --------- BEAT LOADING --------- */
  fileBeat.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    ensureAudio();
    try {
      const arr = await file.arrayBuffer();
      beatBuffer = await ctx.decodeAudioData(arr);
      usingMetronome = false;
      lampBeat.classList.add('on');
      txtMsg.textContent = 'Beat loaded';
    } catch (err) {
      txtMsg.textContent = 'Could not decode audio';
      console.error(err);
    }
  });
  btnMetronome.onclick = () => {
    ensureAudio();
    beatBuffer = null; usingMetronome = true;
    lampBeat.classList.add('on');
    txtMsg.textContent = 'Metronome beat enabled (120 BPM)';
  };

  /* --------- TRANSPORT --------- */
  btnPlay.onclick = async () => {
    ensureAudio(); await ctx.resume();
    if (isPlaying) return;
    setTransportState(true); lampPlaying.classList.add('on'); txtMsg.textContent = 'Playing…';
    startTime = ctx.currentTime;
    scheduleOneMinute(startTime);
    window.__AIMIXER__.startUITimer();
  };
  btnStop.onclick = () => stopAll();
  btnReset.onclick = () => { stopAll({silent:true}); clearTimelineMarker(); txtTime.textContent='t = 0.0s'; txtMsg.textContent='Reset'; };
  btnLoop.onclick = () => { loopEnabled = !loopEnabled; btnLoop.textContent = loopEnabled ? 'Loop On' : 'Loop Off'; };

  /* --------- MUTE / SOLO --------- */
  const bindMuteSolo = (key, muteBtnId, soloBtnId) => {
    document.getElementById(muteBtnId).onclick = () => {
      channel[key].muted = !channel[key].muted;
      document.getElementById(muteBtnId).textContent = channel[key].muted ? 'Unmute' : 'Mute';
      applyGains();
    };
    document.getElementById(soloBtnId).onclick = () => {
      channel[key].solo = !channel[key].solo;
      document.getElementById(soloBtnId).textContent = channel[key].solo ? 'Unsolo' : 'Solo';
      applyGains();
    };
  };
  bindMuteSolo('strings','muteStrings','soloStrings');
  bindMuteSolo('woodwinds','muteWoodwinds','soloWoodwinds');
  bindMuteSolo('brass','muteBrass','soloBrass');
  bindMuteSolo('perc','mutePerc','soloPerc');
  bindMuteSolo('piano','mutePiano','soloPiano');

  function applyGains(){
    const anySolo = Object.values(channel).some(c => c.solo);
    for (const k of Object.keys(channel)) {
      const vol = parseFloat(volEls[k].value);
      const ch = channel[k];
      let target = vol;
      if (anySolo) target = ch.solo ? vol : 0.0;
      if (ch.muted) target = 0.0;
      ch.gain.gain.setTargetAtTime(target, ctx.currentTime, 0.01);
    }
  }

  /* --------- SCHEDULING --------- */
  function scheduleOneMinute(t0) {
    scheduleBeat(t0);
    scheduleUserPatterns(t0);

    const stopAt = t0 + DURATION;
    setTimeout(() => {
      if (!loopEnabled) {
        stopAll();
      } else {
        startTime = ctx.currentTime;
        scheduleOneMinute(startTime);
      }
    }, Math.max(0, (stopAt - ctx.currentTime) * 1000));
  }

  function scheduleBeat(t0){
    if (!ctx) return;
    if (beatBuffer) {
      const src = ctx.createBufferSource();
      src.buffer = beatBuffer; src.loop = true;
      src.connect(beatGain);
      src.start(t0); src.stop(t0 + DURATION + 0.05);
    } else if (usingMetronome) {
      const bpm = 120, spb = 60/bpm;
      for (let t = 0; t < DURATION; t += spb) metronomeTick(t0 + t);
    }
  }
  function metronomeTick(at){
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type='square'; o.frequency.value=2000;
    g.gain.value=0.0001; o.connect(g).connect(beatGain);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.3, at+0.001);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.05);
    o.start(at); o.stop(at+0.06);
  }

  function scheduleUserPatterns(t0){
    for (const p of patterns) {
      const sectionStart = CLASSIC_ORDER.find(x => x.key===p.section)?.start || 0;
      const base = t0 + sectionStart + p.offsetSec;
      const instGain = ctx.createGain();
      instGain.gain.value = p.vol;
      instGain.connect(channel[p.section].gain);

      const spb = 60 / p.bpm;
      for (const ev of p.notes) {
        const at = base + ev.beat * spb;
        const dur = Math.max(0.05, ev.dur) * spb;
        instGain._freq = ev._freq || 440;

        if (p.section === 'perc' && isPercName(p.instrument) && !isPitchedPerc(p.instrument)) {
          schedulePercOne(p.instrument, at, dur, instGain);
        } else {
          scheduleToneOne(p.instrument, at, dur, instGain);
        }
      }
    }
  }

  function isPercName(name){
    const n = name.toLowerCase();
    return n.includes('kick') || n.includes('snare') || n.includes('hat') || n.includes('timpani') || n.includes('cymb') || n.includes('triangle') || n.includes('glock') || n.includes('xylo') || n.includes('tamb') || n.includes('gong') || n.includes('chime');
  }
  function isPitchedPerc(name){
    const n = name.toLowerCase();
    return n.includes('timpani') || n.includes('glock') || n.includes('xylo') || n.includes('chimes');
  }

  // Tone synths by family
  function scheduleToneOne(inst, at, dur, out){
    const fam = SECTION_OF[inst];
    if (fam === 'strings') toneDetuned(at, dur, out, 'sawtooth', 0.9);
    else if (fam === 'woodwinds') toneVibrato(at, dur, out, 'sine', 5, 7);
    else if (fam === 'brass') toneFiltered(at, dur, out, 'square', 900);
    else tonePluck(at, dur, out); // piano/harp/keys
  }
  function toneDetuned(at, dur, out, type, det=0.8){
    const f = out._freq || 440;
    const o1 = ctx.createOscillator(), o2 = ctx.createOscillator();
    const g = ctx.createGain(); g.gain.value = 0.0001;
    o1.type=type; o2.type=type;
    o1.frequency.value = f*(1-det*0.005);
    o2.frequency.value = f*(1+det*0.005);
    o1.connect(g); o2.connect(g); g.connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.24, at+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o1.start(at); o2.start(at); o1.stop(at+dur+0.05); o2.stop(at+dur+0.05);
  }
  function toneVibrato(at, dur, out, type, lfoHz, depth){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain();
    const lfo = ctx.createOscillator(), lg = ctx.createGain();
    o.type=type; o.frequency.value=f; g.gain.value=0.0001;
    lfo.frequency.value = lfoHz; lg.gain.value = depth;
    lfo.connect(lg).connect(o.frequency);
    o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.26, at+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    lfo.start(at); lfo.stop(at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }
  function toneFiltered(at, dur, out, type, lpFreq){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain(); const lp = ctx.createBiquadFilter();
    o.type=type; o.frequency.value=f; g.gain.value=0.0001; lp.type='lowpass'; lp.frequency.value=lpFreq;
    o.connect(lp).connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.35, at+0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }
  function tonePluck(at, dur, out){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type='triangle'; o.frequency.value=f; g.gain.value=0.0001;
    o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.28, at+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }

  // Perc
  function schedulePercOne(inst, at, dur, out){
    const low = inst.toLowerCase();
    if (low.includes('kick')) kick(at, out);
    else if (low.includes('snare')) snare(at, out);
    else if (low.includes('hat')) hat(at, out, 0.05);
    else if (low.includes('timpani')) timpani(at, dur, out);
    else if (low.includes('triangle')) trianglePing(at, out);
    else if (low.includes('glock')) glockPing(at, out);
    else if (low.includes('xylo')) xyloPing(at, out);
    else if (low.includes('chime')) chimePing(at, out);
    else cymbal(at, out);
  }
  function kick(at, out){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(120, at);
    o.frequency.exponentialRampToValueAtTime(40, at+0.1);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.9, at+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.18);
    o.connect(g).connect(out); o.start(at); o.stop(at+0.2);
  }
  function snare(at, out){
    const noise = ctx.createBufferSource();
    const buffer = ctx.createBuffer(1, ctx.sampleRate*0.15, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
    noise.buffer=buffer;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.9;
    const g=ctx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.6, at+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.12);
    noise.connect(bp).connect(g).connect(out);
    noise.start(at); noise.stop(at+0.13);
  }
  function hat(at, out, len=0.05){
    const noise=ctx.createBufferSource();
    const buffer=ctx.createBuffer(1, ctx.sampleRate*len, ctx.sampleRate);
    const data=buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
    noise.buffer=buffer;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.6;
    const g=ctx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.35, at+0.003);
    g.gain.exponentialRampToValueAtTime(0.0001, at+len);
    noise.connect(hp).connect(g).connect(out);
    noise.start(at); noise.stop(at+len+0.01);
  }
  function timpani(at, dur, out){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=out._freq || 100;
    g.gain.value=0.0001; o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.6, at+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, at+Math.min(0.8,dur));
    o.start(at); o.stop(at+Math.min(0.82,dur+0.02));
  }
  function cymbal(at, out){ hat(at, out, 0.2); }
  function trianglePing(at,out){ tonePluck(at,0.08,out); }
  function glockPing(at,out){ out._freq=(out._freq||880); tonePluck(at,0.12,out); }
  function xyloPing(at,out){ out._freq=(out._freq||660); tonePluck(at,0.12,out); }
  function chimePing(at,out){ out._freq=(out._freq||523.25); tonePluck(at,0.35,out); }

  // Notes → frequency
  const NOTE_INDEX = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
  function noteNameToFreq(name){
    const m = String(name).toUpperCase().match(/^([A-G](?:#|B)?)(-?\d)$/);
    if (!m) return 440;
    const pitch = m[1], oct = parseInt(m[2],10);
    const idx = NOTE_INDEX[pitch] ?? 0;
    const n = idx + (oct+1)*12;
    return 440 * Math.pow(2,(n-69)/12);
  }

  /* --------- STOP / RESET --------- */
  function hardResetContext(){ const prev=ctx; if(!prev) return; try{prev.close()}catch{} ctx=null; }
  function stopAll(opts={}){ const {silent=false}=opts; isPlaying=false; btnStop.disabled=true; lampPlaying.classList.remove('on'); hardResetContext(); if(!silent) txtMsg.textContent='Stopped'; }

  /* --------- UI TIMER (Part 4 triggers) --------- */
  let uiTimer=null;
  function startUITimer(){
    clearInterval(uiTimer);
    uiTimer=setInterval(()=>{
      if (!ctx) return;
      const t=Math.max(0, ctx.currentTime - startTime);
      const clamped=Math.min(DURATION,t);
      txtTime.textContent=`t = ${clamped.toFixed(1)}s`;
      playhead.style.left=`${(clamped/DURATION)*100}%`;
      if (t>=DURATION && !isPlaying){ clearInterval(uiTimer); }
    }, 50);
  }

  // Expose minimal API
  window.__AIMIXER__ = {
    DURATION, CLASSIC_ORDER, SECTION_OF,
    get ctx(){ return ctx }, set ctx(v){ ctx=v },
    get startTime(){ return startTime }, isPlaying:()=>isPlaying,
    ensureAudio, scheduleOneMinute,
    stopAll, applyGains,
    timeline, playhead, lamps:{lampAudio,lampBeat,lampPlaying}, txtTime, txtMsg,
    patterns, noteNameToFreq,
    startUITimer
  };
})();
</script>
<script>
(() => {
  const {
    DURATION, CLASSIC_ORDER, SECTION_OF,
    ensureAudio, scheduleOneMinute, stopAll,
    timeline, playhead, lamps, txtTime, txtMsg,
    patterns, noteNameToFreq, startUITimer
  } = window.__AIMIXER__;

  /* ---------- Preset token banks per instrument ---------- */
  // Tokens are NOTE:beat:dur for pitched, or K/S/H for drums.
  const PRESETS = {
    // Strings — light triads over 1 minute at 120 BPM (beats→times later)
    "Violin I":    ["C5:0:1","E5:1:1","G5:2:2","E5:5:1","C5:6:2"],
    "Violin II":   ["G4:0:1","B4:1:1","D5:2:2","B4:5:1","G4:6:2"],
    "Viola":       ["E4:0:1","G4:1:1","C5:2:2","G4:5:1","E4:6:2"],
    "Cello":       ["C3:0:2","G2:4:2","C3:8:2"],
    "Double Bass": ["C2:0:2","G1:4:2","C2:8:2"],
    "Harp":        ["C5:0:0.5","E5:0.5:0.5","G5:1:1","B5:2:1","C6:3:1"],

    // Woodwinds
    "Flute":          ["C6:0:0.8","D6:1:0.8","E6:2:1.2","G6:4:1"],
    "Piccolo":        ["G6:0:0.6","A6:0.5:0.6","C7:1:0.8"],
    "Oboe":           ["C5:0:1","E5:1:1","F5:2:1"],
    "English Horn":   ["G4:0:1.2","A4:2:1.2"],
    "Clarinet":       ["E5:0:1","G5:1:1","B5:2:1"],
    "Bass Clarinet":  ["C3:0:1.5","G2:2:1.5"],
    "Bassoon":        ["C3:0:1.2","E3:1.5:1.2"],
    "Contrabassoon":  ["C2:0:2","G1:3:2"],
    "Saxophone":      ["E4:0:1","G4:1:1","B4:2:1"],

    // Brass
    "Horn":           ["C4:0:1.2","G4:2:1.2"],
    "Trumpet":        ["G4:0:0.8","B4:1:0.8","D5:2:1.2"],
    "Trombone":       ["C3:0:1.2","E3:2:1.2"],
    "Bass Trombone":  ["G2:0:1.2","C3:2:1.2"],
    "Tuba":           ["C2:0:2","G1:3:2"],
    "Euphonium":      ["E3:0:1.2","G3:2:1.2"],
    "Wagner Tuba":    ["C3:0:1.2","G3:2:1.2"],

    // Percussion (K,S,H) plus pitched mallets
    "Kick":          ["K:0:1","K:2:1","K:4:1","K:6:1"],
    "Snare":         ["S:1:1","S:5:1"],
    "Hi-hat":        ["H:0.5:0.5","H:1.5:0.5","H:2.5:0.5","H:3.5:0.5","H:4.5:0.5","H:5.5:0.5","H:6.5:0.5"],
    "Timpani":       ["C2:0:2","G1:4:2"],
    "Cymbals":       ["C5:8:0.2"],
    "Triangle":      ["C6:2:0.2","C6:6:0.2"],
    "Glockenspiel":  ["C6:0:0.6","E6:1:0.6","G6:2:0.8"],
    "Xylophone":     ["C5:0:0.6","E5:1:0.6","G5:2:0.8"],
    "Tambourine":    ["C6:1.5:0.2","C6:3.5:0.2","C6:5.5:0.2"],
    "Gong":          ["C3:6:2"],
    "Chimes":        ["C6:4:1"],

    // Keys / Organ
    "Piano":         ["C4:0:1","E4:1:1","G4:2:2","E4:5:1","C4:6:2"],
    "Celesta":       ["C6:0:0.6","E6:1:0.6","G6:2:0.8"],
    "Harpsichord":   ["C5:0:0.8","E5:1:0.8","G5:2:1.2"],
    "Organ":         ["C3:0:4","G2:4:4"]
  };

  /* ---------- Timeline ---------- */
  const W = () => timeline.clientWidth;
  function initTimeline(){
    timeline.querySelectorAll('.gridline,.label,.band').forEach(n=>n.remove());
    CLASSIC_ORDER.forEach(sec=>{
      const band=document.createElement('div');
      band.className=`band ${sec.key==='strings'?'str':sec.key==='woodwinds'?'ww':sec.key==='brass'?'br':sec.key==='perc'?'pc':'pn'}`;
      const left=(sec.start/DURATION)*100, width=((DURATION-sec.start)/DURATION)*100;
      band.style.left=left+'%'; band.style.width=width+'%'; timeline.appendChild(band);
    });
    for(let s=0;s<=DURATION;s+=5){
      const x=(s/DURATION)*W();
      const gl=document.createElement('div'); gl.className='gridline'; gl.style.left=(x|0)+'px'; timeline.appendChild(gl);
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=s+'s';
      lab.style.left=`calc(${(s/DURATION)*100}% + 4px)`; timeline.appendChild(lab);
    }
  }
  initTimeline(); window.addEventListener('resize', initTimeline);

  /* ---------- Instrument checkboxes & tokens ---------- */
  const ilist = document.getElementById('ilist');
  const tokenArea = document.getElementById('tokenArea');
  const tokInst = document.getElementById('tokInst');

  // runtime table: instrument -> { bpm, offsetSec, vol, enabledTokens:Set<string> }
  // fixed defaults for simplicity:
  const DEFAULTS = { bpm:120, offsetSec:0, vol:0.8 };

  // Ensure a pattern entry exists for instrument; build from enabledTokens
  function upsertPatternFromTokens(instrument){
    const section = SECTION_OF[instrument];
    // find existing
    let p = patterns.find(x => x.instrument===instrument);
    if (!p){
      p = {
        id: patterns.length ? Math.max(...patterns.map(x=>x.id))+1 : 1,
        instrument, section,
        bpm: DEFAULTS.bpm, offsetSec: DEFAULTS.offsetSec, vol: DEFAULTS.vol,
        notes: []
      };
      patterns.push(p);
    }
    const tokens = STATE.enabled[instrument] || new Set();
    p.notes = Array.from(tokens).map(tok => {
      const [n,b,d] = tok.split(':');
      const isPitch = /^[A-G]/i.test(n);
      return { name:n.toUpperCase(), beat:parseFloat(b), dur:parseFloat(d), _freq: isPitch ? window.__AIMIXER__.noteNameToFreq(n.toUpperCase()) : null };
    });
  }

  // Global UI state of enabled tokens per instrument
  const STATE = { enabled:{} }; // map inst -> Set(tokens)

  function renderTokens(instrument){
    tokInst.textContent = instrument || '—';
    tokenArea.innerHTML = '';
    if (!instrument || !PRESETS[instrument]) return;

    // default-select ALL tokens when instrument first seen
    if (!STATE.enabled[instrument]) STATE.enabled[instrument] = new Set(PRESETS[instrument]);

    PRESETS[instrument].forEach(tok => {
      const wrap = document.createElement('label');
      wrap.className = 'token';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value = tok;
      cb.checked = STATE.enabled[instrument].has(tok);
      cb.addEventListener('change', ()=>{
        if (cb.checked) STATE.enabled[instrument].add(tok);
        else STATE.enabled[instrument].delete(tok);
        upsertPatternFromTokens(instrument);
        restartIfNeeded();
      });
      const span = document.createElement('span');
      span.textContent = tok;
      wrap.appendChild(cb); wrap.appendChild(span);
      tokenArea.appendChild(wrap);
    });

    upsertPatternFromTokens(instrument);
  }

  function restartIfNeeded(){
    // If playing, stop & restart the one-minute schedule so the change is audible now
    if (window.__AIMIXER__.isPlaying && window.__AIMIXER__.isPlaying()){
      window.__AIMIXER__.stopAll({silent:true});
      ensureAudio(); // recreate context
      window.__AIMIXER__.txtMsg.textContent = 'Applying changes…';
      document.getElementById('btnPlay').click(); // re-start
    } else {
      // Not playing? Auto-start per your request
      document.getElementById('btnPlay').click();
    }
  }

  // When an instrument checkbox is toggled:
  ilist.addEventListener('change', (e)=>{
    const input = e.target;
    if (input.type !== 'checkbox') return;
    const inst = input.value;

    if (input.checked){
      // create default selection, render tokens, and ensure pattern
      renderTokens(inst);
      restartIfNeeded();
    } else {
      // remove from patterns and state
      delete STATE.enabled[inst];
      const idx = patterns.findIndex(x=>x.instrument===inst);
      if (idx>=0) patterns.splice(idx,1);
      if (tokInst.textContent===inst){ tokInst.textContent='—'; tokenArea.innerHTML=''; }
      restartIfNeeded();
    }
  });

  // Click on a label should preview its tokens panel
  ilist.addEventListener('click', (e)=>{
    const row = e.target.closest('.irow');
    if (!row) return;
    const cb = row.querySelector('input[type="checkbox"]');
    if (!cb) return;
    // If instrument already enabled, just render its tokens panel (don’t toggle)
    if (cb.checked){
      renderTokens(cb.value);
    }
  });

  /* ---------- Transport UI timer ---------- */
  document.getElementById('btnPlay').addEventListener('click', ()=> startUITimer());
  document.getElementById('btnStop').addEventListener('click', ()=> {/* handled in Part 3 */});
  document.getElementById('btnReset').addEventListener('click', ()=>{
    playhead.style.left='0%'; window.__AIMIXER__.txtTime.textContent='t = 0.0s';
  });

  /* ---------- Init: show first group’s tokens when user checks something ---------- */
  // No instruments enabled at load; user ticks to begin.

})();
</script>
</body>
</html>
