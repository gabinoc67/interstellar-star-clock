<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — 1-Minute AI Symphony • 32 Chairs (A/B per section) • A:10 + B:6</title>
<style>
  :root{
    --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758; --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --blink:#6ee7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1380px;margin:0 auto;padding:16px;display:grid;grid-template-columns:480px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"],input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
  }
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
  .stat b{color:var(--ok)}
  #status{font-size:12px;color:#9ad1ff;margin-top:8px}
  .danger{background:#3b1220;border-color:#6b1f35}
  small.hint{display:block;color:#a8b7e3;margin-top:6px}

  /* Stage */
  .stage{
    position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;
    padding-top:280px;
    background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)
  }
  .stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-rows:repeat(4,1fr);grid-template-columns:repeat(5,1fr);gap:10px;height:560px}
  .cell{display:flex;align-items:center;justify-content:center}
  .section{
    background:linear-gradient(180deg,#0e1b43,#0a1232); border:1px solid #20326d; border-radius:12px;
    width:100%; height:100%; min-height:110px; padding:10px; display:flex; flex-direction:column; gap:6px; justify-content:space-between;
  }
  .title{font-weight:800;color:#e4eeff;font-size:13px}
  .meta{font-size:11px;color:#9bb9ff}
  .lights{display:flex;align-items:center;gap:6px}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
  .blink{animation:blink .45s ease-out}
  @keyframes blink{0%{background:#0c1430;border-color:#2a3b7a}30%{background:var(--blink);border-color:#bfefff}100%{background:#0c1430;border-color:#2a3b7a}}
  .check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;display:flex;align-items:center;justify-content:center;font-weight:900}
  .checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
  .mixRow{display:flex;gap:6px;align-items:center}

  /* Conductor + guide */
  .conductor{
    width:92px;height:92px;border-radius:50%; background:#0d1b44;border:2px solid #284a9b;
    display:flex;align-items:center;justify-content:center; font-weight:800; color:#cfe1ff;
    box-shadow:0 0 0 0 rgba(59,130,246,.45); animation:conPulse 1.4s ease-in-out infinite; animation-play-state:paused;
  }
  @keyframes conPulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
  .guide{
    position:absolute; left:50%; transform:translateX(-50%);
    top:118px; width:92%; max-width:860px;
    background:#0c1536; border:1px solid #274094; border-radius:12px; padding:10px 12px; color:#cfe1ff; font-size:12px;
  }
  .guide b{color:#9fe8ff}
  .guide ol{margin:6px 0 0 16px; padding-left:10px}
  .guide li{margin:2px 0}

  /* Pick lists */
  .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .pickList{display:grid;grid-template-columns:1fr;gap:8px}
  .pickItem{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--grid);border-radius:10px;padding:6px 10px;background:#0d1a3d}
  .fam{font-size:11px;color:#9fb8ff;margin-left:6px}

  /* Status dots */
  .statusDot{ width:12px;height:12px;border-radius:3px;background:#ffffff;border:2px solid #dddddd;display:inline-block; }
  .statusOn{background:var(--ok);border-color:#b7f5cd;}

  /* Conductor square panel under stage */
  .conductorPanel{margin-top:12px; display:flex; justify-content:center;}
  .condCard{
    width:260px; height:260px; border:1px solid var(--grid); border-radius:14px;
    background:#0d1b3d; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  }
  .conLabel{font-size:12px;color:#cfe1ff;opacity:0.9}

  /* A/B highlights */
  .section.isA { outline: 2px solid #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.18) inset; }
  .section.isB { outline: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18) inset; }

  .badge { display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px; font-size:10px; font-weight:700; letter-spacing:.3px; vertical-align:middle; }
  .badgeA { background:#0b2a1e; border:1px solid #10b981; color:#b9f6da; }
  .badgeB { background:#0b1f3d; border:1px solid #3b82f6; color:#cfe1ff; }

  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,"Courier New",monospace;font-size:11px;color:#bfe3ff}

  /* 32-chair panel */
  .chairGrid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
  }
  .mini{
    display:flex;flex-direction:column;gap:6px;
    padding:8px;border:1px solid var(--grid);border-radius:10px;background:#0e1733
  }
  .mini h4{margin:0;font-size:12px;color:#cfe1ff}
  .abRow{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .mini label{margin:0;font-size:11px;color:#a8c6ff}
</style>
</head>
<body>
<header>
  <h1>CST — 1-Minute AI Symphony • A:10 + B:6 (non-overlap) • 32 Chairs (per section A/B)</h1>
  <span style="font-size:12px;color:#9ad1ff">Every section has two subtle variants (A/B) that auto-alternate on playback.</span>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <div class="mixRow">
        <button id="btnAnalyze">2) Analyze 60s</button>
        <span id="dotAnalyze" class="statusDot" title="Analysis status"></span>
      </div>
      <button id="btnExport">3) Export CSV</button>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV headers: <b>t,m,b</b> (time sec, dominant MIDI, bass MIDI). Export → then load into A/B.</small>

    <div class="hr"></div>

    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadA">Load CSV → A</button>
          <span id="dotA" class="statusDot" title="A loaded"></span>
        </div>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadB">Load CSV → B</button>
          <span id="dotB" class="statusDot" title="B loaded"></span>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Conductor / Musicalize -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="cinematic" selected>Cinematic — lush</option>
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="bach">Bach — contrapuntal</option>
          <option value="haydn">Haydn — balanced</option>
          <option value="tchaikovsky">Tchaikovsky — lyrical</option>
          <option value="ravel">Ravel — color</option>
          <option value="mahler">Mahler — expansive</option>
          <option value="shostakovich">Shostakovich — edgy</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="price">Florence Price — warm</option>
          <option value="lili">Lili Boulanger — luminous</option>
          <option value="clara">Clara Schumann — lyrical</option>
          <option value="fanny">Fanny Mendelssohn — elegant</option>
          <option value="amy">Amy Beach — romantic</option>
          <option value="saariaho">Kaija Saariaho — spectral</option>
          <option value="tower">Joan Tower — kinetic</option>
          <option value="montgomery">Jessie Montgomery — vibrant</option>
          <option value="williams">John Williams — cinematic</option>
          <option value="zimmer">Hans Zimmer — hybrid</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Humanize (ms)</label><input id="human" type="number" min="0" max="40" step="1" value="6"/></div>
      <div><label>Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Reverb Mix</label><input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
      <div><label>Stereo Spread</label><input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>GM Program (0–127)</label>
        <input id="gmProg" type="number" min="0" max="127" step="1" value="48" />
        <small class="hint">Global fallback program; each chair can override below.</small>
      </div>
      <div>
        <label>Export Audio</label>
        <div class="mixRow">
          <button id="btnExportAudio">Export WAV (60s)</button>
          <span id="dotExport" class="statusDot" title="Export ready"></span>
        </div>
        <small class="hint">White square lights when a 60s score is ready to export.</small>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Cadence & Pace -->
    <label style="font-weight:700">Cadence & Pace</label>
    <div class="row3" id="cadenceRow">
      <button class="cadBtn" data-cad="even">Even</button>
      <button class="cadBtn" data-cad="march">March (2/4)</button>
      <button class="cadBtn" data-cad="waltz">Waltz (3/4)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="latin">Latin (2–3)</button>
      <button class="cadBtn" data-cad="sync">Syncopated</button>
      <button class="cadBtn" data-cad="swing">Swing (Shuffle)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="jig68">Jig (6/8)</button>
      <button class="cadBtn" data-cad="odd54">Odd (5/4)</button>
      <div class="stat"><span>Active cadence</span><b id="cadName">Even</b></div>
    </div>
    <div class="row3" style="margin-top:8px">
      <button class="paceBtn" data-pace="adagio">Adagio</button>
      <button class="paceBtn" data-pace="andante">Andante</button>
      <button class="paceBtn" data-pace="moderato">Moderato</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="paceBtn" data-pace="allegro">Allegro</button>
      <button class="paceBtn" data-pace="vivace">Vivace</button>
      <button class="paceBtn" data-pace="presto">Presto</button>
    </div>
    <div class="stat" style="margin-top:6px"><span>Active pace</span><b id="paceName">Andante</b></div>

    <div class="hr"></div>

    <!-- Family Opening controls -->
    <label style="font-weight:700">Family Opening (entry timing bias)</label>
    <div class="row">
      <button id="btnOpenRandom" title="Generate a musical opening order">Randomize Family Opening</button>
      <button id="btnOpenReset">Reset Default</button>
    </div>
    <div class="stat" style="margin-top:6px">
      <span>Open @ seconds (Strings, Winds, Brass, Perc)</span>
      <b class="mono" id="openSummary">0, 8, 16, 24</b>
    </div>

    <div class="hr"></div>

    <!-- A vs B pickers -->
    <label style="font-weight:700">Orchestration Picks (A:10, B:6 non-overlapping)</label>
    <div class="twoCols" style="margin-top:6px">
      <div>
        <div class="row" style="margin-bottom:6px">
          <button id="btnRandomA">Randomize A (10)</button>
          <div class="stat"><span>A Selected</span><b id="selCountA">0</b></div>
        </div>
        <div id="listA" class="pickList"></div>
      </div>
      <div>
        <div class="row" style="margin-bottom:6px">
          <button id="btnRandomB">Randomize B (6)</button>
          <div class="stat"><span>B Selected</span><b id="selCountB">0</b></div>
        </div>
        <div id="listB" class="pickList"></div>
      </div>
    </div>
    <small class="hint">Use the checkboxes to <b>lock</b> any slot before re-randomizing.</small>

    <div class="hr"></div>
    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>
    <div id="status">Ready.</div>

    <div class="hr"></div>
    <!-- 32-CHAIR PANEL -->
    <label style="font-weight:700">Chair Sounds (GM 0–127) — 32 Chairs (A/B per section)</label>
    <small class="hint">Each section has two subtle variants (A & B). Playback alternates them to simulate two players of the same instrument with slightly different models/styles.</small>

    <div class="chairGrid" style="margin-top:6px">
      <!-- STRINGS -->
      <div class="mini">
        <h4>1st Violins</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_vln1_a" type="number" min="0" max="127" value="48"></div>
          <div><label>B</label><input id="gm_vln1_b" type="number" min="0" max="127" value="49"></div>
        </div>
      </div>
      <div class="mini">
        <h4>2nd Violins</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_vln2_a" type="number" min="0" max="127" value="49"></div>
          <div><label>B</label><input id="gm_vln2_b" type="number" min="0" max="127" value="50"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Violas</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_violas_a" type="number" min="0" max="127" value="50"></div>
          <div><label>B</label><input id="gm_violas_b" type="number" min="0" max="127" value="51"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Cellos</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_cellos_a" type="number" min="0" max="127" value="42"></div>
          <div><label>B</label><input id="gm_cellos_b" type="number" min="0" max="127" value="43"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Double Basses</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_basses_a" type="number" min="0" max="127" value="34"></div>
          <div><label>B</label><input id="gm_basses_b" type="number" min="0" max="127" value="33"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Harp/Keys</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_harp_a" type="number" min="0" max="127" value="46"></div>
          <div><label>B</label><input id="gm_harp_b" type="number" min="0" max="127" value="45"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Piano</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_piano_a" type="number" min="0" max="127" value="0"></div>
          <div><label>B</label><input id="gm_piano_b" type="number" min="0" max="127" value="1"></div>
        </div>
      </div>

      <!-- WOODWINDS -->
      <div class="mini">
        <h4>Flutes/Picc.</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_flutes_a" type="number" min="0" max="127" value="73"></div>
          <div><label>B</label><input id="gm_flutes_b" type="number" min="0" max="127" value="72"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Oboes</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_oboes_a" type="number" min="0" max="127" value="68"></div>
          <div><label>B</label><input id="gm_oboes_b" type="number" min="0" max="127" value="69"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Clarinets</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_clarinets_a" type="number" min="0" max="127" value="71"></div>
          <div><label>B</label><input id="gm_clarinets_b" type="number" min="0" max="127" value="72"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Bassoons</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_bassoons_a" type="number" min="0" max="127" value="70"></div>
          <div><label>B</label><input id="gm_bassoons_b" type="number" min="0" max="127" value="69"></div>
        </div>
      </div>

      <!-- BRASS -->
      <div class="mini">
        <h4>Trumpets</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_trumpets_a" type="number" min="0" max="127" value="56"></div>
          <div><label>B</label><input id="gm_trumpets_b" type="number" min="0" max="127" value="57"></div>
        </div>
      </div>
      <div class="mini">
        <h4>French Horns</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_horns_a" type="number" min="0" max="127" value="60"></div>
          <div><label>B</label><input id="gm_horns_b" type="number" min="0" max="127" value="61"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Trombones/Tuba</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_trombones_a" type="number" min="0" max="127" value="58"></div>
          <div><label>B</label><input id="gm_trombones_b" type="number" min="0" max="127" value="59"></div>
        </div>
      </div>

      <!-- PERCUSSION -->
      <div class="mini">
        <h4>Percussion</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_perc_a" type="number" min="0" max="127" value="115"></div>
          <div><label>B</label><input id="gm_perc_b" type="number" min="0" max="127" value="116"></div>
        </div>
      </div>
      <div class="mini">
        <h4>Drums</h4>
        <div class="abRow">
          <div><label>A</label><input id="gm_drums_a" type="number" min="0" max="127" value="118"></div>
          <div><label>B</label><input id="gm_drums_b" type="number" min="0" max="127" value="117"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: STAGE (unchanged) -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Even spacing • Front strings, winds middle, brass back, perc rear</b></div>
    </div>

    <div class="guide">
      <b>How the 1-minute AI Symphony Orchestra works (HTML + Web Audio)</b>
      <ol>
        <li><b>Load Audio</b> and <b>Analyze 60s</b> → auto-detected notes.</li>
        <li><b>Export CSV</b> (<code>t,m,b</code>) and then load into <b>A</b> and/or <b>B</b>.</li>
        <li>Pick instruments: <b>A = 10</b>, then <b>B = 6</b> from the remaining (no overlap).</li>
        <li>Set Conductor/Key/Tempo/Quantize/Swing/Humanize/Reverb/Spread + Cadence & Pace.</li>
        <li>Press <b>Play</b>. Lights blink on the sections that are sounding.</li>
      </ol>
    </div>

    <div class="grid">
      <!-- Row 1 (back: brass/perc) -->
      <div class="cell"><div class="section" data-sec="trumpets"><div class="title">Trumpets</div><div class="meta">Back left</div><div class="lights"><div class="dot" id="dot-trumpets"></div><div class="check" id="chk-trumpets"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpets">Mute</button><button class="btnSmall" data-solo="trumpets">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="horns"><div class="title">French Horns</div><div class="meta">Back middle</div><div class="lights"><div class="dot" id="dot-horns"></div><div class="check" id="chk-horns"></div></div><div class="mixRow"><button class="btnSmall" data-mute="horns">Mute</button><button class="btnSmall" data-solo="horns">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="perc"><div class="title">Percussion</div><div class="meta">Back center</div><div class="lights"><div class="dot" id="dot-perc"></div><div class="check" id="chk-perc"></div></div><div class="mixRow"><button class="btnSmall" data-mute="perc">Mute</button><button class="btnSmall" data-solo="perc">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombones"><div class="title">Trombones/Tuba</div><div class="meta">Back right</div><div class="lights"><div class="dot" id="dot-trombones"></div><div class="check" id="chk-trombones"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombones">Mute</button><button class="btnSmall" data-solo="trombones">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 2 (winds) -->
      <div class="cell"><div class="section" data-sec="flutes"><div class="title">Flutes/Picc.</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-flutes"></div><div class="check" id="chk-flutes"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutes">Mute</button><button class="btnSmall" data-solo="flutes">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="oboes"><div class="title">Oboes</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-oboes"></div><div class="check" id="chk-oboes"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboes">Mute</button><button class="btnSmall" data-solo="oboes">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="clarinets"><div class="title">Clarinets</div><div class="meta">Winds (A/B alt)</div><div class="lights"><div class="dot" id="dot-clarinets"></div><div class="check" id="chk-clarinets"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinets">Mute</button><button class="btnSmall" data-solo="clarinets">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassoons"><div class="title">Bassoons</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-bassoons"></div><div class="check" id="chk-bassoons"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoons">Mute</button><button class="btnSmall" data-solo="bassoons">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 3 (piano + basses + drums + harp) -->
      <div class="cell"><div class="section" data-sec="piano"><div class="title">Piano</div><div class="meta">Back left (keys)</div><div class="lights"><div class="dot" id="dot-piano"></div><div class="check" id="chk-piano"></div></div><div class="mixRow"><button class="btnSmall" data-mute="piano">Mute</button><button class="btnSmall" data-solo="piano">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="basses"><div class="title">Double Basses</div><div class="meta">Back of strings</div><div class="lights"><div class="dot" id="dot-basses"></div><div class="check" id="chk-basses"></div></div><div class="mixRow"><button class="btnSmall" data-mute="basses">Mute</button><button class="btnSmall" data-solo="basses">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="drums"><div class="title">Drums</div><div class="meta">Center-right</div><div class="lights"><div class="dot" id="dot-drums"></div><div class="check" id="chk-drums"></div></div><div class="mixRow"><button class="btnSmall" data-mute="drums">Mute</button><button class="btnSmall" data-solo="drums">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="harp"><div class="title">Harp/Keys</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harp"></div><div class="check" id="chk-harp"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harp">Mute</button><button class="btnSmall" data-solo="harp">Solo</button></div></div></div>
      <div class="cell"></div>

      <!-- Row 4 (front strings) -->
      <div class="cell"><div class="section" data-sec="vln1"><div class="title">1st Violins</div><div class="meta">Far left</div><div class="lights"><div class="dot" id="dot-vln1"></div><div class="check" id="chk-vln1"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1">Mute</button><button class="btnSmall" data-solo="vln1">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln2"><div class="title">2nd Violins</div><div class="meta">Left-center</div><div class="lights"><div class="dot" id="dot-vln2"></div><div class="check" id="chk-vln2"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2">Mute</button><button class="btnSmall" data-solo="vln2">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="violas"><div class="title">Violas</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violas"></div><div class="check" id="chk-violas"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violas">Mute</button><button class="btnSmall" data-solo="violas">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="cellos"><div class="title">Cellos</div><div class="meta">Right-center</div><div class="lights"><div class="dot" id="dot-cellos"></div><div class="check" id="chk-cellos"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellos">Mute</button><button class="btnSmall" data-solo="cellos">Solo</button></div></div></div>
      <div class="cell"></div>
    </div>

    <!-- Conductor panel -->
    <div class="conductorPanel">
      <div class="condCard">
        <div class="conductor" id="conductor">Conductor</div>
        <div class="conLabel" id="conLabel">Conductor / Musicalize: Cinematic — lush</div>
      </div>
    </div>
  </section>
</main>
<script>
/* ===== Helpers & scales ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const median=a=>{const s=[...a].sort((x,y)=>x-y),n=s.length;return n?(n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):0;}
function pcsFor(root,mode){const r=NOTE.indexOf(root);return (mode==='minor'?MINOR:MAJOR).map(pc=>(pc+r+120)%12);}
function snapToScale(m,pcs){ if(!m) return 0; const pc=((m%12)+12)%12; if(pcs.includes(pc)) return m; for(const d of [1,-1,2,-2]){const c=((pc+d)+12)%12;if(pcs.includes(c)) return m+d;} return m; }
const $=id=>document.getElementById(id);

/* ===== UI refs ===== */
const btnLoadAudio=$('btnLoadAudio'), btnAnalyze=$('btnAnalyze'), btnExport=$('btnExport'), audioFile=$('audioFile');
const detKey=$('detKey'), detBPM=$('detBPM'), statusEl=$('status');
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn'), conductor=$('conductor');
const conLabel=$('conLabel');
const cadName=$('cadName'), paceName=$('paceName');
const btnRandomA=$('btnRandomA'), btnRandomB=$('btnRandomB'), listA=$('listA'), listB=$('listB'), selCountA=$('selCountA'), selCountB=$('selCountB');
const gmProgEl=$('gmProg'), btnExportAudio=$('btnExportAudio');
const btnOpenRandom=$('btnOpenRandom'), btnOpenReset=$('btnOpenReset'), openSummary=$('openSummary');
const dotA=$('dotA'), dotB=$('dotB'), dotAnalyze=$('dotAnalyze'), dotExport=$('dotExport');
function light(el,on){ if(!el) return; if(on){ el.classList.add('statusOn'); } else { el.classList.remove('statusOn'); } }
function setStatus(s){ statusEl.textContent=s; }
function updateConLabel(){ const txt=composerEl.options[composerEl.selectedIndex].textContent; conLabel.textContent='Conductor / Musicalize: ' + txt; }

/* ===== Stage state ===== */
const SECTIONS=['vln1','vln2','violas','cellos','basses','harp','piano','flutes','oboes','clarinets','bassoons','trumpets','horns','trombones','perc','drums'];
const DOT={}, CHK={}, MUTE={}, SOLO={on:false,id:null};
SECTIONS.forEach(id=>{ DOT[id]=document.getElementById('dot-'+id); CHK[id]=document.getElementById('chk-'+id); MUTE[id]=false; });
document.querySelectorAll('[data-mute]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-mute'); MUTE[s]=!MUTE[s]; b.textContent=MUTE[s]?'Unmute':'Mute';});
document.querySelectorAll('[data-solo]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-solo'); if(SOLO.on&&SOLO.id===s){SOLO.on=false;SOLO.id=null;b.textContent='Solo';}else{SOLO.on=true;SOLO.id=s;document.querySelectorAll('[data-solo]').forEach(x=>x.textContent='Solo');b.textContent='Unsolo';}});

/* A/B coloring on stage */
function markStage(){
  const aSet = new Set(PICK_A.map(x=>x.id));
  const bSet = new Set(PICK_B.map(x=>x.id));
  SECTIONS.forEach(id=>{
    const secEl = document.querySelector(`.section[data-sec="${id}"]`);
    if(!secEl) return;
    secEl.classList.remove('isA','isB');
    const titleEl = secEl.querySelector('.title'); if(!titleEl) return;
    titleEl.querySelectorAll('.badge').forEach(b=>b.remove());
    if(aSet.has(id)){
      secEl.classList.add('isA');
      const b = document.createElement('span'); b.className='badge badgeA'; b.textContent='A'; titleEl.appendChild(b);
    }else if(bSet.has(id)){
      secEl.classList.add('isB');
      const b = document.createElement('span'); b.className='badge badgeB'; b.textContent='B'; titleEl.appendChild(b);
    }
  });
}

/* Families & labels */
const FAM={strings:['vln1','vln2','violas','cellos','basses','harp','piano'], winds:['flutes','oboes','clarinets','bassoons'], brass:['horns','trumpets','trombones'], perc:['perc','drums']};
const LABEL={vln1:'1st Violins',vln2:'2nd Violins',violas:'Violas',cellos:'Cellos',basses:'Double Basses',harp:'Harp/Keys',piano:'Piano',flutes:'Flutes/Picc.',oboes:'Oboes',clarinets:'Clarinets',bassoons:'Bassoons',horns:'French Horns',trumpets:'Trumpets',trombones:'Trombones/Tuba',perc:'Percussion',drums:'Drums'};
const FAMNAME={strings:'Strings',winds:'Woodwinds',brass:'Brass',perc:'Percussion'};

/* Picks (A:10, B:6; non-overlapping) */
let PICK_A=[], PICK_B=[];
function famOf(id){ for (const k of Object.keys(FAM)) if (FAM[k].includes(id)) return k; return 'strings'; }
function pickN(arr,n,exclude=new Set()){
  const pool=arr.filter(x=>!exclude.has(x)); const out=[];
  while(pool.length && out.length<n){ const k=Math.floor(Math.random()*pool.length); out.push(pool.splice(k,1)[0]); }
  return out;
}
function renderSide(side){
  const box = side==='A'? listA : listB; const arr = side==='A'? PICK_A : PICK_B; const setCount = side==='A'? selCountA : selCountB;
  box.innerHTML='';
  arr.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='pickItem';
    row.innerHTML=`<div>${LABEL[it.id]} <span class="fam">(${FAMNAME[it.fam]})</span></div>
                   <label style="font-size:12px;display:flex;align-items:center;gap:6px">
                     <input type="checkbox" ${it.locked?'checked':''} data-lock="${side}:${i}"/> lock
                   </label>`;
    box.appendChild(row);
  });
  setCount.textContent=String(arr.length);
  box.querySelectorAll('input[data-lock]').forEach(cb=>{
    cb.onchange=()=>{ const [s,idx]=cb.getAttribute('data-lock').split(':'); const I=+idx; (s==='A'?PICK_A:PICK_B)[I].locked=cb.checked; };
  });
}
function enforceBExclusion(){
  const aSet=new Set(PICK_A.map(x=>x.id)); let changed=false;
  PICK_B = PICK_B.filter(x=>!aSet.has(x.id) ? true : (changed=true,false));
  if(changed){
    const excl=new Set([...aSet, ...PICK_B.map(x=>x.id)]);
    const all=[...FAM.strings,...FAM.winds,...FAM.brass,...FAM.perc];
    const fill=pickN(all, 6 - PICK_B.length, excl).map(id=>({id,fam:famOf(id)}));
    PICK_B=[...PICK_B, ...fill].slice(0,6).map(x=>({...x,locked:!!x.locked}));
  }
}
function randomizeA(){
  const keep=PICK_A.filter(x=>x.locked); const excl=new Set(keep.map(x=>x.id)); const p=[];
  for(const fam of ['strings','winds','brass','perc']){
    const need=Math.min(2, Math.max(0, 10 - (keep.length+p.length)));
    const take=pickN(FAM[fam], need, excl); take.forEach(id=>{excl.add(id); p.push({id,fam});});
  }
  const all=[...FAM.strings,...FAM.winds,...FAM.brass,...FAM.perc];
  pickN(all, 10 - (keep.length+p.length), excl).forEach(id=>{excl.add(id); p.push({id,fam:famOf(id)});});
  PICK_A=[...keep, ...p].slice(0,10).map(x=>({...x,locked:!!x.locked}));
  enforceBExclusion(); renderSide('A'); renderSide('B'); markStage();
}
function randomizeB(){
  const keep=PICK_B.filter(x=>x.locked);
  const excl=new Set([...PICK_A.map(x=>x.id), ...keep.map(x=>x.id)]);
  const all=[...FAM.strings,...FAM.winds,...FAM.brass,...FAM.perc];
  const chosen=pickN(all, 6 - keep.length, excl).map(id=>({id,fam:famOf(id)}));
  PICK_B=[...keep, ...chosen].slice(0,6).map(x=>({...x,locked:!!x.locked}));
  renderSide('B'); markStage();
}

/* Conductor presets */
const PRESETS_BASE={
  classic:{swing:0.06,human:5,  quant:0.125, reverb:0.12, spread:0.45},
  bold:{   swing:0.08,human:7,  quant:0.125, reverb:0.16, spread:0.55},
  color:{  swing:0.12,human:8,  quant:0.125, reverb:0.20, spread:0.60},
  fluid:{  swing:0.18,human:10, quant:0.0625,reverb:0.22, spread:0.65},
  rhythmic:{swing:0.04,human:8, quant:0.0625,reverb:0.14, spread:0.55},
  warm:{  swing:0.10,human:8,  quant:0.125, reverb:0.18, spread:0.55},
  luminous:{swing:0.14,human:9, quant:0.125, reverb:0.20, spread:0.60},
  lyrical:{swing:0.10,human:7,  quant:0.125, reverb:0.17, spread:0.55},
  romantic:{swing:0.10,human:8, quant:0.125, reverb:0.19, spread:0.58},
  spectral:{swing:0.20,human:12,quant:0.0625,reverb:0.26, spread:0.70},
  kinetic:{swing:0.08,human:9,  quant:0.0625,reverb:0.18, spread:0.60},
  vibrant:{swing:0.12,human:9,  quant:0.125, reverb:0.22, spread:0.62},
  cinematic:{swing:0.12,human:9, quant:0.0625,reverb:0.26, spread:0.75},
  contrapuntal:{swing:0.05,human:5,quant:0.125,reverb:0.12, spread:0.40},
  balanced:{swing:0.06,human:6,quant:0.125,reverb:0.14, spread:0.48},
  expansive:{swing:0.10,human:9,quant:0.125,reverb:0.22, spread:0.60},
  edgy:{swing:0.06,human:8,quant:0.0625,reverb:0.16, spread:0.55},
  hybrid:{swing:0.10,human:9,quant:0.125,reverb:0.24, spread:0.72}
};
const PRESETS={
  mozart:PRESETS_BASE.classic, beethoven:PRESETS_BASE.bold, bach:PRESETS_BASE.contrapuntal, haydn:PRESETS_BASE.balanced,
  tchaikovsky:PRESETS_BASE.romantic, ravel:PRESETS_BASE.color, mahler:PRESETS_BASE.expansive, shostakovich:PRESETS_BASE.edgy,
  debussy:PRESETS_BASE.fluid, stravinsky:PRESETS_BASE.rhythmic, price:PRESETS_BASE.warm, lili:PRESETS_BASE.luminous,
  clara:PRESETS_BASE.lyrical, fanny:PRESETS_BASE.lyrical, amy:PRESETS_BASE.romantic, saariaho:PRESETS_BASE.spectral,
  tower:PRESETS_BASE.kinetic, montgomery:PRESETS_BASE.vibrant, williams:PRESETS_BASE.cinematic, zimmer:PRESETS_BASE.hybrid,
  cinematic:PRESETS_BASE.cinematic
};
function applyConductorPreset(){
  const p=PRESETS[composerEl.value]||PRESETS.cinematic;
  $('swing').value=String(p.swing); $('human').value=String(p.human); $('quant').value=String(p.quant);
  $('reverbMix').value=String(p.reverb); $('spread').value=String(p.spread);
  updateConLabel();
}

/* Cadence & Pace */
const PRESETS_PACE={
  adagio:{name:'Adagio', bpmMul:0.85, density:0.7},
  andante:{name:'Andante', bpmMul:1.0, density:0.85},
  moderato:{name:'Moderato', bpmMul:1.1, density:1.0},
  allegro:{name:'Allegro', bpmMul:1.2, density:1.1},
  vivace:{name:'Vivace', bpmMul:1.35, density:1.25},
  presto:{name:'Presto', bpmMul:1.5, density:1.35},
};
const CADENCES={
  even:{name:'Even', pattern:[1,0,0,0], percEvery:4, sync:0},
  march:{name:'March (2/4)', pattern:[1,0], percEvery:2, sync:0.05},
  waltz:{name:'Waltz (3/4)', pattern:[1,0,0], percEvery:3, sync:0.03},
  latin:{name:'Latin (2–3)', pattern:[1,0,1,0,1], percEvery:1, sync:0.12},
  sync:{name:'Syncopated', pattern:[0,1,0,1], percEvery:2, sync:0.18},
  swing:{name:'Swing (Shuffle)', pattern:[1,0,0,1,0,0], percEvery:3, sync:0.10},
  jig68:{name:'Jig (6/8)', pattern:[1,0,0,1,0,0], percEvery:3, sync:0.06},
  odd54:{name:'Odd (5/4)', pattern:[1,0,0,1,0], percEvery:5, sync:0.08},
};
let CAD='even', PAC='andante';
document.querySelectorAll('.cadBtn').forEach(b=>b.onclick=()=>{ CAD=b.dataset.cad; $('cadName').textContent=CADENCES[CAD].name; });
document.querySelectorAll('.paceBtn').forEach(b=>b.onclick=()=>{ PAC=b.dataset.pace; $('paceName').textContent=PRESETS_PACE[PAC].name; });

/* Analysis: Audio → CSV */
let A={events:[]}, B={events:[]}, LAST_ANALYSIS={events:[],key:"C major",bpm:100};
function toCSV(events){ const rows=["t,m,b"]; for(const e of events){ rows.push(`${e.t.toFixed(3)},${e.m|0},${e.b|0}`);} return rows.join("\n"); }
function downloadCSV(name,text){ const blob=new Blob([text],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0); }
function parseCSV(text){
  const lines=text.replace(/\r/g,'').trim().split('\n'); if(!lines.length) return [];
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase()); const ti=hdr.indexOf('t'), mi=hdr.indexOf('m'), bi=hdr.indexOf('b');
  if(ti<0||mi<0||bi<0) throw new Error("CSV must have headers: t,m,b");
  const out=[]; for(let i=1;i<lines.length;i++){ const r=lines[i].split(','); const t=parseFloat(r[ti]||"0"), m=parseInt(r[mi]||"0",10), b=parseInt(r[bi]||"0",10); if(Number.isFinite(t)&&t>=0&&t<=60) out.push({t,m,b}); }
  return out.sort((a,b)=>a.t-b.t);
}
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; } return best.name; }
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0;}
function acPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++)mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const minF=60,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag;lag<=Math.min(maxLag,N-2);lag++){let s=0;for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if(s>best){best=s;bestLag=lag;}}
  return bestLag? sr/bestLag : 0;
}
async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  setStatus("Decoding…");
  const arr=await file.arrayBuffer();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await ctx.decodeAudioData(arr.slice(0));
  const sr=buf.sampleRate, ch=buf.numberOfChannels, mono=new Float32Array(buf.length);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<d.length;i++) mono[i]=(mono[i]||0)+d[i]/ch; }
  const frame=4096, hop=2048, maxS=Math.min(mono.length, sr*60);
  const events=[], pc=new Float32Array(12), on=[]; let prevE=0;
  setStatus("Analyzing 60s…");
  for(let st=0; st+frame<=maxS; st+=hop){
    const fr=mono.subarray(st,st+frame);
    let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if(dE>0.08) on.push(st);
    let f=acPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
    let m=0,b=0; if(f){ m=clamp(Math.round(69+12*Math.log2(f/440)),24,96); if(f<=220) b=clamp(Math.round(69+12*Math.log2(f/440)),28,72); pc[(m%12+12)%12]++; }
    events.push({t:st/sr, m, b});
  }
  const smooth=(list,key)=>{const half=2,a=list.map(e=>e[key]||0),sm=[]; for(let i=0;i<a.length;i++){const w=[]; for(let k=Math.max(0,i-half);k<=Math.min(a.length-1,i+half);k++) if(a[k]) w.push(a[k]); sm[i]=w.length?Math.round(median(w)):0;} for(let i=0;i<list.length;i++) list[i][key]=sm[i];};
  smooth(events,'m'); smooth(events,'b');
  const keyName=correlate(Array.from(pc)); const pcs=pcsFor(keyName.split(' ')[0], keyName.toLowerCase().includes('minor')?'minor':'major');
  for(const e of events){ if(e.m) e.m=snapToScale(e.m,pcs); if(e.b) e.b=snapToScale(e.b,pcs); }
  const bpm=(()=>{ if(on.length<3) return 100; const dif=[]; for(let i=1;i<on.length;i++){const dt=(on[i]-on[i-1])/sr; if(dt>0.18&&dt<2.2) dif.push(dt);} if(!dif.length) return 100; const m=dif.sort((a,b)=>a-b)[Math.floor(dif.length/2)]; let b=Math.round(60/m); while(b<60) b*=2; while(b>180) b=Math.round(b/2); return b; })();
  LAST_ANALYSIS={events,key:keyName,bpm}; detKey.textContent=keyName; detBPM.textContent=String(bpm);
  bpmEl.value=String(Math.round(bpm)); const [r,mo]=(keyName||'C major').split(' '); keyRootEl.value=r; keyModeEl.value=(mo||'major').toLowerCase();
  setStatus("Analysis complete → Export CSV.");
  light(dotAnalyze,true);
  checkExportReady();
}

/* Audio engine */
let AUDIO={ctx:null, master:null, comp:null, dry:null, wet:null, convolver:null, bus:{}};
let idxTimer=null, t0=0, schArr=[], idx=0;
const LOOKAHEAD=0.25;

function makeHallIR(ctx){
  const len=ctx.sampleRate*2.2, ir=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0; ch<2; ch++){ const d=ir.getChannelData(ch); let x=0; for(let i=0;i<len;i++){ const n=(Math.random()*2-1)*0.5; const t=i/ctx.sampleRate; const dec=Math.exp(-t*1.5); x=0.32*n+0.68*x; d[i]=x*dec; } }
  return ir;
}
function getAudio(){
  if(!AUDIO.ctx){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const comp=ctx.createDynamicsCompressor(); comp.threshold.value=-18; comp.ratio.value=3; comp.attack.value=0.004; comp.release.value=0.2;
    const dry=ctx.createGain(), wet=ctx.createGain(); dry.gain.value=1; wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
    const conv=ctx.createConvolver(); conv.buffer=makeHallIR(ctx);
    const master=ctx.createGain(); master.gain.value=parseFloat(masterVolEl.value||"0.85");
    dry.connect(comp); conv.connect(wet); wet.connect(comp); comp.connect(master); master.connect(ctx.destination);
    AUDIO={ctx,master,comp,dry,wet,convolver:conv,bus:{}};
    buildBuses();
  }
  AUDIO.master.gain.value=parseFloat(masterVolEl.value||"0.85");
  AUDIO.wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
  return AUDIO.ctx;
}
function buildBuses(){
  const ctx=AUDIO.ctx, spread=parseFloat(spreadEl.value||"0.55");
  AUDIO.bus={};
  const panTable={vln1:-0.7, vln2:-0.45, violas:-0.05, cellos:0.4, basses:0.65, harp:0.75, piano:-0.8, flutes:-0.1, oboes:0.1, clarinets:-0.2, bassoons:0.2, trumpets:-0.55, horns:0.0, trombones:0.55, perc:0.0, drums:0.15};
  for(const id of SECTIONS){
    const g=ctx.createGain(); g.gain.value=1;
    const l=ctx.createGain(), r=ctx.createGain(), m=ctx.createChannelMerger(2);
    g.connect(l); g.connect(r); l.connect(m,0,0); r.connect(m,0,1);
    const pan=Math.max(-0.95,Math.min(0.95,(panTable[id]||0)*spread));
    const L=Math.max(0,Math.min(1,0.5 - pan/2)), R=Math.max(0,Math.min(1,0.5 + pan/2));
    l.gain.value=L; r.gain.value=R;
    m.connect(AUDIO.dry); m.connect(AUDIO.convolver);
    AUDIO.bus[id]=g;
  }
}
async function resumeAudio(){ const ctx=getAudio(); if(ctx.state==='suspended'){ try{ await ctx.resume(); }catch(_){ } } return ctx; }

/* GM Programs (global fallback) */
let GM_PROGRAM = parseInt(gmProgEl.value,10) || 48;

/* Per-chair A/B overrides for ALL sections → 32 chairs */
const GM_PROGRAMS_A = {
  vln1:48, vln2:49, violas:50, cellos:42, basses:34, harp:46, piano:0,
  flutes:73, oboes:68, clarinets:71, bassoons:70,
  trumpets:56, horns:60, trombones:58,
  perc:115, drums:118,
};
const GM_PROGRAMS_B = {
  vln1:49, vln2:50, violas:51, cellos:43, basses:33, harp:45, piano:1,
  flutes:72, oboes:69, clarinets:72, bassoons:69,
  trumpets:57, horns:61, trombones:59,
  perc:116, drums:117,
};

/* Alternation toggles for each section */
const ALT_TOGGLE = {}; // sec -> bool

/* Which program should this section use for THIS note? Alternates A/B every call */
function gmProgramForSection(sec){
  ALT_TOGGLE[sec] = !ALT_TOGGLE[sec];
  const A = (sec in GM_PROGRAMS_A) ? GM_PROGRAMS_A[sec] : GM_PROGRAM;
  const B = (sec in GM_PROGRAMS_B) ? GM_PROGRAMS_B[sec] : A;
  return ALT_TOGGLE[sec] ? B : A;
}

/* Program → synth shaping (osc approximation) */
function gmPresetFor(p){
  if(p>=32 && p<=39) return {wave:'sine', lp:800, q:0.8, a:0.006, d:0.12, s:0.85, r:0.20}; // Bass
  if(p<=7) return {wave:'triangle', lp:3200, q:0.7, a:0.003, d:0.12, s:0.0, r:0.2}; // Piano
  if(p>=40 && p<=55) return {wave:'sine', lp:2200, q:0.6, a:0.008, d:0.16, s:0.75, r:0.22}; // Strings
  if(p>=56 && p<=63) return {wave:'triangle', lp:2400, q:0.9, a:0.004, d:0.14, s:0.70, r:0.24}; // Brass
  if(p>=64 && p<=71) return {wave:'triangle', lp:2000, q:0.7, a:0.008, d:0.14, s:0.65, r:0.22}; // Reed
  if(p>=72 && p<=79) return {wave:'sine', lp:3000, q:0.5, a:0.006, d:0.12, s:0.55, r:0.20}; // Pipe
  if(p>=80 && p<=95) return {wave:'sawtooth', lp:2600, q:0.6, a:0.004, d:0.12, s:0.60, r:0.20}; // Synth
  if(p>=96 && p<=119) return {wave:'triangle', lp:1800, q:0.7, a:0.006, d:0.12, s:0.65, r:0.18}; // FX/Ethnic
  if(p>=120) return {wave:'noise', lp:6000, q:0.5, a:0.001, d:0.06, s:0.0, r:0.12}; // SFX
  return {wave:'sine', lp:2000, q:0.6, a:0.008, d:0.16, s:0.68, r:0.20};
}

/* Section → blend with per-chair GM program */
function sectionPreset(sec){
  let base;
  if(sec==='piano')    base={wave:'triangle',  lp:3200, q:0.7, a:0.002, d:0.12, s:0.0, r:0.20};
  else if(sec==='drums') base={wave:'noise',     lp:7000, q:0.6, a:0.001, d:0.08, s:0.0, r:0.12};
  else if(sec==='basses')base={wave:'sine',      lp:520,  q:0.8, a:0.008, d:0.10, s:0.8, r:0.16};
  else if(sec==='cellos')base={wave:'triangle',  lp:1100, q:0.7, a:0.010, d:0.18, s:0.78,r:0.22};
  else if(sec==='violas')base={wave:'triangle',  lp:1600, q:0.7, a:0.010, d:0.18, s:0.74,r:0.20};
  else if(sec==='vln1' || sec==='vln2') base={wave:'sine', lp:2600, q:0.6, a:0.008, d:0.14, s:0.7, r:0.18};
  else if(sec==='harp')  base={wave:'sine',      lp:2800, q:0.6, a:0.004, d:0.10, s:0.0, r:0.35};
  else if(sec==='flutes')base={wave:'sine',      lp:3000, q:0.5, a:0.006, d:0.10, s:0.55,r:0.18};
  else if(sec==='oboes') base={wave:'triangle',  lp:2200, q:0.7, a:0.009, d:0.16, s:0.6, r:0.2};
  else if(sec==='clarinets')base={wave:'triangle',lp:2000, q:0.7, a:0.010, d:0.16, s:0.6, r:0.2};
  else if(sec==='bassoons') base={wave:'sine',   lp:1200, q:0.8, a:0.010, d:0.18, s:0.7, r:0.22};
  else if(sec==='trumpets') base={wave:'triangle', lp:2400, q:0.9, a:0.004, d:0.12, s:0.65,r:0.22};
  else if(sec==='horns')    base={wave:'sine',     lp:1800, q:0.9, a:0.008, d:0.14, s:0.7, r:0.24};
  else if(sec==='trombones')base={wave:'sine',     lp:1400, q:0.9, a:0.006, d:0.16, s:0.75, r:0.26};
  else if(sec==='perc')     base={wave:'noise',    lp:6000, q:0.5, a:0.001, d:0.06, s:0.0, r:0.12};
  else base={wave:'sine',lp:2000,q:0.6,a:0.008,d:0.16,s:0.68,r:0.2};

  const gm=gmPresetFor(gmProgramForSection(sec));
  if(base.wave!=='noise' && gm){
    base={...base, wave:gm.wave, lp:gm.lp, q:gm.q, a:gm.a, d:gm.d, s:gm.s, r:gm.r};
  }
  return base;
}

function playSection(sec, midi, when, dur, gain){
  if(MUTE[sec] || (SOLO.on && SOLO.id!==sec)) return;
  const ctx=getAudio(), p=sectionPreset(sec);
  let src;
  if(p.wave==='noise'){
    const len=Math.max(1,Math.floor((dur+p.r)*ctx.sampleRate));
    const buf=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.06)); }
    src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
  }else{
    src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(midiHz(midi),when);
    src.start(when); src.stop(when+dur+p.r+0.05);
  }
  const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
  const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
  amp.gain.linearRampToValueAtTime(gain,when+p.a);
  amp.gain.linearRampToValueAtTime(gain*p.s,when+p.a+p.d);
  amp.gain.setValueAtTime(gain*p.s,when+dur);
  amp.gain.linearRampToValueAtTime(0.0003,when+dur+p.r);
  src.connect(biq); biq.connect(amp); amp.connect(AUDIO.bus[sec]);
  const dot=document.getElementById('dot-'+sec), chk=document.getElementById('chk-'+sec);
  if(dot){ dot.classList.remove('blink'); void dot.offsetWidth; dot.classList.add('blink'); }
  if(chk && !chk.classList.contains('checked')){ chk.classList.add('checked'); chk.textContent='✓'; }
}

/* CSV load */
btnLoadA.onclick=async()=>{ const f=csvA.files?.[0]; if(!f){alert("Select CSV for A");return;}
  try{A.events=parseCSV(await f.text());}catch(e){alert(e.message);return;}
  if(PICK_A.length===0) randomizeA();
  enforceBExclusion();
  setStatus(`A loaded: ${A.events.length} rows`);
  light(dotA,true);
  checkExportReady();
  markStage();
};
btnLoadB.onclick=async()=>{ const f=csvB.files?.[0]; if(!f){alert("Select CSV for B");return;}
  try{B.events=parseCSV(await f.text());}catch(e){alert(e.message);return;}
  if(PICK_B.length===0) randomizeB();
  setStatus(`B loaded: ${B.events.length} rows`);
  light(dotB,true);
  checkExportReady();
  markStage();
};

/* Conductor & musicalization */
function applyConductorPresetAndUI(){ applyConductorPreset(); }
composerEl.onchange=applyConductorPresetAndUI;

/* Family Opening bias */
let FAMILY_OPEN = { strings: 0, winds: 8, brass: 16, perc: 24 };
function familyOfSection(sec){
  if (['vln1','vln2','violas','cellos','basses','harp','piano'].includes(sec)) return 'strings';
  if (['flutes','oboes','clarinets','bassoons'].includes(sec)) return 'winds';
  if (['horns','trumpets','trombones'].includes(sec)) return 'brass';
  if (['perc','drums'].includes(sec)) return 'perc';
  return 'strings';
}
function summarizeOpenings(){ openSummary.textContent = `${FAMILY_OPEN.strings}, ${FAMILY_OPEN.winds}, ${FAMILY_OPEN.brass}, ${FAMILY_OPEN.perc}`; }
function randomIn(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randomizeFamilyOpening(){
  const s0 = 0, w0 = randomIn(6,14), b0 = randomIn(w0+4, Math.min(26, w0+14)), p0 = randomIn(b0+4, Math.min(36, b0+14));
  FAMILY_OPEN = { strings: s0, winds: w0, brass: b0, perc: p0 };
  summarizeOpenings();
  setStatus(`Family Opening randomized → ${openSummary.textContent} (S,W,B,P @ sec)`);
}
function resetFamilyOpening(){
  FAMILY_OPEN = { strings: 0, winds: 8, brass: 16, perc: 24 };
  summarizeOpenings();
  setStatus('Family Opening reset to default (0, 8, 16, 24).');
}
btnOpenRandom.onclick = randomizeFamilyOpening;
btnOpenReset.onclick  = resetFamilyOpening;

/* Selection helpers using Family Opening */
function activeSet(side){ return new Set((side==='A'?PICK_A:PICK_B).map(x=>x.id)); }
function densityCap(){ return Math.max(4, Math.round(10*PRESETS_PACE[PAC].density)); }
function cadenceBeats(BPM){
  const beat=60/ Math.max(40, Math.min(220, BPM));
  const pat=CADENCES[CAD].pattern;
  const hits=[];
  for(let t=0, i=0; t<=60; t+=beat, i++){
    hits.push({t:Math.min(60,t), on:pat[i % pat.length]});
  }
  return {beat, hits};
}
function sectionForSelected(midi,isBass,side,tSec){
  const chosen=activeSet(side);
  const allowed=[...chosen].filter(sec=>{
    const fam=familyOfSection(sec); const openAt=FAMILY_OPEN[fam] ?? 0;
    return tSec>=openAt;
  });
  const tryPick=(pool)=>pool.find(s=>allowed.includes(s)) || null;
  const byPitch=()=>{
    if(isBass || midi<=43) return tryPick(['basses','trombones','horns','piano']);
    if(midi<=55)          return tryPick(['cellos','violas','horns','piano']);
    if(midi<=64)          return tryPick(['violas','vln2','clarinets','piano']);
    if(midi<=76)          return tryPick(['vln2','vln1','flutes','oboes','clarinets','piano']);
    if(midi<=84)          return tryPick(['vln1','flutes','oboes','piano']);
    return tryPick(['flutes','vln1','clarinets','oboes','piano']);
  };
  const cand=byPitch();
  if(cand) return cand;
  if(allowed.length) return allowed[Math.floor(Math.random()*allowed.length)];
  const any=[...chosen];
  return any[Math.floor(Math.random()*any.length)] || 'vln1';
}

function musicalize(events, side){
  if(!events?.length) return [];
  const BPM = Math.round(parseFloat(bpmEl.value||"100") * PRESETS_PACE[PAC].bpmMul);
  const beat = 60/Math.max(40,Math.min(220,BPM));
  const qDiv=parseFloat(quantEl.value||"0.125"), grid=beat*4*qDiv;
  const swing=parseFloat(swingEl.value||"0"), human=parseFloat(humanEl.value||"0")/1000;
  const pcs=pcsFor(keyRootEl.value, keyModeEl.value);

  const lastBy=new Map(); const cap=densityCap(); let lastSec=-1, perSec=0;
  const out=[];
  for(const e of events){
    let q=Math.round(e.t/grid)*grid; if(grid<=beat/2+1e-6){ const pos=Math.round(q/grid); if(pos%2===1) q+=swing*grid*0.5; }
    q=Math.max(0,Math.min(60,q)); const secT=Math.floor(q); if(secT!==lastSec){ perSec=0; lastSec=secT; }
    const m=e.m? snapToScale(e.m,pcs):0; const b=e.b? snapToScale(e.b,pcs):0;
    const push=(midi,isBass)=>{
      if(!midi) return; const last=lastBy.get(midi)||-999; if(q-last<0.08) return; if(perSec>=cap) return;
      lastBy.set(midi,q); perSec++;
      const jitter=(Math.random()*2-1)*human, dur=isBass?0.45:0.28, base=isBass?0.9:0.76;
      const vel=Math.max(0.25,Math.min(1.0, base*(0.9+0.2*((midi/127)-0.5))));
      out.push({t:Math.max(0,Math.min(60,q+jitter)), midi:Math.round(midi), dur, vel, isBass, sec:sectionForSelected(midi,isBass,side,q)});
    };
    push(m,false); push(b,true);
  }
  const chosen=activeSet(side);
  const {beat:hbeat, hits}=cadenceBeats(BPM);
  if(chosen.has('perc') || chosen.has('drums')){
    const comp=CADENCES[CAD], sync=comp.sync||0;
    hits.forEach((h)=>{
      if(h.on){
        const sec=chosen.has('drums')?'drums':'perc';
        out.push({t:Math.max(0,Math.min(60,h.t + (Math.random()*2-1)*0.01)), midi:60, dur:0.09, vel:0.55, isBass:false, sec});
      }else if(Math.random()<sync){
        const sec=chosen.has('perc')?'perc':'drums';
        out.push({t:Math.max(0,Math.min(60,h.t + hbeat*0.5)), midi:67, dur:0.08, vel:0.45, isBass:false, sec});
      }
    });
  }
  return out.sort((a,b)=>a.t-b.t);
}
function buildSchedule(){ const a=musicalize(A.events,'A'); const b=musicalize(B.events,'B'); return [...a,...b].sort((x,y)=>x.t-y.t); }

/* Transport */
async function doPlay(){
  await resumeAudio();
  if(PICK_A.length===0) randomizeA();
  if(PICK_B.length===0) randomizeB();
  if(!A.events.length && !B.events.length){ alert("Load a CSV into A and/or B, or analyze audio and export CSV."); return; }
  schArr=buildSchedule(); if(!schArr.length){ alert("No notes in 0–60s."); return; }
  idx=0; t0=AUDIO.ctx.currentTime+0.06;
  if(idxTimer) clearInterval(idxTimer);
  idxTimer=setInterval(tick,25);
  conductor.style.animationPlayState='running';
  setStatus("Playing…");
  light(dotExport,true);
}
function tick(){
  const now=AUDIO.ctx.currentTime, horizon=now+LOOKAHEAD;
  while(idx<schArr.length){
    const e=schArr[idx]; const when=t0+e.t; if(when>horizon) break;
    playSection(e.sec, e.midi, when, e.dur, e.vel);
    idx++;
  }
  if(idx>=schArr.length){ clearInterval(idxTimer); idxTimer=null; setStatus("Finished."); conductor.style.animationPlayState='paused'; }
}
function stopAll(){ if(idxTimer){clearInterval(idxTimer); idxTimer=null;} setStatus("Stopped."); conductor.style.animationPlayState='paused'; }

/* Export WAV */
function checkExportReady(){
  const ready = (A.events && A.events.length) || (B.events && B.events.length) || (LAST_ANALYSIS.events && LAST_ANALYSIS.events.length);
  light(dotExport, !!ready);
}
btnExportAudio.onclick=async()=>{
  if(PICK_A.length===0) randomizeA();
  if(PICK_B.length===0) randomizeB();
  const sched = buildSchedule();
  if(!sched.length){ alert("No notes to export. Load CSV into A/B or analyze audio first."); return; }
  light(dotExport,true);

  const sampleRate=44100, duration=61;
  const ctx=new OfflineAudioContext(2, sampleRate*duration, sampleRate);

  function playOffline(sec, midi, when, dur, gain){
    /* Alternate per-note A/B here as well */
    ALT_TOGGLE[sec] = !ALT_TOGGLE[sec];
    const gm = gmPresetFor( ALT_TOGGLE[sec] ? (GM_PROGRAMS_B[sec] ?? GM_PROGRAM) : (GM_PROGRAMS_A[sec] ?? GM_PROGRAM) );

    // Derive same base as realtime
    let basePreset = sectionPreset(sec); // calls gmProgramForSection which toggles again
    // To avoid double toggle for export, reconstruct a neutral base and then apply gm shape:
    const baseShapes={
      piano:{wave:'triangle',lp:3200,q:0.7,a:0.002,d:0.12,s:0.0,r:0.20},
      drums:{wave:'noise',lp:7000,q:0.6,a:0.001,d:0.08,s:0.0,r:0.12},
      basses:{wave:'sine',lp:520,q:0.8,a:0.008,d:0.10,s:0.8,r:0.16},
      cellos:{wave:'triangle',lp:1100,q:0.7,a:0.010,d:0.18,s:0.78,r:0.22},
      violas:{wave:'triangle',lp:1600,q:0.7,a:0.010,d:0.18,s:0.74,r:0.20},
      vln1:{wave:'sine',lp:2600,q:0.6,a:0.008,d:0.14,s:0.7,r:0.18},
      vln2:{wave:'sine',lp:2600,q:0.6,a:0.008,d:0.14,s:0.7,r:0.18},
      harp:{wave:'sine',lp:2800,q:0.6,a:0.004,d:0.10,s:0.0,r:0.35},
      flutes:{wave:'sine',lp:3000,q:0.5,a:0.006,d:0.10,s:0.55,r:0.18},
      oboes:{wave:'triangle',lp:2200,q:0.7,a:0.009,d:0.16,s:0.6,r:0.2},
      clarinets:{wave:'triangle',lp:2000,q:0.7,a:0.010,d:0.16,s:0.6,r:0.2},
      bassoons:{wave:'sine',lp:1200,q:0.8,a:0.010,d:0.18,s:0.7,r:0.22},
      trumpets:{wave:'triangle',lp:2400,q:0.9,a:0.004,d:0.12,s:0.65,r:0.22},
      horns:{wave:'sine',lp:1800,q:0.9,a:0.008,d:0.14,s:0.7,r:0.24},
      trombones:{wave:'sine',lp:1400,q:0.9,a:0.006,d:0.16,s:0.75,r:0.26},
      perc:{wave:'noise',lp:6000,q:0.5,a:0.001,d:0.06,s:0.0,r:0.12}
    };
    basePreset = baseShapes[sec] || {wave:'sine',lp:2000,q:0.6,a:0.008,d:0.16,s:0.68,r:0.2};
    const p = (basePreset.wave!=='noise' && gm) ? {...basePreset, wave:gm.wave, lp:gm.lp, q:gm.q, a:gm.a, d:gm.d, s:gm.s, r:gm.r} : basePreset;

    let src;
    if(p.wave==='noise'){
      const len=Math.max(1,Math.floor((dur+p.r)*sampleRate));
      const buf=ctx.createBuffer(1,len,sampleRate);
      const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(sampleRate*0.06)); }
      src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
    }else{
      src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(midiHz(midi),when);
      src.start(when); src.stop(when+dur+p.r+0.05);
    }
    const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
    const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
    amp.gain.linearRampToValueAtTime(gain,when+p.a);
    amp.gain.linearRampToValueAtTime(gain*p.s,when+p.a+p.d);
    amp.gain.setValueAtTime(gain*p.s,when+dur);
    amp.gain.linearRampToValueAtTime(0.0003,when+dur+p.r);
    src.connect(biq); biq.connect(amp); amp.connect(ctx.destination);
  }

  /* Build schedule with realtime alternation but re-apply alternation freshly here */
  ALT_TOGGLE._exportSeed = true; // just a marker, no-op
  let t=0; // not used, just to keep scope
  // Schedule
  const schedClone = buildSchedule(); // uses realtime selection and alternation
  // For export we re-run alternation inside playOffline; just iterate:
  schedClone.forEach(e=>{ playOffline(e.sec, e.midi, e.t+0.02, e.dur, e.vel*0.9); });

  const rendered = await ctx.startRendering();
  const wavBlob = bufferToWav(rendered);
  const url = URL.createObjectURL(wavBlob);
  const a=document.createElement('a'); a.href=url; a.download='CST_Orchestra_60s.wav'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
};

function bufferToWav(buffer){
  const numOfChan = buffer.numberOfChannels;
  const length = buffer.length * numOfChan * 2 + 44;
  const ab = new ArrayBuffer(length);
  const view = new DataView(ab);
  let offset = 0;
  writeString(view, 0, 'RIFF'); view.setUint32(4, length - 8, true); writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
  view.setUint16(22, numOfChan, true); view.setUint32(24, buffer.sampleRate, true);
  view.setUint32(28, buffer.sampleRate * numOfChan * 2, true); view.setUint16(32, numOfChan * 2, true); view.setUint16(34, 16, true);
  writeString(view, 36, 'data'); view.setUint32(40, length - 44, true);
  offset = 44;
  for (let i = 0; i < buffer.length; i++){
    for (let ch = 0; ch < numOfChan; ch++){
      let s = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      offset += 2;
    }
  }
  return new Blob([ab], {type: 'audio/wav'});
}
function writeString(view, offset, string){ for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); }

/* Wire up */
btnLoadAudio.onclick=()=>audioFile.click();
btnAnalyze.onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
btnExport.onclick=()=>{ if(!LAST_ANALYSIS.events.length){ alert("Analyze audio first."); return; } downloadCSV("notes_60s.csv", toCSV(LAST_ANALYSIS.events)); };

btnRandomA.onclick=()=>{ randomizeA(); setStatus("A randomized (10). B adjusted to avoid overlap."); };
btnRandomB.onclick=()=>{ randomizeB(); setStatus("B randomized (6) from remaining instruments."); };

playBtn.onclick=doPlay;
stopBtn.onclick=stopAll;

/* FULL RESET */
resetBtn.onclick=()=>{
  stopAll();
  A={events:[]}; B={events:[]}; LAST_ANALYSIS={events:[],key:"C major",bpm:100};
  detKey.textContent='–'; detBPM.textContent='–';
  csvA.value=""; csvB.value=""; audioFile.value="";
  composerEl.value='cinematic'; keyRootEl.value='C'; keyModeEl.value='major';
  bpmEl.value='100'; quantEl.value='0.125'; swingEl.value='0.10'; humanEl.value='6';
  masterVolEl.value='0.85'; reverbMixEl.value='0.18'; spreadEl.value='0.55';
  gmProgEl.value='48'; GM_PROGRAM=48;
  applyConductorPreset();
  if(AUDIO.ctx){ AUDIO.master.gain.value=parseFloat(masterVolEl.value); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); buildBuses(); }
  CAD='even'; PAC='andante'; cadName.textContent='Even'; paceName.textContent='Andante';
  PICK_A=[]; PICK_B=[]; renderSide('A'); renderSide('B'); markStage();
  FAMILY_OPEN = { strings: 0, winds: 8, brass: 16, perc: 24 }; summarizeOpenings();
  for(const id of SECTIONS){
    const chk=CHK[id], dot=DOT[id];
    if(chk){ chk.classList.remove('checked'); chk.textContent=''; }
    if(dot){ dot.classList.remove('blink'); }
    MUTE[id]=false; ALT_TOGGLE[id]=false;
  }
  light(dotA,false); light(dotB,false); light(dotAnalyze,false); light(dotExport,false);
  setStatus("Ready.");
  updateConLabel();
  setPerChairFromUI(true);
};

/* Live mixers */
masterVolEl.oninput=()=>{ getAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); };
reverbMixEl.oninput=()=>{ getAudio(); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); };
spreadEl.oninput=()=>{ if(AUDIO.ctx){ try{AUDIO.ctx.close();}catch(_){ } AUDIO.ctx=null; } getAudio(); };

/* 32-chair inputs → maps */
function setPerChairFromUI(init=false){
  // helper
  const g=(id,def)=>clamp(parseInt($(id).value,10)||def,0,127);

  GM_PROGRAMS_A.vln1=g('gm_vln1_a',48); GM_PROGRAMS_B.vln1=g('gm_vln1_b',49);
  GM_PROGRAMS_A.vln2=g('gm_vln2_a',49); GM_PROGRAMS_B.vln2=g('gm_vln2_b',50);
  GM_PROGRAMS_A.violas=g('gm_violas_a',50); GM_PROGRAMS_B.violas=g('gm_violas_b',51);
  GM_PROGRAMS_A.cellos=g('gm_cellos_a',42); GM_PROGRAMS_B.cellos=g('gm_cellos_b',43);
  GM_PROGRAMS_A.basses=g('gm_basses_a',34); GM_PROGRAMS_B.basses=g('gm_basses_b',33);
  GM_PROGRAMS_A.harp=g('gm_harp_a',46);     GM_PROGRAMS_B.harp=g('gm_harp_b',45);
  GM_PROGRAMS_A.piano=g('gm_piano_a',0);    GM_PROGRAMS_B.piano=g('gm_piano_b',1);

  GM_PROGRAMS_A.flutes=g('gm_flutes_a',73); GM_PROGRAMS_B.flutes=g('gm_flutes_b',72);
  GM_PROGRAMS_A.oboes=g('gm_oboes_a',68);   GM_PROGRAMS_B.oboes=g('gm_oboes_b',69);
  GM_PROGRAMS_A.clarinets=g('gm_clarinets_a',71); GM_PROGRAMS_B.clarinets=g('gm_clarinets_b',72);
  GM_PROGRAMS_A.bassoons=g('gm_bassoons_a',70);   GM_PROGRAMS_B.bassoons=g('gm_bassoons_b',69);

  GM_PROGRAMS_A.trumpets=g('gm_trumpets_a',56); GM_PROGRAMS_B.trumpets=g('gm_trumpets_b',57);
  GM_PROGRAMS_A.horns=g('gm_horns_a',60);       GM_PROGRAMS_B.horns=g('gm_horns_b',61);
  GM_PROGRAMS_A.trombones=g('gm_trombones_a',58); GM_PROGRAMS_B.trombones=g('gm_trombones_b',59);

  GM_PROGRAMS_A.perc=g('gm_perc_a',115); GM_PROGRAMS_B.perc=g('gm_perc_b',116);
  GM_PROGRAMS_A.drums=g('gm_drums_a',118); GM_PROGRAMS_B.drums=g('gm_drums_b',117);

  if(!init) setStatus('Chair A/B sounds updated.');
}
[
 'gm_vln1_a','gm_vln1_b','gm_vln2_a','gm_vln2_b','gm_violas_a','gm_violas_b','gm_cellos_a','gm_cellos_b',
 'gm_basses_a','gm_basses_b','gm_harp_a','gm_harp_b','gm_piano_a','gm_piano_b','gm_flutes_a','gm_flutes_b',
 'gm_oboes_a','gm_oboes_b','gm_clarinets_a','gm_clarinets_b','gm_bassoons_a','gm_bassoons_b','gm_trumpets_a','gm_trumpets_b',
 'gm_horns_a','gm_horns_b','gm_trombones_a','gm_trombones_b','gm_perc_a','gm_perc_b','gm_drums_a','gm_drums_b'
].forEach(id=>{ const el=$(id); if(el){ el.onchange=()=>setPerChairFromUI(false); }});

/* Init */
(function init(){
  NOTE.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; if(n==='C') o.selected=true; keyRootEl.appendChild(o); });
  applyConductorPreset();
  updateConLabel();
  summarizeOpenings();
  randomizeA(); randomizeB();
  conductor.style.animationPlayState='paused';
  setStatus('Ready.');
  checkExportReady();
  markStage();
  setPerChairFromUI(true);
})();
</script>
</body>
</html>
