<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Dual Key Analyzer (60s) + General MIDI Playback</title>
<style>
  :root{
    --bg:#0a0f1f; --ink:#eaf1ff; --muted:#a8b7e3; --panel:#121a33; --line:#6ee7ff; --ok:#10b981; --warn:#f59e0b;
    --grid:#1b254b; --accent:#3b82f6; --danger:#ef4444; --white:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1240px;margin:0 auto;padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)}
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px;margin-top:8px}
  .stat b{color:var(--ok)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre;line-height:1.42}
  .scroller{max-height:300px;overflow:auto;border:1px solid var(--grid);border-radius:10px;padding:8px;background:#0c1430}
  canvas{width:100%;height:220px;background:#0c1430;border:1px solid #22306b;border-radius:10px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1c44;border:1px solid var(--grid);font-size:12px;color:var(--muted)}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .danger{background:#3b1220;border-color:#6b1f35}
  .whiteSquare{width:100%; height:40px; background:var(--white); color:#000; display:flex; align-items:center; justify-content:center;
    border-radius:8px; border:2px solid #ddd; cursor:pointer; user-select:none;}
  .whiteSquare.active{outline:3px solid #4f8cff; font-weight:700}
  .gmGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .gmItem{border:1px solid var(--grid);border-radius:10px;padding:8px;background:#0b1738;cursor:pointer}
  .gmItem:hover{filter:brightness(1.08)}
  .gmItem .name{font-size:12px;color:#cfe1ff}
  .gmItem .num{font-weight:700;color:#9ad1ff}
  .gmItem .cnt{font-size:12px;color:#9ee6c9}
  .panelTitle{display:flex;align-items:center;justify-content:space-between}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>CST — Dual Key Analyzer (60s) + GM SoundFont Playback</h1>
  <span class="pill">Real GM timbres • Better tuning • Stable pacing</span>
</header>

<main>
  <!-- LEFT: Controls & Dual Analyzer -->
  <section class="card">
    <label>Song A — Audio file (MP3/WAV/AAC/OGG)</label>
    <input id="fileA" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" />
    <div class="row" style="margin-top:10px">
      <button id="analyzeA">Analyze A (first 60s)</button>
      <div class="stat"><span>Key A</span><b id="keyA">–</b></div>
    </div>
    <div class="row">
      <div class="stat"><span>Frames A</span><b id="framesA">–</b></div>
      <div class="stat"><span>BPM A</span><b id="bpmA">–</b></div>
    </div>

    <div class="hr"></div>

    <label>Song B — Audio file (MP3/WAV/AAC/OGG)</label>
    <input id="fileB" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" />
    <div class="row" style="margin-top:10px">
      <button id="analyzeB">Analyze B (first 60s)</button>
      <div class="stat"><span>Key B</span><b id="keyB">–</b></div>
    </div>
    <div class="row">
      <div class="stat"><span>Frames B</span><b id="framesB">–</b></div>
      <div class="stat"><span>BPM B</span><b id="bpmB">–</b></div>
    </div>

    <div class="hr"></div>
    <div>
      <label>Speed (playback spacing)</label>
      <div class="row">
        <div class="whiteSquare" data-speed="0.8">Slow (0.8×)</div>
        <div class="whiteSquare active" data-speed="1.0">Medium (1.0×)</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="whiteSquare" data-speed="1.25">Fast (1.25×)</div>
        <div class="whiteSquare" data-speed="1.5">Very Fast (1.5×)</div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Mix A</label>
          <input id="mixA" type="range" min="0" max="1" step="0.01" value="0.85"/>
        </div>
        <div>
          <label>Mix B</label>
          <input id="mixB" type="range" min="0" max="1" step="0.01" value="0.70"/>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Master Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.75"/>
      </div>
      <div style="margin-top:8px">
        <label style="font-size:12px;color:#a8b7e3"><input id="snapScale" type="checkbox" checked/> Snap detected notes to detected key (major/minor)</label>
      </div>
    </div>

    <div class="hr"></div>
    <div class="btnRow">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
      <button id="resetBtn">Reset</button>
    </div>
  </section>

  <!-- RIGHT: Visuals & Instruments -->
  <section class="card">
    <label>Piano-roll (Song A + B, time → note)</label>
    <canvas id="roll" width="960" height="240"></canvas>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Detected notes (time, dominant, bass) — Click an instrument below to inspect</label>
        <div id="noteList" class="scroller mono"></div>
      </div>
      <div>
        <label>Pitch-class histograms (A & B)</label>
        <div class="row">
          <div id="histA" class="scroller mono" style="min-height:120px"></div>
          <div id="histB" class="scroller mono" style="min-height:120px"></div>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="panelTitle">
      <label style="margin:0">All GM Instruments (0–127)</label>
      <span class="pill" id="selInfo">Select an instrument to view notes</span>
    </div>
    <div id="gmGrid" class="gmGrid" style="margin-top:8px"></div>
  </section>
</main>

<!-- SoundFont player (GM samples) -->
<script src="https://unpkg.com/soundfont-player@0.15.7/dist/soundfont-player.js"></script>

<script>
/* ========= Helpers ========= */
const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
function hzToMidi(hz){ return 69 + 12*Math.log2(hz/440); }
function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }
function midiToName(m){ const n=Math.round(m); return NOTE_NAMES[(n%12+12)%12]+(Math.floor(n/12)-1); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function median(vals){ const s=[...vals].sort((a,b)=>a-b); const n=s.length; return n? (n%2? s[(n-1)/2] : 0.5*(s[n/2-1]+s[n/2])):0; }
function keyPc(name){ return NOTE_NAMES.indexOf(name.split(" ")[0]); }
function keyScalePcs(keyName){ const tonic=keyPc(keyName); if (tonic<0) return null; const isMinor=keyName.toLowerCase().includes("minor"); const base=isMinor?MINOR:MAJOR; return base.map(pc=>(pc+tonic+120)%12); }
function snapToScale(midi, pcs){
  if (!pcs) return midi;
  const pc=((Math.round(midi)%12)+12)%12;
  if (pcs.includes(pc)) return Math.round(midi);
  for (const d of [1,-1,2,-2]){ const cand=((pc+d)+12)%12; if (pcs.includes(cand)) return Math.round(midi)+d; }
  return Math.round(midi);
}

/* ========= GM program names for soundfont-player =========
   We map a subset directly; others fall back to acoustic_grand_piano. */
const GM_NAMES={
  0:'acoustic_grand_piano',1:'bright_acoustic_piano',2:'electric_grand_piano',4:'electric_piano_1',5:'electric_piano_2',
  40:'violin',41:'viola',42:'cello',43:'contrabass',46:'orchestral_harp',47:'timpani',
  48:'string_ensemble_1',49:'string_ensemble_2',
  56:'trumpet',57:'trombone',58:'tuba',60:'french_horn',
  71:'clarinet',68:'oboe',70:'bassoon',73:'flute',72:'piccolo',
  32:'acoustic_bass',33:'electric_bass_finger',34:'electric_bass_pick',35:'fretless_bass',
  52:'choir_aahs',53:'voice_oohs'
};
function gmName(program){ return GM_NAMES[program] || 'acoustic_grand_piano'; }

/* ========= UI refs ========= */
const fileA=document.getElementById('fileA'), fileB=document.getElementById('fileB');
const analyzeA=document.getElementById('analyzeA'), analyzeB=document.getElementById('analyzeB');
const keyAEl=document.getElementById('keyA'), keyBEl=document.getElementById('keyB');
const framesAEl=document.getElementById('framesA'), framesBEl=document.getElementById('framesB');
const bpmAEl=document.getElementById('bpmA'), bpmBEl=document.getElementById('bpmB');
const histAEl=document.getElementById('histA'), histBEl=document.getElementById('histB');
const roll=document.getElementById('roll'), rc=roll.getContext('2d');
const noteList=document.getElementById('noteList'), gmGrid=document.getElementById('gmGrid'), selInfo=document.getElementById('selInfo');
const speedSquares=[...document.querySelectorAll('.whiteSquare')];
const playBtn=document.getElementById('playBtn'), stopBtn=document.getElementById('stopBtn'), resetBtn=document.getElementById('resetBtn');
const snapScaleEl=document.getElementById('snapScale'), mixAEl=document.getElementById('mixA'), mixBEl=document.getElementById('mixB'), masterVolEl=document.getElementById('masterVol');

/* ========= Analyzer core ========= */
const KS_MAJOR=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MINOR=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlateKey(h){
  function norm(v){ const n=Math.hypot(...v); return v.map(x=>x/(n||1)); }
  const hh=norm(h); let best={name:"–",score:-1};
  for(let r=0;r<12;r++){
    const cm=KS_MAJOR.map((v,i)=>v*hh[(i+r)%12]).reduce((a,b)=>a+b,0);
    const cn=KS_MINOR.map((v,i)=>v*hh[(i+r)%12]).reduce((a,b)=>a+b,0);
    if (cm>best.score) best={name:`${NOTE_NAMES[r]} major`,score:cm};
    if (cn>best.score) best={name:`${NOTE_NAMES[r]} minor`,score:cn};
  }
  return best.name;
}
function autocorrPitch(frame, sr){
  const N=frame.length;
  let mean=0; for(let i=0;i<N;i++) mean+=frame[i]; mean/=N;
  let maxAbs=0;
  for(let i=0;i<N;i++){ frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1))); maxAbs=Math.max(maxAbs,Math.abs(frame[i])); }
  const clip=0.3*maxAbs;
  if (clip>0){ for(let i=0;i<N;i++){ if (frame[i]> clip) frame[i]-=clip; else if (frame[i]<-clip) frame[i]+=clip; else frame[i]=0; } }
  const minF=50,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag; lag<=Math.min(maxLag,N-3); lag++){ let s=0; for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if (s>best){best=s; bestLag=lag;} }
  if (bestLag>0){
    const l=bestLag; const c1=acf(frame,l-1), c2=acf(frame,l), c3=acf(frame,l+1); const denom=(c1-2*c2+c3);
    const shift = denom!==0 ? 0.5*(c1-c3)/denom : 0; const refined=l+shift; const f=sr/refined;
    if (isFinite(f)&&f>20&&f<2000) return f;
  }
  return 0;
  function acf(x,lag){ if (lag<1||lag>=x.length) return 0; let s=0; for(let i=0;i<x.length-lag;i++) s+=x[i]*x[i+lag]; return s; }
}
function estimateBPM(onsets, sr){
  if (onsets.length<3) return 100;
  const diffs=[]; for(let i=1;i<onsets.length;i++){ const dt=(onsets[i]-onsets[i-1])/sr; if (dt>0.2&&dt<2.0) diffs.push(dt); }
  if (!diffs.length) return 100;
  const med=diffs.sort((a,b)=>a-b)[Math.floor(diffs.length/2)];
  let bpm=Math.round(60/med);
  while (bpm<60) bpm*=2; while (bpm>180) bpm=Math.round(bpm/2);
  return bpm;
}

/* ========= State ========= */
let A={events:[], pclass:new Float32Array(12), key:"–", bpm:100};
let B={events:[], pclass:new Float32Array(12), key:"–", bpm:100};
let routed=initRouted(); let selectedProg=40;
function initRouted(){ const m=new Map(); for(let p=0;p<128;p++) m.set(p,[]); return m; }

/* ========= Visuals ========= */
function drawHist(el,h){
  const tot=Array.from(h).reduce((a,b)=>a+b,0)||1; let out="PC  %\n";
  for(let i=0;i<12;i++){ const pct=(h[i]/tot*100).toFixed(1).padStart(5,' '); out+=`${NOTE_NAMES[i].padEnd(2,' ')} ${pct}%\n`; }
  el.textContent=out;
}
function drawRoll(){
  const w=roll.width,h=roll.height; rc.clearRect(0,0,w,h);
  rc.strokeStyle="rgba(110,231,255,0.25)"; for(let i=0;i<=10;i++){ const x=(i/10)*w; rc.beginPath(); rc.moveTo(x,0); rc.lineTo(x,h); rc.stroke(); }
  const minM=36,maxM=84,span=maxM-minM; const yy=m=>h-((m-minM)/span)*h;
  A.events.forEach(e=>{ if(e.m){ const x=(e.t/60)*w; rc.fillStyle="rgba(110,231,255,0.9)"; rc.fillRect(x,yy(e.m)-3,3,6);} if(e.b){ const x=(e.t/60)*w; rc.fillStyle="rgba(16,185,129,0.9)"; rc.fillRect(x,yy(e.b)-4,4,8);} });
  B.events.forEach(e=>{ if(e.m){ const x=(e.t/60)*w; rc.fillStyle="rgba(255,206,86,0.9)"; rc.fillRect(x,yy(e.m)-2,2,4);} if(e.b){ const x=(e.t/60)*w; rc.fillStyle="rgba(255,99,132,0.9)"; rc.fillRect(x,yy(e.b)-3,3,6);} });
}
function renderGMGrid(){
  gmGrid.innerHTML="";
  for(let p=0;p<128;p++){
    const d=document.createElement('div'); d.className="gmItem";
    const cnt=routed.get(p).length;
    d.innerHTML=`<div class="num">#${p}</div><div class="name">${GMLabel(p)}</div><div class="cnt">notes: ${cnt}</div>`;
    d.onclick=()=>{ selectedProg=p; showInstrumentNotes(p); };
    gmGrid.appendChild(d);
  }
  showInstrumentNotes(selectedProg);
}
function GMLabel(p){ // compact label
  const names=[
"0 Acoustic Grand Piano","1 Bright Acoustic Piano","2 Electric Grand Piano","3 Honky-tonk Piano","4 Rhodes Piano","5 Chorused Piano","6 Harpsichord","7 Clavinet",
"8 Celesta","9 Glockenspiel","10 Music Box","11 Vibraphone","12 Marimba","13 Xylophone","14 Tubular Bells","15 Dulcimer",
"16 Hammond Organ","17 Percussive Organ","18 Rock Organ","19 Church Organ","20 Reed Organ","21 Accordion","22 Harmonica","23 Tango Accordion",
"24 Acoustic Nylon Guitar","25 Acoustic Steel Guitar","26 Electric Jazz Guitar","27 Electric Clean Guitar","28 Electric Muted Guitar","29 Overdriven Guitar","30 Distortion Guitar","31 Guitar Harmonics",
"32 Acoustic Bass","33 Electric Bass (Finger)","34 Electric Bass (Pick)","35 Fretless Bass","36 Slap Bass 1","37 Slap Bass 2","38 Synth Bass 1","39 Synth Bass 2",
"40 Violin","41 Viola","42 Cello","43 Contrabass","44 Tremolo Strings","45 Pizzicato Strings","46 Orchestral Harp","47 Timpani",
"48 String Ensemble 1","49 String Ensemble 2","50 Synth Strings 1","51 Synth Strings 2","52 Choir Aahs","53 Voice Oohs","54 Synth Voice","55 Orchestral Hit",
"56 Trumpet","57 Trombone","58 Tuba","59 Muted Trumpet","60 French Horn","61 Brass Section","62 Synth Brass 1","63 Synth Brass 2",
"64 Soprano Sax","65 Alto Sax","66 Tenor Sax","67 Baritone Sax","68 Oboe","69 English Horn","70 Bassoon","71 Clarinet",
"72 Piccolo","73 Flute","74 Recorder","75 Pan Flute","76 Bottle Blow","77 Shakuhachi","78 Whistle","79 Ocarina",
"80 Square Lead","81 Saw Lead","82 Calliope Lead","83 Chiff Lead","84 Charang Lead","85 Voice Lead","86 Fifths Lead","87 Bass Lead",
"88 New Age Pad","89 Warm Pad","90 Polysynth Pad","91 Choir Pad","92 Bowed Pad","93 Metallic Pad","94 Halo Pad","95 Sweep Pad",
"96 Rain","97 Soundtrack","98 Crystal","99 Atmosphere","100 Brightness","101 Goblins","102 Echoes","103 Sci-Fi",
"104 Sitar","105 Banjo","106 Shamisen","107 Koto","108 Kalimba","109 Bagpipe","110 Fiddle","111 Shanai",
"112 Tinkle Bell","113 Agogo","114 Steel Drums","115 Woodblock","116 Taiko Drum","117 Melodic Tom","118 Synth Drum","119 Reverse Cymbal",
"120 Guitar Fret Noise","121 Breath Noise","122 Seashore","123 Bird Tweet","124 Telephone Ring","125 Helicopter","126 Applause","127 Gun Shot"
]; return names[p]||(`#${p}`); }
function showInstrumentNotes(p){
  const arr=routed.get(p)||[];
  selInfo.textContent=`Instrument #${p} — ${GMLabel(p)} — ${arr.length} notes`;
  const lines=[]; for(const e of arr){ lines.push(`${e.t.toFixed(2).padStart(6,' ')}s   ${midiToName(e.midi).padEnd(5,' ')} (${e.midi})   from:${e.src}`); }
  noteList.textContent=lines.join("\n")||"(no notes)";
}
function renderNotePreview(){
  const lines=[" time     DOM_A   BASS_A    DOM_B   BASS_B"];
  const n=Math.max(A.events.length,B.events.length);
  for(let i=0;i<n;i++){
    const a=A.events[i]||{}, b=B.events[i]||{};
    const t=((a.t??b.t??0)).toFixed(2).padStart(6,' ');
    const ad=a.m?midiToName(a.m).padEnd(5,' '):" --  "; const ab=a.b?midiToName(a.b).padEnd(5,' '):" --  ";
    const bd=b.m?midiToName(b.m).padEnd(5,' '):" --  "; const bb=b.b?midiToName(b.b).padEnd(5,' '):" --  ";
    lines.push(`${t}s   ${ad}   ${ab}    ${bd}   ${bb}`); if (lines.length>200) break;
  }
  noteList.textContent=lines.join("\n");
}

/* ========= WebAudio + SoundFont ========= */
let AUDIO={ctx:null, master:null, comp:null, speed:1.0};
let gmCache=new Map();           // program -> instrument player
let activeVoices=[];             // array of {stop:Function}
function ensureAudio(){
  if (!AUDIO.ctx){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const comp=ctx.createDynamicsCompressor(); comp.threshold.value=-18; comp.knee.value=9; comp.ratio.value=3; comp.attack.value=0.005; comp.release.value=0.25;
    const master=ctx.createGain(); master.gain.value=parseFloat(masterVolEl.value||"0.75");
    comp.connect(master); master.connect(ctx.destination);
    AUDIO.ctx=ctx; AUDIO.comp=comp; AUDIO.master=master;
  }
  AUDIO.master.gain.value=parseFloat(masterVolEl.value||"0.75");
  return AUDIO.ctx;
}
async function getGM(program){
  const name=gmName(program);
  if (gmCache.has(program)) return gmCache.get(program);
  const ctx=ensureAudio();
  // MusyngKite soundfont is high-quality GM: instrument names match ones above
  const inst=await Soundfont.instrument(ctx, name, { soundfont: 'MusyngKite', gain: 0.9 });
  // Route through compressor/master
  inst.connect(AUDIO.comp);
  gmCache.set(program, inst);
  return inst;
}

/* ========= Routing rules ========= */
function routeEvent(t,midi,isBass,src){
  function push(p){ routed.get(p).push({t, midi, src}); }
  if (isBass || midi<=52){ [32,33,34,35,43].forEach(push); return; }
  if (midi>=53 && midi<=72){ [41,42,60,71,48].forEach(push); return; }
  [40,73,56,72,0,48].forEach(push);
}
function rerouteAll(){
  routed=initRouted();
  A.events.forEach(ev=>{ if(ev.m) routeEvent(ev.t,ev.m,false,'A'); if(ev.b) routeEvent(ev.t,ev.b,true,'A'); });
  B.events.forEach(ev=>{ if(ev.m) routeEvent(ev.t,ev.m,false,'B'); if(ev.b) routeEvent(ev.t,ev.b,true,'B'); });
}

/* ========= Build schedule (quantize + density) ========= */
function buildSchedule(){
  const sch=[];
  function addSide(side){
    const evs=(side==='A'?A.events:B.events);
    const bpm=(side==='A'?A.bpm:B.bpm)||100;
    const spb=60/bpm, grid=spb/4; // 1/16th
    const lastByPitch=new Map();
    for (const e of evs){
      if (!e.m && !e.b) continue;
      const tQ=Math.max(0,Math.min(60,Math.round(e.t/grid)*grid));
      const add=(m,isBass)=>{
        if (!m) return;
        const last=lastByPitch.get(m)||-999;
        if (tQ-last<0.09) return; // density limit
        lastByPitch.set(m,tQ);
        sch.push({t:tQ, midi:Math.round(m), src:side, isBass});
      };
      add(e.m,false); add(e.b,true);
    }
  }
  addSide('A'); addSide('B');
  // assign programs by range/family at play time (to reduce duplication here)
  return sch.filter(x=>x.t>=0&&x.t<60).sort((a,b)=>a.t-b.t);
}

/* ========= Playback with GM ========= */
function programsFor(midi,isBass){
  if (isBass || midi<=52) return [32,33,34,35,43];
  if (midi>=53 && midi<=72) return [41,42,60,71,48];
  return [40,73,56,72,0,48];
}
async function play(){
  stopAll(); ensureAudio();
  const sch=buildSchedule();
  if (!sch.length){ alert("No notes yet. Analyze A and/or B first."); return; }

  // Preload needed instruments (speeds up during playback)
  const needed=new Set();
  for (const e of sch){ for (const p of programsFor(e.midi,e.isBass)) needed.add(p); }
  await Promise.all([...needed].map(p=>getGM(p)));

  const start=AUDIO.ctx.currentTime;
  const speed=AUDIO.speed||1.0;
  const mixA=parseFloat(mixAEl.value||"0.85"), mixB=parseFloat(mixBEl.value||"0.7");

  for (const e of sch){
    const when = (e.t) * (1/speed);
    const dur = (e.midi<=52? 0.55:0.35) * (1/speed);
    const vel = (e.midi<=52? 0.95:0.80) * (e.src==='A'? mixA : mixB);
    const progs = programsFor(e.midi,e.isBass);

    // To avoid ultra-thick doubling, pick up to 2 programs per event
    const pick = progs.slice(0,2);
    for (const p of pick){
      const inst = await getGM(p);
      // play returns a source with a stop() we can store
      const src = inst.play(e.midi, start + when, {duration: dur, gain: vel});
      activeVoices.push(src);
    }
  }
}
function stopAll(){
  // stop scheduled voices
  for (const v of activeVoices){ try{ v.stop(); }catch(_){ } }
  activeVoices.length=0;
}

/* ========= Analysis (with smoothing, snapping, BPM) ========= */
async function analyze(file, side){
  if (!file){ alert(`Choose audio for Song ${side}.`); return; }
  const arrBuf=await file.arrayBuffer();
  const ac=new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,44100*120,44100);
  let buf; try{ buf=await ac.decodeAudioData(arrBuf.slice(0)); } catch(e){ alert("Could not decode audio."); return; }
  const sr=buf.sampleRate, ch=buf.numberOfChannels, mono=new Float32Array(buf.length);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<d.length;i++) mono[i]=(mono[i]||0)+d[i]/ch; }
  const frame=4096, hop=2048, total=mono.length, maxS=Math.min(total,sr*60);
  const out=[], pclass=new Float32Array(12), onsets=[];

  let prevE=0;
  for(let st=0; st+frame<=maxS; st+=hop){
    const fr=mono.subarray(st,st+frame).slice();
    let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if (dE>0.12) onsets.push(st);
    const f0=autocorrPitch(fr,sr);
    let m=0,b=0;
    if (f0>0){
      m=clamp(Math.round(hzToMidi(f0)),24,100);
      if (f0<=200) b=clamp(Math.round(hzToMidi(f0)),20,80);
      pclass[((Math.round(m)%12)+12)%12]+=1;
    }
    out.push({t:st/sr, m, b});
  }
  // median smoothing (window 5)
  function smooth(list,key){ const win=5, half=2; const arr=list.map(e=>e[key]||0), sm=[];
    for(let i=0;i<arr.length;i++){ const winVals=[]; for(let k=Math.max(0,i-half); k<=Math.min(arr.length-1,i+half); k++) if(arr[k]) winVals.push(arr[k]); sm[i]=winVals.length?Math.round(median(winVals)):0; }
    for(let i=0;i<list.length;i++) list[i][key]=sm[i];
  }
  smooth(out,'m'); smooth(out,'b');

  // key + snap
  const smh=new Float32Array(12);
  for(let i=0;i<12;i++){ const a=pclass[(i+11)%12], b=pclass[i], c=pclass[(i+1)%12]; smh[i]=(a+2*b+c)/4; }
  const keyName=correlateKey(Array.from(smh));
  const pcs=keyScalePcs(keyName);
  if (snapScaleEl.checked){ for (const e of out){ if(e.m) e.m=snapToScale(e.m,pcs); if(e.b) e.b=snapToScale(e.b,pcs); } }

  const bpm=estimateBPM(onsets,sr);

  if (side==='A'){ A={events:out, pclass, key:keyName, bpm}; framesAEl.textContent=String(out.length); keyAEl.textContent=keyName; bpmAEl.textContent=`${bpm}`; }
  else{ B={events:out, pclass, key:keyName, bpm}; framesBEl.textContent=String(out.length); keyBEl.textContent=keyName; bpmBEl.textContent=`${bpm}`; }

  rerouteAll(); drawRoll(); drawHist(side==='A'?histAEl:histBEl, pclass); renderGMGrid(); renderNotePreview();
}

/* ========= Wire up ========= */
analyzeA.onclick=()=>analyze(fileA.files?.[0],'A');
analyzeB.onclick=()=>analyze(fileB.files?.[0],'B');
speedSquares.forEach(sq=>{ sq.onclick=()=>{ speedSquares.forEach(x=>x.classList.remove('active')); sq.classList.add('active'); AUDIO.speed=parseFloat(sq.dataset.speed)||1.0; }; });
document.getElementById('masterVol').oninput=()=>{ ensureAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); };
mixAEl.oninput=()=>rerouteAll(); mixBEl.oninput=()=>rerouteAll();
playBtn.onclick=()=>play();
stopBtn.onclick=()=>stopAll();
resetBtn.onclick=()=>{
  stopAll();
  A={events:[],pclass:new Float32Array(12),key:"–",bpm:100};
  B={events:[],pclass:new Float32Array(12),key:"–",bpm:100};
  keyAEl.textContent='–'; keyBEl.textContent='–'; framesAEl.textContent='–'; framesBEl.textContent='–'; bpmAEl.textContent='–'; bpmBEl.textContent='–';
  histAEl.textContent=''; histBEl.textContent=''; noteList.textContent='';
  routed=initRouted(); renderGMGrid(); drawRoll(); fileA.value=""; fileB.value="";
};

/* ========= Init ========= */
(function init(){ renderGMGrid(); drawRoll(); AUDIO.speed=1.0; })();
</script>
</body>
</html>
