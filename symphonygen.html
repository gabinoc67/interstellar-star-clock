<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Orchestral Mixer — Continuous Tokens (Classic Order)</title>
<meta name="description" content="Select orchestra instruments, tick preset tokens, set BPM & pattern length, then Generate. Notes repeat across the full minute and mix with your beat or metronome."/>
<style>
  :root{
    --bg:#081022; --panel:#0f1636; --ink:#e9f1ff; --muted:#9fb2e4; --grid:#1a2658; --btn:#1b2a6b;
    --ok:#10b981; --warn:#f59e0b; --line:#6ee7ff;
    --str:#8bc6ff; --ww:#b8ffda; --br:#ffd599; --pc:#ff9aa2; --pn:#d0b3ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 6px;font-size:26px}
  h2{margin:0 0 8px;font-size:18px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:16px}

  .panel{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:16px;margin-bottom:14px}
  .controls{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:12px;margin:10px 0}
  .btn{background:var(--btn);border:1px solid var(--grid);color:var(--ink);border-radius:12px;padding:14px 16px;font-weight:800;font-size:16px;cursor:pointer}
  .btn.secondary{background:#173076}
  .btn.warn{background:#4d2f03;border-color:#7a4b07}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type="file"],input[type="number"]{background:#0b1432;border:1px solid var(--grid);color:var(--ink);border-radius:10px;padding:12px;font-size:15px;width:100%}
  .small{font-size:13px;color:var(--muted)}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{border:1px solid var(--grid);border-radius:999px;padding:6px 12px;font-size:12px;display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.str{background:var(--str)} .dot.ww{background:var(--ww)} .dot.br{background:var(--br)} .dot.pc{background:var(--pc)} .dot.pn{background:var(--pn)}

  .timeline{height:120px;background:#0b1432;border:1px solid var(--grid);border-radius:12px;position:relative;overflow:hidden}
  .gridline{position:absolute;top:0;bottom:0;width:1px;background:#1a2658}
  .marker{position:absolute;top:0;bottom:0;width:4px;background:var(--line);box-shadow:0 0 14px var(--line)}
  .label{position:absolute;top:8px;font-size:11px;color:var(--muted)}
  .band{position:absolute;top:0;bottom:0;opacity:.16}
  .band.str{background:var(--str)} .band.ww{background:var(--ww)} .band.br{background:var(--br)} .band.pc{background:var(--pc)} .band.pn{background:var(--pn)}

  .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .lamp{width:14px;height:14px;border-radius:50%;background:#394b7a}
  .lamp.on{background:var(--ok);box-shadow:0 0 10px var(--ok)}

  /* Instrument grid */
  .groups{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:1100px){ .groups{grid-template-columns:1fr} }
  .igroup{border:1px solid var(--grid);border-radius:12px;padding:12px}
  .igroup h3{margin:0 0 10px;font-size:16px}
  .irow{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed #182454}
  .irow:last-child{border-bottom:none}
  .irow .name{display:flex;align-items:center;gap:10px}
  .tokens{display:flex;flex-wrap:wrap;gap:8px}
  .token{display:flex;align-items:center;gap:6px;border:1px solid var(--grid);border-radius:999px;padding:6px 10px;font-size:12px}
  .token input{transform:scale(1.15)}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:700px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Orchestral Mixer — Continuous Tokens</h1>
  <div class="sub">Classic entrances: <b>Strings 0s</b> → <b>Woodwinds 10s</b> → <b>Brass 20s</b> → <b>Percussion 35s</b> → <b>Keyboards/Organ 45s</b>. Tokens repeat across the full minute.</div>

  <!-- Transport -->
  <div class="panel">
    <h2>Transport</h2>
    <div class="controls">
      <button id="btnPlay" class="btn">PLAY</button>
      <button id="btnStop" class="btn" disabled>STOP</button>
      <button id="btnReset" class="btn secondary">RESET</button>
      <input id="fileBeat" type="file" accept="audio/*" title="Upload a looped beat (WAV/MP3)"/>
      <button id="btnMetronome" class="btn">Use Metronome</button>
      <button id="btnLoop" class="btn" title="Loop after 60s">Loop Off</button>
    </div>
    <div class="small">Tip: upload your beat (e.g., <i>notesbeat.wav</i>). If none, press <b>Use Metronome</b> (120 BPM).</div>

    <div class="legend">
      <span class="pill"><span class="dot str"></span>Strings @ 0s</span>
      <span class="pill"><span class="dot ww"></span>Woodwinds @ 10s</span>
      <span class="pill"><span class="dot br"></span>Brass @ 20s</span>
      <span class="pill"><span class="dot pc"></span>Percussion @ 35s</span>
      <span class="pill"><span class="dot pn"></span>Keys/Organ @ 45s</span>
    </div>

    <div class="timeline" id="timeline"><div class="marker" id="playhead" style="left:0%"></div></div>

    <div class="bar" style="margin-top:10px">
      <span class="small"><span class="lamp" id="lampAudio"></span> Audio</span>
      <span class="small"><span class="lamp" id="lampBeat"></span> Beat</span>
      <span class="small"><span class="lamp" id="lampPlaying"></span> Playing</span>
      <span class="small" id="txtTime">t = 0.0s</span>
      <span class="small" id="txtMsg"></span>
    </div>
  </div>

  <!-- Global rhythm -->
  <div class="panel">
    <h2>Global Rhythm</h2>
    <div class="grid2">
      <div>
        <label class="small">BPM (beats per minute)</label>
        <input id="inpBPM" type="number" min="40" max="220" value="120"/>
      </div>
      <div>
        <label class="small">Pattern Length (beats) — tokens repeat every N beats</label>
        <input id="inpBeats" type="number" min="1" max="32" value="4"/>
      </div>
    </div>
  </div>

  <!-- Instruments + tokens -->
  <div class="panel">
    <h2>Select Instruments & Tokens</h2>
    <div id="groups" class="groups"><!-- built by JS --></div>
    <div class="bar">
      <button id="btnGenerate" class="btn">GENERATE (Schedule & Start)</button>
      <button id="btnClear" class="btn warn">Clear Selection</button>
    </div>
    <div class="small" style="margin-top:6px">
      Tokens: <b>C6:0:0.6</b>, <b>E6:1:0.6</b>, <b>G6:2:0.8</b> (pitched) • Drums use <b>K</b>=kick, <b>S</b>=snare, <b>H</b>=hat.
    </div>
  </div>
</div>
<script>
(() => {
  const DURATION = 60;
  const CLASSIC_ORDER = [
    { key:'strings',   start: 0,  color:'var(--str)'},
    { key:'woodwinds', start:10,  color:'var(--ww)'},
    { key:'brass',     start:20,  color:'var(--br)'},
    { key:'perc',      start:35,  color:'var(--pc)'},
    { key:'piano',     start:45,  color:'var(--pn)'},
  ];
  const ORCH = {
    strings:["Violin I","Violin II","Viola","Cello","Double Bass","Harp"],
    woodwinds:["Flute","Piccolo","Oboe","English Horn","Clarinet","Bass Clarinet","Bassoon","Contrabassoon","Saxophone"],
    brass:["Horn","Trumpet","Trombone","Bass Trombone","Tuba","Euphonium","Wagner Tuba"],
    perc:["Kick","Snare","Hi-hat","Timpani","Cymbals","Triangle","Glockenspiel","Xylophone","Tambourine","Gong","Chimes"],
    piano:["Piano","Celesta","Harpsichord","Organ"]
  };
  // Tokens for every instrument (same three)
  const DEFAULT_TOKENS = ["C6:0:0.6","E6:1:0.6","G6:2:0.8"];

  // DOM
  const btnPlay = document.getElementById('btnPlay');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnLoop = document.getElementById('btnLoop');
  const fileBeat = document.getElementById('fileBeat');
  const btnMetronome = document.getElementById('btnMetronome');
  const txtTime = document.getElementById('txtTime');
  const txtMsg = document.getElementById('txtMsg');
  const playhead = document.getElementById('playhead');
  const timeline = document.getElementById('timeline');
  const lampAudio = document.getElementById('lampAudio');
  const lampBeat = document.getElementById('lampBeat');
  const lampPlaying = document.getElementById('lampPlaying');

  const inpBPM = document.getElementById('inpBPM');
  const inpBeats = document.getElementById('inpBeats');

  let ctx=null, master=null, startTime=0, isPlaying=false, loopEnabled=false;
  let beatBuffer=null, beatGain=null, usingMetronome=false;

  function ensureAudio(){
    if (ctx) return;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value=0.95; master.connect(ctx.destination);
    beatGain = ctx.createGain(); beatGain.gain.value=0.9; beatGain.connect(master);
    lampAudio.classList.add('on');
  }
  function hardReset(){ if(!ctx) return; try{ctx.close()}catch{} ctx=null; }
  function setTransport(playing){ isPlaying=playing; btnStop.disabled=!playing; lampPlaying.classList.toggle('on', playing); }

  fileBeat.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; ensureAudio();
    try{ const arr=await f.arrayBuffer(); beatBuffer=await ctx.decodeAudioData(arr); usingMetronome=false; lampBeat.classList.add('on'); txtMsg.textContent='Beat loaded'; }
    catch{ txtMsg.textContent='Could not decode audio'; }
  });
  btnMetronome.onclick=()=>{ ensureAudio(); beatBuffer=null; usingMetronome=true; lampBeat.classList.add('on'); txtMsg.textContent='Metronome beat enabled (120 BPM)'; };

  btnPlay.onclick=async()=>{ ensureAudio(); await ctx.resume(); if(isPlaying) return;
    setTransport(true); txtMsg.textContent='Playing…';
    startTime=ctx.currentTime; scheduleOneMinute(startTime); startUITimer();
  };
  btnStop.onclick=()=>{ setTransport(false); hardReset(); txtMsg.textContent='Stopped'; };
  btnReset.onclick=()=>{ setTransport(false); hardReset(); playhead.style.left='0%'; txtTime.textContent='t = 0.0s'; txtMsg.textContent='Reset'; };
  btnLoop.onclick=()=>{ loopEnabled=!loopEnabled; btnLoop.textContent= loopEnabled ? 'Loop On' : 'Loop Off'; };

  function scheduleOneMinute(t0){
    scheduleBeat(t0);
    scheduleCurrentSelection(t0);
    const stopAt=t0+DURATION;
    setTimeout(()=>{ if(!loopEnabled){ setTransport(false); hardReset(); } else { startTime=ctx.currentTime; scheduleOneMinute(startTime); }}, Math.max(0,(stopAt-ctx.currentTime)*1000));
  }
  function scheduleBeat(t0){
    if (!ctx) return;
    if (beatBuffer){
      const src=ctx.createBufferSource(); src.buffer=beatBuffer; src.loop=true; src.connect(beatGain); src.start(t0); src.stop(t0+DURATION+0.05);
    }else if(usingMetronome){
      const bpm=120, spb=60/bpm; for(let t=0;t<DURATION;t+=spb) metronomeTick(t0+t);
    }
  }
  function metronomeTick(at){
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.value=2000;
    g.gain.value=0.0001; o.connect(g).connect(beatGain);
    g.gain.setValueAtTime(0.0001, at); g.gain.exponentialRampToValueAtTime(0.3, at+0.001); g.gain.exponentialRampToValueAtTime(0.0001, at+0.05);
    o.start(at); o.stop(at+0.06);
  }

  // ======= Synthesis =======
  const NOTE_INDEX = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
  function noteToFreq(name){
    const m=String(name).toUpperCase().match(/^([A-G](?:#|B)?)(-?\d)$/); if(!m) return 440;
    const p=m[1], o=parseInt(m[2],10); const idx=NOTE_INDEX[p]??0; const n=idx+(o+1)*12; return 440*Math.pow(2,(n-69)/12);
  }
  function tone(section,f,at,dur){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=(section==='strings')?'sawtooth':(section==='brass')?'square':(section==='woodwinds')?'sine':'triangle';
    o.frequency.value=f; g.gain.value=0.0001; o.connect(g).connect(master);
    g.gain.setValueAtTime(0.0001, at); g.gain.exponentialRampToValueAtTime(0.28, at+0.02); g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }
  function kick(at){ const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(120, at); o.frequency.exponentialRampToValueAtTime(40, at+0.1); g.gain.setValueAtTime(0.0001, at); g.gain.exponentialRampToValueAtTime(0.9, at+0.005); g.gain.exponentialRampToValueAtTime(0.0001, at+0.18); o.connect(g).connect(master); o.start(at); o.stop(at+0.2); }
  function snare(at){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.15, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; n.buffer=b; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.9; const g=ctx.createGain(); g.gain.setValueAtTime(0.0001, at); g.gain.exponentialRampToValueAtTime(0.6, at+0.005); g.gain.exponentialRampToValueAtTime(0.0001, at+0.12); n.connect(bp).connect(g).connect(master); n.start(at); n.stop(at+0.13); }
  function hat(at){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.06, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; n.buffer=b; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.6; const g=ctx.createGain(); g.gain.setValueAtTime(0.0001, at); g.gain.exponentialRampToValueAtTime(0.35, at+0.003); g.gain.exponentialRampToValueAtTime(0.0001, at+0.06); n.connect(hp).connect(g).connect(master); n.start(at); n.stop(at+0.07); }

  // ======= Selection → schedule (continuous) =======
  function scheduleCurrentSelection(t0){
    const bpm = Math.max(40, Math.min(220, parseFloat(inpBPM.value)||120));
    const beatsPerPattern = Math.max(1, Math.min(32, parseFloat(inpBeats.value)||4));
    const spb = 60 / bpm;

    // for each instrument row that is checked
    document.querySelectorAll('.irow input[type="checkbox"][data-inst]').forEach(cb=>{
      if (!cb.checked) return;
      const inst = cb.dataset.inst;
      const section = cb.dataset.section;
      const sectionStart = CLASSIC_ORDER.find(x=>x.key===section)?.start || 0;

      // collect its three token checkboxes
      const tokens = Array.from(document.querySelectorAll(`.token input[data-inst="${cssSafe(inst)}"]`))
        .filter(tcb=>tcb.checked)
        .map(tcb => tcb.value); // "C6:0:0.6" etc.

      // repeat tokens every pattern across the section's active window
      const windowStart = sectionStart;
      const windowEnd = DURATION;
      for (let baseBeat = 0; ; baseBeat += beatsPerPattern){
        const atWindow = t0 + windowStart + baseBeat * spb;
        if (atWindow >= t0 + windowEnd) break;

        for (const tok of tokens){
          const [n, bStr, dStr] = tok.split(':');
          const evAt = atWindow + parseFloat(bStr) * spb;
          const evDur = Math.max(0.05, parseFloat(dStr) * spb);
          if (evAt >= t0 + windowEnd) continue;

          if (section === 'perc' && /kick/i.test(inst)) kick(evAt);
          else if (section === 'perc' && /snare/i.test(inst)) snare(evAt);
          else if (section === 'perc' && /hat|hi-hat/i.test(inst)) hat(evAt);
          else {
            const freq = /^[A-G]/i.test(n) ? noteToFreq(n) : 440;
            tone(section, freq, evAt, evDur);
          }
        }
        // avoid infinite loop if pattern is huge
        if (baseBeat * spb > DURATION + 1) break;
      }
    });
  }

  function cssSafe(s){ return s.replace(/[^a-z0-9_-]/gi,'_'); }

  // ======= UI timer =======
  let uiTimer=null;
  function startUITimer(){
    clearInterval(uiTimer);
    uiTimer=setInterval(()=>{
      if (!ctx) return;
      const t=Math.max(0, ctx.currentTime - startTime);
      const clamped=Math.min(DURATION,t);
      txtTime.textContent=`t = ${clamped.toFixed(1)}s`;
      playhead.style.left=`${(clamped/DURATION)*100}%`;
      if (t>=DURATION && !isPlaying){ clearInterval(uiTimer); }
    }, 50);
  }

  // expose for part 4
  window.__AIMIXER__ = { DURATION, CLASSIC_ORDER, ORCH, DEFAULT_TOKENS, ensureAudio, scheduleOneMinute, startUITimer, setTransport, cssSafe };
})();
</script>
<script>
(() => {
  const { DURATION, CLASSIC_ORDER, ORCH, DEFAULT_TOKENS, ensureAudio, scheduleOneMinute, startUITimer, setTransport, cssSafe } = window.__AIMIXER__;

  // Build instrument grid
  const groups = document.getElementById('groups');
  const orderKeys=['strings','woodwinds','brass','perc','piano'];
  const titles={strings:'Strings',woodwinds:'Woodwinds',brass:'Brass',perc:'Percussion',piano:'Keyboards / Organ'};

  function makeTokenChip(inst, tok){
    const label=document.createElement('label'); label.className='token';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=tok; cb.dataset.inst=cssSafe(inst); cb.checked=true;
    const span=document.createElement('span'); span.textContent=tok;
    label.appendChild(cb); label.appendChild(span);
    return label;
  }
  function buildGroups(){
    groups.innerHTML='';
    orderKeys.forEach(key=>{
      const box=document.createElement('div'); box.className='igroup';
      const h=document.createElement('h3'); h.textContent=titles[key]; box.appendChild(h);
      ORCH[key].forEach(inst=>{
        const row=document.createElement('div'); row.className='irow';
        const left=document.createElement('div'); left.className='name';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.inst=inst; cb.dataset.section=key; cb.id='cb_'+cssSafe(inst);
        const lab=document.createElement('label'); lab.htmlFor=cb.id; lab.textContent=inst;
        left.appendChild(cb); left.appendChild(lab);
        const right=document.createElement('div'); right.className='tokens';
        DEFAULT_TOKENS.forEach(tok=> right.appendChild(makeTokenChip(inst, tok)));
        row.appendChild(left); row.appendChild(right); box.appendChild(row);
      });
      groups.appendChild(box);
    });
  }
  buildGroups();

  // Timeline draw
  const timeline=document.getElementById('timeline'); const playhead=document.getElementById('playhead');
  function W(){ return timeline.clientWidth; }
  function initTimeline(){
    timeline.querySelectorAll('.gridline,.label,.band').forEach(n=>n.remove());
    CLASSIC_ORDER.forEach(sec=>{
      const band=document.createElement('div');
      band.className=`band ${sec.key==='strings'?'str':sec.key==='woodwinds'?'ww':sec.key==='brass'?'br':sec.key==='perc'?'pc':'pn'}`;
      band.style.left=(sec.start/DURATION)*100+'%';
      band.style.width=((DURATION-sec.start)/DURATION)*100+'%';
      timeline.appendChild(band);
    });
    for(let s=0;s<=DURATION;s+=5){
      const x=(s/DURATION)*W();
      const gl=document.createElement('div'); gl.className='gridline'; gl.style.left=(x|0)+'px'; timeline.appendChild(gl);
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=s+'s';
      lab.style.left=`calc(${(s/DURATION)*100}% + 4px)`; timeline.appendChild(lab);
    }
  }
  initTimeline(); window.addEventListener('resize', initTimeline);

  // Buttons
  document.getElementById('btnGenerate').addEventListener('click', async ()=>{
    ensureAudio(); // scheduleOneMinute reads the current checkbox state
    document.getElementById('btnStop').disabled=false;
    document.getElementById('btnPlay').click(); // PLAY triggers schedule & timer
    document.getElementById('txtMsg').textContent='Generated & playing…';
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.querySelectorAll('.irow input[type="checkbox"]').forEach(cb=> cb.checked=false);
    document.getElementById('txtMsg').textContent='Selection cleared';
  });

  // Transport UI small hooks
  document.getElementById('btnPlay').addEventListener('click', ()=> startUITimer());
  document.getElementById('btnStop').addEventListener('click', ()=> { document.getElementById('txtMsg').textContent='Stopped'; });
  document.getElementById('btnReset').addEventListener('click', ()=> { playhead.style.left='0%'; document.getElementById('txtTime').textContent='t = 0.0s'; });

})();
</script>
</body>
</html>
