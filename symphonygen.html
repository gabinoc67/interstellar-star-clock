<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Orchestral Stage (Semi-Circle) + Composer-Guided CSV Player (60s)</title>
<style>
  :root{
    --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758; --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --tile:#0b1738; --tile2:#0d1a40; --white:#fff;
    --blink:#6ee7ff; --check:#72ffa6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  h1{font-size:18px;margin:0}
  main{max-width:1280px;margin:0 auto;padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"],input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
  }
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
  .stat b{color:var(--ok)}
  #status{font-size:12px;color:#9ad1ff;margin-top:8px}
  .danger{background:#3b1220;border-color:#6b1f35}

  /* ===== Stage layout ===== */
  .stageWrap{position:relative; background: radial-gradient(100% 140% at 50% 110%, #0b1434 0%, #0a1027 60%, #0a1027 100%);
             border:1px solid var(--grid); border-radius:14px; padding:14px}
  .stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .conductor{
    width:88px;height:88px;border-radius:50%; background:#0d1b44;border:2px solid #284a9b;
    display:flex;align-items:center;justify-content:center; font-weight:800; color:#cfe1ff;
    position:absolute; left:50%; transform:translateX(-50%); bottom:18px;
    box-shadow:0 0 0 0 rgba(59,130,246,.45); animation:conPulse 1.4s ease-in-out infinite;
  }
  @keyframes conPulse{
    0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}
    70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}
    100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
  }

  .arc{
    position:relative; width:100%; height:520px; overflow:hidden; border-radius:12px; padding-top:8px;
  }
  /* rows from front (bottom) to back (top) */
  .rowStrings{position:absolute; bottom:110px; left:0; right:0; display:flex; justify-content:space-between; gap:8px; padding:0 24px}
  .rowBasses {position:absolute; bottom:170px; left:0; right:0; display:flex; justify-content:flex-end; gap:8px; padding:0 24px}
  .rowWinds  {position:absolute; bottom:260px; left:7%; right:7%; display:flex; justify-content:space-evenly; gap:8px}
  .rowBrass  {position:absolute; bottom:332px; left:6%; right:6%; display:flex; justify-content:space-evenly; gap:8px}
  .rowPerc   {position:absolute; bottom:410px; left:10%; right:10%; display:flex; justify-content:space-evenly; gap:8px}

  .section{
    background:linear-gradient(180deg,#0e1b43,#0a1232); border:1px solid #20326d; border-radius:12px;
    min-width:120px; max-width:170px; padding:8px; display:flex; flex-direction:column; gap:6px;
  }
  .title{font-weight:800;color:#e4eeff;font-size:13px}
  .meta{font-size:11px;color:#9bb9ff}
  .lights{display:flex;align-items:center;gap:6px}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
  .blink{animation:blink .45s ease-out}
  @keyframes blink{
    0%{background:#0c1430;border-color:#2a3b7a}
    30%{background:var(--blink);border-color:#bfefff}
    100%{background:#0c1430;border-color:#2a3b7a}
  }
  .check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;
         display:flex;align-items:center;justify-content:center;font-weight:900}
  .checked{background:#eafff2;border-color:#b7f5cd;color:#059669}

  .mixRow{display:flex;gap:6px}
  .btnSmall{padding:6px 8px;font-size:12px;background:#122153;border:1px solid #23438e;border-radius:8px}
  .btnSmall:hover{filter:brightness(1.1)}
</style>
</head>
<body>
<header>
  <h1>CST — Composer-Guided Orchestral Stage (CSV, 60s)</h1>
  <span style="font-size:12px;color:#9ad1ff">Semi-circle seating • Live section blink • Conductor pulse</span>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <label style="font-weight:700">Load CSV Notes (A/B)</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <button id="btnLoadA" style="margin-top:6px">Load CSV → A</button>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <button id="btnLoadB" style="margin-top:6px">Load CSV → B</button>
      </div>
    </div>

    <div class="hr"></div>
    <label style="font-weight:700">Composer (guides timing • color • orchestration)</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="mozart">Mozart — classic clarity</option>
          <option value="beethoven">Beethoven — bold accents</option>
          <option value="debussy">Debussy — fluid/swing/pads</option>
          <option value="stravinsky">Stravinsky — rhythmic bite</option>
          <option value="cinematic">Cinematic — wide & lush</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Humanize (ms)</label>
        <input id="human" type="number" min="0" max="40" step="1" value="6"/>
      </div>
      <div>
        <label>Master Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.80"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Reverb Mix</label>
        <input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/>
      </div>
      <div>
        <label>Stereo Spread</label>
        <input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>
    <div id="status">Ready.</div>
  </section>

  <!-- RIGHT: Stage -->
  <section class="card stageWrap">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Semi-circle • Balanced projection</b></div>
      <div class="stat"><span>Conductor</span><b id="condName">Maestro</b></div>
    </div>

    <div class="arc">
      <!-- Percussion (very back) -->
      <div class="rowPerc">
        <div class="section" data-sec="perc">
          <div class="title">Percussion</div>
          <div class="meta">Back center</div>
          <div class="lights"><div class="dot" id="dot-perc"></div><div class="check" id="chk-perc"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="perc">Mute</button><button class="btnSmall" data-solo="perc">Solo</button></div>
        </div>
      </div>

      <!-- Brass (back) -->
      <div class="rowBrass">
        <div class="section" data-sec="horns">
          <div class="title">French Horns</div><div class="meta">Back middle</div>
          <div class="lights"><div class="dot" id="dot-horns"></div><div class="check" id="chk-horns"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="horns">Mute</button><button class="btnSmall" data-solo="horns">Solo</button></div>
        </div>
        <div class="section" data-sec="trumpets">
          <div class="title">Trumpets</div><div class="meta">Back left</div>
          <div class="lights"><div class="dot" id="dot-trumpets"></div><div class="check" id="chk-trumpets"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="trumpets">Mute</button><button class="btnSmall" data-solo="trumpets">Solo</button></div>
        </div>
        <div class="section" data-sec="trombones">
          <div class="title">Trombones / Tuba</div><div class="meta">Back right</div>
          <div class="lights"><div class="dot" id="dot-trombones"></div><div class="check" id="chk-trombones"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="trombones">Mute</button><button class="btnSmall" data-solo="trombones">Solo</button></div>
        </div>
      </div>

      <!-- Woodwinds (two rows center) -->
      <div class="rowWinds">
        <div class="section" data-sec="flutes">
          <div class="title">Flutes / Picc.</div><div class="meta">Winds row</div>
          <div class="lights"><div class="dot" id="dot-flutes"></div><div class="check" id="chk-flutes"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="flutes">Mute</button><button class="btnSmall" data-solo="flutes">Solo</button></div>
        </div>
        <div class="section" data-sec="oboes">
          <div class="title">Oboes</div><div class="meta">Winds row</div>
          <div class="lights"><div class="dot" id="dot-oboes"></div><div class="check" id="chk-oboes"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="oboes">Mute</button><button class="btnSmall" data-solo="oboes">Solo</button></div>
        </div>
        <div class="section" data-sec="clarinets">
          <div class="title">Clarinets</div><div class="meta">Winds row</div>
          <div class="lights"><div class="dot" id="dot-clarinets"></div><div class="check" id="chk-clarinets"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="clarinets">Mute</button><button class="btnSmall" data-solo="clarinets">Solo</button></div>
        </div>
        <div class="section" data-sec="bassoons">
          <div class="title">Bassoons</div><div class="meta">Winds row</div>
          <div class="lights"><div class="dot" id="dot-bassoons"></div><div class="check" id="chk-bassoons"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="bassoons">Mute</button><button class="btnSmall" data-solo="bassoons">Solo</button></div>
        </div>
      </div>

      <!-- Basses (back of strings) -->
      <div class="rowBasses">
        <div class="section" data-sec="basses">
          <div class="title">Double Basses</div><div class="meta">Back of strings</div>
          <div class="lights"><div class="dot" id="dot-basses"></div><div class="check" id="chk-basses"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="basses">Mute</button><button class="btnSmall" data-solo="basses">Solo</button></div>
        </div>
      </div>

      <!-- Strings (front semi-circle) -->
      <div class="rowStrings">
        <div class="section" data-sec="vln1">
          <div class="title">1st Violins</div><div class="meta">Far left (front)</div>
          <div class="lights"><div class="dot" id="dot-vln1"></div><div class="check" id="chk-vln1"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="vln1">Mute</button><button class="btnSmall" data-solo="vln1">Solo</button></div>
        </div>
        <div class="section" data-sec="vln2">
          <div class="title">2nd Violins</div><div class="meta">Left-center</div>
          <div class="lights"><div class="dot" id="dot-vln2"></div><div class="check" id="chk-vln2"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="vln2">Mute</button><button class="btnSmall" data-solo="vln2">Solo</button></div>
        </div>
        <div class="section" data-sec="violas">
          <div class="title">Violas</div><div class="meta">Center</div>
          <div class="lights"><div class="dot" id="dot-violas"></div><div class="check" id="chk-violas"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="violas">Mute</button><button class="btnSmall" data-solo="violas">Solo</button></div>
        </div>
        <div class="section" data-sec="cellos">
          <div class="title">Cellos</div><div class="meta">Right-center</div>
          <div class="lights"><div class="dot" id="dot-cellos"></div><div class="check" id="chk-cellos"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="cellos">Mute</button><button class="btnSmall" data-solo="cellos">Solo</button></div>
        </div>
        <div class="section" data-sec="harp">
          <div class="title">Harp / Keys</div><div class="meta">Far right</div>
          <div class="lights"><div class="dot" id="dot-harp"></div><div class="check" id="chk-harp"></div></div>
          <div class="mixRow"><button class="btnSmall" data-mute="harp">Mute</button><button class="btnSmall" data-solo="harp">Solo</button></div>
        </div>
      </div>

      <div class="conductor" id="conductor">Conductor</div>
    </div>
  </section>
</main>

<script>
/* ===== Utilities & scales ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
function pcsFor(root, mode){const r=NOTE.indexOf(root); const base=(mode==='minor')?MINOR:MAJOR; return base.map(pc=>(pc+r+120)%12);}
function snapToScale(m, pcs){ if(!m) return 0; const pc=((m%12)+12)%12; if(pcs.includes(pc)) return m;
  for(const d of [1,-1,2,-2]){ const cand=((pc+d)+12)%12; if(pcs.includes(cand)) return m+d; } return m; }

/* ===== UI refs ===== */
const $=id=>document.getElementById(id);
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const statusEl=$('status'), condNameEl=$('condName'), conductor=$('conductor');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn');

/* ===== State ===== */
let A={events:[]}, B={events:[]};
let AUDIO={ctx:null, master:null, comp:null, convolver:null, wet:null, dry:null, speed:1.0};
let BUS={}; // per-section buses & panners
let sch=[], idx=0, timer=null, t0=0;
const LOOKAHEAD=0.25, TICK=25;

/* ===== Sections & stage mapping ===== */
const SECTIONS=[
  {id:'vln1', name:'1st Violins', pan:-0.7},
  {id:'vln2', name:'2nd Violins', pan:-0.45},
  {id:'violas', name:'Violas', pan:-0.05},
  {id:'cellos', name:'Cellos', pan:0.4},
  {id:'basses', name:'Basses', pan:0.65},
  {id:'harp', name:'Harp/Keys', pan:0.75},
  {id:'flutes', name:'Flutes', pan:-0.1},
  {id:'oboes', name:'Oboes', pan:0.1},
  {id:'clarinets', name:'Clarinets', pan:-0.2},
  {id:'bassoons', name:'Bassoons', pan:0.2},
  {id:'trumpets', name:'Trumpets', pan:-0.55},
  {id:'horns', name:'Horns', pan:0.0},
  {id:'trombones', name:'Trombones', pan:0.55},
  {id:'perc', name:'Percussion', pan:0.0},
];

const DOT={}, CHK={}, MUTE={}, SOLO={on:false, id:null};
SECTIONS.forEach(s=>{ DOT[s.id]=$('dot-'+s.id); CHK[s.id]=$('chk-'+s.id); MUTE[s.id]=false; });

/* ===== Composer presets (conductor guidance) ===== */
const COMPOSER={
  mozart:{ swing:0.06, human:5,  quant:0.125, reverb:0.12, spread:0.45, color:'clear',  percEvery:4, brassAcc:0.15 },
  beethoven:{ swing:0.08, human:7, quant:0.125, reverb:0.16, spread:0.55, color:'bold',   percEvery:2, brassAcc:0.30 },
  debussy:{ swing:0.18, human:10, quant:0.0625,reverb:0.22, spread:0.65, color:'pastel', percEvery:8, brassAcc:0.10 },
  stravinsky:{ swing:0.04,human:8, quant:0.0625,reverb:0.14, spread:0.55, color:'rhythm', percEvery:3, brassAcc:0.35 },
  cinematic:{ swing:0.12,human:9, quant:0.0625,reverb:0.26, spread:0.75, color:'lush',   percEvery:2, brassAcc:0.25 },
};
function applyComposer(){
  const p=COMPOSER[composerEl.value];
  swingEl.value = String(p.swing);
  humanEl.value = String(p.human);
  quantEl.value = String(p.quant);
  reverbMixEl.value = String(p.reverb);
  spreadEl.value = String(p.spread);
  condNameEl.textContent = composerEl.options[composerEl.selectedIndex].text.split(' — ')[0];
}
composerEl.addEventListener('change', applyComposer);

/* ===== CSV helpers ===== */
function parseCSV(text){
  const lines=text.replace(/\r/g,'').trim().split('\n'); if(!lines.length) return [];
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const ti=hdr.indexOf('t'), mi=hdr.indexOf('m'), bi=hdr.indexOf('b');
  if(ti<0||mi<0||bi<0) throw new Error("CSV must have headers: t,m,b");
  const out=[];
  for(let i=1;i<lines.length;i++){
    const row=lines[i].split(',').map(s=>s.trim()); if(!row.length) continue;
    const t=parseFloat(row[ti]||"0"); const m=parseInt(row[mi]||"0",10); const b=parseInt(row[bi]||"0",10);
    if(Number.isFinite(t) && t>=0 && t<=60) out.push({t, m:(m|0), b:(b|0)});
  }
  return out.sort((a,b)=>a.t-b.t);
}

/* ===== Audio chain (soft synth, per-section panners) ===== */
function getAudio(){
  if(!AUDIO.ctx){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const comp=ctx.createDynamicsCompressor(); comp.threshold.value=-18; comp.ratio.value=3; comp.attack.value=0.004; comp.release.value=0.2;
    const dry=ctx.createGain(), wet=ctx.createGain(); dry.gain.value=1; wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
    const conv=ctx.createConvolver(); conv.buffer=makeHallIR(ctx);
    const master=ctx.createGain(); master.gain.value=parseFloat(masterVolEl.value||"0.8");

    // per-section buses with stereo pan
    BUS={};
    const spread=parseFloat(spreadEl.value||"0.55");
    for(const s of SECTIONS){
      const g=ctx.createGain(); g.gain.value=1;
      const left=ctx.createGain(), right=ctx.createGain(), merger=ctx.createChannelMerger(2);
      g.connect(left); g.connect(right);
      left.connect(merger,0,0); right.connect(merger,0,1);
      // simple pan law:
      const pan=clamp(s.pan*spread, -0.95, 0.95);
      const L=clamp(0.5 - pan/2, 0, 1), R=clamp(0.5 + pan/2, 0, 1);
      left.gain.value=L; right.gain.value=R;

      // to dry & wet
      merger.connect(dry);
      merger.connect(conv);

      BUS[s.id]={gain:g};
    }
    conv.connect(wet);
    dry.connect(comp); wet.connect(comp); comp.connect(master); master.connect(ctx.destination);
    AUDIO={ctx, master, comp, convolver:conv, dry, wet, speed:1.0};
  }
  // live tweaks
  AUDIO.master.gain.value=parseFloat(masterVolEl.value||"0.8");
  AUDIO.wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
  // update spreads (approx) by resetting graph (lightweight)
  return AUDIO.ctx;
}
async function resume(){ const ctx=getAudio(); if(ctx.state==='suspended'){ try{await ctx.resume();}catch(_){} } return ctx; }

function makeHallIR(ctx){
  const len=ctx.sampleRate*2.2, ir=ctx.createBuffer(2, len, ctx.sampleRate);
  for(let ch=0; ch<2; ch++){
    const d=ir.getChannelData(ch); let x=0;
    for(let i=0;i<len;i++){ const n=(Math.random()*2-1)*0.5; const t=i/ctx.sampleRate; const decay=Math.exp(-t*1.5); x = 0.32*n + 0.68*x; d[i] = x*decay; }
  }
  return ir;
}

/* ===== Simple orchestral-ish synth per section ===== */
function sectionPreset(sec, midi){
  // rough color per family
  if(sec==='basses') return {wave:'sine', lp:520, q:0.8, a:0.008, d:0.10, s:0.8, r:0.16};
  if(sec==='cellos') return {wave:'triangle', lp:1100, q:0.7, a:0.010, d:0.18, s:0.78, r:0.22};
  if(sec==='violas') return {wave:'triangle', lp:1600, q:0.7, a:0.010, d:0.18, s:0.74, r:0.20};
  if(sec==='vln1'||sec==='vln2') return {wave:'sine', lp:2600, q:0.6, a:0.008, d:0.14, s:0.7, r:0.18};
  if(sec==='harp') return {wave:'sine', lp:2800, q:0.6, a:0.004, d:0.10, s:0.0, r:0.35};
  if(sec==='flutes') return {wave:'sine', lp:3000, q:0.5, a:0.006, d:0.10, s:0.55, r:0.18};
  if(sec==='oboes') return {wave:'triangle', lp:2200, q:0.7, a:0.009, d:0.16, s:0.6, r:0.2};
  if(sec==='clarinets') return {wave:'triangle', lp:2000, q:0.7, a:0.010, d:0.16, s:0.6, r:0.2};
  if(sec==='bassoons') return {wave:'sine', lp:1200, q:0.8, a:0.010, d:0.18, s:0.7, r:0.22};
  if(sec==='trumpets') return {wave:'triangle', lp:2400, q:0.9, a:0.004, d:0.12, s:0.65, r:0.22};
  if(sec==='horns') return {wave:'sine', lp:1800, q:0.9, a:0.008, d:0.14, s:0.7, r:0.24};
  if(sec==='trombones') return {wave:'sine', lp:1400, q:0.9, a:0.006, d:0.16, s:0.75, r:0.26};
  if(sec==='perc') return {wave:'noise', lp:6000, q:0.5, a:0.001, d:0.06, s:0.0, r:0.12};
  return {wave:'sine', lp:2000, q:0.6, a:0.008, d:0.16, s:0.68, r:0.2};
}

function playSectionNote(sec, midi, when, dur, gain){
  if(MUTE[sec] || (SOLO.on && SOLO.id!==sec)) return;
  const ctx=getAudio(); const p=sectionPreset(sec, midi);
  // noise source for perc
  let src;
  if(p.wave==='noise'){
    const len=Math.max(1, Math.floor((dur+p.r)*ctx.sampleRate));
    const buf=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/ (ctx.sampleRate*0.06)); }
    src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
  }else{
    src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(midiHz(midi), when);
    src.start(when); src.stop(when+dur+p.r+0.05);
  }

  const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
  const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
  amp.gain.linearRampToValueAtTime(gain, when+p.a);
  amp.gain.linearRampToValueAtTime(gain*p.s, when+p.a+p.d);
  amp.gain.setValueAtTime(gain*p.s, when+dur);
  amp.gain.linearRampToValueAtTime(0.0003, when+dur+p.r);

  src.connect(biq); biq.connect(amp); amp.connect(BUS[sec].gain);

  // Visuals
  markSection(sec);
}

function markSection(sec){
  const dot=DOT[sec], chk=CHK[sec];
  if(dot){ dot.classList.remove('blink'); void dot.offsetWidth; dot.classList.add('blink'); }
  if(chk && !chk.classList.contains('checked')){ chk.classList.add('checked'); chk.textContent='✓'; }
}

/* ===== Orchestration mapping =====
   Map midi & role to a stage section (strings up front; winds/brass/percussion for color).
*/
function pickSection(midi, isBass, side, beatIndex){
  const comp=COMPOSER[composerEl.value];
  // Core string seating by pitch
  if(isBass || midi<=43) return 'basses';
  if(midi<=55) return 'cellos';
  if(midi<=64) return 'violas';
  if(midi<=76) return side==='A' ? 'vln2' : 'violas';
  if(midi<=84) return 'vln1';
  if(midi>84)  return 'vln1';

  // Color layers (brass accents every N beats)
  if(beatIndex % comp.percEvery===0 && Math.random()<comp.brassAcc){
    return pick(['trumpets','horns','trombones']);
  }
  return 'vln1';
}

/* ===== Musicalize & schedule ===== */
function musicalize(events, side){
  if(!events?.length) return [];
  const BPM=parseFloat(bpmEl.value||"100");
  const beat=60/clamp(BPM,40,200);
  const qDiv=parseFloat(quantEl.value||"0.125");
  const grid=beat*4*qDiv;
  const swing=parseFloat(swingEl.value||"0");
  const human=parseFloat(humanEl.value||"0")/1000;
  const pcs=pcsFor(keyRootEl.value, keyModeEl.value);

  const lastByPitch=new Map(); const perSecCap=10; let lastSec=-1, perSec=0;
  const out=[];
  for(const e of events){
    let q=Math.round(e.t/grid)*grid;
    if(grid<=beat/2+1e-6){ const pos=Math.round(q/grid); if(pos%2===1) q+=swing*grid*0.5; }
    q=clamp(q,0,60);
    const sec=Math.floor(q); if(sec!==lastSec){ perSec=0; lastSec=sec; }
    const m=e.m? snapToScale(e.m, pcs):0;
    const b=e.b? snapToScale(e.b, pcs):0;
    const push=(midi,isBass)=>{
      if(!midi) return;
      const last=lastByPitch.get(midi)||-999; if(q-last<0.08) return; if(perSec>=perSecCap) return;
      lastByPitch.set(midi,q); perSec++;
      const jitter=(Math.random()*2-1)*human;
      const dur=(isBass?0.45:0.28);
      const base=isBass?0.9:0.76;
      const height=midi/127;
      const vel=clamp(base*(0.9+0.2*(height-0.5)),0.25,1.0);
      out.push({t:clamp(q+jitter,0,60), midi:Math.round(midi), dur, vel, isBass, side});
    };
    push(m,false); push(b,true);
  }
  // attach beat index for routing accents
  out.sort((a,b)=>a.t-b.t);
  const beatLen=beat; out.forEach(ev=>ev.beatIndex=Math.round(ev.t/beatLen));
  return out;
}

function buildSchedule(){
  const a=musicalize(A.events,'A');
  const b=musicalize(B.events,'B');
  const all=[...a,...b].sort((x,y)=>x.t-y.t);
  // Map to sections
  const mapped=all.map(e=>{
    const sec=pickSection(e.midi, e.isBass, e.side, e.beatIndex);
    return {...e, sec};
  });
  // Light percussion click on strong beats based on composer
  const comp=COMPOSER[composerEl.value];
  const BPM=parseFloat(bpmEl.value||"100");
  const beat=60/clamp(BPM,40,200);
  for(let t=0; t<=60; t+=beat){
    if(Math.round(t/beat)%comp.percEvery===0){
      mapped.push({t:clamp(t,0,60), midi:60, dur:0.09, vel:0.55, isBass:false, side:'P', sec:'perc'});
    }
  }
  mapped.sort((x,y)=>x.t-y.t);
  return mapped;
}

/* ===== Playback ===== */
async function doPlay(){
  await resume(); stopAll(); applyComposer(); refreshBuses();
  if(!A.events.length && !B.events.length){ alert("Load a CSV into A and/or B first."); return; }
  sch=buildSchedule(); if(!sch.length){ alert("No notes in 0–60s."); return; }
  const ctx=AUDIO.ctx; t0=ctx.currentTime+0.06; idx=0; conductor.style.animationPlayState='running';
  timer=setInterval(tick, TICK); setStatus("Playing…");
}
function tick(){
  const ctx=AUDIO.ctx, now=ctx.currentTime, horizon=now+LOOKAHEAD, speed=AUDIO.speed||1.0;
  while(idx<sch.length){
    const e=sch[idx]; const when=t0 + e.t*(1/speed); if(when>horizon) break;
    const g = gainForSection(e.sec, e);
    playSectionNote(e.sec, e.midi, when, e.dur*(1/speed), g);
    idx++;
  }
  if(idx>=sch.length){ clearInterval(timer); timer=null; setStatus("Finished."); conductor.style.animationPlayState='paused'; }
}
function stopAll(){ if(timer){ clearInterval(timer); timer=null; } idx=sch?.length||0; setStatus("Stopped."); conductor.style.animationPlayState='paused'; }

function gainForSection(sec, e){
  const mixA=0.9, mixB=0.75; const sideGain=(e.side==='B')?mixB:mixA;
  const familyBoost={
    vln1:1.0, vln2:0.95, violas:0.95, cellos:1.05, basses:1.10, harp:0.9,
    flutes:0.9, oboes:0.85, clarinets:0.85, bassoons:0.9,
    trumpets:1.1, horns:1.0, trombones:1.05, perc:0.8
  }[sec] || 1.0;
  return clamp(e.vel * sideGain * familyBoost, 0.05, 1.2);
}

/* ===== Per-section mute/solo ===== */
document.querySelectorAll('[data-mute]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const sec=btn.getAttribute('data-mute');
    MUTE[sec]=!MUTE[sec];
    btn.textContent=MUTE[sec]?'Unmute':'Mute';
  });
});
document.querySelectorAll('[data-solo]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const sec=btn.getAttribute('data-solo');
    if(SOLO.on && SOLO.id===sec){ SOLO.on=false; SOLO.id=null; btn.textContent='Solo'; return; }
    SOLO.on=true; SOLO.id=sec;
    document.querySelectorAll('[data-solo]').forEach(b=>b.textContent='Solo');
    btn.textContent='Unsolo';
  });
});

/* ===== Live bus refresh (recreate per-section panning after spread changes) ===== */
function refreshBuses(){
  // rebuild chain quickly by reinitializing (cheap enough for 14 sections)
  const old=AUDIO.ctx;
  if(old){ try{ old.close(); }catch(_){ } }
  AUDIO.ctx=null; getAudio();
}

/* ===== Wire up ===== */
btnLoadA.addEventListener('click', async ()=>{
  const f=csvA.files?.[0]; if(!f){ alert("Select CSV for A"); return; }
  try{ A.events=parseCSV(await f.text()); }catch(e){ alert(e.message); return; }
  setStatus(`A loaded: ${A.events.length} rows`);
});
btnLoadB.addEventListener('click', async ()=>{
  const f=csvB.files?.[0]; if(!f){ alert("Select CSV for B"); return; }
  try{ B.events=parseCSV(await f.text()); }catch(e){ alert(e.message); return; }
  setStatus(`B loaded: ${B.events.length} rows`);
});
playBtn.addEventListener('click', doPlay);
stopBtn.addEventListener('click', stopAll);
resetBtn.addEventListener('click', ()=>{
  stopAll(); A={events:[]}; B={events:[]};
  Object.keys(MUTE).forEach(k=>MUTE[k]=false); SOLO.on=false; SOLO.id=null;
  Object.values(CHK).forEach(el=>{el.classList.remove('checked');el.textContent='';});
  Object.values(DOT).forEach(el=>el.classList.remove('blink'));
  setStatus('Ready.');
});
masterVolEl.addEventListener('input', ()=>{ getAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); });
reverbMixEl.addEventListener('input', ()=>{ getAudio(); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); });
spreadEl.addEventListener('input', refreshBuses);

/* ===== Init ===== */
(function init(){
  // Key menu
  NOTE.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; if(n==='C') o.selected=true; keyRootEl.appendChild(o); });
  applyComposer();
  conductor.style.animationPlayState='paused';
  setStatus('Ready.');
})();
</script>
</body>
</html>
