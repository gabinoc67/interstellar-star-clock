<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST — Dual Key Analyzer + GM 0–127 Router (60s) + Play/Stop/Reset</title>
<style>
  :root{
    --bg:#0a0f1f; --ink:#eaf1ff; --muted:#a8b7e3; --panel:#121a33; --line:#6ee7ff; --ok:#10b981; --warn:#f59e0b;
    --grid:#1b254b; --accent:#3b82f6; --danger:#ef4444; --white:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1240px;margin:0 auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)}
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px;margin-top:8px}
  .stat b{color:var(--ok)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre;line-height:1.42}
  .scroller{max-height:300px;overflow:auto;border:1px solid var(--grid);border-radius:10px;padding:8px;background:#0c1430}
  canvas{width:100%;height:220px;background:#0c1430;border:1px solid #22306b;border-radius:10px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1c44;border:1px solid var(--grid);font-size:12px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .danger{background:#3b1220;border-color:#6b1f35}
  .whiteSquare{
    width:100%; height:40px; background:var(--white); color:#000; display:flex; align-items:center; justify-content:center;
    border-radius:8px; border:2px solid #ddd; cursor:pointer; user-select:none;
  }
  .whiteSquare.active{outline:3px solid #4f8cff; font-weight:700}
  .gmGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .gmItem{border:1px solid var(--grid);border-radius:10px;padding:8px;background:#0b1738;cursor:pointer}
  .gmItem:hover{filter:brightness(1.08)}
  .gmItem .name{font-size:12px;color:#cfe1ff}
  .gmItem .num{font-weight:700;color:#9ad1ff}
  .gmItem .cnt{font-size:12px;color:#9ee6c9}
  .panelTitle{display:flex;align-items:center;justify-content:space-between}
  .flex{display:flex;gap:10px;align-items:center}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>CST — Dual Key Analyzer (60s) + GM 0–127 Router</h1>
  <span class="pill">Analyzer: WebAudio + autocorrelation (dominant + bass)</span>
  <span class="pill">Playback: Built-in WebAudio synth</span>
</header>

<main>
  <!-- LEFT: Controls & Dual Analyzer -->
  <section class="card">
    <div class="panelTitle">
      <label style="margin:0">Song A — Audio file (MP3/WAV/AAC/OGG)</label>
    </div>
    <input id="fileA" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" />
    <div class="row" style="margin-top:10px">
      <button id="analyzeA">Analyze A (first 60s)</button>
      <div class="stat"><span>Key A</span><b id="keyA">–</b></div>
    </div>
    <div class="stat"><span>Frames A</span><b id="framesA">–</b></div>

    <div class="hr"></div>

    <div class="panelTitle">
      <label style="margin:0">Song B — Audio file (MP3/WAV/AAC/OGG)</label>
    </div>
    <input id="fileB" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" />
    <div class="row" style="margin-top:10px">
      <button id="analyzeB">Analyze B (first 60s)</button>
      <div class="stat"><span>Key B</span><b id="keyB">–</b></div>
    </div>
    <div class="stat"><span>Frames B</span><b id="framesB">–</b></div>

    <div class="hr"></div>
    <div>
      <label>Speed (affects playback spacing)</label>
      <div class="row">
        <div class="whiteSquare" data-speed="0.8">Slow (0.8×)</div>
        <div class="whiteSquare active" data-speed="1.0">Medium (1.0×)</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="whiteSquare" data-speed="1.25">Fast (1.25×)</div>
        <div class="whiteSquare" data-speed="1.5">Very Fast (1.5×)</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="btnRow">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="hint" style="margin-top:8px">
      “Analyze A/B” extracts dominant & bass notes every ~46ms, routes them to GM instruments by pitch range/family, and merges A+B for playback.
    </div>
  </section>

  <!-- RIGHT: Visuals & Instruments -->
  <section class="card">
    <label>Piano-roll (Song A + B, time → note)</label>
    <canvas id="roll" width="960" height="240"></canvas>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Detected notes (time, dominant, bass) — Click an instrument below to inspect its note list</label>
        <div id="noteList" class="scroller mono"></div>
      </div>
      <div>
        <label>Pitch-class histograms (A & B)</label>
        <div class="row">
          <div id="histA" class="scroller mono" style="min-height:120px"></div>
          <div id="histB" class="scroller mono" style="min-height:120px"></div>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="panelTitle">
      <label style="margin:0">All GM Instruments (0–127)</label>
      <span class="pill" id="selInfo">Select an instrument to view notes</span>
    </div>
    <div id="gmGrid" class="gmGrid" style="margin-top:8px"></div>
  </section>
</main>

<script>
/* ======== Musical helpers ======== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function hzToMidi(hz){ return 69 + 12*Math.log2(hz/440); }
function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }
function midiToName(m){ const n=Math.round(m); return NOTE_NAMES[(n%12+12)%12] + (Math.floor(n/12)-1); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* ======== GM names 0..127 ======== */
const GM = [
"0 Acoustic Grand Piano","1 Bright Acoustic Piano","2 Electric Grand Piano","3 Honky-tonk Piano","4 Rhodes Piano","5 Chorused Piano","6 Harpsichord","7 Clavinet",
"8 Celesta","9 Glockenspiel","10 Music Box","11 Vibraphone","12 Marimba","13 Xylophone","14 Tubular Bells","15 Dulcimer",
"16 Hammond Organ","17 Percussive Organ","18 Rock Organ","19 Church Organ","20 Reed Organ","21 Accordion","22 Harmonica","23 Tango Accordion",
"24 Acoustic Nylon Guitar","25 Acoustic Steel Guitar","26 Electric Jazz Guitar","27 Electric Clean Guitar","28 Electric Muted Guitar","29 Overdriven Guitar","30 Distortion Guitar","31 Guitar Harmonics",
"32 Acoustic Bass","33 Fingered Electric Bass","34 Plucked Electric Bass","35 Fretless Bass","36 Slap Bass 1","37 Slap Bass 2","38 Synth Bass 1","39 Synth Bass 2",
"40 Violin","41 Viola","42 Cello","43 Contrabass","44 Tremolo Strings","45 Pizzicato Strings","46 Orchestral Harp","47 Timpani",
"48 String Ensemble 1","49 String Ensemble 2","50 Synth Strings 1","51 Synth Strings 2","52 Choir \"Aah\"","53 Choir \"Ooh\"","54 Synth Voice","55 Orchestral Hit",
"56 Trumpet","57 Trombone","58 Tuba","59 Muted Trumpet","60 French Horn","61 Brass Section","62 Synth Brass 1","63 Synth Brass 2",
"64 Soprano Sax","65 Alto Sax","66 Tenor Sax","67 Baritone Sax","68 Oboe","69 English Horn","70 Bassoon","71 Clarinet",
"72 Piccolo","73 Flute","74 Recorder","75 Pan Flute","76 Bottle Blow","77 Shakuhachi","78 Whistle","79 Ocarina",
"80 Square Lead","81 Saw Lead","82 Calliope Lead","83 Chiff Lead","84 Charang Lead","85 Voice Lead","86 Fifths Lead","87 Bass Lead",
"88 New Age Pad","89 Warm Pad","90 Polysynth Pad","91 Choir Pad","92 Bowed Pad","93 Metallic Pad","94 Halo Pad","95 Sweep Pad",
"96 Rain","97 Soundtrack","98 Crystal","99 Atmosphere","100 Brightness","101 Goblins","102 Echoes","103 Sci-Fi",
"104 Sitar","105 Banjo","106 Shamisen","107 Koto","108 Kalimba","109 Bagpipe","110 Fiddle","111 Shanai",
"112 Tinkle Bell","113 Agogo","114 Steel Drums","115 Woodblock","116 Taiko Drum","117 Melodic Tom","118 Synth Drum","119 Reverse Cymbal",
"120 Guitar Fret Noise","121 Breath Noise","122 Seashore","123 Bird Tweet","124 Telephone Ring","125 Helicopter","126 Applause","127 Gun Shot"
];

/* ======== UI refs ======== */
const fileA = document.getElementById('fileA');
const fileB = document.getElementById('fileB');
const analyzeA = document.getElementById('analyzeA');
const analyzeB = document.getElementById('analyzeB');
const keyA = document.getElementById('keyA');
const keyB = document.getElementById('keyB');
const framesA = document.getElementById('framesA');
const framesB = document.getElementById('framesB');
const histA = document.getElementById('histA');
const histB = document.getElementById('histB');
const roll = document.getElementById('roll'), rc = roll.getContext('2d');
const noteList = document.getElementById('noteList');
const gmGrid = document.getElementById('gmGrid');
const selInfo = document.getElementById('selInfo');
const speedSquares = Array.from(document.querySelectorAll('.whiteSquare'));
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');

/* ======== Analyzer core ======== */
const KS_MAJOR = [6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MINOR = [6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlateKey(pitchClassHist){
  function norm(v){ const n=Math.hypot(...v); return v.map(x=>x/(n||1)); }
  const h = norm(pitchClassHist);
  let best={name:"–",score:-1};
  for(let r=0;r<12;r++){
    const cm = KS_MAJOR.map((v,i)=>v * h[(i+r)%12]).reduce((a,b)=>a+b,0);
    const cn = KS_MINOR.map((v,i)=>v * h[(i+r)%12]).reduce((a,b)=>a+b,0);
    if (cm>best.score) best={name:`${NOTE_NAMES[r]} major`,score:cm};
    if (cn>best.score) best={name:`${NOTE_NAMES[r]} minor`,score:cn};
  }
  return best.name;
}
function autocorrPitch(frame, sampleRate){
  const N = frame.length;
  let mean=0; for(let i=0;i<N;i++) mean += frame[i]; mean/=N;
  let maxAbs=0;
  for(let i=0;i<N;i++){
    frame[i] = (frame[i]-mean) * (0.5 - 0.5*Math.cos(2*Math.PI*i/(N-1)));
    maxAbs = Math.max(maxAbs, Math.abs(frame[i]));
  }
  const clip = 0.3*maxAbs;
  if (clip>0){
    for(let i=0;i<N;i++){
      if (frame[i]> clip) frame[i]-=clip;
      else if (frame[i]<-clip) frame[i]+=clip;
      else frame[i]=0;
    }
  }
  const minF=50, maxF=1000;
  const minLag = Math.floor(sampleRate/maxF);
  const maxLag = Math.floor(sampleRate/minF);
  let bestLag=0, best=0;
  for(let lag=minLag; lag<=Math.min(maxLag, N-3); lag++){
    let sum=0;
    for(let i=0;i<N-lag;i++) sum += frame[i]*frame[i+lag];
    if (sum>best){best=sum; bestLag=lag;}
  }
  if (bestLag>0){
    const l=bestLag;
    const c1=acfAtLag(frame,l-1), c2=acfAtLag(frame,l), c3=acfAtLag(frame,l+1);
    let shift=0, denom=(c1-2*c2+c3);
    if (denom!==0) shift=0.5*(c1-c3)/denom;
    const refined = l + shift;
    const freq = frame.length>0 ? sampleRate/refined : 0;
    if (isFinite(freq)&&freq>20&&freq<2000) return freq;
  }
  return 0;
  function acfAtLag(x, lag){
    if (lag<1 || lag>=x.length) return 0;
    let s=0; for(let i=0;i<x.length-lag;i++) s+=x[i]*x[i+lag];
    return s;
  }
}

/* ======== State: events & routing ======== */
let eventsA=[], eventsB=[];
let pclassA=new Float32Array(12), pclassB=new Float32Array(12);
let routed = initRouted(); // instrument → array of {t, midi, src: 'A'|'B'}
let selectedProg = 40; // default selected instrument for noteList panel
function initRouted(){
  const map = new Map();
  for (let p=0;p<128;p++) map.set(p, []);
  return map;
}

/* ======== Drawing ======== */
function drawHist(el, hist){
  const tot = Array.from(hist).reduce((a,b)=>a+b,0)||1;
  let out = "PC  %\n";
  for (let i=0;i<12;i++){
    const pct = (hist[i]/tot*100).toFixed(1).padStart(5,' ');
    out += `${NOTE_NAMES[i].padEnd(2,' ')} ${pct}%\n`;
  }
  el.textContent = out;
}
function drawRoll(){
  const width = roll.width, height=roll.height;
  rc.clearRect(0,0,width,height);
  rc.strokeStyle = "rgba(110,231,255,0.25)";
  for(let i=0;i<=10;i++){ const x=(i/10)*width; rc.beginPath(); rc.moveTo(x,0); rc.lineTo(x,height); rc.stroke(); }
  const minM=36, maxM=84, span=maxM-minM;
  function y(m){ return height - ((m-minM)/span)*height; }
  // A = cyan (dom), green (bass); B = yellow (dom), red (bass)
  eventsA.forEach(ev=>{ if(ev.midi){ const x=(ev.t/60)*width; rc.fillStyle="rgba(110,231,255,0.9)"; rc.fillRect(x,y(ev.midi)-3,3,6);} });
  eventsA.forEach(ev=>{ if(ev.bass){ const x=(ev.t/60)*width; rc.fillStyle="rgba(16,185,129,0.9)"; rc.fillRect(x,y(ev.bass)-4,4,8);} });
  eventsB.forEach(ev=>{ if(ev.midi){ const x=(ev.t/60)*width; rc.fillStyle="rgba(255,206,86,0.9)"; rc.fillRect(x,y(ev.midi)-2,2,4);} });
  eventsB.forEach(ev=>{ if(ev.bass){ const x=(ev.t/60)*width; rc.fillStyle="rgba(255,99,132,0.9)"; rc.fillRect(x,y(ev.bass)-3,3,6);} });
}
function renderGMGrid(){
  gmGrid.innerHTML = "";
  for (let p=0;p<128;p++){
    const div=document.createElement('div');
    div.className="gmItem";
    const cnt = routed.get(p).length;
    div.innerHTML = `<div class="num">#${p}</div><div class="name">${GM[p]}</div><div class="cnt">notes: ${cnt}</div>`;
    div.onclick = ()=>{ selectedProg=p; showInstrumentNotes(p); };
    gmGrid.appendChild(div);
  }
  showInstrumentNotes(selectedProg);
}
function showInstrumentNotes(p){
  const arr = routed.get(p)||[];
  selInfo.textContent = `Instrument #${p} — ${GM[p]} — ${arr.length} notes`;
  const lines=[];
  for (let i=0;i<arr.length;i++){
    const e=arr[i];
    lines.push(`${e.t.toFixed(2).padStart(6,' ')}s   ${midiToName(e.midi).padEnd(4,' ')} (${e.midi})   from:${e.src}`);
  }
  noteList.textContent = lines.join("\n") || "(no notes)";
}

/* ======== Playback (WebAudio synth) ======== */
let AUDIO = { ctx:null, master:null, nodes:[], running:false, timer:null, speed:1.0 };
function ensureAudio(){
  if (!AUDIO.ctx){
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const master=ctx.createGain(); master.gain.value=0.6; master.connect(ctx.destination);
    AUDIO.ctx=ctx; AUDIO.master=master;
  }
  return AUDIO.ctx;
}
function voiceFor(midi, program){
  // crude family->waveform mapping
  const wf = (()=>{
    if (program>=40 && program<=49) return "sawtooth";     // strings/ensembles
    if (program>=56 && program<=63) return "square";       // brass
    if (program>=72 && program<=79) return "sine";         // flutes/recorders
    if (program>=0 && program<=7)   return "triangle";     // pianos
    if (program>=32 && program<=39) return "sine";         // basses
    if (program===46)               return "triangle";     // harp
    return "sawtooth";
  })();
  const ctx=ensureAudio();
  const osc=ctx.createOscillator(); osc.type=wf;
  const g=ctx.createGain(); g.gain.value=0.0;
  const lp=ctx.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=18000;
  osc.connect(lp); lp.connect(g); g.connect(AUDIO.master);
  osc.frequency.setValueAtTime(midiToHz(midi), ctx.currentTime);
  osc.start();
  return {osc,g,ctx};
}
function playNote(program, midi, when, dur=0.3, vel=0.85){
  const v = voiceFor(midi, program);
  const t = v.ctx.currentTime + when;
  const a=0.01, d=0.08, s=0.6*vel, r=0.12;
  v.g.gain.cancelScheduledValues(t);
  v.g.gain.setValueAtTime(0.0, t);
  v.g.gain.linearRampToValueAtTime(vel, t+a);
  v.g.gain.linearRampToValueAtTime(s, t+a+d);
  v.g.gain.linearRampToValueAtTime(0.0, t+a+d+dur+r);
  v.osc.stop(t+a+d+dur+r+0.02);
  AUDIO.nodes.push(v);
}
function stopAll(){
  AUDIO.running=false;
  if (AUDIO.timer){ clearTimeout(AUDIO.timer); AUDIO.timer=null; }
  if (AUDIO.ctx){
    AUDIO.nodes.forEach(v=>{ try{ v.osc.stop(); }catch(_){} });
    AUDIO.nodes.length=0;
  }
}
function buildScheduleFromRouted(){
  // flatten routed map into schedule [{t, program, midi, src}]
  const sched=[];
  routed.forEach((arr, program)=>{
    arr.forEach(e=> sched.push({t:e.t, program, midi:e.midi, src:e.src}));
  });
  // clamp 0..60s and sort
  return sched.filter(e=>e.t>=0 && e.t<60).sort((a,b)=>a.t-b.t);
}
function play(){
  stopAll();
  const sched = buildScheduleFromRouted();
  if (!sched.length){ alert("No notes yet. Analyze A and/or B first."); return; }
  const start = performance.now()/1000;
  AUDIO.running=true;
  const look=0.25;
  function loop(idx){
    if (!AUDIO.running) return;
    const now = (performance.now()/1000 - start) * (1/AUDIO.speed);
    let i=idx;
    while (i<sched.length && sched[i].t <= now+look){
      const e = sched[i];
      const dt = Math.max(0, (e.t - now)) * AUDIO.speed;
      const dur = (e.midi<=52 ? 0.5 : 0.3) * (1/AUDIO.speed); // longer for bass
      playNote(e.program, e.midi, dt, dur, e.midi<=52?0.95:0.8);
      i++;
    }
    if (i<sched.length){
      AUDIO.timer = setTimeout(()=>loop(i), 25);
    }else{
      AUDIO.timer = setTimeout(()=>{ AUDIO.running=false; }, 1000);
    }
  }
  loop(0);
}

/* ======== Routing rules ======== */
function routeEvent(t, midi, isBass, src){
  // Bass (<=52) -> Bass family + Contrabass
  if (isBass || midi<=52){
    for (const p of [32,33,34,35,43]) routed.get(p).push({t, midi, src});
    return;
  }
  // Mid (53..72) -> Violas/Cellos/Horns/Clarinet/String Ens
  if (midi>=53 && midi<=72){
    for (const p of [41,42,60,71,48]) routed.get(p).push({t, midi, src});
    return;
  }
  // High (>=73) -> Violins/Flutes/Trumpets/Piccolo/Piano/String Ens
  for (const p of [40,73,56,72,0,48]) routed.get(p).push({t, midi, src});
}

/* ======== Analysis pipeline (60s) ======== */
async function analyze(file, which){ // which: 'A' | 'B'
  if (!file){ alert(`Choose audio for Song ${which}.`); return; }
  const arrBuf = await file.arrayBuffer();
  const ac = new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1, 44100*120, 44100);
  let audioBuf;
  try{ audioBuf = await ac.decodeAudioData(arrBuf.slice(0)); }
  catch(e){ alert("Could not decode audio. Try WAV/MP3."); return; }
  const sr = audioBuf.sampleRate, ch = audioBuf.numberOfChannels;
  const mono = new Float32Array(audioBuf.length);
  for (let c=0;c<ch;c++){
    const d = audioBuf.getChannelData(c);
    for (let i=0;i<d.length;i++) mono[i] = (mono[i]||0) + d[i]/ch;
  }
  const frameSize=4096, hop=2048, total=mono.length;
  const maxSamples = Math.min(total, sr*60); // first 60s only
  const outEv=[], pclass = new Float32Array(12);

  for (let start=0; start+frameSize<=maxSamples; start+=hop){
    const frame = mono.subarray(start, start+frameSize).slice();
    const f0 = autocorrPitch(frame, sr);
    let midi=0, bass=0;
    if (f0>0){
      midi = clamp(Math.round(hzToMidi(f0)), 24, 100);
      if (f0<=200) bass = clamp(Math.round(hzToMidi(f0)), 20, 80);
      pclass[((Math.round(midi)%12)+12)%12] += 1;
    }
    const t = start/sr;
    outEv.push({t, midi, bass});
  }

  // store
  if (which==='A'){ eventsA=outEv; pclassA=pclass; framesA.textContent=String(outEv.length); }
  else { eventsB=outEv; pclassB=pclass; framesB.textContent=String(outEv.length); }

  // key estimate
  const sm = new Float32Array(12);
  for (let i=0;i<12;i++){
    const a=pclass[(i+11)%12], b=pclass[i], c=pclass[(i+1)%12];
    sm[i]=(a+2*b+c)/4;
  }
  const k = correlateKey(Array.from(sm));
  if (which==='A') keyA.textContent = k; else keyB.textContent = k;

  // route into GM instruments
  rerouteAll();

  // visuals
  drawRoll();
  drawHist(which==='A'?histA:histB, pclass);
  renderGMGrid();
  renderNotePreview();
}
function rerouteAll(){
  routed = initRouted();
  // add A
  eventsA.forEach(ev=>{
    if (ev.midi) routeEvent(ev.t, ev.midi, false, 'A');
    if (ev.bass) routeEvent(ev.t, ev.bass, true, 'A');
  });
  // add B
  eventsB.forEach(ev=>{
    if (ev.midi) routeEvent(ev.t, ev.midi, false, 'B');
    if (ev.bass) routeEvent(ev.t, ev.bass, true, 'B');
  });
}
function renderNotePreview(){
  const lines=[];
  lines.push(" time     DOM_A   BASS_A    DOM_B   BASS_B");
  const n = Math.max(eventsA.length, eventsB.length);
  for (let i=0;i<n; i++){
    const a=eventsA[i]||{}, b=eventsB[i]||{};
    const t = (a.t??b.t??0).toFixed(2).padStart(6,' ');
    const ad = a.midi? midiToName(a.midi).padEnd(5,' ') : " --  ";
    const ab = a.bass? midiToName(a.bass).padEnd(5,' ') : " --  ";
    const bd = b.midi? midiToName(b.midi).padEnd(5,' ') : " --  ";
    const bb = b.bass? midiToName(b.bass).padEnd(5,' ') : " --  ";
    lines.push(`${t}s   ${ad}   ${ab}    ${bd}   ${bb}`);
    if (lines.length>200) break;
  }
  noteList.textContent = lines.join("\n");
}

/* ======== Wire up UI ======== */
analyzeA.onclick = ()=> analyze(fileA.files?.[0],'A');
analyzeB.onclick = ()=> analyze(fileB.files?.[0],'B');

speedSquares.forEach(sq=>{
  sq.onclick = ()=>{
    speedSquares.forEach(x=>x.classList.remove('active'));
    sq.classList.add('active');
    AUDIO.speed = parseFloat(sq.getAttribute('data-speed'))||1.0;
  };
});
AUDIO.speed = 1.0;

playBtn.onclick = ()=> play();
stopBtn.onclick = ()=> stopAll();
resetBtn.onclick = ()=>{
  stopAll();
  eventsA=[]; eventsB=[]; pclassA=new Float32Array(12); pclassB=new Float32Array(12);
  keyA.textContent='–'; keyB.textContent='–'; framesA.textContent='–'; framesB.textContent='–';
  histA.textContent=''; histB.textContent=''; noteList.textContent='';
  routed = initRouted(); renderGMGrid(); drawRoll();
  fileA.value=""; fileB.value="";
};

/* ======== Initial GM grid & canvas ======== */
(function init(){
  renderGMGrid();
  drawRoll();
})();
</script>
</body>
</html>
