<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audio → CSV (60s) — Analyzer + Panels A/B + Pace/Cadence + 32 Chairs + Smooth Engine</title>
<style>
  :root{
    --bg:#0b1222;--panel:#111a34;--ink:#eaf0ff;--muted:#a7b7e6;--border:#213067;
    --btn:#162455;--btnH:#1d2e6e;--chip:#14224f;--accent:#8fb4ff;--card:#0e1740;
    --ok:#7bffb1;--warn:#ffd37a;--bad:#ff8c8c
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1500px;margin:0 auto;padding:18px}
  h1{font-size:18px;margin:0 0 12px}
  h2{font-size:16px;margin:0 0 10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  button,input[type="file"]{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--ink);cursor:pointer}
  button:hover{background:var(--btnH)}
  input[type="text"],input[type="number"],select,input[type="range"]{padding:8px;border-radius:8px;border:1px solid var(--border);background:#0d1a3a;color:var(--ink)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .rowAuto{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--border);border-radius:10px}
  small.hint{display:block;color:var(--muted);margin-top:6px}
  .fname{font-size:12px;color:#bcd3ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .lights{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px}
  .lightItem{display:flex;align-items:center;gap:6px;font-size:12px;color:#cfe1ff}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #ddd;background:#0f1b3d}
  .dot.on{background:#ffffff;border-color:#ffffff}
  .panelHeader{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .metaBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .metaBox label{margin:0;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:12px;text-align:left}
  th{color:#cfe1ff;background:#0e1a3f;position:sticky;top:0}
  tbody tr:hover{background:#0c1740}
  .tight{width:100px}
  .xs{width:64px}
  .cbx{display:flex;justify-content:center;align-items:center}

  .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:14px}
  .tempoGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .tempoBtn{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .pill{font-size:11px;color:#a7b7e6}
  .cadList{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .applyRow{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}

  /* Stage + 32 chairs + Mixer */
  .stage{display:grid;gap:12px}
  .seating{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
  .chair{border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--card);display:flex;flex-direction:column;gap:6px;cursor:pointer;user-select:none}
  .chair .line1{display:flex;justify-content:space-between;align-items:center;gap:6px}
  .chair .side{font-size:11px;opacity:0.85}
  .chair .prog{font-weight:700;font-size:12px}
  .chair .name{font-size:11px;color:#bcd3ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chair .chan{font-size:10px;opacity:0.7}
  .chair.off{opacity:0.45;filter:saturate(0.6)}
  .legend{font-size:12px;color:#bcd3ff}
  .mini{font-size:11px;color:#a7b7e6}
  .rowBtns{display:flex;gap:8px;flex-wrap:wrap}
  .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:#cfe1ff;background:#14224f}

  .mixerGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .sliderRow{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Audio → CSV Notes (60s)</h1>

    <div class="grid">
      <!-- ========== LEFT COLUMN ========== -->
      <div>
        <!-- Analyzer -->
        <section class="card">
          <label><strong>Audio → CSV Notes (60s)</strong></label>
          <div class="row3" style="margin-top:6px">
            <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
            <button id="btnAnalyze">2) Analyze 60s</button>
            <button id="btnExport">3) Export CSV (enriched)</button>
          </div>
          <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" hidden />

          <div class="lights">
            <div class="lightItem"><div id="dotAnalyze" class="dot"></div>Analyze done</div>
            <div class="lightItem"><div id="dotExport"  class="dot"></div>Export ready</div>
            <div class="lightItem"><div id="dotA" class="dot"></div>A loaded</div>
            <div class="lightItem"><div id="dotB" class="dot"></div>B loaded</div>
          </div>

          <div class="row2" style="margin-top:8px">
            <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
            <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
          </div>
          <small class="hint">Enriched CSV headers required: <b>t,midi,vel,dur,is_bass,bar,beat,bpm,key</b>.</small>

          <div class="hr"></div>

          <label><strong>Load Enriched CSV Notes → A / B</strong></label>
          <div class="rowAuto">
            <div style="min-width:220px"><input id="csvA" type="file" accept=".csv"/></div>
            <div class="fname" id="nameA">—</div>
          </div>
          <div style="margin-top:6px"><button id="btnLoadA" style="min-width:180px">Load CSV → A</button></div>

          <div class="rowAuto" style="margin-top:10px">
            <div style="min-width:220px"><input id="csvB" type="file" accept=".csv"/></div>
            <div class="fname" id="nameB">—</div>
          </div>
          <div style="margin-top:6px"><button id="btnLoadB" style="min-width:180px">Load CSV → B</button></div>

          <div class="hr"></div>
          <div class="row2">
            <div class="stat" id="status"><span>Status</span><b>Ready.</b></div>
            <button id="btnReset">Reset (clear files, lights, labels)</button>
          </div>
          <small class="hint">Reset clears page state and lights. It can’t remove a file already downloaded to your computer.</small>
        </section>

        <!-- Panel A -->
        <section class="card" style="margin-top:14px">
          <div class="panelHeader">
            <h2>Panel A — Enriched CSV (edit)</h2>
            <div class="metaBox">
              <label>BPM <input id="metaBpmA" class="xs" type="number" min="40" max="220" step="1" value="100"/></label>
              <label>Key <input id="metaKeyA" class="tight" type="text" value="C major"/></label>
              <span class="chip">Rows: <b id="rowCountA">0</b></span>
              <span class="chip">Cadences: <span id="cadTagsA" class="pill">—</span></span>
            </div>
          </div>
          <div class="toolbar" style="margin:8px 0">
            <button id="btnAddRowA">Add Row</button>
            <button id="btnDeleteRowsA">Delete Selected</button>
            <button id="btnSortTA">Sort by t</button>
            <button id="btnClampTA">Clamp t to 0–60</button>
            <button id="btnApplyA">Apply Changes</button>
            <button id="btnExportA">Export CSV (A)</button>
          </div>
          <div style="overflow:auto; max-height:320px; border:1px solid var(--border); border-radius:10px">
            <table id="tableA">
              <thead>
                <tr>
                  <th class="cbx"><input type="checkbox" id="chkAllA"/></th>
                  <th class="xs">t</th><th class="xs">midi</th><th class="xs">vel</th><th class="xs">dur</th>
                  <th class="xs">is_bass</th><th class="xs">bar</th><th class="xs">beat</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Panel B -->
        <section class="card" style="margin-top:14px">
          <div class="panelHeader">
            <h2>Panel B — Enriched CSV (edit)</h2>
            <div class="metaBox">
              <label>BPM <input id="metaBpmB" class="xs" type="number" min="40" max="220" step="1" value="100"/></label>
              <label>Key <input id="metaKeyB" class="tight" type="text" value="C major"/></label>
              <span class="chip">Rows: <b id="rowCountB">0</b></span>
              <span class="chip">Cadences: <span id="cadTagsB" class="pill">—</span></span>
            </div>
          </div>
          <div class="toolbar" style="margin:8px 0">
            <button id="btnAddRowB">Add Row</button>
            <button id="btnDeleteRowsB">Delete Selected</button>
            <button id="btnSortTB">Sort by t</button>
            <button id="btnClampTB">Clamp t to 0–60</button>
            <button id="btnApplyB">Apply Changes</button>
            <button id="btnExportB">Export CSV (B)</button>
          </div>
          <div style="overflow:auto; max-height:320px; border:1px solid var(--border); border-radius:10px">
            <table id="tableB">
              <thead>
                <tr>
                  <th class="cbx"><input type="checkbox" id="chkAllB"/></th>
                  <th class="xs">t</th><th class="xs">midi</th><th class="xs">vel</th><th class="xs">dur</th>
                  <th class="xs">is_bass</th><th class="xs">bar</th><th class="xs">beat</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- ========== RIGHT COLUMN ========== -->
      <aside class="stage">
        <!-- Tempo -->
        <section class="card">
          <h2>Pace (Tempo) — select & apply</h2>
          <small class="hint">Standard Italian markings.</small>
          <div id="tempoList" class="tempoGrid" style="margin-top:8px"></div>
          <div class="applyRow" style="margin-top:10px">
            <button id="applyTempoA">Apply to A</button>
            <button id="applyTempoB">Apply to B</button>
            <button id="applyTempoBoth">Apply to Both</button>
            <button id="autoLabelTempo">Auto-label from BPM (A & B)</button>
          </div>
          <div class="hr"></div>
          <div class="stat"><span>Selected tempo</span><b id="tempoSel">—</b></div>
        </section>

        <!-- Cadences -->
        <section class="card">
          <h2>Cadences — choose & tag</h2>
          <small class="hint">Tick any that apply, then tag Panel A/B.</small>
          <div id="cadenceList" class="cadList" style="margin-top:8px"></div>
          <div class="applyRow" style="margin-top:10px">
            <button id="tagCadA">Apply to A</button>
            <button id="tagCadB">Apply to B</button>
            <button id="clearCad">Clear selection</button>
          </div>
        </section>

        <!-- Mixer -->
        <section class="card">
          <h2>Mixer — Smooth Engine</h2>
          <div class="mixerGrid">
            <div class="sliderRow">
              <span>Master</span>
              <input id="volMaster" type="range" min="0" max="1" step="0.01" value="0.6"/>
              <span id="volMasterVal">0.60</span>
            </div>
            <div class="sliderRow">
              <span>Reverb</span>
              <input id="reverbAmt" type="range" min="0" max="1" step="0.01" value="0.18"/>
              <span id="reverbAmtVal">0.18</span>
            </div>
            <div class="sliderRow">
              <span>Tone (LPF)</span>
              <input id="toneLPF" type="range" min="500" max="12000" step="100" value="5500"/>
              <span id="toneLPFVal">5.5k</span>
            </div>
            <div class="sliderRow">
              <span>Poly Cap/Ch</span>
              <input id="polyCap" type="range" min="2" max="16" step="1" value="8"/>
              <span id="polyCapVal">8</span>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row2">
            <div class="stat"><span>Engine</span><b id="engineStatus">Initializing…</b></div>
            <div class="stat"><span>Output</span>
              <select id="midiOut"></select>
            </div>
          </div>
        </section>

        <!-- Stage -->
        <section class="card">
          <h2>Stage — 32 Chairs (A:16 • B:16)</h2>
          <div class="flex" style="margin-bottom:8px">
            <label>Composer (Conductor)
              <select id="conductorSel">
                <option value="mozart">Mozart — light swing, soft dynamics</option>
                <option value="beethoven">Beethoven — bold accents, wider dynamics</option>
                <option value="stravinsky">Stravinsky — tight, percussive, low swing</option>
                <option value="debussy">Debussy — soft attack, wider timing blur</option>
                <option value="williams" selected>John Williams — cinematic sheen, steady pulse</option>
              </select>
            </label>
            <span class="badge">Click = mute/unmute • Alt+Click = next instrument</span>
          </div>
          <div class="rowBtns" style="margin-bottom:8px">
            <button id="btnRandA">Randomize A (16)</button>
            <button id="btnRandB">Randomize B (16)</button>
          </div>
          <div class="seating" id="seating"></div>
          <div class="hr"></div>
          <div class="rowBtns">
            <button id="btnPlay">▶ Play 60s</button>
            <button id="btnStop">■ Stop</button>
            <button id="btnTestChord">Test Chord</button>
            <span class="legend">Channels: A→1–8 • B→9–16 (chairs define programs & mutes)</span>
          </div>
          <small class="mini">If WebMIDI isn’t available, an upgraded WebAudio synth runs with anti-click envelopes, filter, limiter, and reverb.</small>
        </section>
      </aside>
    </div>
  </div>
<script>
/* ========= Core state ========= */
let LAST_ANALYSIS = { events: [], meta: { bpm: 100, key: "C major" } };
let A = { events: [], meta: { bpm: 100, key: "C major" }, cadences: [] };
let B = { events: [], meta: { bpm: 100, key: "C major" }, cadences: [] };

const $ = id => document.getElementById(id);
const detKey = $("detKey"), detBPM = $("detBPM");
const statusVal = $("status").lastElementChild;
const dotAnalyze=$("dotAnalyze"), dotExport=$("dotExport"), dotA=$("dotA"), dotB=$("dotB");
function light(el,on){ el?.classList.toggle("on", !!on); }
function updateExportLight(){
  const ready = (LAST_ANALYSIS.events?.length) || (A.events?.length) || (B.events?.length);
  light(dotExport, !!ready);
}

/* ========= CSV helpers ========= */
function csvEscape(v){ const s=String(v); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
function toEnrichedCSV(events, bpm, key){
  const header = "t,midi,vel,dur,is_bass,bar,beat,bpm,key";
  const rows = events.map(e => [
    (e.t ?? 0).toFixed(3), e.midi|0, Math.round((e.vel ?? 0.7)*127),
    (e.dur ?? (e.isBass?0.450:0.280)).toFixed(3), e.isBass?1:0, e.bar|0,
    (e.beat ?? 1).toFixed(3), bpm|0, key
  ].map(csvEscape).join(","));
  return [header, ...rows].join("\n");
}
function parseEnrichedCSV(text){
  const lines=text.replace(/\r/g,'').trim().split('\n'); if(!lines.length) throw new Error("Empty CSV.");
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const required=['t','midi','vel','dur','is_bass','bar','beat','bpm','key'];
  for(const k of required){ if(hdr.indexOf(k)<0) throw new Error("CSV must include: "+required.join(',')); }
  const idxs=Object.fromEntries(hdr.map((h,i)=>[h,i]));
  const out=[], meta={bpm:100,key:"C major"};
  for(let i=1;i<lines.length;i++){
    const r=lines[i].split(','); if(r.length<hdr.length) continue;
    const t=parseFloat(r[idxs.t]), midi=parseInt(r[idxs.midi],10);
    const vel=(parseFloat(r[idxs.vel])||90)/127; const dur=parseFloat(r[idxs.dur]);
    const isb=+r[idxs.is_bass]===1; const bar=parseInt(r[idxs.bar],10); const beat=parseFloat(r[idxs.beat]);
    const bpm=parseInt(r[idxs.bpm],10); const key=(r[idxs.key]||'C major').trim();
    if(i===1){ if(Number.isFinite(bpm)) meta.bpm=bpm; meta.key=key; }
    if(Number.isFinite(t)&&Number.isFinite(midi)) out.push({t,midi,vel,dur,isBass:isb,bar:bar||1,beat:beat||1});
  }
  out.sort((a,b)=>a.t-b.t);
  return {events:out, meta};
}

/* ========= Music/key detection ========= */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; }
  return best.name; }
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0;}
function acPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++)mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=(frame[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const minF=60,maxF=1000,minLag=Math.floor(sr/maxF),maxLag=Math.floor(sr/minF); let bestLag=0,best=0;
  for(let lag=minLag;lag<=Math.min(maxLag,N-2);lag++){let s=0;for(let i=0;i<N-lag;i++) s+=frame[i]*frame[i+lag]; if(s>best){best=s;bestLag=lag;}}
  return bestLag? sr/bestLag : 0;
}
function barsBeats(t,bpm){ const spb=60/Math.max(40,Math.min(220,bpm)); const beat=t/spb; return {bar:Math.floor(beat/4)+1, beat:(beat%4)+1}; }

/* ========= Analyzer ========= */
async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  statusVal.textContent="Decoding…"; light(dotAnalyze,false);
  const arr=await file.arrayBuffer();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await ctx.decodeAudioData(arr.slice(0));
  const sr=buf.sampleRate, ch=buf.numberOfChannels, N=Math.min(buf.length, sr*60|0);

  const mono=new Float32Array(N);
  for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<N;i++) mono[i]+=d[i]/ch; }

  const frame=4096, hop=2048;
  const pc=new Float32Array(12); const on=[]; const notes=[]; let prevE=0;
  for(let st=0; st+frame<=N; st+=hop){
    const fr=mono.subarray(st,st+frame); let E=0; for(let i=0;i<fr.length;i++) E+=fr[i]*fr[i];
    const dE=E-prevE; prevE=E; if(dE>0.08) on.push(st);
    let f=acPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
    if(f){ const midi=Math.round(69+12*Math.log2(f/440)); pc[(midi%12+12)%12]++; notes.push({t:st/sr,midi}); }
  }

  const keyName=correlate(Array.from(pc));
  const dif=[]; for(let i=1;i<on.length;i++){ const dt=(on[i]-on[i-1])/sr; if(dt>0.18&&dt<2.2) dif.push(dt); }
  let bpm=100; if(dif.length){ const s=[...dif].sort((a,b)=>a-b), m=s[Math.floor(s.length/2)]; bpm=Math.round(60/m); while(bpm<60) bpm*=2; while(bpm>180) bpm=Math.round(bpm/2); }

  const events=[]; const beatLen=60/Math.max(40,Math.min(220,bpm)); const grid=beatLen*4*0.125;
  for(const n of notes){
    const q=Math.max(0,Math.min(60,Math.round(n.t/grid)*grid));
    const {bar,beat}=barsBeats(q,bpm);
    events.push({t:q,midi:n.midi,vel:0.7,dur:0.28,isBass:n.midi<=43,bar,beat});
  }

  LAST_ANALYSIS={events, meta:{bpm, key:keyName}};
  detKey.textContent=keyName; detBPM.textContent=String(bpm);
  statusVal.textContent="Analysis complete — ready to export.";
  light(dotAnalyze,true); updateExportLight();
  const guess = tempoNameFor(bpm); $("tempoSel").textContent = `${guess.name} (${guess.range})`;
}

/* ========= Wire top UI ========= */
const audioFile=$("audioFile");
$("btnLoadAudio").onclick=()=>audioFile.click();
$("btnAnalyze").onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
$("btnExport").onclick=()=>{
  let src=null, meta=null;
  if(LAST_ANALYSIS.events.length){ src=LAST_ANALYSIS.events; meta=LAST_ANALYSIS.meta; }
  else if(A.events.length){ src=A.events; meta=A.meta; }
  else if(B.events.length){ src=B.events; meta=B.meta; }
  if(!src){ alert("Analyze 60s or load an enriched CSV first."); return; }
  const csv = toEnrichedCSV(src, meta.bpm, meta.key);
  const blob=new Blob([csv],{type:"text/csv"}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  updateExportLight();
};

/* ========= Load CSV → A/B ========= */
function showFileName(el, name){ el.textContent = name || "—"; }
$("csvA").addEventListener("change", e => showFileName($("nameA"), e.target.files?.[0]?.name || "—"));
$("csvB").addEventListener("change", e => showFileName($("nameB"), e.target.files?.[0]?.name || "—"));

async function loadCSVto(side, fileInput, nameEl, lightEl){
  const f=fileInput.files?.[0]; if(!f){ alert(`Choose an enriched CSV for ${side}`); return; }
  try{
    const {events, meta}=parseEnrichedCSV(await f.text());
    if(side==='A'){ A={events, meta, cadences:A.cadences||[]}; renderPanel('A'); }
    else { B={events, meta, cadences:B.cadences||[]}; renderPanel('B'); }
    detKey.textContent = meta.key || "C major";
    detBPM.textContent = String(meta.bpm || 100);
    showFileName(nameEl, f.name);
    statusVal.textContent = `${side} loaded: ${events.length} rows (bpm=${meta.bpm||'?'}, key=${meta.key||'?'})`;
    light(lightEl, true); updateExportLight();
    const guess = tempoNameFor(meta.bpm||100);
    $("tempoSel").textContent = `${guess.name} (${guess.range})`;
  }catch(err){
    statusVal.textContent = "Error loading CSV."; light(lightEl, false); alert(err.message);
  }
}
$("btnLoadA").onclick=()=>loadCSVto('A', $("csvA"), $("nameA"), dotA);
$("btnLoadB").onclick=()=>loadCSVto('B', $("csvB"), $("nameB"), dotB);

/* ========= Editable Panels ========= */
function rowHTML(side, e, idx){
  const chkId = `select-${side}-${idx}`;
  return `
    <tr data-i="${idx}">
      <td class="cbx"><input type="checkbox" id="${chkId}"/></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.t??0).toFixed(3)}"></td>
      <td><input class="xs" type="number" step="1" value="${e.midi|0}"></td>
      <td><input class="xs" type="number" step="1" value="${Math.round((e.vel??0.7)*127)}"></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.dur??(e.isBass?0.450:0.280)).toFixed(3)}"></td>
      <td class="cbx"><input type="checkbox" ${e.isBass?'checked':''}></td>
      <td><input class="xs" type="number" step="1" value="${e.bar|0}"></td>
      <td><input class="xs" type="number" step="0.001" value="${(e.beat??1).toFixed(3)}"></td>
    </tr>
  `;
}
function renderCadTags(){
  $("cadTagsA").textContent = (A.cadences?.length)? A.cadences.join(", ") : "—";
  $("cadTagsB").textContent = (B.cadences?.length)? B.cadences.join(", ") : "—";
}
function renderPanel(side){
  const m = (side==='A')? A : B;
  (side==='A'? $("metaBpmA"): $("metaBpmB")).value = String(m.meta.bpm||100);
  (side==='A'? $("metaKeyA"): $("metaKeyB")).value = String(m.meta.key||"C major");
  (side==='A'? $("rowCountA"): $("rowCountB")).textContent = String(m.events.length);
  renderCadTags();
  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  tbody.innerHTML = m.events.map((e,i)=>rowHTML(side,e,i)).join('');
}
function readPanel(side){
  const m = (side==='A')? A : B;
  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  const rows=[...tbody.querySelectorAll('tr')]; const out=[];
  rows.forEach(tr=>{
    const inputs=[...tr.querySelectorAll('input')];
    const t=parseFloat(inputs[1].value), midi=parseInt(inputs[2].value,10);
    const vel=Math.max(0,Math.min(127, parseInt(inputs[3].value,10)||0))/127;
    const dur=parseFloat(inputs[4].value), isb=inputs[5].checked;
    const bar=parseInt(inputs[6].value,10)||1, beat=parseFloat(inputs[7].value)||1;
    if(Number.isFinite(t)&&Number.isFinite(midi)) out.push({t,midi,vel,dur,isBass:isb,bar,beat});
  });
  const bpm=parseInt((side==='A'?$("metaBpmA"):$("metaBpmB")).value,10)||100;
  const key=(side==='A'?$("metaKeyA"):$("metaKeyB")).value||"C major";
  m.events = out.sort((a,b)=>a.t-b.t); m.meta={bpm,key};
  (side==='A'? $("rowCountA"): $("rowCountB")).textContent = String(m.events.length);
  updateExportLight();
}
function addRow(side){ const m=(side==='A')?A:B; m.events.push({t:0,midi:60,vel:0.7,dur:0.28,isBass:false,bar:1,beat:1}); renderPanel(side); }
function deleteSelected(side){
  const tbody = (side==='A')? $("tableA").querySelector('tbody') : $("tableB").querySelector('tbody');
  const rows=[...tbody.querySelectorAll('tr')]; const keep=[];
  rows.forEach(tr=>{
    const checked = tr.querySelector('td input[type="checkbox"]').checked;
    if(!checked){
      const i=[...tr.querySelectorAll('input')];
      const t=parseFloat(i[1].value), midi=parseInt(i[2].value,10);
      const vel=Math.max(0,Math.min(127, parseInt(i[3].value,10)||0))/127;
      const dur=parseFloat(i[4].value), isb=i[5].checked;
      const bar=parseInt(i[6].value,10)||1, beat=parseFloat(i[7].value)||1;
      if(Number.isFinite(t)&&Number.isFinite(midi)) keep.push({t,midi,vel,dur,isBass:isb,bar,beat});
    }
  });
  if(side==='A'){ A.events=keep.sort((a,b)=>a.t-b.t);} else { B.events=keep.sort((a,b)=>a.t-b.t); }
  renderPanel(side);
}
function sortByTime(side){ readPanel(side); (side==='A'?A:B).events.sort((a,b)=>a.t-b.t); renderPanel(side); }
function clampTime(side){ readPanel(side); (side==='A'?A:B).events.forEach(e=>{ e.t=Math.max(0,Math.min(60,e.t));}); renderPanel(side); }

$("btnAddRowA").onclick=()=>addRow('A');
$("btnDeleteRowsA").onclick=()=>deleteSelected('A');
$("btnSortTA").onclick=()=>sortByTime('A');
$("btnClampTA").onclick=()=>clampTime('A');
$("btnApplyA").onclick=()=>{ readPanel('A'); statusVal.textContent="Applied changes to Panel A."; };
$("btnExportA").onclick=()=>{ readPanel('A'); const csv=toEnrichedCSV(A.events,A.meta.bpm,A.meta.key);
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='panel_A_notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0); updateExportLight();};
$("chkAllA").onclick=(e)=>{ $("tableA").querySelectorAll('tbody tr td input[type=\"checkbox\"]').forEach(c=>c.checked=e.target.checked); };

$("btnAddRowB").onclick=()=>addRow('B');
$("btnDeleteRowsB").onclick=()=>deleteSelected('B');
$("btnSortTB").onclick=()=>sortByTime('B');
$("btnClampTB").onclick=()=>clampTime('B');
$("btnApplyB").onclick=()=>{ readPanel('B'); statusVal.textContent="Applied changes to Panel B."; };
$("btnExportB").onclick=()=>{ readPanel('B'); const csv=toEnrichedCSV(B.events,B.meta.bpm,B.meta.key);
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='panel_B_notes_60s_enriched.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0); updateExportLight();};
$("chkAllB").onclick=(e)=>{ $("tableB").querySelectorAll('tbody tr td input[type=\"checkbox\"]').forEach(c=>c.checked=e.target.checked); };

/* ========= Reset ========= */
$("btnReset").onclick=()=>{
  LAST_ANALYSIS={events:[], meta:{bpm:100,key:"C major"}};
  A={events:[], meta:{bpm:100,key:"C major"}, cadences:[]};
  B={events:[], meta:{bpm:100,key:"C major"}, cadences:[]};
  $("audioFile").value=""; $("csvA").value=""; $("csvB").value="";
  $("nameA").textContent="—"; $("nameB").textContent="—";
  detKey.textContent="–"; detBPM.textContent="–";
  light(dotAnalyze,false); light(dotExport,false); light(dotA,false); light(dotB,false);
  $("metaBpmA").value="100"; $("metaKeyA").value="C major"; $("rowCountA").textContent="0";
  $("metaBpmB").value="100"; $("metaKeyB").value="C major"; $("rowCountB").textContent="0";
  $("tableA tbody").innerHTML=""; $("tableB tbody").innerHTML="";
  $("tempoSel").textContent="—"; renderCadTags(); statusVal.textContent="Reset complete. Ready.";
  initSeating(); renderSeating();
};

/* ========= Tempo UI ========= */
const TEMPOS=[
  {name:"Larghissimo",range:"≤24",lo:0,hi:24},{name:"Grave / Adagissimo",range:"24–40",lo:24,hi:40},
  {name:"Largo",range:"40–66",lo:40,hi:66},{name:"Larghetto",range:"44–66",lo:44,hi:66},
  {name:"Adagio",range:"44–66",lo:44,hi:66},{name:"Adagietto",range:"46–80",lo:46,hi:80},
  {name:"Lento",range:"52–108",lo:52,hi:108},{name:"Andante",range:"56–108",lo:56,hi:108},
  {name:"Andantino",range:"60–112",lo:60,hi:112},{name:"Moderato",range:"88–112",lo:88,hi:112},
  {name:"Allegretto",range:"100–128",lo:100,hi:128},{name:"Allegro",range:"120–168",lo:120,hi:168},
  {name:"Vivace",range:"156–176",lo:156,hi:176},{name:"Vivacissimo",range:"172–184",lo:172,hi:184},
  {name:"Presto",range:"168–200",lo:168,hi:200},{name:"Prestissimo",range:">200",lo:200,hi:400}
];
let tempoPickedIndex=-1;
function renderTempoList(){
  const box=$("tempoList"); box.innerHTML="";
  TEMPOS.forEach((t,i)=>{
    const btn=document.createElement('button'); btn.className="tempoBtn";
    btn.innerHTML=`<span>${t.name}</span><span class="pill">${t.range} bpm</span>`;
    btn.onclick=()=>{ tempoPickedIndex=i; $("tempoSel").textContent=`${t.name} (${t.range})`; };
    box.appendChild(btn);
  });
}
function tempoNameFor(bpm){
  let best=TEMPOS[0],bestDist=Infinity;
  for(const t of TEMPOS){
    if(bpm>=t.lo && bpm<=t.hi) return {name:t.name,range:t.range};
    const dist=(bpm<t.lo)?(t.lo-bpm):(bpm>t.hi)?(bpm-t.hi):0;
    if(dist<bestDist){ bestDist=dist; best=t; }
  }
  return {name:best.name,range:best.range};
}
$("applyTempoA").onclick=()=>{ if(tempoPickedIndex<0){ alert("Pick a tempo first."); return; }
  const t=TEMPOS[tempoPickedIndex], mid=Math.round((t.lo+t.hi)/2);
  $("metaBpmA").value=String(mid); A.meta.bpm=mid; renderPanel('A'); statusVal.textContent=`Tempo ${t.name} → A (${mid} bpm)`; };
$("applyTempoB").onclick=()=>{ if(tempoPickedIndex<0){ alert("Pick a tempo first."); return; }
  const t=TEMPOS[tempoPickedIndex], mid=Math.round((t.lo+t.hi)/2);
  $("metaBpmB").value=String(mid); B.meta.bpm=mid; renderPanel('B'); statusVal.textContent=`Tempo ${t.name} → B (${mid} bpm)`; };
$("applyTempoBoth").onclick=()=>{ if(tempoPickedIndex<0){ alert("Pick a tempo first."); return; }
  const t=TEMPOS[tempoPickedIndex], mid=Math.round((t.lo+t.hi)/2);
  $("metaBpmA").value=String(mid); $("metaBpmB").value=String(mid);
  A.meta.bpm=mid; B.meta.bpm=mid; renderPanel('A'); renderPanel('B'); statusVal.textContent=`Tempo ${t.name} → A & B (${mid} bpm)`; };
$("autoLabelTempo").onclick=()=>{ const a=parseInt($("metaBpmA").value||"100",10), an=tempoNameFor(a);
  const b=parseInt($("metaBpmB").value||"100",10), bn=tempoNameFor(b);
  $("tempoSel").textContent=`A: ${an.name} (${an.range}) • B: ${bn.name} (${bn.range})`;
  statusVal.textContent="Auto-labeled tempo names from BPM."; };

/* ========= Cadences ========= */
const CADENCES=[
  {id:"authentic_perfect",label:"Authentic (Perfect) — V→I"},
  {id:"authentic_imperfect",label:"Authentic (Imperfect) — V→I (inversion/top not tonic)"},
  {id:"half",label:"Half (Imperfect) — ?→V"},
  {id:"plagal",label:"Plagal — IV→I"},
  {id:"plagal_minor",label:"Minor Plagal — iv→I"},
  {id:"deceptive",label:"Deceptive / Interrupted — V→vi (or not I)"},
  {id:"phrygian",label:"Phrygian — iv⁶→V (minor)"},
  {id:"evaded",label:"Evaded — V⁷→I⁶"}
];
let cadenceSel=new Set();
function renderCadenceList(){
  const box=$("cadenceList"); box.innerHTML="";
  CADENCES.forEach(c=>{
    const id="cad_"+c.id; const div=document.createElement('label');
    div.style.display="flex"; div.style.alignItems="center"; div.style.gap="8px";
    div.innerHTML = `<input type="checkbox" id="${id}"/><span>${c.label}</span>`;
    box.appendChild(div);
    div.querySelector('input').onchange=(e)=>{ if(e.target.checked) cadenceSel.add(c.label); else cadenceSel.delete(c.label); };
  });
}
$("tagCadA").onclick=()=>{ A.cadences=[...cadenceSel]; renderCadTags(); statusVal.textContent="Cadence tags applied to A."; };
$("tagCadB").onclick=()=>{ B.cadences=[...cadenceSel]; renderCadTags(); statusVal.textContent="Cadence tags applied to B."; };
$("clearCad").onclick=()=>{ cadenceSel.clear(); CADENCES.forEach(c=>{ const el=$("cad_"+c.id); if(el) el.checked=false; }); statusVal.textContent="Cadence selection cleared."; };

/* ========= Instruments & seating ========= */
const GM_NAMES=[/* 0..127 General MIDI names */"Acoustic Grand Piano","Bright Piano","Electric Grand","Honky-Tonk","Electric Piano 1","Electric Piano 2","Harpsichord","Clav","Celesta","Glockenspiel","Music Box","Vibraphone","Marimba","Xylophone","Tubular Bells","Dulcimer","Drawbar Organ","Percussive Organ","Rock Organ","Church Organ","Reed Organ","Accordion","Harmonica","Tango Accordion","Acoustic Guitar (nylon)","Acoustic Guitar (steel)","Electric Guitar (jazz)","Electric Guitar (clean)","Electric Guitar (muted)","Overdriven Guitar","Distortion Guitar","Guitar Harmonics","Acoustic Bass","Electric Bass (finger)","Electric Bass (pick)","Fretless Bass","Slap Bass 1","Slap Bass 2","Synth Bass 1","Synth Bass 2","Violin","Viola","Cello","Contrabass","Tremolo Strings","Pizzicato Strings","Orchestral Harp","Timpani","String Ensemble 1","String Ensemble 2","SynthStrings 1","SynthStrings 2","Choir Aahs","Voice Oohs","Synth Voice","Orchestra Hit","Trumpet","Trombone","Tuba","Muted Trumpet","French Horn","Brass Section","SynthBrass 1","SynthBrass 2","Soprano Sax","Alto Sax","Tenor Sax","Baritone Sax","Oboe","English Horn","Bassoon","Clarinet","Piccolo","Flute","Recorder","Pan Flute","Blown Bottle","Shakuhachi","Whistle","Ocarina","Lead 1 (square)","Lead 2 (sawtooth)","Lead 3 (calliope)","Lead 4 (chiff)","Lead 5 (charang)","Lead 6 (voice)","Lead 7 (fifths)","Lead 8 (bass+lead)","Pad 1 (new age)","Pad 2 (warm)","Pad 3 (polysynth)","Pad 4 (choir)","Pad 5 (bowed)","Pad 6 (metallic)","Pad 7 (halo)","Pad 8 (sweep)","FX 1 (rain)","FX 2 (soundtrack)","FX 3 (crystal)","FX 4 (atmosphere)","FX 5 (brightness)","FX 6 (goblins)","FX 7 (echoes)","FX 8 (sci-fi)","Sitar","Banjo","Shamisen","Koto","Kalimba","Bagpipe","Fiddle","Shanai","Tinkle Bell","Agogo","Steel Drums","Woodblock","Taiko Drum","Melodic Tom","Synth Drum","Reverse Cymbal","Guitar Fret Noise","Breath Noise","Seashore","Bird Tweet","Telephone Ring","Helicopter","Applause","Gunshot"];
const CHAIRS=[]; // 32
function initSeating(){
  CHAIRS.length=0;
  for(let i=0;i<32;i++){
    const side=(i<16)?'A':'B';
    const sectionIndex=(i%16)%8;
    const channel=(side==='A')? sectionIndex : (8+sectionIndex);
    const program=(side==='A')? 48 : 56; // defaults: strings vs brass
    CHAIRS.push({i,side,channel,program,on:true});
  }
}
function progName(p){ return GM_NAMES[p]||`Program ${p}`; }
function renderSeating(){
  const box=$("seating"); box.innerHTML="";
  CHAIRS.forEach(ch=>{
    const div=document.createElement('div');
    div.className="chair"+(ch.on?"":" off");
    div.title="Click: mute/unmute • Alt+Click: next instrument";
    div.innerHTML=`
      <div class="line1"><span class="side">${ch.side}</span><span class="prog">#${String(ch.program).padStart(3,'0')}</span></div>
      <div class="name">${progName(ch.program)}</div>
      <div class="chan">MIDI ch ${ch.channel+1}</div>`;
    div.onclick=(e)=>{ if(e.altKey){ ch.program=(ch.program+1)%128; ensureProgram(ch.channel,ch.program); renderSeating(); }
      else { ch.on=!ch.on; renderSeating(); } };
    box.appendChild(div);
  });
}
const FAMILIES={strings:[40,41,42,43,44,45,46,48,49,50],winds:[73,74,75,71,68,69,70,72],brass:[56,57,58,59,60],keys:[0,4,5,6,7,11,12,13],pads:[88,89,90,91,92,93,94,95],bass:[32,33,34,35,36,37,38,39]};
function pickFrom(list){ return list[Math.floor(Math.random()*list.length)]; }
function randomizeSide(side){
  const idxs=CHAIRS.filter(c=>c.side===side).map(c=>c.i);
  const plan=[...Array(4).fill('strings'),...Array(3).fill('winds'),...Array(3).fill('brass'),...Array(3).fill('keys'),...Array(2).fill('bass'),...Array(1).fill('pads')].slice(0,16);
  plan.sort(()=>Math.random()-0.5);
  idxs.forEach((ci,k)=>{ const fam=plan[k]||'strings'; const p=pickFrom(FAMILIES[fam]); CHAIRS[ci].program=p; CHAIRS[ci].on=true; ensureProgram(CHAIRS[ci].channel,p); });
}
$("btnRandA").onclick=()=>{ randomizeSide('A'); renderSeating(); statusVal.textContent="Randomized A (16)."; };
$("btnRandB").onclick=()=>{ randomizeSide('B'); renderSeating(); statusVal.textContent="Randomized B (16)."; };

/* ========= Conductor (feel) ========= */
const CONDUCTOR={ mozart:{swing:0.06,velCurve:0.85,jitterMs:10,accent:0.9},
  beethoven:{swing:0.02,velCurve:1.10,jitterMs:6,accent:1.2},
  stravinsky:{swing:0.00,velCurve:1.00,jitterMs:3,accent:1.15},
  debussy:{swing:0.03,velCurve:0.95,jitterMs:16,accent:0.85},
  williams:{swing:0.01,velCurve:1.05,jitterMs:5,accent:1.05} };
function currentFeel(){ return CONDUCTOR[$("conductorSel").value]||CONDUCTOR.williams; }

/* ========= Init small UIs ========= */
function initSmall(){
  renderTempoList(); renderCadenceList();
  initSeating(); renderSeating();
  $("conductorSel").onchange=()=>{ statusVal.textContent="Conductor feel updated."; };
}
</script>
<script>
/* ===================== MIXER / ENGINE ===================== */
const ACtx = window.AudioContext || window.webkitAudioContext;
let midiAccess=null, midiOutput=null, WA_ctx=null, masterGain=null, comp=null, revSend=null, revNode=null;

const engineStatusEl=$("engineStatus");
const volMaster=$("volMaster"), volMasterVal=$("volMasterVal");
const reverbAmt=$("reverbAmt"), reverbAmtVal=$("reverbAmtVal");
const toneLPF=$("toneLPF"), toneLPFVal=$("toneLPFVal");
const polyCapEl=$("polyCap"), polyCapVal=$("polyCapVal");

function fmtK(v){ return (v/1000).toFixed(1)+'k'; }
volMaster.oninput=()=>{ volMasterVal.textContent=Number(volMaster.value).toFixed(2); if(masterGain) masterGain.gain.setTargetAtTime(parseFloat(volMaster.value), WA_ctx.currentTime, 0.015); };
reverbAmt.oninput=()=>{ reverbAmtVal.textContent=Number(reverbAmt.value).toFixed(2); if(revSend) revSend.gain.setTargetAtTime(parseFloat(reverbAmt.value), WA_ctx.currentTime, 0.02); };
toneLPF.oninput=()=>{ toneLPFVal.textContent=fmtK(parseInt(toneLPF.value,10)); };
polyCapEl.oninput=()=>{ polyCapVal.textContent=String(parseInt(polyCapEl.value,10)); };

async function initMIDI(){
  try{
    midiAccess = await navigator.requestMIDIAccess({ sysex:false });
    const outs=[...midiAccess.outputs.values()];
    const sel=$("midiOut"); sel.innerHTML="";
    outs.forEach((o)=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=`${o.name}`; sel.appendChild(opt); });
    if(outs.length){ midiOutput=outs[0]; sel.value=outs[0].id; engineStatusEl.textContent="WebMIDI active"; }
    else { sel.innerHTML=`<option value="">(No MIDI outputs)</option>`; engineStatusEl.textContent="Fallback synth"; }
    sel.onchange=()=>{ const id=sel.value; midiOutput = midiAccess.outputs.get(id) || null; engineStatusEl.textContent = midiOutput? "WebMIDI active" : "Fallback synth"; };
  }catch{ engineStatusEl.textContent="Fallback synth"; }
}
function ensureAudio(){
  if(!WA_ctx){ WA_ctx=new ACtx(); }
  if(!masterGain){
    const ctx=WA_ctx;
    masterGain=ctx.createGain(); masterGain.gain.value=parseFloat(volMaster.value);

    comp=ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-14,ctx.currentTime);
    comp.knee.setValueAtTime(12,ctx.currentTime);
    comp.ratio.setValueAtTime(6,ctx.currentTime);
    comp.attack.setValueAtTime(0.003,ctx.currentTime);
    comp.release.setValueAtTime(0.20,ctx.currentTime);

    revSend=ctx.createGain(); revSend.gain.value=parseFloat(reverbAmt.value);
    revNode=createSmallIR(ctx);

    // Mix: dry → comp → master; reverb send → convolver → comp
    revSend.connect(revNode); revNode.connect(comp);
    masterGain.connect(comp); comp.connect(ctx.destination);
  }
}
function createSmallIR(ctx){
  // Tiny room impulse (Schroeder-like noise burst)
  const len = Math.floor(ctx.sampleRate*1.6);
  const ir = ctx.createBuffer(2,len,ctx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d = ir.getChannelData(ch);
    for(let i=0;i<len;i++){
      const t=i/ctx.sampleRate;
      d[i]=(Math.random()*2-1)*Math.pow(1-t/1.6, 3); // decaying noise
    }
  }
  const con = ctx.createConvolver(); con.buffer=ir; return con;
}

/* ===================== WebMIDI helpers ===================== */
function sendMIDI(status,d1=0,d2=0){ if(!midiOutput) return; midiOutput.send([status,d1,d2]); }
function chStatus(cmd,ch){ return (cmd&0xF0)|(ch&0x0F); }
function noteOn(ch,key,vel){ sendMIDI(chStatus(0x90,ch), key&0x7F, vel&0x7F); }
function noteOff(ch,key){ sendMIDI(chStatus(0x80,ch), key&0x7F, 0); }
function programChange(ch,prog){ sendMIDI(chStatus(0xC0,ch), prog&0x7F, 0); }
function ctrl(ch,cc,val){ sendMIDI(chStatus(0xB0,ch), cc&0x7F, val&0x7F); }

/* ===================== WebAudio synth (smooth) ===================== */
const WA_voices = new Map(); // key `${ch}:${note}` → voice
const PER_CH_ACTIVE = Array.from({length:16}, ()=>new Set()); // track polyphony per channel

function midiToHz(n){ return 440*Math.pow(2,(n-69)/12); }
function progToWave(p){
  if(p>=40 && p<=51) return 'sawtooth';     // strings/pads
  if(p>=56 && p<=63) return 'square';       // brass
  if(p>=73 && p<=79) return 'sine';         // winds
  if(p>=0 && p<=7)   return 'triangle';     // pianos
  if(p>=32 && p<=39) return 'square';       // bass
  return 'triangle';
}
function makeVoice(ch,key,vel,prog){
  ensureAudio();
  const ctx=WA_ctx;
  const voice = {};
  // Per-voice chain: osc -> filter -> panner -> dryGain -> masterGain
  const osc=ctx.createOscillator(); osc.type=progToWave(prog);
  const filter=ctx.createBiquadFilter(); filter.type='lowpass'; filter.Q.value=0.6; filter.frequency.value=parseFloat(toneLPF.value);
  const pan=ctx.createStereoPanner(); pan.pan.value = ( (ch%8) - 3.5 ) * 0.14; // subtle stage width
  const dry=ctx.createGain(); const send=ctx.createGain();

  // Gain staging with de-click envelope
  const now=ctx.currentTime;
  const v = Math.max(0.02, Math.min(1, vel/127));
  dry.gain.setValueAtTime(0, now);
  dry.gain.linearRampToValueAtTime(v*0.55, now+0.006);    // quick attack
  dry.gain.exponentialRampToValueAtTime(0.0006, now+3.0); // auto-decay safety

  send.gain.value = parseFloat(reverbAmt.value)*0.6; // send after master control

  osc.frequency.value=midiToHz(key);
  osc.connect(filter).connect(pan).connect(dry).connect(masterGain);
  // Reverb send taps post filter, pre dry gain
  filter.connect(send); send.connect(revSend);

  voice.osc=osc; voice.filter=filter; voice.pan=pan; voice.dry=dry; voice.ch=ch; voice.key=key;
  osc.start(now);
  return voice;
}
function stopVoice(voice, fast=false){
  if(!voice || !WA_ctx) return;
  const t=WA_ctx.currentTime;
  try{
    voice.dry.gain.cancelScheduledValues(t);
    voice.dry.gain.setTargetAtTime(0.0001,t, fast?0.01:0.04);
    setTimeout(()=>{ try{voice.osc.stop(); voice.osc.disconnect(); voice.filter.disconnect(); voice.pan.disconnect(); voice.dry.disconnect();}catch{} }, fast?60:140);
  }catch{}
}
function wa_noteOn(ch,key,vel,prog){
  ensureAudio();
  // Poly cap per channel
  const cap = parseInt(polyCapEl.value,10);
  const active = PER_CH_ACTIVE[ch];
  if(active.size >= cap){
    // drop the oldest (FIFO)
    const oldestKey = active.values().next().value;
    const vo = WA_voices.get(`${ch}:${oldestKey}`);
    stopVoice(vo, true);
    WA_voices.delete(`${ch}:${oldestKey}`);
    active.delete(oldestKey);
  }
  const voice = makeVoice(ch,key,vel,prog);
  WA_voices.set(`${ch}:${key}`, voice);
  active.add(key);
}
function wa_noteOff(ch,key){
  const k=`${ch}:${key}`; const v=WA_voices.get(k);
  if(v){ stopVoice(v); WA_voices.delete(k); PER_CH_ACTIVE[ch].delete(key); }
}
function ensureProgramWA(){ /* handled by progToWave at noteOn */ }

/* Unified send */
function ensureProgramUnified(ch,prog){ if(midiOutput) programChange(ch,prog); }
function U_noteOn(ch,key,vel,prog){ if(midiOutput) noteOn(ch,key,vel); else wa_noteOn(ch,key,vel,prog); }
function U_noteOff(ch,key){ if(midiOutput) noteOff(ch,key); else wa_noteOff(ch,key); }
function ensureProgram(ch,prog){ if(midiOutput) programChange(ch,prog); }

/* ===================== Feel & scheduling ===================== */
function humanize(ms){ return (Math.random()*2-1)*ms; }
function applySwingSec(tSec,bpm,swing){ const spb=60/bpm, eighth=spb/2; const which=Math.round(tSec/eighth); return (which%2===1)? (tSec + swing*eighth) : tSec; }
function velCurve(v0,curve){ const v=Math.max(1,Math.min(127,Math.round(Math.pow(v0/127,curve)*127))); return v; }

function buildQueue(){
  readPanel('A'); readPanel('B');
  const q=[];
  const add=(side,events,bpm)=>{
    const base=(side==='A')?0:8;
    events.forEach(e=>{
      const section=e.isBass?0:(Math.floor(e.midi%8));
      const ch=base+(section%8);
      const chairsHere=CHAIRS.filter(c=>c.side===side && c.channel===ch);
      const anyOn=chairsHere.some(c=>c.on);
      const program=(chairsHere.find(c=>c.on)?.program) ?? ((side==='A')?48:56);
      q.push({t:e.t, midi:e.midi, vel:Math.round((e.vel||0.7)*127), dur:e.dur||0.28, ch, bpm, program, audible:anyOn});
    });
  };
  add('A',A.events,A.meta.bpm||100);
  add('B',B.events,B.meta.bpm||100);
  q.sort((a,b)=>a.t-b.t);
  return q;
}

/* Transport */
let playing=false, playTimer=null;
function allNotesOff(){
  if(midiOutput){ for(let ch=0;ch<16;ch++){ try{ctrl(ch,123,0);}catch{} } }
  // Stop WebAudio voices
  WA_voices.forEach(v=>stopVoice(v,true));
  WA_voices.clear(); PER_CH_ACTIVE.forEach(s=>s.clear());
}
function startPlay(){
  // iOS/Chrome policy: resume audio on gesture
  if(WA_ctx && WA_ctx.state==='suspended'){ WA_ctx.resume(); }
  if(playing) return;
  const feel=currentFeel(); const Q=buildQueue();
  if(!Q.length){ alert("Load CSV or Analyze first — no events to play."); return; }

  // Ensure programs
  for(const c of CHAIRS){ if(c.on) ensureProgramUnified(c.channel,c.program); }

  playing=true; statusVal.textContent="Playing… (60s)";
  const t0=performance.now();

  Q.forEach(evt=>{
    const whenSec = applySwingSec(evt.t, evt.bpm, feel.swing) + (humanize(feel.jitterMs)/1000);
    const when = Math.max(0, whenSec*1000);
    const vel = velCurve(evt.vel, feel.velCurve);
    const durMs = Math.max(60, Math.min(4000, (evt.dur||0.28)*1000));

    setTimeout(()=>{
      if(!playing) return;
      if(evt.audible){ U_noteOn(evt.ch, evt.midi, Math.round(vel*feel.accent), evt.program); }
    }, when);

    setTimeout(()=>{
      if(!playing) return;
      U_noteOff(evt.ch, evt.midi);
    }, when + durMs);
  });

  playTimer=setTimeout(stopPlay, 62000);
}
function stopPlay(){
  if(!playing) return;
  playing=false;
  clearTimeout(playTimer); playTimer=null;
  allNotesOff();
  statusVal.textContent="Stopped.";
}

/* Buttons */
$("btnPlay").onclick=startPlay;
$("btnStop").onclick=stopPlay;
$("btnTestChord").onclick=()=>{
  const t=[{ch:0,n:60},{ch:1,n:64},{ch:2,n:67},{ch:8,n:55},{ch:9,n:59},{ch:10,n:62}];
  t.forEach(o=>{
    const prog=(CHAIRS.find(c=>c.channel===o.ch && c.on)?.program) ?? 48;
    U_noteOn(o.ch,o.n,96,prog); setTimeout(()=>U_noteOff(o.ch,o.n), 520);
  });
};

/* Init */
initMIDI().finally(()=>{ /* if MIDI not available, fallback stays */ });
initSmall();
</script>
</body>
</html>
