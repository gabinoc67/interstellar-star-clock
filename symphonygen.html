<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Audio→CSV • A:10–16 + B:6–16 (sum 32, non-overlap) • 60s Orchestrator • 32 Chairs</title>
<style>
:root{
  --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758;
  --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --blink:#6ee7ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0}
main{max-width:1500px;margin:0 auto;padding:16px;display:grid;grid-template-columns:520px 1fr;gap:16px}
.card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="file"],button,select,input[type="range"],input[type="number"]{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
}
button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
button:hover{filter:brightness(1.06)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
.stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
.stat b{color:var(--ok)}
#status{font-size:12px;color:#9ad1ff;margin-top:8px}
.danger{background:#3b1220;border-color:#6b1f35}
small.hint{display:block;color:#a8b7e3;margin-top:6px}

/* Stage */
.stage{
  position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;
  padding-top:300px;
  background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)
}
.stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}

/* 32 chairs grid */
.grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(4,1fr);gap:10px;min-height:620px}
.cell{display:flex;align-items:center;justify-content:center;min-height:115px}
.section{
  background:linear-gradient(180deg,#0e1b43,#0a1232);
  border:1px solid #20326d;border-radius:12px;width:100%;height:100%;
  padding:10px;display:flex;flex-direction:column;gap:6px;justify-content:space-between;
}
.title{font-weight:800;color:#e4eeff;font-size:12px}
.meta{font-size:11px;color:#9bb9ff}
.lights{display:flex;align-items:center;gap:6px}
.dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
.blink{animation:blink .45s ease-out}
@keyframes blink{
  0%{background:#0c1430;border-color:#2a3b7a}
  30%{background:var(--blink);border-color:#bfefff}
  100%{background:#0c1430;border-color:#2a3b7a}
}
.check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;display:flex;align-items:center;justify-content:center;font-weight:900}
.checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
.mixRow{display:flex;gap:6px;align-items:center}
.btnSmall{padding:6px 8px;font-size:11px}

/* Conductor + guide */
.conductor{
  width:92px;height:92px;border-radius:50%;
  background:#0d1b44;border:2px solid #284a9b;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#cfe1ff;
  box-shadow:0 0 0 0 rgba(59,130,246,.45);
  animation:conPulse 1.4s ease-in-out infinite;animation-play-state:paused;
}
@keyframes conPulse{
  0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}
  70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}
  100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
}
.guide{
  position:absolute; left:50%; transform:translateX(-50%); top:118px; width:96%; max-width:1000px;
  background:#0c1536; border:1px solid #274094; border-radius:12px; padding:10px 12px; color:#cfe1ff; font-size:12px;
}
.guide b{color:#9fe8ff}
.guide ol{margin:6px 0 0 16px; padding-left:10px}
.guide li{margin:2px 0}

/* status dots */
.statusDot{width:12px;height:12px;border-radius:3px;background:#ffffff;border:2px solid #dddddd;display:inline-block;}
.statusOn{background:var(--ok);border-color:#b7f5cd;}

/* Conductor square panel */
.conductorPanel{margin-top:12px; display:flex; justify-content:center;}
.condCard{
  width:260px; height:260px; border:1px solid var(--grid); border-radius:14px; background:#0d1b3d;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
}
.conLabel{font-size:12px;color:#cfe1ff;opacity:0.9}

/* A/B highlights */
.section.isA { outline: 2px solid #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.18) inset; }
.section.isB { outline: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18) inset; }
.badge{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:.3px;vertical-align:middle;}
.badgeA{background:#0b2a1e;border:1px solid #10b981;color:#b9f6da;}
.badgeB{background:#0b1f3d;border:1px solid #3b82f6;color:#cfe1ff;}

/* Per-chair variants */
.chairPanel{max-height:260px; overflow:auto; border:1px solid var(--grid); border-radius:10px; padding:8px; background:#0f1a3b}
.chairRow{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; align-items:center; margin-bottom:6px; font-size:12px}
.chairHead{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; font-size:11px; color:#9fb2e4; margin-bottom:6px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,"Courier New",monospace;font-size:11px;color:#bfe3ff}

/* Mini independent panel */
.miniCard{border:1px solid var(--grid);border-radius:12px;background:#0f1a3b;padding:10px}
.miniHead{font-weight:800;color:#e4eeff;font-size:12px;margin-bottom:6px}
</style>
</head>
<body>
<header>
  <h1>CST — Audio→CSV • A:10–16 & B:6–16 (Total 32, Non-overlap) • 60s • 32 Chairs</h1>
  <span style="font-size:12px;color:#9ad1ff">You can choose A and B counts; total is locked to 32.</span>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <!-- NEW: Clear Audio (sits above step 1) -->
    <div class="row" style="margin-bottom:6px">
      <button id="btnClearAudio" class="danger">Clear Audio / Analysis / Export readiness</button>
      <div class="stat"><span>Audio file</span><b id="audioName">–</b></div>
    </div>
    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <div class="mixRow">
        <button id="btnAnalyze">2) Analyze 60s</button>
        <span id="dotAnalyze" class="statusDot" title="Analysis status"></span>
      </div>
      <div class="mixRow">
        <button id="btnExport">3) Export CSV</button>
        <span id="dotExport" class="statusDot" title="Export ready"></span>
      </div>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>

    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV headers: <b>t,m,b</b> (time sec, dominant MIDI, bass MIDI). Export → then load into A/B.</small>
    <div class="hr"></div>
    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadA">Load CSV → A</button>
          <button id="btnClearA" class="danger" style="width:auto;padding:8px 10px">Clear A</button>
          <span id="dotA" class="statusDot" title="A loaded"></span>
        </div>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadB">Load CSV → B</button>
          <button id="btnClearB" class="danger" style="width:auto;padding:8px 10px">Clear B</button>
          <span id="dotB" class="statusDot" title="B loaded"></span>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Conductor / Musicalize -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="cinematic" selected>Cinematic — lush</option>
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="bach">Bach — contrapuntal</option>
          <option value="haydn">Haydn — balanced</option>
          <option value="tchaikovsky">Tchaikovsky — lyrical</option>
          <option value="ravel">Ravel — color</option>
          <option value="mahler">Mahler — expansive</option>
          <option value="shostakovich">Shostakovich — edgy</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="price">Florence Price — warm</option>
          <option value="lili">Lili Boulanger — luminous</option>
          <option value="clara">Clara Schumann — lyrical</option>
          <option value="fanny">Fanny Mendelssohn — elegant</option>
          <option value="amy">Amy Beach — romantic</option>
          <option value="saariaho">Kaija Saariaho — spectral</option>
          <option value="tower">Joan Tower — kinetic</option>
          <option value="montgomery">Jessie Montgomery — vibrant</option>
          <option value="williams">John Williams — cinematic</option>
          <option value="zimmer">Hans Zimmer — hybrid</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Humanize (ms)</label><input id="human" type="number" min="0" max="40" step="1" value="6"/></div>
      <div><label>Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Reverb Mix</label><input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
      <div><label>Stereo Spread</label><input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>GM Program (0–127)</label>
        <input id="gmProg" type="number" min="0" max="127" step="1" value="48" />
        <small class="hint">Global timbre (still allows per-chair micro-variants below).</small>
      </div>
      <div>
        <label>Export Audio</label>
        <div class="mixRow">
          <button id="btnExportAudio">Export WAV (60s)</button>
          <span id="dotExportAudio" class="statusDot" title="WAV export (lights when ready)"></span>
        </div>
        <small class="hint">White square lights when a 60s score is ready to export.</small>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Cadence & Pace -->
    <label style="font-weight:700">Cadence & Pace</label>
    <div class="row3" id="cadenceRow">
      <button class="cadBtn" data-cad="even">Even</button>
      <button class="cadBtn" data-cad="march">March (2/4)</button>
      <button class="cadBtn" data-cad="waltz">Waltz (3/4)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="latin">Latin (2–3)</button>
      <button class="cadBtn" data-cad="sync">Syncopated</button>
      <button class="cadBtn" data-cad="swing">Swing (Shuffle)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="jig68">Jig (6/8)</button>
      <button class="cadBtn" data-cad="odd54">Odd (5/4)</button>
      <div class="stat"><span>Active cadence</span><b id="cadName">Even</b></div>
    </div>

    <div class="row3" style="margin-top:8px">
      <button class="paceBtn" data-pace="adagio">Adagio</button>
      <button class="paceBtn" data-pace="andante">Andante</button>
      <button class="paceBtn" data-pace="moderato">Moderato</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="paceBtn" data-pace="allegro">Allegro</button>
      <button class="paceBtn" data-pace="vivace">Vivace</button>
      <button class="paceBtn" data-pace="presto">Presto</button>
    </div>
    <div class="stat" style="margin-top:6px"><span>Active pace</span><b id="paceName">Andante</b></div>

    <div class="hr"></div>

    <!-- Family Opening -->
    <label style="font-weight:700">Family Opening (entry timing bias)</label>
    <div class="row">
      <button id="btnOpenRandom" title="Generate a musical opening order">Randomize Family Opening</button>
      <button id="btnOpenReset">Reset Default</button>
    </div>
    <div class="stat" style="margin-top:6px">
      <span>Open @ seconds (Strings, Winds, Brass, Perc)</span>
      <b class="mono" id="openSummary">0, 8, 16, 24</b>
    </div>

    <div class="hr"></div>

    <!-- Orchestration Picks -->
    <label style="font-weight:700">Orchestration Picks (A:10–16, B:6–16 • non-overlapping • total 32)</label>
    <div class="row" style="margin-bottom:6px">
      <div>
        <label>Target A (10–16)</label>
        <div class="mixRow">
          <input id="countA" type="number" min="10" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomA">Randomize A (16)</button>
        </div>
      </div>
      <div>
        <label>Target B (6–16)</label>
        <div class="mixRow">
          <input id="countB" type="number" min="6" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomB">Randomize B (16)</button>
        </div>
      </div>
    </div>
    <small class="hint">Counts auto-adjust to keep A + B = 32. Locks are respected.</small>

    <div class="twoCols" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>A Selected</span><b id="selCountA">0</b></div>
        </div>
        <div id="listA" class="pickList"></div>
      </div>
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>B Selected</span><b id="selCountB">0</b></div>
        </div>
        <div id="listB" class="pickList"></div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Per-Chair Variants -->
    <label style="font-weight:700">Per-Chair Variants (tiny differences per A/B chair)</label>
    <div class="chairHead"><div>Chair</div><div>Variant</div><div>Detune</div></div>
    <div id="chairPanel" class="chairPanel"></div>
    <small class="hint">Variant tweaks tone/attack; detune is ± cents. Defaults: A (brighter) / B (warmer).</small>

    <div class="hr"></div>

    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>

    <div id="status">Ready.</div>

    <div class="hr"></div>

    <!-- ===== INDEPENDENT A+B → ARRANGED CSV PANEL (self-contained) ===== -->
    <div class="miniCard">
      <div class="miniHead">Independent A+B → Arrange & Export CSV (self-contained)</div>
      <div class="row3" style="margin-bottom:6px">
        <button id="abLoad1">Load Song 1</button>
        <button id="abLoad2">Load Song 2</button>
        <button id="abAnalyze">Analyze & Arrange</button>
      </div>
      <input id="abFile1" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
      <input id="abFile2" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
      <div class="row" style="margin-top:6px">
        <div><label>BPM</label><input id="abBPM" type="number" min="40" max="200" step="1" value="100"/></div>
        <div>
          <label>Cadence</label>
          <select id="abCad">
            <option value="even" selected>Even</option>
            <option value="march">March (2/4)</option>
            <option value="waltz">Waltz (3/4)</option>
            <option value="latin">Latin (2–3)</option>
            <option value="sync">Syncopated</option>
            <option value="swing">Swing</option>
            <option value="jig68">Jig (6/8)</option>
            <option value="odd54">Odd (5/4)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Swing (0–60%)</label><input id="abSwing" type="range" min="0" max="0.6" step="0.01" value="0.10"/></div>
        <div>
          <label>Profile</label>
          <select id="abProfile">
            <option value="pop" selected>Pop</option>
            <option value="build">Build</option>
            <option value="flat">Flat</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="abExport">Export Arranged CSV</button>
        <button id="abReset" class="danger">Reset Panel</button>
      </div>
      <div class="stat" style="margin-top:8px">
        <span id="abStatusLabel">Status</span>
        <b id="abStatus">Load two ~1-minute songs.</b>
      </div>
    </div>
    <!-- ===== end independent panel ===== -->
  </section>
  <!-- RIGHT: STAGE -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Even spacing • Front strings, winds middle, brass back, perc rear • 32 chairs</b></div>
    </div>

    <div class="guide">
      <b>How the 1-minute AI Symphony Orchestra works (HTML + Web Audio)</b>
      <ol>
        <li><b>Load Audio</b> and (optionally) click <b>Analyze 60s</b> to auto-detect notes & tempo.</li>
        <li><b>Export CSV</b> (<code>t,m,b</code>) then load CSV into <b>A</b> and/or <b>B</b> panels.</li>
        <li>Choose <b>A (10–16)</b> and <b>B (6–16)</b>. Total stays 32, no overlap. Locks respected.</li>
        <li>Set Conductor/Key/Tempo/Quantize/Swing/Humanize/Reverb/Spread, plus Cadence & Pace.</li>
        <li>Use <b>Per-Chair Variants</b> (bright/warm etc.).</li>
        <li>Press <b>Play</b> for a 60s render; lights blink on sounding chairs. <b>Export WAV</b> to save audio.</li>
        <li>Need to start over? Use <b>Clear</b> buttons (Audio / A / B) or <b>Reset</b> for a full reset.</li>
      </ol>
    </div>
    <!-- 32 Chairs (8 x 4) -->
    <div class="grid">
      <!-- Row 1 -->
      <div class="cell"><div class="section" data-sec="trumpetsa"><div class="title">Trumpets A</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsa"></div><div class="check" id="chk-trumpetsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsa">Mute</button><button class="btnSmall" data-solo="trumpetsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trumpetsb"><div class="title">Trumpets B</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsb"></div><div class="check" id="chk-trumpetsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsb">Mute</button><button class="btnSmall" data-solo="trumpetsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="hornsa"><div class="title">French Horns A</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsa"></div><div class="check" id="chk-hornsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsa">Mute</button><button class="btnSmall" data-solo="hornsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="hornsb"><div class="title">French Horns B</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsb"></div><div class="check" id="chk-hornsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsb">Mute</button><button class="btnSmall" data-solo="hornsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="perca"><div class="title">Percussion A</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-perca"></"></div><div class="check" id="chk-perca"></div></div><div class="mixRow"><button class="btnSmall" data-mute="perca">Mute</button><button class="btnSmall" data-solo="perca">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="percb"><div class="title">Percussion B</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-percb"></div><div class="check" id="chk-percb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="percb">Mute</button><button class="btnSmall" data-solo="percb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombonesa"><div class="title">Trombones/Tuba A</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesa"></div><div class="check" id="chk-trombonesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesa">Mute</button><button class="btnSmall" data-solo="trombonesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombonesb"><div class="title">Trombones/Tuba B</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesb"></div><div class="check" id="chk-trombonesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesb">Mute</button><button class="btnSmall" data-solo="trombonesb">Solo</button></div></div></div>

      <!-- Row 2 -->
      <!-- (keep all your existing chair grid here – unchanged) -->
      <!-- ... SNIP for brevity, keep exactly as in your version ... -->
    </div>

    <!-- Conductor panel -->
    <div class="conductorPanel">
      <div class="condCard">
        <div class="conductor" id="conductor">Conductor</div>
        <div class="conLabel" id="conLabel">Conductor / Musicalize: Cinematic — lush</div>
      </div>
    </div>

    <!-- NEW: Methods & Math explainer -->
    <div class="card" style="margin-top:14px;background:#0f1a3b;border-color:#273b84">
      <div class="miniHead">How the 32-Chair Symphony Works — Methods & Math (v1)</div>
      <ul style="margin:8px 0 0 18px;font-size:12px;line-height:1.45">
        <li><b>Pitch & Bass Detection:</b> autocorrelation + zero-crossing estimate → MIDI map.</li>
        <li><b>Key Detection:</b> Krumhansl-Schmuckler profile correlation → best major/minor root.</li>
        <li><b>Tempo:</b> onset deltas → median IBI → BPM normalized to 60–180.</li>
        <li><b>Quantize & Swing:</b> snap to grid <code>q = round(t/grid)*grid</code>, odd positions get swing offset.</li>
        <li><b>Routing:</b> pitch range + family opening bias (Strings→Winds→Brass→Perc) to seats.</li>
        <li><b>Scheduling:</b> look-ahead event buffer streams notes to WebAudio buses.</li>
        <li><b>Timbre:</b> simple subtractive synth per seat (LPF+ADS(R)) + hall IR reverb + compressor.</li>
      </ul>
      <div class="hr" style="margin:10px 0"></div>
      <div class="mono" style="white-space:pre-wrap">
Key:    argmax_r ⟨profile_r , histogram⟩
BPM:    bpm = clamp( round( 60 / median(Δonset) ) × 2^k , 60..180 )
Quant:  q(t) = round(t / grid) · grid;  swing: if odd grid → q += s·grid/2
Assign: section = f(pitch, isBass, familyOpen_t)
      </div>
      <small class="hint" style="margin-top:6px">
        This is an early HTML-only AI symphony. As the codebase grows, it will fuse analyzer, arranger, orchestration, and rendering into a single unified pass.
      </small>
    </div>
  </section>
<script>
/* ===== Helpers & scales ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const median=a=>{const s=[...a].sort((x,y)=>x-y),n=s.length;return n?(n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):0;}
function pcsFor(root,mode){const r=NOTE.indexOf(root);return (mode==='minor'?MINOR:MAJOR).map(pc=>(pc+r+120)%12);}
function snapToScale(m,pcs){
  if(!m) return 0; const pc=((m%12)+12)%12;
  if(pcs.includes(pc)) return m;
  for(const d of [1,-1,2,-2]){const c=((pc+d)+12)%12;if(pcs.includes(c)) return m+d;}
  return m;
}
const $=id=>document.getElementById(id);

/* ===== UI refs ===== */
const btnLoadAudio=$('btnLoadAudio'), btnAnalyze=$('btnAnalyze'), btnExport=$('btnExport'), audioFile=$('audioFile');
const btnClearAudio=$('btnClearAudio'), audioNameEl=$('audioName');
const detKey=$('detKey'), detBPM=$('detBPM'), statusEl=$('status');
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB'), btnClearA=$('btnClearA'), btnClearB=$('btnClearB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn'), conductor=$('conductor');
const conLabel=$('conLabel'); const cadName=$('cadName'), paceName=$('paceName');
const btnRandomA=$('btnRandomA'), btnRandomB=$('btnRandomB'), listA=$('listA'), listB=$('listB'), selCountA=$('selCountA'), selCountB=$('selCountB');
const gmProgEl=$('gmProg'), btnExportAudio=$('btnExportAudio'), dotExportAudio=$('dotExportAudio');
const chairPanel=$('chairPanel'); const countAEl=$('countA'), countBEl=$('countB');
/* Family opening */
const btnOpenRandom=$('btnOpenRandom'), btnOpenReset=$('btnOpenReset'), openSummary=$('openSummary');
/* Status dots */
const dotA=$('dotA'), dotB=$('dotB'), dotAnalyze=$('dotAnalyze'), dotExport=$('dotExport');

function light(el,on){ if(!el) return; if(on){ el.classList.add('statusOn'); } else { el.classList.remove('statusOn'); } }
function setStatus(s){ statusEl.textContent=s; }
function updateConLabel(){ const txt=composerEl.options[composerEl.selectedIndex].textContent; conLabel.textContent='Conductor / Musicalize: ' + txt; }

/* ===== 32-chair definitions ===== */
const BASE=['vln1','vln2','violas','cellos','basses','harp','piano','flutes','oboes','clarinets','bassoons','trumpets','horns','trombones','perc','drums'];
const CHAIRS = BASE.flatMap(b=>[b+'a', b+'b']); // 32 ids
const LABEL={
  vln1a:'1st Violins A', vln1b:'1st Violins B', vln2a:'2nd Violins A', vln2b:'2nd Violins B',
  violasa:'Violas A', violasb:'Violas B', cellosa:'Cellos A', cellosb:'Cellos B',
  bassesa:'Double Basses A', bassesb:'Double Basses B', harpa:'Harp/Keys A', harpb:'Harp/Keys B',
  pianoa:'Piano A', pianob:'Piano B', flutesa:'Flutes/Picc. A', flutesb:'Flutes/Picc. B',
  oboesa:'Oboes A', oboesb:'Oboes B', clarinetsa:'Clarinets A', clarinetsb:'Clarinets B',
  bassoonsa:'Bassoons A', bassoonsb:'Bassoons B', trumpetsa:'Trumpets A', trumpetsb:'Trumpets B',
  hornsa:'French Horns A', hornsb:'French Horns B', trombonesa:'Trombones/Tuba A', trombonesb:'Trombones/Tuba B',
  perca:'Percussion A', percb:'Percussion B', drumsa:'Drums A', drumsb:'Drums B'
};
function baseOf(id){ return id.slice(0,-1).replace(/(sa|sb)$/,'s'); }
function familyOfSection(sec){
  const b=baseOf(sec);
  if (['vln1','vln2','violas','cellos','basses','harp','piano'].includes(b)) return 'strings';
  if (['flutes','oboes','clarinets','bassoons'].includes(b)) return 'winds';
  if (['horns','trumpets','trombones'].includes(b)) return 'brass';
  if (['perc','drums'].includes(b)) return 'perc';
  return 'strings';
}
/* Family buckets */
const FAM={
  strings:['vln1a','vln1b','vln2a','vln2b','violasa','violasb','cellosa','cellosb','bassesa','bassesb','harpa','harpb','pianoa','pianob'],
  winds:['flutesa','flutesb','oboesa','oboesb','clarinetsa','clarinetsb','bassoonsa','bassoonsb'],
  brass:['hornsa','hornsb','trumpetsa','trumpetsb','trombonesa','trombonesb'],
  perc:['perca','percb','drumsa','drumsb']
};
/* Stage wiring */
const SECTIONS=[...CHAIRS];
const DOT={}, CHK={}, MUTE={}, SOLO={on:false,id:null};
SECTIONS.forEach(id=>{ DOT[id]=document.getElementById('dot-'+id); CHK[id]=document.getElementById('chk-'+id); MUTE[id]=false; });
document.querySelectorAll('[data-mute]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-mute'); MUTE[s]=!MUTE[s]; b.textContent=MUTE[s]?'Unmute':'Mute';});
document.querySelectorAll('[data-solo]').forEach(b=>b.onclick=()=>{const s=b.getAttribute('data-solo'); if(SOLO.on&&SOLO.id===s){SOLO.on=false;SOLO.id=null;b.textContent='Solo';}else{SOLO.on=true;SOLO.id=s;document.querySelectorAll('[data-solo]').forEach(x=>x.textContent='Solo');b.textContent='Unsolo';}});

/* Mark A/B on stage */
function markStage(){
  const aSet = new Set(PICK_A.map(x=>x.id));
  const bSet = new Set(PICK_B.map(x=>x.id));
  SECTIONS.forEach(id=>{
    const secEl = document.querySelector('.section[data-sec="'+id+'"]');
    if(!secEl) return;
    secEl.classList.remove('isA','isB');
    const titleEl = secEl.querySelector('.title');
    if(!titleEl) return;
    titleEl.querySelectorAll('.badge').forEach(b=>b.remove());
    if(aSet.has(id)){
      secEl.classList.add('isA');
      const bd = document.createElement('span'); bd.className='badge badgeA'; bd.textContent='A'; titleEl.appendChild(bd);
    }else if(bSet.has(id)){
      secEl.classList.add('isB');
      const bd = document.createElement('span'); bd.className='badge badgeB'; bd.textContent='B'; titleEl.appendChild(bd);
    }
  });
}
function bufferToWav(buffer){
  const numOfChan = buffer.numberOfChannels; const length = buffer.length * numOfChan * 2 + 44;
  const ab = new ArrayBuffer(length); const view = new DataView(ab);
  writeString(view, 0, 'RIFF'); view.setUint32(4, length - 8, true); writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numOfChan, true);
  view.setUint32(24, buffer.sampleRate, true); view.setUint32(28, buffer.sampleRate * numOfChan * 2, true);
  view.setUint16(32, numOfChan * 2, true); view.setUint16(34, 16, true);
  writeString(view, 36, 'data'); view.setUint32(40, length - 44, true);
  let offset = 44;
  for (let i = 0; i < buffer.length; i++){
    for (let ch = 0; ch < numOfChan; ch++){
      let s = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true); offset += 2;
    }
  }
  return new Blob([ab], {type: 'audio/wav'});
}
function writeString(view, offset, string){ for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); }

/* ===== Independent A+B → ARRANGED CSV PANEL (logic) ===== */
(function(){
  const ab = {
    ui: {
      load1: document.getElementById('abLoad1'),
      load2: document.getElementById('abLoad2'),
      f1: document.getElementById('abFile1'),
      f2: document.getElementById('abFile2'),
      analyze: document.getElementById('abAnalyze'),
      bpm: document.getElementById('abBPM'),
      cad: document.getElementById('abCad'),
      swing: document.getElementById('abSwing'),
      profile: document.getElementById('abProfile'),
      export: document.getElementById('abExport'),
      reset: document.getElementById('abReset'),
      status: document.getElementById('abStatus'),
      statusLabel: document.getElementById('abStatusLabel')
    },
    S1: {events:[]},
    S2: {events:[]},
    ARR: []
  };

  function abSetStatus(t){ ab.ui.status.textContent = t; }
  function abSetLabel(t){ ab.ui.statusLabel.textContent = t; }

  function shortName(file){ return file ? (file.name || 'audio') : '–'; }

  // small smoothing like main analyzer
  function smoothList(events,key){
    const half=2, a=events.map(e=>e[key]||0), sm=[];
    for(let i=0;i<a.length;i++){
      const w=[];
      for(let k=Math.max(0,i-half);k<=Math.min(a.length-1,i+half);k++){
        if(a[k]) w.push(a[k]);
      }
      sm[i]=w.length?Math.round(median(w)):0;
    }
    for(let i=0;i<events.length;i++) events[i][key]=sm[i];
  }

  async function analyzeSongFile(file){
    if(!file) return {events:[]};
    const arr = await file.arrayBuffer();
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const buf = await ctx.decodeAudioData(arr.slice(0));
    const sr = buf.sampleRate, ch = buf.numberOfChannels;
    const maxLen = Math.min(buf.length, sr*60);
    const mono = new Float32Array(maxLen);
    for(let c=0;c<ch;c++){
      const d = buf.getChannelData(c);
      for(let i=0;i<maxLen;i++) mono[i] += d[i]/ch;
    }
    const frame=4096, hop=2048;
    const events=[];
    for(let st=0; st+frame<=maxLen; st+=hop){
      const fr = mono.subarray(st,st+frame);
      let f = acPitch(fr.slice(),sr); if(!f) f = zcPitch(fr,sr);
      let m=0,b=0;
      if(f){
        m = clamp(Math.round(69+12*Math.log2(f/440)),24,96);
        if(f<=220) b = clamp(Math.round(69+12*Math.log2(f/440)),28,72);
      }
      events.push({t:st/sr, m, b});
    }
    smoothList(events,'m'); smoothList(events,'b');
    return {events};
  }

  function arrangeAB(){
    const bpm = clamp(parseInt(ab.ui.bpm.value,10)||100,40,200);
    const beat = 60/bpm;
    const grid = beat/2;                 // 1/8-note grid
    const sw = parseFloat(ab.ui.swing.value||"0"); // 0–0.6

    const pool=[];
    function pushEvents(events, tag){
      events.forEach(e=>{
        if(!e.m && !e.b) return;
        let q = Math.round(e.t/grid)*grid;
        if(grid>0){
          const pos = Math.round(q/grid);
          if(pos%2===1) q += sw*grid*0.5;  // simple swing using panel slider
        }
        q = Math.max(0,Math.min(60,q));
        pool.push({t:q,m:e.m|0,b:e.b|0,tag});
      });
    }
    pushEvents(ab.S1.events,'A');
    pushEvents(ab.S2.events,'B');

    pool.sort((a,b)=>a.t-b.t);
    const cells=[];
    let curT=null, cell=null;
    for(const e of pool){
      if(curT===null || Math.abs(e.t-curT)>1e-3){
        curT = e.t;
        cell = {t:e.t, m:0, b:0};
        cells.push(cell);
      }
      if(e.m){
        if(!cell.m || e.m>cell.m) cell.m = e.m;
      }
      if(e.b){
        if(!cell.b || !cell.m || e.b<cell.b) cell.b = e.b;
      }
    }
    ab.ARR = cells;
  }

  // Wire panel buttons
  ab.ui.load1.onclick = ()=>{ ab.ui.f1.click(); };
  ab.ui.load2.onclick = ()=>{ ab.ui.f2.click(); };

  ab.ui.f1.onchange = ()=>{
    const f = ab.ui.f1.files[0];
    abSetStatus(f ? `Loaded Song 1: ${shortName(f)}` : 'Song 1 cleared.');
  };
  ab.ui.f2.onchange = ()=>{
    const f = ab.ui.f2.files[0];
    abSetStatus(f ? `Loaded Song 2: ${shortName(f)}` : 'Song 2 cleared.');
  };

  ab.ui.analyze.onclick = async()=>{
    const f1 = ab.ui.f1.files[0];
    const f2 = ab.ui.f2.files[0];
    if(!f1 && !f2){
      abSetLabel('Status');
      abSetStatus('Load at least one song.');
      return;
    }
    abSetLabel('Analyzing…');
    abSetStatus('Analyzing Song 1…');
    ab.S1 = await analyzeSongFile(f1);
    abSetStatus('Analyzing Song 2…');
    ab.S2 = await analyzeSongFile(f2);
    arrangeAB();
    abSetLabel('Ready');
    abSetStatus(`Arranged ${ab.ARR.length} time-cells @ ${ab.ui.bpm.value} BPM.`);
  };

  ab.ui.export.onclick = ()=>{
    if(!ab.ARR.length){
      abSetStatus('Nothing to export. Click Analyze & Arrange first.');
      return;
    }
    // reuse main toCSV helper
    const csv = toCSV(ab.ARR.map(e=>({t:e.t,m:e.m,b:e.b})));
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'AB_arranged_60s.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
    abSetStatus('Arranged CSV exported.');
  };

  ab.ui.reset.onclick = ()=>{
    ab.S1={events:[]};
    ab.S2={events:[]};
    ab.ARR=[];
    ab.ui.f1.value='';
    ab.ui.f2.value='';
    ab.ui.bpm.value='100';
    ab.ui.cad.value='even';
    ab.ui.swing.value='0.10';
    ab.ui.profile.value='pop';
    abSetLabel('Status');
    abSetStatus('Load two ~1-minute songs.');
  };
})();

/* Wire up remaining controls */
btnRandomA.onclick=()=>{ syncTargets('A'); randomizeA(); setStatus(`A randomized (${TARGET_A}). B adjusted to avoid overlap and keep total 32.`); };
btnRandomB.onclick=()=>{ syncTargets('B'); randomizeB(); setStatus(`B randomized (${TARGET_B}) from remaining chairs. Total kept at 32.`); };
playBtn.onclick=doPlay; stopBtn.onclick=stopAll;

resetBtn.onclick=()=>{
  stopAll(); A={events:[]}; B={events:[]}; LAST_ANALYSIS={events:[],key:"C major",bpm:100};
  detKey.textContent='–'; detBPM.textContent='–'; csvA.value=""; csvB.value=""; audioFile.value=""; audioNameEl.textContent='–';
  composerEl.value='cinematic'; keyRootEl.value='C'; keyModeEl.value='major'; bpmEl.value='100';
  quantEl.value='0.125'; swingEl.value='0.10'; humanEl.value='6'; masterVolEl.value='0.85'; reverbMixEl.value='0.18'; spreadEl.value='0.55';
  gmProgEl.value='48'; GM_PROGRAM=48; applyConductorPreset();
  light(dotA,false); light(dotB,false); light(dotAnalyze,false); light(dotExport,false); light(dotExportAudio,false);
  if(AUDIO.ctx){ AUDIO.master.gain.value=parseFloat(masterVolEl.value); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); try{AUDIO.ctx.close();}catch{} AUDIO.ctx=null; getAudio(); }
  CAD='even'; PAC='andante'; cadName.textContent='Even'; paceName.textContent='Andante';
  PICK_A=[]; PICK_B=[]; renderSide('A'); renderSide('B'); markStage();
  FAMILY_OPEN = { strings: 0, winds: 8, brass: 16, perc: 24 }; summarizeOpenings();
  for(const id of SECTIONS){ const chk=CHK[id], dot=DOT[id]; if(chk){ chk.classList.remove('checked'); chk.textContent=''; } if(dot){ dot.classList.remove('blink'); } MUTE[id]=false; }
  for(const id of CHAIRS){ CHAIR_VARIANT[id] = id.endsWith('a') ? 'bright' : 'warm'; CHAIR_DETUNE[id] = id.endsWith('a') ? +3 : -3; }
  buildChairPanel(); countAEl.value='16'; countBEl.value='16'; syncTargets(); checkExportReady(); setStatus("Ready."); updateConLabel();
};
masterVolEl.oninput=()=>{ getAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); };
reverbMixEl.oninput=()=>{ getAudio(); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); };
spreadEl.oninput=()=>{ if(AUDIO.ctx){ try{AUDIO.ctx.close();}catch(_){ } AUDIO.ctx=null; } getAudio(); };

/* Init */
(function init(){
  NOTE.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; if(n==='C') o.selected=true; keyRootEl.appendChild(o); });
  applyConductorPreset(); updateConLabel(); summarizeOpenings(); syncTargets(); randomizeA(); randomizeB(); buildChairPanel();
  conductor.style.animationPlayState='paused'; setStatus('Ready.'); checkExportReady(); markStage();
})();
</script>
</main>
</body>
</html>
