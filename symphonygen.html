<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI Orchestral Mixer — Classic Order (Score Builder, Full Orchestra)</title>
<meta name="description" content="One-minute classic-order orchestral mixer. Upload a beat and add exact notes per instrument (no randomness). Includes full orchestra list, solo/mute, and live mixing."/>
<style>
  :root{
    --bg:#081022; --panel:#0f1636; --ink:#e9f1ff; --muted:#9fb2e4; --grid:#1a2658; --btn:#1b2a6b;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#6ee7ff; --accent:#93c5fd;
    --str:#8bc6ff; --ww:#b8ffda; --br:#ffd599; --pc:#ff9aa2; --pn:#d0b3ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  h1{font-size:26px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 8px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:16px}

  /* Layout: make Transport wider */
  .row{display:grid;grid-template-columns:2.2fr 1.3fr;gap:14px}
  @media(max-width:1120px){.row{grid-template-columns:1fr}}

  .panel{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:16px}
  .controls{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:12px;margin:10px 0}
  .btn{background:var(--btn);border:1px solid var(--grid);color:var(--ink);border-radius:12px;padding:14px 16px;font-weight:800;font-size:16px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#173076}
  .btn.warn{background:#4d2f03;border-color:#7a4b07}
  input[type="file"], input[type="number"], input[type="text"], textarea{
    background:#0b1432;border:1px solid var(--grid);color:var(--ink);border-radius:10px;padding:12px 12px;font-size:15px;width:100%
  }
  label{font-size:13px;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{border:1px solid var(--grid);border-radius:999px;padding:6px 12px;font-size:12px;display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.str{background:var(--str)} .dot.ww{background:var(--ww)} .dot.br{background:var(--br)} .dot.pc{background:var(--pc)} .dot.pn{background:var(--pn)}

  .timeline{height:120px;background:#0b1432;border:1px solid var(--grid);border-radius:12px;position:relative;margin-top:12px;overflow:hidden}
  .gridline{position:absolute;top:0;bottom:0;width:1px;background:#1a2658}
  .marker{position:absolute;top:0;bottom:0;width:4px;background:var(--line);box-shadow:0 0 14px var(--line)}
  .label{position:absolute;top:8px;font-size:11px;color:var(--muted)}
  .band{position:absolute;top:0;bottom:0;opacity:.16}
  .band.str{background:var(--str)} .band.ww{background:var(--ww)} .band.br{background:var(--br)} .band.pc{background:var(--pc)} .band.pn{background:var(--pn)}

  .status{display:flex;gap:14px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .lamp{width:14px;height:14px;border-radius:50%;background:#394b7a;box-shadow:0 0 0 0 transparent}
  .lamp.on{background:var(--ok);box-shadow:0 0 10px var(--ok)}

  .meters{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-top:10px}
  .chan{background:#0b1432;border:1px solid var(--grid);border-radius:12px;padding:12px}
  .chan h3{margin:0 0 6px;font-size:15px}
  .tag{font-size:11px;border-radius:999px;padding:2px 8px;display:inline-block;margin-left:6px;vertical-align:1px;border:1px solid var(--grid);color:var(--muted)}
  .volrow{display:flex;gap:10px;align-items:center}
  .volrow input[type="range"]{width:100%}
  .muterow{display:flex;gap:10px;margin-top:8px}
  .muterow .btn{padding:10px 12px;font-size:14px}

  /* Score builder */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:1120px){.grid2{grid-template-columns:1fr}}
  .scroll{max-height:280px;overflow:auto;border:1px solid var(--grid);border-radius:10px}
  table{width:100%;border-collapse:collapse}
  th, td{border:1px solid var(--grid);padding:8px;font-size:14px;vertical-align:top}
  th{background:#0b1432}

  /* Instrument list (2 columns, grouped) */
  .ilist{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .igroup{border:1px solid var(--grid);border-radius:10px;padding:10px}
  .igroup h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
  .irow{display:flex;align-items:center;gap:8px;margin:4px 0}
  .irow input{transform:scale(1.25)}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Orchestral Mixer — Classic Order</h1>
  <div class="sub">One-minute mixer (no randomness). Classic entrances: <b>Strings 0s</b> → <b>Woodwinds 10s</b> → <b>Brass 20s</b> → <b>Percussion 35s</b> → <b>Keyboard/Harp 45s</b>. Upload a beat and add exact notes for any instrument(s).</div>

  <div class="row">
    <!-- LEFT: Transport + Timeline -->
    <div class="panel">
      <h2>Transport</h2>
      <div class="controls">
        <button id="btnPlay" class="btn">PLAY</button>
        <button id="btnStop" class="btn" disabled>STOP</button>
        <button id="btnReset" class="btn secondary">RESET</button>
        <input id="fileBeat" type="file" accept="audio/*" title="Upload a looped beat (WAV/MP3)"/>
        <button id="btnMetronome" class="btn">Use Metronome</button>
        <button id="btnLoop" class="btn" title="Loop after 60s">Loop Off</button>
      </div>
      <div class="small">Tip: upload your beat (e.g., <i>notesbeat.wav</i>). If none, press <b>Use Metronome</b> (120 BPM).</div>

      <div class="legend">
        <span class="pill"><span class="dot str"></span>Strings @ 0s</span>
        <span class="pill"><span class="dot ww"></span>Woodwinds @ 10s</span>
        <span class="pill"><span class="dot br"></span>Brass @ 20s</span>
        <span class="pill"><span class="dot pc"></span>Percussion @ 35s</span>
        <span class="pill"><span class="dot pn"></span>Keyboard/Harp @ 45s</span>
      </div>

      <div class="timeline" id="timeline">
        <div class="marker" id="playhead" style="left:0%"></div>
      </div>

      <div class="status">
        <div class="lamp" id="lampAudio"></div><span class="small">Audio Engine</span>
        <div class="lamp" id="lampBeat"></div><span class="small">Beat Loaded</span>
        <div class="lamp" id="lampPlaying"></div><span class="small">Playing</span>
        <span class="small" id="txtTime">t = 0.0s</span>
        <span class="small" id="txtMsg"></span>
      </div>
    </div>

    <!-- RIGHT: Mixer Channels (Sections) -->
    <div class="panel">
      <h2>Section Mixer</h2>
      <div class="meters">
        <div class="chan">
          <h3>Strings <span class="tag">0–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volStrings" type="range" min="0" max="1" step="0.01" value="0.9"/></div>
          <div class="muterow">
            <button id="muteStrings" class="btn">Mute</button>
            <button id="soloStrings" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Woodwinds <span class="tag">10–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volWoodwinds" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
          <div class="muterow">
            <button id="muteWoodwinds" class="btn">Mute</button>
            <button id="soloWoodwinds" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Brass <span class="tag">20–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volBrass" type="range" min="0" max="1" step="0.01" value="0.8"/></div>
          <div class="muterow">
            <button id="muteBrass" class="btn">Mute</button>
            <button id="soloBrass" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Percussion <span class="tag">35–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volPerc" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
          <div class="muterow">
            <button id="mutePerc" class="btn">Mute</button>
            <button id="soloPerc" class="btn">Solo</button>
          </div>
        </div>
        <div class="chan">
          <h3>Keyboard/Harp <span class="tag">45–60s</span></h3>
          <div class="volrow"><label>Volume</label><input id="volPiano" type="range" min="0" max="1" step="0.01" value="0.8"/></div>
          <div class="muterow">
            <button id="mutePiano" class="btn">Mute</button>
            <button id="soloPiano" class="btn">Solo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCORE BUILDER -->
  <div class="panel" style="margin-top:14px">
    <h2>Score Builder (Select Instruments, Then Add Exact Notes)</h2>

    <div class="grid2">
      <!-- Instrument list (2 columns) -->
      <div>
        <label>Choose instrument(s) (multi-select):</label>
        <div class="ilist" id="ilist">
          <div class="igroup">
            <h4>Strings</h4>
            <div class="irow"><input type="checkbox" value="Violin I"> <span>Violin I</span></div>
            <div class="irow"><input type="checkbox" value="Violin II"> <span>Violin II</span></div>
            <div class="irow"><input type="checkbox" value="Viola"> <span>Viola</span></div>
            <div class="irow"><input type="checkbox" value="Cello"> <span>Cello</span></div>
            <div class="irow"><input type="checkbox" value="Double Bass"> <span>Double Bass</span></div>
            <div class="irow"><input type="checkbox" value="Harp"> <span>Harp</span></div>
          </div>

          <div class="igroup">
            <h4>Woodwinds</h4>
            <div class="irow"><input type="checkbox" value="Flute"> <span>Flute</span></div>
            <div class="irow"><input type="checkbox" value="Piccolo"> <span>Piccolo</span></div>
            <div class="irow"><input type="checkbox" value="Oboe"> <span>Oboe</span></div>
            <div class="irow"><input type="checkbox" value="English Horn"> <span>English Horn</span></div>
            <div class="irow"><input type="checkbox" value="Clarinet"> <span>Clarinet</span></div>
            <div class="irow"><input type="checkbox" value="Bass Clarinet"> <span>Bass Clarinet</span></div>
            <div class="irow"><input type="checkbox" value="Bassoon"> <span>Bassoon</span></div>
            <div class="irow"><input type="checkbox" value="Contrabassoon"> <span>Contrabassoon</span></div>
            <div class="irow"><input type="checkbox" value="Saxophone"> <span>Saxophone</span></div>
          </div>

          <div class="igroup">
            <h4>Brass</h4>
            <div class="irow"><input type="checkbox" value="Horn"> <span>French Horn</span></div>
            <div class="irow"><input type="checkbox" value="Trumpet"> <span>Trumpet</span></div>
            <div class="irow"><input type="checkbox" value="Trombone"> <span>Trombone</span></div>
            <div class="irow"><input type="checkbox" value="Bass Trombone"> <span>Bass Trombone</span></div>
            <div class="irow"><input type="checkbox" value="Tuba"> <span>Tuba</span></div>
            <div class="irow"><input type="checkbox" value="Euphonium"> <span>Euphonium</span></div>
            <div class="irow"><input type="checkbox" value="Wagner Tuba"> <span>Wagner Tuba</span></div>
          </div>

          <div class="igroup">
            <h4>Percussion</h4>
            <div class="irow"><input type="checkbox" value="Kick"> <span>Kick (K)</span></div>
            <div class="irow"><input type="checkbox" value="Snare"> <span>Snare (S)</span></div>
            <div class="irow"><input type="checkbox" value="Hi-hat"> <span>Hi-hat (H)</span></div>
            <div class="irow"><input type="checkbox" value="Timpani"> <span>Timpani</span></div>
            <div class="irow"><input type="checkbox" value="Cymbals"> <span>Cymbals</span></div>
            <div class="irow"><input type="checkbox" value="Triangle"> <span>Triangle</span></div>
            <div class="irow"><input type="checkbox" value="Glockenspiel"> <span>Glockenspiel</span></div>
            <div class="irow"><input type="checkbox" value="Xylophone"> <span>Xylophone</span></div>
            <div class="irow"><input type="checkbox" value="Tambourine"> <span>Tambourine</span></div>
            <div class="irow"><input type="checkbox" value="Gong"> <span>Gong</span></div>
            <div class="irow"><input type="checkbox" value="Chimes"> <span>Chimes</span></div>
          </div>

          <div class="igroup">
            <h4>Keyboards / Organ</h4>
            <div class="irow"><input type="checkbox" value="Piano"> <span>Piano</span></div>
            <div class="irow"><input type="checkbox" value="Celesta"> <span>Celesta</span></div>
            <div class="irow"><input type="checkbox" value="Harpsichord"> <span>Harpsichord</span></div>
            <div class="irow"><input type="checkbox" value="Organ"> <span>Organ</span></div>
          </div>
        </div>
      </div>

      <!-- Pattern controls -->
      <div>
        <div class="grid2" style="grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>BPM (beats/min)</label>
            <input id="inpBPM" type="number" min="20" max="240" value="120"/>
          </div>
          <div>
            <label>Start Offset (sec, after section entry)</label>
            <input id="inpOffset" type="number" min="0" max="60" step="0.01" value="0"/>
          </div>
          <div>
            <label>Channel Volume (0–1)</label>
            <input id="inpVol" type="number" min="0" max="1" step="0.01" value="0.8"/>
          </div>
        </div>

        <label style="margin-top:10px;display:block">Notes (comma-separated): <span class="small">Format <b>NOTE:beatOffset:durBeats</b>. Pitched: C3..C6. Perc: <b>K,S,H</b>.</span></label>
        <textarea id="inpNotes" rows="6" placeholder="Examples:
Violin I → C4:0:1, E4:1:1, G4:2:2
Timpani → C2:0:2, C2:4:2
Percussion → K:0:1, H:0.5:0.5, S:1:1"></textarea>

        <div class="controls" style="grid-template-columns:repeat(3, minmax(0,1fr));margin-top:10px">
          <button id="btnAddPattern" class="btn">Add Pattern (All Checked)</button>
          <button id="btnClearPatterns" class="btn warn">Clear All Patterns</button>
          <button id="btnExportPatterns" class="btn secondary">Export JSON</button>
        </div>
      </div>
    </div>

    <div class="scroll" style="margin-top:10px">
      <table id="tblPatterns">
        <thead>
          <tr><th>#</th><th>Instrument</th><th>Section</th><th>BPM</th><th>Start Offset (s)</th><th>Vol</th><th>Notes</th><th>Remove</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:8px">
      Classic entries: Strings 0s · Woodwinds 10s · Brass 20s · Percussion 35s · Keyboard/Harp 45s. Your <b>Start Offset</b> begins after the section’s entry time.
    </div>
  </div>
</div>
<script>
(() => {
  // ===== Constants =====
  const DURATION = 60;
  const CLASSIC_ORDER = [
    { key:'strings',   start: 0,  color:'var(--str)'},
    { key:'woodwinds', start:10,  color:'var(--ww)'},
    { key:'brass',     start:20,  color:'var(--br)'},
    { key:'perc',      start:35,  color:'var(--pc)'},
    { key:'piano',     start:45,  color:'var(--pn)'},
  ];

  // Instrument → section
  const SECTION_OF = {
    // Strings
    "Violin I":"strings","Violin II":"strings","Viola":"strings","Cello":"strings","Double Bass":"strings","Harp":"piano",
    // Woodwinds
    "Flute":"woodwinds","Piccolo":"woodwinds","Oboe":"woodwinds","English Horn":"woodwinds",
    "Clarinet":"woodwinds","Bass Clarinet":"woodwinds","Bassoon":"woodwinds","Contrabassoon":"woodwinds","Saxophone":"woodwinds",
    // Brass
    "Horn":"brass","Trumpet":"brass","Trombone":"brass","Bass Trombone":"brass","Tuba":"brass","Euphonium":"brass","Wagner Tuba":"brass",
    // Perc
    "Kick":"perc","Snare":"perc","Hi-hat":"perc","Timpani":"perc","Cymbals":"perc","Triangle":"perc","Glockenspiel":"perc","Xylophone":"perc","Tambourine":"perc","Gong":"perc","Chimes":"perc",
    // Keys / Organ
    "Piano":"piano","Celesta":"piano","Harpsichord":"piano","Organ":"piano"
  };

  // ===== State =====
  let ctx = null, master = null;
  let startTime = 0;
  let isPlaying = false;
  let loopEnabled = false;

  // Beat
  let beatBuffer = null, beatGain = null, usingMetronome = false;

  // Section gains
  const channel = {
    strings:{gain:null, muted:false, solo:false},
    woodwinds:{gain:null, muted:false, solo:false},
    brass:{gain:null, muted:false, solo:false},
    perc:{gain:null, muted:false, solo:false},
    piano:{gain:null, muted:false, solo:false},
  };

  // Patterns added by user
  // pattern = { id, instrument, section, bpm, offsetSec, vol, notes: [{name, beat, dur, _freq|null}] }
  const patterns = [];

  // ===== Elements =====
  const lampAudio = document.getElementById('lampAudio');
  const lampBeat = document.getElementById('lampBeat');
  const lampPlaying = document.getElementById('lampPlaying');
  const txtTime = document.getElementById('txtTime');
  const txtMsg = document.getElementById('txtMsg');
  const playhead = document.getElementById('playhead');
  const timeline = document.getElementById('timeline');

  const btnPlay = document.getElementById('btnPlay');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnMetronome = document.getElementById('btnMetronome');
  const btnLoop = document.getElementById('btnLoop');
  const fileBeat = document.getElementById('fileBeat');

  // section volume sliders
  const volEls = {
    strings: document.getElementById('volStrings'),
    woodwinds: document.getElementById('volWoodwinds'),
    brass: document.getElementById('volBrass'),
    perc: document.getElementById('volPerc'),
    piano: document.getElementById('volPiano'),
  };

  // ===== Setup =====
  function ensureAudio() {
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 0.95;
    master.connect(ctx.destination);

    // per-section gains
    for (const k of Object.keys(channel)) {
      const g = ctx.createGain();
      g.gain.value = parseFloat(volEls[k].value);
      g.connect(master);
      channel[k].gain = g;
      volEls[k].addEventListener('input', applyGains);
    }

    beatGain = ctx.createGain();
    beatGain.gain.value = 0.9;
    beatGain.connect(master);

    lampAudio.classList.add('on');
  }

  function setTransportState(playing){
    isPlaying = playing;
    btnStop.disabled = !playing;
  }

  // file beat
  fileBeat.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    ensureAudio();
    try {
      const arr = await file.arrayBuffer();
      beatBuffer = await ctx.decodeAudioData(arr);
      usingMetronome = false;
      lampBeat.classList.add('on');
      txtMsg.textContent = 'Beat loaded';
    } catch (err) {
      txtMsg.textContent = 'Could not decode audio';
      console.error(err);
    }
  });

  // metronome
  btnMetronome.onclick = () => {
    ensureAudio();
    beatBuffer = null;
    usingMetronome = true;
    lampBeat.classList.add('on');
    txtMsg.textContent = 'Metronome beat enabled (120 BPM)';
  };

  // Transport
  btnPlay.onclick = async () => {
    ensureAudio();
    await ctx.resume();
    if (isPlaying) return;
    setTransportState(true);
    lampPlaying.classList.add('on');
    txtMsg.textContent = 'Playing…';

    startTime = ctx.currentTime;
    scheduleOneMinute(startTime);
    window.__AIMIXER__.startUITimer();
  };

  btnStop.onclick = () => stopAll();

  btnReset.onclick = () => {
    stopAll({silent:true});
    clearTimelineMarker();
    txtTime.textContent = 't = 0.0s';
    txtMsg.textContent = 'Reset';
  };

  btnLoop.onclick = () => {
    loopEnabled = !loopEnabled;
    btnLoop.textContent = loopEnabled ? 'Loop On' : 'Loop Off';
  };

  // Mute/Solo
  const bindMuteSolo = (key, muteBtnId, soloBtnId) => {
    document.getElementById(muteBtnId).onclick = () => {
      channel[key].muted = !channel[key].muted;
      document.getElementById(muteBtnId).textContent = channel[key].muted ? 'Unmute' : 'Mute';
      applyGains();
    };
    document.getElementById(soloBtnId).onclick = () => {
      channel[key].solo = !channel[key].solo;
      document.getElementById(soloBtnId).textContent = channel[key].solo ? 'Unsolo' : 'Solo';
      applyGains();
    };
  };
  bindMuteSolo('strings','muteStrings','soloStrings');
  bindMuteSolo('woodwinds','muteWoodwinds','soloWoodwinds');
  bindMuteSolo('brass','muteBrass','soloBrass');
  bindMuteSolo('perc','mutePerc','soloPerc');
  bindMuteSolo('piano','mutePiano','soloPiano');

  function applyGains(){
    const anySolo = Object.values(channel).some(c => c.solo);
    for (const k of Object.keys(channel)) {
      const vol = parseFloat(volEls[k].value);
      const ch = channel[k];
      let target = vol;
      if (anySolo) target = ch.solo ? vol : 0.0;
      if (ch.muted) target = 0.0;
      ch.gain.gain.setTargetAtTime(target, ctx.currentTime, 0.01);
    }
  }

  // ===== Timeline scheduling =====
  function scheduleOneMinute(t0) {
    scheduleBeat(t0);
    scheduleUserPatterns(t0);

    const stopAt = t0 + DURATION;
    setTimeout(() => {
      if (!loopEnabled) {
        stopAll();
      } else {
        startTime = ctx.currentTime;
        scheduleOneMinute(startTime);
      }
    }, Math.max(0, (stopAt - ctx.currentTime) * 1000));
  }

  function scheduleBeat(t0){
    if (!ctx) return;
    if (beatBuffer) {
      const src = ctx.createBufferSource();
      src.buffer = beatBuffer;
      src.loop = true;
      src.connect(beatGain);
      src.start(t0);
      src.stop(t0 + DURATION + 0.05);
    } else if (usingMetronome) {
      const bpm = 120, spb = 60/bpm;
      for (let t = 0; t < DURATION; t += spb) metronomeTick(t0 + t);
    }
  }
  function metronomeTick(at){
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type='square'; o.frequency.value=2000;
    g.gain.value=0.0001; o.connect(g).connect(beatGain);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.3, at+0.001);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.05);
    o.start(at); o.stop(at+0.06);
  }

  // ===== Note scheduling (user patterns) =====
  function scheduleUserPatterns(t0){
    for (const p of patterns) {
      const sectionStart = CLASSIC_ORDER.find(x => x.key===p.section)?.start || 0;
      const base = t0 + sectionStart + p.offsetSec;

      // Instrument-local gain into section
      const instGain = ctx.createGain();
      instGain.gain.value = p.vol;
      instGain.connect(channel[p.section].gain);

      const spb = 60 / p.bpm;

      for (const ev of p.notes) {
        const at = base + ev.beat * spb;
        const dur = Math.max(0.05, ev.dur) * spb;
        instGain._freq = ev._freq || 440; // set frequency for pitched tones

        if (p.section === 'perc' && isPercName(p.instrument) && !isPitchedPerc(p.instrument, ev)) {
          schedulePercOne(p.instrument, at, dur, instGain);
        } else {
          scheduleToneOne(p.instrument, at, dur, instGain);
        }
      }
    }
  }

  function isPercName(name){
    const n = name.toLowerCase();
    return n.includes('kick') || n.includes('snare') || n.includes('hat') || n.includes('timpani') || n.includes('cymb') || n.includes('triangle') || n.includes('glock') || n.includes('xylo') || n.includes('tamb') || n.includes('gong') || n.includes('chime');
  }
  function isPitchedPerc(name, ev){
    return name.toLowerCase().includes('timpani') || name.toLowerCase().includes('glock') || name.toLowerCase().includes('xylo') || name.toLowerCase().includes('chimes');
  }

  // Tone synth by section
  function scheduleToneOne(inst, at, dur, out){
    const fam = SECTION_OF[inst];
    if (fam === 'strings') toneDetuned(at, dur, out, 'sawtooth', 0.9);
    else if (fam === 'woodwinds') toneVibrato(at, dur, out, 'sine', 5, 7);
    else if (fam === 'brass') toneFiltered(at, dur, out, 'square', 900);
    else /* piano/keys/harp/organ */ tonePluck(at, dur, out);
  }

  function toneDetuned(at, dur, out, type, det=0.8){
    const f = out._freq || 440;
    const o1 = ctx.createOscillator(), o2 = ctx.createOscillator();
    const g = ctx.createGain(); g.gain.value = 0.0001;
    o1.type=type; o2.type=type;
    o1.frequency.value = f*(1-det*0.005);
    o2.frequency.value = f*(1+det*0.005);
    o1.connect(g); o2.connect(g); g.connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.24, at+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o1.start(at); o2.start(at); o1.stop(at+dur+0.05); o2.stop(at+dur+0.05);
  }

  function toneVibrato(at, dur, out, type, lfoHz, depth){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain();
    const lfo = ctx.createOscillator(), lg = ctx.createGain();
    o.type=type; o.frequency.value=f; g.gain.value=0.0001;
    lfo.frequency.value = lfoHz; lg.gain.value = depth;
    lfo.connect(lg).connect(o.frequency);
    o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.26, at+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    lfo.start(at); lfo.stop(at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }

  function toneFiltered(at, dur, out, type, lpFreq){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain(); const lp = ctx.createBiquadFilter();
    o.type=type; o.frequency.value=f; g.gain.value=0.0001; lp.type='lowpass'; lp.frequency.value=lpFreq;
    o.connect(lp).connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.35, at+0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }

  function tonePluck(at, dur, out){
    const f = out._freq || 440;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type='triangle'; o.frequency.value=f; g.gain.value=0.0001;
    o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.28, at+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, at+dur);
    o.start(at); o.stop(at+dur+0.02);
  }

  // Percussion synths
  function schedulePercOne(inst, at, dur, out){
    const low = inst.toLowerCase();
    if (low.includes('kick')) kick(at, out);
    else if (low.includes('snare')) snare(at, out);
    else if (low.includes('hat')) hat(at, out, 0.05);
    else if (low.includes('timpani')) timpani(at, dur, out);
    else if (low.includes('triangle')) trianglePing(at, out);
    else if (low.includes('glock')) glockPing(at, out);
    else if (low.includes('xylo')) xyloPing(at, out);
    else if (low.includes('chime')) chimePing(at, out);
    else cymbal(at, out);
  }

  function kick(at, out){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(120, at);
    o.frequency.exponentialRampToValueAtTime(40, at+0.1);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.9, at+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.18);
    o.connect(g).connect(out); o.start(at); o.stop(at+0.2);
  }
  function snare(at, out){
    const noise = ctx.createBufferSource();
    const buffer = ctx.createBuffer(1, ctx.sampleRate*0.15, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
    noise.buffer=buffer;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.9;
    const g=ctx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.6, at+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, at+0.12);
    noise.connect(bp).connect(g).connect(out);
    noise.start(at); noise.stop(at+0.13);
  }
  function hat(at, out, len=0.05){
    const noise=ctx.createBufferSource();
    const buffer=ctx.createBuffer(1, ctx.sampleRate*len, ctx.sampleRate);
    const data=buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
    noise.buffer=buffer;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.6;
    const g=ctx.createGain();
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.35, at+0.003);
    g.gain.exponentialRampToValueAtTime(0.0001, at+len);
    noise.connect(hp).connect(g).connect(out);
    noise.start(at); noise.stop(at+len+0.01);
  }
  function timpani(at, dur, out){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=out._freq || 100;
    g.gain.value=0.0001; o.connect(g).connect(out);
    g.gain.setValueAtTime(0.0001, at);
    g.gain.exponentialRampToValueAtTime(0.6, at+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, at+Math.min(0.8,dur));
    o.start(at); o.stop(at+Math.min(0.82,dur+0.02));
  }
  function cymbal(at, out){ hat(at, out, 0.2); }
  function trianglePing(at,out){ tonePluck(at,0.08,out); }
  function glockPing(at,out){ out._freq=(out._freq||880); tonePluck(at,0.12,out); }
  function xyloPing(at,out){ out._freq=(out._freq||660); tonePluck(at,0.12,out); }
  function chimePing(at,out){ out._freq=(out._freq||523.25); tonePluck(at,0.35,out); }

  // ===== Notes parsing/freqs =====
  const NOTE_INDEX = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
  function noteNameToFreq(name){
    const m = String(name).match(/^([A-G](?:#|b)?)(-?\d)$/);
    if (!m) return 440;
    const pitch = m[1], oct = parseInt(m[2],10);
    const idx = NOTE_INDEX[pitch];
    const n = idx + (oct+1)*12; // MIDI-ish
    return 440 * Math.pow(2,(n-69)/12);
  }

  // ===== STOP / RESET =====
  function hardResetContext(){
    const prev = ctx;
    if (!prev) return;
    try { prev.close(); } catch(_){}
    ctx = null;
  }
  function stopAll(opts={}){
    const {silent=false}=opts;
    isPlaying=false; btnStop.disabled=true; lampPlaying.classList.remove('on');
    hardResetContext();
    if (!silent) txtMsg.textContent='Stopped';
  }

  // ===== UI playhead timer (Part 4 starts it) =====
  let uiTimer=null;
  function startUITimer(){
    clearInterval(uiTimer);
    uiTimer=setInterval(()=>{
      if (!ctx) return;
      const t=Math.max(0, ctx.currentTime - startTime);
      const clamped=Math.min(DURATION,t);
      txtTime.textContent=`t = ${clamped.toFixed(1)}s`;
      playhead.style.left=`${(clamped/DURATION)*100}%`;
      if (t>=DURATION && !isPlaying){ clearInterval(uiTimer); }
    }, 50);
  }

  // Expose API
  window.__AIMIXER__ = {
    DURATION, CLASSIC_ORDER, SECTION_OF,
    get ctx(){ return ctx }, set ctx(v){ ctx=v },
    get startTime(){ return startTime }, isPlaying:()=>isPlaying,
    ensureAudio, scheduleOneMinute,
    stopAll, applyGains,
    timeline, playhead, lamps:{lampAudio,lampBeat,lampPlaying}, txtTime, txtMsg,
    patterns, noteNameToFreq,
    startUITimer
  };
})();
</script>
<script>
(() => {
  const {
    DURATION, CLASSIC_ORDER, SECTION_OF,
    ensureAudio, scheduleOneMinute, stopAll,
    timeline, playhead, lamps, txtTime, txtMsg,
    patterns, noteNameToFreq, startUITimer
  } = window.__AIMIXER__;

  // ===== Timeline Draw =====
  const W = () => timeline.clientWidth;
  function initTimeline(){
    timeline.querySelectorAll('.gridline,.label,.band').forEach(n=>n.remove());
    CLASSIC_ORDER.forEach(sec=>{
      const band=document.createElement('div');
      band.className=`band ${sec.key==='strings'?'str':sec.key==='woodwinds'?'ww':sec.key==='brass'?'br':sec.key==='perc'?'pc':'pn'}`;
      const left=(sec.start/DURATION)*100;
      const width=((DURATION-sec.start)/DURATION)*100;
      band.style.left=left+'%'; band.style.width=width+'%';
      timeline.appendChild(band);
    });
    for(let s=0;s<=DURATION;s+=5){
      const x=(s/DURATION)*W();
      const gl=document.createElement('div'); gl.className='gridline'; gl.style.left=(x|0)+'px';
      timeline.appendChild(gl);
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=s+'s';
      lab.style.left=`calc(${(s/DURATION)*100}% + 4px)`; timeline.appendChild(lab);
    }
  }
  initTimeline(); window.addEventListener('resize', initTimeline);

  // ===== Transport UI hooks =====
  document.getElementById('btnPlay').addEventListener('click', ()=> startUITimer());
  document.getElementById('btnStop').addEventListener('click', ()=> {/* handled in Part 3 */});
  document.getElementById('btnReset').addEventListener('click', ()=>{
    playhead.style.left='0%'; txtTime.textContent='t = 0.0s';
  });

  // ===== Score Builder =====
  const ilist = document.getElementById('ilist');
  const inpBPM = document.getElementById('inpBPM');
  const inpOffset = document.getElementById('inpOffset');
  const inpVol = document.getElementById('inpVol');
  const inpNotes = document.getElementById('inpNotes');
  const btnAddPattern = document.getElementById('btnAddPattern');
  const btnClearPatterns = document.getElementById('btnClearPatterns');
  const btnExportPatterns = document.getElementById('btnExportPatterns');
  const tblBody = document.querySelector('#tblPatterns tbody');

  let patternIdCounter = 1;

  function checkedInstruments(){
    return Array.from(ilist.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
  }

  function parseNotes(raw){
    const out=[];
    const items = String(raw).split(',').map(s=>s.trim()).filter(Boolean);
    for (const it of items){
      const m = it.match(/^([A-G](?:#|b)?-?\d|[KkSsHh])\s*:\s*([0-9]*\.?[0-9]+)\s*:\s*([0-9]*\.?[0-9]+)$/);
      if (!m) continue;
      const name = m[1]; const up = name.toUpperCase();
      const beat = parseFloat(m[2]); const dur = parseFloat(m[3]);
      const isPitch = /^[A-G]/i.test(name);
      out.push({name:up, beat, dur, _freq:isPitch ? noteNameToFreq(up) : null});
    }
    if (!out.length) throw new Error('No valid notes parsed. Use NOTE:beat:dur (e.g., C4:0:1) or K/S/H for drums.');
    return out;
  }

  function sectionOfInstrument(inst){
    return SECTION_OF[inst] || 'strings';
  }

  function addRow(p){
    const tr=document.createElement('tr');
    tr.dataset.id = p.id;
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.instrument}</td>
      <td>${p.section}</td>
      <td>${p.bpm}</td>
      <td>${p.offsetSec}</td>
      <td>${p.vol}</td>
      <td><div class="small">${p.notes.map(n=>`${n.name}:${n.beat}:${n.dur}`).join(', ')}</div></td>
      <td><button class="btn warn btnRemove">Remove</button></td>
    `;
    tr.querySelector('.btnRemove').addEventListener('click', ()=>{
      const id=parseInt(tr.dataset.id,10);
      const idx=patterns.findIndex(x=>x.id===id);
      if (idx>=0){ patterns.splice(idx,1); tr.remove(); txtMsg.textContent='Pattern removed'; }
    });
    tblBody.appendChild(tr);
  }

  btnAddPattern.addEventListener('click', ()=>{
    try{
      const instruments = checkedInstruments();
      if (!instruments.length) throw new Error('Select at least one instrument.');
      const bpm = Math.max(20, Math.min(240, parseFloat(inpBPM.value)||120));
      const offsetSec = Math.max(0, Math.min(60, parseFloat(inpOffset.value)||0));
      const vol = Math.max(0, Math.min(1, parseFloat(inpVol.value)||0.8));
      const notes = parseNotes(inpNotes.value);

      for (const instrument of instruments){
        const section = sectionOfInstrument(instrument);
        const pat = { id: patternIdCounter++, instrument, section, bpm, offsetSec, vol, notes: JSON.parse(JSON.stringify(notes)) };
        patterns.push(pat); addRow(pat);
      }
      txtMsg.textContent='Pattern(s) added';
    }catch(err){
      txtMsg.textContent=err.message || 'Could not add pattern(s)';
    }
  });

  btnClearPatterns.addEventListener('click', ()=>{
    patterns.splice(0, patterns.length);
    tblBody.innerHTML='';
    txtMsg.textContent='All patterns cleared';
  });

  btnExportPatterns.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(patterns, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='mixer_patterns.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });

})();
</script>
</body>
</html>
