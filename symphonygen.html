<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Audio→CSV Enriched • 60s Orchestrator • 32 Chairs</title>
<style>
  :root{
    --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758; --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --blink:#6ee7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1500px;margin:0 auto;padding:16px;display:grid;grid-template-columns:520px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"],input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
  }
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
  .stat b{color:var(--ok)}
  #status{font-size:12px;color:#9ad1ff;margin-top:8px}
  .danger{background:#3b1220;border-color:#6b1f35}
  small.hint{display:block;color:#a8b7e3;margin-top:6px}

  /* Stage */
  .stage{
    position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;
    padding-top:300px;
    background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)
  }
  .stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(4,1fr);gap:10px;min-height:620px}
  .cell{display:flex;align-items:center;justify-content:center;min-height:115px}
  .section{
    background:linear-gradient(180deg,#0e1b43,#0a1232); border:1px solid #20326d; border-radius:12px;
    width:100%; height:100%; padding:10px; display:flex; flex-direction:column; gap:6px; justify-content:space-between;
  }
  .title{font-weight:800;color:#e4eeff;font-size:12px}
  .meta{font-size:11px;color:#9bb9ff}
  .lights{display:flex;align-items:center;gap:6px}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
  .blink{animation:blink .45s ease-out}
  @keyframes blink{0%{background:#0c1430;border-color:#2a3b7a}30%{background:var(--blink);border-color:#bfefff}100%{background:#0c1430;border-color:#2a3b7a}}
  .check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;display:flex;align-items:center;justify-content:center;font-weight:900}
  .checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
  .mixRow{display:flex;gap:6px;align-items:center}
  .btnSmall{padding:6px 8px;font-size:11px}

  .conductor{width:92px;height:92px;border-radius:50%; background:#0d1b44;border:2px solid #284a9b;
    display:flex;align-items:center;justify-content:center; font-weight:800; color:#cfe1ff;
    box-shadow:0 0 0 0 rgba(59,130,246,.45); animation:conPulse 1.4s ease-in-out infinite; animation-play-state:paused;}
  @keyframes conPulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
  .guide{position:absolute; left:50%; transform:translateX(-50%); top:118px; width:96%; max-width:1000px;
    background:#0c1536; border:1px solid #274094; border-radius:12px; padding:10px 12px; color:#cfe1ff; font-size:12px;}
  .guide b{color:#9fe8ff}
  .guide ol{margin:6px 0 0 16px; padding-left:10px}
  .guide li{margin:2px 0}
  .statusDot{ width:12px;height:12px;border-radius:3px;background:#ffffff;border:2px solid #dddddd;display:inline-block; }
  .statusOn{background:var(--ok);border-color:#b7f5cd;}
  .conductorPanel{margin-top:12px; display:flex; justify-content:center;}
  .condCard{ width:260px; height:260px; border:1px solid var(--grid); border-radius:14px;
    background:#0d1b3d; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; }
  .conLabel{font-size:12px;color:#cfe1ff;opacity:0.9}
  .section.isA { outline: 2px solid #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.18) inset; }
  .section.isB { outline: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18) inset; }
  .badge { display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px;
    font-size:10px; font-weight:700; letter-spacing:.3px; vertical-align:middle; }
  .badgeA { background:#0b2a1e; border:1px solid #10b981; color:#b9f6da; }
  .badgeB { background:#0b1f3d; border:1px solid #3b82f6; color:#cfe1ff; }

  .chairPanel{max-height:260px; overflow:auto; border:1px solid var(--grid); border-radius:10px; padding:8px; background:#0f1a3b}
  .chairRow{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; align-items:center; margin-bottom:6px; font-size:12px}
  .chairHead{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; font-size:11px; color:#9fb2e4; margin-bottom:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,"Courier New",monospace;font-size:11px;color:#bfe3ff}
</style>
</head>
<body>
<header>
  <h1>CST — Audio→CSV • Enriched (60s) • A/B Loader • 32 Chairs</h1>
  <span style="font-size:12px;color:#9ad1ff">Analyzer fixed for MP3/WAV. Export enriched CSV.</span>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <div class="mixRow">
        <button id="btnAnalyze">2) Analyze 60s</button>
        <span id="dotAnalyze" class="statusDot" title="Analysis status"></span>
      </div>
      <button id="btnExport">3) Export CSV</button>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV (enriched) headers: <b>t,midi,vel,dur,is_bass,bar,beat,bpm,key</b>. Loader accepts simple or enriched.</small>

    <div class="hr"></div>

    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadA">Load CSV → A</button>
          <span id="dotA" class="statusDot" title="A loaded"></span>
        </div>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadB">Load CSV → B</button>
          <span id="dotB" class="statusDot" title="B loaded"></span>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Conductor / Musicalize -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="cinematic" selected>Cinematic — lush</option>
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="bach">Bach — contrapuntal</option>
          <option value="haydn">Haydn — balanced</option>
          <option value="tchaikovsky">Tchaikovsky — lyrical</option>
          <option value="ravel">Ravel — color</option>
          <option value="mahler">Mahler — expansive</option>
          <option value="shostakovich">Shostakovich — edgy</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="price">Florence Price — warm</option>
          <option value="lili">Lili Boulanger — luminous</option>
          <option value="clara">Clara Schumann — lyrical</option>
          <option value="fanny">Fanny Mendelssohn — elegant</option>
          <option value="amy">Amy Beach — romantic</option>
          <option value="saariaho">Kaija Saariaho — spectral</option>
          <option value="tower">Joan Tower — kinetic</option>
          <option value="montgomery">Jessie Montgomery — vibrant</option>
          <option value="williams">John Williams — cinematic</option>
          <option value="zimmer">Hans Zimmer — hybrid</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Humanize (ms)</label><input id="human" type="number" min="0" max="40" step="1" value="6"/></div>
      <div><label>Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Reverb Mix</label><input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
      <div><label>Stereo Spread</label><input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>GM Program (0–127)</label>
        <input id="gmProg" type="number" min="0" max="127" step="1" value="48" />
        <small class="hint">Global timbre (per-chair micro-variants still apply).</small>
      </div>
      <div>
        <label>Export Audio</label>
        <div class="mixRow">
          <button id="btnExportAudio">Export WAV (60s)</button>
          <span id="dotExport" class="statusDot" title="Export ready"></span>
        </div>
        <small class="hint">Lights when a 60s score is ready.</small>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Cadence & Pace -->
    <label style="font-weight:700">Cadence & Pace</label>
    <div class="row3" id="cadenceRow">
      <button class="cadBtn" data-cad="even">Even</button>
      <button class="cadBtn" data-cad="march">March (2/4)</button>
      <button class="cadBtn" data-cad="waltz">Waltz (3/4)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="latin">Latin (2–3)</button>
      <button class="cadBtn" data-cad="sync">Syncopated</button>
      <button class="cadBtn" data-cad="swing">Swing (Shuffle)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="jig68">Jig (6/8)</button>
      <button class="cadBtn" data-cad="odd54">Odd (5/4)</button>
      <div class="stat"><span>Active cadence</span><b id="cadName">Even</b></div>
    </div>
    <div class="row3" style="margin-top:8px">
      <button class="paceBtn" data-pace="adagio">Adagio</button>
      <button class="paceBtn" data-pace="andante">Andante</button>
      <button class="paceBtn" data-pace="moderato">Moderato</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="paceBtn" data-pace="allegro">Allegro</button>
      <button class="paceBtn" data-pace="vivace">Vivace</button>
      <button class="paceBtn" data-pace="presto">Presto</button>
    </div>
    <div class="stat" style="margin-top:6px"><span>Active pace</span><b id="paceName">Andante</b></div>

    <div class="hr"></div>

    <!-- Family Opening -->
    <label style="font-weight:700">Family Opening (entry timing bias)</label>
    <div class="row">
      <button id="btnOpenRandom" title="Generate a musical opening order">Randomize Family Opening</button>
      <button id="btnOpenReset">Reset Default</button>
    </div>
    <div class="stat" style="margin-top:6px">
      <span>Open @ seconds (Strings, Winds, Brass, Perc)</span>
      <b class="mono" id="openSummary">0, 8, 16, 24</b>
    </div>

    <div class="hr"></div>

    <!-- Orchestration Picks (UI stays the same as your version) -->
    <label style="font-weight:700">Orchestration Picks (A/B • non-overlap • total 32)</label>
    <div class="row" style="margin-bottom:6px">
      <div>
        <label>Target A (10–16)</label>
        <div class="mixRow">
          <input id="countA" type="number" min="10" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomA">Randomize A (16)</button>
        </div>
      </div>
      <div>
        <label>Target B (6–16)</label>
        <div class="mixRow">
          <input id="countB" type="number" min="6" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomB">Randomize B (16)</button>
        </div>
      </div>
    </div>
    <small class="hint">Counts auto-adjust to keep A + B = 32. Locks are respected.</small>

    <div class="twoCols" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>A Selected</span><b id="selCountA">0</b></div>
        </div>
        <div id="listA" class="pickList"></div>
      </div>
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>B Selected</span><b id="selCountB">0</b></div>
        </div>
        <div id="listB" class="pickList"></div>
      </div>
    </div>

    <div class="hr"></div>
    <label style="font-weight:700">Per-Chair Variants</label>
    <div class="chairHead"><div>Chair</div><div>Variant</div><div>Detune</div></div>
    <div id="chairPanel" class="chairPanel"></div>
    <small class="hint">Variant tweaks tone/attack; detune is ± cents. Defaults: A (bright) / B (warm).</small>

    <div class="hr"></div>
    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>
    <div id="status">Ready.</div>
  </section>

  <!-- RIGHT: STAGE (unchanged layout) -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Even spacing • Front strings, winds middle, brass back, perc rear • 32 chairs</b></div>
    </div>

    <div class="guide">
      <b>How the 1-minute AI Symphony Orchestra works (HTML + Web Audio)</b>
      <ol>
        <li><b>Load Audio</b> and <b>Analyze 60s</b> → auto-detected notes.</li>
        <li><b>Export CSV</b> (enriched) or load your own CSV into <b>A</b> and/or <b>B</b>.</li>
        <li>Pick chairs A/B (total 32, no overlap), set cadence/pace/variants.</li>
        <li>Press <b>Play</b>. Lights blink on sounding chairs.</li>
      </ol>
    </div>

    <!-- 32 Chairs grid (same IDs as your previous build) -->
    <div class="grid" id="chairsGrid"></div>

    <div class="conductorPanel">
      <div class="condCard">
        <div class="conductor" id="conductor">Conductor</div>
        <div class="conLabel" id="conLabel">Conductor / Musicalize: Cinematic — lush</div>
      </div>
    </div>
  </section>
<script>
/* ===== Helpers & scales ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const median=a=>{const s=[...a].sort((x,y)=>x-y),n=s.length;return n?(n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):0;}
function pcsFor(root,mode){const r=NOTE.indexOf(root);return (mode==='minor'?MINOR:MAJOR).map(pc=>(pc+r+120)%12);}
function snapToScale(m,pcs){ if(!m) return 0; const pc=((m%12)+12)%12; if(pcs.includes(pc)) return m; for(const d of [1,-1,2,-2]){const c=((pc+d)+12)%12;if(pcs.includes(c)) return m+d;} return m; }
const $=id=>document.getElementById(id);

/* ===== UI refs ===== */
const btnLoadAudio=$('btnLoadAudio'), btnAnalyze=$('btnAnalyze'), btnExport=$('btnExport'), audioFile=$('audioFile');
const detKey=$('detKey'), detBPM=$('detBPM'), statusEl=$('status');
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn'), conductor=$('conductor');
const conLabel=$('conLabel');
const cadName=$('cadName'), paceName=$('paceName');
const btnRandomA=$('btnRandomA'), btnRandomB=$('btnRandomB'), listA=$('listA'), listB=$('listB'), selCountA=$('selCountA'), selCountB=$('selCountB');
const gmProgEl=$('gmProg'), btnExportAudio=$('btnExportAudio');
const chairPanel=$('chairPanel'), chairsGrid=$('chairsGrid');
const countAEl=$('countA'), countBEl=$('countB');
const btnOpenRandom=$('btnOpenRandom'), btnOpenReset=$('btnOpenReset'), openSummary=$('openSummary');
const dotA=$('dotA'), dotB=$('dotB'), dotAnalyze=$('dotAnalyze'), dotExport=$('dotExport');
function light(el,on){ if(!el) return; if(on){ el.classList.add('statusOn'); } else { el.classList.remove('statusOn'); } }
function setStatus(s){ statusEl.textContent=s; }
function updateConLabel(){ const txt=composerEl.options[composerEl.selectedIndex].textContent; conLabel.textContent='Conductor / Musicalize: ' + txt; }
NOTE.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; if(n==='C') o.selected=true; keyRootEl.appendChild(o); });

/* ===== 32-chair definitions (same IDs) ===== */
const BASE=['vln1','vln2','violas','cellos','basses','harp','piano','flutes','oboes','clarinets','bassoons','trumpets','horns','trombones','perc','drums'];
const CHAIRS = BASE.flatMap(b=>[b+'a', b+'b']);
const LABEL={
  vln1a:'1st Violins A', vln1b:'1st Violins B',
  vln2a:'2nd Violins A', vln2b:'2nd Violins B',
  violasa:'Violas A',   violasb:'Violas B',
  cellosa:'Cellos A',   cellosb:'Cellos B',
  bassesa:'Double Basses A', bassesb:'Double Basses B',
  harpa:'Harp/Keys A',  harpb:'Harp/Keys B',
  pianoa:'Piano A',     pianob:'Piano B',
  flutesa:'Flutes/Picc. A', flutesb:'Flutes/Picc. B',
  oboesa:'Oboes A', oboesb:'Oboes B',
  clarinetsa:'Clarinets A', clarinetsb:'Clarinets B',
  bassoonsa:'Bassoons A', bassoonsb:'Bassoons B',
  trumpetsa:'Trumpets A', trumpetsb:'Trumpets B',
  hornsa:'French Horns A', hornsb:'French Horns B',
  trombonesa:'Trombones/Tuba A', trombonesb:'Trombones/Tuba B',
  perca:'Percussion A', percb:'Percussion B',
  drumsa:'Drums A', drumsb:'Drums B'
};
function baseOf(id){ return id.slice(0,-1).replace(/(sa|sb)$/,'s'); }
function familyOfSection(sec){
  const b=baseOf(sec);
  if (['vln1','vln2','violas','cellos','basses','harp','piano'].includes(b)) return 'strings';
  if (['flutes','oboes','clarinets','bassoons'].includes(b)) return 'winds';
  if (['horns','trumpets','trombones'].includes(b)) return 'brass';
  if (['perc','drums'].includes(b)) return 'perc';
  return 'strings';
}
const FAM={
  strings:['vln1a','vln1b','vln2a','vln2b','violasa','violasb','cellosa','cellosb','bassesa','bassesb','harpa','harpb','pianoa','pianob'],
  winds:['flutesa','flutesb','oboesa','oboesb','clarinetsa','clarinetsb','bassoonsa','bassoonsb'],
  brass:['hornsa','hornsb','trumpetsa','trumpetsb','trombonesa','trombonesb'],
  perc:['perca','percb','drumsa','drumsb']
};

/* Build chairs grid */
function buildChairs(){
  chairsGrid.innerHTML='';
  const metaMap={
    trumpetsa:'Back L', trumpetsb:'Back L', hornsa:'Back M', hornsb:'Back M', perca:'Back C', percb:'Back C', trombonesa:'Back R', trombonesb:'Back R',
    flutesa:'Winds', flutesb:'Winds', oboesa:'Winds', oboesb:'Winds', clarinetsa:'Winds', clarinetsb:'Winds', bassoonsa:'Winds', bassoonsb:'Winds',
    pianoa:'Keys', pianob:'Keys', bassesa:'Back Strings', bassesb:'Back Strings', drumsa:'Rhythm', drumsb:'Rhythm', harpa:'Right', harpb:'Right',
    vln1a:'Far L', vln1b:'Far L', vln2a:'L-Center', vln2b:'L-Center', violasa:'Center', violasb:'Center', cellosa:'R-Center', cellosb:'R-Center'
  };
  const order=[
    'trumpetsa','trumpetsb','hornsa','hornsb','perca','percb','trombonesa','trombonesb',
    'flutesa','flutesb','oboesa','oboesb','clarinetsa','clarinetsb','bassoonsa','bassoonsb',
    'pianoa','pianob','bassesa','bassesb','drumsa','drumsb','harpa','harpb',
    'vln1a','vln1b','vln2a','vln2b','violasa','violasb','cellosa','cellosb'
  ];
  order.forEach(id=>{
    const cell=document.createElement('div'); cell.className='cell';
    cell.innerHTML=`<div class="section" data-sec="${id}">
      <div class="title">${LABEL[id]}</div>
      <div class="meta">${metaMap[id]||''}</div>
      <div class="lights"><div class="dot" id="dot-${id}"></div><div class="check" id="chk-${id}"></div></div>
      <div class="mixRow"><button class="btnSmall" data-mute="${id}">Mute</button><button class="btnSmall" data-solo="${id}">Solo</button></div>
    </div>`;
    chairsGrid.appendChild(cell);
  });
}
buildChairs();

/* Stage wiring */
const SECTIONS=[...CHAIRS];
const DOT={}, CHK={}, MUTE={}, SOLO={on:false,id:null};
SECTIONS.forEach(id=>{ DOT[id]=document.getElementById('dot-'+id); CHK[id]=document.getElementById('chk-'+id); MUTE[id]=false; });
document.addEventListener('click',e=>{
  const t=e.target;
  if(t.matches('[data-mute]')){const s=t.getAttribute('data-mute'); MUTE[s]=!MUTE[s]; t.textContent=MUTE[s]?'Unmute':'Mute';}
  if(t.matches('[data-solo]')){const s=t.getAttribute('data-solo'); if(SOLO.on&&SOLO.id===s){SOLO.on=false;SOLO.id=null;t.textContent='Solo';}else{SOLO.on=true;SOLO.id=s;document.querySelectorAll('[data-solo]').forEach(x=>x.textContent='Solo');t.textContent='Unsolo';}}
});

/* Mark A/B on stage */
function markStage(){
  const aSet = new Set(PICK_A.map(x=>x.id));
  const bSet = new Set(PICK_B.map(x=>x.id));
  SECTIONS.forEach(id=>{
    const secEl = document.querySelector(`.section[data-sec="${id}"]`);
    if(!secEl) return;
    secEl.classList.remove('isA','isB');
    const titleEl = secEl.querySelector('.title');
    titleEl.querySelectorAll('.badge').forEach(b=>b.remove());
    if(aSet.has(id)){
      secEl.classList.add('isA'); const bd = document.createElement('span'); bd.className='badge badgeA'; bd.textContent='A'; titleEl.appendChild(bd);
    }else if(bSet.has(id)){
      secEl.classList.add('isB'); const bd = document.createElement('span'); bd.className='badge badgeB'; bd.textContent='B'; titleEl.appendChild(bd);
    }
  });
}

/* Flexible targets */
let TARGET_A=16, TARGET_B=16;
function syncTargets(from){
  const a=clamp(parseInt(countAEl.value||'16',10),10,16);
  const b=clamp(parseInt(countBEl.value||'16',10),6,16);
  if(from==='A'){ TARGET_A=a; TARGET_B=clamp(32-TARGET_A,6,16); TARGET_A=32-TARGET_B; countBEl.value=String(TARGET_B); }
  else if(from==='B'){ TARGET_B=b; TARGET_A=clamp(32-TARGET_B,10,16); TARGET_B=32-TARGET_A; countAEl.value=String(TARGET_A); }
  else { TARGET_A=a; TARGET_B=b; TARGET_B=clamp(32-TARGET_A,6,16); TARGET_A=32-TARGET_B; countAEl.value=String(TARGET_A); countBEl.value=String(TARGET_B); }
  btnRandomA.textContent=`Randomize A (${TARGET_A})`; btnRandomB.textContent=`Randomize B (${TARGET_B})`;
}
countAEl.onchange=()=>syncTargets('A'); countBEl.onchange=()=>syncTargets('B');

/* Picks (non-overlap) */
let PICK_A=[], PICK_B=[];
function pickN(arr,n,exclude=new Set()){ const pool=arr.filter(x=>!exclude.has(x)), out=[]; while(pool.length && out.length<n){ const k=Math.floor(Math.random()*pool.length); out.push(pool.splice(k,1)[0]); } return out; }
function famOf(id){ return familyOfSection(id); }
function renderSide(side){
  const box = side==='A'? listA : listB; const arr = side==='A'? PICK_A : PICK_B; const setCount = side==='A'? selCountA : selCountB;
  box.innerHTML='';
  arr.forEach((it,i)=>{
    const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border:1px solid var(--grid);border-radius:8px;margin-bottom:6px';
    row.innerHTML=`<div>${LABEL[it.id]} <span style="color:#9fb2e4;font-size:11px">(${familyOfSection(it.id)})</span></div>
                   <label style="font-size:12px;display:flex;align-items:center;gap:6px">
                     <input type="checkbox" ${it.locked?'checked':''} data-lock="${side}:${i}"/> lock
                   </label>`;
    box.appendChild(row);
  });
  setCount.textContent=String(arr.length);
  box.querySelectorAll('input[data-lock]').forEach(cb=>{
    cb.onchange=()=>{ const [s,idx]=cb.getAttribute('data-lock').split(':'); const I=+idx; (s==='A'?PICK_A:PICK_B)[I].locked=cb.checked; };
  });
}
function enforceBExclusion(){
  const aSet=new Set(PICK_A.map(x=>x.id)); let changed=false;
  PICK_B = PICK_B.filter(x=>!aSet.has(x.id) ? true : (changed=true,false));
  if(changed){
    const excl=new Set([...aSet, ...PICK_B.map(x=>x.id)]);
    const need = TARGET_B - PICK_B.length;
    if(need>0){
      const fill=pickN(SECTIONS, need, excl).map(id=>({id,fam:famOf(id)}));
      PICK_B=[...PICK_B, ...fill].slice(0,TARGET_B).map(x=>({...x,locked:!!x.locked}));
    }
  }
}
function randomizeA(){
  const keep=PICK_A.filter(x=>x.locked); const excl=new Set(keep.map(x=>x.id)); const p=[];
  const perFam=Math.max(2,Math.floor((TARGET_A-keep.length)/4));
  for(const fam of ['strings','winds','brass','perc']){
    const options=FAM[fam].filter(id=>!excl.has(id));
    if(options.length){ const take=pickN(options, perFam, excl); take.forEach(id=>{excl.add(id); p.push({id,fam});}); }
  }
  pickN(SECTIONS, TARGET_A-(keep.length+p.length), excl).forEach(id=>{excl.add(id); p.push({id,fam:famOf(id)});});
  PICK_A=[...keep, ...p].slice(0,TARGET_A).map(x=>({...x,locked:!!x.locked}));
  enforceBExclusion(); renderSide('A'); renderSide('B'); markStage();
}
function randomizeB(){
  const keep=PICK_B.filter(x=>x.locked);
  const excl=new Set([...PICK_A.map(x=>x.id), ...keep.map(x=>x.id)]);
  const chosen=pickN(SECTIONS, TARGET_B-keep.length, excl).map(id=>({id,fam:famOf(id)}));
  PICK_B=[...keep, ...chosen].slice(0,TARGET_B).map(x=>({...x,locked:!!x.locked}));
  renderSide('B'); markStage();
}

/* Conductor presets (same values) */
const PRESETS_BASE={classic:{swing:0.06,human:5,quant:0.125,reverb:0.12,spread:0.45},bold:{swing:0.08,human:7,quant:0.125,reverb:0.16,spread:0.55},
color:{swing:0.12,human:8,quant:0.125,reverb:0.20,spread:0.60},fluid:{swing:0.18,human:10,quant:0.0625,reverb:0.22,spread:0.65},
rhythmic:{swing:0.04,human:8,quant:0.0625,reverb:0.14,spread:0.55},warm:{swing:0.10,human:8,quant:0.125,reverb:0.18,spread:0.55},
luminous:{swing:0.14,human:9,quant:0.125,reverb:0.20,spread:0.60},lyrical:{swing:0.10,human:7,quant:0.125,reverb:0.17,spread:0.55},
romantic:{swing:0.10,human:8,quant:0.125,reverb:0.19,spread:0.58},spectral:{swing:0.20,human:12,quant:0.0625,reverb:0.26,spread:0.70},
kinetic:{swing:0.08,human:9,quant:0.0625,reverb:0.18,spread:0.60},vibrant:{swing:0.12,human:9,quant:0.125,reverb:0.22,spread:0.62},
cinematic:{swing:0.12,human:9,quant:0.0625,reverb:0.26,spread:0.75},contrapuntal:{swing:0.05,human:5,quant:0.125,reverb:0.12,spread:0.40},
balanced:{swing:0.06,human:6,quant:0.125,reverb:0.14,spread:0.48},expansive:{swing:0.10,human:9,quant:0.125,reverb:0.22,spread:0.60},
edgy:{swing:0.06,human:8,quant:0.0625,reverb:0.16,spread:0.55},hybrid:{swing:0.10,human:9,quant:0.125,reverb:0.24,spread:0.72}};
const PRESETS={mozart:PRESETS_BASE.classic,beethoven:PRESETS_BASE.bold,bach:PRESETS_BASE.contrapuntal,haydn:PRESETS_BASE.balanced,
tchaikovsky:PRESETS_BASE.romantic,ravel:PRESETS_BASE.color,mahler:PRESETS_BASE.expansive,shostakovich:PRESETS_BASE.edgy,
debussy:PRESETS_BASE.fluid,stravinsky:PRESETS_BASE.rhythmic,price:PRESETS_BASE.warm,lili:PRESETS_BASE.luminous,
clara:PRESETS_BASE.lyrical,fanny:PRESETS_BASE.lyrical,amy:PRESETS_BASE.romantic,saariaho:PRESETS_BASE.spectral,
tower:PRESETS_BASE.kinetic,montgomery:PRESETS_BASE.vibrant,williams:PRESETS_BASE.cinematic,zimmer:PRESETS_BASE.hybrid,cinematic:PRESETS_BASE.cinematic};
function applyConductorPreset(){const p=PRESETS[composerEl.value]||PRESETS.cinematic; swingEl.value=String(p.swing); humanEl.value=String(p.human);
quantEl.value=String(p.quant); reverbMixEl.value=String(p.reverb); spreadEl.value=String(p.spread); updateConLabel();}
composerEl.onchange=applyConductorPreset;
const PRESETS_PACE={adagio:{name:'Adagio',bpmMul:0.85,density:0.7},andante:{name:'Andante',bpmMul:1.0,density:0.85},moderato:{name:'Moderato',bpmMul:1.1,density:1.0},
allegro:{name:'Allegro',bpmMul:1.2,density:1.1},vivace:{name:'Vivace',bpmMul:1.35,density:1.25},presto:{name:'Presto',bpmMul:1.5,density:1.35}};
const CADENCES={even:{name:'Even',pattern:[1,0,0,0],percEvery:4,sync:0},march:{name:'March (2/4)',pattern:[1,0],percEvery:2,sync:0.05},
waltz:{name:'Waltz (3/4)',pattern:[1,0,0],percEvery:3,sync:0.03},latin:{name:'Latin (2–3)',pattern:[1,0,1,0,1],percEvery:1,sync:0.12},
sync:{name:'Syncopated',pattern:[0,1,0,1],percEvery:2,sync:0.18},swing:{name:'Swing (Shuffle)',pattern:[1,0,0,1,0,0],percEvery:3,sync:0.10},
jig68:{name:'Jig (6/8)',pattern:[1,0,0,1,0,0],percEvery:3,sync:0.06},odd54:{name:'Odd (5/4)',pattern:[1,0,0,1,0],percEvery:5,sync:0.08}};
let CAD='even', PAC='andante';
document.querySelectorAll('.cadBtn').forEach(b=>b.onclick=()=>{ CAD=b.dataset.cad; $('cadName').textContent=CADENCES[CAD].name; });
document.querySelectorAll('.paceBtn').forEach(b=>b.onclick=()=>{ PAC=b.dataset.pace; $('paceName').textContent=PRESETS_PACE[PAC].name; });

/* Family Opening bias */
let FAMILY_OPEN = { strings: 0, winds: 8, brass: 16, perc: 24 };
function summarizeOpenings(){ $('openSummary').textContent = `${FAMILY_OPEN.strings}, ${FAMILY_OPEN.winds}, ${FAMILY_OPEN.brass}, ${FAMILY_OPEN.perc}`; }
function randomIn(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randomizeFamilyOpening(){ const w0=randomIn(6,14), b0=randomIn(w0+4,Math.min(26,w0+14)), p0=randomIn(b0+4,Math.min(36,b0+14)); FAMILY_OPEN={strings:0,winds:w0,brass:b0,perc:p0}; summarizeOpenings(); setStatus(`Family Opening randomized → ${$('openSummary').textContent}`);}
function resetFamilyOpening(){ FAMILY_OPEN={strings:0,winds:8,brass:16,perc:24}; summarizeOpenings(); setStatus('Family Opening reset.'); }
btnOpenRandom.onclick=randomizeFamilyOpening; btnOpenReset.onclick=resetFamilyOpening;

/* Chair variants + audio buses (kept same behavior) */
let AUDIO={ctx:null, master:null, comp:null, dry:null, wet:null, convolver:null, bus:{}};
let GM_PROGRAM=48; gmProgEl.onchange=()=>{ GM_PROGRAM = clamp(parseInt(gmProgEl.value,10)||0,0,127); };
const VARIANTS = {auto:{name:'Auto',tone:1.00,attack:0.000}, bright:{name:'Bright',tone:1.12,attack:-0.002}, warm:{name:'Warm',tone:0.88,attack:+0.003}, mellow:{name:'Mellow',tone:0.78,attack:+0.004}, edgy:{name:'Edgy',tone:1.22,attack:-0.003}};
const CHAIR_VARIANT = Object.fromEntries(CHAIRS.map(id=>[id, id.endsWith('a')?'bright':'warm']));
const CHAIR_DETUNE  = Object.fromEntries(CHAIRS.map(id=>[id, id.endsWith('a')?+3:-3]));
function buildChairPanel(){
  chairPanel.innerHTML='';
  CHAIRS.forEach(id=>{
    const row=document.createElement('div'); row.className='chairRow';
    const sel=document.createElement('select'); sel.dataset.vid=id;
    ['auto','bright','warm','mellow','edgy'].forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=VARIANTS[k].name; sel.appendChild(o); });
    sel.value=CHAIR_VARIANT[id];
    const det=document.createElement('input'); det.type='number'; det.step='1'; det.min='-20'; det.max='20'; det.value=String(CHAIR_DETUNE[id]); det.style.width='100%'; det.dataset.did=id;
    const lab=document.createElement('div'); lab.textContent=LABEL[id];
    row.appendChild(lab); row.appendChild(sel); row.appendChild(det); chairPanel.appendChild(row);
    sel.onchange=()=>{ CHAIR_VARIANT[id]=sel.value; };
    det.onchange=()=>{ let v=parseInt(det.value,10); if(!Number.isFinite(v)) v=0; v=clamp(v,-50,50); CHAIR_DETUNE[id]=v; det.value=String(v); };
  });
}
function makeHallIR(ctx){ const len=ctx.sampleRate*2.2, ir=ctx.createBuffer(2,len,ctx.sampleRate); for(let ch=0; ch<2; ch++){ const d=ir.getChannelData(ch); let x=0; for(let i=0;i<len;i++){ const n=(Math.random()*2-1)*0.5; const t=i/ctx.sampleRate; const dec=Math.exp(-t*1.5); x=0.32*n+0.68*x; d[i]=x*dec; } } return ir; }
function getAudio(){
  if(!AUDIO.ctx){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const comp=ctx.createDynamicsCompressor(); comp.threshold.value=-18; comp.ratio.value=3; comp.attack.value=0.004; comp.release.value=0.2;
    const dry=ctx.createGain(), wet=ctx.createGain(); dry.gain.value=1; wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
    const conv=ctx.createConvolver(); conv.buffer=makeHallIR(ctx);
    const master=ctx.createGain(); master.gain.value=parseFloat(masterVolEl.value||"0.85");
    dry.connect(comp); conv.connect(wet); wet.connect(comp); comp.connect(master); master.connect(ctx.destination);
    AUDIO={ctx,master,comp,dry,wet,convolver:conv,bus:{}};
    buildBuses();
  }
  AUDIO.master.gain.value=parseFloat(masterVolEl.value||"0.85");
  AUDIO.wet.gain.value=parseFloat(reverbMixEl.value||"0.18");
  return AUDIO.ctx;
}
function buildBuses(){
  const ctx=AUDIO.ctx, spread=parseFloat(spreadEl.value||"0.55");
  AUDIO.bus={};
  const panTable={
    vln1a:-0.78, vln1b:-0.68, vln2a:-0.50, vln2b:-0.40, violasa:-0.10, violasb:0.00,
    cellosa:0.30, cellosb:0.40, bassesa:0.60, bassesb:0.70, harpa:0.80, harpb:0.87,
    pianoa:-0.85, pianob:-0.75,
    flutesa:-0.15, flutesb:0.00, oboesa:0.10, oboesb:0.20, clarinetsa:-0.25, clarinetsb:-0.10, bassoonsa:0.15, bassoonsb:0.28,
    trumpetsa:-0.55, trumpetsb:-0.45, hornsa:0.00, hornsb:0.10, trombonesa:0.45, trombonesb:0.55,
    perca:-0.05, percb:0.05, drumsa:0.10, drumsb:0.18
  };
  for(const id of SECTIONS){
    const g=ctx.createGain(); g.gain.value=1;
    const l=ctx.createGain(), r=ctx.createGain(), m=ctx.createChannelMerger(2);
    g.connect(l); g.connect(r); l.connect(m,0,0); r.connect(m,0,1);
    const pan=Math.max(-0.95,Math.min(0.95,(panTable[id]||0)*spread));
    const L=Math.max(0,Math.min(1,0.5 - pan/2)), R=Math.max(0,Math.min(1,0.5 + pan/2));
    l.gain.value=L; r.gain.value=R;
    m.connect(AUDIO.dry); m.connect(AUDIO.convolver);
    AUDIO.bus[id]=g;
  }
}
masterVolEl.oninput=()=>{ getAudio(); AUDIO.master.gain.value=parseFloat(masterVolEl.value); };
reverbMixEl.oninput=()=>{ getAudio(); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); };
spreadEl.oninput=()=>{ if(AUDIO.ctx){ try{AUDIO.ctx.close();}catch(_){ } AUDIO.ctx=null; } getAudio(); };

let A={events:[]}, B={events:[]}, LAST_ANALYSIS={events:[],key:"C major",bpm:100};
function toCSV_enriched(events,key,bpm){
  const rows=["t,midi,vel,dur,is_bass,bar,beat,bpm,key"];
  for(const e of events){ rows.push([e.t.toFixed(3),e.midi|0,Math.round((e.vel||0.6)*127),e.dur.toFixed(3),e.is_bass?1:0,e.bar|0,(e.beat||1).toFixed(3),Math.round(bpm),key].join(",")); }
  return rows.join("\n");
}
function downloadCSV(name,text){ const blob=new Blob([text],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0); }

function parseCSVFlexible(text){
  const lines=text.replace(/\r/g,'').trim().split('\n'); if(!lines.length) return [];
  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const idx=(name)=>hdr.indexOf(name);
  const hasEnriched = idx('midi')>=0;
  const out=[];
  for(let i=1;i<lines.length;i++){
    if(!lines[i]) continue;
    const r=lines[i].split(',');
    if(hasEnriched){
      const t=parseFloat(r[idx('t')]||"0");
      const midi=parseInt(r[idx('midi')]||"0",10);
      const vel=parseInt(r[idx('vel')]||"96",10)/127;
      const dur=parseFloat(r[idx('dur')]||"0.25");
      const is_bass = (parseInt(r[idx('is_bass')]||"0",10)===1);
      const bar=parseInt(r[idx('bar')]||"1",10);
      const beat=parseFloat(r[idx('beat')]||"1");
      out.push({t, midi, vel, dur, is_bass, bar, beat});
    }else{
      const ti=idx('t'), mi=idx('m'), bi=idx('b');
      if(ti<0||mi<0||bi<0) throw new Error("CSV must have headers: t,m,b or enriched headers.");
      const t=parseFloat(r[ti]||"0"), m=parseInt(r[mi]||"0",10), b=parseInt(r[bi]||"0",10);
      if(Number.isFinite(t)&&t>=0&&t<=60){ if(m) out.push({t, midi:m, vel:0.7, dur:0.25, is_bass:false, bar:1, beat:1}); if(b) out.push({t, midi:b, vel:0.6, dur:0.35, is_bass:true, bar:1, beat:1}); }
    }
  }
  return out.sort((a,b)=>a.t-b.t);
}
const dotA=$('dotA'), dotB=$('dotB'), dotAnalyze=$('dotAnalyze'), dotExport=$('dotExport');
function checkExportReady(){ const ready = (A.events?.length)||(B.events?.length)||(LAST_ANALYSIS.events?.length); light(dotExport, !!ready); }

/* A/B loaders */
btnLoadA.onclick=async()=>{ const f=csvA.files?.[0]; if(!f){alert("Select CSV for A");return;}
  try{A.events=parseCSVFlexible(await f.text());}catch(e){alert(e.message);return;}
  if(PICK_A.length===0) randomizeA(); enforceBExclusion(); setStatus(`A loaded: ${A.events.length} events`); light(dotA,true); checkExportReady(); markStage();
};
btnLoadB.onclick=async()=>{ const f=csvB.files?.[0]; if(!f){alert("Select CSV for B");return;}
  try{B.events=parseCSVFlexible(await f.text());}catch(e){alert(e.message);return;}
  if(PICK_B.length===0) randomizeB(); setStatus(`B loaded: ${B.events.length} events`); light(dotB,true); checkExportReady(); markStage();
};

/* Targets + randomize buttons */
countAEl.value='16'; countBEl.value='16'; syncTargets();
btnRandomA.onclick=()=>{ syncTargets('A'); randomizeA(); setStatus(`A randomized (${TARGET_A}). B auto-adjusted.`); };
btnRandomB.onclick=()=>{ syncTargets('B'); randomizeB(); setStatus(`B randomized (${TARGET_B}).`); };

/* Conductor UI init */
applyConductorPreset(); updateConLabel();
summarizeOpenings(); randomizeA(); randomizeB(); buildChairPanel(); conductor.style.animationPlayState='paused';
setStatus('Ready.'); checkExportReady();

/* ====== MUSICALIZATION (unchanged logic) ====== */
function activeSet(side){ return new Set((side==='A'?PICK_A:PICK_B).map(x=>x.id)); }
function densityCap(){ return Math.max(4, Math.round(10*({adagio:0.7,andante:0.85,moderato:1.0,allegro:1.2,vivace:1.25,presto:1.35}[PAC]))); }
function cadenceBeats(BPM){
  const beat=60/ Math.max(40, Math.min(220, BPM));
  const pat=CADENCES[CAD].pattern; const hits=[]; for(let t=0,i=0; t<=60; t+=beat, i++){ hits.push({t:Math.min(60,t), on:pat[i % pat.length]}); }
  return {beat, hits};
}
function sectionForSelected(midi,isBass,side,tSec){
  const chosen=activeSet(side);
  const allowed=[...chosen].filter(sec=> tSec>=(FAMILY_OPEN[familyOfSection(sec)]??0) );
  const tryPick=(pool)=>pool.find(s=>allowed.includes(s)) || null;
  const byPitch=()=>{
    if(isBass || midi<=43) return tryPick(['bassesa','bassesb','trombonesa','trombonesb','hornsa','hornsb','pianoa','pianob']);
    if(midi<=55)          return tryPick(['cellosa','cellosb','violasa','violasb','hornsa','hornsb','pianoa','pianob']);
    if(midi<=64)          return tryPick(['violasa','violasb','vln2a','vln2b','clarinetsa','clarinetsb','pianoa','pianob']);
    if(midi<=76)          return tryPick(['vln2a','vln2b','vln1a','vln1b','flutesa','flutesb','oboesa','oboesb','clarinetsa','clarinetsb','pianoa','pianob']);
    if(midi<=84)          return tryPick(['vln1a','vln1b','flutesa','flutesb','oboesa','oboesb','pianoa','pianob']);
    return tryPick(['flutesa','flutesb','vln1a','vln1b','clarinetsa','clarinetsb','oboesa','oboesb','pianoa','pianob']);
  };
  return byPitch() || (allowed.length? allowed[Math.floor(Math.random()*allowed.length)] : ([...chosen][0]||'vln1a'));
}
function musicalize(events, side){
  if(!events?.length) return [];
  const BPM = Math.round(parseFloat(bpmEl.value||"100") * ({adagio:0.85,andante:1.0,moderato:1.1,allegro:1.2,vivace:1.35,presto:1.5}[PAC]));
  const beat = 60/Math.max(40,Math.min(220,BPM));
  const qDiv=parseFloat(quantEl.value||"0.125"), grid=beat*4*qDiv;
  const swing=parseFloat(swingEl.value||"0"), human=parseFloat(humanEl.value||"0")/1000;
  const pcs=pcsFor(keyRootEl.value, keyModeEl.value);

  const lastBy=new Map(); const cap=densityCap(); let lastSec=-1, perSec=0; const out=[];
  for(const e of events){
    let q=Math.round(e.t/grid)*grid; if(grid<=beat/2+1e-6){ const pos=Math.round(q/grid); if(pos%2===1) q+=swing*grid*0.5; }
    q=Math.max(0,Math.min(60,q)); const secT=Math.floor(q); if(secT!==lastSec){ perSec=0; lastSec=secT; }
    const m=e.midi? snapToScale(e.midi,pcs):0;
    const push=(midi,isBass,vel,dr)=>{
      if(!midi) return; const last=lastBy.get(midi)||-999; if(q-last<0.08) return; if(perSec>=cap) return; lastBy.set(midi,q); perSec++;
      const jitter=(Math.random()*2-1)*human, dur=isBass?(e.dur||0.45):(e.dur||0.28), base=(e.vel|| (isBass?0.9:0.76));
      out.push({t:Math.max(0,Math.min(60,q+jitter)), midi:Math.round(midi), dur:dr||dur, vel:vel||base, isBass, sec:sectionForSelected(midi,isBass,side,q)});
    };
    if(m) push(m,false,e.vel,e.dur);
    if(e.is_bass) push(m-12,true,(e.vel||0.65),Math.max(0.25,e.dur||0.35));
  }
  const chosen=activeSet(side);
  const {beat:hbeat,hits}=cadenceBeats(BPM);
  if(chosen.has('perca')||chosen.has('percb')||chosen.has('drumsa')||chosen.has('drumsb')){
    const comp=CADENCES[CAD], sync=comp.sync||0;
    hits.forEach((h)=>{
      const have=chosen.has('drumsa')?'drumsa':(chosen.has('drumsb')?'drumsb':(chosen.has('perca')?'perca':'percb'));
      if(h.on){ out.push({t:Math.max(0,Math.min(60,h.t + (Math.random()*2-1)*0.01)), midi:60, dur:0.09, vel:0.55, isBass:false, sec:have}); }
      else if(Math.random()<sync){ const alt=chosen.has('perca')?'perca':(chosen.has('percb')?'percb':(chosen.has('drumsa')?'drumsa':'drumsb'));
        out.push({t:Math.max(0,Math.min(60,h.t + hbeat*0.5)), midi:67, dur:0.08, vel:0.45, isBass:false, sec:alt}); }
    });
  }
  return out.sort((a,b)=>a.t-b.t);
}

/* Transport (unchanged) */
let idxTimer=null, t0=0, schArr=[], idx=0; const LOOKAHEAD=0.25;
async function resumeAudio(){ const ctx=getAudio(); if(ctx.state==='suspended'){ try{ await ctx.resume(); }catch(_){ } } return ctx; }
function sectionPreset(sec){
  const base=baseOf(sec);
  function gmPresetFor(p){
    if(p>=32&&p<=39) return {wave:'sine', lp:800, q:0.8, a:0.006, d:0.12, s:0.85, r:0.20};
    if(p<=7) return {wave:'triangle', lp:3200, q:0.7, a:0.003, d:0.12, s:0.0, r:0.2};
    if(p>=40&&p<=55) return {wave:'sine', lp:2200, q:0.6, a:0.008, d:0.16, s:0.75, r:0.22};
    if(p>=56&&p<=63) return {wave:'triangle', lp:2400, q:0.9, a:0.004, d:0.14, s:0.70, r:0.24};
    if(p>=64&&p<=71) return {wave:'triangle', lp:2000, q:0.7, a:0.008, d:0.14, s:0.65, r:0.22};
    if(p>=72&&p<=79) return {wave:'sine', lp:3000, q:0.5, a:0.006, d:0.12, s:0.55, r:0.20};
    if(p>=80&&p<=95) return {wave:'sawtooth', lp:2600, q:0.6, a:0.004, d:0.12, s:0.60, r:0.20};
    if(p>=96&&p<=119) return {wave:'triangle', lp:1800, q:0.7, a:0.006, d:0.12, s:0.65, r:0.18};
    if(p>=120) return {wave:'noise', lp:6000, q:0.5, a:0.001, d:0.06, s:0.0, r:0.12};
    return {wave:'sine', lp:2000, q:0.6, a:0.008, d:0.16, s:0.68, r:0.20};
  }
  const gm=gmPresetFor(GM_PROGRAM);
  let basePreset={wave:'sine',lp:2000,q:0.6,a:0.008,d:0.16,s:0.68,r:0.2};
  if(base==='piano') basePreset={wave:'triangle',lp:3200,q:0.7,a:0.002,d:0.12,s:0.0,r:0.20};
  if(base==='drums') basePreset={wave:'noise',lp:7000,q:0.6,a:0.001,d:0.08,s:0.0,r:0.12};
  if(base==='basses') basePreset={wave:'sine',lp:520,q:0.8,a:0.008,d:0.10,s:0.8,r:0.16};
  if(base==='cellos') basePreset={wave:'triangle',lp:1100,q:0.7,a:0.010,d:0.18,s:0.78,r:0.22};
  if(base==='violas') basePreset={wave:'triangle',lp:1600,q:0.7,a:0.010,d:0.18,s:0.74,r:0.20};
  if(base==='vln1'||base==='vln2') basePreset={wave:'sine',lp:2600,q:0.6,a:0.008,d:0.14,s:0.7,r:0.18};
  if(base==='harp') basePreset={wave:'sine',lp:2800,q:0.6,a:0.004,d:0.10,s:0.0,r:0.35};
  if(base==='flutes') basePreset={wave:'sine',lp:3000,q:0.5,a:0.006,d:0.10,s:0.55,r:0.18};
  if(base==='oboes') basePreset={wave:'triangle',lp:2200,q:0.7,a:0.009,d:0.16,s:0.6,r:0.2};
  if(base==='clarinets') basePreset={wave:'triangle',lp:2000,q:0.7,a:0.010,d:0.16,s:0.6,r:0.2};
  if(base==='bassoons') basePreset={wave:'sine',lp:1200,q:0.8,a:0.010,d:0.18,s:0.7,r:0.22};
  if(base==='trumpets') basePreset={wave:'triangle',lp:2400,q:0.9,a:0.004,d:0.12,s:0.65,r:0.22};
  if(base==='horns') basePreset={wave:'sine',lp:1800,q:0.9,a:0.008,d:0.14,s:0.7,r:0.24};
  if(base==='trombones') basePreset={wave:'sine',lp:1400,q:0.9,a:0.006,d:0.16,s:0.75,r:0.26};
  let p={...basePreset, wave:basePreset.wave==='noise'? 'noise':gm.wave, lp:gm.lp, q:gm.q, a:Math.max(0.0005,basePreset.a), d:basePreset.d, s:basePreset.s, r:basePreset.r};
  const v=({auto:{tone:1.00,attack:0},bright:{tone:1.12,attack:-0.002},warm:{tone:0.88,attack:+0.003},mellow:{tone:0.78,attack:+0.004},edgy:{tone:1.22,attack:-0.003}})[CHAIR_VARIANT[sec]];
  p={...p, lp:p.lp*v.tone, a:Math.max(0.0005, p.a + v.attack)};
  return p;
}
function playSection(sec, midi, when, dur, gain){
  if(MUTE[sec] || (SOLO.on && SOLO.id!==sec)) return;
  const ctx=getAudio(), p=sectionPreset(sec);
  const detCents=(CHAIR_DETUNE[sec]||0)+({auto:0,bright:+4,warm:-4,mellow:-6,edgy:+6}[CHAIR_VARIANT[sec]]||0);
  const freq=midiHz(midi)*Math.pow(2,detCents/1200);
  let src;
  if(p.wave==='noise'){
    const len=Math.max(1,Math.floor((dur+p.r)*ctx.sampleRate));
    const buf=ctx.createBuffer(1,len,ctx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.06)); }
    src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
  }else{
    src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(freq,when); src.start(when); src.stop(when+dur+p.r+0.05);
  }
  const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
  const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
  amp.gain.linearRampToValueAtTime(gain,when+p.a); amp.gain.linearRampToValueAtTime(gain*p.s,when+p.a+p.d);
  amp.gain.setValueAtTime(gain*p.s,when+dur); amp.gain.linearRampToValueAtTime(0.0003,when+dur+p.r);
  src.connect(biq); biq.connect(amp); amp.connect(AUDIO.bus[sec]);

  const dot=document.getElementById('dot-'+sec), chk=document.getElementById('chk-'+sec);
  if(dot){ dot.classList.remove('blink'); void dot.offsetWidth; dot.classList.add('blink'); }
  if(chk && !chk.classList.contains('checked')){ chk.classList.add('checked'); chk.textContent='✓'; }
}
function buildSchedule(){ const a=musicalize(A.events,'A'); const b=musicalize(B.events,'B'); return [...a,...b].sort((x,y)=>x.t-y.t); }
async function doPlay(){
  await resumeAudio();
  if(PICK_A.length===0) randomizeA(); if(PICK_B.length===0) randomizeB();
  if(!A.events.length && !B.events.length){ alert("Load a CSV into A and/or B, or analyze audio and export CSV."); return; }
  const sch=buildSchedule(); if(!sch.length){ alert("No notes in 0–60s."); return; }
  schArr=sch; idx=0; t0=AUDIO.ctx.currentTime+0.06;
  if(idxTimer) clearInterval(idxTimer); idxTimer=setInterval(tick,25);
  conductor.style.animationPlayState='running'; setStatus("Playing…"); light(dotExport,true);
}
function tick(){
  const now=AUDIO.ctx.currentTime, horizon=now+LOOKAHEAD;
  while(idx<schArr.length){ const e=schArr[idx]; const when=t0+e.t; if(when>horizon) break; playSection(e.sec,e.midi,when,e.dur,e.vel); idx++; }
  if(idx>=schArr.length){ clearInterval(idxTimer); idxTimer=null; setStatus("Finished."); conductor.style.animationPlayState='paused'; }
}
function stopAll(){ if(idxTimer){clearInterval(idxTimer); idxTimer=null;} setStatus("Stopped."); conductor.style.animationPlayState='paused'; }
playBtn.onclick=doPlay; stopBtn.onclick=stopAll;

/* Export WAV (unchanged) */
btnExportAudio.onclick=async()=>{
  if(PICK_A.length===0) randomizeA(); if(PICK_B.length===0) randomizeB();
  const sched=buildSchedule(); if(!sched.length){ alert("No notes to export."); return; } light(dotExport,true);
  const sampleRate=44100, duration=61; const ctx=new OfflineAudioContext(2, sampleRate*duration, sampleRate);
  function sectionPresetOff(sec){ return sectionPreset(sec); }
  function playOffline(sec, midi, when, dur, gain){
    const p=sectionPresetOff(sec); const det= (CHAIR_DETUNE[sec]||0)+({auto:0,bright:+4,warm:-4,mellow:-6,edgy:+6}[CHAIR_VARIANT[sec]]||0);
    const freq=440*Math.pow(2,(midi-69)/12)*Math.pow(2,det/1200); let src;
    if(p.wave==='noise'){ const len=Math.max(1,Math.floor((dur+p.r)*sampleRate)); const buf=ctx.createBuffer(1,len,sampleRate);
      const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(sampleRate*0.06)); }
      src=ctx.createBufferSource(); src.buffer=buf; src.start(when); src.stop(when+dur+p.r+0.05);
    } else { src=ctx.createOscillator(); src.type=p.wave; src.frequency.setValueAtTime(freq,when); src.start(when); src.stop(when+dur+p.r+0.05); }
    const biq=ctx.createBiquadFilter(); biq.type='lowpass'; biq.frequency.setValueAtTime(p.lp,when); biq.Q.setValueAtTime(p.q,when);
    const amp=ctx.createGain(); amp.gain.setValueAtTime(0,when);
    amp.gain.linearRampToValueAtTime(gain,when+p.a); amp.gain.linearRampToValueAtTime(gain*p.s,when+p.a+p.d);
    amp.gain.setValueAtTime(gain*p.s,when+dur); amp.gain.linearRampToValueAtTime(0.0003,when+dur+p.r);
    src.connect(biq); biq.connect(amp); amp.connect(ctx.destination);
  }
  sched.forEach(e=>playOffline(e.sec,e.midi,e.t+0.02,e.dur,e.vel));
  const rendered = await ctx.startRendering();
  const wavBlob = bufferToWav(rendered); const url=URL.createObjectURL(wavBlob);
  const a=document.createElement('a'); a.href=url; a.download='CST_Orchestra_60s.wav'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
};
function bufferToWav(buffer){
  const num=buffer.numberOfChannels, len=buffer.length*num*2+44, ab=new ArrayBuffer(len), view=new DataView(ab);
  let offset=0; const write=(s,pos)=>{for(let i=0;i<s.length;i++) view.setUint8(pos+i,s.charCodeAt(i));};
  write('RIFF',0); view.setUint32(4,len-8,true); write('WAVE',8); write('fmt ',12); view.setUint32(16,16,true);
  view.setUint16(20,1,true); view.setUint16(22,num,true); view.setUint32(24,buffer.sampleRate,true);
  view.setUint32(28,buffer.sampleRate*num*2,true); view.setUint16(32,num*2,true); view.setUint16(34,16,true); write('data',36);
  view.setUint32(40,len-44,true); offset=44;
  for(let i=0;i<buffer.length;i++){ for(let ch=0;ch<num;ch++){ let s=Math.max(-1,Math.min(1, buffer.getChannelData(ch)[i] )); view.setInt16(offset, s<0? s*0x8000:s*0x7FFF, true); offset+=2; } }
  return new Blob([ab], {type: 'audio/wav'});
}

/* Reset */
resetBtn.onclick=()=>{
  stopAll(); A={events:[]}; B={events:[]}; LAST_ANALYSIS={events:[],key:"C major",bpm:100};
  detKey.textContent='–'; detBPM.textContent='–'; csvA.value=""; csvB.value=""; audioFile.value="";
  composerEl.value='cinematic'; keyRootEl.value='C'; keyModeEl.value='major';
  bpmEl.value='100'; quantEl.value='0.125'; swingEl.value='0.10'; humanEl.value='6';
  masterVolEl.value='0.85'; reverbMixEl.value='0.18'; spreadEl.value='0.55'; gmProgEl.value='48'; GM_PROGRAM=48;
  if(AUDIO.ctx){ AUDIO.master.gain.value=parseFloat(masterVolEl.value); AUDIO.wet.gain.value=parseFloat(reverbMixEl.value); try{AUDIO.ctx.close();}catch{} AUDIO.ctx=null; getAudio(); }
  CAD='even'; PAC='andante'; cadName.textContent='Even'; paceName.textContent='Andante';
  PICK_A=[]; PICK_B=[]; renderSide('A'); renderSide('B'); markStage();
  FAMILY_OPEN={strings:0,winds:8,brass:16,perc:24}; summarizeOpenings();
  for(const id of SECTIONS){ const chk=CHK[id], dot=DOT[id]; if(chk){ chk.classList.remove('checked'); chk.textContent=''; } if(dot){ dot.classList.remove('blink'); } MUTE[id]=false; }
  for(const id of CHAIRS){ CHAIR_VARIANT[id]=id.endsWith('a')?'bright':'warm'; CHAIR_DETUNE[id]=id.endsWith('a')?+3:-3; }
  buildChairPanel(); countAEl.value='16'; countBEl.value='16'; syncTargets(); setStatus("Ready."); updateConLabel();
};
</script>
<script>
/* ========= ROBUST ANALYZER — 60s, non-freezing, enriched ========= */
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlateKey(hist){ const n=Math.hypot(...hist)||1, hh=hist.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; }
  return best.name;
}
/* Simple AMDF pitch estimate */
function amdfPitch(frame,sr){
  const N=frame.length; let mean=0; for(let i=0;i<N;i++) mean+=frame[i]; mean/=N;
  for(let i=0;i<N;i++) frame[i]=frame[i]-mean;
  const minF=60, maxF=1000, minLag=Math.floor(sr/maxF), maxLag=Math.min(N-2, Math.floor(sr/minF));
  let bestLag=0, bestVal=Infinity;
  for(let lag=minLag; lag<=maxLag; lag++){
    let sum=0; for(let i=0;i<N-lag;i++){ const d=frame[i]-frame[i+lag]; sum+=Math.abs(d); }
    if(sum<bestVal){ bestVal=sum; bestLag=lag; }
  }
  return bestLag? sr/bestLag : 0;
}
function zcPitch(frame,sr){ let c=0; for(let i=1;i<frame.length;i++){const a=frame[i-1],b=frame[i]; if((a<=0&&b>0)||(a>=0&&b<0))c++;} const f=(c/2)*(sr/frame.length); return (f>40&&f<2000)?f:0; }

/* Spectral flux onset */
function spectralFlux(prev,cur){
  const n=cur.length; let s=0;
  for(let i=0;i<n;i++){ const d=cur[i]- (prev?prev[i]:0); if(d>0) s+=d; }
  return s;
}
function hamming(N){ const w=new Float32Array(N); for(let i=0;i<N;i++) w[i]=0.54-0.46*Math.cos(2*Math.PI*i/(N-1)); return w; }
function fftMag(frame){ // naive DFT magnitude (N small = 1024)
  const N=frame.length; const out=new Float32Array(N/2|0);
  for(let k=0;k<out.length;k++){
    let re=0, im=0; const phi=-2*Math.PI*k/N;
    for(let n=0;n<N;n++){ const x=frame[n]; re+=x*Math.cos(phi*n); im+=x*Math.sin(phi*n); }
    out[k]=Math.hypot(re,im);
  }
  return out;
}
function estimateBPM(onsets){
  if(onsets.length<4) return 100;
  const IOI=[]; for(let i=1;i<onsets.length;i++){ const dt=onsets[i]-onsets[i-1]; if(dt>0.18 && dt<2.2) IOI.push(dt); }
  if(!IOI.length) return 100;
  const H=new Map();
  for(const dt of IOI){ let b=60/dt; while(b<60) b*=2; while(b>180) b/=2; const key=Math.round(b); H.set(key, (H.get(key)||0)+1); }
  let best=100, sc=-1; for(const [k,v] of H){ if(v>sc){ sc=v; best=k; } }
  return best;
}
function pcsIndex(midi){ return ((midi%12)+12)%12; }

/* Yield helper to keep UI responsive */
function uiYield(){ return new Promise(r=>setTimeout(r,0)); }

async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  try{
    setStatus("Decoding audio…");
    const arr=await file.arrayBuffer();
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const buf=await ctx.decodeAudioData(arr.slice(0));
    const sr=buf.sampleRate, ch=buf.numberOfChannels, maxS=Math.min(buf.length, sr*60);
    const mono=new Float32Array(maxS);
    for(let c=0;c<ch;c++){ const d=buf.getChannelData(c); for(let i=0;i<maxS;i++) mono[i]+=d[i]/ch; }

    setStatus("Analyzing (60s)…");
    const frame=1024, hop=512, win=hamming(frame);
    const events=[]; const pcHist=new Float32Array(12);
    let prevSpec=null; const onsets=[];

    // main loop with periodic yields
    for(let st=0, iter=0; st+frame<=maxS; st+=hop, iter++){
      if((iter&63)===0) await uiYield(); // yield every ~64 frames
      const fr=mono.subarray(st,st+frame);
      let energy=0; for(let i=0;i<fr.length;i++){ fr[i]*=win[i]; energy+=fr[i]*fr[i]; }

      // Pitch
      let f=amdfPitch(fr.slice(),sr); if(!f) f=zcPitch(fr,sr);
      let midi=0, isBass=false;
      if(f){ midi=clamp(Math.round(69+12*Math.log2(f/440)),24,96); isBass = f<180; pcHist[pcsIndex(midi)]++; }

      // Spectral flux onset
      const spec=fftMag(fr); const flux=spectralFlux(prevSpec,spec); prevSpec=spec;
      const t=st/sr; if(flux>15) onsets.push(t);

      // Velocity from energy
      const vel=Math.max(0.25, Math.min(1.0, Math.sqrt(energy)*0.75));

      events.push({t, midi, vel, is_bass:isBass});
    }

    const keyName=correlateKey(Array.from(pcHist));
    const [root,modeWord]=keyName.split(' '); const pcs=pcsFor(root, (modeWord||'major').toLowerCase());
    // snap & thin
    for(const e of events){ if(e.midi) e.midi=snapToScale(e.midi,pcs); }
    // BPM from onsets
    const bpm=estimateBPM(onsets);
    detKey.textContent=keyName; detBPM.textContent=String(bpm);
    bpmEl.value=String(bpm); keyRootEl.value=root; keyModeEl.value=(modeWord||'major').toLowerCase();

    // Quantize to grid + assign bar/beat/dur
    const beat=60/Math.max(40,Math.min(220,bpm));
    const qDiv=parseFloat(quantEl.value||"0.125");
    const grid=beat*4*qDiv; const beatsPerBar=(keyModeEl.value==='minor'?4:4); // keep 4/4 default
    const enriched=[];
    let lastAtPitch=new Map();
    for(const e of events){
      if(!e.midi) continue;
      let q=Math.round(e.t/grid)*grid; q=Math.max(0,Math.min(60,q));
      const startBeat=q/beat; const bar=Math.floor(startBeat/beatsPerBar)+1; const beatInBar=(startBeat%beatsPerBar)+1;
      const last=lastAtPitch.get(e.midi)||-999, minSep=grid*0.75;
      if(q-last<minSep) continue;
      lastAtPitch.set(e.midi,q);
      const dur=(e.is_bass? Math.max(0.25,grid*2): Math.max(0.18,grid*1));
      enriched.push({t:q, midi:e.midi, vel:e.vel, dur, is_bass:e.is_bass, bar, beat:beatInBar});
    }

    LAST_ANALYSIS={events:enriched,key:keyName,bpm};
    setStatus(`Analysis complete → ${enriched.length} events. Export CSV.`); light(dotAnalyze,true); checkExportReady();
  }catch(err){
    console.error(err); alert("Analyzer error: "+err.message); setStatus("Analyzer failed.");
  }
}

/* Export enriched CSV */
btnExport.onclick=()=>{
  if(!(LAST_ANALYSIS.events?.length)){ alert("Analyze audio first."); return; }
  const text=toCSV_enriched(LAST_ANALYSIS.events, LAST_ANALYSIS.key, LAST_ANALYSIS.bpm);
  downloadCSV("notes_60s_enriched.csv", text);
};

/* Wire file & analyze */
btnLoadAudio.onclick=()=>audioFile.click();
btnAnalyze.onclick=()=>analyzeAudio(audioFile.files?.[0]||null);
</script>
</main>
</body>
</html>
