<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Audio→CSV • A:10–16 + B:6–16 (sum 32, non-overlap) • 60s Orchestrator • 32 Chairs</title>
<style>
  :root{
    --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758; --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --blink:#6ee7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  main{max-width:1500px;margin:0 auto;padding:16px;display:grid;grid-template-columns:520px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"],button,select,input[type="range"],input[type="number"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
  }
  button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
  button:hover{filter:brightness(1.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
  .stat b{color:var(--ok)}
  #status{font-size:12px;color:#9ad1ff;margin-top:8px}
  .danger{background:#3b1220;border-color:#6b1f35}
  small.hint{display:block;color:#a8b7e3;margin-top:6px}

  /* Stage */
  .stage{
    position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;
    padding-top:300px;
    background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)
  }
  .stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}
  /* 32 chairs: 8x4 grid */
  .grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(4,1fr);gap:10px;min-height:620px}
  .cell{display:flex;align-items:center;justify-content:center;min-height:115px}
  .section{
    background:linear-gradient(180deg,#0e1b43,#0a1232); border:1px solid #20326d; border-radius:12px;
    width:100%; height:100%; padding:10px; display:flex; flex-direction:column; gap:6px; justify-content:space-between;
  }
  .title{font-weight:800;color:#e4eeff;font-size:12px}
  .meta{font-size:11px;color:#9bb9ff}
  .lights{display:flex;align-items:center;gap:6px}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
  .blink{animation:blink .45s ease-out}
  @keyframes blink{0%{background:#0c1430;border-color:#2a3b7a}30%{background:var(--blink);border-color:#bfefff}100%{background:#0c1430;border-color:#2a3b7a}}
  .check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;display:flex;align-items:center;justify-content:center;font-weight:900}
  .checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
  .mixRow{display:flex;gap:6px;align-items:center}
  .btnSmall{padding:6px 8px;font-size:11px}

  /* Conductor + guide */
  .conductor{
    width:92px;height:92px;border-radius:50%; background:#0d1b44;border:2px solid #284a9b;
    display:flex;align-items:center;justify-content:center; font-weight:800; color:#cfe1ff;
    box-shadow:0 0 0 0 rgba(59,130,246,.45); animation:conPulse 1.4s ease-in-out infinite; animation-play-state:paused;
  }
  @keyframes conPulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
  .guide{
    position:absolute; left:50%; transform:translateX(-50%);
    top:118px; width:96%; max-width:1000px;
    background:#0c1536; border:1px solid #274094; border-radius:12px; padding:10px 12px; color:#cfe1ff; font-size:12px;
  }
  .guide b{color:#9fe8ff}
  .guide ol{margin:6px 0 0 16px; padding-left:10px}
  .guide li{margin:2px 0}

  /* status dots */
  .statusDot{ width:12px;height:12px;border-radius:3px;background:#ffffff;border:2px solid #dddddd;display:inline-block; }
  .statusOn{background:var(--ok);border-color:#b7f5cd;}

  /* Conductor square panel */
  .conductorPanel{margin-top:12px; display:flex; justify-content:center;}
  .condCard{ width:260px; height:260px; border:1px solid var(--grid); border-radius:14px;
    background:#0d1b3d; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; }
  .conLabel{font-size:12px;color:#cfe1ff;opacity:0.9}

  /* A/B highlights */
  .section.isA { outline: 2px solid #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.18) inset; }
  .section.isB { outline: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18) inset; }

  .badge { display:inline-block; margin-left:6px; padding:2px 6px; border-radius:8px;
    font-size:10px; font-weight:700; letter-spacing:.3px; vertical-align:middle; }
  .badgeA { background:#0b2a1e; border:1px solid #10b981; color:#b9f6da; }
  .badgeB { background:#0b1f3d; border:1px solid #3b82f6; color:#cfe1ff; }

  /* Per-Chair variants panel */
  .chairPanel{max-height:260px; overflow:auto; border:1px solid var(--grid); border-radius:10px; padding:8px; background:#0f1a3b}
  .chairRow{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; align-items:center; margin-bottom:6px; font-size:12px}
  .chairHead{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; font-size:11px; color:#9fb2e4; margin-bottom:6px}

  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,"Courier New",monospace;font-size:11px;color:#bfe3ff}
</style>
</head>
<body>
<header>
  <h1>CST — Audio→CSV • A:10–16 & B:6–16 (Total 32, Non-overlap) • 60s • 32 Chairs</h1>
  <span style="font-size:12px;color:#9ad1ff">You can choose A and B counts; total is locked to 32.</span>
</header>
<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <div class="mixRow">
        <button id="btnAnalyze">2) Analyze 60s</button>
        <span id="dotAnalyze" class="statusDot" title="Analysis status"></span>
      </div>
      <button id="btnExport">3) Export CSV</button>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV headers: <b>t,m,b</b> (simple) or <b>t,midi,vel,dur,is_bass,bar,beat,bpm,key</b> (enriched).</small>

    <div class="hr"></div>

    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadA">Load CSV → A</button>
          <span id="dotA" class="statusDot" title="A loaded"></span>
        </div>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadB">Load CSV → B</button>
          <span id="dotB" class="statusDot" title="B loaded"></span>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Conductor / Musicalize (unchanged) -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="cinematic" selected>Cinematic — lush</option>
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="bach">Bach — contrapuntal</option>
          <option value="haydn">Haydn — balanced</option>
          <option value="tchaikovsky">Tchaikovsky — lyrical</option>
          <option value="ravel">Ravel — color</option>
          <option value="mahler">Mahler — expansive</option>
          <option value="shostakovich">Shostakovich — edgy</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="price">Florence Price — warm</option>
          <option value="lili">Lili Boulanger — luminous</option>
          <option value="clara">Clara Schumann — lyrical</option>
          <option value="fanny">Fanny Mendelssohn — elegant</option>
          <option value="amy">Amy Beach — romantic</option>
          <option value="saariaho">Kaija Saariaho — spectral</option>
          <option value="tower">Joan Tower — kinetic</option>
          <option value="montgomery">Jessie Montgomery — vibrant</option>
          <option value="williams">John Williams — cinematic</option>
          <option value="zimmer">Hans Zimmer — hybrid</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode"><option value="major" selected>Major</option><option value="minor">Minor</option></select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Humanize (ms)</label><input id="human" type="number" min="0" max="40" step="1" value="6"/></div>
      <div><label>Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Reverb Mix</label><input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
      <div><label>Stereo Spread</label><input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>GM Program (0–127)</label>
        <input id="gmProg" type="number" min="0" max="127" step="1" value="48" />
        <small class="hint">Global timbre (still allows per-chair micro-variants below).</small>
      </div>
      <div>
        <label>Export Audio</label>
        <div class="mixRow">
          <button id="btnExportAudio">Export WAV (60s)</button>
          <span id="dotExport" class="statusDot" title="Export ready"></span>
        </div>
        <small class="hint">White square lights when a 60s score is ready to export.</small>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Cadence & Pace (unchanged) -->
    <label style="font-weight:700">Cadence & Pace</label>
    <div class="row3" id="cadenceRow">
      <button class="cadBtn" data-cad="even">Even</button>
      <button class="cadBtn" data-cad="march">March (2/4)</button>
      <button class="cadBtn" data-cad="waltz">Waltz (3/4)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="latin">Latin (2–3)</button>
      <button class="cadBtn" data-cad="sync">Syncopated</button>
      <button class="cadBtn" data-cad="swing">Swing (Shuffle)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="jig68">Jig (6/8)</button>
      <button class="cadBtn" data-cad="odd54">Odd (5/4)</button>
      <div class="stat"><span>Active cadence</span><b id="cadName">Even</b></div>
    </div>
    <div class="row3" style="margin-top:8px">
      <button class="paceBtn" data-pace="adagio">Adagio</button>
      <button class="paceBtn" data-pace="andante">Andante</button>
      <button class="paceBtn" data-pace="moderato">Moderato</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="paceBtn" data-pace="allegro">Allegro</button>
      <button class="paceBtn" data-pace="vivace">Vivace</button>
      <button class="paceBtn" data-pace="presto">Presto</button>
    </div>
    <div class="stat" style="margin-top:6px"><span>Active pace</span><b id="paceName">Andante</b></div>

    <div class="hr"></div>

    <!-- Family Opening -->
    <label style="font-weight:700">Family Opening (entry timing bias)</label>
    <div class="row">
      <button id="btnOpenRandom" title="Generate a musical opening order">Randomize Family Opening</button>
      <button id="btnOpenReset">Reset Default</button>
    </div>
    <div class="stat" style="margin-top:6px">
      <span>Open @ seconds (Strings, Winds, Brass, Perc)</span>
      <b class="mono" id="openSummary">0, 8, 16, 24</b>
    </div>

    <div class="hr"></div>

    <!-- Orchestration Picks -->
    <label style="font-weight:700">Orchestration Picks (A:10–16, B:6–16 • non-overlapping • total 32)</label>
    <div class="row" style="margin-bottom:6px">
      <div>
        <label>Target A (10–16)</label>
        <div class="mixRow">
          <input id="countA" type="number" min="10" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomA">Randomize A (16)</button>
        </div>
      </div>
      <div>
        <label>Target B (6–16)</label>
        <div class="mixRow">
          <input id="countB" type="number" min="6" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomB">Randomize B (16)</button>
        </div>
      </div>
    </div>
    <small class="hint">Counts auto-adjust to keep A + B = 32. Locks are respected.</small>

    <div class="twoCols" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>A Selected</span><b id="selCountA">0</b></div>
        </div>
        <div id="listA" class="pickList"></div>
      </div>
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>B Selected</span><b id="selCountB">0</b></div>
        </div>
        <div id="listB" class="pickList"></div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Per-Chair Variants (unchanged) -->
    <label style="font-weight:700">Per-Chair Variants (tiny differences per A/B chair)</label>
    <div class="chairHead"><div>Chair</div><div>Variant</div><div>Detune</div></div>
    <div id="chairPanel" class="chairPanel"></div>
    <small class="hint">Variant tweaks tone/attack; detune is ± cents. Defaults: A (brighter) / B (warmer).</small>

    <div class="hr"></div>
    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>
    <div id="status">Ready.</div>
  </section>

  <!-- RIGHT: STAGE -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Even spacing • Front strings, winds middle, brass back, perc rear • 32 chairs</b></div>
    </div>

    <div class="guide">
      <b>How the 1-minute AI Symphony Orchestra works (HTML + Web Audio)</b>
      <ol>
        <li><b>Load Audio</b> and <b>Analyze 60s</b> → auto-detected notes.</li>
        <li><b>Export CSV</b>: Simple (<code>t,m,b</code>) or Enriched (<code>t,midi,vel,dur,is_bass,bar,beat,bpm,key</code>).</li>
        <li><b>Load CSV</b> into <b>A</b> and/or <b>B</b> (both formats accepted).</li>
        <li>Pick chairs and set Conductor/Key/Tempo/Quantize/Swing/Humanize/Reverb/Spread + Cadence & Pace + <b>Per-Chair Variants</b>.</li>
        <li>Press <b>Play</b>. Lights blink on chairs that are sounding.</li>
      </ol>
    </div>

    <!-- 32 Chairs (8 x 4). Each base section has A & B chairs -->
    <!-- (unchanged chair grid; keeping your exact layout/ids) -->
    <div class="grid">
      <!-- Row 1: Brass/Perc back -->
      <div class="cell"><div class="section" data-sec="trumpetsa"><div class="title">Trumpets A</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsa"></div><div class="check" id="chk-trumpetsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsa">Mute</button><button class="btnSmall" data-solo="trumpetsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trumpetsb"><div class="title">Trumpets B</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsb"></div><div class="check" id="chk-trumpetsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsb">Mute</button><button class="btnSmall" data-solo="trumpetsb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="hornsa"><div class="title">French Horns A</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsa"></div><div class="check" id="chk-hornsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsa">Mute</button><button class="btnSmall" data-solo="hornsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="hornsb"><div class="title">French Horns B</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsb"></div><div class="check" id="chk-hornsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsb">Mute</button><button class="btnSmall" data-solo="hornsb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="perca"><div class="title">Percussion A</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-perca"></div><div class="check" id="chk-perca"></div></div><div class="mixRow"><button class="btnSmall" data-mute="perca">Mute</button><button class="btnSmall" data-solo="perca">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="percb"><div class="title">Percussion B</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-percb"></div><div class="check" id="chk-percb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="percb">Mute</button><button class="btnSmall" data-solo="percb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="trombonesa"><div class="title">Trombones/Tuba A</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesa"></div><div class="check" id="chk-trombonesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesa">Mute</button><button class="btnSmall" data-solo="trombonesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombonesb"><div class="title">Trombones/Tuba B</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesb"></div><div class="check" id="chk-trombonesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesb">Mute</button><button class="btnSmall" data-solo="trombonesb">Solo</button></div></div></div>

      <!-- Row 2: Winds -->
      <div class="cell"><div class="section" data-sec="flutesa"><div class="title">Flutes/Picc. A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-flutesa"></div><div class="check" id="chk-flutesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutesa">Mute</button><button class="btnSmall" data-solo="flutesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="flutesb"><div class="title">Flutes/Picc. B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-flutesb"></div><div class="check" id="chk-flutesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutesb">Mute</button><button class="btnSmall" data-solo="flutesb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="oboesa"><div class="title">Oboes A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-oboesa"></div><div class="check" id="chk-oboesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboesa">Mute</button><button class="btnSmall" data-solo="oboesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="oboesb"><div class="title">Oboes B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-oboesb"></div><div class="check" id="chk-oboesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboesb">Mute</button><button class="btnSmall" data-solo="oboesb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="clarinetsa"><div class="title">Clarinets A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-clarinetsa"></div><div class="check" id="chk-clarinetsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinetsa">Mute</button><button class="btnSmall" data-solo="clarinetsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="clarinetsb"><div class="title">Clarinets B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-clarinetsb"></div><div class="check" id="chk-clarinetsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinetsb">Mute</button><button class="btnSmall" data-solo="clarinetsb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="bassoonsa"><div class="title">Bassoons A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-bassoonsa"></div><div class="check" id="chk-bassoonsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoonsa">Mute</button><button class="btnSmall" data-solo="bassoonsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassoonsb"><div class="title">Bassoons B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-bassoonsb"></div><div class="check" id="chk-bassoonsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoonsb">Mute</button><button class="btnSmall" data-solo="bassoonsb">Solo</button></div></div></div>

      <!-- Row 3: Keys / low strings / rhythm -->
      <div class="cell"><div class="section" data-sec="pianoa"><div class="title">Piano A</div><div class="meta">Keys</div><div class="lights"><div class="dot" id="dot-pianoa"></div><div class="check" id="chk-pianoa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="pianoa">Mute</button><button class="btnSmall" data-solo="pianoa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="pianob"><div class="title">Piano B</div><div class="meta">Keys</div><div class="lights"><div class="dot" id="dot-pianob"></div><div class="check" id="chk-pianob"></div></div><div class="mixRow"><button class="btnSmall" data-mute="pianob">Mute</button><button class="btnSmall" data-solo="pianob">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="bassesa"><div class="title">Double Basses A</div><div class="meta">Back Strings</div><div class="lights"><div class="dot" id="dot-bassesa"></div><div class="check" id="chk-bassesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassesa">Mute</button><button class="btnSmall" data-solo="bassesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassesb"><div class="title">Double Basses B</div><div class="meta">Back Strings</div><div class="lights"><div class="dot" id="dot-bassesb"></div><div class="check" id="chk-bassesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassesb">Mute</button><button class="btnSmall" data-solo="bassesb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="drumsa"><div class="title">Drums A</div><div class="meta">Rhythm</div><div class="lights"><div class="dot" id="dot-drumsa"></div><div class="check" id="chk-drumsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="drumsa">Mute</button><button class="btnSmall" data-solo="drumsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="drumsb"><div class="title">Drums B</div><div class="meta">Rhythm</div><div class="lights"><div class="dot" id="dot-drumsb"></div><div class="check" id="chk-drumsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="drumsb">Mute</button><button class="btnSmall" data-solo="drumsb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="harpa"><div class="title">Harp/Keys A</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harpa"></div><div class="check" id="chk-harpa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harpa">Mute</button><button class="btnSmall" data-solo="harpa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="harpb"><div class="title">Harp/Keys B</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harpb"></div><div class="check" id="chk-harpb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harpb">Mute</button><button class="btnSmall" data-solo="harpb">Solo</button></div></div></div>

      <!-- Row 4: Front strings -->
      <div class="cell"><div class="section" data-sec="vln1a"><div class="title">1st Violins A</div><div class="meta">Far L</div><div class="lights"><div class="dot" id="dot-vln1a"></div><div class="check" id="chk-vln1a"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1a">Mute</button><button class="btnSmall" data-solo="vln1a">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln1b"><div class="title">1st Violins B</div><div class="meta">Far L</div><div class="lights"><div class="dot" id="dot-vln1b"></div><div class="check" id="chk-vln1b"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1b">Mute</button><button class="btnSmall" data-solo="vln1b">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="vln2a"><div class="title">2nd Violins A</div><div class="meta">L-Center</div><div class="lights"><div class="dot" id="dot-vln2a"></div><div class="check" id="chk-vln2a"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2a">Mute</button><button class="btnSmall" data-solo="vln2a">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln2b"><div class="title">2nd Violins B</div><div class="meta">L-Center</div><div class="lights"><div class="dot" id="dot-vln2b"></div><div class="check" id="chk-vln2b"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2b">Mute</button><button class="btnSmall" data-solo="vln2b">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="violasa"><div class="title">Violas A</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violasa"></div><div class="check" id="chk-violasa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violasa">Mute</button><button class="btnSmall" data-solo="violasa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="violasb"><div class="title">Violas B</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violasb"></div><div class="check" id="chk-violasb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violasb">Mute</button><button class="btnSmall" data-solo="violasb">Solo</button></div></div></div>

      <div class="cell"><div class="section" data-sec="cellosa"><div class="title">Cellos A</div><div class="meta">R-Center</div><div class="lights"><div class="dot" id="dot-cellosa"></div><div class="check" id="chk-cellosa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellosa">Mute</button><button class="btnSmall" data-solo="cellosa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="cellosb"><div class="title">Cellos B</div><div class="meta">R-Center</div><div class="lights"><div class="dot" id="dot-cellosb"></div><div class="check" id="chk-cellosb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellosb">Mute</button><button class="btnSmall" data-solo="cellosb">Solo</button></div></div></div>
    </div>

    <!-- Conductor panel -->
    <div class="conductorPanel">
      <div class="condCard">
        <div class="conductor" id="conductor">Conductor</div>
        <div class="conLabel" id="conLabel">Conductor / Musicalize: Cinematic — lush</div>
      </div>
    </div>
  </section>

<script>
/* ===== Helpers & scales ===== */
const NOTE=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const MAJOR=[0,2,4,5,7,9,11], MINOR=[0,2,3,5,7,8,10];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const midiHz=m=>440*Math.pow(2,(m-69)/12);
const median=a=>{const s=[...a].sort((x,y)=>x-y),n=s.length;return n?(n%2?s[(n-1)/2]:(s[n/2-1]+s[n/2])/2):0;}
function pcsFor(root,mode){const r=NOTE.indexOf(root);return (mode==='minor'?MINOR:MAJOR).map(pc=>(pc+r+120)%12);}
function snapToScale(m,pcs){ if(!m) return 0; const pc=((m%12)+12)%12; if(pcs.includes(pc)) return m; for(const d of [1,-1,2,-2]){const c=((pc+d)+12)%12;if(pcs.includes(c)) return m+d;} return m; }
const $=id=>document.getElementById(id);

/* ===== UI refs ===== */
const btnLoadAudio=$('btnLoadAudio'), btnAnalyze=$('btnAnalyze'), btnExport=$('btnExport'), audioFile=$('audioFile');
const detKey=$('detKey'), detBPM=$('detBPM'), statusEl=$('status');
const csvA=$('csvA'), csvB=$('csvB'), btnLoadA=$('btnLoadA'), btnLoadB=$('btnLoadB');
const composerEl=$('composer'), keyRootEl=$('keyRoot'), keyModeEl=$('keyMode'), bpmEl=$('bpm'), quantEl=$('quant'), swingEl=$('swing'), humanEl=$('human');
const masterVolEl=$('masterVol'), reverbMixEl=$('reverbMix'), spreadEl=$('spread');
const playBtn=$('playBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn'), conductor=$('conductor');
const conLabel=$('conLabel');
const cadName=$('cadName'), paceName=$('paceName');
const btnRandomA=$('btnRandomA'), btnRandomB=$('btnRandomB'), listA=$('listA'), listB=$('listB'), selCountA=$('selCountA'), selCountB=$('selCountB');
const gmProgEl=$('gmProg'), btnExportAudio=$('btnExportAudio');
const chairPanel=$('chairPanel');
const countAEl=$('countA'), countBEl=$('countB');

/* Family opening */
const btnOpenRandom=$('btnOpenRandom'), btnOpenReset=$('btnOpenReset'), openSummary=$('openSummary');

/* Status dots */
const dotA=$('dotA'), dotB=$('dotB'), dotAnalyze=$('dotAnalyze'), dotExport=$('dotExport');
function light(el,on){ if(!el) return; if(on){ el.classList.add('statusOn'); } else { el.classList.remove('statusOn'); } }
function setStatus(s){ statusEl.textContent=s; }
function updateConLabel(){ const txt=composerEl.options[composerEl.selectedIndex].textContent; conLabel.textContent='Conductor / Musicalize: ' + txt; }

/* ===== 32-chair definitions (unchanged) ===== */
const BASE=['vln1','vln2','violas','cellos','basses','harp','piano','flutes','oboes','clarinets','bassoons','trumpets','horns','trombones','perc','drums'];
const CHAIRS = BASE.flatMap(b=>[b+'a', b+'b']); // 32 ids
const LABEL={ /* ...same labels as your current file... */ 
  vln1a:'1st Violins A', vln1b:'1st Violins B',
  vln2a:'2nd Violins A', vln2b:'2nd Violins B',
  violasa:'Violas A',   violasb:'Violas B',
  cellosa:'Cellos A',   cellosb:'Cellos B',
  bassesa:'Double Basses A', bassesb:'Double Basses B',
  harpa:'Harp/Keys A',  harpb:'Harp/Keys B',
  pianoa:'Piano A',     pianob:'Piano B',
  flutesa:'Flutes/Picc. A', flutesb:'Flutes/Picc. B',
  oboesa:'Oboes A', oboesb:'Oboes B',
  clarinetsa:'Clarinets A', clarinetsb:'Clarinets B',
  bassoonsa:'Bassoons A', bassoonsb:'Bassoons B',
  trumpetsa:'Trumpets A', trumpetsb:'Trumpets B',
  hornsa:'French Horns A', hornsb:'French Horns B',
  trombonesa:'Trombones/Tuba A', trombonesb:'Trombones/Tuba B',
  perca:'Percussion A', percb:'Percussion B',
  drumsa:'Drums A', drumsb:'Drums B'
};
function baseOf(id){ return id.slice(0,-1).replace(/(sa|sb)$/,'s'); }
function familyOfSection(sec){
  const b=baseOf(sec);
  if (['vln1','vln2','violas','cellos','basses','harp','piano'].includes(b)) return 'strings';
  if (['flutes','oboes','clarinets','bassoons'].includes(b)) return 'winds';
  if (['horns','trumpets','trombones'].includes(b)) return 'brass';
  if (['perc','drums'].includes(b)) return 'perc';
  return 'strings';
}

/* Family buckets, stage wiring, A/B pick logic, presets, buses, audio chain … */
/* (keep your existing code here exactly as you have it — unchanged) */
/* ===== Existing simple CSV helpers (kept) ===== */
function toCSV_simple(events){
  const rows=["t,m,b"];
  for(const e of events){ rows.push(`${e.t.toFixed(3)},${e.m|0},${e.b|0}`); }
  return rows.join("\n");
}
function downloadCSV(name,text){
  const blob=new Blob([text],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
}

/* ===== Key profiles (your originals) ===== */
const KS_MAJ=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88];
const KS_MIN=[6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17];
function correlate(h){ const n=Math.hypot(...h)||1, hh=h.map(x=>x/n); let best={name:"C major",score:-1};
  for(let r=0;r<12;r++){ const maj=KS_MAJ.reduce((s,v,i)=>s+v*hh[(i+r)%12],0); const min=KS_MIN.reduce((s,v,i)=>s+v*hh[(i+r)%12],0);
    if(maj>best.score) best={name:`${NOTE[r]} major`,score:maj}; if(min>best.score) best={name:`${NOTE[r]} minor`,score:min}; } return best.name; }

/* ===== Universal CSV parser (simple OR enriched) ===== */
function parseCSVFlexible(text){
  const lines=text.replace(/\r/g,'').trim().split('\n');
  if(!lines.length) return {mode:'none'};

  const hdr=lines[0].split(',').map(s=>s.trim().toLowerCase());
  const idx=(name)=>hdr.indexOf(name);

  // Enriched?
  if(idx('midi')>=0 && idx('vel')>=0 && idx('dur')>=0){
    const ti=idx('t'), mi=idx('midi'), vi=idx('vel'), di=idx('dur'), bi=idx('is_bass');
    const bpmI=idx('bpm'), keyI=idx('key');
    const rows=[];
    for(let i=1;i<lines.length;i++){
      if(!lines[i]) continue;
      const r=lines[i].split(',');
      const t=parseFloat(r[ti]||"0");
      const midi=parseInt(r[mi]||"0",10);
      const vel=Math.max(0.1,Math.min(1,(parseInt(r[vi]||"90",10)/127)));
      const dur=parseFloat(r[di]||"0.2");
      const isBass=(parseInt(r[bi]||"0",10)===1);
      if(Number.isFinite(t) && t>=0 && t<=60 && midi>0){
        rows.push({t, midi, vel, dur, isBass});
      }
    }
    const bpm = bpmI>=0 ? parseInt(lines[1]?.split(',')[bpmI]||"100",10) : 100;
    const key = keyI>=0 ? (lines[1]?.split(',')[keyI]||"C major") : "C major";
    return {mode:'enriched', notes:rows.sort((a,b)=>a.t-b.t), bpm, key};
  }

  // Simple t,m,b
  if(hdr.includes('t') && hdr.includes('m') && hdr.includes('b')){
    const ti=idx('t'), mi=idx('m'), bi=idx('b');
    const events=[];
    for(let i=1;i<lines.length;i++){
      if(!lines[i]) continue;
      const r=lines[i].split(',');
      const t=parseFloat(r[ti]||"0"), m=parseInt(r[mi]||"0",10), b=parseInt(r[bi]||"0",10);
      if(Number.isFinite(t)&&t>=0&&t<=60) events.push({t,m,b});
    }
    return {mode:'simple', events:events.sort((a,b)=>a.t-b.t)};
  }

  throw new Error("CSV header not recognized. Expected either 't,m,b' or 't,midi,vel,dur,is_bass,bar,beat,bpm,key'.");
}

/* ===== New Enriched exporter ===== */
function toCSV_enriched(leadNotes, bassNotes, bpm, keyName){
  const rows=["t,midi,vel,dur,is_bass,bar,beat,bpm,key"];
  const beat = 60/Math.max(40, Math.min(220, bpm||100));
  const beatsPerBar = 4;
  const barBeat = (t)=>{
    const beatIdx = Math.round(t/beat);
    const bar = Math.floor(beatIdx / beatsPerBar) + 1;
    const beatNum = (beatIdx % beatsPerBar) + 1;
    return {bar, beat:beatNum};
  };
  const emit=(n,isBass)=>{
    const {bar,beat} = barBeat(n.t);
    rows.push([
      n.t.toFixed(3),
      n.midi|0,
      Math.round(Math.max(0.1,Math.min(1,n.vel))*127),
      n.dur.toFixed(3),
      isBass?1:0,
      bar, beat,
      bpm||100,
      keyName||'C major'
    ].join(","));
  };
  leadNotes.forEach(n=>emit(n,false));
  bassNotes.forEach(n=>emit(n,true));
  return rows.join("\n");
}

/* ===== Analysis: upgraded 60s analyzer producing notes + simple frames ===== */
let A={events:[], enriched:null, meta:{}}, B={events:[], enriched:null, meta:{}}, LAST_ANALYSIS={events:[], key:"C major", bpm:100, notesLead:[], notesBass:[]};

async function analyzeAudio(file){
  if(!file){ alert("Choose an audio file first."); return; }
  setStatus("Decoding…");
  const arr = await file.arrayBuffer();
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const buf = await ctx.decodeAudioData(arr.slice(0));

  // Mono + pre-emphasis
  const sr = buf.sampleRate, ch = buf.numberOfChannels;
  const mono = new Float32Array(Math.min(buf.length, sr*60));
  for(let c=0;c<ch;c++){
    const d=buf.getChannelData(c);
    for(let i=0;i<mono.length;i++){
      const x=d[i]||0, prev=i? d[i-1]:0;
      mono[i] += (x - 0.97*prev)/ch;
    }
  }

  // Params
  const FRAME=8192, HOP=2048, MIN_F=50, MAX_F=1200, BASS_MAX_F=200, maxS=mono.length;
  const hann=new Float32Array(FRAME); for(let i=0;i<FRAME;i++) hann[i]=0.5-0.5*Math.cos(2*Math.PI*i/(FRAME-1));
  const energy=x=>{let e=0;for(let i=0;i<x.length;i++)e+=x[i]*x[i];return e/x.length;};
  function autocorr(x){
    const n=x.length,out=new Float32Array(n); let mean=0; for(let i=0;i<n;i++) mean+=x[i]; mean/=n;
    let varsum=0; for(let i=0;i<n;i++){ const v=x[i]-mean; varsum+=v*v; }
    if(varsum<=1e-12) return out;
    for(let lag=0;lag<n;lag++){
      let s=0; for(let i=0;i<n-lag;i++){ s+=(x[i]-mean)*(x[i+lag]-mean); }
      out[lag]=s/varsum;
    }
    return out;
  }
  const parabolic=(y,x)=>{ const xv=(y[x-1]-y[x+1])/(2*(y[x-1]-2*y[x]+y[x+1]))+x; const yv=y[x]-0.25*(y[x-1]-y[x+1])*(xv-x); return {x:xv,y:yv}; };
  const freqToMidi=f=>69+12*Math.log2(f/440);

  const raw=[], chroma=new Float32Array(12), onsets=[]; let prevE=0;
  for(let st=0; st+FRAME<=maxS; st+=HOP){
    const fr=mono.subarray(st,st+FRAME);
    const w=new Float32Array(FRAME); for(let i=0;i<FRAME;i++) w[i]=fr[i]*hann[i];

    const E=energy(w); const dE=E-prevE; prevE=E; if(dE>0.005) onsets.push(st);

    const ac=autocorr(w);
    const minLag=Math.floor(sr/MAX_F), maxLag=Math.min(FRAME-3, Math.floor(sr/MIN_F));
    let bestLag=0, bestVal=0;
    for(let lag=minLag; lag<=maxLag; lag++){ if(ac[lag]>bestVal){ bestVal=ac[lag]; bestLag=lag; } }
    let domMidi=0, conf=0;
    if(bestLag>1 && bestLag<ac.length-2 && bestVal>0.15){
      const {x:lagRef,y:valRef}=parabolic(ac,bestLag);
      const f0=sr/Math.max(1e-6,lagRef);
      if(f0>=MIN_F && f0<=MAX_F){ domMidi=Math.round(freqToMidi(f0)); conf=Math.max(0,Math.min(1,valRef)); }
    }
    // bass search
    const minLagB=Math.floor(sr/BASS_MAX_F), maxLagB=Math.min(FRAME-3, Math.floor(sr/MIN_F));
    let bLag=0,bVal=0;
    for(let lag=minLagB; lag<=maxLagB; lag++){ if(ac[lag]>bVal){ bVal=ac[lag]; bLag=lag; } }
    let bassMidi=0;
    if(bLag>1 && bLag<ac.length-2 && bVal>0.12){
      const {x:lagRefB}=parabolic(ac,bLag);
      const fB=sr/Math.max(1e-6,lagRefB);
      if(fB>=MIN_F && fB<=BASS_MAX_F) bassMidi=Math.round(freqToMidi(fB));
    }

    if(domMidi){ const pc=((domMidi%12)+12)%12; chroma[pc]+=1; }

    const vel=Math.max(0.2, Math.min(1, Math.sqrt(E)*6));
    raw.push({t:st/sr, m:domMidi||0, b:bassMidi||0, v:vel, c:conf});
  }

  // median smooth
  const medSmooth=(list,key,half=2)=>{ const arr=list.map(e=>e[key]||0), out=new Array(arr.length).fill(0);
    for(let i=0;i<arr.length;i++){ const win=[]; for(let k=Math.max(0,i-half);k<=Math.min(arr.length-1,i+half);k++) if(arr[k]) win.push(arr[k]);
      if(win.length){ win.sort((a,b)=>a-b); out[i]=win[Math.floor(win.length/2)]; } }
    for(let i=0;i<list.length;i++) list[i][key]=out[i]||0;
  };
  medSmooth(raw,'m',2); medSmooth(raw,'b',2);

  const keyName=correlate(Array.from(chroma)); detKey.textContent=keyName;

  // BPM
  let bpm=100;
  if(onsets.length>=3){
    const dif=[]; for(let i=1;i<onsets.length;i++){ const dt=(onsets[i]-onsets[i-1])/sr; if(dt>0.18&&dt<2.5) dif.push(dt); }
    if(dif.length){ dif.sort((a,b)=>a-b); let b=Math.round(60/dif[Math.floor(dif.length/2)]); while(b<60) b*=2; while(b>180) b=Math.round(b/2); bpm=b; }
  }
  detBPM.textContent=String(bpm); bpmEl.value=String(bpm);

  // Quantize & merge to notes
  const beat=60/Math.max(40,Math.min(220,bpm));
  const qDiv=parseFloat(quantEl.value||"0.125"), grid=beat*4*qDiv;
  const Q=t=>Math.max(0,Math.min(60, Math.round(t/grid)*grid));
  const [r,mo]=(keyName||'C major').split(' '); const pcs=pcsFor(r,(mo||'major').toLowerCase());

  const qFrames=raw.map(e=>({ t:Q(e.t), m:e.m?snapToScale(e.m,pcs):0, b:e.b?snapToScale(e.b,pcs):0, v:e.v, c:e.c })).sort((a,b)=>a.t-b.t);
  function framesToNotes(frames, which='m'){
    const notes=[]; let cur=null;
    for(const f of frames){
      const pitch=f[which]||0;
      if(!pitch){ if(cur){ cur.tEnd=f.t; notes.push(cur); cur=null; } continue; }
      if(!cur){ cur={tStart:f.t,tEnd:f.t,midi:pitch,vel:f.v,conf:f.c}; }
      else if(pitch===cur.midi){ cur.tEnd=f.t; cur.vel=Math.max(cur.vel,f.v); cur.conf=Math.max(cur.conf,f.c); }
      else{ notes.push(cur); cur={tStart:f.t,tEnd:f.t,midi:pitch,vel:f.v,conf:f.c}; }
    }
    if(cur) notes.push(cur);
    const minDur=Math.max(0.08, grid*0.5);
    return notes.map(n=>({t:Math.min(60,n.tStart), dur:Math.max(minDur, Math.min(60-n.tStart, (n.tEnd-n.tStart)||minDur)), midi:n.midi, vel:n.vel, conf:n.conf}))
                .filter(n=>n.t+n.dur>0 && n.t<60);
  }
  const leadNotes=framesToNotes(qFrames,'m');
  const bassNotes=framesToNotes(qFrames,'b');

  // Dense simple frames for legacy path
  const eventsDense=qFrames.map(e=>({t:e.t, m:e.m||0, b:e.b||0}));

  LAST_ANALYSIS={events:eventsDense,key:keyName,bpm,notesLead:leadNotes,notesBass:bassNotes};
  setStatus(`Analysis complete → ${leadNotes.length + bassNotes.length} notes. Export CSV to use.`);
  light(dotAnalyze,true);
  checkExportReady();
}

/* ===== CSV Export button (choice) ===== */
btnExport.onclick=()=>{
  if(!LAST_ANALYSIS.events.length && (!LAST_ANALYSIS.notesLead || !LAST_ANALYSIS.notesLead.length)){
    alert("Analyze audio first.");
    return;
  }
  const enriched = confirm("OK = Enriched CSV (t,midi,vel,dur,is_bass,bar,beat,bpm,key)\nCancel = Simple CSV (t,m,b)");
  if(enriched){
    const csv = toCSV_enriched(LAST_ANALYSIS.notesLead||[], LAST_ANALYSIS.notesBass||[], LAST_ANALYSIS.bpm||100, LAST_ANALYSIS.key||"C major");
    downloadCSV("notes_enriched_60s.csv", csv);
  }else{
    const csv = toCSV_simple(LAST_ANALYSIS.events);
    downloadCSV("notes_60s.csv", csv);
  }
};

/* ===== Enriched-aware loaders for A/B ===== */
async function loadCSVto(side, file){
  if(!file){ alert(`Select CSV for ${side}`); return; }
  let parsed;
  try{ parsed = parseCSVFlexible(await file.text()); }catch(e){ alert(e.message); return; }

  if(side==='A'){
    if(parsed.mode==='enriched'){
      A.enriched = parsed.notes;
      A.events = []; // optional clear
      A.meta = {bpm: parsed.bpm||100, key: parsed.key||"C major"};
      setStatus(`A loaded (enriched): ${A.enriched.length} notes • ${A.meta.key} @ ${A.meta.bpm} BPM`);
    }else if(parsed.mode==='simple'){
      A.events = parsed.events;
      A.enriched = null;
      A.meta = {};
      setStatus(`A loaded (simple): ${A.events.length} rows`);
    }
    light(dotA,true); if(PICK_A.length===0) randomizeA();
  }else{
    if(parsed.mode==='enriched'){
      B.enriched = parsed.notes;
      B.events = [];
      B.meta = {bpm: parsed.bpm||100, key: parsed.key||"C major"};
      setStatus(`B loaded (enriched): ${B.enriched.length} notes • ${B.meta.key} @ ${B.meta.bpm} BPM`);
    }else if(parsed.mode==='simple'){
      B.events = parsed.events;
      B.enriched = null;
      B.meta = {};
      setStatus(`B loaded (simple): ${B.events.length} rows`);
    }
    light(dotB,true); if(PICK_B.length===0) randomizeB();
  }
  checkExportReady();
  markStage();
}
btnLoadA.onclick=()=>loadCSVto('A', csvA.files?.[0]||null);
btnLoadB.onclick=()=>loadCSVto('B', csvB.files?.[0]||null);

/* ===== Build schedule: prefer enriched notes if present ===== */
function activeSet(side){ return new Set((side==='A'?PICK_A:PICK_B).map(x=>x.id)); }
function sectionForSelected(midi,isBass,side,tSec){
  const chosen=activeSet(side);
  const allowed=[...chosen].filter(sec=> tSec>=(FAMILY_OPEN[familyOfSection(sec)]??0) );
  const tryPick=(pool)=>pool.find(s=>allowed.includes(s)) || null;
  const famPick=()=>{
    if(isBass || midi<=43) return tryPick(['bassesa','bassesb','trombonesa','trombonesb','hornsa','hornsb','pianoa','pianob']);
    if(midi<=55)          return tryPick(['cellosa','cellosb','violasa','violasb','hornsa','hornsb','pianoa','pianob']);
    if(midi<=64)          return tryPick(['violasa','violasb','vln2a','vln2b','clarinetsa','clarinetsb','pianoa','pianob']);
    if(midi<=76)          return tryPick(['vln2a','vln2b','vln1a','vln1b','flutesa','flutesb','oboesa','oboesb','clarinetsa','clarinetsb','pianoa','pianob']);
    if(midi<=84)          return tryPick(['vln1a','vln1b','flutesa','flutesb','oboesa','oboesb','pianoa','pianob']);
    return tryPick(['flutesa','flutesb','vln1a','vln1b','clarinetsa','clarinetsb','oboesa','oboesb','pianoa','pianob']);
  };
  const cand=famPick(); if(cand) return cand;
  if(allowed.length) return allowed[Math.floor(Math.random()*allowed.length)];
  const any=[...chosen]; return any[Math.floor(Math.random()*any.length)] || 'vln1a';
}

function scheduleFromEnriched(notes, side){
  return (notes||[]).map(n=>({
    t:Math.min(60,Math.max(0,n.t)),
    midi:Math.round(n.midi),
    dur:Math.max(0.05,Math.min(2.5,n.dur)),
    vel:Math.max(0.1,Math.min(1.0,n.vel)),
    sec:sectionForSelected(Math.round(n.midi), !!n.isBass, side, n.t)
  }));
}

function musicalize(events, side){
  // (your original musicalize — unchanged)
  // returns [{t,midi,dur,vel,sec}, ...]
  /* ... keep your existing musicalize code here ... */
}

function buildSchedule(){
  const a = A.enriched ? scheduleFromEnriched(A.enriched,'A') : musicalize(A.events,'A');
  const b = B.enriched ? scheduleFromEnriched(B.enriched,'B') : musicalize(B.events,'B');
  return [...a,...b].sort((x,y)=>x.t-y.t);
}

/* ===== The rest of your existing transport, audio render, export WAV, reset, init… stay exactly the same ===== */

/* Wire up minimal extras (unchanged originals kept) */
btnLoadAudio.onclick=()=>audioFile.click();
btnAnalyze.onclick=()=>analyzeAudio(audioFile.files?.[0]||null);

function checkExportReady(){
  const ready = (A.events && A.events.length) || (B.events && B.events.length)
             || (A.enriched && A.enriched.length) || (B.enriched && B.enriched.length)
             || (LAST_ANALYSIS.events && LAST_ANALYSIS.events.length);
  light(dotExport, !!ready);
}

/* Keep your existing play/stop/exportAudio/reset/init code below unchanged */
</script>
</main>
</body>
</html>
