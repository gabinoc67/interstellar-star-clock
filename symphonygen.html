<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST Astrodumus — LIVE Orchestrator (Follows Uploaded Song)</title>
<meta name="description" content="Upload a song, detect tempo & beats, then play a symphonic remake locked to that song’s rhythm. Big LIVE button to play when ready."/>
<style>
  :root{
    --bg:#081024;--panel:#0e1634;--ink:#e9f1ff;--muted:#a2b4e8;--grid:#1a2660;--btn:#162760;
    --accent:#9bd1ff;--ok:#3fe6a0;--warn:#ffb86b;--liveOff:#222b5a;--liveOn:#00d27a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  p.sub{margin:0 0 14px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.25);overflow:hidden}
  .pad{padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:var(--btn);color:var(--ink);border:1px solid #273a8a;border-radius:12px;padding:10px 14px;cursor:pointer}
  button:hover{filter:brightness(1.08)}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=file]{accent-color:#5ea0ff}
  .status{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px}
  .status>div{background:#0b1333;border:1px solid var(--grid);border-radius:10px;padding:10px;min-height:54px}
  .tiny{font-size:.85rem;color:var(--muted)}
  canvas{width:100%;height:160px;display:block;background:linear-gradient(180deg,#0b1536,#0b1230)}
  #timeline{height:240px;margin-top:6px}

  /* BIG LIVE BUTTON */
  .liveWrap{display:flex;justify-content:center;align-items:center;padding:16px 14px 6px}
  #liveBtn{
    width:100%; max-width:740px; height:110px;
    border-radius:20px; border:2px solid #10206a;
    background:linear-gradient(180deg,var(--liveOff),#111a44);
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.04);
    color:#cfe7ff; font-weight:900; font-size:48px; letter-spacing:6px;
    display:flex; align-items:center; justify-content:center; user-select:none;
    cursor:not-allowed; position:relative; transition:transform .08s ease, filter .12s ease;
  }
  #liveBtn.ready{
    cursor:pointer; background:linear-gradient(180deg,#0ccf7c,var(--liveOn));
    color:#08221a; border-color:#0a9c5e; text-shadow:0 1px 0 rgba(255,255,255,.35);
    box-shadow:0 12px 40px rgba(3,210,122,.35), inset 0 0 0 2px rgba(255,255,255,.08);
  }
  #liveBtn.playing{
    background:linear-gradient(180deg,#10e08a,#06c776);
    box-shadow:0 14px 42px rgba(3,210,122,.5), inset 0 0 0 2px rgba(255,255,255,.1);
  }
  #liveSub{
    position:absolute; bottom:10px; font-size:14px; letter-spacing:1.2px; opacity:.8
  }
  .hint{color:#a8b8ee;font-size:.85rem;margin:8px 14px 14px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid var(--grid);border-radius:999px;background:#0b1436;color:#cfe0ff;font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>CST “Astrodumus” — LIVE Orchestrator</h1>
  <p class="sub">Upload a song → Analyze → when the big <b>LIVE</b> button turns green, click it to hear a symphonic version that follows your song’s tempo and rhythm.</p>

  <section class="card">
    <div class="pad">
      <div class="row">
        <input id="file" type="file" accept="audio/*"/>
        <button id="analyze">Analyze Uploaded Song</button>
        <button id="export" disabled>⬇ Download Orchestral WAV</button>
        <span id="loaded" class="tag">No file loaded</span>
      </div>

      <div class="status">
        <div><b>Detected BPM</b><div id="bpmOut" class="tiny">–</div></div>
        <div><b>Beat Count</b><div id="beatsOut" class="tiny">–</div></div>
        <div><b>Length</b><div id="lenOut" class="tiny">–</div></div>
        <div><b>Grid</b><div id="gridOut" class="tiny">Beats from your song</div></div>
        <div><b>Lock</b><div class="tiny">Exactly on-beat (no random)</div></div>
      </div>
    </div>

    <!-- BIG LIVE BUTTON -->
    <div class="liveWrap">
      <div id="liveBtn"><span>LIVE</span><div id="liveSub">Load & Analyze to Enable</div></div>
    </div>

    <canvas id="wave" title="Waveform + detected beats"></canvas>
    <canvas id="timeline" title="Orchestral events locked to your song"></canvas>

    <p class="hint">This simulator only follows the uploaded song. It detects tempo & onsets from <i>your</i> audio and orients strings, woods, brass, harp, glock, and bass to those beats—no external patterns.</p>
  </section>
</div>

<script>
/* ===== Utilities ===== */
const $=id=>document.getElementById(id);
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* ===== Global State ===== */
let SRC_ARRAYBUF=null, ANALYSIS=null, SCORE=null;
let ACTX=null, master=null, sendRev=null; const BUS={}; let scheduled=[], playing=false;

/* ===== UI Helpers ===== */
function setReady(isReady){
  const live = $('liveBtn');
  if(isReady){
    live.classList.add('ready'); live.setAttribute('aria-live','polite');
    $('liveSub').textContent='CLICK TO PLAY';
    $('export').disabled = false;
  }else{
    live.classList.remove('ready'); live.classList.remove('playing');
    $('liveSub').textContent='Load & Analyze to Enable';
    $('export').disabled = true;
  }
}

/* ===== Drawing ===== */
function drawWaveform(canvas, pcm, sr, beatsSec){
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1; const W=canvas.clientWidth*dpr, H=canvas.clientHeight*dpr; canvas.width=W; canvas.height=H;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0b1436'; ctx.fillRect(0,0,W,H);
  // waveform
  ctx.strokeStyle='#96b7ff'; ctx.lineWidth=1;
  ctx.beginPath();
  const step=Math.max(1, Math.floor(pcm.length/W));
  const mid=H/2, scale=H*0.45;
  for(let x=0, i=0; x<W; x++, i+=step){
    let min=1e9, max=-1e9;
    for(let j=0;j<step && i+j<pcm.length;j++){
      const v=pcm[i+j];
      if(v<min)min=v; if(v>max)max=v;
    }
    ctx.moveTo(x, mid+min*scale); ctx.lineTo(x, mid+max*scale);
  }
  ctx.stroke();
  // beats
  if(beatsSec && beatsSec.length){
    ctx.strokeStyle='#1b2a66';
    for(const t of beatsSec){
      const x = (t/ (pcm.length/sr)) * W;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    ctx.strokeStyle='#ffd38a'; ctx.lineWidth=1.5;
    beatsSec.forEach((t,idx)=>{
      if(idx%4===0){ const x=(t/(pcm.length/sr))*W; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    });
  }
}
function drawTimeline(canvas, score){
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1; const W=canvas.clientWidth*dpr, H=canvas.clientHeight*dpr; canvas.width=W; canvas.height=H;
  ctx.clearRect(0,0,W,H);
  const rows=['strings','woods','brass','harp','glock','abass']; const rh=H/rows.length;
  const colors={strings:'#ffddb0',woods:'#c8ffc8',brass:'#ffd1d1',harp:'#ffe7f3',glock:'#e9ffbe',abass:'#ffd3a3'};
  ctx.strokeStyle="#1b2a66"; ctx.lineWidth=1;
  for(let i=0;i<=16;i++){ const x=i*(W/16); ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  function rx(t){ return (t/score.seconds)*W; }
  score.events.forEach(e=>{
    const ri=rows.indexOf(e.inst); if(ri<0) return;
    const x=rx(e.time), w=(e.dur/score.seconds)*W, y=ri*rh+rh*0.22, h=rh*0.56;
    ctx.fillStyle=colors[e.inst]||'#eee'; ctx.fillRect(x,y,Math.max(1.5,w),h);
  });
}

/* ===== Audio Engine (Synth, Orchestral Colors) ===== */
function ensureAudio(){
  if(ACTX) return;
  ACTX=new (window.AudioContext||window.webkitAudioContext)();
  master=ACTX.createGain(); master.gain.value=0.9; master.connect(ACTX.destination);
  const sum=ACTX.createGain(); sum.connect(master);
  const delays=[0.0297,0.0371,0.0411,0.0437], gains=[0.805,0.827,0.783,0.764];
  for(let i=0;i<4;i++){ const d=ACTX.createDelay(1); d.delayTime.value=delays[i]; const g=ACTX.createGain(); g.gain.value=gains[i]; d.connect(g); g.connect(d); g.connect(sum); }
  sendRev=ACTX.createGain(); sendRev.gain.value=0.22; sendRev.connect(sum);
}
async function unlockAudio(){ ensureAudio(); try{ await ACTX.resume(); }catch(e){} }
function makeBus(level,pan=0){
  const g=ACTX.createGain(); g.gain.value=level;
  const p=ACTX.createStereoPanner?ACTX.createStereoPanner():null;
  if(p){ p.pan.value=pan; g.connect(p); p.connect(master); } else { g.connect(master); }
  const send=ACTX.createGain(); send.gain.value=0.0; g.connect(send); send.connect(sendRev);
  return {g,send};
}
function env(g,t0,a,d,sus,hold,rel,vel){
  const t1=t0+a, t2=t1+d, t3=t2+hold, t4=t3+rel;
  g.gain.setValueAtTime(0,t0);
  g.gain.linearRampToValueAtTime(vel,t1);
  g.gain.linearRampToValueAtTime(vel*sus,t2);
  g.gain.setValueAtTime(vel*sus,t3);
  g.gain.linearRampToValueAtTime(0,t4);
  return t4;
}
function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }
const BUS_LIST=['strings','woods','brass','harp','glock','abass'];
function initBuses(){ BUS_LIST.forEach((k,i)=>{ BUS[k]=BUS[k]||makeBus(0.72,(i%2?0.12:-0.12)); }); }
const Patches = {
  strings:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='sawtooth'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2200;
    const g=ACTX.createGain(); const end=env(g,t,0.08,0.5,0.8,Math.max(0.05,d-0.4),0.3,v*0.6);
    o.connect(f); f.connect(g); g.connect(BUS.strings.g); g.connect(BUS.strings.send);
    o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); },
  woods:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='square'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2400;
    const g=ACTX.createGain(); const end=env(g,t,0.03,0.22,0.55,Math.max(0.05,d-0.25),0.2,v*0.6);
    o.connect(f); f.connect(g); g.connect(BUS.woods.g); g.connect(BUS.woods.send);
    o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); },
  brass:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='sawtooth'; o.frequency.value=midiToHz(m);
    const f=ACTX.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1800;
    const g=ACTX.createGain(); const end=env(g,t,0.02,0.25,0.6,Math.max(0.05,d-0.3),0.25,v*0.8);
    o.connect(f); f.connect(g); g.connect(BUS.brass.g); g.connect(BUS.brass.send);
    o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); },
  harp:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='triangle'; o.frequency.value=midiToHz(m);
    const g=ACTX.createGain(); const end=env(g,t,0.002,0.22,0.35,0.01,0.4,v*0.7);
    o.connect(g); g.connect(BUS.harp.g); g.connect(BUS.harp.send);
    o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); },
  glock:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='sine'; o.frequency.value=midiToHz(m)*2;
    const g=ACTX.createGain(); const end=env(g,t,0.001,0.4,0.25,0.02,0.8,v*0.6);
    o.connect(g); g.connect(BUS.glock.g); g.connect(BUS.glock.send);
    o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); },
  abass:(m,t,d,v)=>{ const o=ACTX.createOscillator(); o.type='triangle'; o.frequency.value=midiToHz(m);
    const g=ACTX.createGain(); const end=env(g,t,0.01,0.3,0.5,Math.max(0.05,d-0.25),0.25,v*0.7);
    o.connect(g); g.connect(BUS.abass.g); o.start(t); o.stop(end); scheduled.push({o:[o],g,end}); }
};

/* ===== Load & Analyze (only from the uploaded song) ===== */
$('file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  SRC_ARRAYBUF = await f.arrayBuffer();
  $('loaded').textContent = `Loaded: ${f.name}`;
  $('loaded').style.borderColor = '#2f7fff';
  setReady(false);
  ANALYSIS=null; SCORE=null;
  $('bpmOut').textContent='–'; $('beatsOut').textContent='–'; $('lenOut').textContent='–';
  const dpr=window.devicePixelRatio||1;
  $('wave').width=$('wave').clientWidth*dpr; $('wave').height=$('wave').clientHeight*dpr;
  $('timeline').width=$('timeline').clientWidth*dpr; $('timeline').height=$('timeline').clientHeight*dpr;
});

$('analyze').addEventListener('click', async ()=>{
  if(!SRC_ARRAYBUF){ alert('Choose an audio file first.'); return; }
  ensureAudio();
  const ctx = new OfflineAudioContext(1, 44100*240, 44100); // up to 4 minutes mono
  let audioBuf;
  try { audioBuf = await ctx.decodeAudioData(SRC_ARRAYBUF.slice(0)); }
  catch(e){ alert('Decode failed. Try a different file.'); return; }
  const sr = audioBuf.sampleRate;
  const pcm = audioBuf.getChannelData(0);

  // Simple onset/tempo extraction (spectral flux-ish)
  const diff = new Float32Array(pcm.length);
  for(let i=1;i<pcm.length;i++) diff[i] = pcm[i] - pcm[i-1]*0.97;

  const hop = 512, win = 1024;
  const flux = [];
  let prevEnergyBins = new Float32Array(64);
  for(let i=0;i+win<diff.length;i+=hop){
    const seg = diff.subarray(i, i+win);
    const bins = new Float32Array(64);
    const step = Math.max(1, Math.floor(seg.length / 64));
    let idx=0;
    for(let b=0;b<64;b++){
      let s=0; let n=0;
      for(let k=0;k<step && idx<seg.length;k++){ s+=seg[idx]*seg[idx]; n++; idx++; }
      bins[b]=Math.sqrt(s/(n||1));
    }
    let fval=0;
    for(let b=0;b<64;b++){ const d=bins[b]-prevEnergyBins[b]; if(d>0) fval += d; }
    flux.push(fval);
    prevEnergyBins=bins;
  }

  const fmax = flux.reduce((a,b)=>Math.max(a,b),1e-9);
  for(let i=0;i<flux.length;i++) flux[i]/=fmax;

  const thr = new Float32Array(flux.length);
  const winThr=16;
  for(let i=0;i<thr.length;i++){
    let s=0,c=0;
    for(let j=-winThr;j<=winThr;j++){ const k=i+j; if(k>=0 && k<thr.length){ s+=flux[k]; c++; } }
    thr[i] = (s/(c||1))*0.9;
  }

  const onsets=[];
  for(let i=2;i<flux.length-2;i++){
    const v=flux[i]-thr[i];
    if(v>0 && v>flux[i-1]-thr[i-1] && v>flux[i+1]-thr[i+1]) onsets.push(i);
  }
  const frameSec = hop/sr;
  const onsetsSec = onsets.map(f=>f*frameSec);

  const BPM_MIN=60, BPM_MAX=180;
  const hist = new Float32Array(BPM_MAX+1);
  for(let i=1;i<onsetsSec.length;i++){
    const d = onsetsSec[i]-onsetsSec[i-1]; if(d<=0) continue;
    let bpm = 60/d;
    while(bpm>BPM_MAX) bpm/=2;
    while(bpm<BPM_MIN) bpm*=2;
    const bi = Math.round(bpm);
    if(bi>=BPM_MIN && bi<=BPM_MAX) hist[bi]+=1;
  }
  let bestBPM=120, bestVal=-1;
  for(let b=BPM_MIN;b<=BPM_MAX;b++){ if(hist[b]>bestVal){ bestVal=hist[b]; bestBPM=b; } }

  const beats=[];
  if(onsetsSec.length){
    const beatLen = 60/bestBPM;
    const T = pcm.length/sr;
    let bestPhase=0, bestMatches=-1;
    for(let k=0;k<16;k++){
      const phase = (k/16)*beatLen;
      let matches=0;
      for(let tt=phase; tt<T; tt+=beatLen){
        for(const o of onsetsSec){ if(Math.abs(o-tt)<0.04){ matches++; } }
      }
      if(matches>bestMatches){ bestMatches=matches; bestPhase=phase; }
    }
    for(let tt=bestPhase; tt<T; tt+=beatLen){ beats.push(tt); }
  }

  ANALYSIS = { sr, pcm, lengthSec: pcm.length/sr, onsetsSec, beatsSec: beats, bpm: bestBPM };
  $('bpmOut').textContent = bestBPM ? `${bestBPM} BPM` : '–';
  $('beatsOut').textContent = beats.length ? `${beats.length}` : '–';
  $('lenOut').textContent = `${ANALYSIS.lengthSec.toFixed(2)} s`;
  drawWaveform($('wave'), pcm, sr, beats);

  // Build orchestral score and show timeline (still follows only your song)
  SCORE = buildOrchestralScore(ANALYSIS);
  drawTimeline($('timeline'), SCORE);
  setReady(true);
});

function buildOrchestralScore(analysis){
  const beats = analysis.beatsSec;
  const T = analysis.lengthSec;
  const events=[];
  if(!beats || beats.length<4) return {events, seconds:T};

  const meter=4;
  const base=60; // middle C-ish
  const chordRoots=[0,5,7,0]; // C F G C (stable cadence, rhythm-led)
  function degToMidi(root,deg){ return base + root + deg; }
  const nearOnset = (t,win=0.05)=>analysis.onsetsSec.some(o=>Math.abs(o-t)<win);

  for(let i=0;i<beats.length;i++){
    const t=beats[i];
    const barIdx = Math.floor(i/meter);
    const root = chordRoots[barIdx%chordRoots.length];

    if(i%meter===0){
      const hold = Math.min( (i+4<beats.length? beats[i+4]-t : 4*(60/analysis.bpm)), 2.0);
      [0,4,7].forEach(iv=>{
        events.push({inst:'strings', time:t, dur:hold, midi:degToMidi(root,iv), vel:0.40});
      });
      if(barIdx%2===1) events.push({inst:'strings', time:t, dur:hold, midi:degToMidi(root,10), vel:0.32});
      events.push({inst:'abass', time:t, dur:60/analysis.bpm, midi:degToMidi(root,-24), vel:0.62});
    }else if(i%meter===2){
      events.push({inst:'abass', time:t, dur:60/analysis.bpm*0.95, midi:degToMidi(root,-17), vel:0.55});
    }

    if(nearOnset(t,0.05)){
      const dur = 60/analysis.bpm*0.95;
      if(i%2===0){
        events.push({inst:'woods', time:t, dur:dur, midi:degToMidi(root,19), vel:0.66}); // +12+7
      }else{
        events.push({inst:'brass', time:t+0.005, dur:dur*0.95, midi:degToMidi(root,16), vel:0.70}); // +12+4
      }
    }

    const next = beats[i+1] ?? (t+60/analysis.bpm);
    const mid = t + (next-t)/2;
    if(nearOnset(mid,0.05)){
      const seq=[0,4,7,12];
      const step = (next-t)/seq.length;
      seq.forEach((iv,k)=>{
        const tt = t + k*step;
        const inst = (k%2===0)?'harp':'glock';
        events.push({inst, time:tt, dur:step*0.92, midi:degToMidi(root,12+iv), vel:0.46});
      });
    }
  }
  return {events, seconds:T};
}

/* ===== Playback via LIVE button ===== */
function stopAll(){
  if(!playing) return; playing=false;
  $('liveBtn').classList.remove('playing');
  const now=ACTX?ACTX.currentTime:0;
  scheduled.forEach(n=>{ try{ if(n.g){ n.g.gain.cancelScheduledValues(now); n.g.gain.linearRampToValueAtTime(0, now+0.05); } (n.o||[]).forEach(o=>{ try{o.stop(now+0.06);}catch(e){} }); }catch(e){} });
  scheduled.length=0;
}
function startPlay(){
  if(!SCORE) return;
  const start=ACTX.currentTime+0.25; playing=true; scheduled.length=0;
  $('liveBtn').classList.add('playing');
  const playMap={strings:Patches.strings, woods:Patches.woods, brass:Patches.brass, harp:Patches.harp, glock:Patches.glock, abass:Patches.abass};
  const jitter=0; // exact lock to detected beats (no random humanization)
  SCORE.events.forEach(ev=>{
    const when=start+ev.time+(Math.random()*2-1)*jitter;
    const fn=playMap[ev.inst]; if(fn) fn(ev.midi,when,ev.dur,clamp(ev.vel,0,1));
  });
  setTimeout(()=>stopAll(), (SCORE.seconds+1.5)*1000);
}

$('liveBtn').addEventListener('click', async ()=>{
  if(!$('liveBtn').classList.contains('ready')) return;
  await unlockAudio(); ensureAudio(); initBuses();
  if(playing){ stopAll(); return; }
  startPlay();
});

/* ===== Export WAV (orchestral only) ===== */
$('export').addEventListener('click', async ()=>{
  if(!SCORE){ alert('Analyze and click LIVE first to generate a score.'); return; }
  await unlockAudio();
  const sr=44100, len=SCORE.seconds+2;
  const ctx=new OfflineAudioContext(2, Math.ceil(len*sr), sr);
  const master=ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination);
  const send=ctx.createGain(); send.gain.value=0.25; const d=ctx.createDelay(1); d.delayTime.value=0.04; const g=ctx.createGain(); g.gain.value=0.6; d.connect(g); g.connect(d);
  const sum=ctx.createGain(); d.connect(sum); sum.connect(master); send.connect(d);
  function mkBus(level){ const g=ctx.createGain(); g.gain.value=level; g.connect(master); const s=ctx.createGain(); s.gain.value=0.2; g.connect(s); s.connect(send); return {g}; }
  const B={}; ['strings','woods','brass','harp','glock','abass'].forEach(k=>B[k]=mkBus(0.72));
  function hz(m){ return 440*Math.pow(2,(m-69)/12); }
  function ev(g,t0,a,d,s,hold,rel,vel){ const t1=t0+a,t2=t1+d,t3=t2+hold,t4=t3+rel; g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(vel,t1); g.gain.linearRampToValueAtTime(vel*s,t2); g.gain.setValueAtTime(vel*s,t3); g.gain.linearRampToValueAtTime(0,t4); }
  function osc(type,f){ const o=ctx.createOscillator(); o.type=type; o.frequency.value=f; return o; }
  function add(inst,m,when,dur,vel){
    const addOsc=(type,f,a,d,s,h,r,v,bus)=>{ const o=osc(type,f),g=ctx.createGain(); ev(g,when,a,d,s,h,r,vel*v); o.connect(g); g.connect(B[bus].g); o.start(when); o.stop(when+a+d+h+r+0.02); };
    if(inst==='strings'){ const o=osc('sawtooth',hz(m)),f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2200; const g=ctx.createGain();
      ev(g,when,0.08,0.5,0.8,Math.max(0.05,dur-0.4),0.3,0.6*vel); o.connect(f); f.connect(g); g.connect(B.strings.g); o.start(when); o.stop(when+dur+0.6); }
    else if(inst==='woods'){ const o=osc('square',hz(m)),f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2400; const g=ctx.createGain();
      ev(g,when,0.03,0.22,0.55,Math.max(0.05,dur-0.25),0.2,0.6*vel); o.connect(f); f.connect(g); g.connect(B.woods.g); o.start(when); o.stop(when+dur+0.3); }
    else if(inst==='brass'){ const o=osc('sawtooth',hz(m)),f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1800; const g=ctx.createGain();
      ev(g,when,0.02,0.25,0.6,Math.max(0.05,dur-0.3),0.25,0.8*vel); o.connect(f); f.connect(g); g.connect(B.brass.g); o.start(when); o.stop(when+dur+0.4); }
    else if(inst==='harp') addOsc('triangle',hz(m),0.002,0.22,0.35,0.01,0.4,0.7,'harp');
    else if(inst==='glock') addOsc('sine',hz(m)*2,0.001,0.4,0.25,0.02,0.8,0.6,'glock');
    else if(inst==='abass') addOsc('triangle',hz(m),0.01,0.3,0.5,Math.max(0.05,dur-0.25),0.25,0.7,'abass');
  }
  SCORE.events.forEach(e=>add(e.inst,e.midi,e.time+0.05,e.dur,e.vel));

  const buf=await ctx.startRendering();
  function interleave(L,R){ const out=new Float32Array(L.length+R.length); for(let i=0,j=0;i<L.length;i++,j+=2){ out[j]=L[i]; out[j+1]=R[i]; } return out; }
  function f32To16(view,off,data){ for(let i=0;i<data.length;i++,off+=2){ let s=Math.max(-1,Math.min(1,data[i])); s=s<0?s*0x8000:s*0x7FFF; view.setInt16(off,s,true);} }
  function w(view,off,str){ for(let i=0;i<str.length;i++) view.setUint8(off+i,str.charCodeAt(i)); }
  const L=buf.getChannelData(0), R=buf.getChannelData(1), inter=interleave(L,R);
  const ab=new ArrayBuffer(44+inter.length*2), dv=new DataView(ab); const sampleRate=sr;
  w(dv,0,'RIFF'); dv.setUint32(4,36+inter.length*2,true); w(dv,8,'WAVE'); w(dv,12,'fmt '); dv.setUint32(16,16,true);
  dv.setUint16(20,1,true); dv.setUint16(22,2,true); dv.setUint32(24,sampleRate,true); dv.setUint32(28,sampleRate*4,true);
  dv.setUint16(32,4,true); dv.setUint16(34,16,true); w(dv,36,'data'); dv.setUint32(40,inter.length*2,true);
  f32To16(dv,44,inter);
  const blob=new Blob([dv],{type:'audio/wav'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='CST_LIVE_Orchestral_From_Upload.wav'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
});
</script>
</body>
</html>
