<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Warp Tunnel Time & Dilation — Solar & Galaxy Modes (CST Time-Lock)</title>
<meta name="description" content="Interactive demo: Solar System & Galaxy Mode. Choose destination, speed (km/s ≤192 or fraction of c), warp (1–10), and see Earth/CST vs Ship clocks, arrival times, and time dilation (SR + approximate GR) with or without CST stabilization. Includes apparent speed and required warp calculator." />
<style>
  :root{
    --bg:#0b1020; --card:#0f1733; --ink:#ecf2ff; --muted:#9fb0d6; --accent:#7fb1ff; --border:#22305c;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent)}
  .wrap{max-width:1240px;margin:0 auto;padding:20px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .h1{font-weight:800;font-size:1.25rem}
  .pill{display:inline-block;background:#0d2250;border:1px solid var(--border);color:#cfe0ff;border-radius:999px;padding:.2rem .6rem;font-size:.8rem}
  .grid{display:grid;gap:16px}
  @media(min-width:1120px){.grid.cols-3{grid-template-columns:1.2fr 1fr 1fr}}
  @media(min-width:860px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  h2{margin:.2rem 0 .6rem;font-size:1.1rem}
  h3{margin:.3rem 0 .4rem;font-size:1.02rem}
  h4{margin:0 0 .25rem;font-size:.92rem}
  label{display:block;font-size:.9rem;color:var(--muted);margin:.35rem 0}
  input,select{width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--border);background:#0b1430;color:#ecf2ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>*{flex:1}
  .btn{display:inline-block;background:#0d2250;border:1px solid var(--border);color:#cfe0ff;border-radius:10px;padding:.55rem .8rem;text-decoration:none}
  .btn:hover{background:#102b6b}
  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi .box{background:#0b1430;border:1px solid var(--border);border-radius:12px;padding:10px}
  .kpi .box p{margin:0;font-variant-numeric:tabular-nums}
  .num{font-weight:700;color:#e7f1ff}
  .muted{color:#9fb0d6}
  .ok{color:var(--good)}
  .warn{color:var(--warn)}
  .bad{color:var(--bad)}
  .clock{font-family:ui-monospace,Menlo,Consolas,monospace}
  .sep{height:1px;background:var(--border);margin:14px 0}
  .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:.85rem;color:#cfe0ff}
  .tag{display:inline-block;border:1px solid var(--border);padding:.2rem .5rem;border-radius:999px;font-size:.75rem;color:#b7c7ff}
  footer{margin-top:18px;color:var(--muted);font-size:.9rem;text-align:center}
  .inline-note{font-size:.85rem;color:#cfe0ff}
  .switch{display:inline-flex;align-items:center;gap:10px}
  .switch input{width:auto}
  .hero-clocks{display:grid;gap:10px}
  @media(min-width:860px){.hero-clocks{grid-template-columns:1fr 1fr}}
  .bigclock{background:#0b1430;border:1px solid var(--border);border-radius:14px;padding:12px}
  .bigclock h3{margin:.2rem 0 .3rem}
  .bigclock p{font-size:1.02rem;margin:.2rem 0}
  .compare{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .badge{display:inline-block;border:1px solid var(--border);padding:.2rem .5rem;border-radius:999px;font-size:.75rem;margin-left:6px}
  .inline-radios{display:flex;gap:14px;align-items:center}
  .inline-radios label{margin:0;color:#cfe0ff}
  .small{font-size:.85rem}
  .math{background:#0b1430;border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:8px}
  .callout{background:#0b1430;border:1px solid var(--border);border-radius:12px;padding:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
<!-- Optional: MathJax for crisp formulas (safe on GitHub Pages) -->
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="h1">Warp Tunnel Time & Dilation — Solar System & Galaxy Modes</div>
      <div class="muted">Keep clocks in step with Earth using modest speed + path-shortening (Warp) + CST time-lock</div>
    </div>
    <span class="pill">Proposed concept • Educational math demo</span>
  </header>

  <!-- Hero clocks: Outside vs Inside -->
  <section class="hero-clocks">
    <div class="bigclock">
      <h3>Outside the Ship — Earth/CST</h3>
      <p class="clock"><strong>Earth UTC:</strong> <span id="heroUTC">—</span></p>
      <p class="clock"><strong>CST (cosmic):</strong> <span id="heroCST">—</span></p>
    </div>
    <div class="bigclock">
      <h3>Inside the Ship — Proper Clock</h3>
      <p class="clock"><strong>Ship Clock:</strong> <span id="heroShip">—</span></p>
      <p class="clock"><strong>Ship − UTC Offset:</strong> <span id="heroOffset" class="num">0.000 s</span></p>
    </div>
  </section>

  <div class="sep"></div>

  <div class="grid cols-3">
    <!-- Controls -->
    <section class="card">
      <h2>Mission Setup</h2>

      <div class="row">
        <div>
          <label for="mode">Mode</label>
          <select id="mode" onchange="onModeChange()">
            <option value="solar" selected>Solar System</option>
            <option value="galaxy">Galaxy Mode (stars/galaxies)</option>
          </select>
        </div>
        <div>
          <label for="age">Traveler age now (years, optional)</label>
          <input id="age" type="number" min="0" step="0.1" placeholder="e.g., 58.0">
        </div>
      </div>

      <div id="solarDest">
        <label for="destSolar">Destination (static Earth → closest reference distance)</label>
        <select id="destSolar">
          <option value="3.844e5">Moon — 384,400 km</option>
          <option value="4.10e7">Venus — 41,000,000 km</option>
          <option value="7.70e7">Mercury — 77,000,000 km</option>
          <option value="5.46e7" selected>Mars — 54,600,000 km</option>
          <option value="5.88e8">Jupiter — 588,000,000 km</option>
          <option value="1.20e9">Saturn — 1,200,000,000 km</option>
          <option value="2.60e9">Uranus — 2,600,000,000 km</option>
          <option value="4.30e9">Neptune — 4,300,000,000 km</option>
          <option value="4.67e9">Pluto — 4,670,000,000 km</option>
        </select>
        <label for="customKm">Or custom distance (km)</label>
        <input id="customKm" type="number" min="0" step="1000" placeholder="Enter km to override preset (optional)">
      </div>

      <div id="galaxyDest" style="display:none">
        <label for="destGalaxy">Destination (light-years)</label>
        <select id="destGalaxy">
          <option value="4.24">Proxima Centauri — 4.24 ly</option>
          <option value="4.37" selected>Alpha Centauri — 4.37 ly</option>
          <option value="5.96">Barnard’s Star — 5.96 ly</option>
          <option value="8.60">Sirius — 8.60 ly</option>
          <option value="39.5">TRAPPIST-1 — 39.5 ly</option>
          <option value="163000">Large Magellanic Cloud — 163,000 ly</option>
          <option value="2500000">Andromeda Galaxy (M31) — 2,500,000 ly</option>
          <option value="2730000">Triangulum Galaxy (M33) — 2,730,000 ly</option>
        </select>
        <label for="customLy">Or custom distance (ly)</label>
        <input id="customLy" type="number" min="0" step="0.01" placeholder="Enter ly to override preset (optional)">
      </div>

      <div class="row">
        <div>
          <label>Speed input</label>
          <div class="inline-radios">
            <input type="radio" id="spdKm" name="spdMode" value="km" checked onchange="onSpeedMode()" />
            <label for="spdKm">km/s (≤192)</label>
            <input type="radio" id="spdFrac" name="spdMode" value="frac" onchange="onSpeedMode()" />
            <label for="spdFrac">fraction of c</label>
          </div>
        </div>
      </div>

      <div id="speedKmWrap">
        <label for="speedKm">Speed (km/s) — max 192</label>
        <input id="speedKm" type="range" min="1" max="192" step="1" value="192" oninput="updateSpeedKmLabel(this.value)">
        <div class="legend"><span>Speed: <span id="speedKmLabel" class="num">192</span> km/s</span> <span class="tag">c = 299,792 km/s</span></div>
      </div>

      <div id="speedFracWrap" style="display:none">
        <label for="speedFrac">Speed (fraction of c)</label>
        <input id="speedFrac" type="range" min="0.01" max="0.99" step="0.01" value="0.90" oninput="updateSpeedFracLabel(this.value)">
        <div class="legend"><span>Speed: <span id="speedFracLabel" class="num">0.90 c</span></span> <span class="tag">γ auto-computed</span></div>
      </div>

      <div class="row">
        <div>
          <label for="warp">Warp Index (1–10) — path shortened by 1/warp</label>
          <input id="warp" type="range" min="1" max="10" step="1" value="8" oninput="updateWarpLabel(this.value)">
          <div class="legend"><span>Warp: <span id="warpLabel" class="num">8</span></span> <span class="tag">Shortening = distance ÷ warp</span></div>
        </div>
      </div>

      <div class="row">
        <div class="switch">
          <input id="stabilize" type="checkbox" checked />
          <label for="stabilize"><strong>Dilation Stabilization</strong> (CST time-lock + gentle fields)</label>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="targetTime">Target Earth arrival time</label>
          <input id="targetTime" type="number" min="0.001" step="0.001" value="10" />
        </div>
        <div>
          <label for="targetUnit">Unit</label>
          <select id="targetUnit">
            <option value="minutes">minutes</option>
            <option value="hours">hours</option>
            <option value="days" selected>days</option>
            <option value="years">years</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <a href="#" class="btn" onclick="compute();return false;">Compute</a>
        <a href="#" class="btn" onclick="startSim();return false;">Start Clock Sim</a>
        <a href="#" class="btn" onclick="stopSim();return false;">Stop</a>
        <a href="#" class="btn" onclick="resetAll();return false;">Reset</a>
      </div>

      <div class="row" style="margin-top:8px">
        <a href="#" class="btn" onclick="demoSolar();return false;">Try Solar Demo</a>
        <a href="#" class="btn" onclick="demoGalaxy();return false;">Try Galaxy Demo</a>
      </div>

      <div class="sep"></div>
      <p class="inline-note small">
        <strong>Stabilization ON</strong>: SR only (gravity effects minimized by route/field grooming) + CST time-lock (no display drift).<br>
        <strong>Stabilization OFF</strong>: Adds an <em>approximate</em> gravitational effect (deep-space clocks tick a hair faster than Earth) and an illustrative unsynchronized drift on the ship display. Proper time physics is unchanged.
      </p>
    </section>

    <!-- Results -->
    <section class="card">
      <h2>Results</h2>

      <div class="kpi">
        <div class="box"><h4>Coordinate Distance (L)</h4><p><span id="coordDist" class="num">—</span></p></div>
        <div class="box"><h4>Shortened Distance (L′ = L/warp)</h4><p><span id="shortDist" class="num">—</span></p></div>
        <div class="box"><h4>Earth-Frame Travel Time</h4><p><span id="earthTime" class="num">—</span></p></div>
        <div class="box"><h4>Ship Proper Time (SR only)</h4><p><span id="shipTimeSR" class="num">—</span></p></div>
        <div class="box"><h4>Apparent Speed (Earth-view)</h4><p><span id="vApp" class="num">—</span></p></div>
        <div class="box"><h4>Required Warp for Target T</h4><p><span id="warpReq" class="num">—</span></p></div>
      </div>

      <div class="sep"></div>

      <div class="compare">
        <div class="box">
          <h4>Effects Breakdown</h4>
          <p>SR effect (Earth − Ship<sub>SR</sub>): <span id="deltaSR" class="num ok">—</span> s</p>
          <p>Gravitational effect (approx., Ship faster in deep space): <span id="deltaGR" class="num">—</span> s</p>
          <p><strong>Net difference (Earth − Ship total):</strong> <span id="deltaNET" class="num">—</span> s</p>
          <p>Who ages more on the trip? <span id="whoAges" class="badge">—</span></p>
        </div>
        <div class="box">
          <h4>Traveler Age at Arrival</h4>
          <p>Earth frame: <span id="ageEarth" class="num">—</span></p>
          <p>Ship proper (SR + approx. GR): <span id="ageShip" class="num">—</span></p>
        </div>
      </div>

      <p class="inline-note small">
        <strong>Solar System speeds (≤192 km/s):</strong> v/c ≈ 0.000640 → γ ≈ 1.000000205 → seconds over months.  
        <strong>Galaxy Mode at high v (e.g., 0.9c):</strong> γ ≈ 2.294; ship ages ~1/γ relative to Earth during cruise.
      </p>
    </section>

    <!-- Clocks / Timeline -->
    <section class="card">
      <h2>Clocks & Timeline</h2>
      <p class="muted" style="margin-top:-6px">
        With stabilization ON, Earth UTC and CST align; Ship is kept in step (offset ≈ SR effect).  
        With stabilization OFF, an illustrative drift is added (no effect on proper time). For galaxy-scale trips, the sim won’t “reach arrival” (durations are immense)—use the numbers at left.
      </p>
      <div class="kpi">
        <div class="box"><h4>Earth UTC</h4><p class="clock"><span id="clkUTC">—</span></p></div>
        <div class="box"><h4>CST</h4><p class="clock"><span id="clkCST">—</span></p></div>
        <div class="box"><h4>Ship Clock</h4><p class="clock"><span id="clkShip">—</span></p></div>
        <div class="box"><h4>Ship − UTC Offset</h4><p class="clock"><span id="clkOffset" class="num">0.000 s</span></p></div>
      </div>

      <div class="sep"></div>
      <div class="kpi">
        <div class="box"><h4>Depart (UTC)</h4><p class="clock"><span id="departUTC">—</span></p></div>
        <div class="box"><h4>Arrive (UTC)</h4><p class="clock"><span id="arriveUTC">—</span></p></div>
      </div>
    </section>
  </div>

  <!-- How the model works (your two paragraphs) -->
  <section class="card" style="margin-top:16px">
    <h2>How the model works (plain)</h2>
    <p>In my model the ship never outruns light <em>locally</em>. We keep the craft at ordinary speeds and use <strong>Cosmic Standard Time (CST)</strong> to open and steer a <strong>curved tunnel</strong> through spacetime. That tunnel reduces the <em>coordinate</em> distance between departure and destination. So Earth measures a much shorter flight time, even though the ship’s local speed stays low. That’s why crew aging (proper time) stays essentially in step with Earth: small speed → <strong>negligible time dilation</strong>.</p>
    <p>Think of it like aviation great-circles or glass bending a light ray: you don’t make the ray “faster”; you give it a <strong>shorter path</strong>. CST is the timing/synchronization layer (atomic clocks + two-way links + celestial timing) that keeps the tunnel stable and the clocks locked, so we aren’t “cheating time,” we’re <strong>using geometry and timing</strong> to avoid the long way around.</p>
  </section>

  <!-- Math explanation + quick checks -->
  <section class="card">
    <h2>How the math shows it (simple)</h2>
    <div class="math">
      <p>Let \(L\) be the ordinary straight-line distance, \(W \ge 1\) the <em>warp factor</em> (path-shortening), so the effective path is \(L' = L/W\). Let \(v_{\text{local}}\) be the actual ship speed (e.g., 192 km/s). Then Earth-frame travel time is</p>
      <p class="mono">\( T_{\oplus} \approx \dfrac{L'}{v_{\text{local}}} = \dfrac{L}{W\,v_{\text{local}}} \)</p>
      <p>and the <em>apparent speed</em> is</p>
      <p class="mono">\( v_{\text{apparent}} = \dfrac{L}{T_{\oplus}} = W \cdot v_{\text{local}}. \)</p>
      <p>So if \(W\) is large enough, \(v_{\text{apparent}}\) can exceed \(c\) <em>without</em> the ship ever moving locally faster than light.</p>
    </div>
    <div class="callout" style="margin-top:10px">
      <h3 style="margin-top:0">Quick reality checks (what \(W\) must do)</h3>
      <ul>
        <li><strong>Alpha Centauri (4.37 ly)</strong> at 192 km/s: no tunnel → ~6,823 years.<br>
            Want <em>10 days</em>? need \(W \approx 2.49 \times 10^{5}\). • Want <em>1 day</em>? \(W \approx 2.49 \times 10^{6}\).</li>
        <li><strong>Andromeda (2.5 million ly)</strong> at 192 km/s: no tunnel → ~3.9 billion years.<br>
            Want <em>30 years</em>? need \(W \approx 1.3 \times 10^{8}\). • Want <em>10 days</em>? \(W \approx 1.43 \times 10^{11}\).</li>
      </ul>
      <p class="small"><strong>Bottom line:</strong> the tunnel’s path-shortening power \(W\) is the key lever. The claim isn’t “local FTL,” it’s “a very high-\(W\) corridor so a slow ship arrives on fast Earth timescales.”</p>
    </div>
    <div class="callout" style="margin-top:10px">
      <strong>Not cheating time—using geometry.</strong>
      Our ship cruises at modest local speed (e.g., 192 km/s). A CST-synchronized warp tunnel bends the route so the effective path is \(L' = L/W\).
      Earth then measures \(T_{\oplus} = L/(W\,v_{\text{local}})\). The apparent speed becomes \(v_{\text{apparent}} = W\,v_{\text{local}}\): it can exceed \(c\) without any local FTL or exotic matter in the cabin. Time dilation stays negligible because the ship’s local speed is low; CST keeps clocks locked so departure and arrival timestamps match. We’re not outrunning light—we’re not taking the long way.
    </div>
  </section>

  <!-- Dilation explainer -->
  <section class="card">
    <h2>What “time dilation” means here — and how CST keeps it tiny</h2>
    <ol>
      <li><strong>Special Relativity (SR):</strong> Moving clocks tick slightly <em>slower</em>. At Solar speeds like 192 km/s (0.064% c), γ − 1 ≈ 2.05×10⁻⁷ → only seconds of difference over months. At interstellar cruise (e.g., 0.9c), γ ≈ 2.294 → ship ages ~1/γ vs Earth during cruise.</li>
      <li><strong>Gravitational (GR, weak-field approx):</strong> Clocks in <em>weaker gravity</em> (deep space) tick slightly <em>faster</em> than on Earth’s surface by ~7×10⁻¹⁰. Over months that’s milliseconds; over millennia it can add noticeable time. In this demo, turning stabilization OFF adds an <em>approximate</em> GR term.</li>
      <li><strong>Path-shortening, not speed-up:</strong> “Warp” here means bending the route (distance ÷ warp). We keep local speeds modest and arrive sooner by not taking the long way.</li>
      <li><strong>CST time-lock:</strong> Atomic clocks + two-way laser links + pulsar timing keep Earth/CST/Ship clocks synchronized. Time-lock doesn’t change biology; it prevents operational clock drift.</li>
    </ol>
    <p class="inline-note"><strong>Bottom line:</strong> In-system, aging stays essentially in step with Earth. Across interstellar/galactic distances <em>without</em> warp, the problem is <strong>distance</strong>, not lethal dilation: crew proper time can be years or decades while Earth sees centuries to millions of years. With a CST-synchronized warp tunnel, you win by <strong>shortening the route</strong> while keeping local speeds—and dilation—modest.</p>
  </section>

  <footer>© <span id="yr"></span> CST Warp Geometry Demo. All math runs locally in your browser.</footer>
</div>

<script>
  // ---------- Constants ----------
  const C = 299_792_458;        // m/s
  const KM_PER_LY = 9.4607e12;  // km in one light-year
  const MS_IN_S = 1000;
  const SEC_PER_YEAR = 365.25*24*3600;

  // Approx gravitational rate difference: Earth surface vs deep space (~GM/rc^2)
  // Earth surface runs ~6.95e-10 slower than far-away clock.
  const EARTH_GR_FRAC = 6.95e-10;
  const GR_EXPOSURE_OFF = 0.8; // fraction of time effectively out of Earth’s well (illustrative)
  const DRIFT_RATE_OFF = 3e-8; // ~30 ns/s illustrative drift when not time-locked (display only)

  // Sim scale: 1 real second = 12 mission hours (fast-forward for clocks)
  const SIM_SCALE = 12*3600;

  // ---------- DOM helpers ----------
  const el = id => document.getElementById(id);
  const fmtNum = (n,d=3)=> n.toLocaleString(undefined,{maximumFractionDigits:d});
  const fmtSec = s => s.toLocaleString(undefined,{maximumFractionDigits:3});
  function fmtDuration(s){
    if (!isFinite(s) || s<=0) return "0 s";
    const yr = s/SEC_PER_YEAR;
    if (yr >= 1e6) return fmtNum(yr/1e6,3)+" Myr";
    if (yr >= 1)   return fmtNum(yr,6)+" years";
    const d = s/86400;
    if (d >= 2)    return fmtNum(d,3)+" days";
    const h = s/3600;
    if (h >= 1)    return fmtNum(h,3)+" hours";
    const m = s/60;
    if (m >= 1)    return fmtNum(m,3)+" minutes";
    return fmtSec(s)+" s";
  }
  function fmtDist(mode, km){
    if (mode === "solar") return fmtNum(km,0)+" km";
    // galaxy → convert to ly for display
    return fmtNum(km/KM_PER_LY,3)+" ly";
  }

  // ---------- State ----------
  let last = null;
  let timer = null;
  let simStartReal = null;
  let departUTCms = null;

  // ---------- UI visibility ----------
  function onModeChange(){
    const mode = el('mode').value;
    const solar = (mode === "solar");
    el('solarDest').style.display = solar ? "block":"none";
    el('galaxyDest').style.display = solar ? "none":"block";
    // default speed control: km/s for solar, fraction-c for galaxy
    if (solar){ el('spdKm').checked = true; onSpeedMode(); }
    else { el('spdFrac').checked = true; onSpeedMode(); }
  }
  function onSpeedMode(){
    const useKm = el('spdKm').checked;
    el('speedKmWrap').style.display = useKm ? "block":"none";
    el('speedFracWrap').style.display = useKm ? "none":"block";
  }

  // ---------- Helpers ----------
  function unitToSeconds(value, unit){
    const v = parseFloat(value);
    if (!isFinite(v) || v<=0) return NaN;
    switch(unit){
      case "minutes": return v*60;
      case "hours":   return v*3600;
      case "days":    return v*86400;
      case "years":   return v*SEC_PER_YEAR;
      default: return NaN;
    }
  }

  // ---------- Get inputs ----------
  function getDistanceKm(){
    const mode = el('mode').value;
    if (mode === "solar"){
      const custom = parseFloat(el('customKm').value);
      if (!isNaN(custom) && custom>0) return custom;
      return parseFloat(el('destSolar').value);
    } else {
      const customLy = parseFloat(el('customLy').value);
      const ly = (!isNaN(customLy) && customLy>0) ? customLy : parseFloat(el('destGalaxy').value);
      return ly * KM_PER_LY;
    }
  }
  function getSpeed_ms(){
    if (el('spdKm').checked){
      const kmps = parseFloat(el('speedKm').value);
      return kmps*1000;
    } else {
      const frac = parseFloat(el('speedFrac').value);
      return frac * C;
    }
  }

  // ---------- UI label updaters ----------
  function updateSpeedKmLabel(v){ el('speedKmLabel').textContent = v; }
  function updateSpeedFracLabel(v){ el('speedFracLabel').textContent = parseFloat(v).toFixed(2)+" c"; }
  function updateWarpLabel(v){ el('warpLabel').textContent = v; }

  // ---------- Core compute ----------
  function compute(){
    const mode = el('mode').value;
    const coordKm = getDistanceKm();
    const warp = parseInt(el('warp').value,10);
    const shortKm = coordKm / warp;

    const v_ms = getSpeed_ms();
    const gamma = 1/Math.sqrt(1 - Math.pow(v_ms/C,2));

    // Earth-frame travel time (seconds)
    const t_earth_s = (shortKm*1000) / v_ms;

    // Ship proper time (SR-only)
    const t_ship_SR_s = t_earth_s / gamma;
    const deltaSR_s = t_earth_s - t_ship_SR_s; // Earth - Ship_SR (positive if ship ages less)

    // GR approximate term (only if stabilization OFF)
    const stabilize = el('stabilize').checked;
    let t_gravity_s = 0;
    if (!stabilize){
      // deep-space clocks tick slightly faster; approximate fraction × Earth time
      t_gravity_s = GR_EXPOSURE_OFF * EARTH_GR_FRAC * t_earth_s;
    }

    // Net difference Earth − Ship_total
    const deltaNET_s = (t_earth_s - (t_ship_SR_s + t_gravity_s));

    // Who ages more?
    let who = "Essentially identical";
    if (Math.abs(deltaNET_s) >= 0.05){
      who = deltaNET_s > 0 ? "Earth ages more (Ship ages slightly less)" : "Ship ages more (rare at these speeds)";
    }

    // Traveler ages
    const age0 = parseFloat(el('age').value);
    const yrsEarth = t_earth_s / SEC_PER_YEAR;
    const yrsShip  = (t_ship_SR_s + t_gravity_s) / SEC_PER_YEAR;
    const ageEarthStr = isNaN(age0) ? (fmtNum(yrsEarth,6)+" years added") : (fmtNum(age0+yrsEarth,6)+" years");
    const ageShipStr  = isNaN(age0) ? (fmtNum(yrsShip,6)+" years added")  : (fmtNum(age0+yrsShip,6)+" years");

    // Apparent speed (Earth-view)
    const v_app_ms = v_ms * warp;
    const v_app_kmps = v_app_ms/1000;
    const v_app_frac_c = v_app_ms / C;

    // Required warp for target arrival T (using full coordinate L, not shortened)
    const targetSecs = unitToSeconds(el('targetTime').value, el('targetUnit').value);
    let warpRequired = NaN;
    if (isFinite(targetSecs) && targetSecs>0){
      warpRequired = (coordKm*1000) / (v_ms * targetSecs);
    }

    // Arrival times (only meaningful as relative for huge trips)
    const now = Date.now();
    departUTCms = now;
    const arriveUTCms = now + Math.min(t_earth_s*MS_IN_S, Number.MAX_SAFE_INTEGER); // for UI; not accurate for Myr spans

    // Update UI
    el('coordDist').textContent = fmtDist(el('mode').value, coordKm);
    el('shortDist').textContent = fmtDist(el('mode').value, shortKm);
    el('earthTime').textContent = fmtDuration(t_earth_s) + "  ("+fmtSec(t_earth_s)+" s)";
    el('shipTimeSR').textContent= fmtDuration(t_ship_SR_s) + "  ("+fmtSec(t_ship_SR_s)+" s)";
    el('deltaSR').textContent   = fmtSec(deltaSR_s);
    el('deltaGR').textContent   = stabilize ? "0.000" : (t_gravity_s.toFixed(3));
    el('deltaNET').textContent  = fmtSec(deltaNET_s);
    el('whoAges').textContent   = who;
    el('ageEarth').textContent  = ageEarthStr;
    el('ageShip').textContent   = ageShipStr;

    el('vApp').textContent = `${fmtNum(v_app_kmps,3)} km/s  (${fmtNum(v_app_frac_c,6)} c)`;
    el('warpReq').textContent = isFinite(warpRequired) ? (warpRequired<1 ? "≤ 1 (no warp needed)" : `≈ ${warpRequired.toExponential(3)} (×${fmtNum(warpRequired,0)})`) : "—";

    el('departUTC').textContent = new Date(departUTCms).toLocaleString();
    el('arriveUTC').textContent = (t_earth_s < 1e9) ? new Date(arriveUTCms).toLocaleString() : "— (too far in the future)";

    // Save state + resync hero clocks
    last = {mode, coordKm, shortKm, warp, v_ms, gamma, t_earth_s, t_ship_SR_s, t_gravity_s, deltaSR_s, deltaNET_s, stabilize, v_app_ms, warpRequired};
    syncClocks();
  }

  // ---------- Clocks simulation ----------
  function startSim(){
    stopSim();
    if (!last) compute();
    simStartReal = Date.now();
    timer = setInterval(()=>{
      const nowReal = Date.now();
      const realElapsed_s = (nowReal - simStartReal)/MS_IN_S;
      const missionElapsed_s = realElapsed_s * SIM_SCALE;

      // Outside clocks (UTC & CST) advance identically
      const utc_ms = (departUTCms ?? nowReal) + missionElapsed_s*MS_IN_S;
      const cst_ms = utc_ms;

      // Inside (Ship): SR proper time + optional small GR speed-up
      const gamma = last?.gamma ?? 1;
      let ship_ms = (departUTCms ?? nowReal) + (missionElapsed_s/gamma)*MS_IN_S;

      if (!last?.stabilize){
        // add approximate GR speed-up
        const gr_ms = GR_EXPOSURE_OFF * EARTH_GR_FRAC * missionElapsed_s * MS_IN_S;
        ship_ms += gr_ms;
        // illustrative unsynchronized drift (display only)
        const drift_ms = missionElapsed_s * DRIFT_RATE_OFF * MS_IN_S;
        ship_ms -= drift_ms;
      }

      // Update clocks
      el('clkUTC').textContent  = new Date(utc_ms).toLocaleString();
      el('clkCST').textContent  = new Date(cst_ms).toLocaleString();
      el('clkShip').textContent = new Date(ship_ms).toLocaleString();
      el('clkOffset').textContent = ( (utc_ms - ship_ms)/MS_IN_S ).toFixed(3) + " s";

      el('heroUTC').textContent  = new Date(utc_ms).toLocaleString();
      el('heroCST').textContent  = new Date(cst_ms).toLocaleString();
      el('heroShip').textContent = new Date(ship_ms).toLocaleString();
      el('heroOffset').textContent = ( (utc_ms - ship_ms)/MS_IN_S ).toFixed(3) + " s";

      // For galaxy spans we don't auto-stop; for shorter trips, stop at arrival
      const end_s = last?.t_earth_s ?? 0;
      if (end_s>0 && end_s < 3.15e9 /* ~100 years */ && missionElapsed_s >= end_s){ stopSim(); }
    }, 1000);
  }
  function stopSim(){ if (timer){ clearInterval(timer); timer=null; } }
  function syncClocks(){
    const now = Date.now();
    ["clkUTC","clkCST","clkShip","heroUTC","heroCST","heroShip"].forEach(id=>{
      el(id).textContent = new Date(now).toLocaleString();
    });
    ["clkOffset","heroOffset"].forEach(id=>{ el(id).textContent = "0.000 s"; });
  }

  // ---------- Presets & reset ----------
  function demoSolar(){
    el('mode').value = "solar"; onModeChange();
    el('destSolar').value = "5.46e7"; // Mars
    el('customKm').value = "";
    el('age').value = "58.0";
    el('spdKm').checked = true; onSpeedMode();
    el('speedKm').value = 192; updateSpeedKmLabel(192);
    el('warp').value = 8; updateWarpLabel(8);
    el('stabilize').checked = true;
    el('targetTime').value = 5; el('targetUnit').value = "days";
    compute(); startSim();
  }
  function demoGalaxy(){
    el('mode').value = "galaxy"; onModeChange();
    el('destGalaxy').value = "2500000"; // Andromeda
    el('customLy').value = "";
    el('age').value = "58.0";
    el('spdFrac').checked = true; onSpeedMode();
    el('speedFrac').value = 0.90; updateSpeedFracLabel(0.90);
    el('warp').value = 10; updateWarpLabel(10);
    el('stabilize').checked = true;
    el('targetTime').value = 30; el('targetUnit').value = "years";
    compute(); startSim();
  }
  function resetAll(){
    el('mode').value = "solar"; onModeChange();
    el('destSolar').value = "5.46e7";
    el('customKm').value = "";
    el('destGalaxy').value = "4.37";
    el('customLy').value = "";
    el('age').value = "";
    el('spdKm').checked = true; onSpeedMode();
    el('speedKm').value = 192; updateSpeedKmLabel(192);
    el('speedFrac').value = 0.90; updateSpeedFracLabel(0.90);
    el('warp').value = 8; updateWarpLabel(8);
    el('stabilize').checked = true;
    el('targetTime').value = 10; el('targetUnit').value = "days";
    [
      "coordDist","shortDist","earthTime","shipTimeSR","deltaSR","deltaGR","deltaNET",
      "ageEarth","ageShip","departUTC","arriveUTC","vApp","warpReq","whoAges"
    ].forEach(id=>el(id).textContent="—");
    stopSim(); syncClocks();
  }

  // ---------- Init ----------
  document.getElementById('yr').textContent = new Date().getFullYear();
  updateSpeedKmLabel(192); updateSpeedFracLabel(0.90); updateWarpLabel(8);
  onModeChange(); compute(); syncClocks();
</script>
</body>
</html>
