<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Warp Engine ‚Äî Safety & Negative-Pulse Console</title>
<style>
  :root{
    --bg:#070b12; --panel:#0c1424; --glass:#0d1a31cc; --edge:#27406b;
    --text:#eaf2ff; --muted:#a7b9df; --good:#22c55e; --warn:#facc15; --bad:#ef4444;
    --accent:#60a5fa; --accent2:#22d3ee; --purple:#a78bfa;
    --ui:1; --gap: clamp(12px, 3.5vw, 30px); --pad:10px; --fs:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    font-size:var(--fs); color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, #112240 0%, transparent 60%),
      radial-gradient(900px 900px at 120% -20%, #0b1b33 0%, transparent 50%),
      var(--bg);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{ max-width:1400px; margin:0 auto; padding:var(--pad); display:grid; gap:var(--gap) }
  .hdr{ display:flex; align-items:center; justify-content:space-between; gap:10px }
  h1{ margin:.25rem 0; font-weight:800; letter-spacing:.3px }
  .badge{border:1px solid #3b4f77;border-radius:999px;padding:3px 10px;color:#93c5fd;background:#0b1220;white-space:nowrap}

  .grid3{ display:grid; grid-template-columns: 320px 1fr 340px; gap:var(--gap); align-items:start }
  @media (max-width:1150px){ .grid3{ grid-template-columns: 1fr; } }

  .panel{background:linear-gradient(180deg,#0b1528aa,#0b152880),radial-gradient(600px 200px at 20% -30%,#15305f55,transparent 60%);
         backdrop-filter:blur(6px); border:1px solid var(--edge); border-radius:14px; padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.42)}
  .panel h2{ margin:.3rem 0 .7rem }
  .sub{ color:var(--muted); font-size:.9rem }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .stack{ display:grid; gap:10px }
  .kv{ color:#cfe2ff; font-size:.9rem; display:grid; grid-template-columns:auto 1fr; gap:6px 10px }
  .pill{ display:inline-block; padding:.15rem .5rem; border:1px solid #36507d; border-radius:999px; color:#a5f3fc; font-size:.8rem }
  .legend{ color:var(--muted); font-size:.86rem; margin-top:6px }

  label{ color:#a7b9df; font-size:.95rem; display:grid; gap:6px }
  input[type="range"], select, input[type="number"]{
    width:100%; background:#0b1220; color:#eaf2ff; border:1px solid #34425f; border-radius:8px; padding:6px 8px;
  }
  input[type="checkbox"]{ transform:translateY(1px) }
  .btn{ background:#1b2a44; border:1px solid #304166; color:#e6eefc; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:#00ccff; color:#00131a; border:none; font-weight:700 }
  .btn.warn{ background:#fb923c; border:none; color:#0e0a00 }
  .btn.ghost{ background:#0b1220; border:1px solid #3a4e79 }
  .btn:active{ transform:translateY(1px) }

  .lights{ display:flex; gap:8px; flex-wrap:wrap }
  .light{ display:flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; border:1px solid #334155; background:#0b1220; font-size:.85rem }
  .dot{ width:9px; height:9px; border-radius:50% }
  .good .dot{ background:var(--good) } .warn .dot{ background:var(--warn) } .bad .dot{ background:var(--bad) }

  .meters{ display:grid; gap:8px }
  .meter{ display:flex; align-items:center; gap:10px }
  .bar{ height:9px; flex:1; background:#0b1220; border:1px solid #334155; border-radius:6px; overflow:hidden }
  .fill{ height:100%; background:linear-gradient(90deg,#60a5fa,#22d3ee); width:0% }
  .stat{ color:#cfe2ff; font-variant-numeric:tabular-nums; font-size:.9rem }

  canvas{ display:block; width:100%; background:linear-gradient(180deg,#091323,#0a1322); border:1px solid #2b3a5a; border-radius:12px }
  #core{ height:360px }
  #gr{ height:120px }
  #scope{ height:140px }
  .tele{ display:grid; grid-template-columns: repeat(5,1fr); gap:8px; margin-top:6px }
  .tile{ background:#0b1220; border:1px solid #304166; border-radius:10px; padding:6px 8px; display:grid; gap:4px }
  .tile .lbl{ color:#9fb4d9; font-size:.82rem } .tile .val{ font-weight:700 }
</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h1>üõ∞Ô∏è Warp Engine Console</h1>
      <div class="row">
        <span class="badge">v4.0 ‚Ä¢ Safety-first</span>
        <span class="badge">Sim-only exotic pulses (with payback)</span>
      </div>
    </div>

    <section class="grid3">
      <!-- LEFT: Controls -->
      <div class="panel stack">
        <h2>Controls</h2>

        <div class="row">
          <button class="btn primary" id="engageBtn">ENGAGE</button>
          <button class="btn" id="stopBtn">Stop</button>
          <button class="btn warn" id="resetBtn">Reset</button>
          <span class="pill" id="runPill">Idle</span>
        </div>

        <label>Reactor Output (MW)
          <input id="reactorMW" type="range" min="1000" max="10000" step="100" value="5000">
        </label>
        <div class="meters">
          <div class="meter"><span class="stat" style="width:120px">Field Coils</span><div class="bar"><div id="mCoils" class="fill"></div></div><span class="stat" id="mCoilsVal">‚Äî</span></div>
          <div class="meter"><span class="stat" style="width:120px">Containment</span><div class="bar"><div id="mContain" class="fill"></div></div><span class="stat" id="mContainVal">‚Äî</span></div>
          <div class="meter"><span class="stat" style="width:120px">Vectoring</span><div class="bar"><div id="mVanes" class="fill"></div></div><span class="stat" id="mVanesVal">‚Äî</span></div>
        </div>

        <div class="row" style="margin-top:6px">
          <label style="flex:1">Front Contraction %
            <input id="frontPct" type="range" min="0" max="100" value="40">
          </label>
          <label style="flex:1">Rear Expansion %
            <input id="rearPct" type="range" min="0" max="100" value="60">
          </label>
        </div>

        <div class="row">
          <label style="flex:1">Left / Right Bias %
            <input id="lrBias" type="range" min="-50" max="50" value="0">
          </label>
          <label style="flex:1">Up / Down Bias %
            <input id="udBias" type="range" min="-50" max="50" value="0">
          </label>
        </div>

        <div class="panel" style="padding:10px">
          <div class="row" style="justify-content:space-between">
            <label class="badge"><input id="safeClamp" type="checkbox" checked> Safety clamp</label>
            <label class="badge"><input id="autoBal" type="checkbox"> Auto-balance</label>
            <button class="btn ghost" id="balanceBtn">Balance now</button>
          </div>
          <div class="lights" style="margin-top:8px">
            <div class="light good" id="L_bubble"><span class="dot"></span>Bubble</div>
            <div class="light good" id="L_contain"><span class="dot"></span>Containment</div>
            <div class="light good" id="L_stab"><span class="dot"></span>Stability</div>
            <div class="light good" id="L_qi"><span class="dot"></span>NEC/WEC</div>
          </div>
        </div>

        <div class="kv">
          <div>Containment reserve</div><div id="kv_res">‚Äî</div>
          <div>Stability</div><div id="kv_stab">‚Äî</div>
          <div>Jitter</div><div id="kv_jit">‚Äî</div>
          <div>g<sub>tt</sub> min</div><div id="kv_gtt">‚Äî</div>
        </div>
      </div>

      <!-- CENTER: Engine Core + Scope -->
      <div class="panel">
        <h2>Engine Core</h2>
        <div class="sub">Visual bubble + anisotropy + pulses</div>
        <canvas id="core"></canvas>
        <div class="tele">
          <div class="tile"><div class="lbl">v cap</div><div class="val" id="vCap">‚Äî</div></div>
          <div class="tile"><div class="lbl">Œ≤ (visual)</div><div class="val" id="betaVal">‚Äî</div></div>
          <div class="tile"><div class="lbl">gf</div><div class="val" id="gfVal">‚Äî</div></div>
          <div class="tile"><div class="lbl">œÅ<sub>ren</sub> offset</div><div class="val" id="rhoVal">‚Äî</div></div>
          <div class="tile"><div class="lbl">Status</div><div class="val" id="statusVal">Idle</div></div>
        </div>

        <h2 style="margin-top:14px">GR Mini & Pulse Scope</h2>
        <div class="row" style="gap:12px; flex-wrap:wrap">
          <div class="pill">Exotic pulses are fictional & compensated</div>
          <div class="pill" id="necPill">NEC/WEC: ‚úÖ</div>
        </div>
        <canvas id="gr"></canvas>
        <canvas id="scope"></canvas>
        <div class="legend" id="legend">‚Äî</div>
      </div>

      <!-- RIGHT: Exotic Controls (fictional), Mirrors + Crystals + Magnets -->
      <div class="panel stack">
        <h2>Mirror / Crystal / Magnet</h2>
        <div class="sub">Band-limited ‚Äúmirror‚Äù suppression + squeezed pulses + magnetic stabilization (visual only)</div>

        <label>Mirror Suppression S
          <input id="mirrorS" type="range" min="0" max="1" step="0.01" value="0.25">
        </label>
        <label>Squeezing Depth r
          <input id="sqDepth" type="range" min="0" max="1" step="0.01" value="0.35">
        </label>
        <label>Pulse Cadence (Hz)
          <input id="cadence" type="range" min="0.2" max="4" step="0.1" value="1.2">
        </label>
        <label>Window œÑ (ms)
          <input id="tauMs" type="range" min="15" max="240" step="5" value="90">
        </label>
        <label>Magnetic Stabilization
          <input id="magStab" type="range" min="0" max="1" step="0.01" value="0.4">
        </label>

        <div class="row" style="justify-content:space-between">
          <label class="badge"><input id="honorQI" type="checkbox" checked> Honor quantum inequalities</label>
          <label class="badge"><input id="storyMode" type="checkbox"> Story mode (soft cap)</label>
        </div>

        <div class="legend">This panel is a **visual model**: negative pulses are local/brief and auto-compensated by a positive ‚Äúpayback‚Äù lobe. No real negative energy is created.</div>
      </div>
    </section>
  </div>

<script>
/* ===== helpers ===== */
const $=id=>document.getElementById(id);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const tone=(hz=660,ms=140)=>{
  try{
    const ac=new (window.AudioContext||window.webkitAudioContext)();
    const o=ac.createOscillator(), g=ac.createGain();
    o.type="sine"; o.frequency.value=hz; g.gain.value=.0008;
    o.connect(g).connect(ac.destination); o.start();
    g.gain.exponentialRampToValueAtTime(.06,ac.currentTime+.02);
    g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+ms/1000);
    o.stop(ac.currentTime+ms/1000+0.02);
  }catch{}
};
function setLight(el,level){ el.classList.remove("good","warn","bad"); el.classList.add(level); }

/* ===== state ===== */
let running=false, last=performance.now(), t=0;
const engine={ temp:0, sag:0, jitter:0 };
let lastPhysics={ gf:.5, vcap_c:.5, gttMin:.1, beta:0, rhoRen:0, necOK:true };

/* ===== canvases ===== */
const core=$("core"), gr=$("gr"), scope=$("scope");
const coreX=core.getContext("2d"), grX=gr.getContext("2d"), scX=scope.getContext("2d");

/* ===== input getters ===== */
function inputs(){
  return {
    reactorMW: Number($("reactorMW").value),
    front: Number($("frontPct").value)/100,
    rear:  Number($("rearPct").value)/100,
    lr: Number($("lrBias").value)/100,
    ud: Number($("udBias").value)/100,
    S: Number($("mirrorS").value),
    r: Number($("sqDepth").value),
    hz: Number($("cadence").value),
    tau: Number($("tauMs").value)/1000,
    mstab: Number($("magStab").value),
    clamp: $("safeClamp").checked,
    autob: $("autoBal").checked,
    honorQI: $("honorQI").checked,
    story: $("storyMode").checked
  };
}

/* ===== power allocation + stability (simple, visual) ===== */
function powerAlloc(reacMW, vecDemand, containNeed){
  let coils=clamp(0.55-0.25*vecDemand, 0.30, 0.65);
  let contain=Math.max(containNeed,0.22);
  let vanes=clamp(1-coils-contain,0.10,0.40);
  const sum=coils+contain+vanes; if(sum>1){ const k=1/sum; coils*=k; contain*=k; vanes*=k; }
  $("mCoils").style.width=`${(coils*100).toFixed(0)}%`;
  $("mContain").style.width=`${(contain*100).toFixed(0)}%`;
  $("mVanes").style.width=`${(vanes*100).toFixed(0)}%`;
  $("mCoilsVal").textContent = `${(coils*reacMW).toFixed(0)} MW`;
  $("mContainVal").textContent= `${(contain*reacMW).toFixed(0)} MW`;
  $("mVanesVal").textContent  = `${(vanes*reacMW).toFixed(0)} MW`;
  return {coils,contain,vanes};
}

/* ===== engine dynamics (visual) ===== */
function step(dt){
  const I=inputs();
  // heat & sag
  if(running){
    engine.temp = clamp(engine.temp + 0.7*dt, 0, 1);
    engine.sag  = clamp(engine.sag  + 0.45*dt, 0, 0.6);
  } else {
    engine.temp = clamp(engine.temp - 0.9*dt, 0, 1);
    engine.sag  = clamp(engine.sag  - 0.6*dt, 0, 0.6);
  }
  // jitter from bias + randomness
  const biasMag=Math.hypot(I.lr,I.ud);
  engine.jitter = clamp(0.01 + 0.03*biasMag + 0.02*Math.sin(3*t) + 0.01*(Math.random()-0.5), 0, 0.09);

  // demand and allocation
  const vecDemand = clamp(0.4 + 0.6*(Math.abs(I.rear-I.front)+biasMag), 0, 1);
  const containNeed = 0.22 + 0.06*engine.temp;
  const alloc = powerAlloc(I.reactorMW*(1-engine.sag), vecDemand, containNeed);

  // stability index (0..1)
  let stability = 1.0;
  if(alloc.contain < containNeed) stability -= 0.40*(containNeed-alloc.contain)/containNeed;
  stability -= 0.30*Math.max(0,biasMag-0.3)/0.7;
  if(I.rear < I.front) stability -= 0.20*(I.front-I.rear);
  stability -= engine.jitter;
  stability = clamp(stability,0,1);

  // exotic pulses (fictional, compensated)
  const phase = Math.sin(2*Math.PI*I.hz*t);
  const neg = Math.exp(-Math.pow((phase-0.0)/ (I.tau*I.hz*2.2+1e-3),2));
  const pos = Math.exp(-Math.pow((phase-0.35)/ (I.tau*I.hz*2.2+1e-3),2));
  const epsCas = 0.015;                // tiny static offset scale
  const epsSq  = 0.12;                 // squeezed pulse scale
  const kPay   = I.honorQI ? 1.35 : 1; // payback factor
  let rhoRen = -epsCas*I.S + (-epsSq*I.r*neg) + (kPay*epsSq*I.r*pos); // renormalized offset (visual)
  if(I.honorQI && rhoRen < -0.18) rhoRen = -0.18; // guardrail

  // gradient factor & speed cap (visual)
  const gf_base = 0.45 + 0.25*(I.S) + 0.15*I.mstab;
  let gf = clamp(gf_base + (rhoRen<0? 0.12*I.r*neg : -0.10*I.r*pos), 0.05, 1.0);
  gf *= (1 - 0.4*(1-stability)); // poor stability reduces effective gradient

  // visual g_tt min proxy
  let gttMin = clamp(0.08 + 0.9*(1 - (I.front*0.6 - I.rear*0.3 + 0.5*biasMag)), 0.001, 1.2);
  if(rhoRen<0) gttMin *= 0.95; // dips slightly during negative lobe

  // cap < c, soft relax in Story mode during negative lobe
  let vcap_c = clamp(0.10 + 0.45*(1 - Math.exp(-(I.reactorMW/6000))) + 0.25*gf, 0.05, 0.95);
  vcap_c *= (0.45 + 0.55*stability);
  if(I.story && rhoRen<0) vcap_c = Math.min(0.99, vcap_c + 0.06*I.r*neg);

  const beta = clamp(vcap_c * (0.6 + 0.35*Math.sin(t*0.8)) , 0, 0.99);
  const necOK = (rhoRen >= 0); // show NEC/WEC only when negative lobe hits

  lastPhysics = { gf, vcap_c, gttMin, beta, rhoRen, necOK, stability, containReserve:(alloc.contain-containNeed) };
}

/* ===== visuals ===== */
function drawCore(){
  const w=core.width=core.clientWidth, h=core.height=core.clientHeight, cx=w/2, cy=h/2;
  const ctx=coreX; ctx.clearRect(0,0,w,h);

  // starflow background
  const streak = 6 + 26*lastPhysics.beta;
  for(let i=0;i<90;i++){
    const x = (Math.random()*w)|0, y = (Math.random()*h)|0;
    const len = 4 + Math.random()*streak;
    ctx.strokeStyle=`rgba(180,220,255,${0.05+0.15*Math.random()})`;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x, y-len); ctx.stroke();
  }

  // bubble glow
  const R = 60 + 18*lastPhysics.gf;
  const glow=ctx.createRadialGradient(cx,cy,R*0.5, cx,cy,R+26);
  glow.addColorStop(0,`rgba(120,220,255,${0.18+0.24*lastPhysics.gf})`);
  glow.addColorStop(1,"rgba(80,180,255,0.02)");
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(cx,cy,R+26,0,Math.PI*2); ctx.fill();

  // anisotropy vectors (front / rear / LR / UD)
  const I=inputs(); const k= Math.min(50, h*0.18);
  const arrow=(dx,dy,col)=>{const L=Math.hypot(dx,dy)||1; const ux=dx/L, uy=dy/L;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+dx,cy+dy); ctx.strokeStyle=col; ctx.lineWidth=2; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx+dx,cy+dy);
    ctx.lineTo(cx+dx-8*ux+3*uy, cy+dy-8*uy-3*ux);
    ctx.lineTo(cx+dx-8*ux-3*uy, cy+dy-8*uy+3*ux);
    ctx.closePath(); ctx.fillStyle=col; ctx.fill();
  };
  arrow(0,  -k*I.rear, "#22c55e");
  arrow(0,   k*I.front,"#f97316");
  arrow( k*I.lr, 0,    "#8b5cf6");
  arrow( 0, -k*I.ud,   "#38bdf8");

  // core ring and ship
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.strokeStyle="#7dd3fc"; ctx.lineWidth=1.6; ctx.stroke();
  ctx.save(); ctx.translate(cx,cy+3); ctx.beginPath(); ctx.moveTo(0,-18); ctx.lineTo(11,14); ctx.lineTo(-11,14); ctx.closePath(); ctx.fillStyle="#e6eefc"; ctx.fill(); ctx.restore();

  // negative pulse halo (purple/cyan), payback (gold)
  if(lastPhysics.rhoRen<0){
    ctx.beginPath(); ctx.arc(cx,cy,R+8,0,Math.PI*2);
    ctx.strokeStyle="rgba(167,139,250,0.7)"; ctx.lineWidth=3.2; ctx.stroke();
  } else if (lastPhysics.rhoRen>0.03){
    ctx.beginPath(); ctx.arc(cx,cy,R+8,0,Math.PI*2);
    ctx.strokeStyle="rgba(250,204,21,0.45)"; ctx.lineWidth=3.2; ctx.stroke();
  }
}

function drawGR(){
  const w=gr.width=gr.clientWidth, h=gr.height=gr.clientHeight, ctx=grX;
  ctx.clearRect(0,0,w,h);
  // centerline color bar: map rhoRen
  for(let x=0;x<w;x++){
    const t=x/w;
    // synthetic potential slice
    const v = Math.sin(4*Math.PI*t + t*2) * 0.2 + lastPhysics.rhoRen*0.8;
    const vv = clamp((v+0.6)/1.2,0,1);
    const r = Math.floor(255*Math.max(0, 2*vv-1));
    const b = Math.floor(255*Math.max(0, 1-2*vv));
    ctx.fillStyle=`rgb(${r},${(vv*40)|0},${b})`;
    ctx.fillRect(x,0,1,h);
  }
  // g_tt gauge
  const g=lastPhysics.gttMin;
  ctx.fillStyle="#0b1220"; ctx.fillRect(0,h-20,w,20);
  ctx.fillStyle="#9fb4d9"; ctx.fillText(`g_tt min ${g.toFixed(4)} ‚Ä¢ NEC/WEC ${lastPhysics.necOK?"OK":"VIOLATED (pulse)"}`, 8,h-6);
}

const scopeBuf = new Array(600).fill(0);
function drawScope(){
  const w=scope.width=scope.clientWidth, h=scope.height=scope.clientHeight, ctx=scX;
  // shift & push value
  scopeBuf.shift(); scopeBuf.push(lastPhysics.rhoRen);
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle="#3b82f6"; ctx.lineWidth=2; ctx.beginPath();
  for(let i=0;i<scopeBuf.length;i++){
    const x=i*(w/(scopeBuf.length-1));
    const y= h/2 - scopeBuf[i]*h*0.42;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  // midline
  ctx.strokeStyle="rgba(255,255,255,.15)"; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
}

/* ===== UI updates ===== */
function updateUI(){
  // text tiles
  $("vCap").textContent  = (lastPhysics.vcap_c).toFixed(2)+" c";
  $("betaVal").textContent = lastPhysics.beta.toFixed(2);
  $("gfVal").textContent = lastPhysics.gf.toFixed(2);
  $("rhoVal").textContent = (lastPhysics.rhoRen>=0?"+":"")+ lastPhysics.rhoRen.toFixed(3);
  $("necPill").textContent = `NEC/WEC: ${lastPhysics.necOK?"‚úÖ":"‚ùå"}`;

  // kvs
  $("kv_res").textContent = (lastPhysics.containReserve>=0?"+":"")+ (lastPhysics.containReserve*100).toFixed(0) + "%";
  $("kv_stab").textContent = (lastPhysics.stability).toFixed(2);
  $("kv_jit").textContent = (engine.jitter).toFixed(2);
  $("kv_gtt").textContent = (lastPhysics.gttMin).toFixed(5);

  // lights
  setLight($("L_bubble"), lastPhysics.gttMin<=0.01?"bad": lastPhysics.gttMin<0.05?"warn":"good");
  setLight($("L_contain"), lastPhysics.containReserve<0?"bad": lastPhysics.containReserve<0.02?"warn":"good");
  setLight($("L_stab"), lastPhysics.stability<0.35?"bad": lastPhysics.stability<0.60?"warn":"good");
  setLight($("L_qi"), lastPhysics.necOK?"good":"warn");

  // status line
  const I=inputs();
  $("statusVal").textContent = running? (lastPhysics.necOK?"Cruise":"Pulse") : "Idle";
  $("legend").textContent = `Mirror S=${I.S.toFixed(2)} ‚Ä¢ r=${I.r.toFixed(2)} ‚Ä¢ cadence=${I.hz.toFixed(1)} Hz ‚Ä¢ œÑ=${(I.tau*1000).toFixed(0)} ms ‚Ä¢ m-stab=${I.mstab.toFixed(2)}`;
}

/* ===== loop ===== */
function loop(now){
  const dt=Math.min(0.05,(now-last)/1000); last=now; if(running) t+=dt;
  step(dt); drawCore(); drawGR(); drawScope(); updateUI();
  requestAnimationFrame(loop);
}

/* ===== actions ===== */
function balanceNow(){
  const front=$("frontPct"), rear=$("rearPct"), lr=$("lrBias"), ud=$("udBias");
  front.value = String(clamp(Number(front.value), 25, 55));
  rear.value  = String(clamp(Number(rear.value),  50, 75));
  lr.value="0"; ud.value="0";
  // small reactor bump if reserve negative
  if(lastPhysics.containReserve<0){
    $("reactorMW").value = String(Math.min(10000, Math.round(Number($("reactorMW").value)*1.05)));
  }
}

$("engageBtn").onclick=()=>{
  running=true; $("runPill").textContent="Running"; $("runPill").style.background="#16a34a22"; tone(880,150);
};
$("stopBtn").onclick=()=>{ running=false; $("runPill").textContent="Paused"; $("runPill").style.background="#facc1522"; tone(520,140); };
$("resetBtn").onclick=()=>{ running=false; t=0; engine.temp=0; engine.sag=0; engine.jitter=0; $("runPill").textContent="Idle"; $("runPill").style.background=""; tone(360,150); };
$("balanceBtn").onclick=balanceNow;

// gentle safety clamps during update cycle
function safetyGuard(){
  const I=inputs();
  if(!I.clamp) return;
  // if g_tt gets small, ease front a touch
  if(lastPhysics.gttMin<0.05){
    const f=$("frontPct"); f.value = String(Math.max(10, Number(f.value)-1));
  }
  // if cap is very low or stability poor, trim biases
  if(lastPhysics.vcap_c<0.30 || lastPhysics.stability<0.40){
    for(const id of ["lrBias","udBias"]){
      const el=$(id); const v=Number(el.value);
      if(v!==0) el.value = String(Math.round(v*0.8));
    }
  }
  // auto-balance option
  if(I.autob && lastPhysics.stability<0.55) balanceNow();
}

// tick safety guard on an interval
setInterval(safetyGuard, 400);

/* ===== init ===== */
requestAnimationFrame(loop);
</script>
</body>
</html>
