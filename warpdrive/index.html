<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warp Drive Demo — CST Synced</title>
  <style>
    :root {
      --bg:#0d1117; --panel:#161b22; --accent:#59d; --accent2:#9cf; --text:#e6edf3; --muted:#94a3b8;
      --ok:#16a34a; --warn:#eab308; --bad:#ef4444; --shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1000px 800px at 20% -10%, #0a0f1a 0%, #0d1117 60%);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #222}
    header h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.5px}
    .container{display:grid;grid-template-columns: 340px 1fr 380px;gap:16px;padding:16px}
    .panel{background:var(--panel);border:1px solid #222;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .panel h2{margin:0 0 10px 0;font-size:15px;font-weight:700;color:var(--accent2);text-transform:uppercase;letter-spacing:.08em}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    select,input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3340;background:#0f1420;color:var(--text)}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    button{cursor:pointer;border:1px solid #2a3340;background:linear-gradient(180deg,#1b2333,#141b28);color:var(--text);padding:12px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
    button.primary{border-color:#2b4ea3;background:linear-gradient(180deg,#2b4ea3,#1b2f66)}
    button.ghost{background:transparent}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
    .metric{background:#0f1420;border:1px solid #232a36;border-radius:12px;padding:10px;text-align:center}
    .metric .label{font-size:12px;color:var(--muted)}
    .metric .value{font-size:18px;font-weight:800;margin-top:4px}
    #log{height:260px;overflow:auto;background:#0a0f1a;border:1px dashed #2a3340;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
    .grid-rows{display:grid;gap:16px}
    .map{position:relative;height:380px;border-radius:12px;border:1px solid #232a36;background:radial-gradient(600px 300px at 20% 10%, rgba(88,122,255,.18), transparent 60%), linear-gradient(180deg,#0b0f19,#0a0e16)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3340;background:#0f1420;color:var(--muted)}
    .badge.ok{color:#b7f7c1;border-color:#14532d;background:linear-gradient(180deg,#0c1b11,#0b1510)}
    .badge.warn{color:#fff0b4;border-color:#7a5c05;background:linear-gradient(180deg,#1b1709,#141004)}
    .badge.bad{color:#ffc4c4;border-color:#7a1f1f;background:linear-gradient(180deg,#1b0c0c,#140808)}
    .flex{display:flex;gap:10px;align-items:center}
    .right{justify-content:flex-end}
    footer{padding:12px 16px;color:var(--muted);font-size:12px;border-top:1px solid #222}
    .saved-tag{display:inline-block;background:#0f1420;border:1px solid #2a3340;border-radius:8px;padding:4px 8px;margin:4px;font-size:12px}

    /* Saved Missions scroll box */
    #savedBox{
      height:260px; overflow-y:auto; background:#0a0f1a; border:1px dashed #2a3340; border-radius:10px; padding:10px;
      scrollbar-color:#2a3340 #0a0f1a; scrollbar-width:thin;
    }
    #savedBox::-webkit-scrollbar { width: 10px; }
    #savedBox::-webkit-scrollbar-track { background:#0a0f1a; }
    #savedBox::-webkit-scrollbar-thumb { background:#2a3340; border-radius:8px; }
    #savedBox::-webkit-scrollbar-thumb:hover { background:#3a4558; }

    /* Canvas fills map */
    #starCanvas{position:absolute; inset:0; width:100%; height:100%; display:block; border-radius:12px}

    /* Small heading overlay on the map */
    .headingOverlay{
      position:absolute; top:8px; left:50%; transform:translateX(-50%);
      font-weight:900; font-size:26px; letter-spacing:1px;
      color:#e6f0ff; text-shadow:0 2px 8px rgba(0,0,0,.55);
      background:rgba(10,14,22,.35); border:1px solid #223; padding:6px 12px; border-radius:12px;
    }

    /* Big heading above the map */
    .bigHeading {
      width:100%; text-align:center; font-size:56px; font-weight:900; letter-spacing:1px;
      color:#e8f0ff; text-shadow:0 6px 20px rgba(0,0,0,.6); margin:-2px 0 6px 0;
    }

    /* Ops strip */
    .ops {display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .lights {display:flex;gap:12px;flex-wrap:wrap}
    .light {display:flex;align-items:center;gap:8px;background:#0f1420;border:1px solid #232a36;border-radius:999px;padding:6px 10px}
    .dot {width:12px;height:12px;border-radius:50%}
    .dot.ok {background:var(--ok)}
    .dot.warn {background:var(--warn)}
    .dot.bad {background:var(--bad)}
    .name {font-size:12px;color:#cdd6e3}
    .route {font-size:12px;color:#94a3b8;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .route strong {color:#e6edf3}
    .kv {display:inline-flex;gap:6px;align-items:center}
    .kv label{font-size:12px;color:#94a3b8}
    .kv .val{font-size:12px;color:#e6edf3}

    .mode {display:flex;align-items:center;gap:8px;margin-top:8px}
    .mode .scale {width:100%}
  </style>
</head>
<body>
  <header>
    <h1>Warp Drive Demonstrator · CST-Synced Equilibrium</h1>
    <div class="flex right">
      <span id="cstBadge" class="badge ok">CST Sync: <strong id="cstClock">--:--:--</strong></span>
      <span id="rhythmBadge" class="badge ok">Bio Rhythm: Stable</span>
    </div>
  </header>

  <main class="container">
    <!-- Left: Controls -->
    <section class="panel">
      <h2>Controls</h2>
      <label for="warp">Warp Factor (1–10)</label>
      <select id="warp">
        <option value="1">Warp 1</option>
        <option value="2">Warp 2</option>
        <option value="3">Warp 3</option>
        <option value="4">Warp 4</option>
        <option value="5" selected>Warp 5</option>
        <option value="6">Warp 6</option>
        <option value="7">Warp 7</option>
        <option value="8">Warp 8</option>
        <option value="9">Warp 9</option>
        <option value="10">Warp 10</option>
      </select>

      <div class="row">
        <div>
          <label for="class">Destination Class</label>
          <select id="class">
            <option value="planet" selected>Planet</option>
            <option value="moon">Moon</option>
            <option value="galaxy">Galaxy</option>
            <option value="star">Star</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <div>
          <label for="targetSel">Target Name</label>
          <select id="targetSel"></select>
          <input id="targetCustom" type="text" placeholder="Type custom target" style="display:none;margin-top:8px;" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="engage" class="primary">Engage</button>
        <button id="save">Save Mission</button>
      </div>

      <div class="metrics">
        <div class="metric"><div class="label">Front (+E)</div><div id="frontE" class="value">0.00</div></div>
        <div class="metric"><div class="label">Mid (~0)</div><div id="midE" class="value">0.00</div></div>
        <div class="metric"><div class="label">Rear (−E)</div><div id="rearE" class="value">0.00</div></div>
      </div>

      <div style="margin-top:12px" class="flex">
        <button id="reset" class="ghost">Reset</button>
        <span id="persistBadge" class="badge">Not saved</span>
      </div>

      <div style="margin-top:8px" class="flex">
        <button id="resetMetrics" class="ghost">Reset Metrics Only</button>
        <button id="testAlarm" class="ghost" title="Play alarm.mp3 for 3s">Test Alarm</button>
      </div>

      <div class="mode">
        <label for="timeScale">Time Scale:</label>
        <select id="timeScale" class="scale">
          <option value="1" selected>1× (real seconds)</option>
          <option value="10">10×</option>
          <option value="100">100×</option>
          <option value="1000">1,000×</option>
          <option value="1000000">1,000,000×</option>
        </select>
      </div>
    </section>

    <!-- Center: Visualization / Map -->
    <section class="panel grid-rows">
      <!-- Big centered degrees above the map -->
      <div id="bigHeading" class="bigHeading">000°</div>

      <h2>Navigation Map (Concept)</h2>
      <div id="map" class="map">
        <div id="headingOverlay" class="headingOverlay">HEADING: 000°</div>
        <canvas id="starCanvas"></canvas>
      </div>

      <!-- Ops Status + Route -->
      <div class="ops">
        <div class="lights">
          <div class="light" id="lightBubble"><span class="dot ok"></span><span class="name">Bubble</span></div>
          <div class="light" id="lightPower"><span class="dot ok"></span><span class="name">Power</span></div>
          <div class="light" id="lightVector"><span class="dot ok"></span><span class="name">Vector</span></div>
          <div class="light" id="lightNav"><span class="dot warn"></span><span class="name">Nav</span></div>
        </div>
        <div class="route">
          <span class="kv"><label>Departure:</label><strong id="depTxt">(unspecified)</strong></span>
          <span>· Earth</span>
          <span class="kv"><label>Arrival:</label><strong id="arrTxt">(unspecified)</strong></span>
          <span class="kv"><label>Travel Clock:</label><span class="val" id="travelClock">00:00:00.000</span></span>
          <span class="kv"><label>Speed of Light:</label><span class="val" id="solTxt">0.00 c</span></span>
          <span class="kv"><label>Parsec:</label><span class="val" id="pcTxt">0.000 pc/yr</span></span>
        </div>
      </div>

      <div class="row">
        <div class="metric"><div class="label">Bubble Velocity (eff.)</div><div id="vEff" class="value">0.00 c</div></div>
        <div class="metric"><div class="label">Pulse Rate</div><div id="pulse" class="value">0.0 MHz</div></div>
        <div class="metric"><div class="label">Loop η</div><div id="eta" class="value">0.000</div></div>
      </div>
    </section>

    <!-- Right: Status (single-line) & Saved -->
    <aside class="panel grid-rows">
      <h2>Status & Log</h2>
      <div id="log"></div>
      <h2>Saved Missions</h2>
      <div id="savedBox"><div id="saved"></div></div>
    </aside>
  </main>

  <footer>
    Demo only. Timebase is locked to America/Chicago (CST/CDT) to illustrate circadian equilibrium while traveling. Selections persist via localStorage for GitHub Pages deployments.
  </footer>

  <!-- Sounds -->
  <audio id="arriveAudio" src="./warp/arrive.mp3" preload="auto"></audio>
  <audio id="warpAudio"   src="./warp/warp.mp3" preload="auto"></audio>
  <!-- Use your exact RAW URL for the alarm -->
  <audio id="alarmAudio"  src="https://raw.githubusercontent.com/gabinoc67/interstellar-star-clock/main/warpdrive/alarm.mp3" preload="auto" crossOrigin="anonymous" loop></audio>

  <script>
    /* ======= CLOCK (CST) ======= */
    const tz = 'America/Chicago';
    const cstClockEl = document.getElementById('cstClock');
    function fmtCSTClock(d){
      return new Intl.DateTimeFormat('en-US', { timeZone: tz, hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(d);
    }
    setInterval(()=>{
      const d = new Date();
      cstClockEl.textContent = fmtCSTClock(d) + (
        new Intl.DateTimeFormat('en-US',{timeZoneName:'short', timeZone:tz})
          .formatToParts(d).find(p=>p.type==='timeZoneName')?.value.replace('GMT','')||''
      );
    }, 250);

    function pad(n, w){ return String(n).padStart(w,'0'); }
    function monthName(d){ return new Intl.DateTimeFormat('en-US', { timeZone: tz, month:'long' }).format(d); }
    function cstTimestampWithPico(d){
      const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parseInt(parts.find(p=>p.type==='month').value,10);
      const day = parseInt(parts.find(p=>p.type==='day').value,10);
      const hh = parts.find(p=>p.type==='hour').value;
      const mm = parts.find(p=>p.type==='minute').value;
      const pico = pad(Math.floor((performance.now()%1)*1e12), 12);
      return `${monthName(d)} ${day}, ${y}, ${hh}:${mm}, ${pico}`;
    }

    /* ======= ELEMENTS ======= */
    const warpSel = document.getElementById('warp');
    const classSel = document.getElementById('class');
    const targetSel = document.getElementById('targetSel');
    const targetCustom = document.getElementById('targetCustom');
    const timeScaleSel = document.getElementById('timeScale');

    const engageBtn = document.getElementById('engage');
    const saveBtn = document.getElementById('save');
    const resetBtn = document.getElementById('reset');
    const resetMetricsBtn = document.getElementById('resetMetrics');
    const testAlarmBtn = document.getElementById('testAlarm');

    const frontE = document.getElementById('frontE');
    const midE = document.getElementById('midE');
    const rearE = document.getElementById('rearE');
    const vEff = document.getElementById('vEff');
    const pulse = document.getElementById('pulse');
    const eta = document.getElementById('eta');
    const logEl = document.getElementById('log');
    const savedEl = document.getElementById('saved');
    const persistBadge = document.getElementById('persistBadge');
    const rhythmBadge = document.getElementById('rhythmBadge');

    const depTxt = document.getElementById('depTxt');
    const arrTxt = document.getElementById('arrTxt');
    const solTxt = document.getElementById('solTxt');
    const pcTxt  = document.getElementById('pcTxt');
    const travelClockEl = document.getElementById('travelClock');
    const headingOverlay = document.getElementById('headingOverlay');
    const bigHeading = document.getElementById('bigHeading');

    const lightBubble = document.querySelector('#lightBubble .dot');
    const lightPower  = document.querySelector('#lightPower .dot');
    const lightVector = document.querySelector('#lightVector .dot');
    const lightNav    = document.querySelector('#lightNav .dot');

    const arriveAudio = document.getElementById('arriveAudio');
    const warpAudio   = document.getElementById('warpAudio');
    const alarmAudio  = document.getElementById('alarmAudio');

    /* ======= AUDIO UNLOCK (ensures alarms can play later) ======= */
    let audioUnlocked = false;
    function unlockAudioOnce(){
      if(audioUnlocked) return;
      audioUnlocked = true;
      [alarmAudio, warpAudio, arriveAudio].forEach(a=>{
        a.volume = 0.01;
        a.play().then(()=>{ a.pause(); a.currentTime = 0; a.volume = 1; }).catch(()=>{});
      });
    }
    document.addEventListener('click', unlockAudioOnce, { once:true });

    /* ======= DATA (targets + distances + RA/Dec catalog) ======= */
    const fallbackPlanets = ["Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune"];
    const fallbackMoons   = ["Moon","Europa","Ganymede","Callisto","Titan"];
    const fallbackGalaxies = [
      "Andromeda Galaxy (M31)","Triangulum Galaxy (M33)","Sombrero Galaxy (M104)",
      "Pinwheel Galaxy (M101)","Sculptor Galaxy (NGC 253)",
      "Large Magellanic Cloud (center)","Small Magellanic Cloud (center)"
    ];
    const fallbackStars   = [
      "Sirius","Proxima Centauri","Alpha Centauri","Barnard's Star","Ross 128",
      "Epsilon Eridani","Tau Ceti","Kapteyn's Star","Groombridge 34 (GX And)"
    ];

    let distancesData = { targets:{} };
    let catalog = { planets:[], moons:[], stars:[], galaxies:[] };
    let raDecByName = {};

    function makeTargetsData(){
      const p = (catalog.planets||[]).map(o=>o.name).filter(Boolean);
      const m = (catalog.moons||[]).map(o=>o.name).filter(Boolean);
      const s = (catalog.stars||[]).map(o=>o.name).filter(Boolean);
      const g = (catalog.galaxies||[]).map(o=>o.name).filter(Boolean);
      return {
        planet: p.length ? p : fallbackPlanets.slice(),
        moon:   m.length ? m : fallbackMoons.slice(),
        star:   s.length ? s : fallbackStars.slice(),
        galaxy: g.length ? g : fallbackGalaxies.slice(),
        custom: []
      };
    }
    let targetsData = makeTargetsData();

    Promise.all([
      fetch('./warp/targets.json').then(r=>r.ok?r.json():catalog).catch(()=>catalog),
      fetch('./warp/distances.json').then(r=>r.ok?r.json():distancesData).catch(()=>distancesData)
    ]).then(([cat, dist])=>{
      if(cat && typeof cat==='object'){
        catalog = {
          planets: Array.isArray(cat.planets)?cat.planets:[],
          moons: Array.isArray(cat.moons)?cat.moons:[],
          stars: Array.isArray(cat.stars)?cat.stars:[],
          galaxies: Array.isArray(cat.galaxies)?cat.galaxies:[]
        };
        raDecByName = {};
        (catalog.stars||[]).forEach(o=>{ if(o && o.name) raDecByName[o.name] = { ra:o.ra_deg, dec:o.dec_deg }; });
        (catalog.galaxies||[]).forEach(o=>{ if(o && o.name) raDecByName[o.name] = { ra:o.ra_deg, dec:o.dec_deg }; });
      }
      if(dist && typeof dist==='object') distancesData = dist;

      targetsData = makeTargetsData();
      populateTargetOptgroups("");
      updateMetricsStatic();
      updatePreEngageStatus();
      renderSaves();
      restoreFlightIfAny();
      setStatus('System initialized. CST sync engaged.');
    }).catch(err=>{
      console.error('Failed to load JSON:', err);
      targetsData = makeTargetsData(); // fallbacks
      populateTargetOptgroups("");
      setStatus('Error loading data. Using fallback targets.');
    });

    function populateTargetOptgroups(selectedValue = ""){
      const groups = ["planet","moon","galaxy","star"];
      let html = `<option value="">(select target)</option>`;
      for(const g of groups){
        const items = (targetsData[g]||[]);
        if(!items.length) continue;
        const label = g.charAt(0).toUpperCase()+g.slice(1)+"s";
        html += `<optgroup label="${label}" data-group="${g}">` +
          items.map(n=>`<option value="${n}" ${n===selectedValue?'selected':''}>${n}</option>`).join('') +
        `</optgroup>`;
      }
      targetSel.innerHTML = html;

      if(classSel.value==='custom'){
        targetSel.value = "";
        targetSel.style.display='none';
        targetCustom.style.display='block';
        targetCustom.value = "";
      }else{
        targetCustom.style.display='none';
        targetSel.style.display='block';
      }
      updatePreEngageStatus();
      updateStarfieldHeading();
    }

    classSel.addEventListener('change', ()=>{
      clearEngaged();
      if(classSel.value==='custom'){
        targetSel.value = "";
        targetSel.style.display='none';
        targetCustom.style.display='block';
      }else{
        const list = (targetsData[classSel.value]||[]);
        if(list.length){
          populateTargetOptgroups(list[0]);
        }else{
          populateTargetOptgroups("");
        }
        targetSel.style.display='block';
        targetCustom.style.display='none';
      }
      updatePreEngageStatus();
      updateStarfieldHeading();
    });

    targetSel.addEventListener('change', ()=>{
      clearEngaged();
      const opt = targetSel.selectedOptions[0];
      if(opt){
        const og = opt.parentElement;
        const group = og?.getAttribute('data-group');
        if(group && classSel.value !== group){
          classSel.value = group;
        }
      }
      updatePreEngageStatus();
      updateStarfieldHeading();
    });

    targetCustom.addEventListener('input', ()=>{
      clearEngaged();
      updatePreEngageStatus();
      updateStarfieldHeading();
    });

    function getSelectedTarget(){
      if(classSel.value==='custom'){
        return targetCustom.value.trim();
      }
      return (targetSel.value||'').trim();
    }

    /* ======= PHYSICS & ETA ======= */
    const C_KM_S = 299792.458;
    const SECONDS_PER_YEAR = 31557600;
    function lookupDistance(targetName){
      if(!targetName) return null;
      const t = distancesData?.targets?.[targetName];
      if(!t) return null;
      return { distance: Number(t.distance), unit: t.unit };
    }
    function computeVEffFromWarp(w){ return Math.min(0.2*w + 0.1*w*w/10, 10); }
    function baseMetricsFromWarp(w){
      const v = computeVEffFromWarp(w);
      return { vEff: v, pulse: w*0.5, eta: 0.995 + w*0.0004, front: w*0.11, mid: 0, rear: -w*0.11 };
    }
    function vEffNumber(){ return parseFloat((document.getElementById('vEff').textContent||'0').replace(' c',''))||0; }

    function computeRealEtaSeconds(targetName){
      const d = lookupDistance(targetName);
      const v = Math.max(0.01, vEffNumber());
      if(!d){
        const fallbackUnits = { moon:6, planet:12, star:60, galaxy:200, custom:20 };
        const distUnits = fallbackUnits[classSel.value] ?? 20;
        return distUnits / v;
      }
      if(d.unit === 'ly'){
        return (d.distance / v) * SECONDS_PER_YEAR;
      }else if(d.unit === 'km'){
        return d.distance / (v * C_KM_S);
      }
      return 10;
    }

    /* ======= WAYPOINTS ======= */
    function classWaypoints(cls){
      if(cls==='moon' || cls==='planet'){
        return [
          {p:0.01, label:'LEO Achieved'},
          {p:0.05, label:'Injection Burn Complete'},
          {p:0.50, label:'Mid-course'},
          {p:0.90, label:'Approach'},
          {p:0.98, label:'Orbit Insertion'}
        ];
      }else if(cls==='star'){
        return [
          {p:0.02, label:'Heliopause'},
          {p:0.10, label:'Interstellar Cruise'},
          {p:0.50, label:'Midway'},
          {p:0.90, label:'Destination Approach'}
        ];
      }else if(cls==='galaxy'){
        return [
          {p:0.02, label:'Galactic Exit'},
          {p:0.10, label:'Intergalactic Cruise'},
          {p:0.50, label:'Intergalactic Midway'},
          {p:0.95, label:'Target Galaxy Approach'}
        ];
      }
      return [
        {p:0.25, label:'Quarter'},
        {p:0.50, label:'Halfway'},
        {p:0.75, label:'Three-quarters'}
      ];
    }

    /* ======= SAVED MISSIONS ======= */
    const KEY = 'warp-demo:saves';
    function loadSaves(){ try { return JSON.parse(localStorage.getItem(KEY))||[] } catch(e){ return [] } }
    function saveSaves(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function renderSaves(){
      const arr = loadSaves();
      savedEl.innerHTML = arr.length? '' : '<span class="muted">No saved missions yet.</span>';
      arr.forEach((m,i)=>{
        const tag = document.createElement('div');
        tag.className='saved-tag';
        tag.textContent = `#${i+1} · ${m.when} CST · Warp ${m.warp} → ${m.class}:${m.target}`;
        tag.title = 'Click to load';
        tag.onclick = ()=>{
          warpSel.value = m.warp;
          classSel.value = m.class;
          if(m.class==='custom'){
            populateTargetOptgroups("");
            targetCustom.value = m.target;
            targetSel.style.display='none';
            targetCustom.style.display='block';
          }else{
            populateTargetOptgroups(m.target);
            targetSel.style.display='block';
            targetCustom.style.display='none';
          }
          setStatus(`Loaded mission #${i+1}`);
          clearEngaged();
          updatePreEngageStatus();
          updateStarfieldHeading();
        };
        savedEl.appendChild(tag);
      });
      persistBadge.textContent = arr.length? 'Saved ✓' : 'Not saved';
    }

    /* ======= STATUS: single-line board ======= */
    function setStatus(text){ logEl.textContent = text; }

    /* ======= STATUS / METRICS ======= */
    function updateMetricsStatic(){
      const w = Number(warpSel.value);
      const m = baseMetricsFromWarp(w);
      frontE.textContent = m.front.toFixed(2);
      midE.textContent   = m.mid.toFixed(2);
      rearE.textContent  = m.rear.toFixed(2);
      vEff.textContent   = m.vEff.toFixed(2) + ' c';
      pulse.textContent  = m.pulse.toFixed(1) + ' MHz';
      eta.textContent    = m.eta.toFixed(3);
      rhythmBadge.className = 'badge ok';
      rhythmBadge.textContent = 'Bio Rhythm: CST-Locked';
      solTxt.textContent = m.vEff.toFixed(2) + ' c';
      pcTxt.textContent  = (m.vEff/3.26156).toFixed(3) + ' pc/yr';
    }
    function zeroMetrics(){
      frontE.textContent="0.00"; midE.textContent="0.00"; rearE.textContent="0.00";
      vEff.textContent="0.00 c"; pulse.textContent="0.0 MHz"; eta.textContent="0.000";
      solTxt.textContent="0.00 c"; pcTxt.textContent="0.000 pc/yr";
    }

    function anyBad(){ return [lightBubble, lightPower, lightVector, lightNav].some(el => el.classList.contains('bad')); }
    function updateAlarm(){ if(anyBad() && audioUnlocked){ alarmAudio.play().catch(()=>{}); } else { alarmAudio.pause(); alarmAudio.currentTime = 0; } }
    function setDot(el, state){ el.classList.remove('ok','warn','bad'); el.classList.add(state); updateAlarm(); }
    function setAllGreen(){ setDot(lightBubble,'ok'); setDot(lightPower,'ok'); setDot(lightVector,'ok'); setDot(lightNav,'ok'); }
    function updatePreEngageStatus(){
      setDot(lightBubble,'ok'); setDot(lightPower,'ok'); setDot(lightVector,'ok');
      const t = getSelectedTarget();
      setDot(lightNav, t ? 'ok' : 'warn');
      arrTxt.textContent = t || '(unspecified)';
      travelClockEl.textContent = "00:00:00.000";
    }

    /* ======= STARFIELD with RA/Dec HEADING ======= */
    (function initStarfield(){
      const map = document.getElementById('map');
      const cvs = document.getElementById('starCanvas');
      const ctx = cvs.getContext('2d', {alpha:false});

      function resize(){
        const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
        const w = map.clientWidth, h = map.clientHeight;
        cvs.style.width = w+'px'; cvs.style.height = h+'px';
        cvs.width = w * dpr; cvs.height = h * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      window.addEventListener('resize', resize);
      resize();

      const STAR_COUNT = 420;
      const stars = [];
      function rand(min,max){ return Math.random()*(max-min)+min; }
      function makeStar(){
        return { x: rand(0, cvs.clientWidth), y: rand(0, cvs.clientHeight), z: rand(0.2, 1.0), r: rand(0.4, 1.4), tw: rand(0.5, 1.0) };
      }
      for(let i=0;i<STAR_COUNT;i++) stars.push(makeStar());

      function warpBaseSpeed(){
        const w = Number(warpSel.value||1);
        const t = (w-1)/9;
        return 0.15 + 2.85*(t*t);
      }

      let heading = {vx:-1, vy:0, deg:180};
      const HEADING_JITTER_DEG = 0.8;

      function raDecToHeading(name){
        const rec = raDecByName[name];
        if(!rec || rec.ra==null || rec.dec==null) return null;
        const ra = rec.ra * Math.PI/180;
        const dec = rec.dec * Math.PI/180;
        const vx = Math.cos(dec) * Math.cos(ra);
        const vy = Math.cos(dec) * Math.sin(ra);
        let deg = Math.atan2(vy, vx) * 180/Math.PI;
        if(deg < 0) deg += 360;
        return { vx, vy, deg: deg };
      }

      function nameHashHeading(name){
        let h=0; for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i))>>>0; }
        const angle = (h % 360) * Math.PI/180;
        const vx = Math.cos(angle), vy = Math.sin(angle);
        const mag = Math.hypot(vx,vy) || 1;
        return { vx:vx/mag, vy:vy/mag, deg: (h % 360) };
      }

      function setHeadingFromTarget(name){
        if(!name){ heading = {vx:-1, vy:0, deg:180}; updateHeadingOverlay(0); return; }
        const byRa = raDecToHeading(name);
        heading = byRa || nameHashHeading(name);
        updateHeadingOverlay(0);
      }

      function updateHeadingOverlay(jitterDeg){
        const degDisp = ((heading.deg + jitterDeg) % 360 + 360) % 360;
        const dStr = String(Math.round(degDisp)).padStart(3,'0');
        headingOverlay.textContent = `HEADING: ${dStr}°`;
        bigHeading.textContent = `${dStr}°`;
      }

      window.starfield = {
        start(){ if(this.running) return; this.running = true; cancelAnimationFrame(this.raf); this.raf = requestAnimationFrame(this.frame.bind(this)); },
        stop(reset=true){
          this.running = false; cancelAnimationFrame(this.raf);
          if(reset){
            for(let i=0;i<stars.length;i++) stars[i] = makeStar();
            ctx.clearRect(0,0,cvs.clientWidth,cvs.clientHeight);
          }
        },
        setHeading(name){ setHeadingFromTarget(name); },
        update(){},
        running:false, raf:null,
        frame(){
          if(!this.running) return;
          const base = warpBaseSpeed();
          ctx.fillStyle = '#060a12';
          ctx.fillRect(0,0,cvs.clientWidth,cvs.clientHeight);

          const t = performance.now()/1000;
          const jitter = HEADING_JITTER_DEG * Math.sin(t*0.9) * Math.cos(t*0.37);
          const rad = (heading.deg + jitter) * Math.PI/180;
          const hvx = Math.cos(rad), hvy = Math.sin(rad);
          updateHeadingOverlay(jitter);

          for(const s of stars){
            s.x -= base * (0.4 + 0.6*s.z) * hvx;
            s.y -= base * (0.4 + 0.6*s.z) * hvy;

            if(s.x < -8 || s.x > cvs.clientWidth+8 || s.y < -8 || s.y > cvs.clientHeight+8){
              const edgeX = hvx>0 ? -6 : (hvx<0 ? cvs.clientWidth+6 : rand(-6, cvs.clientWidth+6));
              const edgeY = hvy>0 ? -6 : (hvy<0 ? cvs.clientHeight+6 : rand(-6, cvs.clientHeight+6));
              s.x = edgeX; s.y = edgeY;
              s.z = rand(0.2, 1.0); s.r = rand(0.4, 1.4); s.tw = rand(0.5, 1.0);
            }

            const alpha = 0.5 + 0.5 * Math.sin((t*600) * s.tw + (s.x+s.y)*0.002);
            ctx.fillStyle = `rgba(210,225,255,${alpha})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r*(0.6+0.8*s.z), 0, Math.PI*2); ctx.fill();

            const w = Number(warpSel.value||1);
            if(w >= 7){
              ctx.strokeStyle = `rgba(210,225,255,${alpha*0.8})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(s.x, s.y);
              ctx.lineTo(s.x + (w-6)*1.2 * (-hvx), s.y + (w-6)*1.2 * (-hvy));
              ctx.stroke();
            }
          }
          this.raf = requestAnimationFrame(this.frame.bind(this));
        }
      };
      setHeadingFromTarget(getSelectedTarget()||'forward');
    })();

    function updateStarfieldHeading(){
      const name = getSelectedTarget();
      if(window.starfield) window.starfield.setHeading(name || 'forward');
    }

    /* ======= LIVE TRAVEL TICKER & FLIGHT STATE ======= */
    let travelTicker = null, travelClockMs = 0, lastTick = 0;

    function formatClock(ms){
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      const z = Math.floor(ms%1000);
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(z).padStart(3,'0')}`;
    }

    function startTravelTicker(){
      stopTravelTicker();
      lastTick = performance.now();
      travelTicker = setInterval(()=>{
        const now = performance.now();
        const realDt = now - lastTick; lastTick = now;

        const w = Number(warpSel.value);
        const base = baseMetricsFromWarp(w);

        const t = now/1000;
        const wobble = (amp)=> amp * Math.sin(t*2.1) * Math.cos(t*0.7);
        const vNow = Math.max(0, base.vEff + wobble(0.05*base.vEff + 0.03));
        const pNow = Math.max(0, base.pulse + wobble(0.06*base.pulse + 0.05));
        const eNow = Math.min(1.005, Math.max(0.990, base.eta + wobble(0.0015)));

        const fNow = base.front + wobble(0.03*base.front + 0.01);
        const mNow = 0 + wobble(0.01);
        const rNow = base.rear + wobble(0.03*(-base.rear) + 0.01);

        vEff.textContent = vNow.toFixed(2) + ' c';
        pulse.textContent = pNow.toFixed(1) + ' MHz';
        eta.textContent = eNow.toFixed(3);
        frontE.textContent = fNow.toFixed(2);
        midE.textContent = mNow.toFixed(2);
        rearE.textContent = rNow.toFixed(2);

        solTxt.textContent = vNow.toFixed(2) + ' c';
        pcTxt.textContent  = (vNow/3.26156).toFixed(3) + ' pc/yr';

        const rate = 1/(1+vNow);
        travelClockMs += realDt * rate;
        travelClockEl.textContent = formatClock(travelClockMs);

        advanceFlightProgress();
      }, 100);
    }
    function stopTravelTicker(){ if(travelTicker){ clearInterval(travelTicker); travelTicker = null; } }

    const FLIGHT_KEY = 'warp-demo:flight';
    function saveFlightState(state){ localStorage.setItem(FLIGHT_KEY, JSON.stringify(state)); }
    function loadFlightState(){ try { return JSON.parse(localStorage.getItem(FLIGHT_KEY))||null } catch(e){ return null } }
    function clearFlightState(){ localStorage.removeItem(FLIGHT_KEY); }

    function makeHeadingDeg(name){
      const rec = raDecByName[name];
      if(rec && rec.ra!=null && rec.dec!=null){
        let deg = Math.atan2(Math.cos(rec.dec*Math.PI/180)*Math.sin(rec.ra*Math.PI/180),
                             Math.cos(rec.dec*Math.PI/180)*Math.cos(rec.ra*Math.PI/180)) * 180/Math.PI;
        if(deg<0) deg+=360;
        return Math.round(deg);
      }
      let h=0; for(let i=0;i<name.length;i++){ h=(h*31 + name.charCodeAt(i))>>>0; }
      return Math.round(h%360);
    }

    function computeRealEtaSeconds(targetName){
      const d = lookupDistance(targetName);
      const v = Math.max(0.01, vEffNumber());
      if(!d){
        const fallbackUnits = { moon:6, planet:12, star:60, galaxy:200, custom:20 };
        const distUnits = fallbackUnits[classSel.value] ?? 20;
        return distUnits / v;
      }
      if(d.unit === 'ly'){ return (d.distance / v) * 31557600; }
      if(d.unit === 'km'){ return d.distance / (v * 299792.458); }
      return 10;
    }

    function classWaypoints(cls){
      if(cls==='moon' || cls==='planet'){
        return [{p:0.01,label:'LEO'},{p:0.05,label:'Injection'},{p:0.50,label:'Mid-course'},{p:0.90,label:'Approach'},{p:0.98,label:'Orbit'}];
      }else if(cls==='star'){
        return [{p:0.02,label:'Heliopause'},{p:0.10,label:'Cruise'},{p:0.50,label:'Midway'},{p:0.90,label:'Approach'}];
      }else if(cls==='galaxy'){
        return [{p:0.02,label:'Galactic Exit'},{p:0.10,label:'IG Cruise'},{p:0.50,label:'IG Midway'},{p:0.95,label:'Galaxy Approach'}];
      }
      return [{p:0.25,label:'Quarter'},{p:0.50,label:'Halfway'},{p:0.75,label:'3/4'}];
    }

    function startFlightRecord(){
      const tgt = getSelectedTarget();
      const now = Date.now();
      const etaSec = computeRealEtaSeconds(tgt);
      const scale = Number(timeScaleSel.value||1);
      const headingDeg = makeHeadingDeg(tgt || 'forward');
      const wp = classWaypoints(classSel.value);
      const record = {
        active:true,
        startMs: now,
        etaSec: etaSec,
        timeScale: scale,
        warp: warpSel.value,
        class: classSel.value,
        target: tgt,
        waypoints: wp,
        wpIndex: -1,
        headingDeg: headingDeg
      };
      saveFlightState(record);
      return record;
    }

    function restoreFlightIfAny(){
      const r = loadFlightState();
      if(!r || !r.active) return;
      warpSel.value = r.warp;
      classSel.value = r.class;
      if(r.class==='custom'){
        populateTargetOptgroups("");
        targetCustom.value = r.target;
        targetSel.style.display='none';
        targetCustom.style.display='block';
      }else{
        populateTargetOptgroups(r.target);
        targetSel.style.display='block';
        targetCustom.style.display='none';
      }
      updateMetricsStatic();
      updateStarfieldHeading();
      depTxt.textContent = cstTimestampWithPico(new Date(r.startMs));
      arrTxt.textContent = r.target;
      if(window.starfield) window.starfield.start();
      setAllGreen();
      travelClockMs = 0;
      startTravelTicker();
      setStatus(`Resuming → Warp ${r.warp} to ${r.class}:${r.target} · Scale ${r.timeScale}×`);
    }

    function currentFlight(){ return loadFlightState(); }

    function fractionalProgress(r){
      if(!r) return 0;
      const elapsedRealSec = (Date.now() - r.startMs) / 1000;
      const progressed = elapsedRealSec * (r.timeScale || 1);
      return Math.max(0, Math.min(1, progressed / (r.etaSec || 1)));
    }

    function announceWaypoints(r, frac){
      const wps = r.waypoints || [];
      let idx = r.wpIndex || -1;
      for(let i=idx+1; i<wps.length; i++){
        if(frac >= wps[i].p){
          setStatus(`Waypoint: ${wps[i].label} · ${(Math.round(frac*100))}%`);
          r.wpIndex = i;
          saveFlightState(r);
        }else{
          break;
        }
      }
    }

    function arrive(){
      const r = currentFlight();
      if(!r || !r.active) return;
      if(window.starfield) window.starfield.stop(false);
      stopTravelTicker();
      if(arriveAudio){ arriveAudio.currentTime = 0; arriveAudio.play().catch(()=>{}); }
      const arrStamp = cstTimestampWithPico(new Date());
      const name = r.target || '(unspecified)';
      arrTxt.textContent = `${name} ${arrStamp}`;
      setAllGreen();
      r.active = false; saveFlightState(r);
      clearEngaged();
      setStatus(`ARRIVED → ${r.class}:${name}`);
    }

    function advanceFlightProgress(){
      const r = currentFlight();
      if(!r || !r.active) return;
      const frac = fractionalProgress(r);
      announceWaypoints(r, frac);
      if(frac >= 1){ arrive(); }
    }

    /* ======= ACTIONS ======= */
    let engagedState = null;
    function clearEngaged(){ engagedState = null; }
    function currentState(){ return { warp: warpSel.value, class: classSel.value, target: (getSelectedTarget()||'(unspecified)') }; }

    warpSel.addEventListener('change', ()=>{ clearEngaged(); if(window.starfield) window.starfield.update(); });

    timeScaleSel.addEventListener('change', ()=>{
      const r = currentFlight();
      if(r && r.active){
        r.timeScale = Number(timeScaleSel.value||1);
        saveFlightState(r);
        setStatus(`Time Scale set to ${r.timeScale}×`);
      }
    });

    function updateStarfieldHeading(){
      const name = getSelectedTarget();
      if(window.starfield) window.starfield.setHeading(name || 'forward');
    }

    engageBtn.onclick = ()=>{
      unlockAudioOnce();
      const tgt = getSelectedTarget();
      if(!tgt){
        setDot(lightNav,'bad');
        setTimeout(()=>updatePreEngageStatus(), 1200);
        setStatus('Select a target before Engage.');
        return;
      }
      const prev = currentFlight();
      if(prev && prev.active){ prev.active = false; saveFlightState(prev); }

      updateMetricsStatic();
      updateStarfieldHeading();
      if(window.starfield) window.starfield.start();

      engagedState = { ...currentState(), when: new Date() };
      depTxt.textContent = cstTimestampWithPico(engagedState.when);
      arrTxt.textContent = tgt;

      const etaSec = computeRealEtaSeconds(tgt);
      if (warpAudio){ warpAudio.currentTime = 0; warpAudio.play().catch(()=>{}); }
      setAllGreen();

      const record = startFlightRecord();
      travelClockMs = 0;
      startTravelTicker();

      setStatus(`ENGAGE → Warp ${record.warp} to ${record.class}:${record.target} · Scale ${record.timeScale}× · ETA ~ ${Math.round(etaSec)} s`);
    };

    saveBtn.onclick = ()=>{
      unlockAudioOnce();
      const nowState = currentState();
      if(!engagedState || engagedState.warp !== nowState.warp || engagedState.class !== nowState.class || engagedState.target !== nowState.target){
        setStatus('Save blocked: press ENGAGE first for current settings.');
        return;
      }
      const arr = loadSaves();
      const m = { warp: engagedState.warp, class: engagedState.class, target: engagedState.target,
                  when: new Intl.DateTimeFormat('en-US', { timeZone: tz, dateStyle:'medium', timeStyle:'short' }).format(new Date()) };
      arr.unshift(m);
      saveSaves(arr.slice(0,25));
      renderSaves();
      setStatus('Mission saved.');
    };

    resetBtn.onclick = ()=>{
      unlockAudioOnce();
      localStorage.removeItem(KEY);
      renderSaves();
      warpSel.value = "1";
      classSel.value = "planet";
      populateTargetOptgroups("");
      targetCustom.value = "";
      clearEngaged();

      const r = currentFlight();
      if(r && r.active){ r.active=false; saveFlightState(r); }
      clearFlightState();

      stopTravelTicker();
      if(window.starfield) window.starfield.stop(true);
      depTxt.textContent = "(unspecified)";
      arrTxt.textContent = "(unspecified)";
      updateMetricsStatic();
      zeroMetrics();
      updatePreEngageStatus();
      setStatus('Reset complete.');
    };

    resetMetricsBtn.onclick = ()=>{ unlockAudioOnce(); zeroMetrics(); setStatus('Metrics reset to zero.'); };

    /* ======= TEST ALARM: plays alarm (no status/log changes) ======= */
    testAlarmBtn.onclick = ()=>{
      unlockAudioOnce();
      lightPower.classList.remove('ok','warn','bad'); lightPower.classList.add('bad');
      alarmAudio.currentTime = 0;
      alarmAudio.play().catch(()=>{});
      setTimeout(()=>{
        alarmAudio.pause(); alarmAudio.currentTime = 0;
        lightPower.classList.remove('ok','warn','bad'); lightPower.classList.add('ok');
      }, 3000);
    };

    /* ======= STATUS INIT ======= */
    function setStatus(text){ logEl.textContent = text; }
  </script>
</body>
</html>
