<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warp Drive Demo — CST Synced</title>
  <style>
    :root {
      --bg:#0d1117; --panel:#161b22; --accent:#59d; --accent2:#9cf; --text:#e6edf3; --muted:#94a3b8;
      --ok:#16a34a; --warn:#eab308; --bad:#ef4444; --shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1000px 800px at 20% -10%, #0a0f1a 0%, #0d1117 60%);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #222}
    header h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.5px}
    .container{display:grid;grid-template-columns: 340px 1fr 380px;gap:16px;padding:16px}
    .panel{background:var(--panel);border:1px solid #222;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .panel h2{margin:0 0 10px 0;font-size:15px;font-weight:700;color:var(--accent2);text-transform:uppercase;letter-spacing:.08em}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    select,input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3340;background:#0f1420;color:var(--text)}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    button{cursor:pointer;border:1px solid #2a3340;background:linear-gradient(180deg,#1b2333,#141b28);color:var(--text);padding:12px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
    button.primary{border-color:#2b4ea3;background:linear-gradient(180deg,#2b4ea3,#1b2f66)}
    button.ghost{background:transparent}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
    .metric{background:#0f1420;border:1px solid #232a36;border-radius:12px;padding:10px;text-align:center}
    .metric .label{font-size:12px;color:var(--muted)}
    .metric .value{font-size:18px;font-weight:800;margin-top:4px}
    #log{height:260px;overflow:auto;background:#0a0f1a;border:1px dashed #2a3340;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
    .grid-rows{display:grid;gap:16px}
    .map{position:relative;height:340px;border-radius:12px;border:1px solid #232a36;background:radial-gradient(600px 300px at 20% 10%, rgba(88,122,255,.18), transparent 60%), linear-gradient(180deg,#0b0f19,#0a0e16)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3340;background:#0f1420;color:var(--muted)}
    .badge.ok{color:#b7f7c1;border-color:#14532d;background:linear-gradient(180deg,#0c1b11,#0b1510)}
    .badge.warn{color:#fff0b4;border-color:#7a5c05;background:linear-gradient(180deg,#1b1709,#141004)}
    .badge.bad{color:#ffc4c4;border-color:#7a1f1f;background:linear-gradient(180deg,#1b0c0c,#140808)}
    .flex{display:flex;gap:10px;align-items:center}
    .right{justify-content:flex-end}
    footer{padding:12px 16px;color:var(--muted);font-size:12px;border-top:1px solid #222}
    .saved-tag{display:inline-block;background:#0f1420;border:1px solid #2a3340;border-radius:8px;padding:4px 8px;margin:4px;font-size:12px}

    /* Saved Missions scroll box */
    #savedBox{
      height:260px; overflow-y:auto; background:#0a0f1a; border:1px dashed #2a3340; border-radius:10px; padding:10px;
      scrollbar-color:#2a3340 #0a0f1a; scrollbar-width:thin;
    }
    #savedBox::-webkit-scrollbar { width: 10px; }
    #savedBox::-webkit-scrollbar-track { background:#0a0f1a; }
    #savedBox::-webkit-scrollbar-thumb { background:#2a3340; border-radius:8px; }
    #savedBox::-webkit-scrollbar-thumb:hover { background:#3a4558; }

    /* Canvas fills map */
    #starCanvas{position:absolute; inset:0; width:100%; height:100%; display:block; border-radius:12px}

    /* Ops strip */
    .ops {display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .lights {display:flex;gap:12px;flex-wrap:wrap}
    .light {display:flex;align-items:center;gap:8px;background:#0f1420;border:1px solid #232a36;border-radius:999px;padding:6px 10px}
    .dot {width:12px;height:12px;border-radius:50%}
    .dot.ok {background:var(--ok)}
    .dot.warn {background:var(--warn)}
    .dot.bad {background:var(--bad)}
    .name {font-size:12px;color:#cdd6e3}
    .route {font-size:12px;color:#94a3b8;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .route strong {color:#e6edf3}
    .kv {display:inline-flex;gap:6px;align-items:center}
    .kv label{font-size:12px;color:#94a3b8}
    .kv .val{font-size:12px;color:#e6edf3}
  </style>
</head>
<body>
  <header>
    <h1>Warp Drive Demonstrator · CST-Synced Equilibrium</h1>
    <div class="flex right">
      <span id="cstBadge" class="badge ok">CST Sync: <strong id="cstClock">--:--:--</strong></span>
      <span id="rhythmBadge" class="badge ok">Bio Rhythm: Stable</span>
    </div>
  </header>

  <main class="container">
    <!-- Left: Controls -->
    <section class="panel">
      <h2>Controls</h2>
      <label for="warp">Warp Factor (1–10)</label>
      <select id="warp">
        <option value="1">Warp 1</option>
        <option value="2">Warp 2</option>
        <option value="3">Warp 3</option>
        <option value="4">Warp 4</option>
        <option value="5" selected>Warp 5</option>
        <option value="6">Warp 6</option>
        <option value="7">Warp 7</option>
        <option value="8">Warp 8</option>
        <option value="9">Warp 9</option>
        <option value="10">Warp 10</option>
      </select>

      <div class="row">
        <div>
          <label for="class">Destination Class</label>
          <select id="class">
            <option value="planet" selected>Planet</option>
            <option value="moon">Moon</option>
            <option value="galaxy">Galaxy</option>
            <option value="star">Star</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <!-- Target selector (optgroups) or custom text -->
        <div>
          <label for="targetSel">Target Name</label>
          <select id="targetSel"></select>
          <input id="targetCustom" type="text" placeholder="Type custom target" style="display:none;margin-top:8px;" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="engage" class="primary">Engage</button>
        <button id="save">Save Mission</button>
      </div>

      <div class="metrics">
        <div class="metric"><div class="label">Front (+E)</div><div id="frontE" class="value">0.00</div></div>
        <div class="metric"><div class="label">Mid (~0)</div><div id="midE" class="value">0.00</div></div>
        <div class="metric"><div class="label">Rear (−E)</div><div id="rearE" class="value">0.00</div></div>
      </div>

      <div style="margin-top:12px" class="flex">
        <button id="reset" class="ghost">Reset</button>
        <span id="persistBadge" class="badge">Not saved</span>
      </div>

      <div style="margin-top:8px" class="flex">
        <button id="resetMetrics" class="ghost">Reset Metrics Only</button>
        <button id="testAlarm" class="ghost" title="Dev: trigger a red status to test alarm">Test Alarm</button>
      </div>
    </section>

    <!-- Center: Visualization / Map -->
    <section class="panel grid-rows">
      <h2>Navigation Map (Concept)</h2>
      <div id="map" class="map">
        <canvas id="starCanvas"></canvas>
      </div>

      <!-- Ops Status + Route -->
      <div class="ops">
        <div class="lights">
          <div class="light" id="lightBubble"><span class="dot ok"></span><span class="name">Bubble</span></div>
          <div class="light" id="lightPower"><span class="dot ok"></span><span class="name">Power</span></div>
          <div class="light" id="lightVector"><span class="dot ok"></span><span class="name">Vector</span></div>
          <div class="light" id="lightNav"><span class="dot warn"></span><span class="name">Nav</span></div>
        </div>
        <div class="route">
          <span class="kv"><label>Departure:</label><strong id="depTxt">(unspecified)</strong></span>
          <span>· Earth</span>
          <span class="kv"><label>Arrival:</label><strong id="arrTxt">(unspecified)</strong></span>
          <span class="kv"><label>Travel Clock:</label><span class="val" id="travelClock">00:00:00.000</span></span>
          <span class="kv"><label>Speed of Light:</label><span class="val" id="solTxt">0.00 c</span></span>
          <span class="kv"><label>Parsec:</label><span class="val" id="pcTxt">0.000 pc/yr</span></span>
        </div>
      </div>

      <div class="row">
        <div class="metric"><div class="label">Bubble Velocity (eff.)</div><div id="vEff" class="value">0.00 c</div></div>
        <div class="metric"><div class="label">Pulse Rate</div><div id="pulse" class="value">0.0 MHz</div></div>
        <div class="metric"><div class="label">Loop η</div><div id="eta" class="value">0.000</div></div>
      </div>
    </section>

    <!-- Right: Logs / Saved -->
    <aside class="panel grid-rows">
      <h2>Status & Log</h2>
      <div id="log"></div>
      <h2>Saved Missions</h2>
      <div id="savedBox"><div id="saved"></div></div>
    </aside>
  </main>

  <footer>
    Demo only. Timebase is locked to America/Chicago (CST/CDT) to illustrate circadian equilibrium while traveling. Selections persist via localStorage for GitHub Pages deployments.
  </footer>

  <!-- Sounds -->
  <audio id="arriveAudio" src="./warp/arrive.mp3" preload="auto"></audio>
  <audio id="warpAudio"   src="./warp/warp.mp3" preload="auto"></audio>
  <audio id="alarmAudio"  src="./warp/alarm.mp3" preload="auto" loop></audio>

  <script>
    // ---- Time: CST header clock ----
    const tz = 'America/Chicago';
    const cstClockEl = document.getElementById('cstClock');
    function fmtCSTClock(d){
      return new Intl.DateTimeFormat('en-US', { timeZone: tz, hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(d);
    }
    setInterval(()=>{
      const d = new Date();
      cstClockEl.textContent = fmtCSTClock(d) + (
        new Intl.DateTimeFormat('en-US',{timeZoneName:'short', timeZone:tz})
          .formatToParts(d).find(p=>p.type==='timeZoneName')?.value.replace('GMT','')||''
      );
    }, 250);

    // Helper: CST timestamp with Month Day, Year, HH:MM and pseudo-picoseconds
    function pad(n, w){ return String(n).padStart(w,'0'); }
    function monthName(d){ return new Intl.DateTimeFormat('en-US', { timeZone: tz, month:'long' }).format(d); }
    function cstTimestampWithPico(d){
      const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parseInt(parts.find(p=>p.type==='month').value,10);
      const day = parseInt(parts.find(p=>p.type==='day').value,10);
      const hh = parts.find(p=>p.type==='hour').value;
      const mm = parts.find(p=>p.type==='minute').value;
      const pico = pad(Math.floor((performance.now()%1)*1e12), 12);
      return `${monthName(d)} ${day}, ${y}, ${hh}:${mm}, ${pico}`;
    }

    // ---- Elements ----
    const warpSel = document.getElementById('warp');
    const classSel = document.getElementById('class');
    const targetSel = document.getElementById('targetSel');
    const targetCustom = document.getElementById('targetCustom');

    const engageBtn = document.getElementById('engage');
    const saveBtn = document.getElementById('save');
    const resetBtn = document.getElementById('reset');
    const resetMetricsBtn = document.getElementById('resetMetrics');
    const testAlarmBtn = document.getElementById('testAlarm');

    const frontE = document.getElementById('frontE');
    const midE = document.getElementById('midE');
    const rearE = document.getElementById('rearE');
    const vEff = document.getElementById('vEff');
    const pulse = document.getElementById('pulse');
    const eta = document.getElementById('eta');
    const logEl = document.getElementById('log');
    const savedEl = document.getElementById('saved');
    const persistBadge = document.getElementById('persistBadge');
    const rhythmBadge = document.getElementById('rhythmBadge');

    // Ops strip elements
    const depTxt = document.getElementById('depTxt');
    const arrTxt = document.getElementById('arrTxt');
    const solTxt = document.getElementById('solTxt');
    const pcTxt  = document.getElementById('pcTxt');
    const travelClockEl = document.getElementById('travelClock');

    const lightBubble = document.querySelector('#lightBubble .dot');
    const lightPower  = document.querySelector('#lightPower .dot');
    const lightVector = document.querySelector('#lightVector .dot');
    const lightNav    = document.querySelector('#lightNav .dot');

    const arriveAudio = document.getElementById('arriveAudio');
    const warpAudio   = document.getElementById('warpAudio');
    const alarmAudio  = document.getElementById('alarmAudio');

    // ---- Targets data (fallback) + load from /warp/targets.json ----
    let targetsData = {
      planet:["Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune"],
      moon:["Moon","Europa","Ganymede","Callisto","Titan"],
      galaxy:["Andromeda","Triangulum","Sombrero Galaxy"],
      star:["Sirius","Betelgeuse","Proxima Centauri"],
      custom:[]
    };
    fetch('./warp/targets.json').then(r=>r.ok?r.json():null).then(j=>{
      if(j && typeof j==='object'){ targetsData = j; }
      populateTargetOptgroups(); // initial render
    }).catch(()=>{ populateTargetOptgroups(); });

    // Build Target dropdown with optgroups for all categories (except custom)
    function populateTargetOptgroups(selectedValue = ""){
      const groups = ["planet","moon","galaxy","star"];
      let html = `<option value="">(select target)</option>`;
      for(const g of groups){
        const items = (targetsData[g]||[]);
        if(!items.length) continue;
        const label = g.charAt(0).toUpperCase()+g.slice(1)+"s";
        html += `<optgroup label="${label}" data-group="${g}">` +
          items.map(n=>`<option value="${n}" ${n===selectedValue?'selected':''}>${n}</option>`).join('') +
        `</optgroup>`;
      }
      targetSel.innerHTML = html;

      // Show/hide custom input depending on class
      if(classSel.value==='custom'){
        targetSel.value = "";
        targetSel.style.display='none';
        targetCustom.style.display='block';
        targetCustom.value = "";
      }else{
        targetCustom.style.display='none';
        targetSel.style.display='block';
      }
      updatePreEngageStatus();
    }

    // When class changes:
    // - if custom: show text input
    // - if not: keep optgroups visible; optional: auto-select first from that group
    classSel.addEventListener('change', ()=>{
      clearEngaged();
      if(classSel.value==='custom'){
        targetSel.value = "";
        targetSel.style.display='none';
        targetCustom.style.display='block';
      }else{
        const list = (targetsData[classSel.value]||[]);
        if(list.length){
          populateTargetOptgroups(list[0]);
        }else{
          populateTargetOptgroups("");
        }
        targetSel.style.display='block';
        targetCustom.style.display='none';
      }
      updatePreEngageStatus();
    });

    // When user picks any target, sync class selector to the optgroup the option belongs to
    targetSel.addEventListener('change', ()=>{
      clearEngaged();
      const opt = targetSel.selectedOptions[0];
      if(opt){
        const og = opt.parentElement; // <optgroup>
        const group = og?.getAttribute('data-group');
        if(group && classSel.value !== group){
          classSel.value = group;
        }
      }
      updatePreEngageStatus();
    });

    // Custom typing updates status
    targetCustom.addEventListener('input', ()=>{ clearEngaged(); updatePreEngageStatus(); });

    function getSelectedTarget(){
      if(classSel.value==='custom'){
        return targetCustom.value.trim();
      }
      return (targetSel.value||'').trim();
    }

    // ---- Saved missions (localStorage) ----
    const KEY = 'warp-demo:saves';
    function loadSaves(){ try { return JSON.parse(localStorage.getItem(KEY))||[] } catch(e){ return [] } }
    function saveSaves(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function renderSaves(){
      const arr = loadSaves();
      savedEl.innerHTML = arr.length? '' : '<span class="muted">No saved missions yet.</span>';
      arr.forEach((m,i)=>{
        const tag = document.createElement('div');
        tag.className='saved-tag';
        tag.textContent = `#${i+1} · ${m.when} CST · Warp ${m.warp} → ${m.class}:${m.target}`;
        tag.title = 'Click to load';
        tag.onclick = ()=>{
          warpSel.value = m.warp;
          classSel.value = m.class;
          if(m.class==='custom'){
            populateTargetOptgroups("");
            targetCustom.value = m.target;
            targetSel.style.display='none';
            targetCustom.style.display='block';
          }else{
            populateTargetOptgroups(m.target);
            targetSel.style.display='block';
            targetCustom.style.display='none';
          }
          log(`Loaded mission #${i+1}`);
          clearEngaged();
          updatePreEngageStatus();
        };
        savedEl.appendChild(tag);
      });
      persistBadge.textContent = arr.length? 'Saved ✓' : 'Not saved';
    }

    // ---- Metric helpers ----
    function computeVEffFromWarp(w){ return Math.min(0.2*w + 0.1*w*w/10, 10); }
    function baseMetricsFromWarp(w){
      const v = computeVEffFromWarp(w);
      return { vEff: v, pulse: w*0.5, eta: 0.995 + w*0.0004, front: w*0.11, mid: 0, rear: -w*0.11 };
    }
    function updateMetricsStatic(){
      const w = Number(warpSel.value);
      const m = baseMetricsFromWarp(w);
      frontE.textContent = m.front.toFixed(2);
      midE.textContent   = m.mid.toFixed(2);
      rearE.textContent  = m.rear.toFixed(2);
      vEff.textContent   = m.vEff.toFixed(2) + ' c';
      pulse.textContent  = m.pulse.toFixed(1) + ' MHz';
      eta.textContent    = m.eta.toFixed(3);
      rhythmBadge.className = 'badge ok';
      rhythmBadge.textContent = 'Bio Rhythm: CST-Locked';
      solTxt.textContent = m.vEff.toFixed(2) + ' c';
      pcTxt.textContent  = (m.vEff/3.26156).toFixed(3) + ' pc/yr';
    }
    function zeroMetrics(){
      frontE.textContent="0.00"; midE.textContent="0.00"; rearE.textContent="0.00";
      vEff.textContent="0.00 c"; pulse.textContent="0.0 MHz"; eta.textContent="0.000";
      solTxt.textContent="0.00 c"; pcTxt.textContent="0.000 pc/yr";
    }

    // Live travel ticker (ALL metrics fluctuate) while engaged
    let travelTicker = null;
    let travelClockMs = 0;
    let lastTick = 0;

    function formatClock(ms){
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      const z = Math.floor(ms%1000);
      return `${pad(h,2)}:${pad(m,2)}:${pad(s,2)}.${pad(z,3)}`;
    }

    function startTravelTicker(){
      stopTravelTicker();
      travelClockMs = 0;
      lastTick = performance.now();
      travelClockEl.textContent = formatClock(travelClockMs);
      travelTicker = setInterval(()=>{
        const now = performance.now();
        const realDt = now - lastTick; lastTick = now;

        const w = Number(warpSel.value);
        const base = baseMetricsFromWarp(w);

        // Gentle fluctuations
        const t = now/1000;
        const wobble = (amp)=> amp * Math.sin(t*2.1) * Math.cos(t*0.7);
        const vNow = Math.max(0, base.vEff + wobble(0.05*base.vEff + 0.03));
        const pNow = Math.max(0, base.pulse + wobble(0.06*base.pulse + 0.05));
        const eNow = Math.min(1.005, Math.max(0.990, base.eta + wobble(0.0015)));

        const fNow = base.front + wobble(0.03*base.front + 0.01);
        const mNow = 0 + wobble(0.01);
        const rNow = base.rear + wobble(0.03*(-base.rear) + 0.01);

        // Update UI
        vEff.textContent = vNow.toFixed(2) + ' c';
        pulse.textContent = pNow.toFixed(1) + ' MHz';
        eta.textContent = eNow.toFixed(3);
        frontE.textContent = fNow.toFixed(2);
        midE.textContent = mNow.toFixed(2);
        rearE.textContent = rNow.toFixed(2);

        solTxt.textContent = vNow.toFixed(2) + ' c';
        pcTxt.textContent  = (vNow/3.26156).toFixed(3) + ' pc/yr';

        // Travel clock runs slower at higher v: rate = 1/(1+v)
        const rate = 1/(1+vNow);
        travelClockMs += realDt * rate;
        travelClockEl.textContent = formatClock(travelClockMs);
      }, 100);
    }
    function stopTravelTicker(){
      if(travelTicker){ clearInterval(travelTicker); travelTicker = null; }
    }

    // ---- Canvas starfield ----
    (function initStarfield(){
      const map = document.getElementById('map');
      const cvs = document.getElementById('starCanvas');
      const ctx = cvs.getContext('2d', {alpha:false});

      function resize(){
        const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
        const w = map.clientWidth, h = map.clientHeight;
        cvs.style.width = w+'px';
        cvs.style.height = h+'px';
        cvs.width = w * dpr;
        cvs.height = h * dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      window.addEventListener('resize', resize);
      resize();

      const STAR_COUNT = 350;
      const stars = [];
      function rand(min,max){ return Math.random()*(max-min)+min; }
      function makeStar(){
        return { x: rand(0, cvs.clientWidth), y: rand(0, cvs.clientHeight), z: rand(0.2, 1.0), r: rand(0.4, 1.4), tw: rand(0.5, 1.0) };
      }
      for(let i=0;i<STAR_COUNT;i++) stars.push(makeStar());

      function warpSpeed(){
        const w = Number(warpSel.value||1);
        const t = (w-1)/9;
        return 0.15 + 2.85*(t*t);
      }

      let running = false;
      let raf = null;

      function frame(){
        if(!running) return;
        const base = warpSpeed();

        ctx.fillStyle = '#060a12';
        ctx.fillRect(0,0,cvs.clientWidth,cvs.clientHeight);

        const now = performance.now();
        for(const s of stars){
          s.x -= base * (0.4 + 0.6*s.z);
          if(s.x < -4){
            s.x = cvs.clientWidth + rand(0, 40);
            s.y = rand(0, cvs.clientHeight);
            s.z = rand(0.2, 1.0);
            s.r = rand(0.4, 1.4);
            s.tw = rand(0.5, 1.0);
          }
          const alpha = 0.5 + 0.5 * Math.sin((now/600) * s.tw + s.x*0.002);
          ctx.fillStyle = `rgba(210,225,255,${alpha})`;
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r*(0.6+0.8*s.z), 0, Math.PI*2);
          ctx.fill();

          const w = Number(warpSel.value||1);
          if(w >= 7){
            ctx.strokeStyle = `rgba(210,225,255,${alpha*0.8})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(s.x+1, s.y);
            ctx.lineTo(s.x + 1 + (w-6)*1.2, s.y);
            ctx.stroke();
          }
        }
        raf = requestAnimationFrame(frame);
      }

      window.starfield = {
        start(){ if(running) return; running = true; cancelAnimationFrame(raf); raf = requestAnimationFrame(frame); },
        stop(reset=true){
          running = false; cancelAnimationFrame(raf);
          if(reset){
            for(let i=0;i<stars.length;i++) stars[i] = makeStar();
            ctx.clearRect(0,0,cvs.clientWidth,cvs.clientHeight);
          }
        },
        update(){ /* speed read per frame */ }
      };
    })();

    // ---- Logging ----
    function log(msg){
      const ts = new Intl.DateTimeFormat('en-US',{ timeZone: tz, hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date());
      logEl.insertAdjacentHTML('afterbegin', `[${ts}] ${msg}<br/>`);
    }

    // ---- Alarm logic: play alarm.mp3 if ANY dot is red (bad) ----
    function anyBad(){
      return [lightBubble, lightPower, lightVector, lightNav].some(el => el.classList.contains('bad'));
    }
    function updateAlarm(){
      if(anyBad()){
        alarmAudio.play().catch(()=>{ /* user gesture may be needed; will play next time */ });
      }else{
        alarmAudio.pause(); alarmAudio.currentTime = 0;
      }
    }

    // ---- Lights helpers ----
    function setDot(el, state){
      el.classList.remove('ok','warn','bad');
      el.classList.add(state);
      updateAlarm();
    }
    function setAllGreen(){ setDot(lightBubble,'ok'); setDot(lightPower,'ok'); setDot(lightVector,'ok'); setDot(lightNav,'ok'); }
    function updatePreEngageStatus(){
      setDot(lightBubble,'ok'); setDot(lightPower,'ok'); setDot(lightVector,'ok');
      const t = getSelectedTarget();
      setDot(lightNav, t ? 'ok' : 'warn'); // still yellow if no target
      arrTxt.textContent = t || '(unspecified)';
      travelClockEl.textContent = "00:00:00.000";
    }

    // ---- Require Engage before Save ----
    let engagedState = null; // {warp,class,target,when}
    function clearEngaged(){ engagedState = null; }
    function currentState(){ return { warp: warpSel.value, class: classSel.value, target: (getSelectedTarget()||'(unspecified)') }; }

    warpSel.addEventListener('change', ()=>{ clearEngaged(); if(window.starfield) window.starfield.update(); });
    // classSel change is above (syncs with optgroups)
    // targetSel & targetCustom listeners are above

    // ---- Flight timing / automatic arrival ----
    let flightTimer = null;
    function clearFlightTimer(){ if(flightTimer){ clearTimeout(flightTimer); flightTimer = null; } }
    function destDistanceUnits(){
      switch(classSel.value){
        case 'moon':   return 6;
        case 'planet': return 12;
        case 'star':   return 60;
        case 'galaxy': return 200;
        default:       return 20;
      }
    }
    function vEffNumber(){ return parseFloat(vEff.textContent)||0; }
    function computeEtaSec(){
      const dist = destDistanceUnits();
      const v = Math.max(0.05, vEffNumber());
      const seconds = dist / v;
      return Math.max(4, Math.min(seconds, 22));
    }
    function arrive(){
      clearFlightTimer();
      stopTravelTicker(); // freeze ALL live readouts
      if(window.starfield) window.starfield.stop(false);
      if(arriveAudio){ arriveAudio.currentTime = 0; arriveAudio.play().catch(()=>{}); }
      const arrStamp = cstTimestampWithPico(new Date());
      const name = getSelectedTarget() || '(unspecified)';
      arrTxt.textContent = `${name} ${arrStamp}`;
      log(`ARRIVED → ${classSel.value}:${name}`);
      setAllGreen();
      clearEngaged();
    }

    // ---- Actions ----
    engageBtn.onclick = ()=>{
      updateMetricsStatic();
      if(window.starfield) window.starfield.start();
      const name = getSelectedTarget() || '(unspecified)';
      engagedState = { ...currentState(), when: new Date() };
      depTxt.textContent = cstTimestampWithPico(engagedState.when);
      arrTxt.textContent = name;
      log(`ENGAGE → Warp ${engagedState.warp} to ${engagedState.class}:${name}`);
      if (warpAudio){ warpAudio.currentTime = 0; warpAudio.play().catch(()=>{}); }
      clearFlightTimer();
      const etaSec = computeEtaSec();
      log(`ETA ~ ${etaSec.toFixed(0)}s`);
      setAllGreen();
      startTravelTicker();                         // LIVE updates begin
      flightTimer = setTimeout(arrive, etaSec*1000);
    };

    saveBtn.onclick = ()=>{
      const nowState = currentState();
      if(!engagedState || engagedState.warp !== nowState.warp || engagedState.class !== nowState.class || engagedState.target !== nowState.target){
        log('Save blocked: please click ENGAGE first for the current settings.');
        return;
      }
      const arr = loadSaves();
      const m = { warp: engagedState.warp, class: engagedState.class, target: engagedState.target,
                  when: new Intl.DateTimeFormat('en-US', { timeZone: tz, dateStyle:'medium', timeStyle:'short' }).format(new Date()) };
      arr.unshift(m);
      saveSaves(arr.slice(0,25));
      renderSaves();
      log('Mission saved.');
    };

    resetBtn.onclick = ()=>{
      localStorage.removeItem(KEY);
      renderSaves();
      warpSel.value = "1";
      classSel.value = "planet";
      populateTargetOptgroups("");
      targetCustom.value = "";
      logEl.innerHTML = "";
      clearEngaged();
      clearFlightTimer();
      stopTravelTicker();
      if(window.starfield) window.starfield.stop(true);
      depTxt.textContent = "(unspecified)";
      arrTxt.textContent = "(unspecified)";
      updateMetricsStatic(); // recompute for Warp 1
      zeroMetrics();         // clear readouts visually
      updatePreEngageStatus();
    };

    resetMetricsBtn.onclick = ()=>{ zeroMetrics(); log('Metrics reset to zero.'); };

    // ---- Dev/Test: force a red status for 3s to test alarm ----
    testAlarmBtn.onclick = ()=>{
      log('Test alarm: setting Power indicator to RED for 3 seconds.');
      setDot(lightPower, 'bad');
      setTimeout(()=>{ setDot(lightPower, 'ok'); log('Test alarm: cleared.'); }, 3000);
    };

    // ---- Init ----
    renderSaves();
    if(!targetSel.options.length) populateTargetOptgroups("");
    updateMetricsStatic();
    updatePreEngageStatus();
    log('System initialized. CST sync engaged.');
  </script>
</body>
</html>
