<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Harmonic Live — Coherence & Stability (Always Moving)</title>
<style>
  :root{
    --bg:#0b1222; --panel:#111a34; --ink:#eaf0ff; --muted:#a7b7e6; --border:#22316b;
    --btn:#162455; --btnHover:#1d2e6e; --accent:#8fb4ff; --ok:#7bffb1; --bad:#ff8c8c; --grid:#1a234a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-size:1.35rem}
  .sub{margin:0 0 16px;color:var(--muted);font-size:0.95rem}
  .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .panel h2{margin:0 0 10px;font-size:1.05rem}
  .row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:10px 0}
  .row label{font-size:0.92rem;color:var(--muted)}
  .row input[type="range"]{width:240px}
  .micro{font-size:0.82rem;color:var(--muted)}
  .badge{display:inline-block;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:0.85rem}
  .ok{color:#0b2; border-color:#145}
  .fail{color:#b20; border-color:#521}
  canvas{display:block;width:100%;height:360px;background:linear-gradient(180deg,rgba(143,180,255,.07),transparent 28%), repeating-linear-gradient(0deg,var(--grid),var(--grid) 1px,transparent 1px,transparent 28px); border-radius:12px;border:1px solid var(--border)}
  .switch{display:inline-flex;gap:10px;flex-wrap:wrap}
  .switch label{display:inline-flex;gap:8px;align-items:center;font-size:0.92rem;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--btn);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{background:var(--btnHover)}
  .stack{display:flex;gap:10px;flex-wrap:wrap}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace; font-size:0.86rem}
  .nums{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .pill{border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-size:0.9rem}
  /* Demo links mini-panel you can reuse everywhere */
  .demos{display:grid;grid-template-columns:1fr;gap:8px}
  .demos a{display:block;text-decoration:none;color:var(--ink);background:#0e1740;border:1px solid var(--border);padding:10px 12px;border-radius:10px}
  .demos a:hover{outline:1px solid var(--accent)}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} canvas{height:300px} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Harmonic Live — Coherence & Stability</h1>
    <p class="sub">Always-moving wave with adjustable frequency, damping, and coherence mapping. Tunable stability band shows PASS/FAIL in real time.</p>

    <div class="grid">
      <!-- LEFT: Canvas + status -->
      <div class="panel">
        <h2>Live Wave</h2>
        <canvas id="view" width="1080" height="360"></canvas>
        <div class="two" style="margin-top:10px">
          <div>
            <div class="micro">rAF clock with time-based progression and numerical damping; optional noise and grid normalization.</div>
          </div>
          <div style="text-align:right">
            <span id="statusBadge" class="badge fail">Status: FAIL</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Controls -->
      <div class="panel">
        <h2>Controls & Stability</h2>

        <div class="row">
          <label>Frequency (Hz) <span id="valFreq" class="kbd">1.20</span></label>
          <input id="freq" type="range" min="0.10" max="5.00" value="1.20" step="0.01" />
        </div>

        <div class="row">
          <label>Amplitude (norm) <span id="valAmp" class="kbd">0.80</span></label>
          <input id="amp" type="range" min="0.05" max="1.50" value="0.80" step="0.01" />
        </div>

        <div class="row">
          <label>Damping ζ (0–0.2 good) <span id="valDamp" class="kbd">0.06</span></label>
          <input id="damp" type="range" min="0.00" max="0.40" value="0.06" step="0.005" />
        </div>

        <div class="row">
          <label>Coherence Gauge (0–1) <span id="valCoh" class="kbd">0.62</span></label>
          <input id="coh" type="range" min="0.00" max="1.00" value="0.62" step="0.01" />
        </div>

        <div class="row">
          <label>Stability Band [min,max] <span id="valBand" class="kbd">0.58—0.66</span></label>
          <input id="bandMin" type="range" min="0.00" max="1.00" value="0.58" step="0.01" />
          <input id="bandMax" type="range" min="0.00" max="1.00" value="0.66" step="0.01" />
        </div>

        <div class="switch" style="margin:10px 0 12px">
          <label><input id="noise" type="checkbox" /> Add tiny phase noise</label>
          <label><input id="normalize" type="checkbox" checked /> Normalize field</label>
          <label><input id="contours" type="checkbox" /> Curvature contours</label>
        </div>

        <div class="nums">
          <div class="pill">Coherence ∅: <span id="readC" class="kbd">0.00</span></div>
          <div class="pill">v<sub>RMS</sub>: <span id="readV" class="kbd">0.000</span></div>
          <div class="pill">Q-index: <span id="readQ" class="kbd">0.0</span></div>
        </div>

        <div class="stack" style="margin-top:12px">
          <button id="resetBtn" class="btn">Reset (keeps Coherence)</button>
          <button id="examplePass" class="btn">Load Example — PASS</button>
          <button id="exampleFail" class="btn">Load Example — FAIL</button>
        </div>
      </div>
    </div>

    <!-- Reusable mini panel of demo links -->
    <div class="panel" style="margin-top:16px">
      <h2>Demo Simulation Projects</h2>
      <div class="demos">
        <a href="https://gabinoc67.github.io/interstellar-star-clock/demos/vrms.html" target="_blank" rel="noopener">vRMS / Live Wave Demo</a>
        <a href="https://gabinoc67.github.io/interstellar-star-clock/demos/email.html" target="_blank" rel="noopener">Contact / Upload to Email</a>
      </div>
      <p class="micro" style="margin-top:8px">Drop this panel into any page where you want quick navigation to your active demos.</p>
    </div>
  </div>

<script>
(() => {
  // DOM
  const cvs = document.getElementById('view');
  const ctx = cvs.getContext('2d');
  const dpr = Math.max(1, window.devicePixelRatio || 1);

  // Controls
  const ui = {
    freq: document.getElementById('freq'),
    amp: document.getElementById('amp'),
    damp: document.getElementById('damp'),
    coh: document.getElementById('coh'),
    bandMin: document.getElementById('bandMin'),
    bandMax: document.getElementById('bandMax'),
    noise: document.getElementById('noise'),
    normalize: document.getElementById('normalize'),
    contours: document.getElementById('contours'),

    vFreq: document.getElementById('valFreq'),
    vAmp: document.getElementById('valAmp'),
    vDamp: document.getElementById('valDamp'),
    vCoh: document.getElementById('valCoh'),
    vBand: document.getElementById('valBand'),

    readC: document.getElementById('readC'),
    readV: document.getElementById('readV'),
    readQ: document.getElementById('readQ'),

    status: document.getElementById('statusBadge'),
    reset: document.getElementById('resetBtn'),
    exPass: document.getElementById('examplePass'),
    exFail: document.getElementById('exampleFail'),
  };

  // HiDPI canvas
  function fitCanvas() {
    const w = cvs.clientWidth;
    const h = cvs.clientHeight;
    cvs.width = Math.floor(w * dpr);
    cvs.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  fitCanvas();
  window.addEventListener('resize', fitCanvas);

  // Simulation state
  const state = {
    t0: performance.now(),
    phase: 0,
    // keep coherence on reset (as requested previously)
    defaults: { freq: 1.20, amp: 0.80, damp: 0.06, coh: 0.62, bandMin: 0.58, bandMax: 0.66,
                noise:false, normalize:true, contours:false },
    xBuf: new Float32Array(1024),
  };

  // Helpers
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  // Read controls
  function read() {
    const p = {
      f: parseFloat(ui.freq.value),
      A: parseFloat(ui.amp.value),
      z: parseFloat(ui.damp.value),
      C: parseFloat(ui.coh.value),
      Bmin: Math.min(parseFloat(ui.bandMin.value), parseFloat(ui.bandMax.value)),
      Bmax: Math.max(parseFloat(ui.bandMin.value), parseFloat(ui.bandMax.value)),
      noise: ui.noise.checked,
      normalize: ui.normalize.checked,
      contours: ui.contours.checked
    };
    ui.vFreq.textContent = p.f.toFixed(2);
    ui.vAmp.textContent  = p.A.toFixed(2);
    ui.vDamp.textContent = p.z.toFixed(2);
    ui.vCoh.textContent  = p.C.toFixed(2);
    ui.vBand.textContent = `${p.Bmin.toFixed(2)}—${p.Bmax.toFixed(2)}`;
    return p;
  }

  // Reset (keep coherence)
  ui.reset.addEventListener('click', () => {
    const keepC = parseFloat(ui.coh.value);
    const d = state.defaults;
    ui.freq.value = d.freq; ui.amp.value = d.amp; ui.damp.value = d.damp;
    ui.bandMin.value = d.bandMin; ui.bandMax.value = d.bandMax;
    ui.coh.value = keepC.toFixed(2);
    ui.noise.checked = d.noise; ui.normalize.checked = d.normalize; ui.contours.checked = d.contours;
  });

  // Examples
  ui.exPass.addEventListener('click', () => {
    ui.freq.value=1.10; ui.amp.value=0.70; ui.damp.value=0.05;
    ui.coh.value=0.62; ui.bandMin.value=0.58; ui.bandMax.value=0.66;
    ui.noise.checked=true; ui.normalize.checked=true; ui.contours.checked=false;
  });
  ui.exFail.addEventListener('click', () => {
    ui.freq.value=3.80; ui.amp.value=1.20; ui.damp.value=0.22;
    ui.coh.value=0.35; ui.bandMin.value=0.58; ui.bandMax.value=0.66;
    ui.noise.checked=false; ui.normalize.checked=false; ui.contours.checked=true;
  });

  // Derived metrics
  function coherenceToRMS(C, A, z) {
    // Simple illustrative mapping: vRMS increases with amplitude and coherence proximity to 1,
    // but is tempered by damping. This is a placeholder for your specific mapping.
    const rms = A * Math.sqrt(clamp(C,0,1)) * Math.exp(-2*z);
    return rms;
  }
  function qIndex(f, z) {
    // Simplified quality factor proxy
    return clamp(f / (2*Math.max(1e-4,z)), 0, 9999);
  }

  // Draw grid & contours
  function drawGrid() {
    // background (already in CSS), just axis line
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 1;
    const midY = cvs.clientHeight/2;
    ctx.beginPath();
    ctx.moveTo(0, midY+0.5);
    ctx.lineTo(cvs.clientWidth, midY+0.5);
    ctx.stroke();
    ctx.restore();
  }

  // Render loop
  let lastT = performance.now();
  function loop(now) {
    const p = read();
    const dt = (now - lastT)/1000;
    lastT = now;

    // Advance phase
    const nudge = p.noise ? (Math.random()-0.5)*0.002 : 0;
    state.phase += (2 * Math.PI * p.f * dt) + nudge;

    // Prepare data
    const W = cvs.clientWidth, H = cvs.clientHeight, mid = H/2;
    const N = state.xBuf.length;
    const Apx = p.A * (p.normalize ? (H*0.36) : (H*0.50));
    for (let i=0;i<N;i++){
      const x = i/(N-1);
      // Damped traveling wave
      const y = Apx * Math.sin( (x*8*Math.PI) + state.phase ) * Math.exp(-p.z * x * 6);
      state.xBuf[i] = y;
    }

    // Compute metrics
    // Coherence measure: smoothness + bounded amplitude proxy
    const ampEst = Math.min(1, Math.abs(Apx) / (H*0.5));
    const smooth = 1 - p.z*1.8; // less damping => higher oscillatory persistence
    const C_meas = clamp( (0.5*ampEst + 0.5*smooth) * 0.9, 0, 1);
    ui.readC.textContent = C_meas.toFixed(2);

    const v = coherenceToRMS(C_meas, p.A, p.z);
    ui.readV.textContent = v.toFixed(3);

    const q = qIndex(p.f, p.z);
    ui.readQ.textContent = q.toFixed(1);

    // PASS/FAIL
    const pass = (C_meas >= p.Bmin && C_meas <= p.Bmax);
    ui.status.textContent = `Status: ${pass ? 'PASS' : 'FAIL'}`;
    ui.status.className = `badge ${pass ? 'ok' : 'fail'}`;

    // Draw
    ctx.clearRect(0,0,cvs.width,cvs.height);
    drawGrid();

    // Optional contours (vertical faint lines)
    if (p.contours){
      ctx.save();
      ctx.strokeStyle = 'rgba(143,180,255,0.12)';
      for(let i=0;i<16;i++){
        const xx = (i/15) * W;
        ctx.beginPath(); ctx.moveTo(xx,0); ctx.lineTo(xx,H); ctx.stroke();
      }
      ctx.restore();
    }

    // Wave
    ctx.save();
    ctx.beginPath();
    const firstY = mid - state.xBuf[0];
    ctx.moveTo(0, firstY);
    for (let i=1;i<N;i++){
      const x = (i/(N-1)) * W;
      const y = mid - state.xBuf[i];
      ctx.lineTo(x,y);
    }
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(223,235,255,0.95)';
    ctx.stroke();
    ctx.restore();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
