<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live CST FTL Target Board – Pro (Stable)</title>
  <style>
    :root{
      --bg:#070b18; --card:#0f1630; --ink:#eaf0ff; --muted:#9fb0e0; --good:#3dd07f; --warn:#ffd166; --bad:#ef476f;
      --grid-gap:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#060a16,#0a1030);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:20px 22px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:rgba(8,12,30,.78);backdrop-filter: blur(8px)}
    h1{margin:0;font-weight:700;letter-spacing:.2px}
    .note{color:var(--muted);font-size:12px}
    .wrap{padding:20px;max-width:1600px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--grid-gap)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .stat{display:flex;flex-direction:column;padding:10px 12px;background:rgba(255,255,255,.04);border-radius:12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font:600 16px/1.2 system-ui}
    .row{display:grid;grid-template-columns:220px 86px 1.05fr 1fr 1fr 130px 135px 120px 120px 130px 120px 120px;gap:10px;align-items:center;padding:10px;border-bottom:1px dashed rgba(255,255,255,.07)}
    .row.header{font-weight:600;color:#cbd5ff;border-bottom:1px solid rgba(255,255,255,.12)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .ok{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    footer{color:var(--muted);padding:20px;text-align:center}
    a{color:#9bb7ff}
    .tiny{font-size:11px;color:var(--muted)}
    .banner{margin:12px 0;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <header>
    <h1>Live CST FTL Target Board — Pro (Stable)</h1>
    <div class="note">Reads local <code>targets.json</code>, renders rows even without live IDs, and shows clear errors inline. Add <code>horizonsId</code>/<code>naifId</code>/<code>command</code> for live vectors; add <code>ra/dec</code> for Gaia context.</div>
  </header>

  <div class="wrap grid">
    <!-- Clocks -->
    <section class="card" style="grid-column: span 6">
      <h2>Quantum Clocks</h2>
      <div class="grid" style="grid-template-columns: repeat(3,1fr); gap:12px">
        <div class="stat"><div class="k">Local Time (America/Chicago)</div><div class="v" id="localTime">—</div><div class="tiny" id="tzName">—</div></div>
        <div class="stat"><div class="k">Interstellar Time</div><div class="v" id="interstellarYear">—</div><div class="tiny">Toy model for demo</div></div>
        <div class="stat"><div class="k">Stardate</div><div class="v" id="stardate">—</div><div class="tiny">Approx. TNG-style</div></div>
      </div>
    </section>

    <section class="card" style="grid-column: span 6">
      <h2>Status</h2>
      <div class="banner mono" id="statusBanner">Loading targets.json…</div>
      <div class="tiny">If nothing appears, verify: this HTML file and <code>targets.json</code> are in the <b>same folder</b>, and that <code>targets.json</code> is valid JSON.</div>
    </section>

    <!-- Target Table -->
    <section class="card" style="grid-column: span 12">
      <h2>Targets (from targets.json)</h2>
      <div class="row header">
        <div>Name</div>
        <div>Type</div>
        <div>Live Vector (ICRF/J2000, AU)</div>
        <div>Dist. Sun</div>
        <div>Dist. Earth</div>
        <div>Proper Motion</div>
        <div>Radial Vel.</div>
        <div>Distance</div>
        <div>Rec. Vel (H₀·D)</div>
        <div>Last Update</div>
        <div>Status</div>
        <div>Actions</div>
      </div>
      <div id="targets"></div>
      <div class="tiny" style="margin-top:8px">
        Rows render even without live IDs. Add <code>"horizonsId": "399"</code> (Earth), <code>"command": "\"Voyager 1\""</code>, etc. to enable live vectors.
      </div>
    </section>
  </div>

  <footer>
    Built for <span class="mono">targets.json</span>. You may need a CORS proxy for NASA Horizons from the browser.
  </footer>

<script>
/* ========= CONFIG ========= */
const TARGETS_URL = "targets.json";          // same folder as this HTML
const HORIZONS_ENDPOINT = "https://ssd-api.jpl.nasa.gov/horizons.api"; // may need proxy
const GAIA_TAP = "https://mast.stsci.edu/vo-tap/api/v0.1/gaiadr3/tap/sync"; // CORS ok
const CORS_PROXY = ""; // e.g. "https://your-proxy.example.com/?url="

/* ========= TIME & UNITS ========= */
const AU_KM = 149_597_870.700, KM_PER_MI = 1.609344, KM_PER_AU = AU_KM, MI_PER_AU = KM_PER_AU/KM_PER_MI;
const KM_PER_MPC = 3.085677581e19, C_KM_S = 299_792.458, H0 = 70;

function chicagoNow(){const now=new Date();const o={ timeZone:'America/Chicago', hour12:true, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'};return new Intl.DateTimeFormat(undefined,o).format(now)}
function tzLabel(){ try{ return Intl.DateTimeFormat().resolvedOptions().timeZone } catch { return 'Local TZ' } }
function interstellarYear(){ const s=Date.now()/1000; const y=57_800_000+(s/31557600)*100; return `Year ~${y.toFixed(2)}` }
function stardate(){ const ms=Date.now(); const base=Date.UTC(2323,0,1,0,0,0); const sd=1000*((ms-base)/31557600000); return `Stardate ${(sd/10).toFixed(1)}` }
function fmt(n,d=6){ return Number(n).toFixed(d) }
function fmtAU(x){ return fmt(x,6) + " AU" }
function fmtMi(x){ return Intl.NumberFormat().format(Math.round(x)) + " miles" }
function fmtISO(d){ return new Date(d).toISOString().replace(".000Z","Z") }

/* ========= HELPERS ========= */
const rowsEl = document.getElementById('targets');
const banner = document.getElementById('statusBanner');
function setBanner(msg, cls=""){ banner.textContent = msg; banner.className = "banner mono " + cls; }
function norm(v){ return Math.hypot(...v) }
function sub(a,b){ return a.map((v,i)=> v-b[i]) }

/* ========= ROW RENDER ========= */
function makeRow(t){
  const el = document.createElement('div');
  el.className = 'row';
  const id = (t.id || t.name || 'target').toString().replace(/\W+/g,'_');
  el.id = `row-${id}`;
  el.innerHTML = `
    <div><div><strong>${t.name || '(unnamed target)'}</strong></div><div class="tiny">${t.id||''}</div></div>
    <div><span class="pill">${t.type||'—'}</span></div>
    <div class="mono" id="vec-${id}">—</div>
    <div id="sun-${id}">—</div>
    <div id="earth-${id}">—</div>
    <div id="pm-${id}">—</div>
    <div id="rv-${id}">—</div>
    <div id="dist-${id}">—</div>
    <div id="rec-${id}">—</div>
    <div class="tiny" id="upd-${id}">—</div>
    <div class="tiny" id="status-${id}">pending…</div>
    <div><button id="btn-${id}">Recompute</button></div>
  `;
  rowsEl.appendChild(el);
  document.getElementById(`btn-${id}`).addEventListener('click',()=> updateRow(t, id, true));
  // do an initial update (non-force)
  updateRow(t, id, false);
}

/* ========= DATA PATHS ========= */
async function horizonsVector(command, isoUtc){
  const params = new URLSearchParams({
    format:'json', COMMAND: command, EPHEM_TYPE:'VECTORS', CENTER:'500@0', TLIST:`'${isoUtc}'`, REF_PLANE:'ECLIPTIC'
  });
  const url = HORIZONS_ENDPOINT + '?' + params.toString();
  const finalUrl = CORS_PROXY ? CORS_PROXY + encodeURIComponent(url) : url;
  const r = await fetch(finalUrl);
  if(!r.ok) throw new Error(`Horizons ${r.status}`);
  const j = await r.json();
  const txt = j?.result || j?.vectors;
  if(!txt) throw new Error('No vectors in response');
  const m = txt.match(/X\s*=\s*([\-0-9\.E+]+).*?Y\s*=\s*([\-0-9\.E+]+).*?Z\s*=\s*([\-0-9\.E+]+).*?VX\s*=\s*([\-0-9\.E+]+).*?VY\s*=\s*([\-0-9\.E+]+).*?VZ\s*=\s*([\-0-9\.E+]+)/s);
  if(!m) throw new Error('Parse error');
  const km=[+m[1],+m[2],+m[3]], vkm=[+m[4],+m[5],+m[6]];
  const au = km.map(v=> v/AU_KM);
  return {au, km, vkm};
}

async function gaiaCone(raDeg,decDeg,radiusDeg=0.2,limit=1){
  const adql=`SELECT TOP ${limit} source_id,ra,dec,parallax,pmra,pmdec,radial_velocity,phot_g_mean_mag
FROM gaiadr3.gaia_source
WHERE 1=CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${raDeg}, ${decDeg}, ${radiusDeg}))
ORDER BY phot_g_mean_mag ASC`;
  const form = new URLSearchParams({ QUERY: adql });
  const r = await fetch(GAIA_TAP, { method:'POST', body: form });
  if(!r.ok) return [];
  const text = await r.text();
  const lines = text.trim().split(/\n+/);
  if(lines[0]?.includes('<?xml')) return []; // safety
  const header = lines[0].split(/,|\t/);
  return lines.slice(1).map(l=>{
    const a=l.split(/,|\t/); const o={};
    header.forEach((h,i)=> o[h.trim()] = a[i]?a[i].trim():null);
    return o;
  });
}

/* ========= UPDATE LOGIC ========= */
async function updateRow(t, id, force){
  const vecEl = document.getElementById(`vec-${id}`);
  const sunEl = document.getElementById(`sun-${id}`);
  const earthEl = document.getElementById(`earth-${id}`);
  const pmEl = document.getElementById(`pm-${id}`);
  const rvEl = document.getElementById(`rv-${id}`);
  const distEl = document.getElementById(`dist-${id}`);
  const recEl = document.getElementById(`rec-${id}`);
  const updEl = document.getElementById(`upd-${id}`);
  const stEl = document.getElementById(`status-${id}`);

  try{
    const isoUtc = new Date().toISOString();
    let cmd = t?.horizonsId ?? t?.naifId ?? t?.command ?? null;

    // Live vectors via Horizons (if we have an ID/command)
    if(cmd){
      const vec = await horizonsVector(String(cmd), isoUtc);
      vecEl.textContent = `[${fmt(vec.au[0])}, ${fmt(vec.au[1])}, ${fmt(vec.au[2])}]`;
      const rSunAu = norm(vec.au);
      sunEl.textContent = `${fmtAU(rSunAu)} (${fmtMi(rSunAu*MI_PER_AU)})`;

      // Earth distance
      const earth = await horizonsVector('399', isoUtc);
      const rEarthAu = norm(sub(vec.au, earth.au));
      earthEl.textContent = `${fmtAU(rEarthAu)} (${fmtMi(rEarthAu*MI_PER_AU)})`;

      stEl.textContent = 'live via Horizons'; stEl.classList.add('ok');
    } else {
      // No live vector; show RA/Dec if present
      if(typeof t?.ra === 'number' && typeof t?.dec === 'number'){
        vecEl.textContent = `RA ${t.ra}°, Dec ${t.dec}°`;
      } else {
        vecEl.textContent = '—';
      }
      stEl.textContent = 'static (add horizonsId/naifId/command for live)'; stEl.classList.add('warn');
    }

    // Gaia star context if we have RA/Dec
    if(typeof t?.ra === 'number' && typeof t?.dec === 'number'){
      const stars = await gaiaCone(t.ra, t.dec, 0.2, 1);
      if(stars.length){
        const s = stars[0];
        const pmra = parseFloat(s.pmra||0), pmdec = parseFloat(s.pmdec||0);
        pmEl.textContent = `${pmra.toFixed(1)}, ${pmdec.toFixed(1)} mas/yr`;
        const rv = parseFloat(s.radial_velocity||'');
        rvEl.textContent = isFinite(rv)? `${rv.toFixed(1)} km/s` : '—';
        const px = parseFloat(s.parallax||'');
        if(px>0){
          const d_pc = 1000/px; distEl.textContent = `${d_pc.toFixed(0)} pc`;
          const vrec = H0 * (d_pc/1e6); recEl.textContent = `${vrec.toFixed(3)} km/s`;
        } else { distEl.textContent = '—'; }
      } else {
        pmEl.textContent='—'; rvEl.textContent='—';
      }
    }

    updEl.textContent = fmtISO(isoUtc);
  } catch(err){
    stEl.textContent = 'error: ' + err.message;
    stEl.classList.remove('ok','warn'); stEl.classList.add('bad');
  }
}

/* ========= TARGETS LOADER (robust) ========= */
function normalizeTargets(raw){
  if(Array.isArray(raw)) return raw.map(x=> typeof x==='string'? {name:x}: x);
  if(raw && Array.isArray(raw.targets)) return raw.targets.map(x=> typeof x==='string'? {name:x}: x);
  return []; // unknown structure
}

async function loadTargets(){
  try{
    // cache-bust to avoid stale JSON on GitHub Pages
    const r = await fetch(`${TARGETS_URL}?v=${Date.now()}`, { cache: "no-store" });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ throw new Error("Invalid JSON in targets.json"); }

    const list = normalizeTargets(data);
    if(!list.length){
      setBanner("No targets found. Ensure targets.json is an array or { \"targets\": [...] }.", "warn");
      return;
    }
    setBanner(`Loaded ${list.length} target(s) from targets.json.`, "ok");
    list.forEach(makeRow);
  } catch(err){
    setBanner(`Failed to load targets.json: ${err.message}`, "bad");
  }
}

/* ========= CLOCK TICK ========= */
function tick(){
  document.getElementById('localTime').textContent = chicagoNow();
  document.getElementById('tzName').textContent = tzLabel();
  document.getElementById('interstellarYear').textContent = interstellarYear();
  document.getElementById('stardate').textContent = stardate();
}
setInterval(tick, 1000); tick();

/* ========= INIT ========= */
loadTargets();
</script>
</body>
</html>
