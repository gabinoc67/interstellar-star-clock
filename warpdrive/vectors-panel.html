<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FTL Nav Console — CST + Solver (Offline, Expansion + Real Distances)</title>
<style>
:root{
  --bg:#060a16;--card:#0f1630;--ink:#eaf0ff;--muted:#9fb0e0;
  --good:#3dd07f;--warn:#ffd166;--bad:#ef476f;--grid:18px;
}
*{box-sizing:border-box}
body{
  margin:0;background:linear-gradient(180deg,#060a16,#0b1233);
  color:var(--ink);font:19.8px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial; /* +20% */
}
header{
  padding:30px 32px;border-bottom:1px solid rgba(255,255,255,.06);
  position:sticky;top:0;background:rgba(8,12,30,.78);backdrop-filter:blur(8px);z-index:50
}
.wrap{padding:30px;max-width:2100px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--grid)}
.card{
  background:var(--card);border:1px solid rgba(255,255,255,.06);
  border-radius:20px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,.28)
}
.card h2{margin:0 0 12px 0;font-size:22.8px} /* +20% */
.row{
  display:grid;
  grid-template-columns:
    360px 110px 1.25fr 1.05fr 1.0fr 1.0fr 1.1fr 1.0fr 1.1fr 1.0fr;
  gap:14px;align-items:flex-start;padding:14px 0;
  border-bottom:1px dashed rgba(255,255,255,.08)
}
.row.header{
  font-weight:700;color:#cbd5ff;border-bottom:1px solid rgba(255,255,255,.14);
  position:sticky;top:96px;background:linear-gradient(180deg,#0f1630,rgba(15,22,48,.6));z-index:5
}
.row > div{min-height:28px}
.group{
  padding:12px 14px;margin:12px 0;border-radius:14px;
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
  font-weight:700;color:#b9c7ff
}
.mono{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
  font-size:1.06em;word-break:break-word
}
.pill{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.08);font-size:1em}
.ok{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.small{font-size:16px;color:#9fb0e0} /* +20% */
.banner{margin:14px 0;padding:14px 16px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
.scrolly{max-height:65vh;overflow:auto;padding-right:8px}
label input{margin-left:10px}
</style>
</head>
<body>
<header>
  <h1>FTL Nav Console — CST + Solver</h1>
  <div class="small">
    100% offline. Planets/moons use built-in ephemerides; stars/galaxies use <b>real distances</b> (distance_pc/parallax_mas) and evolve via Hubble expansion. Updates every second.
  </div>
</header>

<div class="wrap grid">
  <section class="card" style="grid-column: span 6">
    <h2>Quantum Clocks</h2>
    <div class="grid" style="grid-template-columns: repeat(3,1fr); gap:16px">
      <div><div class="small">Local Time (America/Chicago)</div><div class="mono" id="localTime">—</div><div class="small" id="tzName">—</div></div>
      <div><div class="small">Interstellar Time (demo)</div><div class="mono" id="interstellarYear">—</div></div>
      <div><div class="small">Stardate (demo)</div><div class="mono" id="stardate">—</div></div>
    </div>
    <div class="small" style="margin-top:8px">CST↔UTC offset: <span id="cstOffset">—</span> • UTC epoch: <span class="mono" id="utcEpoch">—</span></div>
    <div class="banner mono" id="statusBanner">Initializing offline models…</div>
  </section>

  <section class="card" style="grid-column: span 6">
    <h2>Expansion & Uncertainty</h2>
    <div class="small">Hubble flow for stars/galaxies; planets/moons are bound but we still show cosmological “Distance” and “Rec. Vel.” from their live Earth-range (tiny but non-zero).</div>
    <div class="small" style="margin-top:10px">
      <label>H₀ (km/s/Mpc) <input id="h0" type="number" step="0.1" value="70" style="width:120px"></label>
      <label style="margin-left:20px">Seed star distance (pc, only if missing) <input id="seedStarPc" type="number" step="0.1" value="10" style="width:140px"></label>
      <label style="margin-left:20px">Seed galaxy distance (Mpc, only if missing) <input id="seedGalMpc" type="number" step="0.01" value="1.00" style="width:140px"></label>
    </div>
  </section>

  <section class="card" style="grid-column: span 12">
    <h2>Targets + CST Solver</h2>
    <div class="row header">
      <div>Name</div><div>Type</div><div>Live Vector (AU)</div><div>Dist. Earth</div>
      <div>Proper Motion</div><div>Radial Vel.</div><div>Distance</div><div>Rec. Vel</div>
      <div>Uncertainty</div><div>Last Update</div>
    </div>
    <div id="targets" class="scrolly"></div>
  </section>

  <section class="card" style="grid-column: span 12">
    <h2>About</h2>
    <div class="small">
      <b>Stars/Galaxies</b>: Uses your real distance (<code>distance_pc</code> or <code>parallax_mas</code>). Evolves via D(t)=D₀·exp(H₀·Δt) with H₀→s⁻¹. Radial/Rec. Vel.=H₀·D(t). Proper motion≈0 mas/yr under expansion.<br/>
      <b>Planets/Moons</b>: Live Earth-range from a 2-body ephemeris (planets) or simple circular model (moons). “Distance” shows that live range in ly/Mpc; “Rec. Vel.” = H₀ × Distance(t) (very small, as expected). Radial Vel.=line-of-sight vs Earth.<br/>
      <b>Uncertainty</b>: |Δdistance| in light-years since the first timestamp t₀ (stars/galaxies use cosmological D; planets/moons use live range).
    </div>
  </section>
</div>

<script>
/* ===== Embedded catalog with REAL distances (used if targets.json isn’t reachable) ===== */
const EMBEDDED_CATALOG = {
  "meta":{"note":"Real distances included. Stars/galaxies have distance_pc; planets/moons are bound system.","version":"2025-08-12"},
  "planets":[{"name":"Mercury"},{"name":"Venus"},{"name":"Earth"},{"name":"Mars"},{"name":"Jupiter"},{"name":"Saturn"},{"name":"Uranus"},{"name":"Neptune"}],
  "moons":[{"name":"Moon"},{"name":"Europa"},{"name":"Ganymede"},{"name":"Callisto"},{"name":"Titan"}],
  "stars":[
    {"name":"Sirius","ra_deg":101.287,"dec_deg":-16.716,"distance_pc":2.637},
    {"name":"Proxima Centauri","ra_deg":217.429,"dec_deg":-62.679,"distance_pc":1.302},
    {"name":"Alpha Centauri","ra_deg":219.902,"dec_deg":-60.835,"distance_pc":1.338},
    {"name":"Barnard's Star","ra_deg":269.454,"dec_deg":4.693,"distance_pc":1.821},
    {"name":"Ross 128","ra_deg":176.0,"dec_deg":0.8,"distance_pc":3.379},
    {"name":"Epsilon Eridani","ra_deg":53.232,"dec_deg":-9.458,"distance_pc":3.218},
    {"name":"Tau Ceti","ra_deg":26.017,"dec_deg":-15.937,"distance_pc":3.65},
    {"name":"Kapteyn's Star","ra_deg":200.981,"dec_deg":-45.246,"distance_pc":3.91},
    {"name":"Groombridge 34 (GX And)","ra_deg":30.75,"dec_deg":44.0,"distance_pc":3.562}
  ],
  "galaxies":[
    {"name":"Andromeda Galaxy (M31)","ra_deg":10.684,"dec_deg":41.269,"distance_pc":776000},
    {"name":"Triangulum Galaxy (M33)","ra_deg":23.462,"dec_deg":30.66,"distance_pc":859000},
    {"name":"Sombrero Galaxy (M104)","ra_deg":189.997,"dec_deg":-11.623,"distance_pc":9550000},
    {"name":"Pinwheel Galaxy (M101)","ra_deg":210.802,"dec_deg":54.349,"distance_pc":6900000},
    {"name":"Sculptor Galaxy (NGC 253)","ra_deg":11.888,"dec_deg":-25.288,"distance_pc":3500000},
    {"name":"Large Magellanic Cloud (center)","ra_deg":80.894,"dec_deg":-69.756,"distance_pc":49600},
    {"name":"Small Magellanic Cloud (center)","ra_deg":13.186,"dec_deg":-72.828,"distance_pc":62000}
  ]
};

/* ===== Units & helpers ===== */
const AU_KM=149_597_870.700, KM_PER_MI=1.609344, MI_PER_AU=AU_KM/KM_PER_MI, C_KM_S=299_792.458;
const KM_PER_MPC=3.085677581e19, PC_TO_LY=3.261563777, AU_PER_LY=63241.077;
const DEG=Math.PI/180;
const fmt=(n,d=6)=>Number(n).toFixed(d);
const fmtAU=x=>fmt(x,6)+" AU";
const fmtMi=x=>Number(x).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})+" miles";
const fmtISO=d=>new Date(d).toISOString().replace('.000Z','Z');
const norm=v=>Math.hypot(...v);
const sub=(a,b)=>a.map((v,i)=>v-b[i]);
const add=(a,b)=>a.map((v,i)=>v+b[i]);
const scale=(a,s)=>a.map(v=>v*s);
const cross=(a,b)=>[a[1]*b[2]-a[2]*b[1], a[2]*b[0]-a[0]*b[2], a[0]*b[1]-a[1]*b[0]];
const unit=v=>{const n=norm(v);return n?scale(v,1/n):[1,0,0];};
function chicagoNow(){const o={timeZone:'America/Chicago',hour12:true,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'};return new Intl.DateTimeFormat(undefined,o).format(new Date())}
function tzLabel(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch{return'Local TZ'}}
function interstellarYear(){const s=Date.now()/1000;const y=57_800_000+(s/31557600)*100;return `Year ~${y.toFixed(2)}`}
function stardate(){const ms=Date.now();const base=Date.UTC(2323,0,1);const sd=1000*((ms-base)/31557600000);return `Stardate ${(sd/10).toFixed(1)}`}
function cstToUtcOffset(){const off=-new Date().getTimezoneOffset()/60;const s=off>=0?'+':'';return `${s}${off.toFixed(0)} h`}
function toJD(date){let Y=date.getUTCFullYear(),M=date.getUTCMonth()+1,D=date.getUTCDate();let h=date.getUTCHours(),m=date.getUTCMinutes(),s=date.getUTCSeconds()+date.getUTCMilliseconds()/1000;if(M<=2){Y-=1;M+=12;}const A=Math.floor(Y/100),B=2-A+Math.floor(A/4);const day=D+(h+(m+s/60)/60)/24;return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+day+B-1524.5;}
const JD_J2000=2451545.0;

/* ===== Planetary & lunar offline states ===== */
const ORBITS={Mercury:{a:0.38709893,e:0.20563069,i:7.00487,O:48.33167,p:77.45645,L0:252.25084,P:87.969},Venus:{a:0.72333199,e:0.00677323,i:3.39471,O:76.68069,p:131.53298,L0:181.97973,P:224.701},Earth:{a:1.00000011,e:0.01671022,i:0.00005,O:-11.26064,p:102.94719,L0:100.46435,P:365.256},Mars:{a:1.52366231,e:0.09341233,i:1.85061,O:49.57854,p:336.04084,L0:355.45332,P:686.980},Jupiter:{a:5.20336301,e:0.04839266,i:1.30530,O:100.55615,p:14.75385,L0:34.40438,P:4332.589},Saturn:{a:9.53707032,e:0.05415060,i:2.48446,O:113.71504,p:92.43194,L0:49.94432,P:10759.22},Uranus:{a:19.19126393,e:0.04716771,i:0.76986,O:74.22988,p:170.96424,L0:313.23218,P:30685.4},Neptune:{a:30.06896348,e:0.00858587,i:1.76917,O:131.72169,p:44.97135,L0:304.88003,P:60190.0}};
const MOON_ORBITS={Moon:{primary:"Earth",a_au:0.002569,P_days:27.321661,phase_deg:20},Europa:{primary:"Jupiter",a_au:0.004484,P_days:3.551181,phase_deg:45},Ganymede:{primary:"Jupiter",a_au:0.007155,P_days:7.154553,phase_deg:90},Callisto:{primary:"Jupiter",a_au:0.012585,P_days:16.689018,phase_deg:135},Titan:{primary:"Saturn",a_au:0.008168,P_days:15.945,phase_deg:60}};
function solveKepler(M,e){let E=M,d;for(let k=0;k<12;k++){d=(E-e*Math.sin(E)-M)/(1-e*Math.cos(E));E-=d;if(Math.abs(d)<1e-12)break;}return E;}
function planetPosAU(name,jd){const el=ORBITS[name];if(!el)return{r:[NaN,NaN,NaN]};const dt=jd-JD_J2000;const n=360/el.P;const M=((el.L0-el.p)+n*dt)*DEG;const w=(el.p-el.O)*DEG,O=el.O*DEG,I=el.i*DEG;const e=el.e,a=el.a;const E=solveKepler(M,e);const cosE=Math.cos(E),sinE=Math.sin(E),b=Math.sqrt(1-e*e);const r=a*(1-e*cosE);const cosv=(cosE-e)/(1-e*cosE),sinv=(b*sinE)/(1-e*cosE);const v=Math.atan2(sinv,cosv),u=w+v;const cosO=Math.cos(O),sinO=Math.sin(O),cosI=Math.cos(I),sinI=Math.sin(I),cosu=Math.cos(u),sinu=Math.sin(u);const x=r*(cosO*cosu - sinO*sinu*cosI);const y=r*(sinO*cosu + cosO*sinu*cosI);const z=r*(sinu*sinI);return{r:[x,y,z]};}
function stateAU(name,date){const jd=toJD(date),d=1/86400;const p0=planetPosAU(name,jd).r;const pP=planetPosAU(name,jd+d).r;const pM=planetPosAU(name,jd-d).r;const v_au_s=scale(sub(pP,pM),1/(2*1));return{r:p0,v_au_s};}
function moonStateAU(m,date){const cfg=MOON_ORBITS[m];if(!cfg)return null;const {primary,a_au,P_days,phase_deg}=cfg;const jd=toJD(date);const prim=stateAU(primary,date);const rhat=unit(prim.r),that=unit(prim.v_au_s),nhat=unit(cross(rhat,that));const e1=that,e2=nhat;const omega=2*Math.PI/(P_days*86400);const theta=(phase_deg*DEG)+omega*((jd-JD_J2000)*86400);const cosT=Math.cos(theta),sinT=Math.sin(theta);const r_rel=add(scale(e1,a_au*cosT),scale(e2,a_au*sinT));const v_rel=add(scale(e1,-a_au*omega*sinT),scale(e2,a_au*omega*cosT));return{r:add(prim.r,r_rel),v_au_s:add(prim.v_au_s,v_rel)};}

/* ===== Target helpers & normalization ===== */
function pickPlanetName(name){const m={mercury:"Mercury",venus:"Venus",earth:"Earth",terra:"Earth",mars:"Mars",jupiter:"Jupiter",saturn:"Saturn",uranus:"Uranus",neptune:"Neptune"};const k=m[name]||m[name?.replace(/\s+/g,'')];const c=name?name[0].toUpperCase()+name.slice(1):"";return ORBITS[k]?k:(ORBITS[c]?c:null);}
function pickMoonName(name){const m={moon:"Moon",europa:"Europa",ganymede:"Ganymede",callisto:"Callisto",titan:"Titan"};const k=m[name]||m[name?.replace(/\s+/g,'')];return MOON_ORBITS[k]?k:null;}
function mapOne(o){const t={...o};if(t.ra==null && typeof t.ra_deg==="number") t.ra=t.ra_deg;if(t.dec==null && typeof t.dec_deg==="number") t.dec=t.dec_deg;return t;}
function normalizeTargets(raw){
  if(Array.isArray(raw)) return raw.map(x=> typeof x==='string'? {name:x} : mapOne(x));
  const groups=["planets","moons","stars","galaxies"]; let out=[];
  for(const g of groups){ if(Array.isArray(raw?.[g])) out=out.concat(raw[g].map(item=>{const o=typeof item==='string'?{name:item}:mapOne(item);o.group=g;o.type=o.type||g.slice(0,-1);return o;})); }
  if(out.length) return out;
  for(const key of ['targets','data','items']) if(raw && Array.isArray(raw[key])) return raw[key].map(x=> typeof x==='string'? {name:x} : mapOne(x));
  if(raw && typeof raw==='object'){const arr=[];for(const k of Object.keys(raw)){const v=raw[k];if(v && typeof v==='object') arr.push(mapOne({name:v.name||k,...v}));}if(arr.length) return arr;}
  return [];
}

/* ===== UI build ===== */
const rowsEl=document.getElementById('targets');
const banner=document.getElementById('statusBanner');
function setBanner(msg,cls){banner.textContent=msg;banner.className='banner mono '+(cls||'')}
const GROUP_ORDER=["planets","moons","stars","galaxies"];
const GROUP_LABEL={planets:"Planets",moons:"Moons",stars:"Stars",galaxies:"Galaxies",other:"Other"};
function addGroupHeader(label){const g=document.createElement('div');g.className='group';g.textContent=label;rowsEl.appendChild(g);}
function makeRow(t){
  const el=document.createElement('div');el.className='row';
  const id=(t.id||t.name||'target').toString().replace(/\W+/g,'_');el.id=`row-${id}`;
  el.innerHTML=`
    <div><div><strong>${t.name||'(unnamed target)'}</strong></div><div class="small">${t.id||''}</div></div>
    <div><span class="pill">${t.type||t.group||'—'}</span></div>
    <div class="mono" id="vec-${id}">—</div>
    <div id="earth-${id}">—</div>
    <div id="pm-${id}">—</div>
    <div id="rv-${id}">—</div>
    <div id="dist-${id}">—</div>
    <div id="rec-${id}">—</div>
    <div id="unc-${id}">—</div>
    <div class="small" id="upd-${id}">—</div>`;
  rowsEl.appendChild(el);
}
function renderTargets(list){
  rowsEl.innerHTML='';
  const by=new Map();
  list.forEach(t=>{const g=t.group||'other';if(!by.has(g))by.set(g,[]);by.get(g).push(t)});
  [...GROUP_ORDER,'other'].forEach(g=>{const arr=by.get(g)||[];if(!arr.length)return;addGroupHeader(GROUP_LABEL[g]||g);arr.forEach(makeRow);});
}

/* ===== Per-target runtime state ===== */
const RUN = new Map(); // name -> {t0_ms, D0_ly, range0_ly}

/* ===== Live update (1 Hz) ===== */
const keyOf=t=>(t.id||t.name||'target').toString().replace(/\W+/g,'_');

function updateOne(t){
  const id=keyOf(t);
  const g=sel=>document.getElementById(sel);
  const vecEl=g(`vec-${id}`), earthEl=g(`earth-${id}`), pmEl=g(`pm-${id}`), rvEl=g(`rv-${id}`),
        distEl=g(`dist-${id}`), recEl=g(`rec-${id}`), uncEl=g(`unc-${id}`), updEl=g(`upd-${id}`);

  const now=new Date(); const jd=toJD(now);
  const H0_kmsmpc = Number(document.getElementById('h0').value||70);
  const H0_per_s = H0_kmsmpc / KM_PER_MPC; // km/s/Mpc -> s^-1

  const lower=(t.name||"").toLowerCase();
  const moonKey = pickMoonName(lower);
  const plKey   = pickPlanetName(lower);

  if(!RUN.has(t.name)) RUN.set(t.name,{t0_ms:Date.now(),D0_ly:null,range0_ly:null});
  const st = RUN.get(t.name);

  // Earth state (for planets/moons LOS + range)
  const e = stateAU("Earth", now);

  if (plKey || moonKey){
    // ----- Planets & Moons -----
    const s = plKey ? stateAU(plKey, now) : moonStateAU(moonKey, now);
    if(!s){ vecEl.textContent='—'; earthEl.textContent='—'; pmEl.textContent='—'; rvEl.textContent='—'; distEl.textContent='—'; recEl.textContent='—'; uncEl.textContent='—'; updEl.textContent=fmtISO(now); return; }
    const r = s.r, v = s.v_au_s;

    const rET = sub(r, e.r);
    const R_AU = norm(rET);
    const R_ly = (R_AU / AU_PER_LY);
    const R_Mpc = (R_ly / (1e6 * PC_TO_LY)); // ly -> pc -> Mpc

    // live vector (heliocentric AU)
    vecEl.textContent = `[${fmt(r[0])}, ${fmt(r[1])}, ${fmt(r[2])}]`;

    // Dist. Earth (AU + miles)
    earthEl.textContent = `${fmtAU(R_AU)} (${fmtMi(R_AU*MI_PER_AU)})`;

    // Proper motion under expansion not applicable (bound)
    pmEl.textContent = '≈0.0 mas/yr (bound)';

    // Radial velocity = line-of-sight vs Earth (km/s)
    const rhat = unit(rET);
    const vrel = sub(v, e.v_au_s);
    const rv_km_s = (vrel[0]*rhat[0]+vrel[1]*rhat[1]+vrel[2]*rhat[2]) * AU_KM;
    rvEl.textContent = `${rv_km_s.toFixed(2)} km/s`;

    // Distance column (like stars/galaxies): live Earth-range in ly + Mpc
    distEl.textContent = `${R_ly.toLocaleString(undefined,{maximumFractionDigits:10})} ly (${R_Mpc.toExponential(6)} Mpc)`;

    // Rec. Vel (like stars/galaxies): H0 * Distance(t) in Mpc
    const vrec_km_s = H0_kmsmpc * R_Mpc;
    recEl.textContent = `${vrec_km_s.toFixed(6)} km/s`;

    // Uncertainty = |Δdistance| in ly since t0 (use range)
    if (st.range0_ly==null) st.range0_ly = R_ly;
    const dLy = Math.abs(R_ly - st.range0_ly);
    uncEl.textContent = `${dLy.toExponential(6)} ly (Δ since t₀)`;

    updEl.textContent = fmtISO(now);
    return;
  }

  // ----- Stars & Galaxies (real distances + Hubble evolution) -----
  if (typeof t.ra!=="number" && typeof t.ra_deg==="number") t.ra=t.ra_deg;
  if (typeof t.dec!=="number" && typeof t.dec_deg==="number") t.dec=t.dec_deg;

  if (typeof t.ra==="number" && typeof t.dec==="number"){
    // Prefer parallax_mas, else distance_pc; seeds only if both missing
    let D0_pc = null;
    if (typeof t.parallax_mas==="number" && t.parallax_mas>0) D0_pc = 1000 / t.parallax_mas;
    else if (typeof t.distance_pc==="number" && t.distance_pc>0) D0_pc = t.distance_pc;
    else {
      const seedStarPc = Number(document.getElementById('seedStarPc').value||10);
      const seedGalMpc = Number(document.getElementById('seedGalMpc').value||1.0);
      D0_pc = (t.group==="galaxies") ? seedGalMpc*1e6 : seedStarPc;
    }

    const D0_Mpc = D0_pc / 1e6;
    const dt_s = (Date.now()-st.t0_ms)/1000;
    const D_Mpc = D0_Mpc * Math.exp(H0_per_s * dt_s);      // Hubble growth
    const vrec_km_s = H0_kmsmpc * D_Mpc;                   // H0 * D(t)

    // Convert to AU for vector + Dist. Earth display
    const D_pc = D_Mpc * 1e6;
    const D_ly = D_pc * PC_TO_LY;
    const D_AU = D_ly * AU_PER_LY;

    const a=t.ra*DEG, d=t.dec*DEG;
    const dir=[Math.cos(d)*Math.cos(a), Math.cos(d)*Math.sin(a), Math.sin(d)];
    const r = scale(dir, D_AU);

    vecEl.textContent = `[${fmt(r[0])}, ${fmt(r[1])}, ${fmt(r[2])}]`;
    earthEl.textContent = `${fmtAU(D_AU)} (${fmtMi(D_AU*MI_PER_AU)})`;
    pmEl.textContent = '≈0.0 mas/yr (Hubble)';
    rvEl.textContent = `${vrec_km_s.toFixed(2)} km/s`;
    distEl.textContent = `${(D_ly).toLocaleString(undefined,{maximumFractionDigits:2})} ly (${D_Mpc.toFixed(6)} Mpc)`;
    recEl.textContent = `${vrec_km_s.toFixed(2)} km/s`;

    if (st.D0_ly==null) st.D0_ly = D0_pc * PC_TO_LY;
    const dLy = Math.abs(D_ly - st.D0_ly);
    uncEl.textContent = `${dLy.toExponential(6)} ly (Δ since t₀)`;

    updEl.textContent = fmtISO(now);
    return;
  }

  // Fallback
  vecEl.textContent='—'; earthEl.textContent='—'; pmEl.textContent='—'; rvEl.textContent='—'; distEl.textContent='—'; recEl.textContent='—'; uncEl.textContent='—'; updEl.textContent=fmtISO(now);
}

function refreshOnce(){ if(!LIVE_LIST.length) return; for(const t of LIVE_LIST) updateOne(t); }
let LIVE_LIST=[], liveTimer=null;
function startLive(){ stopLive(); liveTimer=setInterval(refreshOnce,1000); }
function stopLive(){ if(liveTimer){ clearInterval(liveTimer); liveTimer=null; } }

/* ===== Clocks ===== */
function tick(){
  document.getElementById('localTime').textContent=chicagoNow();
  document.getElementById('tzName').textContent=tzLabel();
  document.getElementById('interstellarYear').textContent=interstellarYear();
  document.getElementById('stardate').textContent=stardate();
  document.getElementById('cstOffset').textContent=cstToUtcOffset();
  document.getElementById('utcEpoch').textContent=new Date().toISOString().replace('T',' ').replace('Z','Z');
}
setInterval(tick,1000); tick();

/* ===== Load targets (prefer your file with real distances) ===== */
async function loadTargets(){
  try{
    if (location.protocol === 'file:') throw new Error('file://');
    const r = await fetch('targets.json?v='+Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const text = await r.text(); let data;
    try{ data=JSON.parse(text); } catch { throw new Error('Invalid JSON in targets.json'); }
    const list = normalizeTargets(data); if(!list.length) throw new Error('No targets in targets.json');
    setBanner(`Loaded ${list.length} target(s) from targets.json (real distances in use).`, 'ok');
    renderTargets(list); LIVE_LIST=list; startLive();
  }catch(e){
    const list = normalizeTargets(EMBEDDED_CATALOG);
    setBanner(`Using embedded catalog (${list.length}) with real distances — offline mode.`, 'warn');
    renderTargets(list); LIVE_LIST=list; startLive();
  }
}
loadTargets();
</script>
</body>
</html>
