<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FTL Nav Console — CST + Solver (Original)</title>
<style>
  :root{
    --scale:1.10;
    --panel:#111a2b; --ink:#e9eef9; --muted:#a9b6d3; --stroke:#274061; --grid:#1b2740;
    --accent:#7dd3fc; --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#081020,#0c1730 55%,#0a1427);
    color:var(--ink);
    font:calc(16px*var(--scale))/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    padding:28px;
  }
  h1{margin:0 0 8px; font-size:clamp(22px,3.2vw,32px); font-weight:800}
  .sub{color:var(--muted); margin:0 0 20px; font-size:.95rem}
  .wrap{width:min(1400px,96vw); margin:0 auto; display:grid; gap:18px}
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:18px}
  .grid.equal{ grid-auto-rows:1fr } /* equal-height row */
  .card{background:var(--panel); border:1px solid var(--stroke); border-radius:var(--radius); overflow:hidden; height:100%}
  .card header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px solid var(--stroke);
    background:radial-gradient(1200px 300px at 20% -20%, rgba(125,211,252,.08), transparent 60%);}
  .card header h2{margin:0; font-size:1.05rem; font-weight:800}
  .badge{padding:.25rem .55rem; border:1px solid var(--stroke); border-radius:999px; color:#b8c5e0; background:#0a182c; font-size:.85rem}
  .body{padding:16px}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .big{font-size:clamp(24px,3.8vw,36px); font-weight:800; letter-spacing:.4px; font-variant-numeric:tabular-nums}
  .pill{background:#0c1a30; border:1px solid var(--stroke); border-radius:10px; padding:.35rem .55rem; font-variant-numeric:tabular-nums}
  .button{cursor:pointer; user-select:none}
  /* Quantum Clocks: 3 equal columns */
  .qgrid{ display:grid; gap:16px }
  @media (min-width:900px){ .qgrid{ grid-template-columns:repeat(3,1fr) } }
  .metric{ display:grid; gap:6px }
  /* evenly spaced controls */
  .even{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; align-items:center }
  /* table */
  .table{width:100%; border-collapse:separate; border-spacing:0}
  .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--grid); text-align:left}
  .table thead th{position:sticky; top:0; background:#0f1830; z-index:1; font-size:.92rem; color:#cfd7eb}
  .table tbody tr:hover{background:#0d1730}
  .num{font-variant-numeric:tabular-nums}
  .toolbar{display:flex; gap:8px; align-items:center}
  input{background:#0b152a; border:1px solid var(--stroke); color:var(--ink); border-radius:10px; font:inherit; padding:.45rem .6rem}
  input[type="number"]{width:12ch}
  .span12{grid-column:span 12}
  .span6{grid-column:span 12}
  @media (min-width:980px){ .span6{grid-column:span 6} }
  .status{ margin-top:10px; padding:10px 12px; border:1px dashed #32496b; border-radius:12px; background:#0b162b; color:#d0d7ea }
  .status.ok{ border-color:#2f6b45; background:#0e1f1a; color:#bde6c7 }
  .selected{ outline:2px solid #7dd3fc66; background:#0e1f33 !important }
</style>
</head>
<body>
  <div class="wrap">
    <h1>FTL Nav Console — CST + Solver</h1>
    <p class="sub">
      Targets from <span class="mono">targets.json</span> (same folder). Live vectors via NASA Horizons; Gaia for stellar context.
      Includes a CST arrival solver and bubble shaping for Δ<sub>warp</sub>.
    </p>

    <!-- Quantum Clocks + Solver Settings (same row) -->
    <div class="grid equal">
      <section class="card span6">
        <header>
          <h2>Quantum Clocks</h2>
          <span class="badge" id="tzBadge">—</span>
        </header>
        <div class="body qgrid">
          <div class="metric">
            <div class="muted">Local Time (system)</div>
            <div class="mono" id="localDate">--/--/----, --:--:--</div>
            <div class="mono" id="localTz">—</div>
            <div class="mono" id="offsetLine">—</div>
          </div>
          <div class="metric">
            <div class="muted">Interstellar Time <span class="badge">original</span></div>
            <div class="big mono" id="interstellarYear">Year ~57,889,169.3</div>
          </div>
          <div class="metric">
            <div class="muted">Stardate <span class="badge">original</span></div>
            <div class="big mono" id="stardateNow">Stardate −29,737.8</div>
          </div>
        </div>
        <div class="body">
          <div class="status mono" id="statusMsg">Loading targets…</div>
        </div>
      </section>

      <section class="card span6">
        <header><h2>Solver Settings</h2></header>
        <div class="body even">
          <label>H₀ (km/s/Mpc) <input type="number" id="H0" value="70" step="0.1"></label>
          <label>Tolerance (km) <input type="number" id="tolKm" value="10000" step="100"></label>
          <label>Max Horizon Δt (s) <input type="number" id="horizon" value="86400" step="60"></label>
          <div class="muted">Ship exits when |error| ≤ tolerance.</div>
        </div>
      </section>
    </div>

    <!-- Targets -->
    <section class="card span12">
      <header>
        <h2>Targets + CST Solver</h2>
        <div class="toolbar">
          <button class="pill button" id="btnFetchVectors">Get Vectors</button>
          <button class="pill button" id="btnSolve">Solve Tc</button>
          <button class="pill button" id="btnShape">Shape Bubble</button>
          <span class="muted">Tip: click a row to select it.</span>
        </div>
      </header>
      <div class="body">
        <table class="table mono" id="targetsTable">
          <thead>
            <tr>
              <th>Name</th><th>Type</th><th>Live Vector (AU)</th><th>Dist. Sun</th><th>Dist. Earth</th>
              <th>Proper Motion</th><th>Radial Vel.</th><th>Distance</th><th>Rec. Vel.</th><th>Uncertainty</th>
              <th>Last Update</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- Math -->
    <section class="card span12">
      <header><h2>Math (implemented)</h2></header>
      <div class="body muted mono" style="font-size:.95rem">
        Closest-approach: T<sub>c</sub> = −(R·V)/||V||², with R = P<sub>target</sub> − P<sub>ref</sub>, V = V<sub>target</sub> − V<sub>ref</sub> (vectors in AU and AU/day).<br/>
        Distances: d<sub>☉</sub> = ||P<sub>heliocentric</sub>|| (AU), d<sub>⊕</sub> = ||P<sub>geocentric</sub>|| (AU).<br/>
        Radial velocity (from vectors): v<sub>r</sub> = (V·Ŕ) · (AU/day → km/s), Ŕ = R/||R||.<br/>
        Expansion (demo): v<sub>rec</sub> = H₀·D<sub>Mpc</sub>, z ≈ v<sub>rec</sub>/c for z ≪ 1.
      </div>
    </section>
  </div>

<script>
/* ========== Constants & Utils ========== */
const AU_KM = 149_597_870.7;
const AU_PER_DAY_TO_KM_S = AU_KM / 86400; // ≈1731.456
const C_KM_S = 299_792.458;

const fmt = (n, f=2)=>Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:f,minimumFractionDigits:f}) : '—';
const v3 = {
  add: (a,b)=>[a[0]+b[0],a[1]+b[1],a[2]+b[2]],
  sub: (a,b)=>[a[0]-b[0],a[1]-b[1],a[2]-b[2]],
  dot: (a,b)=>a[0]*b[0]+a[1]*b[1]+a[2]*b[2],
  norm: a => Math.hypot(a[0],a[1],a[2]),
  mul: (a,s)=>[a[0]*s,a[1]*s,a[2]*s],
  unit: a => { const n=Math.hypot(a[0],a[1],a[2]); return n? [a[0]/n,a[1]/n,a[2]/n] : [0,0,0]; }
};
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
const slug = s => (s||'').toLowerCase().trim().replace(/[^\w]+/g,'-').replace(/^-+|-+$/g,'');

/* ========== Quantum Clocks (original numbers) ========== */
function tickClock(){ setText('localDate', new Date().toLocaleString([], {hour12:false})); }
setInterval(tickClock, 1000); tickClock();
const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
setText('localTz', tz); document.getElementById('tzBadge').textContent = tz;
(function(){
  const now = new Date(), utc = now.toISOString();
  const offsetMin = -now.getTimezoneOffset(), offH = Math.floor(Math.abs(offsetMin)/60)*Math.sign(offsetMin);
  setText('offsetLine', `CST–UTC offset: ${offH>=0?'+':''}${offH} h • UTC epoch: ${utc}`);
})();
setText('interstellarYear', 'Year ~57,889,169.3');
setText('stardateNow', 'Stardate −29,737.8');

/* ========== Targets loader & renderer (no meta row shown) ========== */
const statusMsg = document.getElementById('statusMsg');
const rowsEl = document.getElementById('rows');
const H0Input = document.getElementById('H0');

const GROUPS_DISPLAY = ['planets','moons','stars','galaxies']; // meta hidden
let DATA = {};
let REF = { r:[0,0,0], v:[0,0,0] };
let selectedKey = null; // "group:index"

async function loadTargets(){
  try{
    const res = await fetch('targets.json?nocache=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    DATA = await res.json();
    // reference from meta (e.g., Earth)
    if(Array.isArray(DATA.meta)){
      const refObj = DATA.meta.find(o => (o.role==='observer') || /earth/i.test(o.name||''));
      if(refObj){
        REF.r = Array.isArray(refObj.r_au) ? refObj.r_au : REF.r;
        REF.v = Array.isArray(refObj.v_au_per_d) ? refObj.v_au_per_d : REF.v;
      }
    }
    const groupsFound = GROUPS_DISPLAY.filter(g => Object.prototype.hasOwnProperty.call(DATA, g)).length;
    statusMsg.classList.add('ok');
    statusMsg.textContent = `Loaded ${groupsFound} target group(s) from targets.json.`;
  }catch(err){
    statusMsg.textContent = `Failed to load targets.json: ${err.message} — using empty groups.`;
    DATA = {};
  }
  render();
}

function render(){
  rowsEl.innerHTML = '';
  GROUPS_DISPLAY.forEach(group=>{
    addGroupRow(group);
    const list = Array.isArray(DATA[group])? DATA[group] : [];
    list.forEach((item, i)=> addItemRow(item, group, i));
  });
}

function addGroupRow(title){
  const tr = document.createElement('tr');
  tr.style.background = '#0f1830';
  tr.style.color = '#cfd7eb';
  tr.style.fontWeight = '800';
  const nowIso = new Date().toISOString();
  const cells = [
    title,'—','—','—','—','—','—','—','—','—',nowIso,'static (add vector_url or vectors/<slug>.json)'
  ];
  cells.forEach(c=>{ const td=document.createElement('td'); td.innerHTML=c; tr.appendChild(td); });
  rowsEl.appendChild(tr);
}

function addItemRow(it, group, index){
  const tr = document.createElement('tr');
  tr.dataset.key = `${group}:${index}`;
  tr.addEventListener('click', ()=> selectRow(tr.dataset.key));

  const rSun = Array.isArray(it.r_au) ? it.r_au : null;              // heliocentric (AU)
  const vSun = Array.isArray(it.v_au_per_d) ? it.v_au_per_d : null;  // AU/day
  const rEarth = Array.isArray(it.r_earth_au) ? it.r_earth_au : null;// geocentric (AU)

  const dSun = rSun ? v3.norm(rSun) : null;
  const dEarth = rEarth ? v3.norm(rEarth) : null;

  // Proper motion (optional)
  let pm_mas_yr = null;
  if(typeof it.pm_total_mas_yr === 'number') pm_mas_yr = it.pm_total_mas_yr;
  else if(typeof it.pm_ra_mas_yr === 'number' && typeof it.pm_dec_mas_yr === 'number')
    pm_mas_yr = Math.hypot(it.pm_ra_mas_yr, it.pm_dec_mas_yr);

  // Radial velocity (prefers provided; else from vectors vs reference)
  let vr_kms = null;
  if (typeof it.radial_velocity_km_s === 'number') vr_kms = it.radial_velocity_km_s;
  else if (rSun && (vSun || Array.isArray(it.v_km_s))){
    const rRel = v3.sub(rSun, REF.r);
    const vRel = vSun ? v3.sub(vSun, REF.v) : v3.mul(it.v_km_s, 1/(AU_PER_DAY_TO_KM_S));
    const Rhat = v3.unit(rRel);
    vr_kms = v3.dot(vRel, Rhat) * AU_PER_DAY_TO_KM_S;
  }

  // Hubble flow (optional if distance provided)
  const H0 = parseFloat(H0Input.value) || 70;
  let D_mpc = null;
  if(typeof it.distance_mpc === 'number') D_mpc = it.distance_mpc;
  else if(typeof it.distance_pc === 'number') D_mpc = it.distance_pc / 1e6;
  let vrec = (D_mpc!=null) ? H0 * D_mpc : null;
  let z = (vrec!=null) ? (vrec / C_KM_S) : null;

  const nowIso = new Date().toISOString();
  const cells = [
    it.name || '(unnamed)',
    it.type || group.slice(0,-1),
    rSun ? `<span class="num">[${fmt(rSun[0],3)}, ${fmt(rSun[1],3)}, ${fmt(rSun[2],3)}]</span>` : '—',
    dSun!=null ? `<span class="num">${fmt(dSun,3)}</span>` : '—',
    dEarth!=null ? `<span class="num">${fmt(dEarth,3)}</span>` : '—',
    pm_mas_yr!=null ? `<span class="num">${fmt(pm_mas_yr,2)} mas/yr</span>` : '—',
    vr_kms!=null ? `<span class="num">${fmt(vr_kms,2)} km/s</span>` : '—',
    D_mpc!=null ? `<span class="num">${fmt(D_mpc,4)} Mpc</span>` :
      (typeof it.distance_pc==='number' ? `<span class="num">${fmt(it.distance_pc,2)} pc</span>` : '—'),
    vrec!=null ? `<span class="num">${fmt(vrec,3)} km/s (z≈${fmt(z,6)})</span>` : '—',
    it.uncertainty || '—',
    it.last_update || nowIso,
    it.status || '—'
  ];
  cells.forEach(c=>{ const td=document.createElement('td'); td.innerHTML=c; tr.appendChild(td); });
  rowsEl.appendChild(tr);
}

/* Selection logic for toolbar actions */
function selectRow(key){
  selectedKey = key;
  [...rowsEl.querySelectorAll('tr')].forEach(tr => tr.classList.toggle('selected', tr.dataset.key === key));
}
function getSelectedItem(){
  if(!selectedKey) return null;
  const [group, idxStr] = selectedKey.split(':');
  const idx = parseInt(idxStr,10);
  const list = Array.isArray(DATA[group]) ? DATA[group] : [];
  return list[idx] || null;
}

/* ========== Get Vectors ==========
   Looks for item.vector_url; else tries vectors/<slug(item.name)>.json (same folder).
   Expected JSON: { r_au:[x,y,z], v_au_per_d:[vx,vy,vz], last_update:"ISO", source:"..." }
*/
async function getVectors(){
  let updates = 0, failures = 0;
  const stamp = new Date().toISOString();

  for(const group of GROUPS_DISPLAY){
    const arr = Array.isArray(DATA[group]) ? DATA[group] : [];
    for(const it of arr){
      if(Array.isArray(it.r_au) && Array.isArray(it.v_au_per_d)) continue;
      const url = it.vector_url || `vectors/${slug(it.name||'target')}.json?nocache=${Date.now()}`;
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const vec = await res.json();
        if(Array.isArray(vec.r_au) && Array.isArray(vec.v_au_per_d)){
          it.r_au = vec.r_au; it.v_au_per_d = vec.v_au_per_d;
          it.last_update = vec.last_update || stamp;
          it.status = `vector: ${vec.source || 'loaded'}`;
          updates++;
        }else{ it.status = `vector: malformed (${url})`; failures++; }
      }catch(e){ it.status = `vector: fetch failed (${url})`; failures++; }
    }
  }
  statusMsg.textContent = `Get Vectors → ${updates} updated, ${failures} failed.`;
  render();
}

/* ========== Solve Tc (closest approach, linear) ========== */
function solveTcFor(item){
  const r = Array.isArray(item.r_au) ? item.r_au : (Array.isArray(item.r_earth_au) ? item.r_earth_au : null);
  const v = Array.isArray(item.v_au_per_d) ? item.v_au_per_d : null;
  if(!r || !v) return { error:`need r_au and v_au_per_d` };
  const V2 = v3.dot(v,v); if(V2===0) return { error:`velocity is zero` };
  const Tc_days = - v3.dot(r,v) / V2;
  const Rmin = v3.add(r, v3.mul(v, Tc_days));
  const dmin_au = v3.norm(Rmin);
  const whenIso = new Date(Date.now() + Tc_days*86400000).toISOString();
  return { Tc_days, dmin_au, whenIso };
}

/* ========== Bubble shaping (toy integral) ========== */
function shapeBubbleFor(item){
  // Demo: flat gamma profile for Δt = horizon (seconds)
  const horizon = parseFloat(document.getElementById('horizon').value)||86400;
  const gamma_inv_minus_1 = 0.2; // placeholder shaping
  const I = Math.abs(gamma_inv_minus_1) * horizon; // dimension: seconds
  return { I_sec:I };
}

/* ========== Wire toolbar buttons ========== */
document.getElementById('btnFetchVectors').addEventListener('click', getVectors);
document.getElementById('btnSolve').addEventListener('click', ()=>{
  const it = getSelectedItem();
  if(!it){ alert('Select a row first.'); return; }
  const r = solveTcFor(it);
  if(r.error){ alert(`${it.name}: ${r.error}`); return; }
  alert(`Closest approach (linear)
Target: ${it.name}
T_c: ${r.Tc_days.toFixed(5)} days (${(r.Tc_days*24).toFixed(3)} h)
d_min: ${r.dmin_au.toFixed(6)} AU (${(r.dmin_au*149597870.7).toFixed(2)} km)
At UTC: ${r.whenIso}`);
});
document.getElementById('btnShape').addEventListener('click', ()=>{
  const it = getSelectedItem();
  if(!it){ alert('Select a row first.'); return; }
  const r = shapeBubbleFor(it);
  alert(`Shape Bubble (demo)\nTarget: ${it.name}\nIntegral I = ${r.I_sec.toFixed(2)} s`);
});

/* ========== Start ========== */
loadTargets();
</script>
</body>
</html>
