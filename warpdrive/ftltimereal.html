<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FTL Warp Control System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<div id="mainContainer">

    <!-- Panel: Warp Factor & Status -->
    <div class="panel">
        <h2>Warp Factor</h2>
        <div>Current: <span id="warpFactorDisplay">0.00</span> <span class="status-light" id="warpStatus"></span></div>
        <div>Target: <span id="warpTargetDisplay">0.00</span></div>
        <div>Safe Range: ±5%</div>
    </div>

    <!-- Panel: FTL Distance & ETA -->
    <div class="panel">
        <h2>Distance & ETA</h2>
        <div>Distance Remaining: <span id="distanceRemaining">0.000</span> AU</div>
        <div>ETA: <span id="etaDisplay">--:--:--</span></div>
        <div>Light-Minutes: <span id="lightMinutesDisplay">0</span></div>
        <div>Light-Hours: <span id="lightHoursDisplay">0</span></div>
    </div>

    <!-- Panel: Heading & Course -->
    <div class="panel">
        <h2>Course Vector</h2>
        <div>Heading: <span id="headingDegrees">000</span>°</div>
        <div>Pitch: <span id="pitchDegrees">0</span>°</div>
        <div>Yaw: <span id="yawDegrees">0</span>°</div>
    </div>

    <!-- Panel: Magnetic Field -->
    <div class="panel">
        <h2>Magnetic Field</h2>
        <div>Current Field: <span id="magField">0.00</span> Tesla</div>
        <div>Required: <span id="magFieldTarget">0.00</span> Tesla</div>
        <div>Status: <span class="status-light" id="magFieldStatus"></span></div>
    </div>

    <!-- Panel: Engine Pressure -->
    <div class="panel">
        <h2>Engine Pressure</h2>
        <div>Current: <span id="enginePressure">0.00</span> MPa</div>
        <div>Required: <span id="enginePressureTarget">0.00</span> MPa</div>
        <div>Status: <span class="status-light" id="enginePressureStatus"></span></div>
    </div>

    <!-- Panel: Energy Allocation -->
    <div class="panel">
        <h2>Energy Allocation</h2>
        <div>Coils: <span id="energyCoils">0</span> MW</div>
        <div>Navigation: <span id="energyNav">0</span> MW</div>
        <div>Shields: <span id="energyShields">0</span> MW</div>
        <div>Life Support: <span id="energyLife">0</span> MW</div>
    </div>

    <!-- Panel: Safety Monitor -->
    <div class="panel">
        <h2>Safety Monitor</h2>
        <div>FTL Stability: <span id="stabilityIndex">0.00</span> % <span class="status-light" id="stabilityStatus"></span></div>
        <div>Hull Integrity: <span id="hullIntegrity">100</span> %</div>
        <div>Gravity Balance: <span id="gravityBalance">0.00</span> g</div>
    </div>

    <!-- Panel: Crew Status -->
    <div class="panel">
        <h2>Crew Status</h2>
        <div>Total Crew: <span id="crewTotal">0</span></div>
        <div>Active Duty: <span id="crewActive">0</span></div>
        <div>Medical: <span id="crewMedical">0</span></div>
        <div>Status: <span class="status-light" id="crewStatus"></span></div>
    </div>

    <!-- Panel: Clocks -->
    <div class="panel">
        <h2>Clocks</h2>
        <div>Ship Time: <span id="clockShip">--:--:--</span></div>
        <div>Earth Time: <span id="clockEarth">--:--:--</span></div>
        <div>Destination Time: <span id="clockDest">--:--:--</span></div>
        <div>Countdown: <span id="countdown">--:--:--</span></div>
    </div>

    <!-- Panel: Einstein Tensor -->
    <div class="panel">
        <h2>Einstein Tensor</h2>
        <canvas id="tensorCanvas" width="250" height="80"></canvas>
    </div>

    <!-- Panel: Starfield -->
    <div class="panel">
        <h2>Warp Starfield</h2>
        <canvas id="starfieldCanvas" width="300" height="150"></canvas>
    </div>

    <!-- Panel: Status Log -->
    <div class="panel">
        <h2>Status Log</h2>
        <div id="statusLog" class="log-box"></div>
    </div>

</div>
<script>
// ==========================
// SOUND SETUP
// ==========================
const humSound = new Audio("https://gabinoc67.github.io/interstellar-star-clock/warpdrive/hum.mp3");
const warpSound = new Audio("https://gabinoc67.github.io/interstellar-star-clock/warpdrive/warp.mp3");
const arriveSound = new Audio("https://gabinoc67.github.io/interstellar-star-clock/warpdrive/arrive.mp3");

humSound.loop = true;
warpSound.loop = true;

let soundOn = true;
let warpEngaged = false;

// ==========================
// ENGINE & NAV VARIABLES
// ==========================
let warpFactor = 0;
let warpTarget = 0;
let distanceRemaining = 0; // AU
let magField = 0;
let magTarget = 0;
let pressure = 0;
let pressureTarget = 0;
let stabilityIndex = 100;
let hullIntegrity = 100;
let gravityBalance = 1;
let crewTotal = 50;
let crewActive = 45;
let crewMedical = 5;

let tripInterval;
let arrivalTime;

// ==========================
// HELPER FUNCTIONS
// ==========================
function updateElement(id, value) {
    document.getElementById(id).textContent = value;
}

function statusLight(id, status) {
    let el = document.getElementById(id);
    if (status === "green") el.style.background = "lime";
    else if (status === "yellow") el.style.background = "yellow";
    else el.style.background = "red";
}

function logStatus(msg, warning = false) {
    let logBox = document.getElementById("statusLog");
    let entry = document.createElement("div");
    entry.style.color = warning ? "red" : "cyan";
    entry.textContent = msg;
    logBox.prepend(entry);
}

// ==========================
// CLOCK UPDATES
// ==========================
function updateClocks() {
    let now = new Date();
    updateElement("clockShip", now.toLocaleTimeString());
    updateElement("clockEarth", now.toUTCString().split(" ")[4]);

    if (arrivalTime) {
        let destTime = new Date(arrivalTime);
        updateElement("clockDest", destTime.toLocaleTimeString());
        let diff = Math.max(0, (destTime - now) / 1000);
        let hrs = Math.floor(diff / 3600);
        let mins = Math.floor((diff % 3600) / 60);
        let secs = Math.floor(diff % 60);
        updateElement("countdown", `${hrs}:${mins}:${secs}`);
    }
}

// ==========================
// WARP FORMULAS
// ==========================
// Warp speed (c) using simple cubic warp factor rule
function warpSpeed(wf) {
    return Math.pow(wf, 3); // Simplified warp curve
}

// Time (in hours) = distance in AU / warp speed in AU/hour
function travelTimeAU(distanceAU, wf) {
    let c_in_AUph = 173.145; // 1c in AU/hour
    return distanceAU / (warpSpeed(wf) * c_in_AUph);
}

// ==========================
// PANEL UPDATES
// ==========================
function updatePanels() {
    updateElement("warpFactorDisplay", warpFactor.toFixed(2));
    updateElement("warpTargetDisplay", warpTarget.toFixed(2));

    updateElement("distanceRemaining", distanceRemaining.toFixed(3));
    updateElement("lightMinutesDisplay", (distanceRemaining * 8.31675).toFixed(2));
    updateElement("lightHoursDisplay", (distanceRemaining * 0.1386125).toFixed(2));

    updateElement("headingDegrees", (Math.random() * 360).toFixed(0));
    updateElement("pitchDegrees", (Math.random() * 10 - 5).toFixed(2));
    updateElement("yawDegrees", (Math.random() * 10 - 5).toFixed(2));

    magField = magTarget + (Math.random() - 0.5) * 0.05;
    updateElement("magField", magField.toFixed(2));
    statusLight("magFieldStatus", Math.abs(magField - magTarget) <= 0.05 ? "green" : "red");

    pressure = pressureTarget + (Math.random() - 0.5) * 0.1;
    updateElement("enginePressure", pressure.toFixed(2));
    statusLight("enginePressureStatus", Math.abs(pressure - pressureTarget) <= 0.1 ? "green" : "red");

    updateElement("energyCoils", (warpFactor * 50).toFixed(0));
    updateElement("energyNav", (warpFactor * 10).toFixed(0));
    updateElement("energyShields", (warpFactor * 15).toFixed(0));
    updateElement("energyLife", 200);

    stabilityIndex = 100 - Math.random() * 2;
    updateElement("stabilityIndex", stabilityIndex.toFixed(2));
    statusLight("stabilityStatus", stabilityIndex >= 95 ? "green" : "yellow");

    updateElement("hullIntegrity", hullIntegrity.toFixed(2));
    updateElement("gravityBalance", (1 + (Math.random() - 0.5) * 0.01).toFixed(3));

    updateElement("crewTotal", crewTotal);
    updateElement("crewActive", crewActive);
    updateElement("crewMedical", crewMedical);
    statusLight("crewStatus", crewMedical === 0 ? "green" : "yellow");
}

// ==========================
// WARP CONTROL
// ==========================
function engageWarp(targetWF, targetAU) {
    if (warpEngaged) return;
    warpEngaged = true;
    warpTarget = targetWF;
    distanceRemaining = targetAU;

    magTarget = warpTarget * 0.5;
    pressureTarget = warpTarget * 1.2;

    let travelHours = travelTimeAU(distanceRemaining, warpTarget);
    arrivalTime = new Date(Date.now() + travelHours * 3600000);

    logStatus(`Warp engaged to ${targetAU} AU at Warp ${targetWF}`);
    if (soundOn) { humSound.pause(); warpSound.play(); }

    tripInterval = setInterval(() => {
        warpFactor = warpTarget + (Math.random() - 0.5) * 0.05;
        distanceRemaining -= warpSpeed(warpFactor) * 0.0001;
        if (distanceRemaining <= 0) {
            arriveWarp();
        }
        updatePanels();
        updateClocks();
        safetyCheck();
    }, 1000);
}

function arriveWarp() {
    clearInterval(tripInterval);
    warpEngaged = false;
    warpFactor = 0;
    distanceRemaining = 0;
    updatePanels();
    logStatus("Arrived at destination!");
    if (soundOn) { warpSound.pause(); arriveSound.play(); setTimeout(() => humSound.play(), 5000); }
}

function safetyCheck() {
    if (Math.abs(magField - magTarget) > 0.1 || Math.abs(pressure - pressureTarget) > 0.2 || stabilityIndex < 90) {
        logStatus("⚠ Safety limits exceeded — Warp disengaging!", true);
        arriveWarp();
    }
}

// ==========================
// INIT
// ==========================
updatePanels();
setInterval(updateClocks, 1000);
if (soundOn) humSound.play();

// Example: Auto-engage warp for testing
setTimeout(() => engageWarp(5, 20), 3000); // Warp 5 to 20 AU
</script>
<style>
body {
    background-color: #05080f;
    font-family: Arial, sans-serif;
    color: #eaf2ff;
    margin: 0;
    padding: 0;
}

#mainContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    grid-gap: 12px;
    padding: 12px;
}

/* Panel styling */
.panel {
    background-color: #0c1424;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(0,0,0,0.7);
    border: 1px solid #3ad5ff;
}

.panel h2 {
    margin: 0 0 8px;
    font-size: 1.2em;
    color: #3ad5ff;
    text-shadow: 0 0 8px #3ad5ff;
}

/* Status light circle */
.status-light {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: gray;
    margin-left: 6px;
    vertical-align: middle;
    box-shadow: 0 0 6px rgba(255,255,255,0.3);
}

/* Log box */
.log-box {
    height: 160px;
    overflow-y: auto;
    background: rgba(0,0,0,0.25);
    border: 1px solid #3ad5ff;
    padding: 6px;
    font-size: 0.95em;
}

/* Gauges & values */
.panel div {
    font-size: 1.05em;
    margin-bottom: 4px;
}

/* Canvas styling */
#tensorCanvas, #starfieldCanvas {
    display: block;
    background: black;
    margin-top: 4px;
    border: 1px solid #3ad5ff;
    border-radius: 4px;
}

/* Scrollbar styling for logs */
.log-box::-webkit-scrollbar {
    width: 8px;
}
.log-box::-webkit-scrollbar-thumb {
    background: #3ad5ff;
    border-radius: 4px;
}
</style>
  </script>
<!-- ===== CSV-driven chips directly under the footer line (layout + animations) ===== -->
<style>
  /* Full-width container */
  .wdp-wrap{
    width:100%;
    max-width:none;
    margin:8px 0 16px;
    padding:0 12px;
  }

  /* Two-row main layout: Nav | Engine | Crew ; and below Ship under Crew */
  .wdp-sections{
    display:grid;
    gap:12px;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto auto;
    grid-template-areas:
      "nav engine crew"
      "nav engine ship";
  }

  /* Card placement */
  .wdp-card[data-loc="Navigation"] { grid-area: nav; }
  .wdp-card[data-loc="Engine"]     { grid-area: engine; }
  .wdp-card[data-loc="Crew"]       { grid-area: crew; }
  .wdp-card[data-loc="Ship"]       { grid-area: ship; }

  /* Card shell */
  .wdp-card{
    border:1px solid #223;
    border-radius:12px;
    padding:10px;
    background:#101521;
  }

  /* Titles */
  .wdp-title{
    display:flex;align-items:center;gap:8px;
    font-weight:800;
    font-size:clamp(13px,1.2vw,15px);
    text-transform:uppercase;letter-spacing:.08em;
    color:#9fb7ff;margin:0 0 8px;
  }

  /* Default chip grid */
  .wdp-grid{
    display:grid;
    gap:6px;
    grid-template-columns: repeat(3, minmax(160px, 1fr)); /* sensible default */
  }

  /* Navigation & Engine: fill space evenly, adapt to width */
  .wdp-card[data-loc="Navigation"] .wdp-grid,
  .wdp-card[data-loc="Engine"]     .wdp-grid{
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  }

  /* Crew & Ship: exactly 3 columns, evenly spaced */
  .wdp-card[data-loc="Crew"] .wdp-grid,
  .wdp-card[data-loc="Ship"] .wdp-grid{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  /* Ultra-wide screens: let Nav/Engine pack a bit more per row if room allows */
  @media (min-width: 1800px){
    .wdp-card[data-loc="Navigation"] .wdp-grid,
    .wdp-card[data-loc="Engine"]     .wdp-grid{
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
  }

  /* Responsive: 2 columns then 1 column */
  @media (max-width:1200px){
    .wdp-sections{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "nav engine"
        "crew ship";
    }
  }
  @media (max-width:900px){
    .wdp-card[data-loc="Crew"] .wdp-grid,
    .wdp-card[data-loc="Ship"] .wdp-grid{
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (max-width:720px){
    .wdp-sections{
      grid-template-columns: 1fr;
      grid-template-areas:
        "nav"
        "engine"
        "crew"
        "ship";
    }
    .wdp-card[data-loc="Crew"] .wdp-grid,
    .wdp-card[data-loc="Ship"] .wdp-grid{
      grid-template-columns: 1fr;
    }
  }

  /* Chip styles */
  .wdp-chip{
    display:flex;align-items:center;gap:8px;
    border:1px solid #2a3340;border-radius:9999px;
    padding:7px 10px;min-height:36px;background:#0f1420;
  }
  .wdp-dot{width:11px;height:11px;border-radius:50%;box-shadow:0 0 0 1px #334255 inset}
  .wdp-dot.ok{background:#16a34a}
  .wdp-dot.warn{background:#eab308}
  .wdp-dot.bad{background:#ef4444}
  @keyframes pulseWarn{0%,100%{transform:scale(1);opacity:.95}50%{transform:scale(1.25);opacity:.7}}
  @keyframes blinkBad{0%,49%{opacity:1}50%,100%{opacity:.25}}
  .wdp-dot.warn{animation:pulseWarn 1.2s ease-in-out infinite}
  .wdp-dot.bad{animation:blinkBad .8s steps(2,end) infinite}
  .wdp-abbr{font-weight:800;font-size:14.3px}
  .wdp-type{font-size:12px;color:#8ea0bd}
  .wdp-val{margin-left:auto;font-variant-numeric:tabular-nums;white-space:nowrap;font-size:13px;color:#e6edf3}
  @keyframes tick{0%{transform:translateY(0);opacity:1}40%{transform:translateY(-2px);opacity:.85}100%{transform:translateY(0);opacity:1}}
  .wdp-val.tick{animation:tick .35s ease}
  .wdp-empty{
    border:1px dashed #2a3340;border-radius:12px;padding:16px;
    text-align:center;color:#9fb7ff;font-size:13px;background:#0f1420;
  }
</style>

<div class="wdp-wrap" id="wdp-panel" aria-label="Warp Drive Demonstrator · CST-Synced Equilibrium">
  <div class="wdp-sections" id="wdp-sections"></div>
</div>

<script type="module" id="wdp-chips" data-wdp-csv="https://gabinoc67.github.io/interstellar-star-clock/warpdrive/navengreadings.csv">
const ORDER=["Navigation","Engine","Crew","Ship"]; // render order

const normalizeType=s=>String(s||"").trim().toLowerCase();
const truthy=v=>["yes","true","1","y"].includes(String(v||"").trim().toLowerCase());
const TZ="America/Chicago";
const fmtTime=new Intl.DateTimeFormat("en-US",{timeZone:TZ,hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
const fmtDate=new Intl.DateTimeFormat("en-US",{timeZone:TZ});

function parseCSV(text){
  const rows=[];let cur=[],val="",q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(q){ if(c=='"'&&n=='"'){val+='"';i++;} else if(c=='"'){q=false;} else{val+=c;} }
    else { if(c=='"'){q=true;} else if(c==','){cur.push(val);val="";} else if(c=='\n'){cur.push(val);rows.push(cur);cur=[];val="";} else if(c!='\r'){val+=c;} }
  }
  if(val.length||cur.length){cur.push(val);rows.push(cur);}
  const headers=rows.shift().map(h=>h.trim());
  return rows.filter(r=>r.some(x=>String(x).trim()!=="")).map(r=>{const o={};headers.forEach((h,i)=>o[h]=r[i]??"");return o;});
}
function normalizeRows(rows){
  return rows.map(r=>{
    const o={}; for(const k in r){ o[k.trim()] = typeof r[k]==="string" ? r[k].trim() : r[k]; }
    if(o["Display Type"]) o["Display Type"] = normalizeType(o["Display Type"]);
    if(o["Display Type"]==="date ") o["Display Type"]="date";
    return o;
  });
}
function normKey(s){return String(s||"").toLowerCase().replace(/[\s_\-]+/g,"").replace(/[^a-z0-9]/g,"");}
function detectKey(keys,re){const pairs=keys.map(k=>[k,normKey(k)]);const hit=pairs.find(([k,n])=>re.test(n));return hit?hit[0]:null;}
function buildKeyMap(sample){
  const keys=Object.keys(sample||{});
  return{ label:detectKey(keys,/label(name)?$/)||"Label Name",
          abbr:detectKey(keys,/(abbr|abbrev|abbreviation)s?$/)||"Abbreviation",
          dtype:detectKey(keys,/(displaytype|display|type)$/)||"Display Type",
          circle:detectKey(keys,/(circle)$/)||"Circle",
          location:detectKey(keys,/(location|loc)$/)||"Location" };
}
function groupByLocation(rows,KM){
  const g={};
  rows.forEach(r=>{
    const loc=String(r[KM.location]||"").trim()||"Crew";
    (g[loc] ||= []).push(r);
  });
  Object.keys(g).forEach(k=>{
    g[k].sort((a,b)=>String(a[KM.abbr]||"").localeCompare(String(b[KM.abbr]||"")));
  });
  return g;
}
const seedOf=s=>Array.from(String(s||"")).reduce((a,c)=>a+c.charCodeAt(0),0);

function liveValue(typ,labelOrAbbr,t){
  const seed=seedOf(labelOrAbbr);
  const base=(seed%1000)/10;
  const wiggle=(Math.sin((seed+t)/7)+1)*0.5;
  const v=base*(0.9+0.2*wiggle);
  switch(typ){
    case"degrees":  return `${Math.floor((v*3.6+t)%360)}°`;
    case"time":     return fmtTime.format(new Date());
    case"numbers":  return Intl.NumberFormat().format(Math.round(v*100+(t%5)));
    case"watts":    { const degLike=Math.floor((v*3.6+t)%360); return `${Math.round(50+degLike*0.8)} W`; }
    case"miles":    return `${(v*1.3).toFixed(1)} mi`;
    case"frequency":return `${(v*7).toFixed(2)} Hz`;
    case"pressure": return `${(v*2.3).toFixed(2)} psi`;
    case"speed":    return `${(v*3.1).toFixed(2)} kn`;
    case"date":     return fmtDate.format(new Date());
    case"alarm":    return ((seed+t)%17<1) ? "ALARM" : "OK";
    case"calculation": return (v*42).toFixed(2);
    default: return "—";
  }
}

function circleClassForRow(row,engine){
  const { v=0, p=0, f=0, r=0, hazard='none' } = engine || {};
  const imbalance = Math.abs(f - Math.abs(r));
  const vStress = Math.min(1, v/6);
  const pStress = Math.min(1, p/8);
  const vecStress= Math.min(1, imbalance/2);
  const hazStress= (hazard==='inside')?1 : (hazard==='approach')?0.8 : (hazard==='standby')?0.3 : 0;
  let stress = (0.35*vStress + 0.25*pStress + 0.25*vecStress + 0.15*hazStress);
  const seed = seedOf(row.__abbr || row.__label || '');
  const jitter = ((seed%101)/100 - 0.5) * 0.20;
  stress = Math.max(0, Math.min(1, stress + jitter));
  if(stress < 0.35) return 'ok';
  if(stress < 0.60) return 'warn';
  return 'bad';
}

const host = document.getElementById("wdp-sections");
const csvSrc = document.getElementById("wdp-chips")?.dataset.wdpCsv || new URL("navengreadings.csv", location.href).href;

function render(groups,KM){
  host.innerHTML = "";
  const order = ORDER.filter(k=>groups[k]?.length);
  if(!order.length){
    const div=document.createElement("div"); div.className="wdp-empty"; div.textContent="No items found in CSV."; host.appendChild(div); return;
  }
  for(const loc of order){
    const card=document.createElement("section"); card.className="wdp-card"; card.dataset.loc=loc;
    const h=document.createElement("div"); h.className="wdp-title"; h.textContent=loc; card.appendChild(h);
    const grid=document.createElement("div"); grid.className="wdp-grid";

    groups[loc].forEach(row=>{
      const typ = normalizeType(row[KM.dtype]);
      const showCircle = truthy(row[KM.circle]);
      const abbr = String(row[KM.abbr] || row[KM.label] || "").trim();
      row.__abbr = abbr; row.__label = row[KM.label];

      const chip=document.createElement("div"); chip.className="wdp-chip";
      if(showCircle){ const dot=document.createElement("span"); dot.className="wdp-dot ok"; chip.appendChild(dot); chip._dot=dot; }
      const ab=document.createElement("span"); ab.className="wdp-abbr"; ab.textContent=abbr; chip.appendChild(ab);
      const ty=document.createElement("span"); ty.className="wdp-type"; ty.textContent=typ; chip.appendChild(ty);
      const val=document.createElement("span"); val.className="wdp-val"; chip.appendChild(val);

      chip._wdp={ row, valEl:val, abbr, typ, showCircle, prevText:"" };
      grid.appendChild(chip);
    });

    card.appendChild(grid); host.appendChild(card);
  }
}

(async function(){
  try{
    const res = await fetch(csvSrc, { cache:"no-store" });
    if(!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
    const rows0 = parseCSV(await res.text());
    const rows  = normalizeRows(rows0);
    const KM    = buildKeyMap(rows[0]||{});
    const groups= groupByLocation(rows, KM);
    render(groups, KM);

    const liveSet = new Set(["numbers","degrees","time","watts"]);
    let redSince=null, lastT=-1;

    function anim(){
      const t = Math.floor(performance.now()/1000);
      if(t !== lastT){
        lastT = t;
        const engine = window.__engine_live_state || {v:0,p:0,f:0,r:0,hazard:'none'};
        let redCount = 0;

        host.querySelectorAll(".wdp-chip").forEach(ch=>{
          const ref = ch._wdp; if(!ref) return;

          const vtxt = liveValue(ref.typ, ref.abbr, t);
          if(liveSet.has(ref.typ)){
            if(vtxt !== ref.prevText){
              ref.valEl.textContent = vtxt;
              ref.prevText = vtxt;
              ref.valEl.classList.remove('tick'); void ref.valEl.offsetWidth; ref.valEl.classList.add('tick');
            }
          } else if(!ref.valEl.textContent){
            ref.valEl.textContent = vtxt; ref.prevText = vtxt;
          }

          if(ref.showCircle && ch._dot){
            const cls = circleClassForRow(ref.row, engine);
            ch._dot.classList.remove('ok','warn','bad');
            ch._dot.classList.add(cls);
            if(cls==='bad') redCount++;
          }
        });

        const threshold = 20;
        if(redCount > threshold){
          if(redSince==null) redSince = performance.now();
          else if(performance.now() - redSince > 2000 && typeof window.requestEngineShutdown==='function'){
            window.requestEngineShutdown(`> ${threshold} critical sensor circles`);
            redSince = null;
          }
        } else redSince = null;
      }
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }catch(e){
    console.error(e);
    const div=document.createElement("div"); div.className="wdp-empty"; div.textContent="Could not load CSV."; host.appendChild(div);
  }
})();
</script>  
</body>
</html>
