<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Warp Control Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        background: #050a14;
        color: #eaf2ff;
        font-family: monospace;
        margin: 0;
        padding: 0;
    }
    .container {
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
    }
    .panel {
        background: #0c1424;
        border: 1px solid #27406b;
        border-radius: 8px;
        padding: 10px;
    }
    .panel h3 {
        margin: 0 0 6px;
        font-size: 14px;
        color: #7dd3fc;
    }
    select, button {
        background: #1a2747;
        color: #eaf2ff;
        border: 1px solid #27406b;
        border-radius: 4px;
        padding: 4px;
        font-family: monospace;
        font-size: 14px;
    }
    .gauge {
        background: #1a2747;
        border: 1px solid #27406b;
        border-radius: 4px;
        height: 20px;
        width: 100%;
        position: relative;
        margin: 4px 0;
    }
    .gauge-fill {
        background: #22c55e;
        height: 100%;
        width: 0%;
        transition: width 0.3s linear;
    }
    .warning {
        color: #ef4444;
        font-weight: bold;
        animation: flash 1s infinite;
        display: none;
    }
    @keyframes flash {
        0%, 50%, 100% { opacity: 1; }
        25%, 75% { opacity: 0; }
    }
    /* Compass */
    .compass {
        width: 150px;
        height: 150px;
        border: 4px solid #27406b;
        border-radius: 50%;
        position: relative;
        margin: auto;
    }
    .compass-needle {
        width: 4px;
        height: 70px;
        background: #facc15;
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%) rotate(0deg);
        transform-origin: bottom center;
        transition: transform 1s ease-in-out;
    }
    /* Safety Monitor colors */
    .safe { color: #22c55e; }
    .warn { color: #facc15; }
    .danger { color: #ef4444; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <!-- Engine Core Status -->
    <div class="panel">
        <h3>Destination</h3>
        <select id="planet">
            <option value="Mercury">Mercury</option>
            <option value="Venus">Venus</option>
            <option value="Earth">Earth</option>
            <option value="Mars">Mars</option>
            <option value="Jupiter">Jupiter</option>
            <option value="Saturn">Saturn</option>
            <option value="Uranus">Uranus</option>
            <option value="Neptune">Neptune</option>
        </select>
        <h3>Warp Factor</h3>
        <select id="warp">
            <option value="1">Warp 1</option>
            <option value="2">Warp 2</option>
            <option value="3">Warp 3</option>
            <option value="4">Warp 4</option>
            <option value="5">Warp 5</option>
            <option value="6">Warp 6</option>
            <option value="7">Warp 7</option>
            <option value="8">Warp 8</option>
            <option value="9">Warp 9</option>
            <option value="10">Warp 10</option>
        </select>
        <br><br>
        <button onclick="engageWarp()">Engage</button>
    </div>

    <div class="panel">
        <h3>Engine Status</h3>
        <div>Eng: <span id="status">Idle</span></div>
        <div>WF: <span id="wf">0</span></div>
        <div>Dst: <span id="dst">0</span> AU</div>
        <div>ETA: <span id="eta">0</span> min</div>
        <div>Prs: <span id="pressureVal">0</span> %</div>
        <div class="gauge"><div id="pressureGauge" class="gauge-fill"></div></div>
        <div>MF: <span id="mfVal">0</span> %</div>
        <div class="gauge"><div id="mfGauge" class="gauge-fill"></div></div>
        <div>En: <span id="energyVal">0</span> %</div>
        <div class="gauge"><div id="energyGauge" class="gauge-fill"></div></div>
        <div class="warning" id="warning">⚠ ENGINE SAFETY TRIGGERED — RETURNING TO IDLE</div>
    </div>

    <!-- Navigation -->
    <div class="panel">
        <h3>Navigation & Targeting</h3>
        <div>Pln: <span id="navPlanet">-</span></div>
        <div>Dst: <span id="navDistAU">0</span> AU (<span id="navDistKM">0</span> km)</div>
        <div>ETA: <span id="navETA">0</span> min</div>
        <div>Hdg: <span id="navHeading">0</span>°</div>
        <div>Grv: <span id="navGravity">Nom</span></div>
        <div>Aln: <span id="navAlign">OK</span></div>
    </div>

    <!-- NEW: Safety Monitor -->
    <div class="panel">
        <h3>Safety Monitor (±5 Safe Zone)</h3>
        <div>Prs: <span id="safePressure" class="safe">0</span>%</div>
        <div>MF: <span id="safeMF" class="safe">0</span>%</div>
        <div>En: <span id="safeEnergy" class="safe">0</span>%</div>
        <div>SMC: <span id="safeSMC" class="safe">0</span>%</div>
        <div>MB: <span id="safeMB" class="safe">0</span>%</div>
        <div>Aln Dev: <span id="safeAlnDev" class="safe">0</span>°</div>
        <div class="warning" id="safetyWarning">⚠ SAFETY BREACH — AUTO-IDLE</div>
    </div>

    <!-- Mission -->
    <div class="panel">
        <h3>Mission & Time Sync</h3>
        <div>Earth: <span id="earthTime">--:--:--</span></div>
        <div>Ship: <span id="shipTime">--:--:--</span></div>
        <div>ETA: <span id="missionETA">0</span> min</div>
        <div>Arr: <span id="arrivalTime">--:--</span></div>
        <div>Countdown: <span id="countdown">--:--</span></div>
    </div>

    <div class="panel">
        <h3>Event Log</h3>
        <div id="eventLog" style="font-size:12px; max-height:120px; overflow-y:auto;"></div>
    </div>

    <!-- Compass -->
    <div class="panel">
        <h3>Course Compass</h3>
        <div class="compass">
            <div id="compassNeedle" class="compass-needle"></div>
        </div>
    </div>
</div>
<script>
let tripActive = false;
let tripTimer = null;
let countdownTimer = null;

// Planet data
const planetData = {
    Mercury: {au: 0.39, heading: 75},
    Venus: {au: 0.72, heading: 100},
    Earth: {au: 1.00, heading: 0},
    Mars: {au: 1.52, heading: 45},
    Jupiter: {au: 5.20, heading: 150},
    Saturn: {au: 9.58, heading: 200},
    Uranus: {au: 19.2, heading: 250},
    Neptune: {au: 30.1, heading: 300}
};

// Audio
let humSound = new Audio("warpdrive/hum.mp3");
humSound.loop = true;
let warpSound = new Audio("warpdrive/warp.mp3");
let arriveSound = new Audio("warpdrive/arrive.mp3");

// Start hum immediately
window.addEventListener("load", () => { humSound.play().catch(()=>{}); });

// Engage warp
function engageWarp() {
    if (tripActive) return;
    tripActive = true;
    document.getElementById('status').innerText = 'Active';
    warpSound.play();

    let warpFactor = parseInt(document.getElementById('warp').value);
    let planet = document.getElementById('planet').value;
    document.getElementById('wf').innerText = warpFactor;

    let data = planetData[planet];
    let distance = data.au;
    document.getElementById('dst').innerText = distance;

    // Time-based FTL calculations
    let c = 299792.458; // km/s
    let warpSpeed = c * Math.pow(warpFactor, 3); // km/s
    let distanceKm = distance * 149597870; // AU -> km
    let etaMin = Math.max(1, Math.round(distanceKm / warpSpeed / 60));

    let pressure = Math.min(100, (warpFactor**2 * 1.2) + (distance * 2.5));
    let mf = Math.min(100, (warpFactor**2 * 1.1) + (distance * 1.8));
    let energy = Math.min(100, (warpFactor**2 * 1.3) + (distance * 1.6));

    document.getElementById('eta').innerText = etaMin;
    animateGauges(pressure, mf, energy);

    updateNavigation(planet, warpFactor, etaMin);
    updateCompass(data.heading);
    startCountdown(etaMin);
    logEvent(`Engaged Warp ${warpFactor} to ${planet}. ETA ${etaMin} min.`);

    tripTimer = setTimeout(() => { idleEngine(true); }, etaMin * 1000);
}

// Animate gauges
function animateGauges(pressure, mf, energy) {
    let pGauge = document.getElementById('pressureGauge');
    let mGauge = document.getElementById('mfGauge');
    let eGauge = document.getElementById('energyGauge');
    let pVal = document.getElementById('pressureVal');
    let mVal = document.getElementById('mfVal');
    let eVal = document.getElementById('energyVal');

    let step = 0;
    let update = setInterval(() => {
        if (!tripActive) { clearInterval(update); return; }
        let pNow = Math.min(pressure, step);
        let mNow = Math.min(mf, step);
        let eNow = Math.min(energy, step);
        pGauge.style.width = pNow + '%';
        mGauge.style.width = mNow + '%';
        eGauge.style.width = eNow + '%';
        pVal.innerText = pNow;
        mVal.innerText = mNow;
        eVal.innerText = eNow;

        // Calculate stability values
        let smc = Math.max(0, 100 - (pNow / 2));
        let mb = Math.max(0, 100 - (Math.abs(mNow - 50) / 0.5));
        let alnDev = (parseInt(document.getElementById('warp').value) > 8) ?
                     (parseInt(document.getElementById('warp').value) - 8) * 2 : 0;

        // Update safety monitor
        updateSafetyMonitor(pNow, mNow, eNow, smc, mb, alnDev);

        step += 5;
    }, 300);
}

// Safety monitor with ±5 safe zone
function updateSafetyMonitor(pressure, mf, energy, smc, mb, alnDev) {
    setSafetyColor("safePressure", pressure, 50);
    setSafetyColor("safeMF", mf, 50);
    setSafetyColor("safeEnergy", energy, 50);
    setSafetyColor("safeSMC", smc, 100);
    setSafetyColor("safeMB", mb, 100);
    setSafetyColor("safeAlnDev", alnDev, 0, true);

    // Auto-idle if any breach
    if (isBreach(pressure, 50) || isBreach(mf, 50) || isBreach(energy, 50) ||
        isBreach(smc, 100) || isBreach(mb, 100) || isBreach(alnDev, 0, true)) {
        document.getElementById('safetyWarning').style.display = 'block';
        document.getElementById('warning').style.display = 'block';
        setTimeout(()=>idleEngine(false), 1500);
    } else {
        document.getElementById('safetyWarning').style.display = 'none';
    }
}

// Set parameter color
function setSafetyColor(id, value, nominal, isDegrees=false) {
    let diff = isDegrees ? Math.abs(value) : Math.abs(value - nominal);
    let el = document.getElementById(id);
    el.innerText = value.toFixed(0);
    if (diff <= 4) {
        el.className = "safe";
    } else if (diff > 4 && diff <= 5) {
        el.className = "warn";
    } else {
        el.className = "danger";
    }
}

// Check for breach
function isBreach(value, nominal, isDegrees=false) {
    let diff = isDegrees ? Math.abs(value) : Math.abs(value - nominal);
    return diff > 5;
}

// Navigation update
function updateNavigation(planet, warpFactor, etaMin) {
    let data = planetData[planet];
    let kmDist = (data.au * 149597870).toFixed(0);

    document.getElementById('navPlanet').innerText = planet;
    document.getElementById('navDistAU').innerText = data.au;
    document.getElementById('navDistKM').innerText = kmDist;
    document.getElementById('navETA').innerText = etaMin;
    document.getElementById('navHeading').innerText = data.heading;
    document.getElementById('navGravity').innerText = (warpFactor > 8 && data.au > 5) ? "High" : "Nom";
    document.getElementById('navAlign').innerText = (warpFactor > 9) ? "Adj" : "OK";
}

// Compass update
function updateCompass(degrees) {
    document.getElementById('compassNeedle').style.transform =
        `translateX(-50%) rotate(${degrees}deg)`;
}

// Countdown timer
function startCountdown(etaMinutes) {
    let remaining = etaMinutes * 60;
    let arrival = new Date(Date.now() + remaining * 1000);
    document.getElementById('arrivalTime').innerText = arrival.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    document.getElementById('missionETA').innerText = etaMinutes;

    countdownTimer = setInterval(() => {
        if (!tripActive) { clearInterval(countdownTimer); return; }
        remaining--;
        let mins = Math.floor(remaining / 60);
        let secs = remaining % 60;
        document.getElementById('countdown').innerText =
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        if (remaining <= 0) {
            clearInterval(countdownTimer);
            idleEngine(true);
        }
    }, 1000);
}

// Idle engine
function idleEngine(arrived) {
    clearTimeout(tripTimer);
    tripActive = false;
    document.getElementById('status').innerText = 'Idle';
    document.getElementById('warning').style.display = 'none';
    document.getElementById('safetyWarning').style.display = 'none';
    resetGauges();
    updateCompass(0);
    logEvent("Engine returned to idle.");
    if (arrived) {
        arriveSound.play();
        logEvent("Arrived at destination.");
    }
}

// Reset gauges
function resetGauges() {
    document.getElementById('pressureGauge').style.width = '0%';
    document.getElementById('mfGauge').style.width = '0%';
    document.getElementById('energyGauge').style.width = '0%';
    document.getElementById('pressureVal').innerText = '0';
    document.getElementById('mfVal').innerText = '0';
    document.getElementById('energyVal').innerText = '0';
}

// Update clocks
function updateClocks() {
    let now = new Date();
    document.getElementById('earthTime').innerText = now.toLocaleTimeString();
    let shipNow = new Date(now.getTime() + (tripActive ? 2000 : 0));
    document.getElementById('shipTime').innerText = shipNow.toLocaleTimeString();
}
setInterval(updateClocks, 1000);

// Event log
function logEvent(msg) {
    let time = new Date().toLocaleTimeString();
    let entry = `[${time}] ${msg}`;
    let log = document.getElementById('eventLog');
    log.innerHTML = entry + "<br>" + log.innerHTML;
}
</script>
</body>
</html>
