<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Warp Control ‚Äî Even Grid + Compact Panels (v3.6.3 ‚Ä¢ row-height)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#070b12; --panel:#0c1424; --glass:#0d1a31cc; --edge:#27406b;
    --text:#eaf2ff; --muted:#a7b9df; --good:#22c55e; --warn:#facc15; --bad:#ef4444;
    --ui-scale:1; --fs:14px; --pad:8px;
    --gap: clamp(12px, 2.2vmin, 24px);
    /* NEW: global vertical scale for rows/canvases */
    --row-scale: 0.90; /* 90% by default; adjust with slider */
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1200px 800px at 10% -10%, #112240 0%, transparent 60%),
      radial-gradient(900px 900px at 120% -20%, #0b1b33 0%, transparent 50%),
      var(--bg);
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;font-size:var(--fs);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .viewportScale{transform:scale(var(--ui-scale));transform-origin:top left;width:calc(100%/var(--ui-scale))}
  .wrap{max-width:1400px;margin:0 auto;padding:var(--pad)}
  .glass{
    background:linear-gradient(180deg,#0b1528aa,#0b152880),
               radial-gradient(600px 200px at 20% -30%,#15305f55,transparent 60%);
    backdrop-filter:blur(6px)
  }
  .panel{
    border:1px solid var(--edge);border-radius:12px;padding:calc(var(--pad) - 1px);
    box-shadow:0 10px 24px rgba(0,0,0,.42);
    display:flex; flex-direction:column;
    height:100%;
    /* NEW: smaller minimum height, scaled */
    min-height: calc(240px * var(--row-scale));
  }
  h1,h2,h3{margin:.35rem 0}
  .grid{display:grid;gap:var(--gap)}

  /* Even grid with equal row heights, controlled by tallest card */
  .evenGrid{
    display:grid;
    grid-template-columns: repeat(4, minmax(260px, 1fr));
    gap:var(--gap);
    align-items:stretch;
    grid-auto-rows:1fr;
  }
  .evenGrid > .panel{height:100%}

  @media (max-width:1250px){ .evenGrid{ grid-template-columns: repeat(3, minmax(260px, 1fr)); } }
  @media (max-width:980px){  .evenGrid{ grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
  @media (max-width:640px){  .evenGrid{ grid-template-columns: 1fr; } }

  .span-all{grid-column:1 / -1}

  .controls label,
  .grid label{display:flex;flex-direction:column;align-items:flex-start;gap:4px;margin:6px 0;color:var(--muted);font-size:.95rem}
  select,input[type="number"],input[type="text"]{
    width:100%;background:#0b1220;color:#eaf2ff;border:1px solid #34425f;border-radius:8px;padding:6px 8px;font-size:.95rem
  }
  input[type="range"]{width:100%}

  button{background:#1b2a44;border:1px solid #304166;color:#e6eefc;padding:7px 9px;margin:3px;border-radius:8px;cursor:pointer}
  #startBtn{background:#00ccff;color:#00131a;border:none} #stopBtn{background:#64748b}
  #resetBtn{background:#fb923c;border:none} #exportBtn{background:#7c3aed;border:none}

  .lights{display:flex;gap:8px;flex-wrap:wrap}
  .light{display:flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:.85rem}
  .dot{width:9px;height:9px;border-radius:50%}
  .good .dot{background:var(--good)} .warn .dot{background:var(--warn)} .bad .dot{background:var(--bad)}

  .meter{display:flex;align-items:center;gap:8px;margin:4px 0}
  .bar{height:9px;background:#0b1220;border:1px solid #334155;border-radius:6px;overflow:hidden;flex:1}
  .fill{height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  .stat{font-variant-numeric:tabular-nums;font-size:.86rem;color:var(--muted)}

  canvas{
    background:linear-gradient(180deg,#091323,#0a1322);
    border:1px solid #2b3a5a;border-radius:10px;max-width:100%;display:block
  }
  .pill{display:inline-block;padding:.1rem .4rem;border:1px solid #36507d;border-radius:999px;font-size:.8rem;color:#a5f3fc}
  .legend{color:var(--muted);font-size:.84rem;margin-top:6px}
  .hdrline{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .toggle{display:flex;align-items:center;gap:10px;color:#a7b9df;font-size:.9rem}
  .badge{border:1px solid #3b4f77;border-radius:999px;padding:2px 8px;color:#93c5fd;background:#0b1220}

  .clockSection{margin-top:6px}
  .clockHeader{display:flex;align-items:center;justify-content:space-between;margin:2px 0 6px}
  .clockGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--gap)}
  @media (max-width:1200px){ .clockGrid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:820px){  .clockGrid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){  .clockGrid{grid-template-columns:1fr} }

  .clockCard{background:#0b1220;border:1px solid #304166;border-radius:12px;padding:8px;display:grid;gap:4px; align-content:start}
  .clockHdr{display:flex;justify-content:space-between;align-items:center}
  .clockTitle{font-weight:600}
  .status{font-size:.78rem;border:1px solid #36507d;border-radius:999px;padding:2px 6px}
  .status.good{color:#0f0;border-color:#256f2a} .status.warn{color:#222;background:#facc15} .status.bad{color:#fff;background:#ef4444}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:4px 8px;font-size:.84rem;color:#cfe2ff}

  /* === canvas heights now scale with --row-scale === */
  #curveCanvas{width:100%;height:calc(200px * var(--row-scale))}
  #orbitCanvas{width:100%;height:calc(280px * var(--row-scale))}
  #debrisCanvas{width:100%;height:calc(180px * var(--row-scale))}
  #starfieldCanvas{width:100%;height:calc(160px * var(--row-scale));
                   background:radial-gradient(160px 105px at 50% 60%, #0a1322 0%, #08101d 65%, #060d18 100%)}
  #shieldCanvas{width:100%;height:calc(160px * var(--row-scale))}
  #grCanvas{width:100%;height:calc(110px * var(--row-scale))}
</style>
</head>
<body>
<div class="viewportScale">
  <div class="wrap grid">
    <div class="hdrline">
      <h1>üöÄ Warp Control Center</h1>
      <div class="toggle">
        <label>UI Scale
          <input id="uiScale" type="range" min="70" max="140" step="1" value="100">
          <span id="uiScaleVal" class="badge">100%</span>
        </label>
        <!-- NEW: row height control -->
        <label>Row Height
          <input id="rowScale" type="range" min="70" max="120" step="1" value="90">
          <span id="rowScaleVal" class="badge">90%</span>
        </label>
        <label>Sound <input id="soundOn" type="checkbox" checked></label>
        <span class="badge">v3.6.3 ‚Ä¢ Row height</span>
      </div>
    </div>

    <section class="evenGrid">
      <!-- Flight Plan -->
      <div class="panel glass">
        <h2>Flight Plan</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
          <label>Warp Speed
            <select id="warpSpeed"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
          </label>
          <label>Destination
            <select id="destination"><option>Mars</option><option>Jupiter</option><option>Saturn</option><option>Pluto</option></select>
          </label>
          <label>Warp Law (n) <input id="warpExp" type="number" step="0.1" value="3"></label>
          <label>Speed Scale (√óc) <input id="warpScale" type="number" step="0.1" value="1"></label>
          <label>IST Day 0 (yrs ago) <input id="istDay0Years" type="number" step="1" value="45500000000"></label>
          <label>Days / IST year <input id="baselineDaysPerYear" type="number" step="0.001" value="365.25"></label>
          <label>Calibration
            <select id="calibration">
              <option value="off">Off</option>
              <option value="mars_opp">Mars ‚Äì Opposition (fast window)</option>
              <option value="mars_conj">Mars ‚Äì Conjunction (slow window)</option>
            </select>
          </label>
        </div>
        <div class="lights" style="margin-top:6px">
          <div class="light good" id="lightBubble"><span class="dot"></span>Bubble</div>
          <div class="light good" id="lightPower"><span class="dot"></span>Power</div>
          <div class="light good" id="lightVector"><span class="dot"></span>Vector</div>
          <div class="light good" id="lightNav"><span class="dot"></span>Nav</div>
        </div>
        <div style="margin-top:6px">
          <button id="startBtn">‚ñ∂Ô∏è Start</button>
          <button id="stopBtn">‚è∏Ô∏è Stop</button>
          <button id="resetBtn">üîÑ Engage Warp</button>
          <button id="exportBtn">üìÑ Export Log</button>
        </div>
        <div class="legend" id="beacon">‚è≥ Waiting‚Ä¶</div>
        <div class="legend" id="constraints">EC/Horizon: ‚Äî</div>
      </div>

      <!-- Gravity Vectoring -->
      <div class="panel glass">
        <h2>Gravity Vectoring Engine</h2>
        <div class="controls">
          <label>Reactor Output (MW) <input id="reactorMW" type="number" value="5000" step="50"></label>
          <label>Front Contraction % <input id="frontPct" type="range" min="0" max="100" value="35"><span class="stat" id="frontLbl"></span></label>
          <label>Rear Expansion % <input id="rearPct" type="range" min="0" max="100" value="65"><span class="stat" id="rearLbl"></span></label>
          <label>Left / Right Bias % <input id="lrBias" type="range" min="-50" max="50" value="0"><span class="stat" id="lrLbl"></span></label>
          <label>Up / Down Bias % <input id="udBias" type="range" min="-50" max="50" value="0"><span class="stat" id="udLbl"></span></label>
          <label>Intake Mode
            <select id="intakeMode">
              <option value="balanced">Balanced (¬±)</option>
              <option value="positive">Positive Gravity Capture</option>
              <option value="negative">Negative Gravity Capture</option>
            </select>
          </label>
        </div>
        <h3>Power Allocation</h3>
        <div class="meter"><span class="stat" style="width:120px">Field Coils</span><div class="bar"><div id="mCoils" class="fill" style="width:48%"></div></div><span class="stat" id="mCoilsVal"></span></div>
        <div class="meter"><span class="stat" style="width:120px">Vectoring Vanes</span><div class="bar"><div id="mVanes" class="fill" style="width:32%"></div></div><span class="stat" id="mVanesVal"></span></div>
        <div class="meter"><span class="stat" style="width:120px">Containment</span><div class="bar"><div id="mContain" class="fill" style="width:20%"></div></div><span class="stat" id="mContainVal"></span></div>
      </div>

      <!-- Trajectory -->
      <div class="panel glass">
        <h2>Trajectory & Field Vectors</h2>
        <canvas id="curveCanvas"></canvas>
        <div class="legend" id="curveLegend">‚Äî</div>
      </div>

      <!-- Polar Map -->
      <div class="panel glass">
        <h2>Heliocentric Polar Map (Now vs Arrival)</h2>
        <canvas id="orbitCanvas"></canvas>
        <div class="legend" id="orbitLegend">‚Äî</div>
      </div>

      <!-- Debris -->
      <div class="panel glass">
        <h2>Debris Defense Field</h2>
        <canvas id="debrisCanvas"></canvas>
        <div class="legend" id="debrisLegend">‚Äî</div>
      </div>

      <!-- Starfield -->
      <div class="panel glass">
        <h2>Warp Starfield Window</h2>
        <canvas id="starfieldCanvas"></canvas>
        <div class="legend" id="starfieldLegend">‚Äî</div>
      </div>

      <!-- Shield -->
      <div class="panel glass">
        <h2>Shield Bubble Box</h2>
        <canvas id="shieldCanvas"></canvas>
        <div class="legend" id="shieldLegend">‚Äî</div>
      </div>

      <!-- GR Mini -->
      <div class="panel glass">
        <h2>Einstein Tensor Mini</h2>
        <canvas id="grCanvas"></canvas>
        <div class="legend" id="grMini">G<sub>ŒºŒΩ</sub> proxy ‚Ä¢ œÅ<sub>em</sub> from |‚àáŒ¶|¬≤ (visual) ‚Ä¢ Auto-throttle if g<sub>tt</sub>‚â§0</div>
        <div class="legend">g<sub>tt</sub> min: <span id="gr_gtt">‚Äî</span> ‚Ä¢ œÅ<sub>em</sub> min/max: <span id="gr_rho">‚Äî</span> ‚Ä¢ EC: <span id="gr_ec">‚Äî</span> ‚Ä¢ Horizons: <span id="gr_hor">‚Äî</span></div>
      </div>

      <!-- IST Tracker -->
      <div class="panel glass span-all">
        <h2>IST Orbital Tracker (Live)</h2>
        <div id="orbit-rows" class="grid" style="grid-template-columns:repeat(4,1fr);gap:var(--gap)"></div>
      </div>
    </section>

    <section class="clockSection span-all">
      <div class="clockHeader">
        <h2>Clock Sync (C1‚ÄìC5) + Arrival CST/IST</h2>
        <span class="badge">Compact view</span>
      </div>
      <div class="clockGrid" id="clockGrid"></div>
    </section>
  </div>
</div>

<script>
/* ===== helpers & constants (unchanged math) ===== */
const AU_M=1.495978707e11, C_MPS=299792458, G=6.67430e-11, MU0=4*Math.PI*1e-7;
const orbitAU={ Earth:1.0, Mars:1.524, Jupiter:5.204, Saturn:9.582, Pluto:39.48 };
const orbitalDays={ Mercury:87.969, Venus:224.701, Earth:365.256, Mars:686.980, Jupiter:4332.59, Saturn:10759.22, Uranus:30685, Neptune:60190, Pluto:90560 };
const formationOffsetMyr={ Sun:0, Mercury:5, Venus:30, Earth:27, Mars:10, Jupiter:1, Saturn:3, Uranus:15, Neptune:20, Pluto:30 };
const $=id=>document.getElementById(id);
let ac=null;
function tone(kind="good"){ if(!$("soundOn").checked) return;
  if(!ac){try{ac=new (window.AudioContext||window.webkitAudioContext)();}catch{}}
  if(!ac) return; const o=ac.createOscillator(), g=ac.createGain();
  o.type="sine"; o.frequency.value= kind==="good"?880:kind==="warn"?520:320;
  g.gain.value=.001; o.connect(g).connect(ac.destination); o.start();
  g.gain.exponentialRampToValueAtTime(.07, ac.currentTime+.02);
  g.gain.exponentialRampToValueAtTime(.001, ac.currentTime+.18);
  o.stop(ac.currentTime+.2);
}
function setLight(el,level){ const was=el.dataset.level||"good";
  if(was!==level){ el.dataset.level=level; el.classList.remove("good","warn","bad"); el.classList.add(level); tone(level==="good"?"good":level==="warn"?"warn":"bad"); }
}

/* ===== IST time/orbits (unchanged) ===== */
let tIST0=performance.now();
function IST_INPUT(){ return Number($("istDay0Years").value||45500000000); }
function DPY_INPUT(){ return Number($("baselineDaysPerYear").value||365.25); }
function IST_snapshot(){ const dpy=DPY_INPUT(), spy=dpy*86400;
  const elapsed=(performance.now()-tIST0)/1000/spy;
  const istYears=IST_INPUT()+elapsed, istDays=istYears*dpy;
  return {istYears, istDays, dpy, spy};
}
function planetAgeYears(name,iy){ return Math.max(0, iy - (formationOffsetMyr[name]||0)*1e6); }
function trueAnomalyFrac(name,iy,dpy){ const py=planetAgeYears(name,iy), pd=py*dpy, T=orbitalDays[name];
  if(!T) return 0; const N=pd/T; return N-Math.floor(N);
}
function orbitsFor(name,pd){ const T=orbitalDays[name]; if(!T) return null;
  const tot=pd/T, comp=Math.max(0,Math.floor(tot)), frac=tot-comp, daysInto=frac*T;
  return {totalOrbits:tot,completed:comp,frac,daysInto,yearLen:T};
}

/* ===== Engine dynamics (unchanged) ===== */
let simulationRunning=false, shipProgress=0, shipArrived=false;
let driftInterval=null, beaconInterval=null, orbitInterval=null, animationFrame=null, lastFrameTime=performance.now();
const engineState={ t:0, temp:0, sag:0, containNeed:0.22, jitter:0 };
function stepEngineDynamics(dt, running){
  if(!running){ engineState.temp=Math.max(0,engineState.temp-0.30*dt);
    engineState.sag=Math.max(0,engineState.sag-0.25*dt); engineState.jitter*=0.85;
    engineState.containNeed=0.22+0.06*engineState.temp; return; }
  engineState.t+=dt; engineState.temp=Math.min(1,engineState.temp+0.06*dt);
  const baseSag=0.02+0.04*engineState.temp, ripple=0.01*Math.sin(0.7*engineState.t);
  engineState.sag=Math.max(0, baseSag + ripple);
  engineState.containNeed=0.22+0.06*engineState.temp;
  const biasMag=Math.hypot(Number($("lrBias").value||0)/100, Number($("udBias").value||0)/100);
  engineState.jitter = 0.01 + 0.03*biasMag + 0.01*Math.sin(3*engineState.t) + 0.006*(Math.random()-0.5);
  engineState.jitter = Math.max(0, Math.min(0.08, engineState.jitter));
}
function warpInputs(){ return { warp:Number($("warpSpeed").value||1), exp:Number($("warpExp").value||3), scale:Number($("warpScale").value||1) }; }
function engineInputs(){
  const reactorMW_in=Number($("reactorMW").value||5000);
  const front=Number($("frontPct").value||0)/100, rear=Number($("rearPct").value||0)/100;
  const lr=Number($("lrBias").value||0)/100, ud=Number($("udBias").value||0)/100;
  const mode=$("intakeMode").value;
  const reactorMW = reactorMW_in * (1 - engineState.sag);

  const vecDemand=Math.min(1, 0.4 + 0.6*(Math.abs(lr)+Math.abs(ud)+Math.abs(rear-front)));
  let coilsPct=Math.max(0.35, 0.55 - 0.25*vecDemand);
  let containPct=Math.max(engineState.containNeed, 0.20);
  let vanesPct=Math.min(0.35, 1 - coilsPct - containPct);
  const sum=coilsPct+containPct+vanesPct; if(sum>1){ const k=1/sum; coilsPct*=k; containPct*=k; vanesPct*=k; }

  $("mCoils").style.width=`${coilsPct*100}%`; $("mCoilsVal").textContent=`${(coilsPct*reactorMW).toFixed(0)} MW`;
  $("mVanes").style.width=`${vanesPct*100}%`; $("mVanesVal").textContent=`${(vanesPct*reactorMW).toFixed(0)} MW`;
  $("mContain").style.width=`${containPct*100}%`; $("mContainVal").textContent=`${(containPct*reactorMW).toFixed(0)} MW`;

  let stability=1.0;
  if (containPct < engineState.containNeed) stability -= 0.40*(engineState.containNeed - containPct)/engineState.containNeed;
  const biasMag2=Math.hypot(lr,ud); stability -= 0.30*Math.max(0, biasMag2-0.3)/0.7;
  if (rear<front) stability -= 0.20*(front-rear);
  if (mode==="positive" && rear<front) stability -= 0.05;
  if (mode==="negative" && rear>front) stability -= 0.05;
  stability -= engineState.jitter;
  stability = Math.max(0, Math.min(1, stability));

  return {reactorMW, front, rear, lr, ud, coilsPct, containPct, vanesPct, stability, mode};
}

/* ===== Physics gating & ETA (unchanged) ===== */
let lastPhysics = { gf:0.5, vcap_c:0.6, gttMin:1, ecOK:true, horizon:false, beta:0 };
let calib = "off"; const physicsCal = { kGF:1.00, kCap:1.00 };
function setCalibration(kind){ calib=kind;
  switch(kind){ case "mars_opp": physicsCal.kGF=1.12; physicsCal.kCap=1.10; break;
                 case "mars_conj": physicsCal.kGF=0.92; physicsCal.kCap=0.88; break;
                 default: physicsCal.kGF=1.00; physicsCal.kCap=1.00; }
}
function computeETASeconds(v_mps_override=null){
  const { istYears, dpy } = IST_snapshot();
  const dest=$("destination").value;
  const { warp, exp, scale } = warpInputs();
  const eng=engineInputs();

  const r1=orbitAU.Earth, r2=orbitAU[dest];
  const thE0=trueAnomalyFrac("Earth",istYears,dpy)*Math.PI*2;
  const thD0=trueAnomalyFrac(dest, istYears,dpy)*Math.PI*2;

  const TE = orbitalDays.Earth * 86400;
  const TD = orbitalDays[dest] * 86400;
  const wE = TE ? (2*Math.PI/TE) : 0;
  const wD = TD ? (2*Math.PI/TD) : 0;

  const v_base = C_MPS * scale * Math.pow(Math.max(1, warp), exp);
  const { v_mps, gf, vcap_c, gttMin, ecOK, horizon, beta } = gatedSpeed(v_base, eng);
  lastPhysics = { gf, vcap_c, gttMin, ecOK, horizon, beta };
  const v = v_mps_override ?? v_mps;

  let t=0; const maxIter=8;
  for(let k=0;k<maxIter;k++){
    const thE=thE0 + wE*t, thD=thD0 + wD*t;
    const dAU=Math.sqrt(r1*r1+r2*r2-2*r1*r2*Math.cos(thD-thE));
    const tNew=(dAU*AU_M)/Math.max(v,1e-3);
    if(Math.abs(tNew-t)<0.05){ t=tNew; break; }
    t=tNew;
  }
  const dAU0=Math.sqrt(r1*r1+r2*r2-2*r1*r2*Math.cos(thD0-thE0));
  setLight($("lightNav"), isFinite(t)?(t<86400?"good":"warn"):"bad");
  return { eta:t, dAU:dAU0, v, thE:thE0, thD:thD0, r1, r2 };
}
const MU0=4*Math.PI*1e-7;
const grCanvas=$("grCanvas"), grx=grCanvas.getContext("2d");
const GR={ nx:120, ny:48, L:900, sigma:150, scalePhi:1.0e10 };
function buildPotentialGrid(){
  const eng=engineInputs(); const front=eng.front, rear=eng.rear, lr=eng.lr, ud=eng.ud;
  const nx=GR.nx, ny=GR.ny, L=GR.L, dx=L/nx, dy=L/ny, s2=GR.sigma*GR.sigma;
  const A_r = rear*1.2e14, A_f = front*1.2e14;
  const x0 = 180 + 110*rear, y0 =  70*ud, xskew = 70*lr;
  const phi = new Float64Array(nx*ny);
  for(let j=0;j<ny;j++){
    const y=(j-ny/2)*dy;
    for(let i=0;i<nx;i++){
      const x=(i-nx/2)*dx;
      const rRear2=(x + x0 + xskew)**2 + (y - y0)**2;
      const rFront2=(x - x0 + xskew)**2 + (y + y0)**2;
      phi[i+j*nx] = (-A_r*Math.exp(-rRear2/s2) + A_f*Math.exp(-rFront2/s2))/GR.scalePhi;
    }
  }
  return {phi, dx, dy, nx, ny};
}
function grad2(phi,i,j,nx,ny,dx,dy){ const l=phi[(i>0?i-1:0)+j*nx], r=phi[(i<nx-1?i+1:nx-1)+j*nx]; const u=phi[i+(j>0?j-1:0)*nx], d=phi[i+(j<ny-1?j+1:ny-1)*nx]; const gx=(r-l)/(2*dx), gy=(d-u)/(2*dy); return {gx,gy,g2:gx*gx+gy*gy}; }
function validateGR(){
  const {phi, dx, dy, nx, ny} = buildPotentialGrid();
  let gttMin=+1, phiMin=+1e99, phiMax=-1e99, Eint=0;
  for(let k=0;k<phi.length;k++){ const v=phi[k]; if(v<phiMin)phiMin=v; if(v>phiMax)phiMax=v; }
  const span=Math.max(1e-12, phiMax-phiMin);

  grCanvas.width=grCanvas.clientWidth; grCanvas.height=Math.max(40, Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--row-scale')) * 110));
  grx.clearRect(0,0,grCanvas.width,grCanvas.height);

  let rhoMin=+1e99, rhoMax=-1e99, horizons=0;

  for(let j=1;j<ny-1;j++){
    for(let i=1;i<nx-1;i++){
      const {g2} = grad2(phi,i,j,nx,ny,dx,dy);
      Eint += g2 * dx * dy;
      const ph=phi[i+j*nx];
      const rho_em = g2/(2*MU0*C_MPS*C_MPS); if(rho_em<rhoMin)rhoMin=rho_em; if(rho_em>rhoMax)rhoMax=rho_em;
      const gtt=1 + 2*ph/(C_MPS*C_MPS); if(gtt<gttMin)gttMin=gtt; if(gtt<=0)horizons++;

      if(j===Math.floor(ny/2)){
        const x=Math.floor((i/nx)*grCanvas.width), t=(ph - phiMin)/span; 
        const r=Math.floor(255*Math.max(0,2*t-1)), b=Math.floor(255*Math.max(0,1-2*t));
        grx.fillStyle=`rgb(${r},0,${b})`; grx.fillRect(x,0,2,grCanvas.height);
      }
    }
  }

  $("gr_gtt").textContent = gttMin.toFixed(6);
  $("gr_rho").textContent = `${rhoMin.toExponential(3)} / ${rhoMax.toExponential(3)}`;
  $("gr_ec").textContent  = `‚úÖ NEC ‚Ä¢ ‚úÖ WEC ‚Ä¢ ‚úÖ SEC`;
  $("gr_hor").textContent = horizons>0 ? `‚ö† ${horizons}` : "None";

  return { Eint, gttMin };
}
function gatedSpeed(v_base, eng){
  const { Eint, gttMin } = validateGR();

  const Escaled = Math.log10(1 + Math.max(0, Eint)/1e6);
  const gf_raw = 1/(1+Math.exp(-(Escaled-2.0)));
  let gf = Math.max(0.05, Math.min(1.0, gf_raw * physicsCal.kGF));

  const pMW = Math.max(0, eng.reactorMW);
  let vcap_c = Math.min(0.99, physicsCal.kCap * (0.10 + 0.45*(1 - Math.exp(-pMW/6000)) + 0.25*gf) * Math.max(0.35, eng.stability));

  if (gttMin <= 0.01){ vcap_c = Math.min(vcap_c, 0.15); setLight($("lightBubble"),"bad"); }
  else if (gttMin < 0.05){ vcap_c = Math.min(vcap_c, 0.35); setLight($("lightBubble"),"warn"); }
  else setLight($("lightBubble"),"good");

  const v_limited = Math.min(v_base * gf, vcap_c * C_MPS);
  const beta = Math.max(0, Math.min(0.99, v_limited / C_MPS));
  const ecOK=true, horizon=(gttMin<=0);

  $("constraints").textContent = `EC/Horizon: g_tt min ${gttMin.toFixed(5)} ‚Ä¢ gf ${gf.toFixed(2)} ‚Ä¢ cap ${(vcap_c).toFixed(2)} c`;
  return { v_mps: v_limited, gf, vcap_c, gttMin, ecOK, horizon, beta };
}

/* ===== UI drawings & clocks (unchanged) ===== */
</script>
<script>
/* drawOrbitView, drawCurve, starfield/debris/shield, clocks, status‚Ä¶ (IDENTICAL to your v3.6.2)
   ‚Äî omitted here for brevity ‚Äî paste your existing JS blocks unchanged below this comment.
   If you prefer, keep exactly what you had; the only new logic you need is at the very end:
   the row-scale handler. */

/* ===== Row-scale + UI scale ===== */
const rootEl=document.documentElement, scaleEl=$("uiScale"), rowEl=$("rowScale");
function applyScale(){
  const pct=Number(scaleEl.value||100);
  try{ localStorage.setItem('uiScalePct', String(pct)); }catch{}
  rootEl.style.setProperty('--ui-scale',(pct/100).toString());
  $("uiScaleVal").textContent=pct+"%";
}
function applyRowScale(){
  const pct=Number(rowEl.value||90);
  rootEl.style.setProperty('--row-scale',(pct/100).toString());
  $("rowScaleVal").textContent=pct+"%";
  // redraw canvases at new heights
  if (typeof drawCurve==='function') drawCurve();
  if (typeof drawOrbitView==='function') drawOrbitView();
}
["input","change"].forEach(evt=>{
  if(scaleEl) scaleEl.addEventListener(evt, applyScale);
  if(rowEl)   rowEl.addEventListener(evt, applyRowScale);
});

/* ===== Init ===== */
window.addEventListener('resize', ()=>{ if (typeof drawCurve==='function') drawCurve(); if (typeof drawOrbitView==='function') drawOrbitView(); });
window.onload=()=>{ 
  try{ const saved=localStorage.getItem('uiScalePct'); if(saved){ $("uiScale").value = saved; $("uiScaleVal").textContent = saved + "%"; } }catch{}
  applyScale(); applyRowScale();
  if (typeof updateOrbitTable==='function') updateOrbitTable();
  if (typeof drawCurve==='function') drawCurve();
  if (typeof drawOrbitView==='function') drawOrbitView();
  if (typeof updateAllStatus==='function') updateAllStatus();
};
</script>
</body>
</html>
