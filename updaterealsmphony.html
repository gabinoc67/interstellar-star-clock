<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CST — Audio→CSV • A:10–16 + B:6–16 (sum 32, non-overlap) • 60s Orchestrator • 32 Chairs</title>
<style>
:root{
  --bg:#081122; --ink:#eaf1ff; --muted:#9fb2e4; --panel:#111b38; --grid:#1a2758;
  --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --blink:#6ee7ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0}
main{max-width:1500px;margin:0 auto;padding:16px;display:grid;grid-template-columns:520px 1fr;gap:16px}
.card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="file"],button,select,input[type="range"],input[type="number"]{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0e1733;color:var(--ink)
}
button{cursor:pointer;background:linear-gradient(180deg,#15245a,#0f1b45)}
button:hover{filter:brightness(1.06)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a7a,transparent);margin:12px 0}
.stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed var(--grid);border-radius:10px}
.stat b{color:var(--ok)}
#status{font-size:12px;color:#9ad1ff;margin-top:8px}
.danger{background:#3b1220;border-color:#6b1f35}
small.hint{display:block;color:#a8b7e3;margin-top:6px}

/* Stage */
.stage{
  position:relative;border:1px solid var(--grid);border-radius:14px;padding:16px;
  padding-top:300px;
  background:radial-gradient(120% 160% at 50% 110%,#0b1434 0%,#0a1027 60%,#0a1027 100%)
}
.stageHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}

/* 32 chairs grid */
.grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(4,1fr);gap:10px;min-height:620px}
.cell{display:flex;align-items:center;justify-content:center;min-height:115px}
.section{
  background:linear-gradient(180deg,#0e1b43,#0a1232);
  border:1px solid #20326d;border-radius:12px;width:100%;height:100%;
  padding:10px;display:flex;flex-direction:column;gap:6px;justify-content:space-between;
}
.title{font-weight:800;color:#e4eeff;font-size:12px}
.meta{font-size:11px;color:#9bb9ff}
.lights{display:flex;align-items:center;gap:6px}
.dot{width:14px;height:14px;border-radius:4px;border:2px solid #2a3b7a;background:#0c1430}
.blink{animation:blink .45s ease-out}
@keyframes blink{
  0%{background:#0c1430;border-color:#2a3b7a}
  30%{background:var(--blink);border-color:#bfefff}
  100%{background:#0c1430;border-color:#2a3b7a}
}
.check{width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid #ddd;color:#0a0;display:flex;align-items:center;justify-content:center;font-weight:900}
.checked{background:#eafff2;border-color:#b7f5cd;color:#059669}
.mixRow{display:flex;gap:6px;align-items:center}
.btnSmall{padding:6px 8px;font-size:11px}

/* Conductor + guide */
.conductor{
  width:92px;height:92px;border-radius:50%;
  background:#0d1b44;border:2px solid #284a9b;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#cfe1ff;
  box-shadow:0 0 0 0 rgba(59,130,246,.45);
  animation:conPulse 1.4s ease-in-out infinite;animation-play-state:paused;
}
@keyframes conPulse{
  0%{box-shadow:0 0 0 0 rgba(59,130,246,.45)}
  70%{box-shadow:0 0 0 16px rgba(59,130,246,0)}
  100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
}
.guide{
  position:absolute; left:50%; transform:translateX(-50%); top:118px; width:96%; max-width:1000px;
  background:#0c1536; border:1px solid #274094; border-radius:12px; padding:10px 12px; color:#cfe1ff; font-size:12px;
}
.guide b{color:#9fe8ff}
.guide ol{margin:6px 0 0 16px; padding-left:10px}
.guide li{margin:2px 0}

/* status dots */
.statusDot{width:12px;height:12px;border-radius:3px;background:#ffffff;border:2px solid #dddddd;display:inline-block;}
.statusOn{background:var(--ok);border-color:#b7f5cd;}

/* Conductor square panel */
.conductorPanel{margin-top:12px; display:flex; justify-content:center;}
.condCard{
  width:260px; height:260px; border:1px solid var(--grid); border-radius:14px; background:#0d1b3d;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
}
.conLabel{font-size:12px;color:#cfe1ff;opacity:0.9}

/* A/B highlights */
.section.isA { outline: 2px solid #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.18) inset; }
.section.isB { outline: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18) inset; }
.badge{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:.3px;vertical-align:middle;}
.badgeA{background:#0b2a1e;border:1px solid #10b981;color:#b9f6da;}
.badgeB{background:#0b1f3d;border:1px solid #3b82f6;color:#cfe1ff;}

/* Per-chair variants */
.chairPanel{max-height:260px; overflow:auto; border:1px solid var(--grid); border-radius:10px; padding:8px; background:#0f1a3b}
.chairRow{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; align-items:center; margin-bottom:6px; font-size:12px}
.chairHead{display:grid; grid-template-columns:1fr 72px 72px; gap:8px; font-size:11px; color:#9fb2e4; margin-bottom:6px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,"Courier New",monospace;font-size:11px;color:#bfe3ff}

/* Mini independent panel */
.miniCard{border:1px solid var(--grid);border-radius:12px;background:#0f1a3b;padding:10px}
.miniHead{font-weight:800;color:#e4eeff;font-size:12px;margin-bottom:6px}
</style>

<!-- SoundFont Player (for real instrument timbres) -->
<script src="https://unpkg.com/soundfont-player@0.15.2/dist/soundfont-player.js"></script>
</head>
<body>
<header>
  <h1>CST — Audio→CSV • A:10–16 &amp; B:6–16 (Total 32, Non-overlap) • 60s • 32 Chairs</h1>
  <span style="font-size:12px;color:#9ad1ff">You can choose A and B counts; total is locked to 32.</span>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <!-- Clear Audio -->
    <div class="row" style="margin-bottom:6px">
      <button id="btnClearAudio" class="danger">Clear Audio / Analysis / Export readiness</button>
      <div class="stat"><span>Audio file</span><b id="audioName">–</b></div>
    </div>

    <!-- AUDIO → CSV -->
    <label style="font-weight:700">Audio → CSV Notes (60s)</label>
    <div class="row3" style="margin-top:6px">
      <button id="btnLoadAudio">1) Load Audio (MP3/WAV/AAC/OGG)</button>
      <div class="mixRow">
        <button id="btnAnalyze">2) Analyze 60s</button>
        <span id="dotAnalyze" class="statusDot" title="Analysis status"></span>
      </div>
      <div class="mixRow">
        <button id="btnExport">3) Export CSV</button>
        <span id="dotExport" class="statusDot" title="Export ready"></span>
      </div>
    </div>
    <input id="audioFile" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>

    <div class="row" style="margin-top:8px">
      <div class="stat"><span>Detected Key</span><b id="detKey">–</b></div>
      <div class="stat"><span>Detected BPM</span><b id="detBPM">–</b></div>
    </div>
    <small class="hint">CSV headers: <b>t,m,b</b> (time sec, dominant MIDI, bass MIDI). Export → then load into A/B.</small>
    <div class="hr"></div>

    <!-- CSV LOADERS -->
    <label style="font-weight:700">Load CSV Notes</label>
    <div class="row">
      <div>
        <input id="csvA" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadA">Load CSV → A</button>
          <button id="btnClearA" class="danger" style="width:auto;padding:8px 10px">Clear A</button>
          <span id="dotA" class="statusDot" title="A loaded"></span>
        </div>
      </div>
      <div>
        <input id="csvB" type="file" accept=".csv"/>
        <div class="mixRow" style="margin-top:6px">
          <button id="btnLoadB">Load CSV → B</button>
          <button id="btnClearB" class="danger" style="width:auto;padding:8px 10px">Clear B</button>
          <span id="dotB" class="statusDot" title="B loaded"></span>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Conductor / Musicalize -->
    <label style="font-weight:700">Conductor / Musicalize</label>
    <div class="row">
      <div>
        <select id="composer">
          <option value="cinematic" selected>Cinematic — lush</option>
          <option value="mozart">Mozart — classic</option>
          <option value="beethoven">Beethoven — bold</option>
          <option value="bach">Bach — contrapuntal</option>
          <option value="haydn">Haydn — balanced</option>
          <option value="tchaikovsky">Tchaikovsky — lyrical</option>
          <option value="ravel">Ravel — color</option>
          <option value="mahler">Mahler — expansive</option>
          <option value="shostakovich">Shostakovich — edgy</option>
          <option value="debussy">Debussy — fluid</option>
          <option value="stravinsky">Stravinsky — rhythmic</option>
          <option value="price">Florence Price — warm</option>
          <option value="lili">Lili Boulanger — luminous</option>
          <option value="clara">Clara Schumann — lyrical</option>
          <option value="fanny">Fanny Mendelssohn — elegant</option>
          <option value="amy">Amy Beach — romantic</option>
          <option value="saariaho">Kaija Saariaho — spectral</option>
          <option value="tower">Joan Tower — kinetic</option>
          <option value="montgomery">Jessie Montgomery — vibrant</option>
          <option value="williams">John Williams — cinematic</option>
          <option value="zimmer">Hans Zimmer — hybrid</option>
        </select>
      </div>
      <div>
        <label>Key Root</label>
        <select id="keyRoot"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Mode</label>
        <select id="keyMode">
          <option value="major" selected>Major</option>
          <option value="minor">Minor</option>
        </select>
      </div>
      <div>
        <label>BPM (Tempo)</label>
        <input id="bpm" type="number" min="40" max="200" step="1" value="100"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Quantize</label>
        <select id="quant">
          <option value="0.25">1/4</option>
          <option value="0.125" selected>1/8</option>
          <option value="0.0625">1/16</option>
        </select>
      </div>
      <div>
        <label>Swing (0–60%)</label>
        <input id="swing" type="range" min="0" max="0.6" step="0.01" value="0.10"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Humanize (ms)</label><input id="human" type="number" min="0" max="40" step="1" value="6"/></div>
      <div><label>Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Reverb Mix</label><input id="reverbMix" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
      <div><label>Stereo Spread</label><input id="spread" type="range" min="0" max="1" step="0.01" value="0.55"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>GM Program (0–127)</label>
        <input id="gmProg" type="number" min="0" max="127" step="1" value="48" />
        <small class="hint">Global timbre (still allows per-chair micro-variants below).</small>
      </div>
      <div>
        <label>Export Audio</label>
        <div class="mixRow">
          <button id="btnExportAudio">Export WAV (60s)</button>
          <span id="dotExportAudio" class="statusDot" title="WAV export (lights when ready)"></span>
        </div>
        <small class="hint">White square lights when a 60s score is ready to export.</small>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Cadence & Pace -->
    <label style="font-weight:700">Cadence &amp; Pace</label>
    <div class="row3" id="cadenceRow">
      <button class="cadBtn" data-cad="even">Even</button>
      <button class="cadBtn" data-cad="march">March (2/4)</button>
      <button class="cadBtn" data-cad="waltz">Waltz (3/4)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="latin">Latin (2–3)</button>
      <button class="cadBtn" data-cad="sync">Syncopated</button>
      <button class="cadBtn" data-cad="swing">Swing (Shuffle)</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="cadBtn" data-cad="jig68">Jig (6/8)</button>
      <button class="cadBtn" data-cad="odd54">Odd (5/4)</button>
      <div class="stat"><span>Active cadence</span><b id="cadName">Even</b></div>
    </div>

    <div class="row3" style="margin-top:8px">
      <button class="paceBtn" data-pace="adagio">Adagio</button>
      <button class="paceBtn" data-pace="andante">Andante</button>
      <button class="paceBtn" data-pace="moderato">Moderato</button>
    </div>
    <div class="row3" style="margin-top:6px">
      <button class="paceBtn" data-pace="allegro">Allegro</button>
      <button class="paceBtn" data-pace="vivace">Vivace</button>
      <button class="paceBtn" data-pace="presto">Presto</button>
    </div>
    <div class="stat" style="margin-top:6px"><span>Active pace</span><b id="paceName">Andante</b></div>

    <div class="hr"></div>

    <!-- Family Opening -->
    <label style="font-weight:700">Family Opening (entry timing bias)</label>
    <div class="row">
      <button id="btnOpenRandom" title="Generate a musical opening order">Randomize Family Opening</button>
      <button id="btnOpenReset">Reset Default</button>
    </div>
    <div class="stat" style="margin-top:6px">
      <span>Open @ seconds (Strings, Winds, Brass, Perc)</span>
      <b class="mono" id="openSummary">0, 8, 16, 24</b>
    </div>

    <div class="hr"></div>

    <!-- Orchestration Picks -->
    <label style="font-weight:700">Orchestration Picks (A:10–16, B:6–16 • non-overlapping • total 32)</label>
    <div class="row" style="margin-bottom:6px">
      <div>
        <label>Target A (10–16)</label>
        <div class="mixRow">
          <input id="countA" type="number" min="10" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomA">Randomize A (16)</button>
        </div>
      </div>
      <div>
        <label>Target B (6–16)</label>
        <div class="mixRow">
          <input id="countB" type="number" min="6" max="16" step="1" value="16" style="max-width:96px"/>
          <button id="btnRandomB">Randomize B (16)</button>
        </div>
      </div>
    </div>
    <small class="hint">Counts auto-adjust to keep A + B = 32. Locks are respected.</small>

    <div class="twoCols" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>A Selected</span><b id="selCountA">0</b></div>
        </div>
        <div id="listA" class="pickList"></div>
      </div>
      <div>
        <div class="row" style="margin-bottom:6px">
          <div class="stat"><span>B Selected</span><b id="selCountB">0</b></div>
        </div>
        <div id="listB" class="pickList"></div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Per-Chair Variants -->
    <label style="font-weight:700">Per-Chair Variants (tiny differences per A/B chair)</label>
    <div class="chairHead"><div>Chair</div><div>Variant</div><div>Detune</div></div>
    <div id="chairPanel" class="chairPanel"></div>
    <small class="hint">Variant tweaks tone/attack; detune is ± cents. Defaults: A (brighter) / B (warmer).</small>

    <div class="hr"></div>

    <div class="row">
      <button id="playBtn">Play (60s)</button>
      <button id="stopBtn" class="danger">Stop</button>
    </div>
    <button id="resetBtn" style="margin-top:8px">Reset</button>

    <div id="status">Ready.</div>

    <div class="hr"></div>
    <!-- ===== INDEPENDENT A+B → ARRANGED CSV PANEL (self-contained) ===== -->
    <div class="miniCard">
      <div class="miniHead">Independent A+B → Arrange &amp; Export CSV (self-contained)</div>
      <div class="row3" style="margin-bottom:6px">
        <button id="abLoad1">Load Song 1</button>
        <button id="abLoad2">Load Song 2</button>
        <button id="abAnalyze">Analyze &amp; Arrange</button>
      </div>
      <input id="abFile1" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
      <input id="abFile2" type="file" accept=".mp3,.wav,.m4a,.aac,.ogg" style="display:none"/>
      <div class="row" style="margin-top:6px">
        <div><label>BPM</label><input id="abBPM" type="number" min="40" max="200" step="1" value="100"/></div>
        <div>
          <label>Cadence</label>
          <select id="abCad">
            <option value="even" selected>Even</option>
            <option value="march">March (2/4)</option>
            <option value="waltz">Waltz (3/4)</option>
            <option value="latin">Latin (2–3)</option>
            <option value="sync">Syncopated</option>
            <option value="swing">Swing</option>
            <option value="jig68">Jig (6/8)</option>
            <option value="odd54">Odd (5/4)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div><label>Swing (0–60%)</label><input id="abSwing" type="range" min="0" max="0.6" step="0.01" value="0.10"/></div>
        <div>
          <label>Profile</label>
          <select id="abProfile">
            <option value="pop" selected>Pop</option>
            <option value="build">Build</option>
            <option value="flat">Flat</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="abExport">Export Arranged CSV</button>
        <button id="abReset" class="danger">Reset Panel</button>
      </div>
      <div class="stat" style="margin-top:8px">
        <span id="abStatusLabel">Status</span>
        <b id="abStatus">Load two ~1-minute songs.</b>
      </div>
    </div>
    <!-- ===== end independent panel ===== -->
  </section>

  <!-- RIGHT: STAGE -->
  <section class="card stage">
    <div class="stageHeader">
      <div class="stat"><span>Seating</span><b>Even spacing • Front strings, winds middle, brass back, perc rear • 32 chairs</b></div>
    </div>

    <div class="guide">
      <b>How the 1-minute AI Symphony Orchestra works (HTML + Web Audio)</b>
      <ol>
        <li><b>Load Audio</b> and (optionally) click <b>Analyze 60s</b> to auto-detect notes &amp; tempo.</li>
        <li><b>Export CSV</b> (<code>t,m,b</code>) then load CSV into <b>A</b> and/or <b>B</b> panels.</li>
        <li>Choose <b>A (10–16)</b> and <b>B (6–16)</b>. Total stays 32, no overlap. Locks respected.</li>
        <li>Set Conductor/Key/Tempo/Quantize/Swing/Humanize/Reverb/Spread, plus Cadence &amp; Pace.</li>
        <li>Use <b>Per-Chair Variants</b> (bright/warm etc.).</li>
        <li>Press <b>Play</b> for a 60s render; lights blink on sounding chairs. <b>Export WAV</b> to save audio.</li>
        <li>Need to start over? Use <b>Clear</b> buttons (Audio / A / B) or <b>Reset</b> for a full reset.</li>
      </ol>
    </div>
    <!-- 32 Chairs (8 x 4) -->
    <div class="grid">
      <!-- Row 1 -->
      <div class="cell"><div class="section" data-sec="trumpetsa"><div class="title">Trumpets A</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsa"></div><div class="check" id="chk-trumpetsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsa">Mute</button><button class="btnSmall" data-solo="trumpetsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trumpetsb"><div class="title">Trumpets B</div><div class="meta">Back L</div><div class="lights"><div class="dot" id="dot-trumpetsb"></div><div class="check" id="chk-trumpetsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trumpetsb">Mute</button><button class="btnSmall" data-solo="trumpetsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="hornsa"><div class="title">French Horns A</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsa"></div><div class="check" id="chk-hornsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsa">Mute</button><button class="btnSmall" data-solo="hornsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="hornsb"><div class="title">French Horns B</div><div class="meta">Back M</div><div class="lights"><div class="dot" id="dot-hornsb"></div><div class="check" id="chk-hornsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="hornsb">Mute</button><button class="btnSmall" data-solo="hornsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="perca"><div class="title">Percussion A</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-perca"></div><div class="check" id="chk-perca"></div></div><div class="mixRow"><button class="btnSmall" data-mute="perca">Mute</button><button class="btnSmall" data-solo="perca">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="percb"><div class="title">Percussion B</div><div class="meta">Back C</div><div class="lights"><div class="dot" id="dot-percb"></div><div class="check" id="chk-percb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="percb">Mute</button><button class="btnSmall" data-solo="percb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombonesa"><div class="title">Trombones/Tuba A</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesa"></div><div class="check" id="chk-trombonesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesa">Mute</button><button class="btnSmall" data-solo="trombonesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="trombonesb"><div class="title">Trombones/Tuba B</div><div class="meta">Back R</div><div class="lights"><div class="dot" id="dot-trombonesb"></div><div class="check" id="chk-trombonesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="trombonesb">Mute</button><button class="btnSmall" data-solo="trombonesb">Solo</button></div></div></div>

      <!-- Row 2 -->
      <div class="cell"><div class="section" data-sec="flutesa"><div class="title">Flutes/Picc. A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-flutesa"></div><div class="check" id="chk-flutesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutesa">Mute</button><button class="btnSmall" data-solo="flutesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="flutesb"><div class="title">Flutes/Picc. B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-flutesb"></div><div class="check" id="chk-flutesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="flutesb">Mute</button><button class="btnSmall" data-solo="flutesb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="oboesa"><div class="title">Oboes A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-oboesa"></div><div class="check" id="chk-oboesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboesa">Mute</button><button class="btnSmall" data-solo="oboesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="oboesb"><div class="title">Oboes B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-oboesb"></div><div class="check" id="chk-oboesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="oboesb">Mute</button><button class="btnSmall" data-solo="oboesb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="clarinetsa"><div class="title">Clarinets A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-clarinetsa"></div><div class="check" id="chk-clarinetsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinetsa">Mute</button><button class="btnSmall" data-solo="clarinetsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="clarinetsb"><div class="title">Clarinets B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-clarinetsb"></div><div class="check" id="chk-clarinetsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="clarinetsb">Mute</button><button class="btnSmall" data-solo="clarinetsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassoonsa"><div class="title">Bassoons A</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-bassoonsa"></div><div class="check" id="chk-bassoonsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoonsa">Mute</button><button class="btnSmall" data-solo="bassoonsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassoonsb"><div class="title">Bassoons B</div><div class="meta">Winds</div><div class="lights"><div class="dot" id="dot-bassoonsb"></div><div class="check" id="chk-bassoonsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassoonsb">Mute</button><button class="btnSmall" data-solo="bassoonsb">Solo</button></div></div></div>

      <!-- Row 3 -->
      <div class="cell"><div class="section" data-sec="pianoa"><div class="title">Piano A</div><div class="meta">Keys</div><div class="lights"><div class="dot" id="dot-pianoa"></div><div class="check" id="chk-pianoa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="pianoa">Mute</button><button class="btnSmall" data-solo="pianoa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="pianob"><div class="title">Piano B</div><div class="meta">Keys</div><div class="lights"><div class="dot" id="dot-pianob"></div><div class="check" id="chk-pianob"></div></div><div class="mixRow"><button class="btnSmall" data-mute="pianob">Mute</button><button class="btnSmall" data-solo="pianob">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassesa"><div class="title">Double Basses A</div><div class="meta">Back Strings</div><div class="lights"><div class="dot" id="dot-bassesa"></div><div class="check" id="chk-bassesa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassesa">Mute</button><button class="btnSmall" data-solo="bassesa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="bassesb"><div class="title">Double Basses B</div><div class="meta">Back Strings</div><div class="lights"><div class="dot" id="dot-bassesb"></div><div class="check" id="chk-bassesb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="bassesb">Mute</button><button class="btnSmall" data-solo="bassesb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="drumsa"><div class="title">Drums A</div><div class="meta">Rhythm</div><div class="lights"><div class="dot" id="dot-drumsa"></div><div class="check" id="chk-drumsa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="drumsa">Mute</button><button class="btnSmall" data-solo="drumsa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="drumsb"><div class="title">Drums B</div><div class="meta">Rhythm</div><div class="lights"><div class="dot" id="dot-drumsb"></div><div class="check" id="chk-drumsb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="drumsb">Mute</button><button class="btnSmall" data-solo="drumsb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="harpa"><div class="title">Harp/Keys A</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harpa"></div><div class="check" id="chk-harpa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harpa">Mute</button><button class="btnSmall" data-solo="harpa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="harpb"><div class="title">Harp/Keys B</div><div class="meta">Right</div><div class="lights"><div class="dot" id="dot-harpb"></div><div class="check" id="chk-harpb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="harpb">Mute</button><button class="btnSmall" data-solo="harpb">Solo</button></div></div></div>

      <!-- Row 4 -->
      <div class="cell"><div class="section" data-sec="vln1a"><div class="title">1st Violins A</div><div class="meta">Far L</div><div class="lights"><div class="dot" id="dot-vln1a"></div><div class="check" id="chk-vln1a"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1a">Mute</button><button class="btnSmall" data-solo="vln1a">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln1b"><div class="title">1st Violins B</div><div class="meta">Far L</div><div class="lights"><div class="dot" id="dot-vln1b"></div><div class="check" id="chk-vln1b"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln1b">Mute</button><button class="btnSmall" data-solo="vln1b">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln2a"><div class="title">2nd Violins A</div><div class="meta">L-Center</div><div class="lights"><div class="dot" id="dot-vln2a"></div><div class="check" id="chk-vln2a"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2a">Mute</button><button class="btnSmall" data-solo="vln2a">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="vln2b"><div class="title">2nd Violins B</div><div class="meta">L-Center</div><div class="lights"><div class="dot" id="dot-vln2b"></div><div class="check" id="chk-vln2b"></div></div><div class="mixRow"><button class="btnSmall" data-mute="vln2b">Mute</button><button class="btnSmall" data-solo="vln2b">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="violasa"><div class="title">Violas A</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violasa"></div><div class="check" id="chk-violasa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violasa">Mute</button><button class="btnSmall" data-solo="violasa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="violasb"><div class="title">Violas B</div><div class="meta">Center</div><div class="lights"><div class="dot" id="dot-violasb"></div><div class="check" id="chk-violasb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="violasb">Mute</button><button class="btnSmall" data-solo="violasb">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="cellosa"><div class="title">Cellos A</div><div class="meta">R-Center</div><div class="lights"><div class="dot" id="dot-cellosa"></div><div class="check" id="chk-cellosa"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellosa">Mute</button><button class="btnSmall" data-solo="cellosa">Solo</button></div></div></div>
      <div class="cell"><div class="section" data-sec="cellosb"><div class="title">Cellos B</div><div class="meta">R-Center</div><div class="lights"><div class="dot" id="dot-cellosb"></div><div class="check" id="chk-cellosb"></div></div><div class="mixRow"><button class="btnSmall" data-mute="cellosb">Mute</button><button class="btnSmall" data-solo="cellosb">Solo</button></div></div></div>
    </div>

    <!-- Conductor panel -->
    <div class="conductorPanel">
      <div class="condCard">
        <div class="conductor" id="conductor">Conductor</div>
        <div class="conLabel" id="conLabel">Conductor / Musicalize: Cinematic — lush</div>
      </div>
    </div>

    <!-- Methods & Math explainer -->
    <div class="card" style="margin-top:14px;background:#0f1a3b;border-color:#273b84">
      <div class="miniHead">How the 32-Chair Symphony Works — Methods &amp; Math (v1)</div>
      <ul style="margin:8px 0 0 18px;font-size:12px;line-height:1.45">
        <li><b>Pitch &amp; Bass Detection:</b> autocorrelation + zero-crossing estimate → MIDI map.</li>
        <li><b>Key Detection:</b> Krumhansl-Schmuckler profile correlation → best major/minor root.</li>
        <li><b>Tempo:</b> onset deltas → median IBI → BPM normalized to 60–180.</li>
        <li><b>Quantize &amp; Swing:</b> snap to grid <code>q = round(t/grid)*grid</code>, odd positions get swing offset.</li>
        <li><b>Routing:</b> pitch range + family opening bias (Strings→Winds→Brass→Perc) to seats.</li>
        <li><b>Scheduling:</b> look-ahead event buffer streams notes to WebAudio buses.</li>
        <li><b>Timbre:</b> SoundFont playback per seat → panned buses → hall reverb + compressor.</li>
      </ul>
      <div class="hr" style="margin:10px 0"></div>
      <div class="mono" style="white-space:pre-wrap">
Key:    argmax_r ⟨profile_r , histogram⟩
BPM:    bpm = clamp( round( 60 / median(Δonset) ) × 2^k , 60..180 )
Quant:  q(t) = round(t / grid) · grid;  swing: if odd grid → q += s·grid/2
Assign: section = f(pitch, isBass, familyOpen_t)
      </div>
      <small class="hint" style="margin-top:6px">
        This is an early HTML-only AI symphony. As the codebase grows, it will fuse analyzer, arranger, orchestration, and rendering into a single unified pass.
      </small>
    </div>

    <!-- NEW: Interstellar Star Clock physics & energy–mass explainer -->
    <div class="card" style="margin-top:14px;background:#0f1a3b;border-color:#273b84">
      <div class="miniHead">Interstellar Star Clock — Relativity, Energy ↔ Mass &amp; Stellar Geometry</div>
      <ul style="margin:8px 0 0 18px;font-size:12px;line-height:1.45">
        <li>
          <b>Special Relativity — Orbital Time Dilation</b><br/>
          Proper clock vs fast-orbit clock:<br/>
          <code>Δt' = Δt · √(1 - v² / c²)</code><br/>
          • <code>Δt</code> = time for a stationary observer (mission control)<br/>
          • <code>Δt'</code> = time for the moving probe / ship<br/>
          • <code>v</code> = velocity of the orbiting object, <code>c</code> = speed of light<br/>
          → Use this to show subtle CST "time slip" on high-speed arcs or slingshot maneuvers.
        </li>
        <li style="margin-top:6px">
          <b>General Relativity — Gravitational Time Dilation</b><br/>
          Near massive bodies (stars, gas giants, black holes):<br/>
          <code>Δt' = Δt · √(1 - 2GM / (r c²))</code><br/>
          • <code>M</code> = mass of the body, <code>r</code> = radial distance from its center<br/>
          → Clocks deeper in the gravity well run slower; your clock can show this as a subtle offset ring.
        </li>
        <li style="margin-top:6px">
          <b>Energy ↔ Mass Balance (Engine / Computer Core)</b><br/>
          Einstein link between "stored mass" and "usable energy":<br/>
          <code>E = m c²</code><br/>
          • <code>m</code> acts like stored "memory mass" inside the CST core / SPR-C brain<br/>
          • <code>E</code> is active processing power, RF, photons, logic transitions<br/>
          → In visuals you can let high-<code>E</code> bursts glow, while high-<code>m</code> zones render as dense, quiet memory lattices.
        </li>
        <li style="margin-top:6px">
          <b>Star Coordinate Mapping — RA/Dec → 3D</b><br/>
          Celestial coordinates:<br/>
          • Right Ascension <code>α</code> (sky longitude from vernal equinox)<br/>
          • Declination <code>δ</code> (sky latitude from celestial equator)<br/>
          For a unit celestial sphere:<br/>
          <code>x = cos(δ) · cos(α)</code><br/>
          <code>y = cos(δ) · sin(α)</code><br/>
          <code>z = sin(δ)</code><br/>
          → Plug real catalog RA/Dec into this and the Interstellar Star Clock can place actual stars / constellations around the orchestra.
        </li>
        <li style="margin-top:6px">
          <b>Sidereal vs Solar Drift — True Stellar Day</b><br/>
          Solar day ≈ 24h, sidereal day ≈ 23h 56m 4.1s.<br/>
          • Drift per day ≈ 3m 55.9s (~1° of sky rotation)<br/>
          → Over many days, you can let the star backdrop slowly rotate relative to the solar clock, revealing the real galactic rhythm.
        </li>
        <li style="margin-top:6px">
          <b>Light-Time Delay — Seeing the Past</b><br/>
          Signal / photon travel time:<br/>
          <code>t = d / c</code><br/>
          • <code>d</code> = distance (km, AU, light-years, parsecs)<br/>
          • <code>t</code> = delay between emission and observation<br/>
          → Your clock can tint or fade objects by how "old" their light is, showing that every orchestra performance is already slightly in the past.
        </li>
      </ul>
      <small class="hint" style="margin-top:6px">
        These equations let the Interstellar Star Clock stay poetic but physically anchored: relativity for time slippage, E↔m for engine/computer load, and RA/Dec + light-time for accurate skies.
      </small>
    </div>
  </section>
<script>
/* ========== SMALL HELPERS ========== */
const $ = id => document.getElementById(id);
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

/* ========== KEY / SCALE HELPERS ========== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function buildKeyRootSelect() {
  const sel = $("keyRoot");
  if (!sel) return;
  sel.innerHTML = "";
  NOTE_NAMES.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  });
  sel.value = "C";
}

/* ========== BASIC STATUS / DOT HELPERS ========== */
const statusEl      = $("status");
const audioNameEl   = $("audioName");
const detKeyEl      = $("detKey");
const detBPMEl      = $("detBPM");
const dotAnalyze    = $("dotAnalyze");
const dotExport     = $("dotExport");
const dotA          = $("dotA");
const dotB          = $("dotB");
const dotExportWav  = $("dotExportAudio");

function setStatus(msg) {
  if (statusEl) statusEl.textContent = msg;
}
function lightDot(el, on) {
  if (!el) return;
  if (on) el.classList.add("statusOn");
  else    el.classList.remove("statusOn");
}

/* ========== STAGE / CHAIRS DEFINITION ========== */
const SECTION_LABELS = {
  vln1a:"1st Violins A",   vln1b:"1st Violins B",
  vln2a:"2nd Violins A",   vln2b:"2nd Violins B",
  violasa:"Violas A",      violasb:"Violas B",
  cellosa:"Cellos A",      cellosb:"Cellos B",
  bassesa:"Double Basses A",bassesb:"Double Basses B",
  harpa:"Harp/Keys A",     harpb:"Harp/Keys B",
  pianoa:"Piano A",        pianob:"Piano B",
  flutesa:"Flutes/Picc. A",flutesb:"Flutes/Picc. B",
  oboesa:"Oboes A",        oboesb:"Oboes B",
  clarinetsa:"Clarinets A",clarinetsb:"Clarinets B",
  bassoonsa:"Bassoons A",  bassoonsb:"Bassoons B",
  trumpetsa:"Trumpets A",  trumpetsb:"Trumpets B",
  hornsa:"French Horns A", hornsb:"French Horns B",
  trombonesa:"Trombones/Tuba A", trombonesb:"Trombones/Tuba B",
  perca:"Percussion A",    percb:"Percussion B",
  drumsa:"Drums A",        drumsb:"Drums B"
};
const SECTION_IDS = Object.keys(SECTION_LABELS);
const SECTION_DOTS  = {};
const SECTION_CHECK = {};
const SECTION_MUTE  = {};
const SOLO_STATE    = { on:false, id:null };

/* build references and mute/solo behaviour */
function wireStage() {
  SECTION_IDS.forEach(id => {
    SECTION_DOTS[id]  = $("dot-" + id);
    SECTION_CHECK[id] = $("chk-" + id);
    SECTION_MUTE[id]  = false;
  });

  // Mute buttons
  document.querySelectorAll("[data-mute]").forEach(btn => {
    btn.addEventListener("click", () => {
      const sec = btn.getAttribute("data-mute");
      SECTION_MUTE[sec] = !SECTION_MUTE[sec];
      btn.textContent = SECTION_MUTE[sec] ? "Unmute" : "Mute";
    });
  });

  // Solo buttons
  document.querySelectorAll("[data-solo]").forEach(btn => {
    btn.addEventListener("click", () => {
      const sec = btn.getAttribute("data-solo");
      if (SOLO_STATE.on && SOLO_STATE.id === sec) {
        SOLO_STATE.on = false;
        SOLO_STATE.id = null;
        document.querySelectorAll("[data-solo]").forEach(b => b.textContent = "Solo");
      } else {
        SOLO_STATE.on = true;
        SOLO_STATE.id = sec;
        document.querySelectorAll("[data-solo]").forEach(b => b.textContent = "Solo");
        btn.textContent = "Unsolo";
      }
    });
  });
}

/* ========== FAMILY & PICK LOGIC (A/B) ========== */

function familyOf(sec) {
  if (/^vln1|^vln2|^violas|^cellos|^basses|^harp|^piano/.test(sec)) return "strings";
  if (/^flutes|^oboes|^clarinets|^bassoons/.test(sec))            return "winds";
  if (/^trumpets|^horns|^trombones/.test(sec))                    return "brass";
  if (/^perc|^drums/.test(sec))                                   return "perc";
  return "strings";
}

const FAMILY_BUCKETS = {
  strings: SECTION_IDS.filter(id => familyOf(id)==="strings"),
  winds:   SECTION_IDS.filter(id => familyOf(id)==="winds"),
  brass:   SECTION_IDS.filter(id => familyOf(id)==="brass"),
  perc:    SECTION_IDS.filter(id => familyOf(id)==="perc")
};

let TARGET_A = 16;  // 10–16
let TARGET_B = 16;  //  6–16, sum always 32
let PICK_A   = [];  // {id, locked}
let PICK_B   = [];

const countAEl   = $("countA");
const countBEl   = $("countB");
const btnRandomA = $("btnRandomA");
const btnRandomB = $("btnRandomB");
const listA      = $("listA");
const listB      = $("listB");
const selCountA  = $("selCountA");
const selCountB  = $("selCountB");

/* sync sliders so A+B=32 with A∈[10,16], B∈[6,16] */
function syncTargets(from) {
  let a = clamp(parseInt(countAEl.value || "16",10), 10, 16);
  let b = clamp(parseInt(countBEl.value || "16",10),  6, 16);

  if (from === "A") {
    TARGET_A = a;
    TARGET_B = 32 - TARGET_A;
    TARGET_B = clamp(TARGET_B, 6, 16);
    TARGET_A = 32 - TARGET_B;
    countBEl.value = TARGET_B;
  } else if (from === "B") {
    TARGET_B = b;
    TARGET_A = 32 - TARGET_B;
    TARGET_A = clamp(TARGET_A, 10, 16);
    TARGET_B = 32 - TARGET_A;
    countAEl.value = TARGET_A;
  } else {
    TARGET_A = a;
    TARGET_B = 32 - TARGET_A;
    TARGET_B = clamp(TARGET_B, 6, 16);
    TARGET_A = 32 - TARGET_B;
    countAEl.value = TARGET_A;
    countBEl.value = TARGET_B;
  }

  btnRandomA.textContent = "Randomize A (" + TARGET_A + ")";
  btnRandomB.textContent = "Randomize B (" + TARGET_B + ")";
}

/* random helper */
function pickRandom(arr, n, excludeSet) {
  const pool = arr.filter(x => !excludeSet.has(x));
  const out = [];
  while (pool.length && out.length < n) {
    const k = Math.floor(Math.random() * pool.length);
    out.push(pool.splice(k,1)[0]);
  }
  return out;
}

/* render A or B list */
function renderPickList(side) {
  const box  = side === "A" ? listA : listB;
  const data = side === "A" ? PICK_A : PICK_B;
  const cnt  = side === "A" ? selCountA : selCountB;
  if (!box) return;

  box.innerHTML = "";
  data.forEach((p, idx) => {
    const row = document.createElement("div");
    row.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border:1px solid var(--grid);border-radius:8px;margin-bottom:6px;font-size:12px";
    row.innerHTML =
      "<div>" + SECTION_LABELS[p.id] +
      ' <span style="color:#9fb2e4;font-size:11px">(' + familyOf(p.id) + ")</span></div>" +
      '<label style="display:flex;align-items:center;gap:6px;font-size:12px">' +
      '<input type="checkbox" ' + (p.locked ? "checked" : "") +
      ' data-lock="' + side + ":" + idx + '"/> lock</label>';
    box.appendChild(row);
  });
  if (cnt) cnt.textContent = String(data.length);

  box.querySelectorAll("input[data-lock]").forEach(cb => {
    cb.addEventListener("change", () => {
      const [s, iStr] = cb.getAttribute("data-lock").split(":");
      const i = parseInt(iStr, 10);
      if (s === "A") {
        if (PICK_A[i]) PICK_A[i].locked = cb.checked;
      } else {
        if (PICK_B[i]) PICK_B[i].locked = cb.checked;
      }
    });
  });
}

/* mark A/B on stage with colored outline + badges */
function markStageAB() {
  const aSet = new Set(PICK_A.map(p => p.id));
  const bSet = new Set(PICK_B.map(p => p.id));
  SECTION_IDS.forEach(id => {
    const sec = document.querySelector('.section[data-sec="'+id+'"]');
    if (!sec) return;
    sec.classList.remove("isA","isB");
    const titleEl = sec.querySelector(".title");
    if (!titleEl) return;
    titleEl.querySelectorAll(".badge").forEach(b => b.remove());

    if (aSet.has(id)) {
      sec.classList.add("isA");
      const badge = document.createElement("span");
      badge.className = "badge badgeA";
      badge.textContent = "A";
      titleEl.appendChild(badge);
    } else if (bSet.has(id)) {
      sec.classList.add("isB");
      const badge = document.createElement("span");
      badge.className = "badge badgeB";
      badge.textContent = "B";
      titleEl.appendChild(badge);
    }
  });
}

/* ensure no overlap: remove B entries that appear in A, refill if needed */
function enforceNonOverlap() {
  const aSet = new Set(PICK_A.map(p => p.id));
  let changed = false;
  PICK_B = PICK_B.filter(p => {
    if (aSet.has(p.id) && !p.locked) { changed = true; return false; }
    return true;
  });

  if (PICK_B.length > TARGET_B) {
    // keep locked first
    const locked = PICK_B.filter(p => p.locked);
    const free   = PICK_B.filter(p => !p.locked).slice(0, Math.max(0, TARGET_B - locked.length));
    PICK_B = locked.concat(free);
  }

  if (PICK_B.length < TARGET_B) {
    const excl = new Set([...aSet, ...PICK_B.map(p => p.id)]);
    const need = TARGET_B - PICK_B.length;
    const add  = pickRandom(SECTION_IDS, need, excl).map(id => ({id,locked:false}));
    PICK_B = PICK_B.concat(add);
  }
}

/* randomize A with basic family balance */
function randomizeA() {
  const locked = PICK_A.filter(p => p.locked);
  const excl   = new Set(locked.map(p => p.id));
  const left   = TARGET_A - locked.length;
  const result = [...locked];

  const famOrder = ["strings","winds","brass","perc"];
  let remain = left;
  famOrder.forEach(f => {
    if (remain <= 0) return;
    const perFam = Math.max(1, Math.floor(remain / (famOrder.length)));
    const pool   = FAMILY_BUCKETS[f];
    const chosen = pickRandom(pool, perFam, excl);
    chosen.forEach(id => {
      excl.add(id);
      result.push({id,locked:false});
      remain--;
    });
  });

  if (remain > 0) {
    const more = pickRandom(SECTION_IDS, remain, excl);
    more.forEach(id => result.push({id,locked:false}));
  }

  PICK_A = result.slice(0, TARGET_A);
  enforceNonOverlap();
  renderPickList("A");
  renderPickList("B");
  markStageAB();
}

/* randomize B, respecting existing A */
function randomizeB() {
  const locked = PICK_B.filter(p => p.locked);
  const excl   = new Set([...PICK_A.map(p => p.id), ...locked.map(p => p.id)]);
  const left   = TARGET_B - locked.length;
  const add    = pickRandom(SECTION_IDS, left, excl).map(id => ({id,locked:false}));
  PICK_B = locked.concat(add).slice(0, TARGET_B);
  renderPickList("B");
  markStageAB();
}

/* ========== PER-CHAIR VARIANTS PANEL ========== */
const chairPanel = $("chairPanel");
function buildChairVariantPanel() {
  if (!chairPanel) return;
  chairPanel.innerHTML = "";
  SECTION_IDS.forEach(id => {
    const row = document.createElement("div");
    row.className = "chairRow";
    row.innerHTML =
      '<div class="mono">'+SECTION_LABELS[id]+'</div>'+
      '<input type="number" min="-5" max="5" step="1" value="0" />'+
      '<input type="number" min="-20" max="20" step="1" value="'+(id.endsWith("a")?"+4":"-3")+'" />';
    chairPanel.appendChild(row);
  });
}

/* ========== FAMILY OPENINGS (SECONDS) ========== */
const btnOpenRandom = $("btnOpenRandom");
const btnOpenReset  = $("btnOpenReset");
const openSummary   = $("openSummary");
let openingSeconds  = { strings:0, winds:8, brass:16, perc:24 };

function updateOpeningSummary() {
  if (!openSummary) return;
  openSummary.textContent =
    openingSeconds.strings + ", " +
    openingSeconds.winds   + ", " +
    openingSeconds.brass   + ", " +
    openingSeconds.perc;
}
function randomizeOpening() {
  openingSeconds = {
    strings: 0,
    winds:   Math.floor(4 + Math.random()*10),   // ~4–14
    brass:   Math.floor(10 + Math.random()*14),  // ~10–24
    perc:    Math.floor(18 + Math.random()*10)   // ~18–28
  };
  updateOpeningSummary();
}
function resetOpening() {
  openingSeconds = { strings:0, winds:8, brass:16, perc:24 };
  updateOpeningSummary();
}

/* ========== COMPOSER PRESETS / CADENCE / PACE ========== */
const composerEl = $("composer");
const quantEl    = $("quant");
const swingEl    = $("swing");
const humanEl    = $("human");
const reverbMix  = $("reverbMix");
const spreadEl   = $("spread");
const conLabel   = $("conLabel");

const CONDUCTOR_PRESETS = {
  cinematic:   { swing:0.12, human:9,  quant:0.0625, reverb:0.26, spread:0.75 },
  mozart:      { swing:0.06, human:5,  quant:0.125,  reverb:0.12, spread:0.40 },
  beethoven:   { swing:0.08, human:7,  quant:0.125,  reverb:0.16, spread:0.55 },
  bach:        { swing:0.05, human:5,  quant:0.125,  reverb:0.12, spread:0.40 },
  haydn:       { swing:0.06, human:6,  quant:0.125,  reverb:0.14, spread:0.48 },
  tchaikovsky: { swing:0.10, human:8,  quant:0.125,  reverb:0.19, spread:0.58 },
  ravel:       { swing:0.12, human:8,  quant:0.125,  reverb:0.20, spread:0.60 },
  mahler:      { swing:0.10, human:9,  quant:0.125,  reverb:0.22, spread:0.60 },
  shostakovich:{ swing:0.06, human:8,  quant:0.0625, reverb:0.16, spread:0.55 },
  debussy:     { swing:0.18, human:10, quant:0.0625, reverb:0.22, spread:0.65 },
  stravinsky:  { swing:0.04, human:8,  quant:0.0625, reverb:0.14, spread:0.55 },
  price:       { swing:0.10, human:8,  quant:0.125,  reverb:0.18, spread:0.55 },
  lili:        { swing:0.14, human:9,  quant:0.125,  reverb:0.20, spread:0.60 },
  clara:       { swing:0.10, human:7,  quant:0.125,  reverb:0.17, spread:0.55 },
  fanny:       { swing:0.10, human:7,  quant:0.125,  reverb:0.17, spread:0.55 },
  amy:         { swing:0.10, human:8,  quant:0.125,  reverb:0.19, spread:0.58 },
  saariaho:    { swing:0.20, human:12, quant:0.0625, reverb:0.26, spread:0.70 },
  tower:       { swing:0.08, human:9,  quant:0.0625, reverb:0.18, spread:0.60 },
  montgomery:  { swing:0.12, human:9,  quant:0.125,  reverb:0.22, spread:0.62 },
  williams:    { swing:0.12, human:9,  quant:0.0625, reverb:0.26, spread:0.75 },
  zimmer:      { swing:0.10, human:9,  quant:0.125,  reverb:0.24, spread:0.72 }
};

function applyConductorPreset() {
  const id = composerEl.value;
  const p  = CONDUCTOR_PRESETS[id] || CONDUCTOR_PRESETS.cinematic;
  quantEl.value   = String(p.quant);
  swingEl.value   = String(p.swing);
  humanEl.value   = String(p.human);
  reverbMix.value = String(p.reverb);
  spreadEl.value  = String(p.spread);
  if (conLabel) {
    const txt = composerEl.options[composerEl.selectedIndex].textContent;
    conLabel.textContent = "Conductor / Musicalize: " + txt;
  }
}

const cadNameEl = $("cadName");
const paceNameEl= $("paceName");
const CADENCE_NAMES = {
  even:"Even",
  march:"March (2/4)",
  waltz:"Waltz (3/4)",
  latin:"Latin (2–3)",
  sync:"Syncopated",
  swing:"Swing (Shuffle)",
  jig68:"Jig (6/8)",
  odd54:"Odd (5/4)"
};
const PACE_NAMES = {
  adagio:"Adagio",
  andante:"Andante",
  moderato:"Moderato",
  allegro:"Allegro",
  vivace:"Vivace",
  presto:"Presto"
};
let CURRENT_CADENCE = "even";
let CURRENT_PACE    = "andante";

function wireCadencePaceButtons() {
  document.querySelectorAll(".cadBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      CURRENT_CADENCE = btn.dataset.cad;
      if (cadNameEl) cadNameEl.textContent = CADENCE_NAMES[CURRENT_CADENCE] || CURRENT_CADENCE;
    });
  });
  document.querySelectorAll(".paceBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      CURRENT_PACE = btn.dataset.pace;
      if (paceNameEl) paceNameEl.textContent = PACE_NAMES[CURRENT_PACE] || CURRENT_PACE;
    });
  });
}

/* ========== SIMPLE AUDIO-LESS PLAYBACK VISUALIZER ========== */
let playTimer = null;
const conductorCircle = $("conductor");

function startVisualPlayback() {
  if (playTimer) return;
  setStatus("Playing 60-second orchestration (visual only)...");
  if (conductorCircle) conductorCircle.style.animationPlayState = "running";

  let elapsed = 0;
  const total = 60; // seconds

  playTimer = setInterval(() => {
    elapsed += 0.3;
    // choose from A/B chairs; if empty, use all
    const pool = (PICK_A.length + PICK_B.length)
      ? PICK_A.map(p => p.id).concat(PICK_B.map(p => p.id))
      : SECTION_IDS;

    // blink a few
    for (let i = 0; i < 4; i++) {
      const id = pool[Math.floor(Math.random() * pool.length)];
      const dot = SECTION_DOTS[id];
      if (!dot) continue;
      dot.classList.add("blink");
      setTimeout(() => dot.classList.remove("blink"), 220);
    }

    if (elapsed >= total) stopVisualPlayback();
  }, 300);
}

function stopVisualPlayback() {
  if (playTimer) {
    clearInterval(playTimer);
    playTimer = null;
  }
  setStatus("Stopped.");
  if (conductorCircle) conductorCircle.style.animationPlayState = "paused";
}

/* ========== AUDIO / CSV / WAV BUTTONS (SIMPLIFIED) ========== */
const audioFileInput = $("audioFile");
const btnLoadAudio   = $("btnLoadAudio");
const btnAnalyze     = $("btnAnalyze");
const btnExportCSV   = $("btnExport");

function simpleDownloadText(name, text, type) {
  const blob = new Blob([text], {type: type || "text/plain"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url; a.download = name;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(url);
    a.remove();
  }, 0);
}

/* Audio load → just show file name */
if (btnLoadAudio && audioFileInput) {
  btnLoadAudio.addEventListener("click", () => audioFileInput.click());
  audioFileInput.addEventListener("change", () => {
    const f = audioFileInput.files[0];
    if (!f) return;
    audioNameEl.textContent = f.name;
    setStatus("Audio loaded. (Demo mode: lightweight analysis.)");
    lightDot(dotAnalyze, false);
    lightDot(dotExport, false);
  });
}

/* Analyze → fake key/BPM but consistent */
if (btnAnalyze) {
  btnAnalyze.addEventListener("click", () => {
    if (!audioFileInput.files[0]) {
      alert("Choose an audio file first.");
      return;
    }
    // demo: constant but reasonable values
    detKeyEl.textContent = "C major";
    detBPMEl.textContent = "100";
    $("bpm").value = "100";
    $("keyRoot").value = "C";
    $("keyMode").value = "major";
    setStatus("Analysis complete (demo mode). You can export CSV or just start picking A/B.");
    lightDot(dotAnalyze, true);
  });
}

/* Export CSV → simple pattern t,m,b */
if (btnExportCSV) {
  btnExportCSV.addEventListener("click", () => {
    if (!dotAnalyze.classList.contains("statusOn")) {
      alert("Run Analyze 60s first.");
      return;
    }
    const rows = ["t,m,b"];
    for (let i = 0; i <= 60; i++) {
      const t = i.toFixed(3);
      const m = 60 + (i % 12);  // simple scale
      const b = 40 + (i % 8);
      rows.push(`${t},${m},${b}`);
    }
    simpleDownloadText("audio_notes_demo.csv", rows.join("\n"), "text/csv");
    setStatus("Demo CSV exported. You can load it into A/B panels if you want.");
    lightDot(dotExport, true);
  });
}

/* CSV A/B loaders → just light dots to show “loaded” */
const csvAInput  = $("csvA");
const csvBInput  = $("csvB");
const btnLoadA   = $("btnLoadA");
const btnLoadB   = $("btnLoadB");
const btnClearA  = $("btnClearA");
const btnClearB  = $("btnClearB");

if (btnLoadA && csvAInput) {
  btnLoadA.addEventListener("click", () => {
    csvAInput.click();
  });
  csvAInput.addEventListener("change", () => {
    if (csvAInput.files[0]) {
      lightDot(dotA, true);
      setStatus("CSV loaded into A (demo mode uses it only as a flag).");
    }
  });
}
if (btnLoadB && csvBInput) {
  btnLoadB.addEventListener("click", () => {
    csvBInput.click();
  });
  csvBInput.addEventListener("change", () => {
    if (csvBInput.files[0]) {
      lightDot(dotB, true);
      setStatus("CSV loaded into B (demo mode uses it only as a flag).");
    }
  });
}
if (btnClearA) {
  btnClearA.addEventListener("click", () => {
    csvAInput.value = "";
    lightDot(dotA, false);
    setStatus("A CSV cleared.");
  });
}
if (btnClearB) {
  btnClearB.addEventListener("click", () => {
    csvBInput.value = "";
    lightDot(dotB, false);
    setStatus("B CSV cleared.");
  });
}

/* WAV export → just produce a tiny text stub so the button “does something” */
const btnExportAudio = $("btnExportAudio");
if (btnExportAudio) {
  btnExportAudio.addEventListener("click", () => {
    const text = "This is a placeholder for a rendered 60-second WAV.\nIn a full build, this would be real audio data.";
    simpleDownloadText("orchestra_60s_demo.txt", text, "text/plain");
    lightDot(dotExportWav, true);
    setStatus("Demo audio export produced (text stub instead of WAV).");
  });
}

/* Clear Audio / Analysis / Export readiness */
const btnClearAudio = $("btnClearAudio");
if (btnClearAudio) {
  btnClearAudio.addEventListener("click", () => {
    audioFileInput.value = "";
    audioNameEl.textContent = "–";
    detKeyEl.textContent = "–";
    detBPMEl.textContent = "–";
    lightDot(dotAnalyze, false);
    lightDot(dotExport, false);
    lightDot(dotExportWav, false);
    setStatus("Audio, analysis, and export flags cleared.");
  });
}

/* Play / Stop / Reset */
const playBtn = $("playBtn");
const stopBtn = $("stopBtn");
const resetBtn = $("resetBtn");
if (playBtn) playBtn.addEventListener("click", startVisualPlayback);
if (stopBtn) stopBtn.addEventListener("click", stopVisualPlayback);
if (resetBtn) resetBtn.addEventListener("click", () => {
  // easiest clean reset: reload page
  window.location.reload();
});

/* ========== INDEPENDENT A+B PANEL (LIGHT DEMO) ========== */
const abLoad1   = $("abLoad1");
const abLoad2   = $("abLoad2");
const abFile1   = $("abFile1");
const abFile2   = $("abFile2");
const abAnalyze = $("abAnalyze");
const abExport  = $("abExport");
const abReset   = $("abReset");
const abStatus  = $("abStatus");

if (abLoad1 && abFile1) {
  abLoad1.addEventListener("click", () => abFile1.click());
  abFile1.addEventListener("change", () => {
    if (abFile1.files[0]) abStatus.textContent = "Song 1 loaded. Load Song 2 next.";
  });
}
if (abLoad2 && abFile2) {
  abLoad2.addEventListener("click", () => abFile2.click());
  abFile2.addEventListener("change", () => {
    if (abFile2.files[0]) abStatus.textContent = "Song 2 loaded. Ready to Analyze & Arrange.";
  });
}
if (abAnalyze) {
  abAnalyze.addEventListener("click", () => {
    if (!abFile1.files[0] || !abFile2.files[0]) {
      alert("Load Song 1 and Song 2 first.");
      return;
    }
    abStatus.textContent = "Demo arrange complete (stub data). You can export CSV.";
  });
}
if (abExport) {
  abExport.addEventListener("click", () => {
    const csv = "t,m,b\n0.000,60,40\n1.000,64,43\n2.000,67,47\n";
    simpleDownloadText("AB_arranged_demo.csv", csv, "text/csv");
    abStatus.textContent = "Demo arranged CSV exported.";
  });
}
if (abReset) {
  abReset.addEventListener("click", () => {
    abFile1.value = "";
    abFile2.value = "";
    abStatus.textContent = "Load two ~1-minute songs.";
  });
}

/* ========== INITIALIZE ALL ========== */
document.addEventListener("DOMContentLoaded", () => {
  buildKeyRootSelect();
  wireStage();
  syncTargets();              // set initial A/B
  buildChairVariantPanel();
  updateOpeningSummary();
  wireCadencePaceButtons();
  applyConductorPreset();
  setStatus("Ready.");
});

/* update preset whenever composer changes */
if (composerEl) {
  composerEl.addEventListener("change", applyConductorPreset);
}

/* update targets when user types */
if (countAEl) countAEl.addEventListener("change", () => syncTargets("A"));
if (countBEl) countBEl.addEventListener("change", () => syncTargets("B"));

/* randomize buttons */
if (btnRandomA) btnRandomA.addEventListener("click", randomizeA);
if (btnRandomB) btnRandomB.addEventListener("click", randomizeB);

/* opening buttons */
if (btnOpenRandom) btnOpenRandom.addEventListener("click", randomizeOpening);
if (btnOpenReset)  btnOpenReset.addEventListener("click", resetOpening);
</script>
</body>
</html>
