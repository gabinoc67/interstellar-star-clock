<!-- ======================= PART 1 / 3 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ice-Core + EarthScope (IRIS/NSF SAGE) Station Metadata ¬∑ Cosmic Clock</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#020617;
    --panel:rgba(15,23,42,0.96);
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --line:rgba(148,163,184,0.28);
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#fb7185;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

  header{
    padding:16px 24px;
    border-bottom:1px solid rgba(148,163,184,0.4);
    background: radial-gradient(circle at top left, #0ea5e9 0, #0f172a 45%, #000 100%);
  }
  header h1{ margin:0 0 4px; font-size:24px; letter-spacing:.04em; }
  header p{ margin:2px 0; font-size:13px; color:#bae6fd; }
  .muted{ color:var(--muted); }
  .mini{ font-size:11px; }

  .container{
    display:grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.6fr);
    gap:16px;
    padding:16px 20px 20px;
  }
  .panel{
    background: radial-gradient(circle at top, rgba(56,189,248,0.14), rgba(15,23,42,0.98));
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 45px rgba(15,23,42,0.9);
    padding:14px 16px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height: 540px;
  }
  .panel h2{
    margin:0;
    font-size:16px;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; }
  .controls label{ color:#bae6fd; font-size:12px; }
  select, input[type="text"], input[type="number"]{
    background: rgba(15,23,42,0.9);
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
    color:var(--ink);
    padding:4px 10px;
    font-size:12px;
    outline:none;
  }
  select:focus, input:focus{
    border-color: var(--accent);
    box-shadow:0 0 0 1px rgba(56,189,248,0.6);
  }
  .btn{
    border-radius:999px;
    padding:6px 10px;
    border:1px solid rgba(148,163,184,0.55);
    background: rgba(2,6,23,0.35);
    color: var(--ink);
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(56,189,248,0.75); }
  .btn.primary{ border-color: rgba(56,189,248,0.85); }

  .scroll{
    max-height: 380px;
    overflow:auto;
    margin:0 -6px -6px;
    padding:0 6px 1px;
  }
  table{ width:100%; border-collapse:collapse; margin-top:6px; font-size:12px; }
  thead{
    position:sticky;
    top:0;
    background: linear-gradient(to right, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
    z-index:1;
  }
  th, td{
    padding:6px 6px;
    text-align:left;
    border-bottom:1px solid rgba(15,118,110,0.55);
    vertical-align:top;
  }
  th{
    font-weight:700;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
  }
  tbody tr{ cursor:pointer; transition: background .1s ease, transform .08s ease; }
  tbody tr:hover{ background: rgba(56,189,248,0.16); transform: translateY(-0.5px); }
  tbody tr.active-row{
    background: radial-gradient(circle at left, rgba(56,189,248,0.32), rgba(15,23,42,0.95));
  }

  .tag{
    display:inline-flex;
    align-items:center;
    gap:5px;
    padding:1px 8px;
    border-radius:999px;
    font-size:10px;
    border:1px solid rgba(148,163,184,0.85);
    background: rgba(15,23,42,0.72);
    white-space:nowrap;
  }
  .tag-dot{ width:6px; height:6px; border-radius:999px; }
  .tag-ice .tag-dot{ background:#38bdf8; }
  .tag-hum .tag-dot{ background:#22c55e; }
  .tag-scale-global .tag-dot{ background:#f97316; }
  .tag-scale-hemisphere .tag-dot{ background:#22c55e; }
  .tag-scale-regional .tag-dot{ background:#e5e7eb; }

  .coords{ font-family:var(--mono); font-size:11px; color:#bae6fd; }
  .plot-wrap{
    border:1px solid rgba(148,163,184,0.28);
    border-radius:14px;
    padding:10px;
    background: rgba(2,6,23,0.25);
  }
  canvas{ width:100%; height:220px; display:block; }
  .kv{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    font-size:12px;
  }
  .k{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.22);
  }
  .k b{ display:block; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:4px; }
  .k .v{ font-family:var(--mono); font-size:12px; }

  .status{
    padding:8px 10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.22);
    font-size:12px;
  }
  .status.ok{ border-color: rgba(34,197,94,0.55); }
  .status.warn{ border-color: rgba(245,158,11,0.55); }
  .status.bad{ border-color: rgba(251,113,133,0.55); }

  @media (max-width: 980px){
    .container{ grid-template-columns: minmax(0, 1fr); }
    .panel{ min-height: unset; }
    .scroll{ max-height: 280px; }
    canvas{ height: 200px; }
  }
</style>
</head>
<body>
<header>
  <h1>Ice-Core + Station Metadata (EarthScope / IRIS / NSF SAGE)</h1>
  <p>Left table merges: (A) ice-core climate pulses + (B) real station metadata you load from the FDSN Station service (net/sta wildcards, lat/lon, start/end).</p>
  <p class="muted mini">Note: this loads station metadata live (internet required). If the request is blocked by CORS on your browser, use the ‚ÄúPaste Station Text‚Äù box (offline import).</p>
</header>

<div class="container">
  <section class="panel">
    <h2>üßä + üåä Unified Timeline Items</h2>

    <div class="controls">
      <label>Category:
        <select id="catFilter">
          <option value="all">All</option>
          <option value="ice">Ice-core events</option>
          <option value="hum">Stations (metadata)</option>
        </select>
      </label>

      <label>Search:
        <input type="text" id="searchBox" placeholder="event name, IU, ANMO, site name‚Ä¶" />
      </label>

      <label>Sort:
        <select id="sortMode">
          <option value="olderFirst" selected>Older first (BP)</option>
          <option value="newerFirst">Newer first (BP)</option>
          <option value="name">Name</option>
        </select>
      </label>
    </div>

    <div class="controls" style="margin-top:2px;">
      <span class="tag tag-ice"><span class="tag-dot"></span><span>Ice-core</span></span>
      <span class="tag tag-hum"><span class="tag-dot"></span><span>Station</span></span>
      <span class="tag tag-scale-global"><span class="tag-dot"></span><span>Global</span></span>
      <span class="tag tag-scale-hemisphere"><span class="tag-dot"></span><span>Hemisphere</span></span>
      <span class="tag tag-scale-regional"><span class="tag-dot"></span><span>Regional</span></span>
    </div>

    <div class="scroll">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Kind</th>
            <th>Scale</th>
            <th>Core / Net.Sta</th>
            <th>Lat</th>
            <th>Age / Date</th>
          </tr>
        </thead>
        <tbody id="eventTableBody"></tbody>
      </table>
    </div>

    <div class="muted mini">
      Tip: click a row ‚Üí right panel shows details + plot. For station rows, ‚ÄúAge/Date‚Äù is station start/end; the plot still shows your climate+hum proxy sandbox.
    </div>
  </section>
<!-- ======================= PART 2 / 3 ======================= -->
  <section class="panel">
    <h2>üß≠ Load Real Station Metadata + Plot</h2>

    <div class="status warn" id="statusBox">
      Status: No stations loaded yet. Use the loader below (online) or paste text output (offline).
    </div>

    <div class="controls">
      <label>Service base:
        <select id="serviceBase">
          <option value="https://service.earthscope.org/fdsnws/station/1/query" selected>EarthScope (recommended)</option>
          <option value="https://service.iris.edu/fdsnws/station/1/query">Legacy IRIS (may still work)</option>
        </select>
      </label>

      <label>net:
        <input type="text" id="netCode" value="IU" style="width:70px" />
      </label>

      <label>sta:
        <input type="text" id="staCode" value="ANMO" style="width:90px" />
      </label>

      <label>level:
        <select id="levelMode">
          <option value="station" selected>station</option>
          <option value="channel">channel (bigger)</option>
        </select>
      </label>

      <button class="btn primary" id="btnLoadStations">Load Stations</button>
      <button class="btn" id="btnClearStations">Clear Stations</button>
    </div>

    <div class="controls">
      <label>Optional time filter (ISO date):
        <input type="text" id="startTime" placeholder="starttime (e.g., 2010-01-01)" style="width:180px" />
      </label>
      <label>
        <input type="text" id="endTime" placeholder="endtime (e.g., 2020-12-31)" style="width:180px" />
      </label>
      <label>Limit:
        <input type="number" id="limit" value="200" min="1" max="20000" step="50" style="width:90px" />
      </label>
    </div>

    <div class="controls" style="gap:10px;">
      <label>Offline import:
        <button class="btn" id="btnPasteToggle">Paste Station Text</button>
      </label>
      <button class="btn" id="btnUseExample">Use Example Stations</button>
    </div>

    <div id="pasteWrap" style="display:none;">
      <div class="muted mini" style="margin:6px 0 4px;">
        Paste the <b>format=text</b> output from the station service here (lines beginning with ‚Äú#‚Äù are OK). Then click ‚ÄúImport‚Äù.
      </div>
      <textarea id="pasteBox" style="width:100%; min-height:120px; border-radius:14px; padding:10px; background:rgba(15,23,42,0.85); color:var(--ink); border:1px solid rgba(148,163,184,0.5); font-family:var(--mono); font-size:11px; outline:none;"></textarea>
      <div class="controls" style="margin-top:8px;">
        <button class="btn primary" id="btnImportPasted">Import Pasted Text</button>
      </div>
    </div>

    <div class="controls" style="margin-top:8px;">
      <label>Plot window (years BP):
        <input type="number" id="winStart" value="14000" min="0" step="100" style="width:110px" />
        ‚Üí
        <input type="number" id="winEnd" value="0" min="-200" step="10" style="width:110px" />
      </label>

      <label>Hum proxy mode:
        <select id="humMode">
          <option value="climate" selected>Climate-linked (toy)</option>
          <option value="storms">Storm/microseism (toy)</option>
          <option value="flat">Constant (control)</option>
        </select>
      </label>

      <label>Coupling:
        <select id="humCoupling">
          <option value="low">Low</option>
          <option value="med" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </label>

      <button class="btn primary" id="btnRecompute">Recompute Plot</button>
      <button class="btn" id="btnExport">Export plot CSV</button>
    </div>

    <div class="plot-wrap">
      <canvas id="plot"></canvas>
      <div class="muted mini" id="plotNote" style="margin-top:6px;">
        Plot shows two synthetic series across the window: CO‚ÇÇ proxy (ice anchors) + hum amplitude proxy (toy).
      </div>
    </div>

    <div class="kv">
      <div class="k"><b>Selected</b><div class="v" id="selName">‚Äî</div></div>
      <div class="k"><b>Selected age/date</b><div class="v" id="selAge">‚Äî</div></div>
      <div class="k"><b>Latitude band</b><div class="v" id="selBand">‚Äî</div></div>
      <div class="k"><b>Core / Net.Sta</b><div class="v" id="selSite">‚Äî</div></div>
    </div>

    <div id="detailsContent" style="margin-top:8px;">
      <p class="muted">Select an item on the left to see details.</p>
    </div>

  </section>
</div>

<script>
  // ================= Helpers =================
  const $ = (id)=>document.getElementById(id);
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function lerp(a,b,t){ return a + (b-a)*t; }

  function latBand(lat){
    const a = Math.abs(lat);
    if (a < 10) return "Equatorial (0‚Äì10¬∞)";
    if (a < 23.5) return "Tropical (10‚Äì23.5¬∞)";
    if (a < 40) return "Subtropical (23.5‚Äì40¬∞)";
    if (a < 60) return "Mid-latitudes (40‚Äì60¬∞)";
    return "High-latitude / polar (60¬∞+)";
  }

  function bpMid(ageRangeBP){
    if (!ageRangeBP || ageRangeBP.length < 2) return null;
    return (ageRangeBP[0] + ageRangeBP[1]) / 2;
  }

  // Map ISO date -> years BP (relative to 1950). Approx: uses UTC year fraction by millis.
  function isoToBP(iso){
    if (!iso) return null;
    const d = new Date(iso);
    if (!isFinite(d.getTime())) return null;
    const base = Date.UTC(1950,0,1);
    const years = (base - d.getTime()) / (1000*60*60*24*365.2425);
    return years;
  }

  function fmt(n, digits=2){
    if (n == null || !isFinite(n)) return "‚Äî";
    return Number(n).toFixed(digits);
  }

  // ================= Ice-core dataset (compact, same style) =================
  const iceItems = [
    { id:"mpt", kind:"ice", name:"Mid-Pleistocene Transition (41k ‚Üí 100k yr cycles)", scale:"Global",
      siteName:"Antarctica ‚Äî Dome C / Little Dome C", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà1,200,000 ‚Äì 900,000 years BP", ageRangeBP:[1200000, 900000],
      tempChangeText:"Shift to larger, colder glacials; ~100k-year dominance.",
      greenhouseInfo:"CO‚ÇÇ baseline/amplitude changes; stronger dust/ice/CO‚ÇÇ feedbacks.",
      notes:"Deep Antarctic cores show long-cycle shift clearly."
    },
    { id:"lgm", kind:"ice", name:"Last Glacial Maximum (LGM)", scale:"Global",
      siteName:"Antarctica ‚Äî Dome C; Greenland summit cores", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà26,000 ‚Äì 19,000 years BP", ageRangeBP:[26000, 19000],
      tempChangeText:"Global mean ‚âà4‚Äì7 ¬∞C colder than today; very cold poles.",
      greenhouseInfo:"CO‚ÇÇ ‚âà180‚Äì190 ppm (glacial).",
      notes:"Cold/dusty interval in both Greenland and Antarctic."
    },
    { id:"younger_dryas", kind:"ice", name:"Younger Dryas cold reversal", scale:"Hemisphere",
      siteName:"Greenland ‚Äî GISP2 / NGRIP", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà12,900 ‚Äì 11,700 years BP", ageRangeBP:[12900, 11700],
      tempChangeText:"Abrupt North Atlantic cooling; Greenland cools fast.",
      greenhouseInfo:"CO‚ÇÇ slow rise; main driver is circulation/meltwater dynamics.",
      notes:"Sharp zig-zag in Greenland Œ¥18O; cause debated."
    },
    { id:"82ka", kind:"ice", name:"8.2 ka cold event", scale:"Hemisphere",
      siteName:"Greenland ‚Äî GRIP/GISP2/NGRIP", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà8,200 years BP (~150‚Äì200 years)", ageRangeBP:[8300, 8000],
      tempChangeText:"NH cooling ~1‚Äì3 ¬∞C; stronger in Greenland.",
      greenhouseInfo:"Small wiggles in gases; strong isotope/temperature signal.",
      notes:"Benchmark abrupt Holocene event."
    },
    { id:"little_ice_age", kind:"ice", name:"Little Ice Age (multi-centennial)", scale:"Hemisphere",
      siteName:"Greenland, Arctic & Alpine glaciers", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà1300 ‚Äì 1850 CE", ageRangeBP:[650, 100],
      tempChangeText:"NH cooling ~0.5‚Äì1 ¬∞C vs 20th century; regional extremes.",
      greenhouseInfo:"CO‚ÇÇ near preindustrial until late period.",
      notes:"Volcanic sulfate clusters + lower solar output periods."
    },
    { id:"modern_warming", kind:"ice", name:"Modern rapid warming", scale:"Global",
      siteName:"Atmosphere + recent ice layers", siteLat:0.0, siteLon:0.0,
      dateText:"‚âà1950 CE ‚Äì present", ageRangeBP:[0, -75],
      tempChangeText:"~1.2‚Äì1.3 ¬∞C above 1850‚Äì1900; extremely rapid.",
      greenhouseInfo:"CO‚ÇÇ >420 ppm; CH‚ÇÑ/N‚ÇÇO very high vs long ice-core record.",
      notes:"Modern gases exceed long ice-core ranges."
    }
  ];

  // Station items get added here after loading/import
  let stationItems = [];

  // Unified
  function allItems(){ return [...iceItems, ...stationItems]; }

  // ================= Table rendering =================
  const tbody = $("eventTableBody");
  const detailsContent = $("detailsContent");
  const catFilter = $("catFilter");
  const searchBox = $("searchBox");
  const sortMode = $("sortMode");

  let selectedId = null;

  function tagHTML(kind){
    if (kind === "ice") return `<span class="tag tag-ice"><span class="tag-dot"></span><span>Ice-core</span></span>`;
    return `<span class="tag tag-hum"><span class="tag-dot"></span><span>Station</span></span>`;
  }
  function scaleTagHTML(scale){
    const cls = scale === "Global" ? "tag tag-scale-global" : (scale === "Hemisphere" ? "tag tag-scale-hemisphere" : "tag tag-scale-regional");
    return `<span class="${cls}"><span class="tag-dot"></span><span>${scale}</span></span>`;
  }

  function renderTable(){
    const cat = catFilter.value;
    const q = (searchBox.value || "").toLowerCase();
    const mode = sortMode.value;

    let list = allItems().filter(it=>{
      if (cat !== "all" && it.kind !== cat) return false;
      if (!q) return true;
      const hay = (it.name + " " + (it.siteName||"") + " " + (it.netSta||"") + " " + (it.notes||"")).toLowerCase();
      return hay.includes(q);
    });

    list.sort((a,b)=>{
      if (mode === "name") return a.name.localeCompare(b.name);
      const am = bpMid(a.ageRangeBP), bm = bpMid(b.ageRangeBP);
      if (am == null && bm == null) return 0;
      if (am == null) return 1;
      if (bm == null) return -1;
      return (mode === "olderFirst") ? (bm - am) : (am - bm);
    });

    tbody.innerHTML = "";

    list.forEach(it=>{
      const tr = document.createElement("tr");
      tr.dataset.id = it.id;
      if (it.id === selectedId) tr.classList.add("active-row");

      const tdName = document.createElement("td");
      tdName.textContent = it.name;

      const tdKind = document.createElement("td");
      tdKind.innerHTML = tagHTML(it.kind);

      const tdScale = document.createElement("td");
      tdScale.innerHTML = scaleTagHTML(it.scale || "Regional");

      const tdSite = document.createElement("td");
      tdSite.textContent = it.kind === "hum" ? (it.netSta || "‚Äî") : (it.siteName.split("‚Äî")[0].trim());

      const tdLat = document.createElement("td");
      tdLat.textContent = (it.siteLat ?? 0).toFixed(2);

      const tdDate = document.createElement("td");
      tdDate.textContent = it.dateText || "‚Äî";

      tr.appendChild(tdName);
      tr.appendChild(tdKind);
      tr.appendChild(tdScale);
      tr.appendChild(tdSite);
      tr.appendChild(tdLat);
      tr.appendChild(tdDate);

      tr.addEventListener("click", ()=>{
        selectedId = it.id;
        document.querySelectorAll("#eventTableBody tr").forEach(r=>r.classList.remove("active-row"));
        tr.classList.add("active-row");
        renderDetails(it);
        recomputeAndPlot();
      });

      tbody.appendChild(tr);
    });

    if (!list.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.className = "muted";
      td.textContent = "No items match.";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  }

  catFilter.addEventListener("change", renderTable);
  searchBox.addEventListener("input", renderTable);
  sortMode.addEventListener("change", renderTable);

  // ================= Details =================
  function renderDetails(it){
    $("selName").textContent = it.name || "‚Äî";
    $("selAge").textContent = it.dateText || "‚Äî";
    $("selBand").textContent = it.siteLat != null ? `${latBand(it.siteLat)} ¬∑ ${(it.siteLat>=0?"Northern":"Southern")}` : "‚Äî";
    $("selSite").textContent = it.kind === "hum" ? (it.netSta || "‚Äî") : (it.siteName || "‚Äî");

    if (it.kind === "ice"){
      detailsContent.innerHTML = `
        <div class="coords">Core reference: ${it.siteName} ‚Äî Lat ${fmt(it.siteLat,4)}¬∞, Lon ${fmt(it.siteLon,4)}¬∞</div>
        <div style="margin-top:8px;">
          <div class="muted mini"><b>Temperature:</b> ${it.tempChangeText}</div>
          <div class="muted mini" style="margin-top:6px;"><b>Greenhouse gases:</b> ${it.greenhouseInfo}</div>
          <div class="muted mini" style="margin-top:6px;"><b>Notes:</b> ${it.notes || "‚Äî"}</div>
        </div>
      `;
    } else {
      detailsContent.innerHTML = `
        <div class="coords">Station: ${it.netSta} ‚Äî Lat ${fmt(it.siteLat,4)}¬∞, Lon ${fmt(it.siteLon,4)}¬∞, Elev ${fmt(it.elev,1)} m</div>
        <div class="muted mini" style="margin-top:8px;"><b>Site name:</b> ${it.siteName || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Operating:</b> ${it.startISO || "‚Äî"} ‚Üí ${it.endISO || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Source:</b> FDSN Station service (format=text). Imported into the table as real metadata.</div>
      `;
    }
  }

  // ================= Station loader / parser =================
  function setStatus(kind, msg){
    const box = $("statusBox");
    box.className = "status " + (kind || "warn");
    box.textContent = "Status: " + msg;
  }

  function buildStationURL(){
    const base = $("serviceBase").value.trim();
    const net = encodeURIComponent(($("netCode").value || "").trim() || "*");
    const sta = encodeURIComponent(($("staCode").value || "").trim() || "*");
    const level = encodeURIComponent(($("levelMode").value || "station").trim());
    const limit = encodeURIComponent(String(Math.max(1, Number($("limit").value || 200))));
    const start = ($("startTime").value || "").trim();
    const end = ($("endTime").value || "").trim();

    const params = new URLSearchParams();
    params.set("net", net);
    params.set("sta", sta);
    params.set("level", level);
    params.set("format", "text");
    params.set("nodata", "404");
    params.set("limit", limit);
    if (start) params.set("starttime", start);
    if (end) params.set("endtime", end);

    return base + "?" + params.toString();
  }

  // Parses format=text output (pipe-separated). Robust to comments/header lines.
  // Typical station-level columns are like:
  // Network|Station|Latitude|Longitude|Elevation|SiteName|StartTime|EndTime
  function parseStationText(text){
    const lines = String(text || "").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const rows = [];
    for (const line of lines){
      if (!line || line.startsWith("#")) continue;
      // Some services may separate by | or whitespace; we prefer |
      const parts = line.includes("|") ? line.split("|").map(x=>x.trim()) : line.split(/\s+/);
      if (parts.length < 5) continue;

      // Best-effort mapping:
      // 0 net, 1 sta, 2 lat, 3 lon, 4 elev, 5 sitename, 6 start, 7 end
      const net = parts[0] || "";
      const sta = parts[1] || "";
      const lat = Number(parts[2]);
      const lon = Number(parts[3]);
      const elev = Number(parts[4]);
      const siteName = parts[5] || "";
      const startISO = parts[6] || "";
      const endISO = parts[7] || "";

      if (!net || !sta || !isFinite(lat) || !isFinite(lon)) continue;

      rows.push({ net, sta, lat, lon, elev: isFinite(elev)?elev:null, siteName, startISO, endISO });
    }
    return rows;
  }

  function rowsToStationItems(rows){
    // Convert station metadata into "hum" items.
    // For timeline ageRangeBP, we map station start/end (ISO) to BP (approx).
    const out = [];
    for (const r of rows){
      const startBP = isoToBP(r.startISO);
      const endBP = isoToBP(r.endISO) ?? isoToBP(new Date().toISOString());
      // If missing times, give a small window near present.
      const a = (startBP==null ? 0 : startBP);
      const b = (endBP==null ? -10 : endBP);
      const older = Math.max(a,b);
      const newer = Math.min(a,b);

      out.push({
        id: `sta_${r.net}_${r.sta}_${Math.round(Math.abs((older+newer)/2)*1000)}`,
        kind:"hum",
        name:`Station ${r.net}.${r.sta} (metadata)`,
        scale:"Regional",
        netSta:`${r.net}.${r.sta}`,
        siteName: r.siteName || `${r.net}.${r.sta}`,
        siteLat: r.lat,
        siteLon: r.lon,
        elev: r.elev,
        startISO: r.startISO || "‚Äî",
        endISO: r.endISO || "‚Äî",
        dateText: `${r.startISO || "?"} ‚Üí ${r.endISO || "?"}`,
        ageRangeBP: [older, newer],
        notes:"Loaded from FDSN Station service (format=text)."
      });
    }
    return out;
  }

  async function loadStationsOnline(){
    const url = buildStationURL();
    setStatus("warn", "Loading station metadata‚Ä¶");
    try{
      const res = await fetch(url, { method:"GET" });
      if (!res.ok){
        throw new Error(`HTTP ${res.status} ${res.statusText}`);
      }
      const text = await res.text();
      const rows = parseStationText(text);
      if (!rows.length){
        setStatus("warn", "Loaded response, but parsed 0 rows. Try level=station, widen net/sta, or use Paste import.");
        return;
      }
      const newItems = rowsToStationItems(rows);

      // Merge (avoid duplicates by netSta)
      const existing = new Set(stationItems.map(s=>s.netSta));
      const merged = [];
      for (const it of newItems){
        if (!existing.has(it.netSta)){
          merged.push(it);
          existing.add(it.netSta);
        }
      }
      stationItems = [...stationItems, ...merged];

      setStatus("ok", `Loaded ${merged.length} stations (${rows.length} parsed rows).`);
      renderTable();

      // auto-select first new station if nothing selected
      if (!selectedId && stationItems.length){
        selectedId = stationItems[0].id;
        renderDetails(stationItems[0]);
      }
      recomputeAndPlot();
    }catch(err){
      // Common failure: CORS blocked by browser
      setStatus("bad", `Load failed (${String(err.message || err)}). If this is CORS, use Paste Station Text or host a tiny proxy on your own domain.`);
    }
  }

  function clearStations(){
    stationItems = [];
    setStatus("warn", "Cleared stations. No stations loaded.");
    renderTable();
    recomputeAndPlot();
  }

  function useExampleStations(){
    // Example rows matching the station-level text shape (for offline testing).
    const example = `
#Network|Station|Latitude|Longitude|Elevation|SiteName|StartTime|EndTime
IU|ANMO|34.9459|-106.4572|1850.0|Albuquerque, New Mexico, USA|1989-01-01T00:00:00|2599-12-31T23:59:59
IU|COLA|64.8736|-147.8616|200.0|College Outpost, Alaska, USA|1990-01-01T00:00:00|2599-12-31T23:59:59
IU|KONO|59.6490|9.5980|216.0|Kongsberg, Norway|1991-01-01T00:00:00|2599-12-31T23:59:59
`;
    const rows = parseStationText(example);
    const newItems = rowsToStationItems(rows);
    stationItems = newItems;
    setStatus("ok", `Loaded example stations (${newItems.length}).`);
    renderTable();
    if (stationItems.length){
      selectedId = stationItems[0].id;
      renderDetails(stationItems[0]);
    }
    recomputeAndPlot();
  }

  $("btnLoadStations").addEventListener("click", loadStationsOnline);
  $("btnClearStations").addEventListener("click", clearStations);
  $("btnUseExample").addEventListener("click", useExampleStations);

  // paste import
  $("btnPasteToggle").addEventListener("click", ()=>{
    const w = $("pasteWrap");
    w.style.display = (w.style.display === "none") ? "block" : "none";
  });
  $("btnImportPasted").addEventListener("click", ()=>{
    const text = $("pasteBox").value || "";
    const rows = parseStationText(text);
    if (!rows.length){
      setStatus("warn", "Paste import parsed 0 rows. Make sure it‚Äôs station service format=text output.");
      return;
    }
    const newItems = rowsToStationItems(rows);
    stationItems = [...stationItems, ...newItems];
    setStatus("ok", `Imported ${newItems.length} stations from pasted text.`);
    renderTable();
    recomputeAndPlot();
  });

  // ================= Initial render =================
  catFilter.value = "all";
  renderTable();
  selectedId = "lgm";
  renderDetails(iceItems.find(x=>x.id==="lgm"));
</script>
<!-- ======================= PART 3 / 3 ======================= -->
<script>
  // ================= Proxy plot (same idea, now with real station metadata loaded) =================
  const canvas = $("plot");
  const ctx = canvas.getContext("2d");

  function resizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(320, Math.floor(rect.width * dpr));
    canvas.height = Math.max(180, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); recomputeAndPlot(); });

  function co2StateForIce(it){
    // Very rough anchors for plotting only.
    if (it.id === "lgm") return 190;
    if (it.id === "younger_dryas") return 240;
    if (it.id === "82ka") return 265;
    if (it.id === "little_ice_age") return 280;
    if (it.id === "modern_warming") return 420;
    if (it.id === "mpt") return 240;
    return 280;
  }

  function getCoupling(){
    const c = $("humCoupling").value;
    if (c === "low") return 0.20;
    if (c === "high") return 0.70;
    return 0.40;
  }

  function anchorsInWindow(startBP, endBP){
    const a = iceItems
      .map(it=>({ bp: bpMid(it.ageRangeBP), co2: co2StateForIce(it), id: it.id }))
      .filter(p=>p.bp != null)
      .filter(p=>p.bp <= startBP && p.bp >= endBP)
      .sort((x,y)=> y.bp - x.bp);

    if (a.length >= 2) return a;

    const all = iceItems
      .map(it=>({ bp: bpMid(it.ageRangeBP), co2: co2StateForIce(it), id: it.id }))
      .filter(p=>p.bp != null)
      .sort((x,y)=> y.bp - x.bp);

    const targetMid = (startBP + endBP)/2;
    all.sort((x,y)=> Math.abs(x.bp-targetMid)-Math.abs(y.bp-targetMid));
    return all.slice(0, Math.min(4, all.length)).sort((x,y)=> y.bp - x.bp);
  }

  function interpCO2(bp, anchors){
    if (!anchors.length) return 280;
    if (anchors.length === 1) return anchors[0].co2;
    for (let i=0;i<anchors.length-1;i++){
      const A = anchors[i], B = anchors[i+1];
      if (bp <= A.bp && bp >= B.bp){
        const t = (A.bp === B.bp) ? 0 : ((A.bp - bp) / (A.bp - B.bp));
        return lerp(A.co2, B.co2, clamp(t,0,1));
      }
    }
    if (bp > anchors[0].bp) return anchors[0].co2;
    return anchors[anchors.length-1].co2;
  }

  function rotationProxy(bp){
    const My = Math.max(0,bp) / 1e6;
    return clamp(0.02 * My, 0, 1.0);
  }
  function pseudoNoise(x){
    const s = Math.sin(x*12.9898) * 43758.5453;
    return s - Math.floor(s);
  }

  function computeSeries(){
    const startBP = Number($("winStart").value);
    const endBP = Number($("winEnd").value);
    const lo = Math.max(endBP, -500);
    const hi = Math.max(startBP, lo+1);

    const N = 420;
    const anchors = anchorsInWindow(hi, lo);
    const coupling = getCoupling();
    const mode = $("humMode").value;

    const series = [];
    for (let i=0;i<N;i++){
      const t = i/(N-1);
      const bp = lerp(hi, lo, t);
      const co2 = interpCO2(bp, anchors);
      const co2Norm = clamp((co2 - 180) / (420 - 180), 0, 1);
      const rot = rotationProxy(bp);
      const base = 0.45 + 0.10*rot;

      let hum;
      if (mode === "flat"){
        hum = 0.50;
      } else if (mode === "storms"){
        const n = pseudoNoise(bp/75);
        const spikes = Math.pow(n, 8);
        hum = base + 0.15*coupling*co2Norm + 0.35*spikes;
      } else {
        const wig = (pseudoNoise(bp/120) - 0.5) * 0.06;
        hum = base + coupling*0.35*co2Norm + wig;
      }
      hum = clamp(hum, 0, 1);
      series.push({ bp, co2, hum });
    }

    return { series, anchors, startBP:hi, endBP:lo, mode, coupling: $("humCoupling").value };
  }

  function drawPlot(model){
    resizeCanvas();
    const rect = canvas.getBoundingClientRect();
    const W = rect.width;
    const H = rect.height;

    ctx.clearRect(0,0,W,H);

    const padL = 44, padR = 10, padT = 12, padB = 24;
    const x0 = padL, y0 = padT, x1 = W - padR, y1 = H - padB;

    const xFor = (bp)=> x0 + ((model.startBP - bp) / (model.startBP - model.endBP)) * (x1 - x0);
    const yCO2 = (co2)=> y1 - clamp((co2 - 180)/(420-180),0,1) * (y1 - y0);
    const yHum = (h)=> y1 - clamp(h,0,1) * (y1 - y0);

    // grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(148,163,184,0.22)";
    ctx.fillStyle = "rgba(148,163,184,0.85)";
    ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

    for (let k=0;k<=4;k++){
      const frac = k/4;
      const y = y1 - frac*(y1-y0);
      ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke();
      const label = (180 + frac*(420-180)).toFixed(0) + " ppm CO‚ÇÇ / " + frac.toFixed(2) + " hum";
      ctx.fillText(label, 6, y+4);
    }

    const ticks = 5;
    for (let i=0;i<=ticks;i++){
      const bp = lerp(model.startBP, model.endBP, i/ticks);
      const x = xFor(bp);
      ctx.beginPath(); ctx.moveTo(x, y1); ctx.lineTo(x, y1+6); ctx.stroke();
      const txt = (bp>=0 ? Math.round(bp)+" BP" : (Math.round(-bp)+" yrs after 1950"));
      ctx.fillText(txt, x-24, H-6);
    }

    // CO2 line (cyan)
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(56,189,248,0.95)";
    ctx.beginPath();
    model.series.forEach((p,idx)=>{
      const x = xFor(p.bp);
      const y = yCO2(p.co2);
      if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Hum line (green)
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(34,197,94,0.95)";
    ctx.beginPath();
    model.series.forEach((p,idx)=>{
      const x = xFor(p.bp);
      const y = yHum(p.hum);
      if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // selected marker
    const sel = selectedId ? allItems().find(it=>it.id===selectedId) : null;
    if (sel){
      const mid = bpMid(sel.ageRangeBP);
      if (mid != null){
        const x = xFor(mid);
        ctx.strokeStyle = "rgba(248,250,252,0.75)";
        ctx.beginPath(); ctx.moveTo(x, y0); ctx.lineTo(x, y1); ctx.stroke();
        ctx.fillStyle = "rgba(248,250,252,0.92)";
        ctx.fillText("selected", x+6, y0+12);
      }
    }

    // legend
    ctx.fillStyle = "rgba(56,189,248,0.95)";
    ctx.fillText("CO‚ÇÇ proxy (ice anchors)", x0+4, y0+12);
    ctx.fillStyle = "rgba(34,197,94,0.95)";
    ctx.fillText("Hum proxy (toy)", x0+170, y0+12);

    // anchor dots
    ctx.fillStyle = "rgba(56,189,248,0.95)";
    model.anchors.forEach(a=>{
      const x = xFor(a.bp);
      const y = yCO2(a.co2);
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    });
  }

  function toCSV(series){
    const head = "bp_years,co2_ppm_proxy,hum_amp_proxy\n";
    const rows = series.map(p=>`${p.bp.toFixed(2)},${p.co2.toFixed(2)},${p.hum.toFixed(6)}`).join("\n");
    return head + rows + "\n";
  }

  function recomputeAndPlot(){
    const model = computeSeries();
    drawPlot(model);
    $("plotNote").textContent =
      `Window: ${model.startBP} ‚Üí ${model.endBP} BP. Hum mode="${model.mode}", coupling="${model.coupling}". Stations loaded: ${stationItems.length}.`;
  }

  $("btnRecompute").addEventListener("click", recomputeAndPlot);
  $("btnExport").addEventListener("click", ()=>{
    const model = computeSeries();
    const csv = toCSV(model.series);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "icecore_hum_proxy_plot.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Hook selection update into table clicks (already calls recomputeAndPlot)
  // Initial plot
  recomputeAndPlot();
</script>

</body>
</html>
