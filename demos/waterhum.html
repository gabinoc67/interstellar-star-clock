<!-- ======================= PART 1 / 5 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cosmic Clock ‚Äî Ocean Hum (Gravity + Rotation + Microseism Bands)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#020617;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --panel:rgba(15,23,42,0.96);
    --line:rgba(148,163,184,0.28);
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#fb7185;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background:
      radial-gradient(circle at top, rgba(56,189,248,0.10), rgba(2,6,23,1) 55%, rgba(0,0,0,1) 100%);
    color:var(--ink);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  }
  header{
    padding:16px 24px;
    border-bottom:1px solid rgba(148,163,184,0.35);
    background: radial-gradient(circle at top left, #0ea5e9 0, #0f172a 45%, #000 100%);
  }
  header h1{ margin:0 0 6px; font-size:22px; letter-spacing:.04em; }
  header p{ margin:2px 0; font-size:13px; color:#bae6fd; }
  .muted{ color:var(--muted); }
  .mini{ font-size:11px; }

  .wrap{
    padding:16px 20px 22px;
    display:grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
    gap:16px;
    max-width: 1280px;
    margin: 0 auto;
  }

  .panel{
    background: radial-gradient(circle at top, rgba(56,189,248,0.12), rgba(15,23,42,0.98));
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.30);
    box-shadow:0 18px 45px rgba(0,0,0,0.55);
    padding:14px 16px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height: 560px;
  }
  .panel h2{
    margin:0;
    font-size:15px;
    font-weight:780;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:12px; }
  .controls label{ color:#bae6fd; font-size:12px; display:flex; align-items:center; gap:8px; }

  select, input[type="number"], input[type="text"]{
    background: rgba(15,23,42,0.9);
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.65);
    color:var(--ink);
    padding:5px 10px;
    font-size:12px;
    outline:none;
  }
  select:focus, input:focus{
    border-color: var(--accent);
    box-shadow:0 0 0 1px rgba(56,189,248,0.6);
  }

  .btn{
    border-radius:999px;
    padding:6px 10px;
    border:1px solid rgba(148,163,184,0.55);
    background: rgba(2,6,23,0.35);
    color: var(--ink);
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(56,189,248,0.75); }
  .btn.primary{ border-color: rgba(56,189,248,0.90); }

  .status{
    padding:8px 10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.22);
    font-size:12px;
  }

  .rangeRow{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.20);
    background: rgba(2,6,23,0.20);
  }
  input[type="range"]{ width:100%; }

  .plot-wrap{
    border:1px solid rgba(148,163,184,0.25);
    border-radius:14px;
    padding:10px;
    background: rgba(2,6,23,0.22);
  }
  canvas{ width:100%; height:260px; display:block; }

  .kv{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    font-size:12px;
  }
  .k{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.20);
    background: rgba(2,6,23,0.20);
  }
  .k b{
    display:block;
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.08em;
    margin-bottom:4px;
  }
  .k .v{ font-family:var(--mono); font-size:12px; color:#eaf2ff; }

  .note{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.18);
    font-size:12px;
    line-height:1.35;
  }

  .ev{
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.20);
    border-radius:14px;
    padding:10px;
    font-size:12px;
    line-height:1.35;
  }
  .ev h3{
    margin:0 0 6px;
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:#bae6fd;
  }
  .ev ul{ margin:8px 0 0 18px; padding:0; }
  .ev li{ margin:6px 0; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:2px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.40);
    background: rgba(15,23,42,0.55);
    font-size:11px;
    color:#eaf2ff;
  }
  .dot{ width:7px; height:7px; border-radius:99px; background:#22c55e; }
  .dot.warn{ background:#f59e0b; }
  .dot.bad{ background:#fb7185; }

  @media (max-width: 980px){
    .wrap{ grid-template-columns: minmax(0, 1fr); }
    .panel{ min-height: unset; }
    canvas{ height: 240px; }
  }
</style>
</head>

<body>
<header>
  <h1>Cosmic Clock ‚Äî Ocean Hum (Gravity + Rotation + Microseism Bands)</h1>
  <p>Measured era: microseisms + Earth hum from seismometers. Deep time: infer forcing from Moon distance + Earth spin + resonance + orbital modulation.</p>
  <p class="muted mini">Wave monitor is ‚Äúdisplay-scaled‚Äù: real bands are slow/fast, but animation keeps them visible while preserving relative frequency shifts.</p>
</header>

<div class="wrap">
  <section class="panel">
    <h2>üï∞Ô∏è Time + Drivers</h2>

    <div class="controls">
      <label>Time back:
        <input type="number" id="tMa" value="50" min="0" max="4500" step="1" style="width:110px" />
        <span class="muted">Ma</span>
      </label>

      <button class="btn primary" id="btnApply">Apply</button>
      <button class="btn" id="btnPlay">Play</button>
      <button class="btn" id="btnPause">Pause</button>

      <label>Speed:
        <select id="speed">
          <option value="0.25">0.25√ó</option>
          <option value="0.5">0.5√ó</option>
          <option value="1" selected>1√ó</option>
          <option value="2">2√ó</option>
          <option value="4">4√ó</option>
        </select>
      </label>
    </div>

    <div class="rangeRow">
      <input type="range" id="tSlider" min="0" max="4500" value="50" step="1" />
      <div class="status" id="timeReadout">t = 50 Ma</div>
    </div>

    <div class="controls">
      <label>Plot span:
        <input type="number" id="spanMa" value="200" min="10" max="4500" step="10" style="width:110px" />
        <span class="muted">Ma window</span>
      </label>

      <label>Resolution:
        <input type="number" id="N" value="520" min="150" max="2200" step="50" style="width:110px" />
      </label>

      <label>Driver:
        <select id="driver">
          <option value="combo" selected>Full combo (tides + rotation + resonance + microseism + orbital)</option>
          <option value="gravity">Gravity (tides) + rotation</option>
          <option value="gravity_only">Gravity only (tides)</option>
          <option value="rotation_only">Rotation/Coriolis only</option>
          <option value="flat">Constant (control)</option>
        </select>
      </label>
    </div>

    <div class="controls">
      <label>Coupling:
        <select id="coupling">
          <option value="low">Low</option>
          <option value="med" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </label>

      <label>Resonance:
        <select id="resMode">
          <option value="mild" selected>Mild</option>
          <option value="peaky">Peaky basins</option>
          <option value="off">Off</option>
        </select>
      </label>

      <label>Microseism:
        <select id="microMode">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <label>Freq band:
        <select id="band">
          <option value="secondary" selected>Secondary microseism (3‚Äì10 s)</option>
          <option value="primary">Primary microseism (10‚Äì20 s)</option>
          <option value="hum">Earth hum (‚âà30‚Äì300 s)</option>
          <option value="tide">Tide (hours)</option>
          <option value="blend">Blend (tide + hum + microseism)</option>
        </select>
      </label>
    </div>

    <div class="plot-wrap">
      <canvas id="plot"></canvas>
      <div class="muted mini" id="plotNote">‚Äî</div>
    </div>

    <div class="note">
      <b>Key idea:</b> ‚ÄúHum amplitude‚Äù is a proxy for mechanical energy available to drive ocean-coupled vibration.
      <span class="muted">Closer Moon + faster spin ‚áí stronger forcing ‚áí higher proxy hum.</span>
    </div>
  </section>

  <section class="panel">
    <h2>üìö Evidence Timeline + Live Wave</h2>

    <div class="status" id="eraPill">
      <span class="pill"><span class="dot warn"></span><span>Era: ‚Äî</span></span>
    </div>

    <div class="ev" id="evidenceBox">
      <h3>Oldest records ‚Üí today</h3>
      <div class="muted mini">This panel updates based on your selected time.</div>
      <div id="evidence"></div>
    </div>

    <div class="kv">
      <div class="k"><b>Time</b><div class="v" id="vTime">‚Äî</div></div>
      <div class="k"><b>Day length</b><div class="v" id="vDay">‚Äî</div></div>
      <div class="k"><b>Moon distance</b><div class="v" id="vMoon">‚Äî</div></div>
      <div class="k"><b>Tidal forcing</b><div class="v" id="vTide">‚Äî</div></div>
      <div class="k"><b>Rotation/Coriolis</b><div class="v" id="vRot">‚Äî</div></div>
      <div class="k"><b>Resonance</b><div class="v" id="vRes">‚Äî</div></div>
      <div class="k"><b>Microseism proxy</b><div class="v" id="vMicro">‚Äî</div></div>
      <div class="k"><b>Dominant band</b><div class="v" id="vBand">‚Äî</div></div>
      <div class="k"><b>Band frequency</b><div class="v" id="vHz">‚Äî</div></div>
      <div class="k"><b>Hum amplitude</b><div class="v" id="vHum">‚Äî</div></div>
    </div>

    <div class="plot-wrap">
      <div class="muted mini" id="waveReadout">Wave: ‚Äî</div>
      <canvas id="wave"></canvas>
      <div class="muted mini" id="waveNote">Live wave: amplitude + frequency follow the selected band and time.</div>
    </div>
  </section>
</div>
<!-- ======================= PART 2 / 5 ======================= -->
<script>
  // ================= Utilities =================
  const $ = (id)=>document.getElementById(id);
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function fmt(n, d=3){ return (isFinite(n) ? n.toFixed(d) : "‚Äî"); }
  function pseudoNoise(x){
    const s = Math.sin(x*12.9898) * 43758.5453;
    return s - Math.floor(s);
  }

  // ================= Deep-Time Proxies (Toy, Deterministic) =================
  // Present-day constants
  const DAY_HOURS_NOW = 24.0;
  const MOON_DIST_NOW = 384400; // km

  // Proxy day length: older => shorter day; clamped
  function dayLengthHoursAtMa(tMa){
    const t = clamp(tMa, 0, 4500);
    const short = 10.0;                // floor (toy)
    const frac = t / 4500;
    const curve = Math.pow(frac, 0.65);
    const day = DAY_HOURS_NOW - (DAY_HOURS_NOW - short) * curve;
    return clamp(day, short, DAY_HOURS_NOW);
  }

  // Proxy moon distance: older => closer moon; clamped
  function moonDistanceKmAtMa(tMa){
    const t = clamp(tMa, 0, 4500);
    const minKm = 280000;              // toy minimum
    const frac = t / 4500;
    const curve = Math.pow(frac, 0.55);
    const dist = MOON_DIST_NOW - (MOON_DIST_NOW - minKm) * curve;
    return clamp(dist, minKm, MOON_DIST_NOW);
  }

  // Orbital modulation proxy (structure only)
  function orbitalModAtMa(tMa){
    const years = tMa * 1e6;
    const a = 0.5 + 0.5*Math.sin(2*Math.PI*years/100000);
    const b = 0.5 + 0.5*Math.sin(2*Math.PI*years/41000 + 1.2);
    const c = 0.5 + 0.5*Math.sin(2*Math.PI*years/23000 + 2.4);
    return clamp(0.45*a + 0.35*b + 0.20*c, 0, 1);
  }

  // Tidal forcing proxy: strong dependence on distance (steep exponent)
  function tidalForcingAtMa(tMa){
    const r = moonDistanceKmAtMa(tMa);
    const ratio = MOON_DIST_NOW / r;
    const p = 6; // sensitivity
    return clamp(Math.pow(ratio, p), 0, 10);
  }

  // Rotation proxy: normalized Œ© ~ 1/daylength
  function rotationProxyAtMa(tMa){
    const dayH = dayLengthHoursAtMa(tMa);
    const omega = 2*Math.PI / (dayH*3600);
    const omegaNow = 2*Math.PI / (DAY_HOURS_NOW*3600);
    return clamp(omega / omegaNow, 0, 3);
  }

  function resonanceProxyAtMa(tMa, mode){
    if (mode === "off") return 0;
    const orb = orbitalModAtMa(tMa);
    const slow = 0.5 + 0.5*Math.sin(2*Math.PI*(tMa/600) + 0.7);
    const base = 0.35 + 0.45*orb + 0.20*slow;
    if (mode === "peaky") return clamp(Math.pow(base, 2.3), 0, 1);
    return clamp(base, 0, 1);
  }

  function microseismProxyAtMa(tMa, onOff){
    if (onOff === "off") return 0;
    const orb = orbitalModAtMa(tMa);
    const n = pseudoNoise(tMa*0.37);
    const spikes = Math.pow(n, 8);
    return clamp(0.25 + 0.55*orb + 0.35*spikes, 0, 1);
  }

  function couplingValue(){
    const c = $("coupling").value;
    if (c === "low") return 0.35;
    if (c === "high") return 0.85;
    return 0.60;
  }

  // "Instrument era" threshold (roughly last ~150 years)
  // Convert 150 years to Ma: 150 / 1e6 = 0.00015 Ma
  const INSTRUMENT_ERA_MA = 0.00015;

  function yearsFromMa(tMa){ return tMa * 1e6; }
</script>
<!-- ======================= PART 3 / 5 ======================= -->
<script>
  // ================= Hum Amplitude + Frequency Band Model =================
  function humAmplitudeAtMa(tMa){
    const driver = $("driver").value;
    if (driver === "flat") return 0.50;

    const k = couplingValue();
    const tide = tidalForcingAtMa(tMa);
    const rot  = rotationProxyAtMa(tMa);
    const res  = resonanceProxyAtMa(tMa, $("resMode").value);
    const mic  = microseismProxyAtMa(tMa, $("microMode").value);
    const orb  = orbitalModAtMa(tMa);

    const tideN = clamp((tide - 1) / 4, 0, 1);
    const rotN  = clamp((rot  - 1) / 1.5, 0, 1);

    let hum = 0.22;

    if (driver === "gravity_only"){
      hum += k*(0.70*tideN + 0.15*orb + 0.10*res);
    } else if (driver === "rotation_only"){
      hum += k*(0.70*rotN + 0.20*orb + 0.10*res);
    } else if (driver === "gravity"){
      hum += k*(0.52*tideN + 0.30*rotN + 0.10*res + 0.08*orb);
    } else { // combo
      hum += k*(0.42*tideN + 0.28*rotN + 0.12*res + 0.12*mic + 0.06*orb);
    }

    // small deterministic wiggle
    hum += (pseudoNoise(tMa*0.91) - 0.5) * 0.03;
    return clamp(hum, 0, 1);
  }

  // Frequency (Hz) proxy for the selected band.
  // Anchors reflect observed modern bands:
  // - Secondary microseism: ~3‚Äì10 s (~0.1‚Äì0.33 Hz)
  // - Primary microseism:  ~10‚Äì20 s (~0.05‚Äì0.1 Hz)
  // - Earth hum:           ~30‚Äì300 s (~0.003‚Äì0.033 Hz)
  // - Tide:                hours (~1e-5 Hz scale)
  //
  // Deep-time: we let forcing (tides/rotation/micro) slightly bias frequency within the band.
  function bandHzAtMa(tMa){
    const band = $("band").value;

    const hum = humAmplitudeAtMa(tMa);
    const tide = tidalForcingAtMa(tMa);
    const rot  = rotationProxyAtMa(tMa);
    const mic  = microseismProxyAtMa(tMa, $("microMode").value);

    const tideN = clamp((tide - 1) / 4, 0, 1);
    const rotN  = clamp((rot  - 1) / 1.5, 0, 1);

    // A small ‚Äúforcing tilt‚Äù 0..1
    const tilt = clamp(0.45*mic + 0.25*tideN + 0.20*rotN + 0.10*hum, 0, 1);

    function hzInRange(hzMin, hzMax){
      // tilt chooses within the band; hum adds subtle widening
      const widen = 0.90 + 0.25*hum;
      const hz = lerp(hzMin, hzMax, tilt) * widen;
      return clamp(hz, hzMin*0.6, hzMax*1.6);
    }

    if (band === "secondary") return hzInRange(0.10, 0.33);
    if (band === "primary")   return hzInRange(0.05, 0.10);
    if (band === "hum")       return hzInRange(0.003, 0.033);
    if (band === "tide")      return hzInRange(0.00001, 0.00004); // ~1 cycle per 7‚Äì28 hours
    // blend
    const a = hzInRange(0.10, 0.33);
    const b = hzInRange(0.05, 0.10);
    const c = hzInRange(0.003, 0.033);
    const d = hzInRange(0.00001, 0.00004);
    // Weight by microseism presence + hum
    const wMic = clamp(0.55*mic + 0.25*hum + 0.20, 0, 1);
    const wLow = 1 - wMic;
    return (wMic*(0.65*a + 0.35*b)) + (wLow*(0.75*c + 0.25*d));
  }

  function bandLabel(){
    const b = $("band").value;
    if (b === "secondary") return "Secondary microseism (3‚Äì10 s)";
    if (b === "primary") return "Primary microseism (10‚Äì20 s)";
    if (b === "hum") return "Earth hum (‚âà30‚Äì300 s)";
    if (b === "tide") return "Tide (hours)";
    return "Blend (tide + hum + microseism)";
  }

  // Evidence timeline content (no links; names are enough for your ‚Äúweb references‚Äù panel)
  const EVIDENCE = [
    {
      tag: "Measured (instrument era)",
      items: [
        "Seismometers record continuous ocean-driven microseisms (primary ~10‚Äì20 s; secondary ~3‚Äì10 s).",
        "Microseism levels track storms and wave climate (modern global analyses).",
        "Earth‚Äôs ‚Äúhum‚Äù (continuous free oscillations) is observed without earthquakes and is linked to atmosphere‚Äìocean‚Äìseafloor coupling."
      ]
    },
    {
      tag: "Constrained (geologic evidence)",
      items: [
        "Earth‚Äôs rotation slowed over geologic time; fossil corals and rhythmites constrain past day length (more days/year in deep past).",
        "Some studies suggest complex deep-time behavior (e.g., possible mid-Proterozoic day-length stabilization)."
      ]
    },
    {
      tag: "Assumed (deep-time extrapolation)",
      items: [
        "Moon was closer in the past ‚Üí stronger tidal forcing (steep distance dependence).",
        "Faster Earth spin ‚Üí stronger Coriolis influence on large-scale ocean dynamics.",
        "Basin resonance, microseism texture, and orbital modulation are modeled as deterministic structure (not measured)."
      ]
    }
  ];

  function renderEvidence(tMa){
    const years = yearsFromMa(tMa);
    const inInstrument = (tMa <= INSTRUMENT_ERA_MA);

    const pill = $("eraPill");
    const dotClass = inInstrument ? "" : (tMa < 5 ? "warn" : "bad");
    pill.innerHTML = `<span class="pill"><span class="dot ${dotClass}"></span><span>Era: ${
      inInstrument ? "Measured (‚âàlast 150 years)" : (tMa < 5 ? "Mixed (proxy + constraints)" : "Assumption-heavy (deep time)")
    }</span></span>`;

    // Pick which blocks to emphasize
    let html = "";
    html += `<div class="muted mini">Selected time: <b>${Math.round(tMa)}</b> Ma (${years < 1e6 ? Math.round(years) + " years" : "‚âà" + (years/1e6).toFixed(1) + " million years"})</div>`;
    html += "<ul>";
    if (inInstrument){
      EVIDENCE[0].items.forEach(s=> html += `<li><b>${EVIDENCE[0].tag}:</b> ${s}</li>`);
      html += `<li><b>Assumption layer:</b> Even today, we infer ‚Äúocean hum drivers‚Äù from tides/rotation; the measured part is the seismic/ocean-noise record.</li>`;
    } else if (tMa < 5){
      EVIDENCE[0].items.slice(0,2).forEach(s=> html += `<li><b>${EVIDENCE[0].tag}:</b> ${s}</li>`);
      EVIDENCE[1].items.forEach(s=> html += `<li><b>${EVIDENCE[1].tag}:</b> ${s}</li>`);
      html += `<li><b>Assumed drivers:</b> ${EVIDENCE[2].items.join(" ")}</li>`;
    } else {
      EVIDENCE[1].items.forEach(s=> html += `<li><b>${EVIDENCE[1].tag}:</b> ${s}</li>`);
      EVIDENCE[2].items.forEach(s=> html += `<li><b>${EVIDENCE[2].tag}:</b> ${s}</li>`);
    }
    html += "</ul>";

    $("evidence").innerHTML = html;
  }
</script>
<!-- ======================= PART 4 / 5 ======================= -->
<script>
  // ================= Plot + Live Wave =================
  const plotCanvas = $("plot");
  const plotCtx = plotCanvas.getContext("2d");
  const waveCanvas = $("wave");
  const waveCtx = waveCanvas.getContext("2d");

  function resizeCanvas(c, ctx){
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    const cssW = Math.max(320, Math.floor(rect.width || 320));
    const cssH = Math.max(200, Math.floor(rect.height || 200));
    c.width = Math.floor(cssW * dpr);
    c.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { cssW, cssH };
  }

  function computeSeries(){
    const tNow = Number($("tMa").value);
    const span = Number($("spanMa").value);
    const N = Math.max(150, Number($("N").value));

    const t0 = clamp(tNow - span, 0, 4500);
    const t1 = clamp(tNow + span, 0, 4500);
    const lo = Math.min(t0, t1);
    const hi = Math.max(t0, t1);

    const series = [];
    for (let i=0;i<N;i++){
      const u = i/(N-1);
      const t = lerp(lo, hi, u);

      const dayH = dayLengthHoursAtMa(t);
      const moonKm = moonDistanceKmAtMa(t);

      const tide = tidalForcingAtMa(t);
      const rot = rotationProxyAtMa(t);
      const res = resonanceProxyAtMa(t, $("resMode").value);
      const mic = microseismProxyAtMa(t, $("microMode").value);
      const hz  = bandHzAtMa(t);
      const hum = humAmplitudeAtMa(t);

      // normalize for plotting
      const tideN = clamp((tide - 1) / 4, 0, 1);
      const rotN  = clamp((rot  - 1) / 1.5, 0, 1);

      // frequency normalization for plot: relative to microseism max ~0.33 Hz
      const hzN = clamp(hz / 0.33, 0, 1);

      series.push({ t, dayH, moonKm, tide, rot, res, mic, hz, hum, tideN, rotN, hzN });
    }
    return { series, lo, hi, tNow };
  }

  function drawPlot(model){
    const { cssW:W, cssH:H } = resizeCanvas(plotCanvas, plotCtx);
    plotCtx.clearRect(0,0,W,H);

    const padL=54, padR=12, padT=12, padB=28;
    const x0=padL, y0=padT, x1=W-padR, y1=H-padB;

    const xFor = (t)=> x0 + ((t - model.lo) / (model.hi - model.lo || 1)) * (x1-x0);
    const yFor = (v)=> y1 - clamp(v,0,1)*(y1-y0);

    // grid
    plotCtx.strokeStyle = "rgba(148,163,184,0.22)";
    plotCtx.lineWidth = 1;
    plotCtx.fillStyle = "rgba(148,163,184,0.85)";
    plotCtx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

    for (let k=0;k<=4;k++){
      const f = k/4;
      const y = y1 - f*(y1-y0);
      plotCtx.beginPath(); plotCtx.moveTo(x0,y); plotCtx.lineTo(x1,y); plotCtx.stroke();
      plotCtx.fillText(`${f.toFixed(2)}`, 10, y+4);
    }
    plotCtx.fillText("Proxy scale (0..1)", 10, y0-2);

    // x ticks
    const ticks=5;
    for (let i=0;i<=ticks;i++){
      const t = lerp(model.lo, model.hi, i/ticks);
      const x = xFor(t);
      plotCtx.beginPath(); plotCtx.moveTo(x,y1); plotCtx.lineTo(x,y1+6); plotCtx.stroke();
      plotCtx.fillText(`${Math.round(t)} Ma`, x-18, H-6);
    }

    function drawLine(getV, stroke, w=2){
      plotCtx.strokeStyle = stroke;
      plotCtx.lineWidth = w;
      plotCtx.beginPath();
      model.series.forEach((p,idx)=>{
        const x = xFor(p.t);
        const y = yFor(getV(p));
        if (idx===0) plotCtx.moveTo(x,y); else plotCtx.lineTo(x,y);
      });
      plotCtx.stroke();
    }

    // Lines:
    // Hum (green), Tides norm (cyan), Rotation norm (white), Frequency norm (orange)
    drawLine(p=>p.hum,  "rgba(34,197,94,0.95)", 2);
    drawLine(p=>p.tideN,"rgba(56,189,248,0.95)", 2);
    drawLine(p=>p.rotN, "rgba(248,250,252,0.70)", 2);
    drawLine(p=>p.hzN,  "rgba(249,115,22,0.85)", 2);

    // Legend
    plotCtx.fillStyle = "rgba(34,197,94,0.95)"; plotCtx.fillText("Hum", x0, y0+10);
    plotCtx.fillStyle = "rgba(56,189,248,0.95)"; plotCtx.fillText("Tides (norm)", x0+52, y0+10);
    plotCtx.fillStyle = "rgba(248,250,252,0.70)"; plotCtx.fillText("Rotation (norm)", x0+150, y0+10);
    plotCtx.fillStyle = "rgba(249,115,22,0.85)"; plotCtx.fillText("Freq (norm)", x0+280, y0+10);

    // Cursor at tNow
    const xNow = xFor(model.tNow);
    plotCtx.strokeStyle = "rgba(255,255,255,0.55)";
    plotCtx.lineWidth = 1;
    plotCtx.beginPath();
    plotCtx.moveTo(xNow, y0);
    plotCtx.lineTo(xNow, y1);
    plotCtx.stroke();
  }

  // Live wave: frequency is ‚Äúdisplay-scaled‚Äù so very low Hz still animates.
  function hzToDisplayCycles(hz){
    // Map real Hz into cycles across canvas width:
    // - 0.33 Hz -> many cycles
    // - 0.00002 Hz (tide) -> still a slow visible wave
    const hn = clamp(hz / 0.33, 0, 1);
    return 0.6 + 12.0 * hn;
  }

  function drawWave(tMa){
    const { cssW:W, cssH:H } = resizeCanvas(waveCanvas, waveCtx);
    waveCtx.clearRect(0,0,W,H);

    const hum = humAmplitudeAtMa(tMa);
    const hz  = bandHzAtMa(tMa);

    const mid = H/2;
    const amp = (H*0.38) * hum;

    const cycles = hzToDisplayCycles(hz);
    const phase = performance.now() * (0.003 + 0.010*clamp(hz/0.33,0,1));

    // A slow beat modulation (gives living texture)
    const beat = 0.70 + 0.30*Math.sin(performance.now()*0.0012 + tMa*0.3);

    // center line
    waveCtx.strokeStyle = "rgba(148,163,184,0.22)";
    waveCtx.lineWidth = 1;
    waveCtx.beginPath();
    waveCtx.moveTo(0, mid);
    waveCtx.lineTo(W, mid);
    waveCtx.stroke();

    // wave
    waveCtx.strokeStyle = "rgba(34,197,94,0.95)";
    waveCtx.lineWidth = 2;
    waveCtx.beginPath();
    for (let x=0; x<=W; x+=2){
      const u = x / W;
      const y = mid + Math.sin((u*cycles*2*Math.PI) + phase) * amp * beat;
      if (x===0) waveCtx.moveTo(x,y); else waveCtx.lineTo(x,y);
    }
    waveCtx.stroke();

    // glow
    waveCtx.strokeStyle = "rgba(34,197,94,0.20)";
    waveCtx.lineWidth = 6;
    waveCtx.beginPath();
    for (let x=0; x<=W; x+=3){
      const u = x / W;
      const y = mid + Math.sin((u*cycles*2*Math.PI) + phase) * amp * beat;
      if (x===0) waveCtx.moveTo(x,y); else waveCtx.lineTo(x,y);
    }
    waveCtx.stroke();

    $("waveReadout").textContent =
      `Band: ${bandLabel()} | Hz‚âà${fmt(hz, bandHzAtMa(tMa) < 0.01 ? 4 : 3)} | display cycles‚âà${fmt(cycles,2)} | hum=${fmt(hum,3)}`;
  }
</script>
<!-- ======================= PART 5 / 5 ======================= -->
<script>
  // ================= UI + Main Loop =================
  let playing = false;
  let lastTS = null;

  function updateReadouts(tMa){
    const years = yearsFromMa(tMa);
    const dayH = dayLengthHoursAtMa(tMa);
    const moonKm = moonDistanceKmAtMa(tMa);

    const tide = tidalForcingAtMa(tMa);
    const rot  = rotationProxyAtMa(tMa);
    const res  = resonanceProxyAtMa(tMa, $("resMode").value);
    const mic  = microseismProxyAtMa(tMa, $("microMode").value);
    const hz   = bandHzAtMa(tMa);
    const hum  = humAmplitudeAtMa(tMa);

    const tideN = clamp((tide - 1) / 4, 0, 1);
    const rotN  = clamp((rot  - 1) / 1.5, 0, 1);

    $("vTime").textContent = `${fmt(tMa,0)} Ma (${years < 1e6 ? Math.round(years)+" years" : (years/1e6).toFixed(2)+" Myr"})`;
    $("vDay").textContent  = `${fmt(dayH,2)} hours`;
    $("vMoon").textContent = `${fmt(moonKm,0)} km`;
    $("vTide").textContent = `${fmt(tide,3)} (norm ${fmt(tideN,3)})`;
    $("vRot").textContent  = `${fmt(rot,3)} (norm ${fmt(rotN,3)})`;
    $("vRes").textContent  = `${fmt(res,3)}`;
    $("vMicro").textContent= `${fmt(mic,3)}`;
    $("vBand").textContent = bandLabel();
    $("vHz").textContent   = `${fmt(hz, hz < 0.01 ? 4 : 3)} Hz`;
    $("vHum").textContent  = `${fmt(hum,3)}`;

    renderEvidence(tMa);
  }

  function recompute(){
    const tMa = Number($("tMa").value);
    $("tSlider").value = String(clamp(tMa, 0, 4500));
    $("timeReadout").textContent = `t = ${fmt(tMa,0)} Ma`;

    const model = computeSeries();
    drawPlot(model);

    $("plotNote").textContent =
      `Window: ${Math.round(model.lo)} ‚Üí ${Math.round(model.hi)} Ma | driver="${$("driver").value}" | coupling="${$("coupling").value}" | resonance="${$("resMode").value}" | microseism="${$("microMode").value}" | band="${bandLabel()}"`;

    updateReadouts(tMa);
    drawWave(tMa);
  }

  function applyFromSlider(){
    const tMa = Number($("tSlider").value);
    $("tMa").value = String(tMa);
    $("timeReadout").textContent = `t = ${fmt(tMa,0)} Ma`;
    recompute();
  }

  function tick(ts){
    if (!playing){ lastTS = null; return; }
    if (lastTS == null) lastTS = ts;
    const dt = (ts - lastTS) / 1000;
    lastTS = ts;

    const speed = Number($("speed").value || 1);
    const rate = 6 * speed; // Ma/sec
    let t = Number($("tMa").value);
    t += dt * rate;

    if (t > 4500) t = 0;

    $("tMa").value = String(t);
    $("tSlider").value = String(Math.round(t));
    $("timeReadout").textContent = `t = ${fmt(t,0)} Ma`;

    recompute();
    requestAnimationFrame(tick);
  }

  // Buttons
  $("btnApply").addEventListener("click", recompute);
  $("btnPlay").addEventListener("click", ()=>{
    if (!playing){
      playing = true;
      requestAnimationFrame(tick);
    }
  });
  $("btnPause").addEventListener("click", ()=>{ playing = false; });

  // Controls
  $("tSlider").addEventListener("input", applyFromSlider);
  ["driver","coupling","resMode","microMode","band","spanMa","N"].forEach(id=>{
    $(id).addEventListener("change", recompute);
  });

  window.addEventListener("resize", ()=>recompute());

  // Initial
  $("tMa").value = "50";
  $("tSlider").value = "50";
  recompute();
</script>

</body>
</html>
