<!-- ======================= PART 1 / 4 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ice-Core + Station Metadata + Gravity-Hum Monitor</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#020617;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --panel:rgba(15,23,42,0.96);
    --line:rgba(148,163,184,0.28);
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#fb7185;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

  header{
    padding:16px 24px;
    border-bottom:1px solid rgba(148,163,184,0.4);
    background: radial-gradient(circle at top left, #0ea5e9 0, #0f172a 45%, #000 100%);
  }
  header h1{ margin:0 0 4px; font-size:24px; letter-spacing:.04em; }
  header p{ margin:2px 0; font-size:13px; color:#bae6fd; }
  .muted{ color:var(--muted); }
  .mini{ font-size:11px; }

  .container{
    display:grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.6fr);
    gap:16px;
    padding:16px 20px 20px;
  }
  .panel{
    background: radial-gradient(circle at top, rgba(56,189,248,0.14), rgba(15,23,42,0.98));
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 45px rgba(15,23,42,0.9);
    padding:14px 16px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height: 560px;
  }
  .panel h2{
    margin:0;
    font-size:16px;
    font-weight:750;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; }
  .controls label{ color:#bae6fd; font-size:12px; }

  select, input[type="text"], input[type="number"]{
    background: rgba(15,23,42,0.9);
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
    color:var(--ink);
    padding:4px 10px;
    font-size:12px;
    outline:none;
  }
  select:focus, input:focus{
    border-color: var(--accent);
    box-shadow:0 0 0 1px rgba(56,189,248,0.6);
  }

  .btn{
    border-radius:999px;
    padding:6px 10px;
    border:1px solid rgba(148,163,184,0.55);
    background: rgba(2,6,23,0.35);
    color: var(--ink);
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{ border-color: rgba(56,189,248,0.75); }
  .btn.primary{ border-color: rgba(56,189,248,0.85); }

  .status{
    padding:8px 10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.22);
    font-size:12px;
  }
  .status.ok{ border-color: rgba(34,197,94,0.55); }
  .status.warn{ border-color: rgba(245,158,11,0.55); }
  .status.bad{ border-color: rgba(251,113,133,0.55); }

  .scroll{
    max-height: 390px;
    overflow:auto;
    margin:0 -6px -6px;
    padding:0 6px 1px;
  }
  table{ width:100%; border-collapse:collapse; margin-top:6px; font-size:12px; }
  thead{
    position:sticky; top:0;
    background: linear-gradient(to right, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
    z-index:1;
  }
  th, td{
    padding:6px 6px;
    text-align:left;
    border-bottom:1px solid rgba(15,118,110,0.55);
    vertical-align:top;
  }
  th{
    font-weight:750;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
  }
  tbody tr{ cursor:pointer; transition: background .1s ease, transform .08s ease; }
  tbody tr:hover{ background: rgba(56,189,248,0.16); transform: translateY(-0.5px); }
  tbody tr.active-row{
    background: radial-gradient(circle at left, rgba(56,189,248,0.32), rgba(15,23,42,0.95));
  }

  .tag{
    display:inline-flex;
    align-items:center;
    gap:5px;
    padding:1px 8px;
    border-radius:999px;
    font-size:10px;
    border:1px solid rgba(148,163,184,0.85);
    background: rgba(15,23,42,0.72);
    white-space:nowrap;
  }
  .tag-dot{ width:6px; height:6px; border-radius:999px; }
  .tag-ice .tag-dot{ background:#38bdf8; }
  .tag-hum .tag-dot{ background:#22c55e; }
  .tag-scale-global .tag-dot{ background:#f97316; }
  .tag-scale-hemisphere .tag-dot{ background:#22c55e; }
  .tag-scale-regional .tag-dot{ background:#e5e7eb; }

  .coords{ font-family:var(--mono); font-size:11px; color:#bae6fd; }

  .plot-wrap{
    border:1px solid rgba(148,163,184,0.28);
    border-radius:14px;
    padding:10px;
    background: rgba(2,6,23,0.25);
  }
  canvas{ width:100%; height:220px; display:block; }

  .kv{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    font-size:12px;
  }
  .k{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.22);
    background: rgba(2,6,23,0.22);
  }
  .k b{ display:block; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:4px; }
  .k .v{ font-family:var(--mono); font-size:12px; }

  .wavebox{
    border:1px solid rgba(148,163,184,0.22);
    border-radius:14px;
    padding:10px;
    background: rgba(2,6,23,0.22);
  }
  .wavehdr{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .wavehdr .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .readout{ font-family:var(--mono); font-size:12px; color:#bbf7d0; }

  textarea{
    width:100%;
    min-height:120px;
    border-radius:14px;
    padding:10px;
    background:rgba(15,23,42,0.85);
    color:var(--ink);
    border:1px solid rgba(148,163,184,0.5);
    font-family:var(--mono);
    font-size:11px;
    outline:none;
  }

  @media (max-width: 980px){
    .container{ grid-template-columns: minmax(0, 1fr); }
    .panel{ min-height: unset; }
    .scroll{ max-height: 280px; }
    canvas{ height: 200px; }
  }
</style>
</head>

<body>
<header>
  <h1>Ice-Core + Station Metadata + Gravity-Hum Monitor</h1>
  <p>Stations load real metadata (net/sta, lat/lon, start/end). The ‚Äúhum amplitude‚Äù is a <b>physics-inspired proxy</b>; in this version you can drive it by <b>gravity/tidal cycles</b> (Milankovitch-style) rather than CO‚ÇÇ.</p>
  <p class="muted mini">If ‚ÄúLoad Stations‚Äù is blocked (CORS), use Paste Import. The animation and proxy model are purely local.</p>
</header>

<div class="container">
  <section class="panel">
    <h2>üßä + üåä Unified Timeline Items</h2>

    <div class="controls">
      <label>Category:
        <select id="catFilter">
          <option value="all">All</option>
          <option value="ice">Ice-core</option>
          <option value="hum">Stations</option>
        </select>
      </label>

      <label>Search:
        <input type="text" id="searchBox" placeholder="event name, IU, ANMO, site name‚Ä¶" />
      </label>

      <label>Sort:
        <select id="sortMode">
          <option value="olderFirst" selected>Older first (BP)</option>
          <option value="newerFirst">Newer first (BP)</option>
          <option value="name">Name</option>
        </select>
      </label>
    </div>

    <div class="scroll">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Kind</th>
            <th>Scale</th>
            <th>Core / Net.Sta</th>
            <th>Lat</th>
            <th>Age / Date</th>
          </tr>
        </thead>
        <tbody id="eventTableBody"></tbody>
      </table>
    </div>

    <div class="muted mini">Click a row ‚Üí right panel updates details + plot + live wave monitor.</div>
  </section>

  <section class="panel">
    <h2>üß≠ Load Stations + Plot + Live Wave</h2>

    <div class="status warn" id="statusBox">Status: No stations loaded yet.</div>

    <div class="controls">
      <label>Service base:
        <select id="serviceBase">
          <option value="https://service.earthscope.org/fdsnws/station/1/query" selected>EarthScope</option>
          <option value="https://service.iris.edu/fdsnws/station/1/query">Legacy IRIS</option>
        </select>
      </label>

      <label>net: <input type="text" id="netCode" value="IU" style="width:70px" /></label>
      <label>sta: <input type="text" id="staCode" value="ANMO" style="width:90px" /></label>

      <label>level:
        <select id="levelMode">
          <option value="station" selected>station</option>
          <option value="channel">channel (many rows)</option>
        </select>
      </label>

      <button class="btn primary" id="btnLoadStations">Load Stations</button>
      <button class="btn" id="btnClearStations">Clear Stations</button>
    </div>

    <div class="controls">
      <label>starttime: <input type="text" id="startTime" placeholder="2010-01-01" style="width:150px" /></label>
      <label>endtime: <input type="text" id="endTime" placeholder="2020-12-31" style="width:150px" /></label>
      <label>Limit: <input type="number" id="limit" value="200" min="1" max="20000" step="50" style="width:90px" /></label>
    </div>

    <div class="controls" style="gap:10px;">
      <button class="btn" id="btnPasteToggle">Paste Station Text</button>
      <button class="btn" id="btnUseExample">Use Example Stations</button>
    </div>

    <div id="pasteWrap" style="display:none;">
      <div class="muted mini" style="margin:6px 0 4px;">
        Paste <b>format=text</b> output here (station or channel). Import will dedupe by <b>net.sta</b>.
      </div>
      <textarea id="pasteBox"></textarea>
      <div class="controls" style="margin-top:8px;">
        <button class="btn primary" id="btnImportPasted">Import Pasted Text</button>
      </div>
    </div>

    <div class="controls" style="margin-top:8px;">
      <label>Plot window (years BP):
        <input type="number" id="winStart" value="14000" min="0" step="100" style="width:110px" />
        ‚Üí
        <input type="number" id="winEnd" value="0" min="-200" step="10" style="width:110px" />
      </label>

      <label>Hum driver:
        <select id="humMode">
          <option value="gravity" selected>Gravity-linked (tides/orbital cycles)</option>
          <option value="climate">Climate-linked (CO‚ÇÇ toy)</option>
          <option value="storms">Storm/microseism (toy)</option>
          <option value="flat">Constant (control)</option>
        </select>
      </label>

      <label>Coupling:
        <select id="humCoupling">
          <option value="low">Low</option>
          <option value="med">Medium</option>
          <option value="high" selected>High</option>
        </select>
      </label>

      <button class="btn primary" id="btnRecompute">Recompute Plot</button>
      <button class="btn" id="btnExport">Export plot CSV</button>
    </div>

    <div class="plot-wrap">
      <canvas id="plot"></canvas>
      <div class="muted mini" id="plotNote" style="margin-top:6px;">‚Äî</div>
    </div>

    <div class="wavebox">
      <div class="wavehdr">
        <div class="left">
          <button class="btn primary" id="btnPlay">Play</button>
          <button class="btn" id="btnPause">Pause</button>
          <label>Speed:
            <select id="playSpeed">
              <option value="0.25">0.25√ó</option>
              <option value="0.5">0.5√ó</option>
              <option value="1" selected>1√ó</option>
              <option value="2">2√ó</option>
              <option value="4">4√ó</option>
            </select>
          </label>
        </div>
        <div class="readout" id="waveReadout">Year: ‚Äî | Hum: ‚Äî</div>
      </div>
      <canvas id="wave"></canvas>
      <div class="muted mini" style="margin-top:6px;">
        Live waveform whose amplitude follows the proxy hum at the current year cursor.
      </div>
    </div>

    <div class="kv">
      <div class="k"><b>Selected</b><div class="v" id="selName">‚Äî</div></div>
      <div class="k"><b>Selected age/date</b><div class="v" id="selAge">‚Äî</div></div>
      <div class="k"><b>Latitude band</b><div class="v" id="selBand">‚Äî</div></div>
      <div class="k"><b>Core / Net.Sta</b><div class="v" id="selSite">‚Äî</div></div>
    </div>

    <div id="detailsContent" style="margin-top:8px;">
      <p class="muted">Select an item on the left to see details.</p>
    </div>

  </section>
</div>
<!-- ======================= PART 2 / 4 ======================= -->
<script>
  // ================= Helpers =================
  const $ = (id)=>document.getElementById(id);
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function lerp(a,b,t){ return a + (b-a)*t; }

  function latBand(lat){
    const a = Math.abs(lat);
    if (a < 10) return "Equatorial (0‚Äì10¬∞)";
    if (a < 23.5) return "Tropical (10‚Äì23.5¬∞)";
    if (a < 40) return "Subtropical (23.5‚Äì40¬∞)";
    if (a < 60) return "Mid-latitudes (40‚Äì60¬∞)";
    return "High-latitude / polar (60¬∞+)";
  }
  function bpMid(ageRangeBP){
    if (!ageRangeBP || ageRangeBP.length < 2) return null;
    return (ageRangeBP[0] + ageRangeBP[1]) / 2;
  }

  // ‚úÖ years BP = years before 1950.
  // After 1950 -> negative BP. Before 1950 -> positive BP.
  function isoToBP(iso){
    if (!iso) return null;
    const d = new Date(iso);
    if (!isFinite(d.getTime())) return null;
    const base = Date.UTC(1950,0,1);
    const years = (base - d.getTime()) / (1000*60*60*24*365.2425);
    return years;
  }

  function setStatus(kind, msg){
    const box = $("statusBox");
    box.className = "status " + (kind || "warn");
    box.textContent = "Status: " + msg;
  }

  // ================= Ice-core dataset =================
  const iceItems = [
    { id:"mpt", kind:"ice", name:"Mid-Pleistocene Transition (41k ‚Üí 100k yr cycles)", scale:"Global",
      siteName:"Antarctica ‚Äî Dome C / Little Dome C", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà1,200,000 ‚Äì 900,000 years BP", ageRangeBP:[1200000, 900000],
      tempChangeText:"Shift to larger, colder glacials; ~100k-year dominance.",
      greenhouseInfo:"CO‚ÇÇ baseline/amplitude changes; stronger dust/ice/CO‚ÇÇ feedbacks.",
      notes:"Deep Antarctic cores show long-cycle shift clearly."
    },
    { id:"toba", kind:"ice", name:"Toba era (context marker; debated global impact)", scale:"Global",
      siteName:"Antarctica + Greenland (tephra context)", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà74,000 years BP", ageRangeBP:[75000, 73000],
      tempChangeText:"Short-term volcanic cooling plausible; regional signals vary.",
      greenhouseInfo:"CO‚ÇÇ remains glacial-range; volcanic aerosols dominate short-term forcing.",
      notes:"Used as a reference marker in some paleoclimate discussions."
    },
    { id:"heinrich1", kind:"ice", name:"Heinrich Stadial 1 (ice-rafting interval)", scale:"Hemisphere",
      siteName:"North Atlantic + Greenland cores", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà17,500 ‚Äì 14,700 years BP", ageRangeBP:[17500, 14700],
      tempChangeText:"Cold North Atlantic conditions; impacts on AMOC/monsoon patterns.",
      greenhouseInfo:"CO‚ÇÇ low-to-rising toward deglaciation.",
      notes:"Often linked to large meltwater/iceberg discharge episodes."
    },
    { id:"ba", kind:"ice", name:"B√∏lling‚ÄìAller√∏d warming (abrupt deglacial warm phase)", scale:"Hemisphere",
      siteName:"Greenland ‚Äî GRIP/GISP2/NGRIP", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà14,700 ‚Äì 12,900 years BP", ageRangeBP:[14700, 12900],
      tempChangeText:"Rapid warming in Greenland; widespread NH effects.",
      greenhouseInfo:"CO‚ÇÇ rising through deglaciation.",
      notes:"Classic abrupt warming interval before Younger Dryas."
    },
    { id:"yd", kind:"ice", name:"Younger Dryas (abrupt return to cold)", scale:"Hemisphere",
      siteName:"Greenland + North Atlantic region", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà12,900 ‚Äì 11,700 years BP", ageRangeBP:[12900, 11700],
      tempChangeText:"Sharp cooling in the North Atlantic; termination is abrupt.",
      greenhouseInfo:"CO‚ÇÇ continues gradual rise; regional circulation dominates temperature.",
      notes:"Benchmark deglacial ‚Äòcold reversal‚Äô."
    },
    { id:"lgm", kind:"ice", name:"Last Glacial Maximum (LGM)", scale:"Global",
      siteName:"Antarctica ‚Äî Dome C; Greenland summit cores", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà26,000 ‚Äì 19,000 years BP", ageRangeBP:[26000, 19000],
      tempChangeText:"Global mean ‚âà4‚Äì7 ¬∞C colder than today.",
      greenhouseInfo:"CO‚ÇÇ ‚âà180‚Äì190 ppm (glacial).",
      notes:"Cold/dusty interval in both Greenland and Antarctic."
    },
    { id:"82ka", kind:"ice", name:"8.2 ka cold event", scale:"Hemisphere",
      siteName:"Greenland ‚Äî GRIP/GISP2/NGRIP", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà8,200 years BP (~150‚Äì200 years)", ageRangeBP:[8300, 8000],
      tempChangeText:"NH cooling ~1‚Äì3 ¬∞C; stronger in Greenland.",
      greenhouseInfo:"Small wiggles in gases; strong isotope/temperature signal.",
      notes:"Benchmark abrupt Holocene event."
    },
    { id:"42ka", kind:"ice", name:"4.2 ka event (widespread aridity/cooling marker)", scale:"Regional",
      siteName:"Multiple proxies (regional)", siteLat:30.0, siteLon:31.0,
      dateText:"‚âà4,200 years BP", ageRangeBP:[4250, 4050],
      tempChangeText:"Regional drying/cooling signals in several records.",
      greenhouseInfo:"CO‚ÇÇ near preindustrial background.",
      notes:"Often used as a climatic marker in archaeological/climate synthesis."
    },
    { id:"lia", kind:"ice", name:"Little Ice Age (multi-centennial)", scale:"Hemisphere",
      siteName:"Greenland, Arctic & Alpine glaciers", siteLat:72.6, siteLon:-38.5,
      dateText:"‚âà1300 ‚Äì 1850 CE", ageRangeBP:[650, 100],
      tempChangeText:"NH cooling ~0.5‚Äì1 ¬∞C vs 20th century.",
      greenhouseInfo:"CO‚ÇÇ near preindustrial until late period.",
      notes:"Volcanic sulfate clusters + lower solar output periods."
    },
    { id:"tambora", kind:"ice", name:"Tambora era (volcanic sulfate peak; ‚ÄòYear Without a Summer‚Äô context)", scale:"Hemisphere",
      siteName:"Greenland & Antarctic sulfate layers", siteLat:-75.1, siteLon:123.3,
      dateText:"‚âà1815‚Äì1816 CE", ageRangeBP:[135, 134],
      tempChangeText:"Short-term cooling in NH; strong aerosol forcing.",
      greenhouseInfo:"CO‚ÇÇ still preindustrial-range.",
      notes:"Useful as a sharp marker in recent ice stratigraphy."
    },
    { id:"modern", kind:"ice", name:"Modern rapid warming", scale:"Global",
      siteName:"Atmosphere + recent ice layers", siteLat:0.0, siteLon:0.0,
      dateText:"‚âà1950 CE ‚Äì present", ageRangeBP:[0, -75],
      tempChangeText:"~1.2‚Äì1.3 ¬∞C above 1850‚Äì1900; extremely rapid.",
      greenhouseInfo:"CO‚ÇÇ >420 ppm; very high vs long ice-core record.",
      notes:"Modern gases exceed long ice-core ranges."
    }
  ];

  let stationItems = [];
  function allItems(){ return [...iceItems, ...stationItems]; }

  // ================= UI refs =================
  const tbody = $("eventTableBody");
  const detailsContent = $("detailsContent");
  const catFilter = $("catFilter");
  const searchBox = $("searchBox");
  const sortMode = $("sortMode");
  let selectedId = null;

  function tagHTML(kind){
    return kind === "ice"
      ? `<span class="tag tag-ice"><span class="tag-dot"></span><span>Ice-core</span></span>`
      : `<span class="tag tag-hum"><span class="tag-dot"></span><span>Station</span></span>`;
  }
  function scaleTagHTML(scale){
    const cls = scale === "Global" ? "tag tag-scale-global" : (scale === "Hemisphere" ? "tag tag-scale-hemisphere" : "tag tag-scale-regional");
    return `<span class="${cls}"><span class="tag-dot"></span><span>${scale}</span></span>`;
  }

  function renderTable(){
    const cat = catFilter.value;
    const q = (searchBox.value || "").toLowerCase();
    const mode = sortMode.value;

    let list = allItems().filter(it=>{
      if (cat !== "all" && it.kind !== cat) return false;
      if (!q) return true;
      const hay = (it.name + " " + (it.siteName||"") + " " + (it.netSta||"") + " " + (it.notes||"")).toLowerCase();
      return hay.includes(q);
    });

    list.sort((a,b)=>{
      if (mode === "name") return a.name.localeCompare(b.name);
      const am = bpMid(a.ageRangeBP), bm = bpMid(b.ageRangeBP);
      if (am == null && bm == null) return 0;
      if (am == null) return 1;
      if (bm == null) return -1;
      return (mode === "olderFirst") ? (bm - am) : (am - bm);
    });

    tbody.innerHTML = "";
    list.forEach(it=>{
      const tr = document.createElement("tr");
      tr.dataset.id = it.id;
      if (it.id === selectedId) tr.classList.add("active-row");

      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${tagHTML(it.kind)}</td>
        <td>${scaleTagHTML(it.scale || "Regional")}</td>
        <td>${it.kind === "hum" ? (it.netSta || "‚Äî") : (String(it.siteName||"‚Äî").split("‚Äî")[0].trim())}</td>
        <td>${(it.siteLat ?? 0).toFixed(2)}</td>
        <td>${it.dateText || "‚Äî"}</td>
      `;

      tr.addEventListener("click", ()=>{
        selectedId = it.id;
        document.querySelectorAll("#eventTableBody tr").forEach(r=>r.classList.remove("active-row"));
        tr.classList.add("active-row");
        renderDetails(it);
        if (typeof recomputeAndPlot === "function") recomputeAndPlot();
      });

      tbody.appendChild(tr);
    });

    if (!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="6">No items match.</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderDetails(it){
    $("selName").textContent = it.name || "‚Äî";
    $("selAge").textContent = it.dateText || "‚Äî";
    $("selBand").textContent = it.siteLat != null ? `${latBand(it.siteLat)} ¬∑ ${(it.siteLat>=0?"Northern":"Southern")}` : "‚Äî";
    $("selSite").textContent = it.kind === "hum" ? (it.netSta || "‚Äî") : (it.siteName || "‚Äî");

    if (it.kind === "ice"){
      detailsContent.innerHTML = `
        <div class="coords">Core/Proxy: ${it.siteName} ‚Äî Lat ${it.siteLat.toFixed(4)}¬∞, Lon ${it.siteLon.toFixed(4)}¬∞</div>
        <div class="muted mini" style="margin-top:8px;"><b>Temperature:</b> ${it.tempChangeText || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Gases:</b> ${it.greenhouseInfo || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Notes:</b> ${it.notes || "‚Äî"}</div>
      `;
    } else {
      detailsContent.innerHTML = `
        <div class="coords">Station: ${it.netSta} ‚Äî Lat ${it.siteLat.toFixed(4)}¬∞, Lon ${it.siteLon.toFixed(4)}¬∞, Elev ${(it.elev ?? 0).toFixed(1)} m</div>
        <div class="muted mini" style="margin-top:8px;"><b>Site name:</b> ${it.siteName || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Operating:</b> ${it.startISO || "‚Äî"} ‚Üí ${it.endISO || "‚Äî"}</div>
        <div class="muted mini" style="margin-top:6px;"><b>Note:</b> Metadata is real. Hum is a physics-inspired proxy driver (gravity / climate / storms).</div>
      `;
    }
  }

  catFilter.addEventListener("change", renderTable);
  searchBox.addEventListener("input", renderTable);
  sortMode.addEventListener("change", renderTable);
</script>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
  // ================= Station loading/parsing =================
  function buildStationURL(){
    const base = $("serviceBase").value.trim();
    const net = encodeURIComponent(($("netCode").value || "").trim() || "*");
    const sta = encodeURIComponent(($("staCode").value || "").trim() || "*");
    const level = encodeURIComponent(($("levelMode").value || "station").trim());
    const limit = encodeURIComponent(String(Math.max(1, Number($("limit").value || 200))));
    const start = ($("startTime").value || "").trim();
    const end = ($("endTime").value || "").trim();

    const params = new URLSearchParams();
    params.set("net", net);
    params.set("sta", sta);
    params.set("level", level);
    params.set("format", "text");
    params.set("nodata", "404");
    params.set("limit", limit);
    if (start) params.set("starttime", start);
    if (end) params.set("endtime", end);
    return base + "?" + params.toString();
  }

  // Robust parser for station OR channel rows:
  function parseStationText(text){
    const lines = String(text || "").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const rows = [];
    for (const line of lines){
      if (!line || line.startsWith("#")) continue;

      const parts = line.includes("|") ? line.split("|").map(x=>x.trim()) : line.split(/\s+/);
      if (parts.length < 5) continue;

      const net = parts[0] || "";
      const sta = parts[1] || "";
      const lat = Number(parts[2]);
      const lon = Number(parts[3]);
      const elev = Number(parts[4]);

      if (!net || !sta || !isFinite(lat) || !isFinite(lon)) continue;

      const siteName = parts[5] || "";

      // Accept either full ISO (with T) or YYYY-MM-DD
      const isoLike = parts.filter(p => (
        /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(p) ||
        /^\d{4}-\d{2}-\d{2}$/.test(p)
      ));
      const startISO = isoLike[0] || "";
      const endISO = isoLike[1] || "";

      rows.push({ net, sta, lat, lon, elev: isFinite(elev)?elev:null, siteName, startISO, endISO });
    }
    return rows;
  }

  function rowsToStationItems(rows){
    // ‚úÖ Dedup by netSta so channel rows don't create duplicates
    const byKey = new Map();
    for (const r of rows){
      const key = `${r.net}.${r.sta}`;
      if (!byKey.has(key)) byKey.set(key, r);
    }

    const out = [];
    for (const [netSta, r] of byKey.entries()){
      const startBP = isoToBP(r.startISO);
      const endBP = isoToBP(r.endISO) ?? isoToBP(new Date().toISOString());

      const a = (startBP==null ? 0 : startBP);
      const b = (endBP==null ? -10 : endBP);
      const older = Math.max(a,b);
      const newer = Math.min(a,b);

      out.push({
        id: `sta_${r.net}_${r.sta}`,
        kind:"hum",
        name:`Station ${netSta} (metadata)`,
        scale:"Regional",
        netSta,
        siteName: r.siteName || netSta,
        siteLat: r.lat,
        siteLon: r.lon,
        elev: r.elev,
        startISO: r.startISO || "‚Äî",
        endISO: r.endISO || "‚Äî",
        dateText: `${r.startISO || "?"} ‚Üí ${r.endISO || "?"}`,
        ageRangeBP: [older, newer],
        notes:"Loaded/imported from FDSN Station service (format=text)."
      });
    }
    return out;
  }

  async function loadStationsOnline(){
    const url = buildStationURL();
    setStatus("warn", "Loading station metadata‚Ä¶");
    try{
      const res = await fetch(url, { method:"GET" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const text = await res.text();

      const parsedRows = parseStationText(text);
      const dedupItems = rowsToStationItems(parsedRows);

      const before = new Set(stationItems.map(s=>s.netSta));
      let added = 0;
      for (const it of dedupItems){
        if (!before.has(it.netSta)){
          stationItems.push(it);
          before.add(it.netSta);
          added++;
        }
      }

      setStatus("ok", `Parsed rows: ${parsedRows.length} | Stations added: ${added} | Total stations: ${stationItems.length}`);
      renderTable();

      if (!selectedId && stationItems.length){
        selectedId = stationItems[0].id;
        renderDetails(stationItems[0]);
      }
      if (typeof recomputeAndPlot === "function") recomputeAndPlot();
    }catch(err){
      setStatus("bad", `Load failed (${String(err.message || err)}). If CORS, use Paste Import.`);
    }
  }

  function clearStations(){
    stationItems = [];
    setStatus("warn", "Cleared stations. Total stations: 0");
    renderTable();
    if (typeof recomputeAndPlot === "function") recomputeAndPlot();
  }

  function useExampleStations(){
    const example = `
#Network|Station|Latitude|Longitude|Elevation|SiteName|StartTime|EndTime
IU|ANMO|34.9459|-106.4572|1850.0|Albuquerque, New Mexico, USA|1989-01-01T00:00:00|2599-12-31T23:59:59
IU|COLA|64.8736|-147.8616|200.0|College Outpost, Alaska, USA|1990-01-01T00:00:00|2599-12-31T23:59:59
IU|KONO|59.6490|9.5980|216.0|Kongsberg, Norway|1991-01-01T00:00:00|2599-12-31T23:59:59
`;
    const parsedRows = parseStationText(example);
    stationItems = rowsToStationItems(parsedRows);
    setStatus("ok", `Parsed rows: ${parsedRows.length} | Stations added: ${stationItems.length} | Total stations: ${stationItems.length}`);
    renderTable();
    selectedId = stationItems[0]?.id || iceItems[0].id;
    renderDetails(allItems().find(x=>x.id===selectedId) || iceItems[0]);
    if (typeof recomputeAndPlot === "function") recomputeAndPlot();
  }

  $("btnLoadStations").addEventListener("click", loadStationsOnline);
  $("btnClearStations").addEventListener("click", clearStations);
  $("btnUseExample").addEventListener("click", useExampleStations);

  $("btnPasteToggle").addEventListener("click", ()=>{
    const w = $("pasteWrap");
    w.style.display = (w.style.display === "none") ? "block" : "none";
  });

  $("btnImportPasted").addEventListener("click", ()=>{
    const text = $("pasteBox").value || "";
    const parsedRows = parseStationText(text);
    const dedupItems = rowsToStationItems(parsedRows);

    const before = new Set(stationItems.map(s=>s.netSta));
    let added = 0;
    for (const it of dedupItems){
      if (!before.has(it.netSta)){
        stationItems.push(it);
        before.add(it.netSta);
        added++;
      }
    }
    setStatus("ok", `Parsed rows: ${parsedRows.length} | Stations added: ${added} | Total stations: ${stationItems.length}`);
    renderTable();
    if (typeof recomputeAndPlot === "function") recomputeAndPlot();
  });

  // ===== Initial render + default selection =====
  catFilter.value = "all";
  renderTable();
  selectedId = "mpt";
  renderDetails(iceItems.find(x=>x.id==="mpt") || iceItems[0]);
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
  // ==========================================================
  // HUM MODEL (checked & upgraded)
  //
  // Your old code: hum ‚âà CO2-driven + tiny rotation term.
  // New code: adds a GRAVITY driver:
  //   - Milankovitch-style cycles (100k, 41k, 23k years)
  //   - Long tidal-friction drift term (very slow trend)
  //   - Optional storm spikiness mode
  //
  // IMPORTANT: This remains a "proxy" (not measured ocean acoustics).
  // But it aligns with the idea: gravity ‚Üí tides/energy injection ‚Üí broad ocean ‚Äúhum‚Äù.
  // ==========================================================

  function co2StateForIce(it){
    const id = it.id;
    if (id === "lgm") return 190;
    if (id === "82ka") return 265;
    if (id === "lia") return 280;
    if (id === "tambora") return 280;
    if (id === "modern") return 420;
    if (id === "mpt") return 240;
    if (id === "yd") return 240;
    if (id === "ba") return 250;
    if (id === "heinrich1") return 210;
    if (id === "toba") return 210;
    if (id === "42ka") return 275;
    return 280;
  }

  function getCoupling(){
    const c = $("humCoupling").value;
    if (c === "low") return 0.20;
    if (c === "high") return 0.70;
    return 0.40;
  }

  function anchorsInWindow(startBP, endBP){
    const a = iceItems
      .map(it=>({ bp: bpMid(it.ageRangeBP), co2: co2StateForIce(it) }))
      .filter(p=>p.bp != null)
      .filter(p=>p.bp <= startBP && p.bp >= endBP)
      .sort((x,y)=> y.bp - x.bp);

    if (a.length >= 2) return a;

    const all = iceItems
      .map(it=>({ bp: bpMid(it.ageRangeBP), co2: co2StateForIce(it) }))
      .filter(p=>p.bp != null)
      .sort((x,y)=> y.bp - x.bp);

    const target = (startBP + endBP)/2;
    all.sort((x,y)=> Math.abs(x.bp-target)-Math.abs(y.bp-target));
    return all.slice(0, Math.min(4, all.length)).sort((x,y)=> y.bp - x.bp);
  }

  function interpCO2(bp, anchors){
    if (!anchors.length) return 280;
    if (anchors.length === 1) return anchors[0].co2;

    for (let i=0;i<anchors.length-1;i++){
      const A = anchors[i], B = anchors[i+1];
      if (bp <= A.bp && bp >= B.bp){
        const t = (A.bp === B.bp) ? 0 : ((A.bp - bp)/(A.bp - B.bp));
        return lerp(A.co2, B.co2, clamp(t,0,1));
      }
    }
    if (bp > anchors[0].bp) return anchors[0].co2;
    return anchors[anchors.length-1].co2;
  }

  function pseudoNoise(x){
    const s = Math.sin(x*12.9898) * 43758.5453;
    return s - Math.floor(s);
  }

  // --- Gravity / tide proxy (physics-inspired, still simplified) ---
  // bp in years before 1950. Use it as "time" for cycles.
  function gravityTideProxy(bp){
    // cycles: eccentricity (~100k), obliquity (~41k), precession (~23k)
    const t = bp; // years
    const ecc = 0.55 + 0.45 * Math.sin((2*Math.PI * t) / 100000);
    const obl = 0.55 + 0.45 * Math.sin((2*Math.PI * t) / 41000 + 1.1);
    const pre = 0.55 + 0.45 * Math.sin((2*Math.PI * t) / 23000 + 2.2);

    // long drift: tidal friction / ocean-basin reorg proxy (very slow, low amplitude)
    // scaled so 0..1 over ~2 million years (clamped)
    const drift = clamp((Math.max(0, bp) / 2_000_000), 0, 1); // older -> bigger
    const slow = 0.65 - 0.25*drift; // slightly decreasing toward older times (toy)

    // combine, then normalize-ish
    const g = (0.42*ecc + 0.33*obl + 0.25*pre) * slow;
    return clamp(g, 0, 1);
  }

  // Return hum proxy at a single BP (used for plot and live wave)
  function humAtBP(bp, co2, mode, coupling){
    const co2Norm = clamp((co2 - 180) / (420 - 180), 0, 1);
    const g = gravityTideProxy(bp);

    // base: always some background ‚Äúocean noise floor‚Äù
    const base = 0.28 + 0.10*g;

    let hum;
    if (mode === "flat"){
      hum = 0.50;
    } else if (mode === "storms"){
      // storm/microseism: heavy-tailed spikes + mild gravity modulation
      const n = pseudoNoise(bp/75);
      const spikes = Math.pow(n, 8);
      hum = base + 0.18*coupling*g + 0.12*coupling*co2Norm + 0.40*spikes;
    } else if (mode === "climate"){
      // climate: CO2 drives, gravity slightly modulates
      const wig = (pseudoNoise(bp/120) - 0.5) * 0.06;
      hum = base + coupling*(0.34*co2Norm + 0.10*g) + wig;
    } else {
      // gravity (default): gravity drives, CO2 only slightly modulates
      const wig = (pseudoNoise(bp/160) - 0.5) * 0.04;
      hum = base + coupling*(0.48*g + 0.06*co2Norm) + wig;
    }
    return clamp(hum, 0, 1);
  }

  // ================= Plot + Live Wave Animation =================
  const plotCanvas = $("plot");
  const plotCtx = plotCanvas.getContext("2d");
  const waveCanvas = $("wave");
  const waveCtx = waveCanvas.getContext("2d");

  function resizeCanvas(c, ctx){
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();

    // ‚úÖ Fix: avoid 0√ó0 at load/layout moments
    const cssW = Math.max(320, Math.floor(rect.width || 320));
    const cssH = Math.max(160, Math.floor(rect.height || 160));

    c.width = Math.floor(cssW * dpr);
    c.height = Math.floor(cssH * dpr);

    // draw in CSS pixels
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { cssW, cssH };
  }

  function computeSeries(){
    const startBP = Number($("winStart").value);
    const endBP = Number($("winEnd").value);

    // keep sane ordering and allow negative BP
    const lo = Math.max(endBP, -500);
    const hi = Math.max(startBP, lo+1);

    const N = 420;
    const anchors = anchorsInWindow(hi, lo);
    const coupling = getCoupling();
    const mode = $("humMode").value;

    const series = [];
    for (let i=0;i<N;i++){
      const t = i/(N-1);
      const bp = lerp(hi, lo, t);
      const co2 = interpCO2(bp, anchors);
      const hum = humAtBP(bp, co2, mode, coupling);
      series.push({ bp, co2, hum, g: gravityTideProxy(bp) });
    }
    return { series, anchors, startBP:hi, endBP:lo, mode, couplingLabel:$("humCoupling").value };
  }

  function drawPlot(model){
    const { cssW:W, cssH:H } = resizeCanvas(plotCanvas, plotCtx);
    plotCtx.clearRect(0,0,W,H);

    const padL = 44, padR = 10, padT = 12, padB = 24;
    const x0 = padL, y0 = padT, x1 = W - padR, y1 = H - padB;

    const xFor = (bp)=> x0 + ((model.startBP - bp) / (model.startBP - model.endBP)) * (x1 - x0);
    const yCO2 = (co2)=> y1 - clamp((co2 - 180)/(420-180),0,1) * (y1 - y0);
    const yHum = (h)=> y1 - clamp(h,0,1) * (y1 - y0);

    // grid
    plotCtx.lineWidth = 1;
    plotCtx.strokeStyle = "rgba(148,163,184,0.22)";
    plotCtx.fillStyle = "rgba(148,163,184,0.85)";
    plotCtx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

    for (let k=0;k<=4;k++){
      const frac = k/4;
      const y = y1 - frac*(y1-y0);
      plotCtx.beginPath(); plotCtx.moveTo(x0, y); plotCtx.lineTo(x1, y); plotCtx.stroke();
      plotCtx.fillText(`${(180 + frac*(420-180)).toFixed(0)} ppm CO‚ÇÇ / ${frac.toFixed(2)} hum`, 6, y+4);
    }

    const ticks = 5;
    for (let i=0;i<=ticks;i++){
      const bp = lerp(model.startBP, model.endBP, i/ticks);
      const x = xFor(bp);
      plotCtx.beginPath(); plotCtx.moveTo(x, y1); plotCtx.lineTo(x, y1+6); plotCtx.stroke();
      const txt = (bp>=0 ? Math.round(bp)+" BP" : (Math.round(-bp)+" yrs after 1950"));
      plotCtx.fillText(txt, x-24, H-6);
    }

    // CO2 line
    plotCtx.lineWidth = 2;
    plotCtx.strokeStyle = "rgba(56,189,248,0.95)";
    plotCtx.beginPath();
    model.series.forEach((p,idx)=>{
      const x = xFor(p.bp), y = yCO2(p.co2);
      if (idx===0) plotCtx.moveTo(x,y); else plotCtx.lineTo(x,y);
    });
    plotCtx.stroke();

    // Hum line
    plotCtx.lineWidth = 2;
    plotCtx.strokeStyle = "rgba(34,197,94,0.95)";
    plotCtx.beginPath();
    model.series.forEach((p,idx)=>{
      const x = xFor(p.bp), y = yHum(p.hum);
      if (idx===0) plotCtx.moveTo(x,y); else plotCtx.lineTo(x,y);
    });
    plotCtx.stroke();

    // anchors
    plotCtx.fillStyle = "rgba(56,189,248,0.95)";
    model.anchors.forEach(a=>{
      const x = xFor(a.bp), y = yCO2(a.co2);
      plotCtx.beginPath(); plotCtx.arc(x,y,3,0,Math.PI*2); plotCtx.fill();
    });

    return { xFor, y0, y1, W, H };
  }

  // ================= Live Wave Animation =================
  let playing = false;
  let cursorT = 0;          // 0..1 position across window
  let lastTS = null;

  function drawWave(model, cursorBP){
    const { cssW:W, cssH:H } = resizeCanvas(waveCanvas, waveCtx);
    waveCtx.clearRect(0,0,W,H);

    const co2 = interpCO2(cursorBP, model.anchors);
    const g = gravityTideProxy(cursorBP);
    const hum = humAtBP(cursorBP, co2, model.mode, getCoupling());

    const yearLabel = (cursorBP >= 0)
      ? `${Math.round(cursorBP)} BP`
      : `${Math.round(-cursorBP)} yrs after 1950`;

    $("waveReadout").textContent =
      `Year: ${yearLabel} | Hum: ${hum.toFixed(3)} | Grav: ${g.toFixed(3)} | CO‚ÇÇ: ${co2.toFixed(0)} ppm`;

    const mid = H/2;
    const amp = (H*0.40) * hum;
    const freq = 2 + 10*hum;
    const phase = performance.now() * 0.006;

    waveCtx.strokeStyle = "rgba(148,163,184,0.22)";
    waveCtx.lineWidth = 1;
    waveCtx.beginPath();
    waveCtx.moveTo(0, mid);
    waveCtx.lineTo(W, mid);
    waveCtx.stroke();

    waveCtx.strokeStyle = "rgba(34,197,94,0.95)";
    waveCtx.lineWidth = 2;
    waveCtx.beginPath();
    for (let x=0; x<=W; x+=2){
      const t = x / W;
      const y = mid + Math.sin((t*freq*2*Math.PI) + phase) * amp * (0.75 + 0.25*Math.sin(phase*0.6));
      if (x===0) waveCtx.moveTo(x,y); else waveCtx.lineTo(x,y);
    }
    waveCtx.stroke();

    waveCtx.strokeStyle = "rgba(34,197,94,0.25)";
    waveCtx.lineWidth = 6;
    waveCtx.beginPath();
    for (let x=0; x<=W; x+=3){
      const t = x / W;
      const y = mid + Math.sin((t*freq*2*Math.PI) + phase) * amp;
      if (x===0) waveCtx.moveTo(x,y); else waveCtx.lineTo(x,y);
    }
    waveCtx.stroke();
  }

  // IMPORTANT: must exist globally (PART 1 calls it)
  function recomputeAndPlot(){
    const model = computeSeries();
    const plotGeom = drawPlot(model);

    $("plotNote").textContent =
      `Window: ${model.startBP} ‚Üí ${model.endBP} BP | Hum driver="${model.mode}" | Coupling="${model.couplingLabel}" | Stations loaded: ${stationItems.length}`;

    const cursorBP = lerp(model.startBP, model.endBP, clamp(cursorT,0,1));
    drawWave(model, cursorBP);

    // cursor line
    const padT = 12, padB = 24;
    const y0 = padT, y1 = plotGeom.H - padB;
    const x = plotGeom.xFor(cursorBP);

    plotCtx.strokeStyle = "rgba(248,250,252,0.70)";
    plotCtx.lineWidth = 1;
    plotCtx.beginPath();
    plotCtx.moveTo(x, y0);
    plotCtx.lineTo(x, y1);
    plotCtx.stroke();
  }

  function tick(ts){
    if (!playing){ lastTS = null; return; }
    if (lastTS == null) lastTS = ts;
    const dt = (ts - lastTS) / 1000;
    lastTS = ts;

    const speed = Number($("playSpeed").value || 1);
    cursorT += dt * 0.05 * speed;
    if (cursorT > 1) cursorT -= 1;

    recomputeAndPlot();
    requestAnimationFrame(tick);
  }

  $("btnPlay").addEventListener("click", ()=>{
    if (!playing){
      playing = true;
      requestAnimationFrame(tick);
    }
  });
  $("btnPause").addEventListener("click", ()=>{ playing = false; });

  $("btnRecompute").addEventListener("click", ()=>recomputeAndPlot());

  $("btnExport").addEventListener("click", ()=>{
    const model = computeSeries();
    const head = "bp_years,co2_ppm_proxy,gravity_proxy,hum_amp_proxy\n";
    const rows = model.series.map(p=>`${p.bp.toFixed(2)},${p.co2.toFixed(2)},${p.g.toFixed(6)},${p.hum.toFixed(6)}`).join("\n");
    const csv = head + rows + "\n";
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "icecore_gravity_hum_proxy_plot.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // recompute when controls change (prevents ‚Äúnothing updates‚Äù feeling)
  $("humMode").addEventListener("change", recomputeAndPlot);
  $("humCoupling").addEventListener("change", recomputeAndPlot);
  $("winStart").addEventListener("change", recomputeAndPlot);
  $("winEnd").addEventListener("change", recomputeAndPlot);

  // resize handling
  window.addEventListener("resize", ()=>{
    recomputeAndPlot();
  });

  // first render
  recomputeAndPlot();
</script>

</body>
</html>
