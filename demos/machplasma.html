<!-- ======================= PART 1 / 5 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan → Paris Trip Simulator — Live Gauges + Hotspot Compression Map + Print/CSV Report</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1100px 700px at 25% -10%, rgba(96,165,250,.20), transparent 50%),
      radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.14), transparent 55%),
      linear-gradient(180deg, #050814 0%, #03050c 100%);
    color:var(--ink);
  }
  .wrap{max-width:1550px;margin:0 auto;padding:18px 14px 42px}
  header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.24);font-size:.85rem;color:var(--muted);background:rgba(2,6,23,.35)}
  .mono{font-family:var(--mono)}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .bad{color:var(--bad)}
  .row{display:grid;grid-template-columns: 520px 1fr;gap:14px;margin-top:14px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}
  .card{
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.92));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
  .card .hd .t{font-weight:800}
  .card .bd{padding:14px}

  .controls{display:grid;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  button{
    appearance:none;border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.55);
    color:var(--ink);
    padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;
  }
  button:hover{border-color:rgba(96,165,250,.55)}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.45;cursor:not-allowed}

  .stat{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .k{color:var(--muted);font-size:.82rem}
  .v{font-family:var(--mono);font-size:1.05rem;margin-top:4px}
  .small{font-size:.92rem;color:var(--muted);line-height:1.25}
  input[type="range"]{width:100%}
  .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.12);overflow:hidden;border:1px solid rgba(148,163,184,.16)}
  .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85))}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    color:var(--muted);font-size:.86rem
  }
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.5)}
  .eq{
    font-family:var(--mono);
    font-size:.92rem;
    background:rgba(2,6,23,.35);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
    white-space:pre-wrap
  }

  /* ===== Time panel ===== */
  .timeGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  @media (max-width:520px){.timeGrid{grid-template-columns:1fr}}
  .timeBox{background:rgba(2,6,23,.30);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .timeLbl{color:var(--muted);font-size:.82rem}
  .timeVal{font-family:var(--mono);font-size:1.0rem;margin-top:6px;line-height:1.12;white-space:pre-line}
  .timeSub{color:var(--muted);font-size:.82rem;margin-top:6px}

  /* ===== Fuel meters ===== */
  .meter{display:grid;gap:8px}
  .meterline{display:flex;justify-content:space-between;gap:10px;font-family:var(--mono);font-size:.92rem}
  .meterbar{height:10px;border-radius:999px;background:rgba(148,163,184,.10);border:1px solid rgba(148,163,184,.16);overflow:hidden}
  .meterbar > b{display:block;height:100%;width:0%}
  .bFuel{background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(96,165,250,.45))}
  .bScram{background:linear-gradient(90deg, rgba(251,191,36,.95), rgba(251,191,36,.45))}
  .bCool{background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(52,211,153,.45))}

  /* ===== Timeline table ===== */
  .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
  table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(2,6,23,.25)}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
  th{text-align:left;color:var(--muted);font-size:.85rem;position:sticky;top:0;background:rgba(7,10,20,.85);backdrop-filter: blur(6px)}
  tr.active{outline:2px solid rgba(96,165,250,.55);background:rgba(96,165,250,.08)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.18);font-size:.78rem;color:var(--muted)}
  .tagGood{border-color:rgba(52,211,153,.35);color:rgba(52,211,153,.95);background:rgba(52,211,153,.08)}
  .tagBlue{border-color:rgba(96,165,250,.35);color:rgba(96,165,250,.95);background:rgba(96,165,250,.08)}
  .tagWarn{border-color:rgba(251,191,36,.35);color:rgba(251,191,36,.95);background:rgba(251,191,36,.08)}

  /* ===== Stability lights ===== */
  .lights{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .light{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    min-width:160px;
  }
  .bulb{width:14px;height:14px;border-radius:999px;background:rgba(148,163,184,.25);box-shadow:0 0 0 rgba(0,0,0,0)}
  .light .lbl{font-weight:900}
  .light .sub{font-size:.82rem;color:var(--muted);margin:0}
  .on-good .bulb{background:rgba(52,211,153,.95);box-shadow:0 0 18px rgba(52,211,153,.55)}
  .on-warn .bulb{background:rgba(251,191,36,.95);box-shadow:0 0 18px rgba(251,191,36,.55)}
  .on-bad .bulb{background:rgba(251,113,133,.95);box-shadow:0 0 18px rgba(251,113,133,.55)}
  @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:.25} }
  .blink{animation:blink .7s infinite}

  /* ===== Hotspot panel ===== */
  .hotHdr{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .togrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .toggle{
    display:flex;align-items:center;gap:10px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.25);
    color:var(--muted);
    font-size:.9rem;
  }
  .toggle input{transform:scale(1.1)}
  .hotGrid{display:grid;grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px}
  @media (max-width:900px){.hotGrid{grid-template-columns:1fr}}
  .planeWrap{
    background: radial-gradient(900px 420px at 40% 0%, rgba(96,165,250,.16), transparent 55%), rgba(2,6,23,.20);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  .planeLegend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .miniPill{padding:5px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.35);color:var(--muted);font-size:.82rem}
  svg{width:100%;height:auto;display:block}
  .airframe{fill:none;stroke:rgba(148,163,184,.55);stroke-width:2}
  .zone{fill:rgba(96,165,250,.06);stroke:rgba(96,165,250,.25);stroke-width:2}
  .zoneLabel{fill:rgba(229,231,235,.85);font: 12px var(--mono)}
  .zoneStable{stroke:rgba(96,165,250,.95); fill:rgba(96,165,250,.12)}
  .zoneUnstable{stroke:rgba(251,113,133,.95); fill:rgba(251,113,133,.12)}
  .zoneAssist{stroke:rgba(96,165,250,.95); fill:rgba(96,165,250,.18)}
  @keyframes pulseBlue {0%,49%{opacity:1} 50%,100%{opacity:.25}}
  @keyframes pulseRed {0%,49%{opacity:1} 50%,100%{opacity:.25}}
  .blinkBlue{animation:pulseBlue .65s infinite}
  .blinkRed{animation:pulseRed .65s infinite}

  /* ===== NEW: Protection overlays (Plasma + SQUEEZE) ===== */
  .protPlasma{
    stroke: rgba(96,165,250,.95) !important;
    filter: drop-shadow(0 0 10px rgba(96,165,250,.45));
  }
  .protSqueeze{
    stroke: rgba(52,211,153,.95) !important;
    filter: drop-shadow(0 0 10px rgba(52,211,153,.45));
  }
  .protBoth{
    stroke: rgba(229,231,235,.92) !important;
    filter:
      drop-shadow(0 0 10px rgba(96,165,250,.35))
      drop-shadow(0 0 10px rgba(52,211,153,.28));
  }

  .zonesList{display:grid;gap:8px}
  .zrow{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:8px 10px;border-radius:14px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.25);
  }
  .zname{font-weight:800}
  .zval{font-family:var(--mono);color:var(--muted);display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .zprot{font-family:var(--mono)}

  /* ===== Report / Print ===== */
  .reportBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .reportPanel{
    margin-top:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.22);
    border-radius:14px;
    padding:10px;
  }

  /* ===== Asteroidal Helix panel ===== */
  .helixGrid{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:10px}
  @media (max-width:900px){.helixGrid{grid-template-columns:1fr}}
  .helixWrap{
    background: radial-gradient(900px 420px at 40% 0%, rgba(52,211,153,.12), transparent 55%), rgba(2,6,23,.20);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  .hxPath{fill:none;stroke:rgba(52,211,153,.75);stroke-width:2}
  .hxAxis{stroke:rgba(148,163,184,.25);stroke-width:1}
  .hxDot{fill:rgba(96,165,250,.95)}
  .hxTxt{fill:rgba(229,231,235,.85);font:12px var(--mono)}
  .hxNote{color:var(--muted);font-size:.9rem;line-height:1.25}

  /* ===== NEW: Warp-1 Stability Stack panel (LEFT) ===== */
  .stackWrap{
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.22);
    border-radius:14px;
    padding:10px;
  }
  .stackRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    margin-top:10px;
  }
  .stackBox{
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.25);
    border-radius:14px;
    padding:10px;
  }
  .stackTop{
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
  }
  .stackTitle{font-weight:900}
  .stackGrid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .stackGrid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
  @media (max-width:520px){
    .stackGrid2,.stackGrid3{grid-template-columns:1fr}
  }
  .miniBar{height:10px;border-radius:999px;background:rgba(148,163,184,.10);border:1px solid rgba(148,163,184,.16);overflow:hidden}
  .miniBar > b{display:block;height:100%;width:0%}
  .bBlue{background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(96,165,250,.35))}
  .bGreen{background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(52,211,153,.35))}
  .bMix{background:linear-gradient(90deg, rgba(96,165,250,.85), rgba(52,211,153,.75))}
  .arrowLine{
    margin-top:10px;
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    color:var(--muted);font-size:.86rem
  }
  .arrNode{
    padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.20);
    font-family:var(--mono);
  }
  .arrArrow{opacity:.85}
  .explainBox{
    margin-top:10px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.18);
    border-radius:14px;
    padding:10px;
    white-space:pre-line;
    font-size:.90rem;
    color:var(--muted);
    line-height:1.28;
  }

  /* Print styling */
  @media print{
    body{background:#fff !important;color:#000 !important}
    .wrap{max-width:none;padding:0}
    header,.row,.card:nth-of-type(2){display:none !important}
    #printArea{display:block !important}
    #printArea *{color:#000 !important}
  }
  #printArea{display:none}
  #printArea h2{margin:8px 0 6px}
  #printArea .pbox{border:1px solid #bbb;padding:10px;margin:8px 0}
  #printArea table{width:100%;border-collapse:collapse}
  #printArea th,#printArea td{border:1px solid #bbb;padding:6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Japan → Paris Trip Simulator (Live Readout)</h1>
      <div class="sub">
        Fix: coolant remaining <b>never disappears on Start</b> (it only decreases with flow). Added a full <b>Compression/Hotspot Report</b> with hit counts + peak/average compression, plus <b>Print</b> and <b>CSV export</b>.
        <span class="small" style="display:block;margin-top:6px">
          <b>Update:</b> Added <b>Asteroidal Helix Stabilizer</b> (10-minute up/down curve) with a live panel showing how helix motion improves stability during the high-risk ramp window.
        </span>
      </div>
    </div>
    <div class="legend">
      <span class="pill">Trip length: <b id="tripLen">146 min</b></span>
      <span class="pill">Playback: <b id="spdLbl">60×</b></span>
      <span class="pill">Mass factor: <b id="massFactorLbl">1.00×</b></span>
      <span class="pill">Status: <b id="statusLbl" class="warn">Stopped</b></span>
    </div>
  </header>

  <div class="row">
    <!-- LEFT: Controls + instruments -->
    <section class="card">
      <div class="hd">
        <div class="t">Controls • Instruments</div>
        <div class="pill mono">t = <span id="tNow">0.00</span> min</div>
      </div>
      <div class="bd">
        <div class="controls">
          <div class="btnrow">
            <button id="btnStart" type="button">Start</button>
            <button id="btnStop" type="button" disabled>Stop</button>
            <button id="btnReset" type="button">Reset</button>
          </div>

          <div class="stat">
            <div class="k">Playback speed (sim minutes per real second)</div>
            <input id="spd" type="range" min="1" max="240" value="60"/>
            <div class="small">Effective speed = slider × mass factor (mass changes response lag + ETA).</div>
            <div class="small mono" style="margin-top:6px">
              Effective: <span id="effSpeedLbl">60.0</span> sim-min/s • ETA (real): <span id="etaRealLbl">—</span>
            </div>
          </div>

          <div class="stat">
            <div class="k">Trip progress</div>
            <div class="bar"><i id="prog"></i></div>
            <div class="small mono"><span id="progPct">0</span>% • step <span id="stepNow">—</span> • <span id="phaseNow">—</span></div>
          </div>

          <div class="split">
            <div class="stat"><div class="k">Mach (actual)</div><div class="v"><span id="mach">0.00</span></div><div class="small">Lagged response to the plan.</div></div>
            <div class="stat"><div class="k">Altitude (actual)</div><div class="v"><span id="alt">0.0</span> km</div><div class="small">Lagged response to the plan.</div></div>
            <div class="stat"><div class="k">Medium type</div><div class="v"><span id="medium">Troposphere</span></div><div class="small">Band by altitude.</div></div>
            <div class="stat"><div class="k">Cold index</div><div class="v"><span id="cold">0.00</span></div><div class="small">From ambient temperature (0..1).</div></div>
            <div class="stat"><div class="k">Ambient temp</div><div class="v"><span id="Tamb">288.15</span> K</div><div class="small">Interpolated by altitude.</div></div>
            <div class="stat"><div class="k">Density</div><div class="v"><span id="rho">1.2250</span> kg/m³</div><div class="small">Interpolated by altitude.</div></div>
            <div class="stat"><div class="k">Speed</div><div class="v"><span id="V">0</span> m/s</div><div class="small">V = Mach · a(alt).</div></div>
            <div class="stat"><div class="k">Dynamic pressure</div><div class="v"><span id="q">0.0</span> kPa</div><div class="small">q = ½ρV².</div></div>
            <div class="stat"><div class="k">Heating proxy</div><div class="v"><span id="H">0.00</span></div><div class="small">H = q/q_ref.</div></div>
            <div class="stat"><div class="k">Skin temperature</div><div class="v"><span id="Tskin">288.15</span> K</div><div class="small">Thermal ODE.</div></div>
            <div class="stat"><div class="k">Coolant flow (actual)</div><div class="v"><span id="cool">0.20</span> kg/s</div><div class="small">Tank-limited, decreases remaining.</div></div>
            <div class="stat"><div class="k">Stability score</div><div class="v"><span id="stab">1.00</span></div><div class="small">Loads + heating + ramps + plasma/INS + mass.</div></div>
          </div>

          <div class="stat">
            <div class="k">CST discipline (from active row)</div>
            <div class="small" id="cstNote">—</div>
          </div>

          <div class="stat">
            <div class="k">Quick status</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
              <span class="chip"><span class="dot" id="dotTherm"></span>Thermal</span>
              <span class="chip"><span class="dot" id="dotLoad"></span>Loads</span>
              <span class="chip"><span class="dot" id="dotNav"></span>Nav/INS</span>
              <span class="chip"><span class="dot" id="dotComm"></span>Comm/Plasma</span>
            </div>
            <div class="small" id="riskTxt" style="margin-top:8px">—</div>
          </div>

          <div class="stat">
            <div class="k">Stability annunciator</div>
            <div class="lights">
              <div class="light" id="lightStable"><div class="bulb"></div><div><div class="lbl">STABLE</div><p class="sub">Stab ≥ 0.70</p></div></div>
              <div class="light" id="lightCaution"><div class="bulb"></div><div><div class="lbl">CAUTION</div><p class="sub">0.45–0.70</p></div></div>
              <div class="light" id="lightUnstable"><div class="bulb"></div><div><div class="lbl">UNSTABLE</div><p class="sub">Stab &lt; 0.45</p></div></div>
            </div>
            <div class="small" id="annNote" style="margin-top:8px">—</div>
          </div>

          <!-- ===================== NEW LEFT PANEL: Warp-1 Stability Stack ===================== -->
          <div class="stat">
            <div class="k">Warp-1 Mach-10 Stability Stack (live)</div>

            <div class="stackWrap" aria-label="warp-1 stability stack">
              <div class="arrowLine">
                <span class="arrNode">Plasma Buffer</span>
                <span class="arrArrow">→</span>
                <span class="arrNode">Shock/Heat Moderation</span>
                <span class="arrArrow">→</span>
                <span class="arrNode">SQUEEZE TPS</span>
                <span class="arrArrow">→</span>
                <span class="arrNode">Stable Ride Index</span>
              </div>

              <div class="stackRow">
                <div class="stackBox">
                  <div class="stackTop">
                    <div class="stackTitle">Plasma Buffer (front)</div>
                    <span class="tag" id="plasmaModeTag">—</span>
                  </div>
                  <div class="stackGrid2">
                    <div>
                      <div class="k">Buffer duty (derived)</div>
                      <div class="v"><span id="plasmaDutyLbl">0.00</span></div>
                      <div class="miniBar" aria-label="plasma duty bar"><b id="plasmaDutyBar" class="bBlue"></b></div>
                      <div class="small" style="margin-top:6px">Based on step (NONE/MAYBE/LIKELY) × altitude effectiveness.</div>
                    </div>
                    <div>
                      <div class="k">Buffer effect (derived)</div>
                      <div class="v"><span id="plasmaEffectLbl">0%</span></div>
                      <div class="miniBar" aria-label="plasma effect bar"><b id="plasmaEffectBar" class="bBlue"></b></div>
                      <div class="small" style="margin-top:6px">Acts by softening peaks (toy): reduces q/H penalties slightly.</div>
                    </div>
                  </div>
                </div>

                <div class="stackBox">
                  <div class="stackTop">
                    <div class="stackTitle">Shock/Heat Moderation (derived)</div>
                    <span class="tag" id="moderationTag">—</span>
                  </div>
                  <div class="stackGrid3">
                    <div>
                      <div class="k">q (raw)</div>
                      <div class="v"><span id="qRawLbl">—</span> kPa</div>
                      <div class="small mono">from live q panel</div>
                    </div>
                    <div>
                      <div class="k">q (moderated)</div>
                      <div class="v"><span id="qEffLbl">—</span> kPa</div>
                      <div class="small mono">q_eff = q · (1 − k·duty)</div>
                    </div>
                    <div>
                      <div class="k">Δq reduction</div>
                      <div class="v"><span id="dqLbl">0%</span></div>
                      <div class="miniBar"><b id="dqBar" class="bBlue"></b></div>
                    </div>
                    <div>
                      <div class="k">H (raw)</div>
                      <div class="v"><span id="hRawLbl">—</span></div>
                      <div class="small mono">from live H panel</div>
                    </div>
                    <div>
                      <div class="k">H (moderated)</div>
                      <div class="v"><span id="hEffLbl">—</span></div>
                      <div class="small mono">H_eff = H · (1 − k·duty)</div>
                    </div>
                    <div>
                      <div class="k">ΔH reduction</div>
                      <div class="v"><span id="dHLbl">0%</span></div>
                      <div class="miniBar"><b id="dHBar" class="bBlue"></b></div>
                    </div>
                  </div>
                </div>

                <div class="stackBox">
                  <div class="stackTop">
                    <div class="stackTitle">SQUEEZE TPS (tiles + coolant)</div>
                    <span class="tag" id="squeezeTag">—</span>
                  </div>
                  <div class="stackGrid3">
                    <div>
                      <div class="k">Coolant flow</div>
                      <div class="v"><span id="sqFlowLbl">0.00</span> kg/s</div>
                      <div class="miniBar"><b id="sqFlowBar" class="bGreen"></b></div>
                      <div class="small">From live coolant flow (left).</div>
                    </div>
                    <div>
                      <div class="k">SQUEEZE strength (derived)</div>
                      <div class="v"><span id="sqStrengthLbl">0%</span></div>
                      <div class="miniBar"><b id="sqStrengthBar" class="bGreen"></b></div>
                      <div class="small">Derived from flow + coolingStrength.</div>
                    </div>
                    <div>
                      <div class="k">Tile clamp setpoint (derived)</div>
                      <div class="v"><span id="tileClampLbl">—</span></div>
                      <div class="small mono">Nose/Lead/Gaps (% preload)</div>
                    </div>
                  </div>

                  <div class="small" style="margin-top:10px">
                    Protected zones (live mapping): <span class="tag tagBlue">PLASMA</span> <span class="tag tagGood">SQUEEZE</span> <span class="tag">BOTH</span>
                  </div>
                  <div class="small mono" style="margin-top:6px;white-space:pre-line" id="protSummary">
—</div>
                </div>

                <div class="stackBox">
                  <div class="stackTop">
                    <div class="stackTitle">Stable Ride Index (derived)</div>
                    <span class="tag" id="rideTag">—</span>
                  </div>
                  <div class="stackGrid2">
                    <div>
                      <div class="k">Base stability (from sim)</div>
                      <div class="v"><span id="stabBaseLbl">—</span></div>
                      <div class="small">This is your existing Stability score.</div>
                    </div>
                    <div>
                      <div class="k">Stable Ride Index</div>
                      <div class="v"><span id="rideLbl">—</span></div>
                      <div class="miniBar"><b id="rideBar" class="bMix"></b></div>
                      <div class="small">Toy fusion: stability + plasma + squeeze contributions.</div>
                    </div>
                  </div>

                  <div class="explainBox" id="stackExplain">—</div>
                </div>
              </div>
            </div>
          </div>
          <!-- ===================== END NEW LEFT PANEL ===================== -->

        </div>
      </div>
    </section>
<!-- ======================= PART 2 / 5 ======================= -->
    <!-- RIGHT: Hotspot map + clocks + mass/fuel + helix + report -->
    <section class="card">
      <div class="hd">
        <div class="t">Hotspot Compression Map • Clocks • Mass/Fuel • Helix • Report</div>
        <div class="tag">Print + CSV</div>
      </div>
      <div class="bd">

        <!-- HOTSPOT PANEL -->
        <div class="stat">
          <div class="hotHdr">
            <div>
              <div class="k">Hotspot Compression + Cooling Map</div>
              <div class="small" id="hotState">Hotspot system is IDLE.</div>
            </div>
            <div class="togrow">
              <label class="toggle"><input id="assistOn" type="checkbox" checked> Zoned assist (ON/OFF)</label>
              <label class="toggle"><input id="showLabels" type="checkbox" checked> Show labels</label>
            </div>
          </div>

          <div class="hotGrid">
            <div class="planeWrap">
              <svg viewBox="0 0 640 260" aria-label="airplane hotspot outline">
                <path class="airframe" d="M320 20 C350 20 374 38 384 60 L430 150 L600 170 L600 190 L430 190 L382 252 C370 240 350 228 320 228 C290 228 270 240 258 252 L210 190 L40 190 L40 170 L210 150 L256 60 C266 38 290 20 320 20 Z"/>
                <polygon id="z_nose" class="zone" points="320,26 350,40 338,74 302,74 290,40"/>
                <polygon id="z_inlet" class="zone" points="300,74 340,74 360,110 280,110"/>
                <polygon id="z_leadL" class="zone" points="210,150 256,60 280,110 240,162"/>
                <polygon id="z_leadR" class="zone" points="430,150 384,60 360,110 400,162"/>
                <polygon id="z_wbj" class="zone" points="280,110 360,110 392,160 248,160"/>
                <polygon id="z_gaps" class="zone" points="248,160 392,160 382,205 258,205"/>
                <text id="lbl_nose" class="zoneLabel" x="320" y="62" text-anchor="middle">Nose</text>
                <text id="lbl_inlet" class="zoneLabel" x="320" y="104" text-anchor="middle">Inlet</text>
                <text id="lbl_leadL" class="zoneLabel" x="215" y="135" text-anchor="middle">Lead L</text>
                <text id="lbl_leadR" class="zoneLabel" x="425" y="135" text-anchor="middle">Lead R</text>
                <text id="lbl_wbj" class="zoneLabel" x="320" y="155" text-anchor="middle">WBJ</text>
                <text id="lbl_gaps" class="zoneLabel" x="320" y="202" text-anchor="middle">Gaps</text>
              </svg>

              <div class="planeLegend">
                <span class="miniPill">Blue blink = stable compression</span>
                <span class="miniPill">Red blink = unstable compression</span>
                <span class="miniPill">“Hits” counted when zone ≥ 45%</span>
              </div>

              <div class="planeLegend">
                <span class="miniPill">Glow blue = PLASMA protection</span>
                <span class="miniPill">Glow green = SQUEEZE protection</span>
                <span class="miniPill">White edge = BOTH</span>
              </div>

              <div class="small" style="margin-top:8px">
                Active zones: <b id="hotActive">0</b> • Engaged zones: <b id="hotEngaged">0</b> • Assist: <b id="hotAssistLbl">ON</b>
              </div>

              <div class="small" style="margin-top:8px">
                Sensitivity <input id="hotSensitivity" type="range" min="0" max="200" value="100"/>
                <span class="mono" id="hotSensLbl">1.00×</span>
              </div>
            </div>

            <div class="zonesList" aria-label="zone readouts">
              <div class="zrow">
                <div>
                  <div class="zname">Nose / stagnation</div><div class="small">High q + heat</div>
                </div>
                <div class="zval">
                  <span id="zr_nose">0%</span>
                  <span id="zp_nose" class="tag zprot">—</span>
                </div>
              </div>

              <div class="zrow">
                <div>
                  <div class="zname">Leading edges</div><div class="small">Shock attachment</div>
                </div>
                <div class="zval">
                  <span id="zr_lead">0%</span>
                  <span id="zp_lead" class="tag zprot">—</span>
                </div>
              </div>

              <div class="zrow">
                <div>
                  <div class="zname">Inlet / forebody</div><div class="small">Compression & inlet</div>
                </div>
                <div class="zval">
                  <span id="zr_inlet">0%</span>
                  <span id="zp_inlet" class="tag zprot">—</span>
                </div>
              </div>

              <div class="zrow">
                <div>
                  <div class="zname">Wing-body junction</div><div class="small">Interference flow</div>
                </div>
                <div class="zval">
                  <span id="zr_wbj">0%</span>
                  <span id="zp_wbj" class="tag zprot">—</span>
                </div>
              </div>

              <div class="zrow">
                <div>
                  <div class="zname">Control-surface gaps</div><div class="small">Leakage + hot spots</div>
                </div>
                <div class="zval">
                  <span id="zr_gaps">0%</span>
                  <span id="zp_gaps" class="tag zprot">—</span>
                </div>
              </div>

              <div class="stat">
                <div class="k">Zone classification thresholds</div>
                <div class="eq" style="margin-top:8px">risk% = clamp( base + wC·compIdx + wH·Hn + wQ·qN + wU·(1-stab) + bias ) · sensitivity
stable: risk% &lt; 45 → blue blink
unstable: risk% ≥ 45 → red blink
Assist effect (if armed + ON): risk% *= (1 - 0.18*coolingStrength)</div>
                <div class="small" style="margin-top:8px">
                  Cooling strength <input id="coolStrength" type="range" min="0" max="100" value="60"/>
                  <span class="mono" id="coolStrengthLbl">0.60</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CLOCKS PANEL -->
        <div class="stat">
          <div class="k">Departure & Arrival clocks (browser time)</div>
          <div class="timeGrid">
            <div class="timeBox">
              <div class="timeLbl">Departure (locked when Start is pressed)</div>
              <div class="timeVal" id="depTimes">—</div>
              <div class="timeSub" id="depNote">Press Start to lock departure time.</div>
            </div>
            <div class="timeBox">
              <div class="timeLbl">Arrival (ETA from effective speed)</div>
              <div class="timeVal" id="arrTimes">—</div>
              <div class="timeSub" id="arrNote">Updates live from current time + ETA.</div>
            </div>
          </div>
        </div>

        <!-- MASS/FUEL PANEL -->
        <div class="stat">
          <div class="k">Mass & Fuel (sliders + live burn)</div>

          <div class="split" style="margin-top:10px">
            <div class="stat">
              <div class="k">Airframe (dry)</div>
              <input id="mAir" type="range" min="10000" max="120000" step="500" value="52000"/>
              <div class="small mono"><span id="mAirLbl">52000</span> kg</div>
            </div>
            <div class="stat">
              <div class="k">Scram system</div>
              <input id="mScramSys" type="range" min="500" max="20000" step="100" value="4500"/>
              <div class="small mono"><span id="mScramSysLbl">4500</span> kg</div>
            </div>
            <div class="stat">
              <div class="k">Jet fuel capacity</div>
              <input id="mJetFuel" type="range" min="0" max="60000" step="250" value="18000"/>
              <div class="small mono"><span id="mJetFuelLbl">18000</span> kg</div>
            </div>
            <div class="stat">
              <div class="k">Scram fuel capacity</div>
              <input id="mScramFuel" type="range" min="0" max="40000" step="250" value="9000"/>
              <div class="small mono"><span id="mScramFuelLbl">9000</span> kg</div>
            </div>
            <div class="stat">
              <div class="k">Coolant capacity</div>
              <input id="mCoolant" type="range" min="0" max="12000" step="50" value="2200"/>
              <div class="small mono"><span id="mCoolantLbl">2200</span> kg</div>
            </div>
            <div class="stat">
              <div class="k">Options</div>
              <label class="toggle" style="width:100%"><input id="unmanned" type="checkbox" checked> Unmanned (lower inertia penalty)</label>
              <div class="small mono" style="margin-top:8px">Total mass: <span id="mTotalLbl">—</span> kg</div>
            </div>
          </div>

          <div class="split" style="margin-top:10px">
            <div class="stat">
              <div class="k">Remaining tanks</div>
              <div class="meter" style="margin-top:8px">
                <div class="meterline"><span>Jet fuel</span><span><span id="jetRemainLbl">—</span> kg</span></div>
                <div class="meterbar"><b class="bFuel" id="jetBar"></b></div>
                <div class="small mono">Cap: <span id="jetCapLbl">—</span> kg</div>

                <div style="height:6px"></div>

                <div class="meterline"><span>Scram fuel</span><span><span id="scramRemainLbl">—</span> kg</span></div>
                <div class="meterbar"><b class="bScram" id="scramBar"></b></div>
                <div class="small mono">Cap: <span id="scramCapLbl">—</span> kg</div>

                <div style="height:6px"></div>

                <div class="meterline"><span>Coolant</span><span><span id="coolRemainLbl">—</span> kg</span></div>
                <div class="meterbar"><b class="bCool" id="coolBar"></b></div>
                <div class="small mono">Cap: <span id="coolCapLbl">—</span> kg</div>

                <div class="small" style="margin-top:8px">
                  <b class="warn">Coolant fix:</b> on Start we clamp remaining to cap (never resets to 0 unless it was truly used up).
                </div>
              </div>
            </div>

            <!-- ASTEROIDAL HELIX PANEL (10 minutes) -->
            <div class="stat">
              <div class="k">Asteroidal Helix Stabilizer (10-minute up/down curve)</div>
              <div class="small">
                Helix window: <span class="mono" id="hxWindowLbl">—</span> • Status: <b id="hxStateLbl" class="warn">IDLE</b>
              </div>

              <div class="helixGrid">
                <div class="helixWrap">
                  <svg viewBox="0 0 640 220" aria-label="asteroidal helix curve">
                    <!-- axes -->
                    <line class="hxAxis" x1="40" y1="180" x2="620" y2="180"></line>
                    <line class="hxAxis" x1="40" y1="25" x2="40" y2="180"></line>
                    <text class="hxTxt" x="40" y="205">0 min</text>
                    <text class="hxTxt" x="580" y="205" text-anchor="end">10 min</text>
                    <text class="hxTxt" x="12" y="30" transform="rotate(-90,12,30)">±Alt offset</text>

                    <!-- path + moving marker -->
                    <path id="hxPath" class="hxPath" d=""></path>
                    <circle id="hxDot" class="hxDot" r="6" cx="40" cy="180"></circle>

                    <text class="hxTxt" x="52" y="42">Up/Down curve + lateral swirl → spreads heating & smooths load peaks</text>
                  </svg>

                  <div class="small" style="margin-top:8px">
                    Live marker = current helix phase (only active during the 10-minute window).
                  </div>
                </div>

                <div class="stat">
                  <div class="k">Live helix figures</div>
                  <div class="small mono" style="margin-top:8px;white-space:pre-line" id="hxLive">—</div>
                  <div class="hxNote" style="margin-top:8px">
                    How it “keeps stable” (in this simulator): helix gain reduces effective peak dynamic-pressure/heating penalties and softens ramp/track penalties during the highest-risk acceleration segment, raising the resulting stability score.
                  </div>
                </div>
              </div>

              <div class="eq" style="margin-top:10px">Helix model (10 min):
altOffset(t) = A_km · sin(ωt)  (up/down)
lateralSwirl(t) = R_km · [cos(ωt), sin(ωt)]
helixGain(t) ramps in/out to avoid impulses.

Stability assist (conceptual):
qN_eff = qN · (1 - kq·helixGain)
Hn_eff = Hn · (1 - kH·helixGain)
trackPen_eff = trackPen · (1 - kt·helixGain)
ramp_eff = ramp · (1 - kr·helixGain)</div>
            </div>
          </div>
        </div>

        <!-- REPORT TOOLS -->
        <div class="stat">
          <div class="k">Report tools</div>
          <div class="small">Logs every frame: Mach/Alt/q/H/Stability/Coolant + zone compression% (with “hits” and averages).</div>
          <div class="reportBtns">
            <button id="btnReport" type="button">Build Report</button>
            <button id="btnPrint" type="button">Print Report</button>
            <button id="btnCSV" type="button">Download CSV</button>
            <button id="btnClearLog" type="button">Clear Log</button>
          </div>
          <div class="reportPanel small mono" id="reportSummary">No report yet. Click “Build Report”.</div>
        </div>

      </div>
    </section>
  </div><!-- row -->

  <div style="height:14px"></div>

  <section class="card">
    <div class="hd">
      <div class="t">Event Log • Row-by-row Timeline</div>
      <div class="pill mono">Active row highlights as the trip runs</div>
    </div>
    <div class="bd">
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Step</th>
              <th>Phase</th>
              <th>Start–End (min)</th>
              <th>Speed plan</th>
              <th>Alt band (km)</th>
              <th>Distance (km)</th>
              <th>Fuel / Mode</th>
              <th>EM</th>
              <th>Plasma</th>
              <th>INS reliance</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRINT AREA (only visible in print) -->
  <section id="printArea">
    <h2>Japan → Paris Trip Simulator — Compression / Hotspot Report</h2>
    <div class="pbox" id="printSummary">—</div>
    <div class="pbox">
      <h2 style="font-size:16px;margin:0 0 6px">Zone Compression Stats</h2>
      <div id="printZones">—</div>
    </div>
    <div class="pbox">
      <h2 style="font-size:16px;margin:0 0 6px">Frame Log (first 200 rows)</h2>
      <div id="printLog">—</div>
    </div>
  </section>
</div><!-- wrap -->

<script>
/* ===================== DATA (from your Excel) ===================== */
const TRIP_LEN_MIN = 146.0;

const STEPS = [
  {"step":1,"phase":"Takeoff + initial climb","t0":0.0,"t1":15.0,"mach0":0.0,"mach1":1.0,"alt0":0.0,"alt1":12.0,"speedPlan":"0 → ~Mach 1","distKm":123.0,"fuelMode":"Jet fuel","notes":"Runway to high climb","em":"LOW (surface)","plasma":"NONE","ins":"LOW","cst":"Initialize CST baseline; timestamp discipline begins at takeoff."},
  {"step":2,"phase":"Climb + accelerate to Mach 3 corridor","t0":15.0,"t1":40.0,"mach0":1.0,"mach1":3.0,"alt0":12.0,"alt1":30.0,"speedPlan":"Mach 1 → Mach 3","distKm":926.0,"fuelMode":"Jet fuel","notes":"Transition into thinner air; heating begins to rise.","em":"LOW→MOD","plasma":"NONE→MAYBE","ins":"LOW→MOD","cst":"Monitor time drift; tighten sensor-fusion timing as heating increases."},
  {"step":3,"phase":"Ramp up (controlled)","t0":40.0,"t1":50.0,"mach0":3.0,"mach1":10.0,"alt0":30.0,"alt1":45.0,"speedPlan":"Mach 3 → Mach 10","distKm":1338.0,"fuelMode":"Scramjet / mixed-mode","notes":"Peak heating window; plasma and comm risk increases.","em":"MOD→HIGH","plasma":"MAYBE→LIKELY","ins":"HIGH","cst":"Mode switch: predict blackout; increase INS weight; keep clock sync coherent."},
  {"step":4,"phase":"Mach-10 cruise window","t0":50.0,"t1":60.0,"mach0":10.0,"mach1":10.0,"alt0":45.0,"alt1":55.0,"speedPlan":"Mach 10 steady","distKm":2058.0,"fuelMode":"Scramjet (steady)","notes":"Short Mach-10 window; most sensitive to thermal/structural margins.","em":"HIGH","plasma":"LIKELY","ins":"HIGH","cst":"Hold time coherence through sensor dropouts; deterministic logging."},
  {"step":5,"phase":"Ramp down (controlled)","t0":60.0,"t1":70.0,"mach0":10.0,"mach1":3.0,"alt0":55.0,"alt1":35.0,"speedPlan":"Mach 10 → Mach 3","distKm":1338.0,"fuelMode":"Scramjet → turbine/ram","notes":"Recover comms; reduce heating; stabilize inlet margin.","em":"HIGH→MOD","plasma":"LIKELY→MAYBE","ins":"HIGH→MOD","cst":"Reacquire/re-sync clocks; smooth handoff back to comm-aided nav."},
  {"step":6,"phase":"Long midcourse at Mach 3","t0":70.0,"t1":126.0,"mach0":3.0,"mach1":3.0,"alt0":25.0,"alt1":30.0,"speedPlan":"Mach 3 steady","distKm":4138.0,"fuelMode":"Ramjet / turbine","notes":"Main distance segment; lower heating than Mach-10; optimize range.","em":"MOD","plasma":"MAYBE (sporadic)","ins":"MOD","cst":"Maintain long-term timing stability; periodic sync checks."},
  {"step":7,"phase":"Descent + landing","t0":126.0,"t1":146.0,"mach0":3.0,"mach1":0.0,"alt0":30.0,"alt1":0.0,"speedPlan":"Mach 3 → 0","distKm":540.0,"fuelMode":"Turbine + landing","notes":"Thermal cooldown; return to dense air; control authority increases.","em":"MOD→LOW","plasma":"NONE","ins":"LOW","cst":"Finalize logs; compute drift summary; archive mission timeline."}
];

const ATM = [
  {"alt_km":0.0,"T":288.15,"rho":1.2250000,"a":340.2940},
  {"alt_km":5.0,"T":255.65,"rho":0.7361155,"a":320.5294},
  {"alt_km":10.0,"T":223.15,"rho":0.4127061,"a":299.4632},
  {"alt_km":15.0,"T":216.65,"rho":0.1936735,"a":295.0695},
  {"alt_km":20.0,"T":216.65,"rho":0.0880350,"a":295.1000},
  {"alt_km":25.0,"T":221.65,"rho":0.0394660,"a":298.5000},
  {"alt_km":30.0,"T":226.65,"rho":0.0180120,"a":301.8000},
  {"alt_km":35.0,"T":237.05,"rho":0.0082140,"a":308.6000},
  {"alt_km":40.0,"T":251.05,"rho":0.0038510,"a":317.6000},
  {"alt_km":45.0,"T":265.05,"rho":0.0018810,"a":326.4000},
  {"alt_km":50.0,"T":270.65,"rho":0.0009780,"a":329.8000},
  {"alt_km":55.0,"T":259.45,"rho":0.0005370,"a":322.9000},
  {"alt_km":60.0,"T":245.45,"rho":0.0002880,"a":314.1000},
  {"alt_km":65.0,"T":231.45,"rho":0.0001490,"a":305.0000}
];

/* ===================== HELPERS ===================== */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const el = (id)=>document.getElementById(id);

function fmt(x, d=2){ return isFinite(x) ? Number(x).toFixed(d) : "—"; }
function fmtInt(x){ return isFinite(x) ? String(Math.round(x)) : "—"; }

function interp1(x, x0, y0, x1, y1){
  if (x1===x0) return y0;
  const s=(x-x0)/(x1-x0);
  return y0+s*(y1-y0);
}

function atmAt(altKm){
  const x = clamp(altKm, ATM[0].alt_km, ATM[ATM.length-1].alt_km);
  for (let i=0;i<ATM.length-1;i++){
    const a0=ATM[i], a1=ATM[i+1];
    if (x>=a0.alt_km && x<=a1.alt_km){
      return {
        T: interp1(x,a0.alt_km,a0.T, a1.alt_km,a1.T),
        rho: interp1(x,a0.alt_km,a0.rho, a1.alt_km,a1.rho),
        a: interp1(x,a0.alt_km,a0.a, a1.alt_km,a1.a)
      };
    }
  }
  return {T:ATM[0].T,rho:ATM[0].rho,a:ATM[0].a};
}

function stepAt(tMin){
  for (const s of STEPS) if (tMin>=s.t0 && tMin<s.t1) return s;
  return STEPS[STEPS.length-1];
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

function mediumType(altKm){
  if (altKm < 12) return "Troposphere";
  if (altKm < 50) return "Stratosphere";
  if (altKm < 85) return "Mesosphere";
  return "Thermosphere";
}

function coldIndex(TambK){
  const T_warm = 288.15, T_cold = 216.65;
  return clamp((T_warm - TambK)/(T_warm - T_cold), 0, 1);
}

function fmtHMS(totalSeconds){
  if (!isFinite(totalSeconds) || totalSeconds < 0) return "—";
  const s = Math.max(0, Math.round(totalSeconds));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}
</script>
<!-- ======================= PART 3 / 5 ======================= -->
<script>
/* ===================== TABLE BUILD ===================== */
const tbody = el("tbody");
const rowEls = new Map();

function buildTable(){
  tbody.innerHTML = "";
  for (const s of STEPS){
    const tr = document.createElement("tr");
    tr.dataset.step = String(s.step);
    tr.innerHTML = `
      <td class="mono">${s.step}</td>
      <td>${escapeHtml(s.phase)}</td>
      <td class="mono">${fmt(s.t0,0)}–${fmt(s.t1,0)}</td>
      <td>${escapeHtml(s.speedPlan)}</td>
      <td class="mono">${fmt(s.alt0,0)}→${fmt(s.alt1,0)}</td>
      <td class="mono">${fmt(s.distKm,0)}</td>
      <td>${escapeHtml(s.fuelMode)}</td>
      <td>${escapeHtml(s.em)}</td>
      <td>${escapeHtml(s.plasma)}</td>
      <td>${escapeHtml(s.ins)}</td>
      <td>${escapeHtml(s.notes)}</td>
    `;
    tbody.appendChild(tr);
    rowEls.set(s.step, tr);
  }
}

function highlightStep(step){
  for (const [k,tr] of rowEls.entries()){
    tr.classList.toggle("active", step === k);
  }
}

/* ===================== REPORT LOGGING ===================== */
const LOG = []; // per frame
const ZONES = ["nose","lead","inlet","wbj","gaps"];

function newZoneStats(){
  const o = {};
  for (const z of ZONES){
    o[z] = {frames:0, activeFrames:0, hitFrames:0, peak:0, sum:0, sumActive:0, enterHits:0, lastHit:false};
  }
  return o;
}
let zoneStats = newZoneStats();

function clearLog(){
  LOG.length = 0;
  zoneStats = newZoneStats();
  el("reportSummary").textContent = "Log cleared. Run the sim, then click “Build Report”.";
  el("printSummary").textContent = "—";
  el("printZones").textContent = "—";
  el("printLog").textContent = "—";
}

function zoneUpdateStats(z, riskPct){
  const st = zoneStats[z];
  st.frames++;
  st.sum += riskPct;
  st.peak = Math.max(st.peak, riskPct);
  const active = riskPct >= 30;
  const hit = riskPct >= 45;
  if (active){
    st.activeFrames++;
    st.sumActive += riskPct;
  }
  if (hit){
    st.hitFrames++;
  }
  if (hit && !st.lastHit) st.enterHits++;
  st.lastHit = hit;
}

function addLogFrame(row){
  LOG.push(row);
  if (LOG.length > 20000) LOG.shift();
}

/* ===================== UI REFS ===================== */
const btnStart = el("btnStart");
const btnStop = el("btnStop");
const btnReset = el("btnReset");
const btnReport = el("btnReport");
const btnPrint = el("btnPrint");
const btnCSV = el("btnCSV");
const btnClearLog = el("btnClearLog");
const reportSummary = el("reportSummary");

const spd = el("spd");
const spdLbl = el("spdLbl");
const statusLbl = el("statusLbl");
const massFactorLbl = el("massFactorLbl");
const effSpeedLbl = el("effSpeedLbl");
const etaRealLbl = el("etaRealLbl");

const tNow = el("tNow");
const prog = el("prog");
const progPct = el("progPct");
const stepNow = el("stepNow");
const phaseNow = el("phaseNow");

const machEl = el("mach");
const altEl = el("alt");
const mediumEl = el("medium");
const coldEl = el("cold");
const TambEl = el("Tamb");
const rhoEl = el("rho");
const VEl = el("V");
const qEl = el("q");
const HEl = el("H");
const TskinEl = el("Tskin");
const coolEl = el("cool");
const stabEl = el("stab");
const cstNote = el("cstNote");

const lightStable = el("lightStable");
const lightCaution = el("lightCaution");
const lightUnstable = el("lightUnstable");
const annNote = el("annNote");

const dotTherm = el("dotTherm");
const dotLoad = el("dotLoad");
const dotNav = el("dotNav");
const dotComm = el("dotComm");
const riskTxt = el("riskTxt");

/* clocks */
const depTimes = el("depTimes");
const arrTimes = el("arrTimes");
const depNote = el("depNote");
const arrNote = el("arrNote");

/* mass/fuel */
const mAir = el("mAir");
const mScramSys = el("mScramSys");
const mJetFuel = el("mJetFuel");
const mScramFuel = el("mScramFuel");
const mCoolant = el("mCoolant");
const unmanned = el("unmanned");

const mAirLbl = el("mAirLbl");
const mScramSysLbl = el("mScramSysLbl");
const mJetFuelLbl = el("mJetFuelLbl");
const mScramFuelLbl = el("mScramFuelLbl");
const mCoolantLbl = el("mCoolantLbl");
const mTotalLbl = el("mTotalLbl");

const jetRemainLbl = el("jetRemainLbl");
const scramRemainLbl = el("scramRemainLbl");
const coolRemainLbl = el("coolRemainLbl");
const jetBar = el("jetBar");
const scramBar = el("scramBar");
const coolBar = el("coolBar");
const jetCapLbl = el("jetCapLbl");
const scramCapLbl = el("scramCapLbl");
const coolCapLbl = el("coolCapLbl");

/* hotspot */
const assistOn = el("assistOn");
const showLabels = el("showLabels");
const hotState = el("hotState");
const hotActive = el("hotActive");
const hotEngaged = el("hotEngaged");
const hotAssistLbl = el("hotAssistLbl");
const hotSensitivity = el("hotSensitivity");
const hotSensLbl = el("hotSensLbl");
const coolStrength = el("coolStrength");
const coolStrengthLbl = el("coolStrengthLbl");

const zr_nose = el("zr_nose");
const zr_lead = el("zr_lead");
const zr_inlet = el("zr_inlet");
const zr_wbj = el("zr_wbj");
const zr_gaps = el("zr_gaps");

/* NEW: zone protection label refs */
const zp_nose = el("zp_nose");
const zp_lead = el("zp_lead");
const zp_inlet = el("zp_inlet");
const zp_wbj = el("zp_wbj");
const zp_gaps = el("zp_gaps");

const z_nose = el("z_nose");
const z_inlet = el("z_inlet");
const z_leadL = el("z_leadL");
const z_leadR = el("z_leadR");
const z_wbj = el("z_wbj");
const z_gaps = el("z_gaps");

const lbls = ["lbl_nose","lbl_inlet","lbl_leadL","lbl_leadR","lbl_wbj","lbl_gaps"].map(el);

/* print area */
const printSummary = el("printSummary");
const printZones = el("printZones");
const printLog = el("printLog");

/* helix refs */
const hxWindowLbl = el("hxWindowLbl");
const hxStateLbl = el("hxStateLbl");
const hxLive = el("hxLive");
const hxPath = el("hxPath");
const hxDot = el("hxDot");

/* ===================== NEW: Stability Stack refs (LEFT) ===================== */
const plasmaModeTag = el("plasmaModeTag");
const plasmaDutyLbl = el("plasmaDutyLbl");
const plasmaDutyBar = el("plasmaDutyBar");
const plasmaEffectLbl = el("plasmaEffectLbl");
const plasmaEffectBar = el("plasmaEffectBar");

const moderationTag = el("moderationTag");
const qRawLbl = el("qRawLbl");
const qEffLbl = el("qEffLbl");
const dqLbl = el("dqLbl");
const dqBar = el("dqBar");
const hRawLbl = el("hRawLbl");
const hEffLbl = el("hEffLbl");
const dHLbl = el("dHLbl");
const dHBar = el("dHBar");

const squeezeTag = el("squeezeTag");
const sqFlowLbl = el("sqFlowLbl");
const sqFlowBar = el("sqFlowBar");
const sqStrengthLbl = el("sqStrengthLbl");
const sqStrengthBar = el("sqStrengthBar");
const tileClampLbl = el("tileClampLbl");
const protSummary = el("protSummary");

const rideTag = el("rideTag");
const stabBaseLbl = el("stabBaseLbl");
const rideLbl = el("rideLbl");
const rideBar = el("rideBar");
const stackExplain = el("stackExplain");

/* ===================== TUNABLES ===================== */
const q_ref_kPa = 50.0;
const q_bad_kPa = 120.0;
const H_bad = 2.0;

const k_heat = 0.35;
const k_cool = 0.08;
const deltaHot = 50.0;

const m_min = 0.20;
const m_max = 1.20;

const gH = 0.55;
const gCold = 0.18;
const gMach = 0.15;

const wq = 0.33, wH = 0.33, wRamp = 0.18, wBand = 0.10, wTrack = 0.06;

const burnJet_takeoff = 55;
const burnJet_mid = 40;
const burnJet_land = 30;
const burnScram_ramp = 85;
const burnScram_cruise = 110;

const refMass = 75000;
const tauMach_base = 10.0;
const tauAlt_base = 14.0;

/* hotspot weights */
const hot_base = 0.16;
const hot_wC = 0.30;
const hot_wH = 0.26;
const hot_wQ = 0.18;
const hot_wU = 0.20;

/* NEW: plasma moderation coefficients for the left stack (toy, conservative) */
const PLASMA_Q_K = 0.18;  // max q reduction fraction at duty=1
const PLASMA_H_K = 0.14;  // max H reduction fraction at duty=1

/* ===================== ASTEROIDAL HELIX MODEL ===================== */
const HELIX_SEG_START_MIN = 40.0;
const HELIX_SEG_END_MIN   = 50.0;
const HELIX_A_KM = 1.2;
const HELIX_R_KM = 4.0;
const HELIX_PERIOD_SEC = 28.0;
const HELIX_RAMP_SEC = 25.0;

const hx_kq = 0.10;
const hx_kH = 0.08;
const hx_kt = 0.18;
const hx_kr = 0.22;

function smoothstep01(x){
  x = clamp(x,0,1);
  return x*x*(3-2*x);
}

function helixGainAt(tMin){
  const t0 = HELIX_SEG_START_MIN;
  const t1 = HELIX_SEG_END_MIN;
  if (tMin <= t0 || tMin >= t1) return 0;

  const winSec = (t1 - t0) * 60;
  const localSec = (tMin - t0) * 60;
  const in01 = smoothstep01(localSec / HELIX_RAMP_SEC);
  const out01 = smoothstep01((winSec - localSec) / HELIX_RAMP_SEC);
  return Math.min(in01, out01);
}

function helixKinematics(tMin){
  const gain = helixGainAt(tMin);
  const t0 = HELIX_SEG_START_MIN;
  const localSec = (tMin - t0) * 60.0;
  const w = (2*Math.PI) / HELIX_PERIOD_SEC;

  const altOffsetKm = gain * HELIX_A_KM * Math.sin(w * localSec);
  const xKm = gain * HELIX_R_KM * Math.cos(w * localSec);
  const yKm = gain * HELIX_R_KM * Math.sin(w * localSec);

  const aLat_mps2 = gain * (w*w) * (HELIX_R_KM*1000);

  const qRed = gain * hx_kq;
  const hRed = gain * hx_kH;

  return {gain, localSec, altOffsetKm, xKm, yKm, aLat_mps2, qRed, hRed, w};
}

function buildHelixSVGPath(){
  const x0 = 40, x1 = 620, yMid = 102, yAmp = 70;
  const N = 240;
  let d = "";
  for (let i=0;i<=N;i++){
    const u = i/N;
    const tSec = u * 10*60;
    const w = (2*Math.PI) / HELIX_PERIOD_SEC;
    const y = yMid - yAmp * Math.sin(w * tSec);
    const x = x0 + (x1-x0) * u;
    d += (i===0 ? `M ${x.toFixed(2)} ${y.toFixed(2)}` : ` L ${x.toFixed(2)} ${y.toFixed(2)}`);
  }
  hxPath.setAttribute("d", d);
}
</script>
<!-- ======================= PART 4 / 5 ======================= -->
<script>
/* ===================== STATE ===================== */
let running = false;
let tMin = 0.0;
let lastTs = null;

let Tskin = atmAt(0).T;
let depReal = null;

let jetFuelRemain = 0, scramFuelRemain = 0, coolantRemain = 0;
let jetCap = 0, scramCap = 0, coolCap = 0;

let MachAct = 0.0;
let AltAct = 0.0;

let lastCoolFlow = 0.0;
let unstableHoldSec = 0.0;

/* ===================== CORE ===================== */
function setStatus(txt, cls){
  statusLbl.textContent = txt;
  statusLbl.className = cls;
}
function setButtons(){
  btnStart.disabled = running;
  btnStop.disabled = !running;
}
function dotColor(dotEl, level){
  const c = (level < 0.33) ? "rgba(52,211,153,.85)" : (level < 0.66) ? "rgba(251,191,36,.85)" : "rgba(251,113,133,.85)";
  dotEl.style.background = c;
}
function rampMetric(step){
  const dt = Math.max(1e-9, step.t1 - step.t0);
  const dMach = Math.abs(step.mach1 - step.mach0) / dt;
  const dAlt = Math.abs(step.alt1 - step.alt0 ) / dt;
  return clamp(clamp(dMach/1.0,0,1) + 0.6*clamp(dAlt/2.0,0,1), 0, 1);
}
function bandPenalty(step){
  let p=0;
  const plasma = String(step.plasma||"").toUpperCase();
  const ins = String(step.ins||"").toUpperCase();
  if (plasma.includes("LIKELY")) p += 0.6; else if (plasma.includes("MAYBE")) p += 0.3;
  if (ins.includes("HIGH")) p += 0.5; else if (ins.includes("MOD")) p += 0.25;
  return clamp(p/1.2, 0, 1);
}
function coolantCommand(H, Cold, Mach){
  return clamp(m_min + gH*H + gCold*Cold + gMach*(Mach/10), m_min, m_max);
}

/* UPDATED: stabilityScore now includes helixGain (unchanged behavior) */
function stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen, helixGain){
  const qn = clamp(q_kPa / q_bad_kPa, 0, 1);
  const Hn = clamp(H / H_bad, 0, 1);

  const qnEff = qn * (1 - hx_kq*helixGain);
  const HnEff = Hn * (1 - hx_kH*helixGain);
  const trackEff = trackPen * (1 - hx_kt*helixGain);
  const rampEff  = ramp     * (1 - hx_kr*helixGain);

  return clamp(1 - (wq*qnEff + wH*HnEff + wRamp*rampEff + wBand*bandPen + wTrack*trackEff + inertiaPen), 0, 1);
}

function burnRatesForStep(step){
  const st = step.step;
  if (st === 1 || st === 2) return {jet: burnJet_takeoff, scram: 0};
  if (st === 6) return {jet: burnJet_mid, scram: 0};
  if (st === 7) return {jet: burnJet_land, scram: 0};
  if (st === 3 || st === 5) return {jet: 0, scram: burnScram_ramp};
  if (st === 4) return {jet: 0, scram: burnScram_cruise};
  return {jet: 0, scram: 0};
}

/* mass/time effect */
function totalMass(){
  return Number(mAir.value) + Number(mScramSys.value) + Number(mJetFuel.value) + Number(mScramFuel.value) + Number(mCoolant.value);
}
function massFactor(){
  return clamp(Math.sqrt(refMass / Math.max(1,totalMass())), 0.65, 1.10);
}
function effectiveSpeedSimMinPerSec(){
  return Number(spd.value) * massFactor();
}
function tauMachSec(){
  return tauMach_base * Math.pow(Math.max(1,totalMass())/refMass, 0.70);
}
function tauAltSec(){
  return tauAlt_base * Math.pow(Math.max(1,totalMass())/refMass, 0.70);
}

/* ===================== CLOCKS ===================== */
const TZ_LOCAL = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
const TZ_CENTRAL = "America/Chicago";
const TZ_MOUNTAIN = "America/Denver";
const TZ_PARIS = "Europe/Paris";

function fmtInTZ(date, timeZone){
  try{
    const f = new Intl.DateTimeFormat(undefined, {
      timeZone,
      weekday:"short", year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });
    return f.format(date);
  }catch(e){
    return date.toISOString();
  }
}

function renderDepTimes(){
  if (!depReal){
    depTimes.textContent =
      `Local (${TZ_LOCAL}): —\n` +
      ` + Central (${TZ_CENTRAL}): —\n` +
      ` + Mountain (${TZ_MOUNTAIN}): —\n` +
      ` + Paris (${TZ_PARIS}): —`;
    depNote.textContent = "Press Start to lock departure time.";
    return;
  }
  depTimes.textContent =
    `Local (${TZ_LOCAL}): ${fmtInTZ(depReal, TZ_LOCAL)}\n` +
    ` + Central (${TZ_CENTRAL}): ${fmtInTZ(depReal, TZ_CENTRAL)}\n` +
    ` + Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(depReal, TZ_MOUNTAIN)}\n` +
    ` + Paris (${TZ_PARIS}): ${fmtInTZ(depReal, TZ_PARIS)}`;
  depNote.textContent = "Departure is locked.";
}

function renderArrivalETA(){
  const eff = effectiveSpeedSimMinPerSec();
  const remainingMin = Math.max(0, TRIP_LEN_MIN - tMin);
  const etaSec = (eff > 0) ? (remainingMin / eff) : Infinity;

  effSpeedLbl.textContent = fmt(eff, 1);
  etaRealLbl.textContent = isFinite(etaSec) ? `${fmtHMS(etaSec)} (hh:mm:ss)` : "—";

  const now = new Date();
  const arr = new Date(now.getTime() + (isFinite(etaSec) ? etaSec*1000 : 0));

  arrTimes.textContent =
    `Local (${TZ_LOCAL}): ${fmtInTZ(arr, TZ_LOCAL)}\n` +
    ` + Central (${TZ_CENTRAL}): ${fmtInTZ(arr, TZ_CENTRAL)}\n` +
    ` + Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(arr, TZ_MOUNTAIN)}\n` +
    ` + Paris (${TZ_PARIS}): ${fmtInTZ(arr, TZ_PARIS)}`;
  arrNote.textContent = "Computed from now + ETA.";
}

/* ===================== METERS ===================== */
function updateMassLabels(){
  mAirLbl.textContent = String(Number(mAir.value));
  mScramSysLbl.textContent = String(Number(mScramSys.value));
  mJetFuelLbl.textContent = String(Number(mJetFuel.value));
  mScramFuelLbl.textContent = String(Number(mScramFuel.value));
  mCoolantLbl.textContent = String(Number(mCoolant.value));
  mTotalLbl.textContent = String(Math.round(totalMass()));
  massFactorLbl.textContent = fmt(massFactor(), 2) + "×";
}
function syncCapsFromSliders(){
  jetCap = Number(mJetFuel.value);
  scramCap= Number(mScramFuel.value);
  coolCap = Number(mCoolant.value);
  jetCapLbl.textContent = fmt(jetCap,0);
  scramCapLbl.textContent= fmt(scramCap,0);
  coolCapLbl.textContent = fmt(coolCap,0);
}
function clampRemainToCaps(){
  jetFuelRemain = clamp(isFinite(jetFuelRemain)?jetFuelRemain:0, 0, jetCap);
  scramFuelRemain = clamp(isFinite(scramFuelRemain)?scramFuelRemain:0, 0, scramCap);
  coolantRemain = clamp(isFinite(coolantRemain)?coolantRemain:0, 0, coolCap);
}
function refillAllTanksToCaps(){
  jetFuelRemain = jetCap;
  scramFuelRemain = scramCap;
  coolantRemain = coolCap;
}
function setTankBars(){
  jetRemainLbl.textContent = fmt(jetFuelRemain, 0);
  scramRemainLbl.textContent = fmt(scramFuelRemain, 0);
  coolRemainLbl.textContent = fmt(coolantRemain, 0);

  const jetPct = jetCap>0 ? clamp(jetFuelRemain/jetCap,0,1) : 0;
  const scrPct = scramCap>0 ? clamp(scramFuelRemain/scramCap,0,1) : 0;
  const coolPct = coolCap>0 ? clamp(coolantRemain/coolCap,0,1) : 0;

  jetBar.style.width = (jetPct*100).toFixed(1)+"%";
  scramBar.style.width = (scrPct*100).toFixed(1)+"%";
  coolBar.style.width = (coolPct*100).toFixed(1)+"%";
}

/* ===================== ANNUNCIATOR ===================== */
function setAnnunciator(stab, runningNow){
  const STABLE_T = 0.70, UNSTABLE_T = 0.45;
  lightStable.className = "light";
  lightCaution.className = "light";
  lightUnstable.className = "light";

  if (!runningNow){
    annNote.textContent = "Stopped: lights idle (updates during flight).";
    return;
  }

  let state="STABLE";
  if (stab < UNSTABLE_T) state="UNSTABLE";
  else if (stab < STABLE_T) state="CAUTION";

  if (state === "UNSTABLE") unstableHoldSec = 2.5;
  if (unstableHoldSec > 0 && state !== "UNSTABLE") state="CAUTION";

  if (state === "STABLE"){
    lightStable.classList.add("on-good");
    annNote.textContent="Stable: no blink.";
  } else if (state === "CAUTION"){
    lightCaution.classList.add("on-warn","blink");
    annNote.textContent="Caution: blinking.";
  } else {
    lightUnstable.classList.add("on-bad","blink");
    annNote.textContent="Unstable: blinking.";
  }
}

/* ===================== STABILITY STACK HELPERS ===================== */
function plasmaDutyFromStep(step, altKm, mach){
  // Derive a conservative duty from step text + altitude (thin air helps) + only after supersonic.
  const txt = String(step.plasma||"").toUpperCase();

  let base = 0.0;
  if (txt.includes("LIKELY")) base = 0.85;
  else if (txt.includes("MAYBE")) base = 0.45;
  else base = 0.0;

  // only meaningful after ~Mach 2 in this toy model
  const machGate = clamp((mach - 2.0)/2.0, 0, 1);

  // altitude effectiveness: 0 at 15 km, 1 near 50 km
  const altEff = clamp((altKm - 15.0)/(50.0 - 15.0), 0, 1);

  // running gate
  const runGate = running ? 1 : 0;

  return clamp(base * machGate * altEff * runGate, 0, 1);
}

function squeezeStrengthFromFlow(flowKgS){
  // Flow-based 0..1 plus your coolingStrength slider.
  const flow01 = clamp((flowKgS - m_min)/(m_max - m_min), 0, 1);
  const cool01 = clamp(Number(coolStrength.value)/100, 0, 1);
  // Bias: SQUEEZE exists as long as tiles/coolant system is available; strength increases with flow.
  return clamp(0.20 + 0.80*(flow01 * (0.45 + 0.55*cool01)), 0, 1);
}

function tileClampSetpoints(risks, squeezeStrength){
  // Derive a simple (toy) preload setpoint in % based on zone risks (0..1) and squeeze strength.
  // Keep within safe-looking bounds: 35%..92%.
  const nose = clamp(0.35 + 0.57*(risks.nose) + 0.18*squeezeStrength, 0.35, 0.92);
  const lead = clamp(0.35 + 0.57*(risks.lead) + 0.16*squeezeStrength, 0.35, 0.92);
  const gaps = clamp(0.40 + 0.55*(risks.gaps) + 0.20*squeezeStrength, 0.40, 0.95);
  return {nose, lead, gaps};
}

function setTag(elTag, txt, cls){
  elTag.textContent = txt;
  elTag.className = "tag" + (cls ? (" " + cls) : "");
}
</script>
<!-- ======================= PART 5 / 5 ======================= -->
<script>
/* ===================== HOTSPOT MAP ===================== */
function setZoneClass(elZone, stable, assisted, protPlasma, protSqueeze){
  elZone.setAttribute("class","zone");

  // existing visual states
  if (assisted){
    elZone.classList.add("zoneAssist","blinkBlue");
  } else if (stable){
    elZone.classList.add("zoneStable","blinkBlue");
  } else {
    elZone.classList.add("zoneUnstable","blinkRed");
  }

  // NEW overlay glows (does not change your risk logic; only shows protection mapping)
  if (protPlasma && protSqueeze) elZone.classList.add("protBoth");
  else if (protPlasma) elZone.classList.add("protPlasma");
  else if (protSqueeze) elZone.classList.add("protSqueeze");
}

function setLabelsVisible(on){
  for (const t of lbls) t.style.display = on ? "block" : "none";
}

function hotspotRisk01({compIdx, Hn, qN, stab, bias, sens}){
  const u = (1 - stab);
  let r = hot_base + hot_wC*compIdx + hot_wH*Hn + hot_wQ*qN + hot_wU*u + bias;
  r *= sens;
  return clamp(r, 0, 1);
}

/* UPDATED: accepts plasmaDuty + squeezeStrength so the map can show protected zones live */
function updateHotspotsAndReturnRisks({Mach, compIdx, H, q_kPa, stab, plasmaDuty, squeezeStrength}){
  const armed = (running && Mach >= 1.2);

  const sens = 0.60 + 0.80*(Number(hotSensitivity.value)/200);
  hotSensLbl.textContent = fmt(sens,2) + "×";

  const coolStr = Number(coolStrength.value)/100;
  coolStrengthLbl.textContent = fmt(coolStr,2);

  hotAssistLbl.textContent = assistOn.checked ? "ON" : "OFF";

  const Hn = clamp(H / H_bad, 0, 1);
  const qN = clamp(q_kPa / q_bad_kPa, 0, 1);

  // zone biases
  const rN = hotspotRisk01({compIdx, Hn, qN, stab, bias: 0.10, sens});
  const rI = hotspotRisk01({compIdx, Hn, qN, stab, bias: 0.08, sens});
  const rL = hotspotRisk01({compIdx, Hn, qN, stab, bias: 0.06, sens});
  const rW = hotspotRisk01({compIdx, Hn, qN, stab, bias: 0.05, sens});
  const rG = hotspotRisk01({compIdx, Hn, qN, stab, bias: 0.03, sens});

  const assist = (armed && assistOn.checked);
  const assistFactor = 1 - 0.18*coolStr;

  const rn = assist ? rN*assistFactor : rN;
  const ri = assist ? rI*assistFactor : rI;
  const rl = assist ? rL*assistFactor : rL;
  const rw = assist ? rW*assistFactor : rW;
  const rg = assist ? rG*assistFactor : rG;

  const TH_UNST = 0.45;
  const stableN = rn < TH_UNST;
  const stableI = ri < TH_UNST;
  const stableL = rl < TH_UNST;
  const stableW = rw < TH_UNST;
  const stableG = rg < TH_UNST;

  const ENG = 0.65;
  let active=0, engaged=0;

  // Protection mapping (live):
  // - Plasma: front-facing zones (nose/inlet/leading) when duty is meaningful.
  // - SQUEEZE: zones that are tile/coolant sensitive (nose/leading/gaps/wbj) when squeeze strength is meaningful.
  const pOn = (plasmaDuty >= 0.18);
  const sOn = (squeezeStrength >= 0.25);

  const prot = {
    nose:  {p:pOn, s:sOn},
    inlet: {p:pOn, s:(sOn && Mach >= 2.0)},
    lead:  {p:pOn, s:sOn},
    wbj:   {p:(pOn && Mach >= 3.0), s:sOn},
    gaps:  {p:false, s:sOn}
  };

  function paint(zoneEl, stable, r, pp, ss){
    if (r > 0.30) active++;
    if (r >= ENG) engaged++;
    const assisted = assist && (r >= ENG);
    setZoneClass(zoneEl, stable, assisted, pp, ss);
  }

  paint(z_nose, stableN, rn, prot.nose.p, prot.nose.s);
  paint(z_inlet, stableI, ri, prot.inlet.p, prot.inlet.s);
  paint(z_leadL, stableL, rl, prot.lead.p, prot.lead.s);
  paint(z_leadR, stableL, rl, prot.lead.p, prot.lead.s);
  paint(z_wbj,  stableW, rw, prot.wbj.p,  prot.wbj.s);
  paint(z_gaps, stableG, rg, prot.gaps.p, prot.gaps.s);

  // zone numeric display
  zr_nose.textContent = fmt(rn*100,0) + "%";
  zr_inlet.textContent = fmt(ri*100,0) + "%";
  zr_lead.textContent = fmt(rl*100,0) + "%";
  zr_wbj.textContent = fmt(rw*100,0) + "%";
  zr_gaps.textContent = fmt(rg*100,0) + "%";

  // zone protection tags
  function setProtTag(elTag, p, s){
    if (p && s){ setTag(elTag, "BOTH", ""); return; }
    if (p){ setTag(elTag, "PLASMA", "tagBlue"); return; }
    if (s){ setTag(elTag, "SQUEEZE", "tagGood"); return; }
    setTag(elTag, "—", "");
  }
  setProtTag(zp_nose, prot.nose.p, prot.nose.s);
  setProtTag(zp_lead, prot.lead.p, prot.lead.s);
  setProtTag(zp_inlet, prot.inlet.p, prot.inlet.s);
  setProtTag(zp_wbj, prot.wbj.p, prot.wbj.s);
  setProtTag(zp_gaps, prot.gaps.p, prot.gaps.s);

  hotActive.textContent = String(active);
  hotEngaged.textContent = String(engaged);

  if (!running){
    hotState.textContent = "Hotspot system is IDLE.";
  } else if (!armed){
    hotState.textContent = `Hotspot system is ARMED near Mach 1.2 (current Mach ${fmt(Mach,2)}).`;
  } else {
    hotState.textContent = `Hotspot system is ARMED. Active zones: ${active} • Engaged zones: ${engaged} • Assist: ${assistOn.checked ? "ON" : "OFF"}.`;
  }

  return {nose:rn, lead:rl, inlet:ri, wbj:rw, gaps:rg, armed, assistOn:assistOn.checked, prot};
}

/* ===================== SIM LOOP ===================== */
function plannedAt(t){
  const s = stepAt(t);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((t - s.t0)/span, 0, 1);

  let MachPlan = s.mach0 + frac*(s.mach1 - s.mach0);
  let AltPlan  = s.alt0  + frac*(s.alt1  - s.alt0);

  const hx = helixKinematics(t);
  AltPlan += hx.altOffsetKm;

  return {s, MachPlan, AltPlan, hx};
}

function render(){
  const {s, MachPlan, AltPlan, hx} = plannedAt(tMin);

  const Aatm = atmAt(AltAct);
  const V = MachAct * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;

  const med = mediumType(AltAct);
  const Cold = coldIndex(Aatm.T);

  const ramp = rampMetric(s);
  const bandPen = bandPenalty(s);

  const eMach = Math.abs(MachPlan - MachAct);
  const eAlt = Math.abs(AltPlan - AltAct);
  const trackPen = clamp((eMach/2.5) + 0.35*(eAlt/12.0), 0, 1);

  const tm = totalMass();
  const massOver = clamp((tm/refMass) - 1.0, 0, 1.0);
  let inertiaPen = 0.09 * massOver;
  if (unmanned.checked) inertiaPen *= 0.75;

  const helixGain = hx.gain;
  const stab = stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen, helixGain);

  // UI
  tNow.textContent = fmt(tMin, 2);
  const pct = clamp((tMin/TRIP_LEN_MIN)*100, 0, 100);
  prog.style.width = pct.toFixed(1) + "%";
  progPct.textContent = pct.toFixed(0);

  stepNow.textContent = s.step;
  phaseNow.textContent = s.phase;

  machEl.textContent = fmt(MachAct, 2);
  altEl.textContent = fmt(AltAct, 1);

  mediumEl.textContent = med;
  coldEl.textContent = fmt(Cold, 2);
  TambEl.textContent = fmt(Aatm.T, 2);
  rhoEl.textContent = fmt(Aatm.rho, 4);

  VEl.textContent = fmtInt(V);
  qEl.textContent = fmt(q_kPa, 1);
  HEl.textContent = fmt(H, 2);
  TskinEl.textContent = fmt(Tskin, 2);
  coolEl.textContent = fmt(lastCoolFlow, 2);
  stabEl.textContent = fmt(stab, 2);

  cstNote.textContent = s.cst || "—";

  const thermRisk = clamp((Tskin - Aatm.T)/120.0, 0, 1);
  const loadRisk = clamp(q_kPa / q_bad_kPa, 0, 1);
  const navRisk = bandPen;
  const plasmaU = String(s.plasma||"").toUpperCase();
  const commRisk = clamp(plasmaU.includes("LIKELY") ? 1 : plasmaU.includes("MAYBE") ? 0.5 : 0.1, 0, 1);

  dotColor(dotTherm, thermRisk);
  dotColor(dotLoad, loadRisk);
  dotColor(dotNav, navRisk);
  dotColor(dotComm, commRisk);

  riskTxt.innerHTML =
    `PlanMach=<span class="mono">${fmt(MachPlan,2)}</span> • `+
    `LagMach=<span class="mono">${fmt(Math.abs(MachPlan-MachAct),2)}</span> • `+
    `LagAlt=<span class="mono">${fmt(Math.abs(AltPlan-AltAct),1)}km</span> • `+
    `BandPen=<span class="mono">${fmt(bandPen,2)}</span> • `+
    `Mass=<span class="mono">${fmt(tm,0)}kg</span> • `+
    `HelixGain=<span class="mono">${fmt(helixGain,2)}</span> • `+
    `Stability=<span class="mono">${fmt(stab,2)}</span>`;

  highlightStep(s.step);

  updateMassLabels();
  renderArrivalETA();
  setAnnunciator(stab, running);

  syncCapsFromSliders();
  clampRemainToCaps();
  setTankBars();

  // ------------------- NEW: Plasma + SQUEEZE live stack computation -------------------
  const plasmaDuty = plasmaDutyFromStep(s, AltAct, MachAct);
  const squeezeStrength = squeezeStrengthFromFlow(lastCoolFlow);

  // Moderated q/H (display only; does not change your core sim physics)
  const qEff = q_kPa * (1 - PLASMA_Q_K*plasmaDuty);
  const hEff = H * (1 - PLASMA_H_K*plasmaDuty);

  const dq = (q_kPa > 1e-9) ? clamp((q_kPa - qEff)/q_kPa, 0, 1) : 0;
  const dH = (H > 1e-9) ? clamp((H - hEff)/H, 0, 1) : 0;

  // Hotspot risk uses raw q/H (existing), but protection overlays use plasma/squeeze values
  const compIdx = clamp((1 + (q_kPa/35.0) + 0.12*MachAct - 1) / (6.0 - 1), 0, 1);
  const risks = updateHotspotsAndReturnRisks({Mach:MachAct, compIdx, H, q_kPa, stab, plasmaDuty, squeezeStrength});
  setLabelsVisible(showLabels.checked);

  // Update report stats continuously (only while running)
  if (running){
    const rn = risks.nose*100, rl = risks.lead*100, ri = risks.inlet*100, rw = risks.wbj*100, rg = risks.gaps*100;
    zoneUpdateStats("nose", rn);
    zoneUpdateStats("lead", rl);
    zoneUpdateStats("inlet", ri);
    zoneUpdateStats("wbj", rw);
    zoneUpdateStats("gaps", rg);
  }

  // -------- LEFT STACK UI updates (all live labels) --------
  // Plasma panel
  const plasmaTxt = String(s.plasma||"NONE").toUpperCase();
  if (plasmaTxt.includes("LIKELY")) setTag(plasmaModeTag, "LIKELY", "tagBlue");
  else if (plasmaTxt.includes("MAYBE")) setTag(plasmaModeTag, "MAYBE", "tagBlue");
  else setTag(plasmaModeTag, "NONE", "");

  plasmaDutyLbl.textContent = fmt(plasmaDuty, 2);
  plasmaDutyBar.style.width = (plasmaDuty*100).toFixed(1)+"%";

  const plasmaEffPct = Math.round((0.5*dq + 0.5*dH)*100);
  plasmaEffectLbl.textContent = plasmaEffPct + "%";
  plasmaEffectBar.style.width = plasmaEffPct + "%";

  // Moderation panel
  setTag(moderationTag, (plasmaDuty > 0.15 ? "ACTIVE" : (running ? "ARMED" : "IDLE")), (plasmaDuty>0.15 ? "tagBlue" : ""));
  qRawLbl.textContent = fmt(q_kPa, 1);
  qEffLbl.textContent = fmt(qEff, 1);
  dqLbl.textContent = Math.round(dq*100) + "%";
  dqBar.style.width = (dq*100).toFixed(1)+"%";

  hRawLbl.textContent = fmt(H, 2);
  hEffLbl.textContent = fmt(hEff, 2);
  dHLbl.textContent = Math.round(dH*100) + "%";
  dHBar.style.width = (dH*100).toFixed(1)+"%";

  // SQUEEZE panel
  setTag(squeezeTag, (running ? (squeezeStrength>0.25 ? "ACTIVE" : "ARMED") : "IDLE"), (squeezeStrength>0.25 ? "tagGood" : ""));
  sqFlowLbl.textContent = fmt(lastCoolFlow, 2);
  const flow01 = clamp((lastCoolFlow - m_min)/(m_max - m_min), 0, 1);
  sqFlowBar.style.width = (flow01*100).toFixed(1)+"%";

  sqStrengthLbl.textContent = Math.round(squeezeStrength*100) + "%";
  sqStrengthBar.style.width = (squeezeStrength*100).toFixed(1)+"%";

  const clamps = tileClampSetpoints(risks, squeezeStrength);
  tileClampLbl.textContent =
    `${Math.round(clamps.nose*100)} / ${Math.round(clamps.lead*100)} / ${Math.round(clamps.gaps*100)} %`;

  // Protection summary (live)
  const pOn = (plasmaDuty >= 0.18);
  const sOn = (squeezeStrength >= 0.25);
  protSummary.textContent =
`PLASMA: ${pOn ? "ON" : "OFF"}  (duty=${fmt(plasmaDuty,2)})  •  SQUEEZE: ${sOn ? "ON" : "OFF"}  (strength=${Math.round(squeezeStrength*100)}%)
Protected (front): Nose/Lead/Inlet  •  Protected (TPS): Nose/Lead/WBJ/Gaps
Current step plasma text: ${String(s.plasma||"NONE")}`;

  // Ride index (derived; display only)
  stabBaseLbl.textContent = fmt(stab, 2);
  const ride = clamp(stab + 0.08*plasmaDuty + 0.06*squeezeStrength, 0, 1);
  rideLbl.textContent = fmt(ride, 2);
  rideBar.style.width = (ride*100).toFixed(1)+"%";
  setTag(rideTag, ride >= 0.70 ? "STABLE" : (ride >= 0.45 ? "CAUTION" : "UNSTABLE"),
    ride >= 0.70 ? "tagGood" : (ride >= 0.45 ? "tagWarn" : ""));

  stackExplain.textContent =
`What’s happening right now (live):
• Plasma Buffer (front): ${pOn ? "active" : "not active"} — it conditions the shock layer to reduce peak fluctuations (toy: reduces q/H penalties slightly).
• Shock/Heat Moderation: showing q_eff and H_eff derived from duty; this represents “smoother ride” by softening peaks, not removing the shock.
• SQUEEZE TPS (tiles+coolant): ${sOn ? "active" : "armed"} — tile clamp setpoints rise with zone risk, and coolant flow increases with heating/Cold/Mach.
• Protected zone highlights on the airframe map:
  - Blue glow = Plasma-protected zones (front-facing compression region)
  - Green glow = SQUEEZE-protected zones (tile/gap/coolant management)
  - White edge = BOTH systems contributing in the same zone.`;

  // ------------------- Helix panel render (existing) -------------------
  hxWindowLbl.textContent = `${HELIX_SEG_START_MIN.toFixed(0)}–${HELIX_SEG_END_MIN.toFixed(0)} min`;
  const hxActive = (helixGain > 0.001);
  hxStateLbl.textContent = hxActive ? "ACTIVE" : (running ? "ARMED" : "IDLE");
  hxStateLbl.className = hxActive ? "good" : (running ? "warn" : "warn");

  const x0 = 40, x1 = 620, yMid = 102, yAmp = 70;
  let u = 0;
  if (tMin <= HELIX_SEG_START_MIN) u = 0;
  else if (tMin >= HELIX_SEG_END_MIN) u = 1;
  else u = (tMin - HELIX_SEG_START_MIN) / (HELIX_SEG_END_MIN - HELIX_SEG_START_MIN);

  const tSec = u * 10*60;
  const w = (2*Math.PI) / HELIX_PERIOD_SEC;
  const y = yMid - yAmp * Math.sin(w * tSec);
  const x = x0 + (x1-x0) * u;
  hxDot.setAttribute("cx", x.toFixed(2));
  hxDot.setAttribute("cy", y.toFixed(2));

  const stabRaw = stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen, 0);
  const phaseDeg = (hx.w * hx.localSec * 180/Math.PI) % 360;
  hxLive.textContent =
`helixGain      = ${fmt(helixGain,2)}
altOffset       = ${fmt(hx.altOffsetKm,2)} km
lateralSwirl    = (${fmt(hx.xKm,2)}, ${fmt(hx.yKm,2)}) km
phase           = ${fmt(phaseDeg,1)}°
a_lateral       = ${fmt(hx.aLat_mps2,2)} m/s²

stability(raw)  = ${fmt(stabRaw,2)}
stability(helix)= ${fmt(stab,2)}
Δstability      = ${fmt(stab - stabRaw,2)}

q penalty red.  = ${(hx.qRed*100).toFixed(1)}%
H penalty red.  = ${(hx.hRed*100).toFixed(1)}%`;
}

function loop(ts){
  if (!running) return;
  if (lastTs == null) lastTs = ts;

  const dtReal = (ts - lastTs) / 1000.0;
  lastTs = ts;

  const eff = effectiveSpeedSimMinPerSec();
  const dtMin = eff * dtReal;
  tMin += dtMin;

  const {s, MachPlan, AltPlan} = plannedAt(tMin);
  const dtSimSec = dtMin * 60.0;

  const aMach = 1 - Math.exp(-dtSimSec / Math.max(0.5, tauMachSec()));
  const aAlt  = 1 - Math.exp(-dtSimSec / Math.max(0.5, tauAltSec()));
  MachAct += (MachPlan - MachAct) * aMach;
  AltAct  += (AltPlan  - AltAct ) * aAlt;

  const Aatm = atmAt(AltAct);
  const V = MachAct * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;
  const Cold = coldIndex(Aatm.T);

  // coolant
  const mDotCmd = coolantCommand(H, Cold, MachAct);
  let mDot = mDotCmd;

  clampRemainToCaps();
  if (coolantRemain <= 0 || dtSimSec <= 0){
    mDot = 0;
  } else {
    const maxPossible = coolantRemain / dtSimSec;
    mDot = Math.min(mDotCmd, maxPossible);
  }
  lastCoolFlow = mDot;
  coolantRemain = Math.max(0, coolantRemain - (mDot * dtSimSec));

  // thermal update
  const coolFrac = (m_max > m_min) ? clamp((mDot - m_min)/(m_max - m_min), 0, 1) : 0;
  const kCoolEff = k_cool * (1 + 1.6*coolFrac);
  const heatTarget = Aatm.T + deltaHot;
  const dT = (k_heat * H * (heatTarget - Tskin)) - (kCoolEff * (Tskin - Aatm.T));
  Tskin += dT * (dtSimSec/60.0);

  // fuel burn
  const burns = burnRatesForStep(s);
  jetFuelRemain = Math.max(0, jetFuelRemain - burns.jet * dtMin);
  scramFuelRemain = Math.max(0, scramFuelRemain - burns.scram* dtMin);

  if (unstableHoldSec > 0) unstableHoldSec = Math.max(0, unstableHoldSec - dtReal);

  // log frame
  const compIdx = clamp((1 + (q_kPa/35.0) + 0.12*MachAct - 1) / (6.0 - 1), 0, 1);
  const plasmaDuty = plasmaDutyFromStep(s, AltAct, MachAct);
  const squeezeStrength = squeezeStrengthFromFlow(lastCoolFlow);

  const risksTmp = updateHotspotsAndReturnRisks({
    Mach:MachAct, compIdx, H, q_kPa,
    stab: clamp(1 - (q_kPa/q_bad_kPa)*0.35 - (H/H_bad)*0.35, 0, 1),
    plasmaDuty, squeezeStrength
  });

  addLogFrame({
    tMin, step: s.step, phase: s.phase,
    Mach: MachAct, AltKm: AltAct, q_kPa, H, Tskin,
    coolantRemain, jetRemain: jetFuelRemain, scramRemain: scramFuelRemain,
    z_nose: risksTmp.nose*100, z_lead: risksTmp.lead*100, z_inlet: risksTmp.inlet*100, z_wbj: risksTmp.wbj*100, z_gaps: risksTmp.gaps*100,
    plasmaDuty, squeezeStrength
  });

  if (tMin >= TRIP_LEN_MIN){
    tMin = TRIP_LEN_MIN;
    running = false;
    setStatus("Ended", "warn");
    setButtons();
  }

  render();
  if (running) requestAnimationFrame(loop);
}

/* ===================== REPORT BUILD/PRINT/CSV ===================== */
function buildReport(){
  const frames = LOG.length;
  if (frames === 0){
    reportSummary.textContent = "No frames logged yet. Click Start, let it run, then click Build Report.";
    return;
  }

  const zoneLines = [];
  for (const z of ZONES){
    const st = zoneStats[z];
    const avg = st.frames ? (st.sum/st.frames) : 0;
    const avgActive = st.activeFrames ? (st.sumActive/st.activeFrames) : 0;
    zoneLines.push(
      `${z.toUpperCase()}: peak=${fmt(st.peak,1)}% • avg=${fmt(avg,1)}% • avg(active)=${fmt(avgActive,1)}% • ` +
      `activeFrames=${st.activeFrames} • hitFrames=${st.hitFrames} • hitEntries=${st.enterHits}`
    );
  }

  const last = LOG[LOG.length-1];
  reportSummary.textContent =
    `Frames logged: ${frames}\n` +
    `Last t=${fmt(last.tMin,2)} min • Mach=${fmt(last.Mach,2)} • Alt=${fmt(last.AltKm,1)} km • q=${fmt(last.q_kPa,1)} kPa • H=${fmt(last.H,2)}\n` +
    `Coolant remaining=${fmt(last.coolantRemain,0)} kg (cap ${fmt(coolCap,0)} kg)\n\n` +
    `Zone stats:\n` + zoneLines.join("\n");

  printSummary.textContent =
    `Frames logged: ${frames}\n` +
    `Final t=${fmt(last.tMin,2)} min; Mach=${fmt(last.Mach,2)}; Alt=${fmt(last.AltKm,1)} km; q=${fmt(last.q_kPa,1)} kPa; H=${fmt(last.H,2)}\n` +
    `Final tanks: Jet=${fmt(last.jetRemain,0)} kg; Scram=${fmt(last.scramRemain,0)} kg; Coolant=${fmt(last.coolantRemain,0)} kg (cap ${fmt(coolCap,0)} kg)\n` +
    `Hit definition: zone risk% ≥ 45 (red blink).`;

  const zoneTable = [];
  zoneTable.push(`<table><thead><tr>
    <th>Zone</th><th>Peak %</th><th>Avg %</th><th>Avg(active ≥30%)</th>
    <th>Active frames</th><th>Hit frames (≥45%)</th><th>Hit entries</th>
  </tr></thead><tbody>`);
  for (const z of ZONES){
    const st = zoneStats[z];
    const avg = st.frames ? (st.sum/st.frames) : 0;
    const avgActive = st.activeFrames ? (st.sumActive/st.activeFrames) : 0;
    zoneTable.push(`<tr>
      <td>${z}</td>
      <td>${fmt(st.peak,1)}%</td>
      <td>${fmt(avg,1)}%</td>
      <td>${fmt(avgActive,1)}%</td>
      <td>${st.activeFrames}</td>
      <td>${st.hitFrames}</td>
      <td>${st.enterHits}</td>
    </tr>`);
  }
  zoneTable.push(`</tbody></table>`);
  printZones.innerHTML = zoneTable.join("");

  const headN = Math.min(200, LOG.length);
  const rows = [];
  rows.push(`<table><thead><tr>
    <th>#</th><th>t(min)</th><th>Step</th><th>Mach</th><th>Alt(km)</th><th>q(kPa)</th><th>H</th><th>Coolant(kg)</th>
    <th>Nose%</th><th>Lead%</th><th>Inlet%</th><th>WBJ%</th><th>Gaps%</th>
  </tr></thead><tbody>`);
  for (let i=0;i<headN;i++){
    const r = LOG[i];
    rows.push(`<tr>
      <td>${i+1}</td>
      <td>${fmt(r.tMin,2)}</td>
      <td>${r.step}</td>
      <td>${fmt(r.Mach,2)}</td>
      <td>${fmt(r.AltKm,1)}</td>
      <td>${fmt(r.q_kPa,1)}</td>
      <td>${fmt(r.H,2)}</td>
      <td>${fmt(r.coolantRemain,0)}</td>
      <td>${fmt(r.z_nose,0)}%</td>
      <td>${fmt(r.z_lead,0)}%</td>
      <td>${fmt(r.z_inlet,0)}%</td>
      <td>${fmt(r.z_wbj,0)}%</td>
      <td>${fmt(r.z_gaps,0)}%</td>
    </tr>`);
  }
  rows.push(`</tbody></table>`);
  printLog.innerHTML = rows.join("");
}

function downloadCSV(){
  if (LOG.length === 0){
    reportSummary.textContent = "No data to export. Run the sim first.";
    return;
  }
  const cols = ["tMin","step","phase","Mach","AltKm","q_kPa","H","Tskin","coolantRemain","jetRemain","scramRemain","z_nose","z_lead","z_inlet","z_wbj","z_gaps","plasmaDuty","squeezeStrength"];
  const lines = [cols.join(",")];

  for (const r of LOG){
    const line = cols.map(c=>{
      const v = r[c];
      if (typeof v === "string") return `"${v.replace(/"/g,'""')}"`;
      return (isFinite(v) ? String(v) : "");
    }).join(",");
    lines.push(line);
  }

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "japan_paris_compression_log.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===================== RESET/INIT ===================== */
function setTripLen(){
  el("tripLen").textContent = `${TRIP_LEN_MIN.toFixed(0)} min`;
}
function applySliderCapsWhenStopped(){
  syncCapsFromSliders();
  if (!running){
    refillAllTanksToCaps();
    setTankBars();
  } else {
    clampRemainToCaps();
    setTankBars();
  }
}
function resetAll(){
  running = false;
  lastTs = null;
  tMin = 0.0;
  MachAct = 0.0;
  AltAct = 0.0;
  Tskin = atmAt(0).T;
  lastCoolFlow = 0.0;
  depReal = null;

  syncCapsFromSliders();
  refillAllTanksToCaps();

  unstableHoldSec = 0.0;

  setStatus("Stopped", "warn");
  setButtons();

  updateMassLabels();
  setTankBars();

  renderDepTimes();
  renderArrivalETA();

  render();
  highlightStep(null);
}

/* ===================== EVENTS ===================== */
btnStart.addEventListener("click", ()=>{
  if (!depReal) depReal = new Date();
  renderDepTimes();

  syncCapsFromSliders();

  const startingFresh = (tMin <= 0.0001) || (tMin >= TRIP_LEN_MIN - 1e-6);
  if (startingFresh){
    tMin = 0.0;
    MachAct = 0;
    AltAct = 0;
    Tskin = atmAt(0).T;
    refillAllTanksToCaps();
  } else {
    clampRemainToCaps();
  }

  if (coolCap > 0 && coolantRemain === 0 && startingFresh){
    coolantRemain = coolCap;
  }

  running = true;
  lastTs = null;
  setStatus("Running", "good");
  setButtons();
  requestAnimationFrame(loop);
});

btnStop.addEventListener("click", ()=>{
  running = false;
  lastTs = null;
  setStatus("Stopped", "warn");
  setButtons();
  render();
});

btnReset.addEventListener("click", resetAll);

spd.addEventListener("input", ()=>{
  spdLbl.textContent = spd.value + "×";
  renderArrivalETA();
});

[assistOn, showLabels, hotSensitivity, coolStrength].forEach(x=>{
  x.addEventListener("input", ()=>render());
});

[mAir,mScramSys,mJetFuel,mScramFuel,mCoolant,unmanned].forEach(x=>{
  x.addEventListener("input", ()=>{
    updateMassLabels();
    renderArrivalETA();
    applySliderCapsWhenStopped();
    render();
  });
});

btnReport.addEventListener("click", buildReport);
btnPrint.addEventListener("click", ()=>{ buildReport(); window.print(); });
btnCSV.addEventListener("click", downloadCSV);
btnClearLog.addEventListener("click", clearLog);

/* ===================== INIT ===================== */
buildTable();
setTripLen();
spdLbl.textContent = spd.value + "×";

buildHelixSVGPath();

setInterval(()=>{
  updateMassLabels();
  renderArrivalETA();
  if (!running){
    if (!depReal) renderDepTimes();
    render();
  }
}, 1000);

clearLog();
resetAll();
</script>
</body>
</html>
