<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ferri + CST Curvature Drive (Theory) — Launch to Space Simulator</title>
  <style>
    :root{
      --bg0:#070A12; --bg1:#0C1230; --card:#0E1738cc; --stroke:#26336a;
      --txt:#E9EEFF; --mut:#AAB6FF; --good:#3CFFB0; --warn:#FFD36A; --bad:#FF5A7A;
      --accent:#79B7FF; --accent2:#C5A3FF;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a7a55 0%, transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, #6a2aa855 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      padding:18px 18px 10px;
      border-bottom:1px solid #1a2555;
      background: linear-gradient(180deg, #0a1026cc, #0a102600);
      position: sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
    }
    .titleRow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{color:var(--mut); font-size:12px; margin-top:6px; max-width:1100px; line-height:1.35}
    .wrap{padding:14px 18px 22px; max-width:1240px; margin:0 auto;}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: 0 10px 30px #00000055;
      overflow:hidden;
    }
    .cardHead{
      padding:12px 12px 10px;
      border-bottom:1px solid #22306a;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead b{font-size:13px; letter-spacing:.2px}
    .cardBody{padding:12px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid #2d3d82; color:var(--txt);
      background: linear-gradient(180deg, #16255a, #0f1b42);
      border-radius:12px; padding:10px 12px; font-weight:650;
      cursor:pointer; transition:.12s transform,.12s filter,.12s opacity;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:.45; cursor:not-allowed}
    .pill{
      padding:6px 10px; border-radius:999px; border:1px solid #2d3d82;
      color:var(--mut); font-size:12px; font-family:var(--mono);
      background:#0a1436aa;
    }
    .kv{
      display:grid; grid-template-columns: 1fr auto;
      gap:8px 10px; align-items:baseline;
      font-family:var(--mono); font-size:12px;
    }
    .kv .k{color:var(--mut)}
    .kv .v{color:var(--txt); text-align:right}
    .kv .v.good{color:var(--good)}
    .kv .v.warn{color:var(--warn)}
    .kv .v.bad{color:var(--bad)}
    .sep{height:10px}
    .hr{height:1px; background:#22306a; margin:10px 0}
    .mini{color:var(--mut); font-size:12px; line-height:1.35}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:520px){ .twoCol{grid-template-columns:1fr} }

    /* HUD */
    .hud{
      position:relative;
      min-height:520px;
      background:
        radial-gradient(900px 520px at 55% 40%, #1f3cff22 0%, transparent 60%),
        linear-gradient(180deg, #07102a, #050918);
      border-radius: var(--r);
      border:1px solid #22306a;
      overflow:hidden;
    }
    .hudTop{
      position:absolute; left:12px; top:12px; right:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      pointer-events:none;
    }
    .hudBadge{
      pointer-events:none;
      padding:7px 10px; border-radius:12px;
      border:1px solid #2d3d82;
      background:#0a1436aa;
      font-family:var(--mono); font-size:12px; color:var(--mut);
    }
    canvas{display:block; width:100%; height:520px}
    .logBox{
      height:240px; overflow:auto; font-family:var(--mono);
      font-size:12px; line-height:1.35; color:var(--txt);
      padding:10px; background:#07102a; border:1px solid #22306a;
      border-radius: var(--r);
      white-space:pre-wrap;
    }

    /* Print */
    @media print{
      header, .noPrint{display:none !important}
      body{background:#fff; color:#000}
      .wrap{max-width:none}
      .card{box-shadow:none; border:1px solid #999; background:#fff}
      .logBox{border:1px solid #999; background:#fff; color:#000}
    }
  </style>
</head>
<body>
<header>
  <div class="titleRow">
    <div>
      <h1>Ferri + CST Curvature Drive (Theory) — Launch to Space Simulator</h1>
      <div class="sub">
        Educational “systems-integration” sim inspired by Ferri-style compressible-flow thinking (inlet/drag/heating) plus a <span style="color:var(--accent)">mass–energy ledger</span> and a <span style="color:var(--accent2)">CST curvature assist</span> (theoretical).
        Modes: Scramjet (air-breathing) → Rocket → Fusion/Nuclear “Field Assist” (reduces effective gravity/drag in the sim).
      </div>
    </div>
    <div class="pill" id="pillStatus">STATUS: IDLE</div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls + Live Readouts -->
    <div class="card">
      <div class="cardHead">
        <b>Controls</b>
        <span class="pill" id="pillMode">MODE: —</span>
      </div>
      <div class="cardBody">
        <div class="btnRow noPrint">
          <button id="btnArm">Arm Rocket</button>
          <button id="btnStart" disabled>Take Off</button>
          <button id="btnReset">Reset</button>
          <button id="btnPrint">Print Readings</button>
        </div>

        <div class="hr"></div>

        <div class="twoCol">
          <div class="card" style="border-radius:14px">
            <div class="cardHead"><b>Mission Targets</b><span class="pill">Point A → Point B</span></div>
            <div class="cardBody">
              <div class="kv">
                <div class="k">Point A (Earth)</div><div class="v" id="A_loc">Lat 25.88, Lon -97.50</div>
                <div class="k">Point B (Space)</div><div class="v" id="B_loc">Vector: +Up +East</div>
                <div class="k">Kármán line</div><div class="v" id="targetK">100.0 km</div>
                <div class="k">“Outer space” target</div><div class="v" id="targetAlt">160.0 km</div>
                <div class="k">Target speed</div><div class="v" id="targetV">7.80 km/s</div>
              </div>
              <div class="sep"></div>
              <div class="mini">
                Vector path: a gentle “curvature” (pitch program) that arcs from vertical climb to downrange acceleration.
              </div>
            </div>
          </div>

          <div class="card" style="border-radius:14px">
            <div class="cardHead"><b>Clocks</b><span class="pill">UTC + CST + Interstellar</span></div>
            <div class="cardBody">
              <div class="kv">
                <div class="k">UTC</div><div class="v" id="utcNow">—</div>
                <div class="k">CST Time (sim)</div><div class="v" id="cstNow">—</div>
                <div class="k">CST dilation (field)</div><div class="v" id="cstDil">1.000×</div>
                <div class="k">Interstellar time</div><div class="v" id="isTime">—</div>
              </div>
              <div class="sep"></div>
              <div class="mini">
                CST dilation here is a **control variable** tied to “field assist” power (theoretical). It does not claim real GR validity—it's a systems knob.
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card" style="border-radius:14px">
          <div class="cardHead"><b>Live Vehicle Telemetry</b><span class="pill" id="pillPhase">PHASE: READY</span></div>
          <div class="cardBody">
            <div class="kv" id="kvTelemetry">
              <!-- filled by JS -->
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: HUD + Logs -->
    <div class="card">
      <div class="cardHead">
        <b>Flight HUD</b>
        <span class="pill" id="pillT">t = 0.0 s</span>
      </div>
      <div class="cardBody">
        <div class="hud">
          <div class="hudTop">
            <div class="hudBadge" id="hudLeft">ALT — | V — | Mach —</div>
            <div class="hudBadge" id="hudRight">Heat — | q — | g_eff —</div>
          </div>
          <canvas id="cv" width="1200" height="520"></canvas>
        </div>

        <div class="sep"></div>

        <div class="twoCol">
          <div>
            <div class="mini"><b>Event Log (captured from Takeoff → Space)</b></div>
            <div class="sep"></div>
            <div class="logBox" id="logBox"></div>
          </div>
          <div>
            <div class="mini"><b>Run Summary (auto-updates)</b></div>
            <div class="sep"></div>
            <div class="card" style="border-radius:14px">
              <div class="cardBody">
                <div class="kv" id="kvSummary"></div>
              </div>
            </div>
            <div class="sep"></div>
            <div class="mini">
              Model includes: simplified atmosphere, drag, “compression heating” proxy, Ferri-style inlet total-pressure loss proxy, thrust/power ledger, and a curvature assist factor driven by nuclear/fusion power.
            </div>
          </div>
        </div>

        <!-- Print-only block -->
        <div class="sep"></div>
        <div class="card" style="border-radius:14px">
          <div class="cardHead"><b>Printable Readings</b><span class="pill">Included in Print</span></div>
          <div class="cardBody">
            <div class="mini">When you click <b>Print Readings</b>, your telemetry + full log prints cleanly.</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<script>
/* =========================================================
   Ferri + CST Curvature Drive (Theory) — Simplified Simulator
   =========================================================
   - Not a real flight dynamics tool; it is a “systems panel”
   - Emphasis: integration + ledgers (momentum / power / energy)
   - Modes:
     1) SCRAMJET (Mach 3–8, alt < 30 km)  [air-breathing proxy]
     2) ROCKET   (anywhere after ignition)
     3) FIELD ASSIST (nuclear/fusion power -> reduces effective g/drag in sim)
*/

// ---------- Constants ----------
const g0 = 9.80665;          // m/s^2
const Re = 6371000;          // m
const gamma = 1.4;
const Rair = 287.05;
const T0 = 288.15;           // K
const rho0 = 1.225;          // kg/m^3
const H = 8500;              // m scale height
const a0 = Math.sqrt(gamma * Rair * T0);

const targetAlt = 160e3;     // m
const karman = 100e3;        // m
const targetV = 7800;        // m/s  (orbital-ish)

// “Energy equivalence” ledger
const c = 299792458;         // m/s
const fusionMassFrac = 0.007; // ~0.7% of reacting mass to energy (DT order)
const etaPowerToField = 0.35; // power -> field “coupling” (toy)
const etaPowerToJet  = 0.65;  // power -> exhaust kinetic (toy)

// Vehicle geometry (toy)
const Cd = 0.25;
const Aref = 18.0;           // m^2
const heatK = 1.7e-4;        // scaling for heat proxy (~rho*v^3)
const qK = 0.5;              // dynamic pressure coefficient uses q = 0.5*rho*v^2

// ---------- Simulation State ----------
let sim = {
  running:false,
  armed:false,
  t:0,
  dt:0.05,          // s
  logEvery:1.0,     // s
  _logAcc:0,

  // Kinematics (1D up with pitch program to add “downrange”)
  alt:0,            // m
  downrange:0,      // m
  v:0,              // m/s
  vVert:0,          // m/s
  vHor:0,           // m/s
  pitch:90,         // degrees (90 = straight up)

  // Mass + propellants
  m0:130000 * 0.45359237,  // 130,000 lb -> kg
  mDry:50000  * 0.45359237, // 50,000 lb -> kg
  mPayload:10000* 0.45359237, // 10,000 lb -> kg (not burned)
  m:0,
  prop:0,           // kg remaining

  // Engines + power
  mode:"IDLE",      // IDLE / SCRAMJET / ROCKET / COAST
  throttle:1.0,     // 0..1
  mdotRocket:220,   // kg/s (toy)
  VeRocket:3600,    // m/s (toy)
  mdotFusion:1.5,   // kg/s reacting mass (toy)
  Pnuclear:120e6,   // W baseline reactor (toy)
  PfusionMax:4.0e9, // W maximum fusion power (toy)
  fusionOn:true,
  nuclearOn:true,

  // Ferri-ish inlet/combustion proxies
  inletTPR:1.0,     // total pressure recovery 0..1
  shockLoss:0,      // 0..1
  chemLimit:0,      // 0..1 (residence-time/kinetics limiter)

  // Field/CST
  fieldLevel:0,     // 0..1
  cstDil:1.0,       // dilation factor
  gEff: g0,         // effective g under field assist (toy)
  dragFactor:1.0,   // reduced by field (toy)
  heatFactor:1.0,   // reduced by field (toy)

  // Telemetry derived
  rho:rho0,
  T:T0,
  a:a0,
  mach:0,
  q:0,
  Tstag:T0,
  heat:0,

  // Accumulators
  impulse:0,        // N*s
  Etotal:0,         // J total generated (nuclear+fusion)
  Efield:0,         // J put into field (toy)
  Ejet:0,           // J put into exhaust kinetic
  mEqTotal:0,       // kg equivalent for Etotal
  mEqField:0,       // kg eq for Efield

  // Termination flags
  reachedKarman:false,
  reachedTarget:false
};

// init mass/prop
function resetSim(){
  sim.running=false;
  sim.armed=false;
  sim.t=0; sim._logAcc=0;
  sim.alt=0; sim.downrange=0;
  sim.v=0; sim.vVert=0; sim.vHor=0;
  sim.pitch=90;

  sim.m = sim.m0;
  // Propellant = total - dry - payload (cannot be burned)
  sim.prop = Math.max(0, sim.m0 - sim.mDry - sim.mPayload);

  sim.mode="IDLE";
  sim.throttle=1.0;

  sim.inletTPR=1.0; sim.shockLoss=0; sim.chemLimit=0;

  sim.fieldLevel=0; sim.cstDil=1.0;
  sim.gEff=g0; sim.dragFactor=1.0; sim.heatFactor=1.0;

  sim.rho=rho0; sim.T=T0; sim.a=a0; sim.mach=0;
  sim.q=0; sim.Tstag=T0; sim.heat=0;

  sim.impulse=0;
  sim.Etotal=0; sim.Efield=0; sim.Ejet=0;
  sim.mEqTotal=0; sim.mEqField=0;

  sim.reachedKarman=false;
  sim.reachedTarget=false;

  logClear();
  logLine("READY — Click “Arm Rocket”, then “Take Off”.");
  uiSync();
  draw();
}

// ---------- Atmosphere + aero ----------
function atmosphere(alt){
  const h = Math.max(0, alt);
  const rho = rho0 * Math.exp(-h/H);
  // Simple lapse until 11 km, then clamp
  let T = T0 - 0.0065 * Math.min(h,11000);
  if (h > 11000) T = (T0 - 0.0065*11000); // isothermal above for toy
  const a = Math.sqrt(gamma * Rair * T);
  return {rho, T, a};
}

// “Compression heating” proxy via stagnation temperature
function stagnationTemp(T, M){
  return T * (1 + (gamma-1)/2 * M*M);
}

// Dynamic pressure
function dynPressure(rho, v){
  return 0.5 * rho * v*v;
}

// Drag
function drag(rho, v){
  return Cd * Aref * dynPressure(rho,v);
}

// Heat proxy ~ rho*v^3
function heatProxy(rho, v){
  return heatK * rho * v*v*v; // arbitrary unit
}

// ---------- Ferri-ish inlet loss proxies ----------
function ferriInletLoss(M){
  // Stronger shocks at higher Mach => more total-pressure loss
  // Keep gentle; Ferri wanted to preserve total pressure.
  const shock = clamp((M - 3) / 8, 0, 1);     // starts at Mach 3
  const shockLoss = 0.55 * shock * shock;     // nonlinear penalty
  const tpr = clamp(1 - shockLoss, 0.25, 1);  // total pressure recovery
  return {shockLoss, tpr};
}

function chemistryLimit(M, alt){
  // Mixing / residence-time constraints worsen with Mach & low density.
  // Toy: best around Mach 5 and 15 km, worse outside.
  const mTerm = 1 - Math.min(1, Math.abs(M - 5) / 4);
  const aTerm = 1 - Math.min(1, Math.abs(alt - 15000) / 25000);
  const limit = clamp(0.25 + 0.75 * mTerm * aTerm, 0.15, 1);
  return limit;
}

// ---------- Field / CST (toy) ----------
function updateFieldFromPower(Pavailable){
  // Turn some power into “field level”
  // Field level rises with log(power), saturates at 1.
  const Pnorm = Pavailable / 5e9; // 5 GW scale
  const level = clamp(Math.log10(1 + 9*Pnorm) / Math.log10(10), 0, 1);

  sim.fieldLevel = level;

  // Toy: field reduces effective gravity and aero penalties
  sim.gEff = g0 * (1 - 0.55*level);        // up to 55% g reduction (toy)
  sim.dragFactor = 1 - 0.40*level;         // up to 40% drag reduction
  sim.heatFactor = 1 - 0.50*level;         // up to 50% heating reduction

  // CST dilation as a “readout” tied to field level (toy)
  sim.cstDil = 1 + 0.08*level;             // up to +8% dilation in sim clock
}

// ---------- Helpers ----------
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmt(x, d=2){ return Number.isFinite(x) ? x.toFixed(d) : "—"; }
function fmtInt(x){ return Number.isFinite(x) ? Math.round(x).toString() : "—"; }
function fmtSI(x, unit){
  if(!Number.isFinite(x)) return "—";
  const ax = Math.abs(x);
  if(ax >= 1e9) return (x/1e9).toFixed(2) + " G" + unit;
  if(ax >= 1e6) return (x/1e6).toFixed(2) + " M" + unit;
  if(ax >= 1e3) return (x/1e3).toFixed(2) + " k" + unit;
  return x.toFixed(2) + " " + unit;
}
</script>
<script>
// ---------- Logging ----------
const logBox = document.getElementById("logBox");
function logLine(s){
  logBox.textContent += (logBox.textContent ? "\n" : "") + s;
  logBox.scrollTop = logBox.scrollHeight;
}
function logClear(){ logBox.textContent=""; }

// ---------- Mode logic ----------
function chooseMode(){
  if(!sim.running) return;

  // Scramjet phase: Mach 3–8 and alt < 30 km, while armed and before rocket dominance
  if(sim.alt < 30000 && sim.mach >= 3 && sim.mach <= 8 && sim.prop > 0){
    sim.mode = "SCRAMJET";
    return;
  }
  // Rocket phase: once armed and either above scramjet envelope or when Mach too low initially
  if(sim.armed && sim.prop > 0){
    sim.mode = "ROCKET";
    return;
  }
  // Coast
  sim.mode = "COAST";
}

// ---------- Power sources ----------
function getAvailablePower(){
  let P = 0;
  if(sim.nuclearOn) P += sim.Pnuclear;
  if(sim.fusionOn){
    // Fusion power is tied to mdotFusion and mass->energy fraction
    const Pf = sim.mdotFusion * fusionMassFrac * c*c; // W (J/s)
    P += Math.min(Pf, sim.PfusionMax);
  }
  return P;
}

// ---------- Thrust models ----------
function thrustScramjet(rho, M){
  // Thrust proxy: depends on inlet total pressure recovery, chemistry limit, and dynamic pressure
  // Ferri idea: preserve total pressure => TPR matters.
  const {shockLoss, tpr} = ferriInletLoss(M);
  sim.shockLoss = shockLoss;
  sim.inletTPR = tpr;

  const chem = chemistryLimit(M, sim.alt);
  sim.chemLimit = chem;

  // Use q*A as “air processing scale” and multiply by efficiencies
  const q = dynPressure(rho, sim.v);
  const base = q * Aref * 0.85; // N-ish scale
  const eff = tpr * chem * sim.throttle;

  // Penalize heating extremes: if stagnation too high, throttle back automatically
  const hotPenalty = clamp(1.0 - (sim.Tstag - 1200)/900, 0.15, 1.0); // toy
  return base * eff * hotPenalty;
}

function thrustRocket(){
  // Classical momentum: F = mdot*(Ve - V0) + (pe - p0)Ae (pressure term ignored)
  // Here: mdot and Ve adjustable; reduce mdot when prop low.
  const md = sim.mdotRocket * sim.throttle;
  const F = md * Math.max(0, sim.VeRocket - sim.v);
  return {F, mdot: md};
}

// ---------- Pitch program (curvature vector) ----------
function pitchProgram(){
  // Start vertical, gradually pitch over with altitude to add downrange velocity
  // “Curvature” feel: smooth arcing path
  const h = sim.alt;
  let pitch = 90;
  if(h > 2000) pitch = 90 - 15 * clamp((h-2000)/8000, 0, 1);     // to 75 by 10 km
  if(h > 12000) pitch = 75 - 25 * clamp((h-12000)/28000, 0, 1);  // to 50 by 40 km
  if(h > 40000) pitch = 50 - 20 * clamp((h-40000)/60000, 0, 1);  // to 30 by 100 km
  if(h > 100000) pitch = 30 - 10 * clamp((h-100000)/60000, 0, 1);// to 20 by 160 km
  sim.pitch = clamp(pitch, 10, 90);
}

// ---------- Main step ----------
function step(){
  // clocks
  const atm = atmosphere(sim.alt);
  sim.rho = atm.rho; sim.T = atm.T; sim.a = atm.a;

  sim.mach = sim.a > 0 ? (sim.v / sim.a) : 0;
  sim.q = dynPressure(sim.rho, sim.v);
  sim.Tstag = stagnationTemp(sim.T, sim.mach);
  sim.heat = heatProxy(sim.rho, sim.v);

  // Power -> field
  const P = getAvailablePower();
  updateFieldFromPower(P);

  // Allocate power to “field” and “jet” ledgers (toy split)
  const Pfield = P * etaPowerToField;
  const Pjet   = P * etaPowerToJet;

  sim.Etotal += P * sim.dt;
  sim.Efield += Pfield * sim.dt;
  sim.Ejet   += Pjet   * sim.dt;

  sim.mEqTotal = sim.Etotal / (c*c);
  sim.mEqField = sim.Efield / (c*c);

  // mode
  chooseMode();
  pitchProgram();

  // Forces
  const D = drag(sim.rho, sim.v) * sim.dragFactor;
  const heatAdj = sim.heat * sim.heatFactor;

  let Fth = 0;
  let mdotUsed = 0;

  if(sim.mode === "SCRAMJET"){
    // Air-breathing: no onboard oxidizer consumption modeled; minimal fuel draw
    Fth = thrustScramjet(sim.rho, sim.mach);
    // fuel draw toy: depends on thrust
    mdotUsed = clamp(Fth / 2.2e5, 0.2, 6.0); // kg/s
  } else if(sim.mode === "ROCKET"){
    const rr = thrustRocket();
    Fth = rr.F;
    mdotUsed = rr.mdot;
    // in rocket mode, inlet/chem proxies irrelevant
    sim.inletTPR = 1.0; sim.shockLoss = 0; sim.chemLimit = 1.0;
  } else {
    Fth = 0; mdotUsed = 0;
    sim.inletTPR = 1.0; sim.shockLoss = 0; sim.chemLimit = 1.0;
  }

  // Burn prop
  if(sim.prop > 0 && mdotUsed > 0){
    const dm = mdotUsed * sim.dt;
    const burn = Math.min(sim.prop, dm);
    sim.prop -= burn;
    sim.m -= burn;
  } else if(sim.prop <= 0){
    sim.prop = 0;
    // Once out, force coast
    if(sim.mode !== "COAST") sim.mode = "COAST";
  }

  // Resolve thrust into vertical/horizontal based on pitch
  const pitchRad = sim.pitch * Math.PI/180;
  const Fv = Fth * Math.sin(pitchRad);
  const Fh = Fth * Math.cos(pitchRad);

  // Effective gravity (toy) + “Earth curvature” small variation with altitude
  const g = sim.gEff * (Re*Re) / ((Re + sim.alt)*(Re + sim.alt));

  // Accelerations
  const av = (Fv - D * (sim.vVert/(sim.v+1e-6)) - sim.m*g) / sim.m;
  const ah = (Fh - D * (sim.vHor/(sim.v+1e-6))) / sim.m;

  // Integrate velocities
  sim.vVert += av * sim.dt;
  sim.vHor  += ah * sim.dt;

  // prevent negative vertical speed at ground before liftoff thrust
  if(sim.alt <= 0 && sim.vVert < 0) sim.vVert = 0;

  // Integrate position
  sim.alt += sim.vVert * sim.dt;
  sim.downrange += sim.vHor * sim.dt;

  // Clamp ground
  if(sim.alt < 0){ sim.alt = 0; }

  // Total speed
  sim.v = Math.sqrt(sim.vVert*sim.vVert + sim.vHor*sim.vHor);

  // Impulse
  sim.impulse += Fth * sim.dt;

  // Milestones
  if(!sim.reachedKarman && sim.alt >= karman){
    sim.reachedKarman = true;
    logLine(`MILESTONE @ t=${fmt(sim.t,1)}s: Crossed Kármán line (100 km).`);
  }
  if(!sim.reachedTarget && sim.alt >= targetAlt){
    sim.reachedTarget = true;
    logLine(`MILESTONE @ t=${fmt(sim.t,1)}s: Reached outer-space target altitude (160 km).`);
  }

  // Auto-stop condition: reached target alt AND near orbital speed OR time limit
  if((sim.reachedTarget && sim.v >= 6800) || sim.t > 900){
    sim.running = false;
    document.getElementById("pillStatus").textContent = "STATUS: COMPLETE";
    document.getElementById("pillPhase").textContent = "PHASE: COMPLETE";
    logLine(`COMPLETE: t=${fmt(sim.t,1)}s | alt=${fmt(sim.alt/1000,2)} km | v=${fmt(sim.v/1000,2)} km/s`);
    uiSync();
  }

  // Log cadence
  sim._logAcc += sim.dt;
  if(sim._logAcc >= sim.logEvery){
    sim._logAcc = 0;
    const mode = sim.mode.padEnd(8," ");
    logLine(
      `t=${fmt(sim.t,1)}s | ${mode} | alt=${fmt(sim.alt/1000,2)}km | v=${fmt(sim.v,1)}m/s | M=${fmt(sim.mach,2)} | q=${fmtSI(sim.q,"Pa")} | T0=${fmt(sim.Tstag,0)}K | field=${fmt(sim.fieldLevel,2)}`
    );
  }

  sim.t += sim.dt;
}

// ---------- UI Sync ----------
const pillStatus = document.getElementById("pillStatus");
const pillMode = document.getElementById("pillMode");
const pillPhase = document.getElementById("pillPhase");
const pillT = document.getElementById("pillT");

const hudLeft = document.getElementById("hudLeft");
const hudRight = document.getElementById("hudRight");

const kvTelemetry = document.getElementById("kvTelemetry");
const kvSummary = document.getElementById("kvSummary");

function clsBy(value, goodThr, warnThr){
  if(value >= goodThr) return "good";
  if(value >= warnThr) return "warn";
  return "bad";
}

function uiSync(){
  pillT.textContent = `t = ${fmt(sim.t,1)} s`;
  pillMode.textContent = `MODE: ${sim.mode}`;
  pillStatus.textContent = sim.running ? "STATUS: RUNNING" : (sim.armed ? "STATUS: ARMED" : "STATUS: IDLE");

  const phase = sim.running ? "ASCENT" : (sim.reachedTarget ? "COMPLETE" : (sim.armed ? "READY" : "READY"));
  pillPhase.textContent = `PHASE: ${phase}`;

  // Clocks
  const now = new Date();
  document.getElementById("utcNow").textContent = now.toISOString().replace("T"," ").replace("Z"," UTC");
  // CST sim time: UTC + sim seconds scaled by dilation
  const cstMillis = now.getTime() + (sim.t * sim.cstDil * 1000);
  const cstDate = new Date(cstMillis);
  document.getElementById("cstNow").textContent = cstDate.toISOString().replace("T"," ").replace("Z"," CST(sim)");
  document.getElementById("cstDil").textContent = `${fmt(sim.cstDil,3)}×`;

  // “Interstellar time” readout: Julian-like day count (toy)
  const jd = (cstMillis/86400000) + 2440587.5;
  document.getElementById("isTime").textContent = `JD ${fmt(jd,5)}`;

  // HUD badges
  hudLeft.textContent = `ALT ${fmt(sim.alt/1000,2)} km | V ${fmt(sim.v/1000,3)} km/s | Mach ${fmt(sim.mach,2)} | Pitch ${fmt(sim.pitch,0)}°`;
  hudRight.textContent = `Heat ${fmt( (sim.heat*sim.heatFactor), 3)} | q ${fmtSI(sim.q,"Pa")} | g_eff ${fmt(sim.gEff,2)} m/s² | Drag× ${fmt(sim.dragFactor,2)}`;

  // Telemetry key-values
  const veEff = (sim.mode==="ROCKET") ? sim.VeRocket : (sim.mode==="SCRAMJET" ? 2200 + 250*sim.mach : 0);
  const fuelPct = sim.prop / Math.max(1,(sim.m0 - sim.mDry - sim.mPayload));

  const rows = [
    ["Altitude", `${fmt(sim.alt,0)} m (${fmt(sim.alt/1000,2)} km)`],
    ["Downrange", `${fmt(sim.downrange/1000,2)} km`],
    ["Velocity (total)", `${fmt(sim.v,1)} m/s (${fmt(sim.v/1000,3)} km/s)`],
    ["Vertical / Horizontal V", `${fmt(sim.vVert,1)} / ${fmt(sim.vHor,1)} m/s`],
    ["Mach", `${fmt(sim.mach,2)}`],
    ["Atmos density ρ", `${fmt(sim.rho,4)} kg/m³`],
    ["Stagnation Temp T₀", `${fmt(sim.Tstag,0)} K`],
    ["Dynamic pressure q", `${fmtSI(sim.q,"Pa")}`],
    ["Inlet TPR (Ferri)", `${fmt(sim.inletTPR,3)}`],
    ["Shock loss proxy", `${fmt(sim.shockLoss,3)}`],
    ["Chem/residence limit", `${fmt(sim.chemLimit,3)}`],
    ["Propellant remaining", `${fmt(sim.prop,0)} kg (${fmt(fuelPct*100,1)}%)`],
    ["Vehicle mass", `${fmt(sim.m,0)} kg`],
    ["Effective exhaust Ve", `${fmt(veEff,0)} m/s`],
    ["Field level (0..1)", `${fmt(sim.fieldLevel,3)}`],
    ["CST dilation", `${fmt(sim.cstDil,3)}×`],
    ["Energy total (nuc+fus)", `${fmtSI(sim.Etotal,"J")}`],
    ["E → mass equiv (E/c²)", `${fmt(sim.mEqTotal,6)} kg`],
    ["Field energy (toy)", `${fmtSI(sim.Efield,"J")}`],
    ["Field mass equiv", `${fmt(sim.mEqField,6)} kg`],
  ];

  kvTelemetry.innerHTML = rows.map(([k,v])=>{
    return `<div class="k">${k}</div><div class="v">${v}</div>`;
  }).join("");

  // Summary
  const payloadFrac = sim.mPayload / sim.m0;
  const dryFrac = sim.mDry / sim.m0;

  const sum = [
    ["Payload fraction", `${fmt(payloadFrac*100,2)}%`],
    ["Dry fraction", `${fmt(dryFrac*100,2)}%`],
    ["Impulse (∫F dt)", `${fmtSI(sim.impulse,"N·s")}`],
    ["Kármán crossed", sim.reachedKarman ? "YES" : "NO"],
    ["160 km reached", sim.reachedTarget ? "YES" : "NO"],
    ["Target speed (7.8 km/s)", sim.v >= targetV ? "YES" : "NO"],
    ["Mode now", sim.mode],
  ];

  kvSummary.innerHTML = sum.map(([k,v])=>`<div class="k">${k}</div><div class="v">${v}</div>`).join("");
}

// ---------- Animation Loop ----------
let raf = 0;
function tick(){
  if(sim.running){
    // advance multiple substeps per frame for stability
    const steps = 3;
    for(let i=0;i<steps;i++) step();
  }
  uiSync();
  draw();
  raf = requestAnimationFrame(tick);
}
</script>
<script>
// ---------- Canvas drawing ----------
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

function draw(){
  const W = cv.width, Hh = cv.height;
  ctx.clearRect(0,0,W,Hh);

  // Background stars (deterministic-ish)
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#050918";
  ctx.fillRect(0,0,W,Hh);

  // Atmosphere gradient
  const atmTop = Math.max(0, 1 - sim.alt/120000);
  const g = ctx.createLinearGradient(0,Hh,0,0);
  g.addColorStop(0, "#07102a");
  g.addColorStop(0.35, `rgba(30,80,200,${0.20*atmTop})`);
  g.addColorStop(0.70, `rgba(120,60,255,${0.12*atmTop})`);
  g.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,Hh);

  // Horizon / Earth curve (simple arc)
  const earthY = Hh + 260;
  ctx.strokeStyle = "rgba(120,183,255,0.35)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(W*0.5, earthY, 520, Math.PI*1.05, Math.PI*1.95);
  ctx.stroke();

  // Scale mapping
  // alt 0..200km -> y from bottom to top
  const altMax = 200000;
  const y = Hh - (sim.alt/altMax) * (Hh-40) - 20;
  const x = 140 + (sim.downrange/400000) * (W-200); // 0..400km downrange
  const X = clamp(x, 80, W-80);
  const Y = clamp(y, 30, Hh-40);

  // Trajectory path (keep a short history)
  if(!draw.path) draw.path=[];
  if(sim.running){
    draw.path.push({x:X,y:Y, alt:sim.alt});
    if(draw.path.length > 900) draw.path.shift();
  } else {
    // keep path until reset
    if(draw.path.length > 0 && sim.t===0) draw.path=[];
  }

  // Path
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(197,163,255,0.65)";
  ctx.beginPath();
  for(let i=0;i<draw.path.length;i++){
    const p = draw.path[i];
    if(i===0) ctx.moveTo(p.x,p.y);
    else ctx.lineTo(p.x,p.y);
  }
  ctx.stroke();

  // Rocket body
  const s = 10;
  ctx.save();
  ctx.translate(X,Y);
  // rotate with pitch (0 = horizontal)
  const ang = (90 - sim.pitch) * Math.PI/180;
  ctx.rotate(ang);

  // Field “bubble”
  const fb = 18 + 30*sim.fieldLevel;
  ctx.globalAlpha = 0.30;
  ctx.strokeStyle = "rgba(121,183,255,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.ellipse(0,0, fb*1.25, fb*0.85, 0, 0, Math.PI*2);
  ctx.stroke();

  // Plasma glow
  const heatN = clamp((sim.heat*sim.heatFactor)/2.0, 0, 1);
  ctx.globalAlpha = 0.18 + 0.25*heatN;
  ctx.fillStyle = "rgba(255,211,106,1)";
  ctx.beginPath();
  ctx.ellipse(-6,0, 22, 10, 0, 0, Math.PI*2);
  ctx.fill();

  // Rocket
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#E9EEFF";
  ctx.beginPath();
  ctx.moveTo(18,0);
  ctx.lineTo(-14,-7);
  ctx.lineTo(-10,0);
  ctx.lineTo(-14,7);
  ctx.closePath();
  ctx.fill();

  // Exhaust
  if(sim.running && (sim.mode==="ROCKET" || sim.mode==="SCRAMJET")){
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = sim.mode==="ROCKET" ? "rgba(60,255,176,0.9)" : "rgba(121,183,255,0.8)";
    ctx.beginPath();
    ctx.moveTo(-14,0);
    ctx.lineTo(-36,-6);
    ctx.lineTo(-54,0);
    ctx.lineTo(-36,6);
    ctx.closePath();
    ctx.fill();
  }

  ctx.restore();

  // Alt markers
  ctx.globalAlpha = 1;
  ctx.strokeStyle = "rgba(170,182,255,0.25)";
  ctx.lineWidth = 1;
  for(const km of [0,10,20,30,40,60,80,100,120,160,200]){
    const yy = Hh - (km*1000/altMax)*(Hh-40) - 20;
    ctx.beginPath(); ctx.moveTo(60,yy); ctx.lineTo(W-60,yy); ctx.stroke();
    ctx.fillStyle = "rgba(170,182,255,0.55)";
    ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
    ctx.fillText(`${km} km`, 10, yy+4);
  }

  // Labels A & B
  ctx.fillStyle = "rgba(233,238,255,0.9)";
  ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
  ctx.fillText("Point A (Earth)", 78, Hh-24);
  ctx.fillText("Point B (Space target)", W-220, 34);
}

// ---------- Buttons ----------
const btnArm = document.getElementById("btnArm");
const btnStart = document.getElementById("btnStart");
const btnReset = document.getElementById("btnReset");
const btnPrint = document.getElementById("btnPrint");

btnArm.addEventListener("click", ()=>{
  sim.armed = true;
  btnStart.disabled = false;
  logLine("ARMED — Rocket ignition authorized. Scramjet will auto-engage once Mach 3–8 in dense air.");
  uiSync();
});

btnStart.addEventListener("click", ()=>{
  if(!sim.armed) return;
  if(sim.running) return;

  sim.running = true;
  sim.mode = "ROCKET"; // initial liftoff is rocket in this model
  document.getElementById("pillStatus").textContent = "STATUS: RUNNING";
  document.getElementById("pillPhase").textContent = "PHASE: ASCENT";

  logLine("TAKEOFF — Liftoff. Logging begins.");
  logLine("NOTE — Field assist is powered by nuclear+fusion power ledger (toy).");
  uiSync();
});

btnReset.addEventListener("click", ()=>{
  resetSim();
});

btnPrint.addEventListener("click", ()=>{
  // Make sure UI is up to date before print
  uiSync();
  logLine("PRINT — User initiated printout of readings + log.");
  window.print();
});

// ---------- Startup ----------
resetSim();
cancelAnimationFrame(raf);
tick();
</script>

</body>
</html>
