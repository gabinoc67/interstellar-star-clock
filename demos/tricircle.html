<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earth ⇄ Mars 3-Point Curvature Sync Demo</title>
<style>
  :root{
    --bg:#0b0f16; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink); }
  .wrap{ display:grid; grid-template-columns: 1.35fr 0.65fr; gap:14px; padding:14px; }
  canvas{ width:100%; height: calc(100vh - 28px); background:#070a10; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .panel{ height: calc(100vh - 28px); background:var(--panel); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:auto; }
  h1{ font-size:16px; margin:0 0 10px; }
  .tiny{ font-size:12px; color:var(--muted); line-height:1.35; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
  button{
    background:#1f2937; color:var(--ink); border:1px solid #374151; border-radius:10px;
    padding:10px 12px; cursor:pointer;
  }
  button:hover{ filter:brightness(1.08); }
  button.primary{ background:#2563eb; border-color:#1d4ed8; }
  button.danger{ background:#991b1b; border-color:#7f1d1d; }
  .box{ border:1px solid #374151; border-radius:12px; padding:10px; margin:10px 0; background:#0b1220; }
  .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #374151; color:var(--muted); }
  .tag.good{ border-color: rgba(34,197,94,.45); color:#86efac; }
  .tag.warn{ border-color: rgba(245,158,11,.45); color:#fde68a; }
  .tag.bad{ border-color: rgba(239,68,68,.45); color:#fecaca; }
  .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 10px; margin-top:8px; }
  .k{ color:var(--muted); font-size:12px; }
  .v{ font-variant-numeric: tabular-nums; }
  input[type="range"]{ width:100%; }
  textarea{
    width:100%; min-height:200px; resize:vertical;
    border-radius:12px; border:1px solid #374151; background:#060a12; color:var(--ink); padding:10px;
  }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="cv"></canvas>

  <div class="panel">
    <h1>Earth ⇄ Mars 3-Point Curvature Sync Demo (Sun in the middle)</h1>
    <div class="tiny">
      Earth completes 360° first and marks 3 points (Perihelion, Quadrature, Aphelion).
      Then Earth stops and Mars completes 360° and marks its 3 points.
      Finally we check “touch” = closest angular match (same Sun-direction) between any Earth/Mars marked points.
    </div>

    <div class="row">
      <button class="primary" id="startBtn">Start</button>
      <button id="pauseBtn">Pause</button>
      <button class="danger" id="resetBtn">Reset</button>
      <button id="printBtn">Print Report</button>
    </div>

    <div class="box">
      <div class="k">Simulation speed</div>
      <input id="speed" type="range" min="0.2" max="4" step="0.1" value="1" />
      <div class="tiny">Higher = faster sweep.</div>
    </div>

    <div class="box">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="tag" id="phaseTag">Phase: idle</div>
        <div class="tag" id="alignTag">Alignment: waiting</div>
      </div>

      <div class="kv">
        <div class="k">Earth angle (deg)</div><div class="v" id="earthDeg">—</div>
        <div class="k">Mars angle (deg)</div><div class="v" id="marsDeg">—</div>

        <div class="k">Earth r (AU)</div><div class="v" id="earthR">—</div>
        <div class="k">Mars r (AU)</div><div class="v" id="marsR">—</div>

        <div class="k">Earth v (km/s)</div><div class="v" id="earthV">—</div>
        <div class="k">Mars v (km/s)</div><div class="v" id="marsV">—</div>

        <div class="k">Best match Δθ (deg)</div><div class="v" id="matchDeg">—</div>
      </div>
    </div>

    <div class="box">
      <div class="k">Report log</div>
      <textarea id="log" readonly></textarea>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- DOM ----------
  var canvas = document.getElementById("cv");
  var ctx = canvas.getContext("2d");

  function $(id){ return document.getElementById(id); }

  var startBtn = $("startBtn");
  var pauseBtn = $("pauseBtn");
  var resetBtn = $("resetBtn");
  var printBtn = $("printBtn");
  var speedEl  = $("speed");

  var phaseTag = $("phaseTag");
  var alignTag = $("alignTag");
  var earthDegEl = $("earthDeg");
  var marsDegEl  = $("marsDeg");
  var earthREl   = $("earthR");
  var marsREl    = $("marsR");
  var earthVEl   = $("earthV");
  var marsVEl    = $("marsV");
  var matchDegEl = $("matchDeg");
  var logEl      = $("log");

  // ---------- Constants ----------
  var AU = 1.495978707e11;          // m
  var MU_SUN = 1.32712440018e20;    // m^3/s^2

  var Earth = { name:"Earth", a_AU:1.00000011, e:0.01671022, color:"#3b82f6", period_days:365.256 };
  var Mars  = { name:"Mars",  a_AU:1.523679,   e:0.0934,     color:"#fb7185", period_days:686.980 };

  var TP = [
    {label:"Perihelion", theta:0},
    {label:"Quadrature", theta:Math.PI/2},
    {label:"Aphelion", theta:Math.PI}
  ];

  // ---------- Resize canvas properly ----------
  function resize(){
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.getBoundingClientRect();
    canvas.width  = Math.max(600, Math.floor(rect.width  * dpr));
    canvas.height = Math.max(400, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  window.addEventListener("resize", resize);

  // ---------- Math helpers ----------
  function wrap2pi(t){
    t = t % (2*Math.PI);
    return t < 0 ? t + 2*Math.PI : t;
  }
  function deg(r){ return r * 180 / Math.PI; }
  function fmt(n, d){
    if (!isFinite(n)) return "—";
    return n.toFixed(d);
  }

  function rAU(planet, theta){
    var a = planet.a_AU, e = planet.e;
    var p = a*(1 - e*e);
    return p / (1 + e*Math.cos(theta));
  }
  function visViva_kms(planet, r_AU){
    var r = r_AU * AU;
    var a = planet.a_AU * AU;
    var v = Math.sqrt(MU_SUN * (2/r - 1/a)); // m/s
    return v / 1000; // km/s
  }
  function nearAngle(a,b,eps){
    var d = (a-b) % (2*Math.PI);
    if (d > Math.PI) d -= 2*Math.PI;
    if (d < -Math.PI) d += 2*Math.PI;
    return Math.abs(d) <= eps;
  }

  // ---------- Drawing helpers ----------
  function clear(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function drawSun(cx,cy){
    ctx.save();
    // glow
    var grd = ctx.createRadialGradient(cx,cy,2,cx,cy,60);
    grd.addColorStop(0,"rgba(255,215,0,0.95)");
    grd.addColorStop(1,"rgba(255,215,0,0.0)");
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(cx,cy,60,0,2*Math.PI); ctx.fill();
    // core
    ctx.fillStyle="#facc15";
    ctx.beginPath(); ctx.arc(cx,cy,12,0,2*Math.PI); ctx.fill();
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.font="14px system-ui";
    ctx.fillText("SUN", cx+16, cy+5);
    ctx.restore();
  }

  function orbitPoint(cx,cy,pxPerAU, planet, theta){
    var r = rAU(planet, theta);
    return { x: cx + Math.cos(theta)*r*pxPerAU, y: cy + Math.sin(theta)*r*pxPerAU, r_AU:r };
  }

  function drawOrbit(cx,cy,pxPerAU, planet){
    ctx.save();
    ctx.strokeStyle="rgba(255,255,255,0.92)";
    ctx.lineWidth=4;
    ctx.beginPath();
    var steps = 720;
    for (var i=0;i<=steps;i++){
      var th = (i/steps)*2*Math.PI;
      var P = orbitPoint(cx,cy,pxPerAU, planet, th);
      if (i===0) ctx.moveTo(P.x,P.y); else ctx.lineTo(P.x,P.y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawPlanet(cx,cy,pxPerAU, planet, theta){
    var P = orbitPoint(cx,cy,pxPerAU, planet, theta);
    ctx.save();
    ctx.fillStyle=planet.color;
    ctx.beginPath(); ctx.arc(P.x,P.y,8,0,2*Math.PI); ctx.fill();
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.font="13px system-ui";
    ctx.fillText(planet.name, P.x+12, P.y+4);
    ctx.restore();
    return P;
  }

  function drawRadial(cx,cy,x,y){
    ctx.save();
    ctx.strokeStyle="rgba(255,255,255,0.55)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(cx,cy); ctx.lineTo(x,y);
    ctx.stroke();
    ctx.restore();
  }

  function drawMarks(marks){
    ctx.save();
    for (var i=0;i<marks.length;i++){
      var m = marks[i];
      ctx.fillStyle="rgba(255,255,255,0.95)";
      ctx.beginPath(); ctx.arc(m.x,m.y,6,0,2*Math.PI); ctx.fill();
      ctx.fillStyle="rgba(255,255,255,0.8)";
      ctx.font="12px system-ui";
      ctx.fillText(m.label, m.x+10, m.y-10);
    }
    ctx.restore();
  }

  // ---------- State ----------
  var running=false, paused=false;
  var phase="idle"; // idle -> earth -> mars -> done
  var thetaE=0, thetaM=0;
  var markedE = {};
  var markedM = {};
  var marksEarth=[], marksMars=[];
  var baseSweepSeconds = 16; // each 360 sweep duration at speed=1
  var lastT = performance.now();

  function logLine(s){
    logEl.value += s + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function reset(){
    running=false; paused=false; phase="idle";
    thetaE=0; thetaM=0;
    markedE = {}; markedM = {};
    marksEarth=[]; marksMars=[];
    logEl.value="";
    logLine("Reset complete. Click Start.");
    setTags();
    setUI();
  }

  function setTags(){
    phaseTag.textContent = "Phase: " + phase + (paused ? " (paused)" : "");
    phaseTag.className = "tag" + (phase==="done" ? " good" : (phase==="idle" ? "" : " warn"));
  }

  function alignmentReport(){
    if (marksEarth.length<3 || marksMars.length<3) return null;
    var bestD = 1e9, bestE=null, bestM=null;
    for (var i=0;i<marksEarth.length;i++){
      for (var j=0;j<marksMars.length;j++){
        var d = (marksEarth[i].theta - marksMars[j].theta) % (2*Math.PI);
        if (d>Math.PI) d-=2*Math.PI;
        if (d<-Math.PI) d+=2*Math.PI;
        d = Math.abs(d);
        if (d<bestD){ bestD=d; bestE=marksEarth[i]; bestM=marksMars[j]; }
      }
    }
    return { matchDeg: deg(bestD), e:bestE, m:bestM };
  }

  function setUI(){
    if (phase==="idle"){
      earthDegEl.textContent="—"; marsDegEl.textContent="—";
      earthREl.textContent="—"; marsREl.textContent="—";
      earthVEl.textContent="—"; marsVEl.textContent="—";
      matchDegEl.textContent="—";
      alignTag.textContent="Alignment: waiting";
      alignTag.className="tag";
      return;
    }

    // Earth current (always known after start)
    var rect = canvas.getBoundingClientRect();
    var cx = rect.width/2, cy = rect.height/2;
    var pxPerAU = Math.min(rect.width, rect.height)*0.26;

    var PE = orbitPoint(cx,cy,pxPerAU, Earth, thetaE);
    earthDegEl.textContent = fmt(deg(thetaE),1);
    earthREl.textContent = fmt(PE.r_AU,6);
    earthVEl.textContent = fmt(visViva_kms(Earth, PE.r_AU),3);

    // Mars current only after mars phase
    if (phase==="mars" || phase==="done"){
      var PM = orbitPoint(cx,cy,pxPerAU, Mars, thetaM);
      marsDegEl.textContent = fmt(deg(thetaM),1);
      marsREl.textContent = fmt(PM.r_AU,6);
      marsVEl.textContent = fmt(visViva_kms(Mars, PM.r_AU),3);
    } else {
      marsDegEl.textContent="—";
      marsREl.textContent="—";
      marsVEl.textContent="—";
    }

    var R = alignmentReport();
    if (!R){
      matchDegEl.textContent="—";
      alignTag.textContent="Alignment: waiting";
      alignTag.className="tag";
    } else {
      matchDegEl.textContent = fmt(R.matchDeg,3);
      if (R.matchDeg <= 1.5){
        alignTag.textContent = "Alignment: TOUCH (≤1.5°)";
        alignTag.className="tag good";
      } else if (R.matchDeg <= 5){
        alignTag.textContent = "Alignment: close (≤5°)";
        alignTag.className="tag warn";
      } else {
        alignTag.textContent = "Alignment: not close";
        alignTag.className="tag bad";
      }
    }
  }

  function tryMark(planetName){
    var eps = 0.04; // ~2.3°
    var planet = (planetName==="Earth") ? Earth : Mars;
    var theta  = (planetName==="Earth") ? thetaE : thetaM;
    var marked = (planetName==="Earth") ? markedE : markedM;
    var marks  = (planetName==="Earth") ? marksEarth : marksMars;

    for (var i=0;i<TP.length;i++){
      var tp = TP[i];
      if (marked[tp.label]) continue;
      if (nearAngle(theta, tp.theta, eps)){
        // compute in CSS pixels
        var rect = canvas.getBoundingClientRect();
        var cx = rect.width/2, cy = rect.height/2;
        var pxPerAU = Math.min(rect.width, rect.height)*0.26;

        var P = orbitPoint(cx,cy,pxPerAU, planet, tp.theta);
        var v = visViva_kms(planet, P.r_AU);
        marked[tp.label] = true;
        marks.push({ label:tp.label, theta:tp.theta, x:P.x, y:P.y, r_AU:P.r_AU, v_kms:v });
        logLine("[" + planetName + "] Marked " + tp.label + " at θ=" + deg(tp.theta).toFixed(1) + "° | r=" + P.r_AU.toFixed(6) + " AU | v=" + v.toFixed(3) + " km/s");
      }
    }
  }

  // ---------- Main animation ----------
  function tick(now){
    var dt = Math.min(0.05, (now - lastT)/1000);
    lastT = now;

    var rect = canvas.getBoundingClientRect();
    var cx = rect.width/2, cy = rect.height/2;
    var pxPerAU = Math.min(rect.width, rect.height)*0.26;

    if (running && !paused){
      var speed = parseFloat(speedEl.value);
      var omega = (2*Math.PI) / (baseSweepSeconds / speed);

      if (phase==="earth"){
        thetaE = wrap2pi(thetaE + omega*dt);
        tryMark("Earth");

        if (markedE["Perihelion"] && markedE["Quadrature"] && markedE["Aphelion"] && nearAngle(thetaE, 0, 0.02)){
          // finish Earth sweep
          thetaE = 0;
          phase = "mars";
          logLine("— Earth 360° complete. Starting Mars sweep. —");
          setTags();
        }
      } else if (phase==="mars"){
        thetaM = wrap2pi(thetaM + omega*dt);
        tryMark("Mars");

        if (markedM["Perihelion"] && markedM["Quadrature"] && markedM["Aphelion"] && nearAngle(thetaM, 0, 0.02)){
          thetaM = 0;
          phase = "done";
          var R = alignmentReport();
          logLine("— Mars 360° complete. —");
          if (R){
            logLine("BEST MATCH Δθ=" + R.matchDeg.toFixed(3) + "° | Earth:" + R.e.label + " vs Mars:" + R.m.label);
          }
          setTags();
        }
      }
    }

    // draw frame
    clear();

    // simple stars
    ctx.save();
    ctx.fillStyle="rgba(255,255,255,0.07)";
    for (var i=0;i<80;i++){
      var x = (i*173)%rect.width;
      var y = (i*97)%rect.height;
      ctx.fillRect(x,y,1,1);
    }
    ctx.restore();

    drawSun(cx,cy);
    drawOrbit(cx,cy,pxPerAU, Earth);
    drawOrbit(cx,cy,pxPerAU, Mars);
    drawMarks(marksEarth);
    drawMarks(marksMars);

    if (phase==="idle"){
      var P0 = drawPlanet(cx,cy,pxPerAU, Earth, 0);
      drawRadial(cx,cy,P0.x,P0.y);
    } else if (phase==="earth"){
      var PE = drawPlanet(cx,cy,pxPerAU, Earth, thetaE);
      drawRadial(cx,cy,PE.x,PE.y);
    } else if (phase==="mars"){
      drawPlanet(cx,cy,pxPerAU, Earth, 0);
      var PM = drawPlanet(cx,cy,pxPerAU, Mars, thetaM);
      drawRadial(cx,cy,PM.x,PM.y);
    } else {
      drawPlanet(cx,cy,pxPerAU, Earth, 0);
      drawPlanet(cx,cy,pxPerAU, Mars, 0);
      var R2 = alignmentReport();
      if (R2){
        var ang = R2.e.theta;
        var x2 = cx + Math.cos(ang) * (Mars.a_AU * pxPerAU * 1.02);
        var y2 = cy + Math.sin(ang) * (Mars.a_AU * pxPerAU * 1.02);
        drawRadial(cx,cy,x2,y2);
      }
    }

    setUI();
    requestAnimationFrame(tick);
  }

  // ---------- Buttons ----------
  startBtn.addEventListener("click", function(){
    if (!running){
      // hard start
      running = true; paused = false;
      phase = "earth";
      thetaE = 0; thetaM = 0;
      markedE = {}; markedM = {};
      marksEarth = []; marksMars = [];
      logEl.value = "";
      logLine("Starting Earth 360° sweep…");
    } else {
      paused = false;
      logLine("Resumed.");
    }
    setTags();
  });

  pauseBtn.addEventListener("click", function(){
    if (!running) return;
    paused = !paused;
    logLine(paused ? "Paused." : "Resumed.");
    setTags();
  });

  resetBtn.addEventListener("click", function(){
    reset();
  });

  printBtn.addEventListener("click", function(){
    // Print the page (no popup windows)
    window.print();
  });

  // ---------- Init ----------
  resize();
  reset();
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
