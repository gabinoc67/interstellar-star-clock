<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Theoretical Disease Evolution Lab — CST Resets, Weather, Immunity (Fictional)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { color-scheme: dark; }
  body {
    margin:0; padding:18px;
    background: radial-gradient(circle at top, #020617 0, #000 65%);
    color:#e5e7eb;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  h1 { margin-top:0; font-size:1.4rem; }
  .disclaimer {
    padding:10px;
    border-radius:10px;
    background:rgba(127,29,29,0.18);
    border:1px solid rgba(248,113,113,0.7);
    font-size:0.8rem;
    max-width:960px;
    margin-bottom:10px;
  }
  .layout{
    display:flex;
    flex-wrap:wrap;
    gap:22px;
  }
  #plot {
    border:1px solid #1f2937;
    border-radius:10px;
    background:radial-gradient(circle at center, #020617 0, #000 90%);
  }
  .side {
    display:flex;
    flex-direction:column;
    gap:12px;
    width:360px;
    max-width:420px;
  }
  .box{
    padding:12px;
    border-radius:12px;
    background:rgba(15,23,42,0.92);
    border:1px solid #1f2937;
  }
  h2 { margin:0 0 4px 0; font-size:1rem; }
  label{
    display:block;
    font-size:0.78rem;
    margin:4px 0;
  }
  select{
    width:100%;
    margin-top:4px;
    margin-bottom:4px;
    padding:4px;
    border-radius:6px;
    border:1px solid #1f2937;
    background:#020617;
    color:#e5e7eb;
    font-size:0.8rem;
  }
  input[type=range]{ width:100%; }
  button{
    padding:6px 10px; font-size:0.82rem;
    border-radius:6px; border:none; cursor:pointer;
    background:#1e3a8a; color:#e5e7eb;
    margin-right:4px;
    margin-top:4px;
  }
  button:hover{ background:#3749ad; }
  .tiny{ font-size:0.75rem; color:#9ca3af; }
  pre{ white-space:pre-wrap; font-size:0.72rem; max-height:180px; overflow:auto; }
  #cstLabel{
    font-size:0.8rem;
    color:#a5b4fc;
    margin-top:4px;
  }
  #treeCanvas{
    width:100%;
    border-radius:8px;
    border:1px solid #1f2937;
    background:radial-gradient(circle at top, #020617 0, #000 100%);
  }
</style>
</head>
<body>

<h1>Theoretical Disease Evolution Lab — CST Resets, Weather, Immunity (Fictional)</h1>

<div class="disclaimer">
  <strong>DISCLAIMER:</strong> This simulation is a <strong>theoretical, fictional, educational</strong> toy model.
  It does <strong>not</strong> represent any real disease, region, or medical data.
  It must <strong>not</strong> be used for real epidemiology, diagnosis, treatment, or policy decisions.
  It only visualizes how abstract “strains” might drift, branch, or go extinct under changing conditions
  like CST-time resets, environmental shifts, and population immunity, in a purely conceptual sense.
</div>

<p style="max-width:960px;font-size:0.9rem;">
Each dot is a <strong>fictional disease strain</strong>: drifting, adapting, branching or dying out
as environment and population parameters change.
We explore how <strong>CST-time resets, climate / weather, barometric stress, and immunity patterns</strong>
affect whether a strain tends to persist or go extinct.
</p>

<div class="layout">
  <!-- MAIN PHASE-SPACE PLOT: strains in abstract fitness space -->
  <canvas id="plot" width="680" height="600"></canvas>

  <!-- CONTROL / EXPLANATION SIDE PANEL -->
  <div class="side">

    <!-- DISEASE + REGION SELECTION -->
    <div class="box">
      <h2>Disease & Region (Fiction Only)</h2>
      <label>
        Select theoretical disease type
        <select id="diseaseSelect">
          <option value="resp_urban">Respiratory Virus — Dense Urban (theory)</option>
          <option value="water_tropical">Waterborne Infection — Tropical (theory)</option>
          <option value="vector_equatorial">Vector-Borne Disease — Equatorial (theory)</option>
          <option value="chronic_cold">Chronic Infection — Cold Climate (theory)</option>
        </select>
      </label>
      <label>
        Select conceptual area
        <select id="areaSelect">
          <option value="global">Global (conceptual)</option>
          <option value="countryA">Country A — Temperate (conceptual)</option>
          <option value="countryB">Country B — Tropical (conceptual)</option>
          <option value="stateX">State X — Coastal (conceptual)</option>
          <option value="stateY">State Y — Mountain (conceptual)</option>
        </select>
      </label>
      <p class="tiny">
        Disease and area choices <strong>do not use real data</strong>. They simply change sliders internally
        (mutation, climate, immunity) to illustrate how different settings might behave in the model.
      </p>
    </div>

    <!-- ENVIRONMENT / CST / WEATHER -->
    <div class="box">
      <h2>CST, Resets & Environment</h2>

      <label>
        CST-time drift rate
        <input id="cstDrift" type="range" min="0" max="2" step="0.05" value="0.3">
      </label>

      <label>
        Global reset / catastrophe frequency
        <input id="resetFreq" type="range" min="0" max="0.05" step="0.002" value="0.008">
      </label>

      <label>
        Reset severity (fraction of strains affected)
        <input id="resetSeverity" type="range" min="0" max="1" step="0.05" value="0.5">
      </label>

      <label>
        Temperature (0=cold, 1=hot)
        <input id="tempSlider" type="range" min="0" max="1" step="0.05" value="0.5">
      </label>

      <label>
        Barometric / climate stress
        <input id="climateStress" type="range" min="0" max="1" step="0.05" value="0.3">
      </label>

      <div id="cstLabel">CST-time τ = 0.00</div>

      <p class="tiny">
        CST-time models long-scale cosmic / historical drift.
        Resets represent hypothetical <strong>human or Earth resets</strong> that may suddenly reduce diversity.
        Temperature and climate stress represent coarse environment pressures (cold vs hot, stable vs harsh).
      </p>
    </div>

    <!-- POPULATION & IMMUNITY -->
    <div class="box">
      <h2>Population & Immunity (Conceptual)</h2>

      <label>
        Baseline population density
        <input id="popDensity" type="range" min="0" max="1" step="0.05" value="0.6">
      </label>

      <label>
        Fraction of population with immunity
        <input id="immuneFraction" type="range" min="0" max="1" step="0.05" value="0.4">
      </label>

      <label>
        Immunity heterogeneity (0=uniform, 1=patchy pockets)
        <input id="immuneVar" type="range" min="0" max="1" step="0.05" value="0.5">
      </label>

      <label>
        Intervention pressure (theoretical controls, treatment)
        <input id="intervention" type="range" min="0" max="1" step="0.05" value="0.3">
      </label>

      <p class="tiny">
        Some people can be more or less immune to a fictional strain.
        Higher immunity fraction reduces effective fitness of most strains.
        Heterogeneity lets a few strains exploit "pockets" of susceptible hosts.
      </p>
    </div>

    <!-- STRAIN DYNAMICS -->
    <div class="box">
      <h2>Strain Dynamics</h2>

      <label>
        Evolution band width (viable niche size)
        <input id="evoWidth" type="range" min="0.05" max="0.45" step="0.01" value="0.25">
      </label>

      <label>
        Extinction radius (how far from niche before dying out)
        <input id="extinctRadius" type="range" min="0.05" max="0.7" step="0.01" value="0.35">
      </label>

      <label>
        Mutation step size
        <input id="mutStep" type="range" min="0.05" max="1" step="0.05" value="0.45">
      </label>

      <label>
        Mutation rate (per step)
        <input id="mutationRate" type="range" min="0.0" max="0.03" step="0.001" value="0.008">
      </label>

      <label>
        Branching threshold (speciation strictness)
        <input id="branchThreshold" type="range" min="0.1" max="1" step="0.05" value="0.5">
      </label>

      <label>
        Mortality curve (age / fragility)
        <input id="mortalityCurve" type="range" min="0" max="1" step="0.05" value="0.4">
      </label>

      <button id="addStrain">Add Strain</button>
      <button id="driftToggle">Start Simulation</button>
      <button id="toggle3D">Toggle 3D Holographic</button>

      <p class="tiny">
        High mutation ≈ fast-evolving diseases; low mutation ≈ stable diseases.
        Branching creates new fictional variants. Mortality curve makes strains age out.
      </p>
    </div>

    <!-- PHYLOGENETIC TREE -->
    <div class="box">
      <h2>Phylogenetic Tree (Fictional Strains)</h2>
      <canvas id="treeCanvas" width="340" height="220"></canvas>
      <p class="tiny">
        Root strains on the left, descendants toward the right.
        Colors show survival vs extinction. This is a conceptual evolution tree, not real data.
      </p>
    </div>

    <!-- EXPORT -->
    <div class="box">
      <h2>Export History (CSV)</h2>
      <button id="exportCSV">Export CSV History</button>
      <p class="tiny">
        Exports simulation snapshots over time: step, CST-time, fictional disease type, area,
        strain name, position, fitness, and extinction status.
        Use it only for theoretical or educational plots, not real forecasting.
      </p>
      <pre id="csvOut"></pre>
    </div>

  </div>
</div>

<script>
/* ============================================================
   CORE GLOBALS & DATA STRUCTURES
   ============================================================ */

// Main 2D canvas where we draw strain positions
const canvas   = document.getElementById("plot");
const ctx      = canvas.getContext("2d");

// Phylogenetic tree canvas
const treeCanvas = document.getElementById("treeCanvas");
const treeCtx    = treeCanvas.getContext("2d");

// UI elements for disease & area selection
const diseaseSelect = document.getElementById("diseaseSelect");
const areaSelect    = document.getElementById("areaSelect");

// Sliders for CST & environment
const cstDriftIn    = document.getElementById("cstDrift");
const resetFreqIn   = document.getElementById("resetFreq");
const resetSeverityIn = document.getElementById("resetSeverity");
const tempSliderIn  = document.getElementById("tempSlider");
const climateStressIn = document.getElementById("climateStress");
const cstLabel      = document.getElementById("cstLabel");

// Population & immunity sliders
const popDensityIn  = document.getElementById("popDensity");
const immuneFractionIn = document.getElementById("immuneFraction");
const immuneVarIn   = document.getElementById("immuneVar");
const interventionIn= document.getElementById("intervention");

// Strain dynamic sliders
const evoWidthIn    = document.getElementById("evoWidth");
const extinctIn     = document.getElementById("extinctRadius");
const mutStepIn     = document.getElementById("mutStep");
const mutationRateIn= document.getElementById("mutationRate");
const branchThIn    = document.getElementById("branchThreshold");
const mortalityIn   = document.getElementById("mortalityCurve");

// Buttons & export
const addStrainBtn  = document.getElementById("addStrain");
const driftBtn      = document.getElementById("driftToggle");
const toggle3DBtn   = document.getElementById("toggle3D");
const exportBtn     = document.getElementById("exportCSV");
const csvOut        = document.getElementById("csvOut");

// Simulation state
let drifting = false;     // is the main loop running?
let threeD   = false;     // holographic 3D mode on/off
let strains  = [];        // list of strain agents
let nextId   = 1;         // numeric ID for strains
let nextName = 1;         // Species-001, Species-002 style naming
let simStep  = 0;         // simulation step counter
let cstTime  = 0;         // CST-time τ (global drift variable)

// History log for CSV export
const history = [];

/* ============================================================
   STRAIN DATA MODEL
   Each strain is an object:
   {
     id,          // numeric unique ID
     name,        // "Strain-001"
     parentId,    // null or parent strain's id
     x, y,        // position in abstract parameter space
     extinct,     // boolean
     age,         // integer age in steps
     birthStep,   // step at which created
     tempPref,    // [0,1] temperature preference
     immuneEscape // [0,1] how well it avoids immunity
   }
   ============================================================ */

/* ============================================================
   COORDINATE CONVERSION
   ============================================================ */

/**
 * Convert normalized (0..1,0..1) coordinates into canvas pixels with padding.
 * x,y ~ infection / survival parameters in this toy model.
 */
function toCanvas(x, y){
  const pad = 60;
  const w = canvas.width  - pad*2;
  const h = canvas.height - pad*2;
  const cx = pad + x * w;
  const cy = canvas.height - pad - y * h; // invert y for canvas
  return { cx, cy };
}

/* ============================================================
   BACKGROUND DRAW: GRID & AXES
   ============================================================ */
function drawAxes(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Soft grid to help see motion over time
  ctx.strokeStyle = "rgba(148,163,184,0.12)";
  for(let i=0;i<=10;i++){
    const x = (canvas.width/10)*i;
    const y = (canvas.height/10)*i;

    ctx.beginPath();
    ctx.moveTo(x,0); ctx.lineTo(x,canvas.height);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0,y); ctx.lineTo(canvas.width,y);
    ctx.stroke();
  }

  // Axes
  ctx.strokeStyle = "#9ca3af";
  // X axis
  ctx.beginPath();
  ctx.moveTo(60, canvas.height - 60);
  ctx.lineTo(canvas.width - 15, canvas.height - 60);
  ctx.stroke();
  // Y axis
  ctx.beginPath();
  ctx.moveTo(60, canvas.height - 60);
  ctx.lineTo(60, 15);
  ctx.stroke();

  // Axis labels (conceptual)
  ctx.fillStyle = "#9ca3af";
  ctx.font = "11px system-ui";
  ctx.fillText("Strain parameter X →", canvas.width - 200, canvas.height - 42);
  ctx.save();
  ctx.translate(30, 100);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Strain parameter Y / fitness ↑", 0, 0);
  ctx.restore();

  // Holographic label if 3D mode is on
  if(threeD){
    ctx.fillStyle = "#a5b4fc";
    ctx.font = "11px system-ui";
    ctx.fillText("3D holographic mode: Z axis = fitness (size/brightness/height)", 70, 30);
  }
}

/* ============================================================
   BAND DRAWING — VIABLE NICHE REGION
   ============================================================ */

/**
 * Draw a simple "comfort band" in parameter space where strains
 * are more viable. Outside the band they tend to go extinct.
 */
function drawBand(width){
  const N = 150;
  ctx.beginPath();

  // upper boundary y = x + width
  for(let i=0;i<=N;i++){
    const x = i / N;
    let yT = x + width;
    if(yT>1) yT = 1;
    const {cx, cy} = toCanvas(x, yT);
    if(i===0) ctx.moveTo(cx,cy); else ctx.lineTo(cx,cy);
  }
  // lower boundary y = x - width
  for(let i=N;i>=0;i--){
    const x = i / N;
    let yB = x - width;
    if(yB<0) yB = 0;
    const {cx, cy} = toCanvas(x, yB);
    ctx.lineTo(cx,cy);
  }
  ctx.closePath();
  ctx.fillStyle = "rgba(14,165,233,0.12)";
  ctx.fill();
  ctx.strokeStyle = "rgba(14,165,233,0.6)";
  ctx.stroke();
}

/* ============================================================
   FITNESS COMPUTATION
   Conceptual fitness = how likely a strain is to persist
   under:
     - distance to viable band
     - CST / environment (temperature, climate stress)
     - immunity (immuneFraction, immuneVar, immuneEscape)
     - population density & interventions
   ============================================================ */
function computeFitness(strain){
  const evoWidth      = parseFloat(evoWidthIn.value);
  const extinctRadius = parseFloat(extinctIn.value);
  const tempEnv       = parseFloat(tempSliderIn.value);
  const climateStress = parseFloat(climateStressIn.value);
  const popDensity    = parseFloat(popDensityIn.value);
  const immuneFrac    = parseFloat(immuneFractionIn.value);
  const immuneVar     = parseFloat(immuneVarIn.value);
  const intervention  = parseFloat(interventionIn.value);

  // Distance to diagonal niche y = x (very simple toy niche)
  const dist = Math.abs(strain.y - strain.x);

  // Base niche fitness (closer to diagonal is better)
  let baseFit = Math.max(0, 1 - (dist / evoWidth));

  // Temperature match: if strain’s preference matches environment, it gets a boost
  const tempMismatch = Math.abs(strain.tempPref - tempEnv);
  const tempFit = Math.max(0, 1 - tempMismatch);

  // Immunity: if immuneFraction is high, most strains lose fitness,
  // but strains with high immuneEscape suffer less penalty.
  const immunePressure = immuneFrac * (1 - strain.immuneEscape);
  // Heterogeneity (immuneVar) shrinks or expands that penalty
  const heteroFactor = 1 - immuneVar * 0.5;
  const immuneFitFactor = Math.max(0, 1 - immunePressure * heteroFactor);

  // Population density: more dense populations support spread, up to a point.
  // Simple saturating function: 0..1 → 0..1
  const popFit = 0.5 + 0.5 * popDensity;

  // Intervention pressure: stronger interventions reduce fitness
  const interventionPenalty = intervention * (0.2 + 0.8 * popDensity);
  const interventionFitFactor = Math.max(0, 1 - interventionPenalty);

  // Climate stress globally reduces survival
  const climateFitFactor = Math.max(0, 1 - climateStress * 0.7);

  // Combine all fitness contributions
  let fitness =
    baseFit *
    tempFit *
    immuneFitFactor *
    popFit *
    interventionFitFactor *
    climateFitFactor;

  // Clamp to [0,1]
  fitness = Math.max(0, Math.min(1, fitness));

  // If very far from niche, flag as extinct
  if(dist > extinctRadius){
    strain.extinct = true;
  }

  return fitness;
}

/* ============================================================
   DRAW STRAINS ON MAIN PLOT
   ============================================================ */
function drawStrains(){
  for(const s of strains){
    const f = computeFitness(s);
    const {cx, cy} = toCanvas(s.x, s.y);

    // Fitness encoded as hue & brightness
    const hue = 120 * f; // 0=red (low), 120=green (high)
    const baseLight = 40 + f*35;

    // Holographic: fitness as point size & vertical offset
    let radius = 7;
    let yOffset = 0;
    if(threeD){
      radius  = 5 + 8*f;
      yOffset = -12 * (f - 0.5);
    }

    ctx.beginPath();
    ctx.arc(cx, cy + yOffset, radius, 0, Math.PI*2);
    ctx.fillStyle = `hsl(${hue}, 75%, ${baseLight}%)`;
    ctx.fill();

    // Label
    ctx.fillStyle = "#e5e7eb";
    ctx.font = "10px system-ui";
    ctx.fillText(s.name, cx+10, cy-10 + yOffset);

    // Extinction mark
    if(s.extinct){
      ctx.save();
      ctx.fillStyle = "#ef4444";
      ctx.font = "10px system-ui";
      ctx.fillText("EXTINCT", cx+10, cy + yOffset);
      ctx.restore();
    }
  }
}

/* ============================================================
   PHYLOGENETIC TREE DRAWING (FICTIONAL)
   ============================================================ */
function drawTree(){
  treeCtx.clearRect(0,0,treeCanvas.width,treeCanvas.height);
  if(strains.length === 0) return;

  // Sort by birth step so older strains are near the top
  const sorted = [...strains].sort((a,b)=>a.birthStep - b.birthStep);

  // Compute generation depth from parentId
  const depthMap = new Map();
  function getDepth(strain){
    if(depthMap.has(strain.id)) return depthMap.get(strain.id);
    if(strain.parentId === null){
      depthMap.set(strain.id, 0);
      return 0;
    }
    const parent = strains.find(s => s.id === strain.parentId);
    if(!parent){
      depthMap.set(strain.id, 0);
      return 0;
    }
    const d = getDepth(parent) + 1;
    depthMap.set(strain.id, d);
    return d;
  }
  sorted.forEach(s => getDepth(s));
  const maxDepth = Math.max(...sorted.map(s => depthMap.get(s.id)));

  // Layout positions
  const padX = 25, padY = 20;
  const innerW = treeCanvas.width  - padX*2;
  const innerH = treeCanvas.height - padY*2;
  const stepY  = sorted.length>1 ? innerH/(sorted.length-1) : 0;
  const stepX  = maxDepth>0 ? innerW/maxDepth : 0;

  const nodePos = new Map();
  sorted.forEach((s, i)=>{
    const d = depthMap.get(s.id);
    const x = padX + d * stepX;
    const y = padY + i * stepY;
    nodePos.set(s.id, {x,y});
  });

  // Draw parent-child connections
  treeCtx.strokeStyle = "rgba(148,163,184,0.7)";
  treeCtx.lineWidth = 1;
  for(const s of sorted){
    if(s.parentId !== null && nodePos.has(s.parentId)){
      const p = nodePos.get(s.parentId);
      const c = nodePos.get(s.id);
      treeCtx.beginPath();
      treeCtx.moveTo(p.x+4, p.y);
      treeCtx.lineTo(c.x-4, c.y);
      treeCtx.stroke();
    }
  }

  // Draw nodes
  for(const s of sorted){
    const pos = nodePos.get(s.id);
    const f   = computeFitness(s);
    const radius = 3 + 3*f;

    treeCtx.beginPath();
    treeCtx.arc(pos.x, pos.y, radius, 0, Math.PI*2);
    treeCtx.fillStyle = s.extinct ? "#f97373" : "#22c55e";
    treeCtx.fill();

    treeCtx.fillStyle = "#e5e7eb";
    treeCtx.font = "8px system-ui";
    treeCtx.fillText(s.name, pos.x+5, pos.y+3);
  }
}

/* ============================================================
   MAIN SIMULATION LOOP
   Handles:
   - CST-time drift
   - random mutation
   - branching
   - mortality
   - global resets (CST catastrophes)
   ============================================================ */
function driftLoop(){
  if(!drifting) return;

  simStep++;

  // Read environment sliders
  const cstDrift      = parseFloat(cstDriftIn.value);
  const resetFreq     = parseFloat(resetFreqIn.value);
  const resetSeverity = parseFloat(resetSeverityIn.value);
  const mutStep       = parseFloat(mutStepIn.value);
  const mutRate       = parseFloat(mutationRateIn.value);
  const branchTh      = parseFloat(branchThIn.value);
  const mortality     = parseFloat(mortalityIn.value);
  const evoWidth      = parseFloat(evoWidthIn.value);
  const extinctRadius = parseFloat(extinctIn.value);

  // Advance CST-time τ (global drift)
  cstTime += cstDrift * 0.01;
  cstLabel.textContent = `CST-time τ = ${cstTime.toFixed(2)}`;

  const newStrains = [];

  for(const s of strains){
    if(s.extinct){
      s.age += 1;
      continue;
    }

    // Age increases each step
    s.age += 1;

    // Mutation: random drift in parameter space
    if(Math.random() < mutRate){
      s.x += (Math.random()-0.5) * 0.01 * mutStep;
      s.y += (Math.random()-0.5) * 0.01 * mutStep;
    }

    // Gentle pull toward the diagonal niche y = x
    const dist = Math.abs(s.y - s.x);
    if(dist < evoWidth){
      s.y += (s.x - s.y) * 0.05;
    }

    // Branching (fictional variant creation)
    // If within a narrow niche window and random chance
    const branchingWindow = evoWidth * branchTh;
    if(dist < branchingWindow && Math.random() < 0.003){
      const child = {
        id: nextId++,
        name: "Strain-" + String(nextName++).padStart(3,'0'),
        parentId: s.id,
        x: s.x + (Math.random()-0.5)*0.04,
        y: s.y + (Math.random()-0.5)*0.04,
        extinct: false,
        age: 0,
        birthStep: simStep,
        // Child inherits similar temp preference and immune escape,
        // with small random perturbation
        tempPref: Math.min(1, Math.max(0, s.tempPref + (Math.random()-0.5)*0.1)),
        immuneEscape: Math.min(1, Math.max(0, s.immuneEscape + (Math.random()-0.5)*0.1))
      };
      newStrains.push(child);
    }

    // Environment-based extinction from niche radius
    if(dist > extinctRadius){
      s.extinct = true;
    }

    // Age-based + random mortality curve
    const ageFactor = s.age / 2000;
    let deathProb = 0.0005 + mortality * 0.003 + mortality * ageFactor;
    if(Math.random() < deathProb){
      s.extinct = true;
    }

    // Keep inside bounds
    s.x = Math.max(0, Math.min(1, s.x));
    s.y = Math.max(0, Math.min(1, s.y));
  }

  // Add newly branched strains
  for(const child of newStrains){
    strains.push(child);
  }

  // Global CST / Earth reset:
  // With frequency resetFreq, randomly extinct a fraction of strains.
  if(Math.random() < resetFreq && strains.length>0){
    for(const s of strains){
      if(!s.extinct && Math.random() < resetSeverity){
        s.extinct = true;
      }
    }
  }

  // Log history every few steps
  const logEvery = 15;
  if(simStep % logEvery === 0){
    const diseaseType = diseaseSelect.value;
    const areaType    = areaSelect.value;
    for(const s of strains){
      const f = computeFitness(s);
      history.push({
        step: simStep,
        cst: cstTime,
        diseaseType,
        areaType,
        name: s.name,
        x: s.x,
        y: s.y,
        fitness: f,
        extinct: s.extinct
      });
    }
  }

  // Redraw main plot & tree
  redraw();

  // Schedule next frame
  requestAnimationFrame(driftLoop);
}

/* ============================================================
   REDRAW WRAPPER
   ============================================================ */
function redraw(){
  drawAxes();
  drawBand(parseFloat(evoWidthIn.value));
  drawStrains();
  drawTree();
}

/* ============================================================
   UI: ADD STRAIN
   ============================================================ */
addStrainBtn.onclick = ()=>{
  // When adding a new strain, we initialize it with:
  // - random position in parameter space
  // - random temperature preference
  // - random immune escape
  const s = {
    id: nextId++,
    name: "Strain-" + String(nextName++).padStart(3,'0'),
    parentId: null,
    x: Math.random()*0.9 + 0.05,
    y: Math.random()*0.9 + 0.05,
    extinct: false,
    age: 0,
    birthStep: simStep,
    tempPref: Math.random(),          // 0=cold loving, 1=heat loving
    immuneEscape: Math.random()       // 0=very visible, 1=very evasive
  };
  strains.push(s);
  redraw();
};

/* ============================================================
   UI: START/STOP SIMULATION
   ============================================================ */
driftBtn.onclick = ()=>{
  drifting = !drifting;
  driftBtn.textContent = drifting ? "Stop Simulation" : "Start Simulation";
  if(drifting) driftLoop();
};

/* ============================================================
   UI: 3D HOLOGRAPHIC TOGGLE
   ============================================================ */
toggle3DBtn.onclick = ()=>{
  threeD = !threeD;
  if(threeD){
    alert("3D holographic mode: fitness (Z) is encoded by size, brightness, and slight vertical offset.\nThis is visual only — still a 2D canvas.");
  }
  redraw();
};

/* ============================================================
   UI: EXPORT CSV HISTORY
   ============================================================ */
exportBtn.onclick = ()=>{
  let rows = ["Step,CST_Time,DiseaseType,AreaType,StrainName,X,Y,Fitness,Extinct"];
  for(const h of history){
    rows.push(
      `${h.step},${h.cst.toFixed(3)},${h.diseaseType},${h.areaType},${h.name},${h.x.toFixed(3)},${h.y.toFixed(3)},${h.fitness.toFixed(3)},${h.extinct}`
    );
  }
  csvOut.textContent = rows.join("\n");
};

/* ============================================================
   UI: DISEASE & AREA PRESETS
   We adjust some sliders automatically when the user chooses a
   theoretical disease type or region, to illustrate different
   behaviors (fast vs slow mutation, hot vs cold, etc.).
   ============================================================ */
function applyDiseasePreset(){
  const val = diseaseSelect.value;
  // Note: numbers are purely illustrative, no real data.
  if(val === "resp_urban"){
    mutationRateIn.value = 0.015;
    mutStepIn.value      = 0.6;
    evoWidthIn.value     = 0.22;
    tempSliderIn.value   = 0.5;
  }else if(val === "water_tropical"){
    mutationRateIn.value = 0.008;
    mutStepIn.value      = 0.4;
    evoWidthIn.value     = 0.28;
    tempSliderIn.value   = 0.8;
  }else if(val === "vector_equatorial"){
    mutationRateIn.value = 0.02;
    mutStepIn.value      = 0.7;
    evoWidthIn.value     = 0.25;
    tempSliderIn.value   = 0.9;
  }else if(val === "chronic_cold"){
    mutationRateIn.value = 0.004;
    mutStepIn.value      = 0.25;
    evoWidthIn.value     = 0.18;
    tempSliderIn.value   = 0.2;
  }
  redraw();
}

function applyAreaPreset(){
  const val = areaSelect.value;
  // Adjust climate stress & immunity sliders conceptually
  if(val === "global"){
    climateStressIn.value = 0.3;
    immuneFractionIn.value = 0.4;
  }else if(val === "countryA"){ // temperate
    climateStressIn.value = 0.2;
    immuneFractionIn.value = 0.5;
  }else if(val === "countryB"){ // tropical
    climateStressIn.value = 0.4;
    immuneFractionIn.value = 0.3;
  }else if(val === "stateX"){ // coastal
    climateStressIn.value = 0.35;
    immuneFractionIn.value = 0.45;
  }else if(val === "stateY"){ // mountain
    climateStressIn.value = 0.5;
    immuneFractionIn.value = 0.35;
  }
  redraw();
}

diseaseSelect.onchange = applyDiseasePreset;
areaSelect.onchange    = applyAreaPreset;

/* ============================================================
   SLIDERS: REDRAW WHEN USER MOVES THEM
   ============================================================ */
[
  cstDriftIn, resetFreqIn, resetSeverityIn,
  tempSliderIn, climateStressIn,
  popDensityIn, immuneFractionIn, immuneVarIn, interventionIn,
  evoWidthIn, extinctIn, mutStepIn, mutationRateIn,
  branchThIn, mortalityIn
].forEach(el => { el.oninput = redraw; });

/* ============================================================
   INITIAL STATE
   ============================================================ */
applyDiseasePreset();
applyAreaPreset();
redraw();
</script>
</body>
</html>
