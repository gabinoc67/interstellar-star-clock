<!-- ======================= PART 1 / 5 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earth → Mars Geodesic Corridor Demo (Panels + Orbit Circle + 4D Line)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#020617;
    --panel:rgba(15,23,42,.92);
    --panel2:rgba(2,6,23,.65);
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#fb7185;
    --line:rgba(148,163,184,.26);
    --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: radial-gradient(1200px 700px at 30% -10%, rgba(56,189,248,.22), transparent 55%),
                radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.14), transparent 60%),
                var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  header{
    padding:18px 18px 14px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(2,6,23,.25));
    position: sticky; top: 0; z-index: 20;
    backdrop-filter: blur(10px);
  }
  .title{
    display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;
  }
  .title h1{
    margin:0; font-size:20px; letter-spacing:.3px;
  }
  .title .tag{
    font-size:12px; color:#bfe8ff;
    border:1px solid rgba(56,189,248,.35);
    padding:4px 8px; border-radius:999px;
    background:rgba(56,189,248,.12);
  }
  .subtitle{
    margin-top:6px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
    max-width:1100px;
  }

  .wrap{
    max-width:1280px;
    margin:0 auto;
    padding:16px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--panel);
    border:1px solid rgba(56,189,248,.18);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card h2{
    margin:0;
    padding:12px 14px;
    font-size:13px;
    letter-spacing:.25px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between;
    background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(2,6,23,.35));
  }
  .card h2 small{ color:var(--muted); font-weight:500; }
  .card .content{ padding:12px 14px; }

  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .pill{
    border:1px solid var(--line);
    background: rgba(2,6,23,.45);
    border-radius: 999px;
    padding:6px 10px;
    font-size:12px;
    color:var(--ink);
  }
  .pill b{ font-family:var(--mono); font-weight:700; }
  .pill .m{ color:var(--muted); margin-left:6px; font-family:var(--mono); }

  .controls{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 620px){
    .controls{ grid-template-columns: 1fr; }
  }
  label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
  input[type="range"], input[type="number"], select{
    width:100%;
    padding:10px 10px;
    border-radius: 12px;
    border:1px solid rgba(148,163,184,.25);
    background: rgba(2,6,23,.55);
    color: var(--ink);
    outline:none;
  }
  .btnbar{
    display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
  }
  button{
    padding:10px 12px;
    border-radius: 12px;
    border:1px solid rgba(148,163,184,.25);
    background: rgba(2,6,23,.55);
    color: var(--ink);
    cursor:pointer;
    font-weight:650;
  }
  button:hover{ border-color: rgba(56,189,248,.45); }
  .primary{
    background: rgba(56,189,248,.18);
    border-color: rgba(56,189,248,.35);
  }
  .danger{
    background: rgba(251,113,133,.14);
    border-color: rgba(251,113,133,.30);
  }
  .miniBtn{
    padding:8px 10px;
    border-radius: 999px;
    font-size:12px;
    border:1px solid rgba(148,163,184,.25);
    background: rgba(2,6,23,.55);
  }

  .kv{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 620px){
    .kv{ grid-template-columns: 1fr; }
  }
  .kbox{
    border:1px solid var(--line);
    background: rgba(2,6,23,.45);
    border-radius: 14px;
    padding:10px 12px;
  }
  .kbox .k{ color:var(--muted); font-size:11px; }
  .kbox .v{ font-family:var(--mono); font-size:13px; margin-top:6px; }
  .meter{
    height:10px;
    border-radius:999px;
    background: rgba(148,163,184,.22);
    overflow:hidden;
    border:1px solid rgba(148,163,184,.18);
    margin-top:10px;
  }
  .meter > i{
    display:block; height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(56,189,248,.95));
  }

  .canvasWrap{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width: 980px){
    .canvasWrap{ grid-template-columns: 1fr; }
  }
  canvas{
    width:100%;
    height:360px;
    background: radial-gradient(900px 500px at 30% 10%, rgba(56,189,248,.10), transparent 60%),
                rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.22);
    border-radius: 14px;
  }
  .note{
    font-size:12px; color:var(--muted);
    line-height:1.45;
  }
  .eq{
    font-family:var(--mono);
    padding:8px 10px;
    border-radius: 12px;
    background: rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.22);
    margin-top:10px;
    font-size:12px;
  }
  .foot{
    margin-top:12px;
    font-size:11px;
    color:var(--muted);
  }
</style>
</head>
<body>
<header>
  <div class="title">
    <h1>Earth → Mars “Geodesic Corridor” Demonstrator</h1>
    <span class="tag">Toy sim · real physics equations for aero loads + heating proxy</span>
    <span class="tag">Panels · orbit circle · 4D line · CSV + Print</span>
  </div>
  <div class="subtitle">
    Goal: explain the professor discussion (“gravity is geometry / parallel transport”) using practical aerospace constraints.
    We don’t claim “no drag in air.” Instead we show the corridor where density ρ becomes tiny, so aerodynamic forces drop and motion becomes “geodesic-like.”
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <section class="card">
      <h2>Mission Controls <small>start / pause / reset · export</small></h2>
      <div class="content">

        <div class="controls">
          <div>
            <label>Launch latitude (deg) — affects Earth surface co-rotation speed</label>
            <input id="lat" type="range" min="-90" max="90" step="0.1" value="25.7" />
            <div class="row" style="margin-top:8px">
              <span class="pill">lat: <b id="latOut">25.7</b><span class="m">deg</span></span>
              <span class="pill">Earth surface co-rotation: <b id="vRotOut">—</b><span class="m">m/s</span></span>
            </div>
          </div>

          <div>
            <label>Ascent “squeeze” mode (toy) — target Mach at thin air</label>
            <select id="mode">
              <option value="scram">SCRAM squeeze (build Mach in thin air)</option>
              <option value="rocket">ROCKET push (classic ascent)</option>
              <option value="hybrid" selected>HYBRID (squeeze → rocket → coast)</option>
            </select>
            <div class="row" style="margin-top:8px">
              <span class="pill">mode: <b id="modeOut">HYBRID</b></span>
              <span class="pill">phase: <b id="phaseOut">IDLE</b></span>
            </div>
          </div>

          <div>
            <label>Target “edge-of-space” altitude (km) — where ρ becomes tiny (corridor)</label>
            <input id="edgeKm" type="range" min="30" max="120" step="1" value="80" />
            <div class="row" style="margin-top:8px">
              <span class="pill">edge: <b id="edgeOut">80</b><span class="m">km</span></span>
              <span class="pill">ρ model: <b>exp(-h/H)</b><span class="m">(toy)</span></span>
            </div>
          </div>

          <div>
            <label>Time scale (sim speed)</label>
            <input id="timeScale" type="range" min="0.25" max="20" step="0.25" value="6" />
            <div class="row" style="margin-top:8px">
              <span class="pill">× <b id="tsOut">6.00</b></span>
              <span class="pill">step: <b id="dtOut">—</b><span class="m">s</span></span>
            </div>
          </div>
        </div>

        <!-- NEW: QUICK ORBIT PRESETS -->
        <div style="margin-top:10px">
          <label>Earth↔Mars geometry presets (toy) — quick setups</label>
          <div class="row">
            <button class="miniBtn" id="presetOpp">Opposition (≈180°)</button>
            <button class="miniBtn" id="presetAvg">Average (≈90°)</button>
            <button class="miniBtn" id="presetConj">Conjunction (≈0°)</button>
            <span class="pill">Preset: <b id="presetOut">Average</b></span>
          </div>
        </div>

        <div class="btnbar">
          <button class="primary" id="startBtn">Start</button>
          <button id="pauseBtn">Pause</button>
          <button class="danger" id="resetBtn">Reset</button>
          <button id="csvBtn">Export CSV</button>
          <button id="printBtn">Print Report</button>
        </div>

        <div class="foot">
          Notes: “Mach” is speed relative to the atmosphere. Geodesic-like behavior begins only when air density ρ is tiny and aerodynamic forces drop.
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Live Clocks + Reference Speeds <small>real numbers, toy propagation</small></h2>
      <div class="content">
        <div class="row">
          <span class="pill">UTC: <b id="utcOut">--:--:--</b></span>
          <span class="pill">CST (Monterrey): <b id="cstOut">--:--:--</b></span>
          <span class="pill">SIM T+: <b id="tOut">0.0</b><span class="m">s</span></span>
        </div>

        <div class="kv" style="margin-top:12px">
          <div class="kbox">
            <div class="k">Earth mean orbital speed about Sun (ref)</div>
            <div class="v"><span id="vEarthOrb">29.78</span> km/s</div>
          </div>
          <div class="kbox">
            <div class="k">Mars mean orbital speed about Sun (ref)</div>
            <div class="v"><span id="vMarsOrb">24.07</span> km/s</div>
          </div>
          <div class="kbox">
            <div class="k">Earth equator rotational speed (ref)</div>
            <div class="v"><span id="vEq">465</span> m/s</div>
          </div>
          <div class="kbox">
            <div class="k">Speed “stack” reminder</div>
            <div class="v">You feel acceleration, not shared velocity</div>
          </div>
        </div>

        <div class="eq">
          Real physics corridor (entry/exit loads): q = ½ ρ v²  ·  heating proxy ∝ ρ v³
        </div>
        <div class="eq">
          Geodesic / “parallel” idea: force felt ↔ Duᵘ/Dτ ≠ 0  ·  “parallel transport” ↔ stay near a geodesic family
        </div>
      </div>
    </section>

  </div>
</div>
<!-- ======================= PART 2 / 5 ======================= -->
<div class="wrap">
  <div class="canvasWrap">

    <section class="card">
      <h2>Orbit Circle (Sun-centered) <small>Earth & Mars circular orbits (toy)</small></h2>
      <div class="content">
        <canvas id="orbitCanvas" width="900" height="360"></canvas>
        <div class="row" style="margin-top:10px">
          <span class="pill">Earth θ: <b id="thE">0.0</b><span class="m">deg</span></span>
          <span class="pill">Mars θ: <b id="thM">0.0</b><span class="m">deg</span></span>
          <span class="pill">Phase (E→M): <b id="phOut">0.0</b><span class="m">deg</span></span>
          <span class="pill">Distance: <b id="distOut">—</b><span class="m">Mkm</span></span>
        </div>

        <div class="note" style="margin-top:10px">
          We intentionally keep orbit geometry simple (circular, coplanar). The purpose is not astronomical precision —
          it’s a teaching instrument for “frame alignment” and the corridor where the atmosphere becomes negligible.
        </div>
      </div>
    </section>

    <section class="card">
      <h2>4D Line View (x, y, w) <small>w = time-like phase channel (toy)</small></h2>
      <div class="content">
        <canvas id="line4dCanvas" width="900" height="360"></canvas>

        <div class="kv" style="margin-top:12px">
          <div class="kbox">
            <div class="k">4D separation proxy (x,y,w)</div>
            <div class="v" id="sep4dOut">—</div>
          </div>
          <div class="kbox">
            <div class="k">“Parallel / geodesic match” score (toy)</div>
            <div class="v" id="geoScoreOut">—</div>
            <div class="meter"><i id="geoBar"></i></div>
          </div>
        </div>

        <div class="note" style="margin-top:10px">
          Interpretation: as atmospheric density → tiny, aero forces drop, and the craft’s motion becomes “geodesic-like.”
          We visualize that with a score. This is not claiming warp — it’s demonstrating the professor’s geometric language.
        </div>
      </div>
    </section>

  </div>

  <div class="grid" style="margin-top:14px">

    <section class="card">
      <h2>Atmosphere Corridor Panel <small>loads + heating proxies</small></h2>
      <div class="content">

        <div class="controls">
          <div>
            <label>Vehicle speed relative to air (km/s) — toy schedule</label>
            <input id="vAir" type="range" min="0.2" max="4.0" step="0.01" value="2.8" />
            <div class="row" style="margin-top:8px">
              <span class="pill">v_air: <b id="vAirOut">2.80</b><span class="m">km/s</span></span>
              <span class="pill">Mach proxy: <b id="machOut">—</b></span>
            </div>
          </div>

          <div>
            <label>Altitude (km) — sets density ρ(h) (toy, exponential)</label>
            <input id="altKm" type="range" min="0" max="120" step="0.5" value="0" />
            <div class="row" style="margin-top:8px">
              <span class="pill">h: <b id="altOut">0.0</b><span class="m">km</span></span>
              <span class="pill">ρ(h): <b id="rhoOut">—</b><span class="m">kg/m³</span></span>
            </div>
          </div>
        </div>

        <div class="kv" style="margin-top:12px">
          <div class="kbox">
            <div class="k">Dynamic pressure q = ½ ρ v²</div>
            <div class="v" id="qOut">—</div>
          </div>
          <div class="kbox">
            <div class="k">Heating proxy ∝ ρ v³ (normalized)</div>
            <div class="v" id="heatOut">—</div>
          </div>
          <div class="kbox">
            <div class="k">Corridor status (goal: low ρ, bounded q & heating)</div>
            <div class="v" id="corridorOut">—</div>
          </div>
          <div class="kbox">
            <div class="k">Aero force vs gravity (concept)</div>
            <div class="v">Aero ≪ gravity/inertial when ρ is tiny</div>
          </div>
        </div>

        <div class="note" style="margin-top:10px">
          Density uses a toy exponential model ρ(h)=ρ₀·exp(-h/H) to show trends: higher altitude ⇒ lower ρ ⇒ lower q & heating proxies.
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Mission Readouts <small>departure → transfer → arrival</small></h2>
      <div class="content">

        <div class="kv">
          <div class="kbox">
            <div class="k">Stage</div>
            <div class="v" id="stageOut">IDLE</div>
          </div>
          <div class="kbox">
            <div class="k">Progress</div>
            <div class="v"><span id="progOut">0.0</span>%</div>
            <div class="meter"><i id="progBar"></i></div>
          </div>
          <div class="kbox">
            <div class="k">Transfer time (toy)</div>
            <div class="v" id="ttOut">—</div>
          </div>
          <div class="kbox">
            <div class="k">Arrival (CST)</div>
            <div class="v" id="arrOut">—</div>
          </div>
        </div>

        <div class="eq">
          Orbit speed relation (real): v(r)=√(GM/r). Different r ⇒ different stable orbital speeds (geodesics).
        </div>

        <div class="note" style="margin-top:10px">
          This demo emphasizes the “parallel” story: a craft transitions from atmosphere-dominated motion (non-geodesic)
          into near-vacuum where forces become small and the trajectory becomes geodesic-like. Then it coasts toward Mars.
        </div>

      </div>
    </section>

  </div>
</div>
<!-- ======================= PART 3 / 5 ======================= -->
<script>
const REF = {
  AU_km: 149_597_870.7,
  earthOrb_kms: 29.78,
  marsOrb_kms: 24.07,
  earthEqRot_ms: 465.0,
  rho0: 1.225,
  H_km: 8.5,
  a_sound_ms: 295,
  rE_AU: 1.0,
  rM_AU: 1.524,
  wScale: 0.12
};

const $ = (id)=>document.getElementById(id);

// UI elements
const lat = $("lat"), latOut = $("latOut"), vRotOut = $("vRotOut");
const mode = $("mode"), modeOut = $("modeOut"), phaseOut = $("phaseOut");
const edgeKm = $("edgeKm"), edgeOut = $("edgeOut");
const timeScale = $("timeScale"), tsOut = $("tsOut"), dtOut = $("dtOut");

const presetOpp = $("presetOpp");
const presetAvg = $("presetAvg");
const presetConj = $("presetConj");
const presetOut = $("presetOut");

const utcOut = $("utcOut"), cstOut = $("cstOut"), tOut = $("tOut");
const thE = $("thE"), thM = $("thM"), phOut = $("phOut"), distOut = $("distOut");

const sep4dOut = $("sep4dOut"), geoScoreOut = $("geoScoreOut"), geoBar = $("geoBar");

const vAir = $("vAir"), vAirOut = $("vAirOut"), machOut = $("machOut");
const altKm = $("altKm"), altOut = $("altOut"), rhoOut = $("rhoOut");
const qOut = $("qOut"), heatOut = $("heatOut"), corridorOut = $("corridorOut");

const stageOut = $("stageOut"), progOut = $("progOut"), progBar = $("progBar");
const ttOut = $("ttOut"), arrOut = $("arrOut");

const startBtn = $("startBtn"), pauseBtn = $("pauseBtn"), resetBtn = $("resetBtn");
const csvBtn = $("csvBtn"), printBtn = $("printBtn");

const orbitCanvas = $("orbitCanvas");
const line4dCanvas = $("line4dCanvas");
const octx = orbitCanvas.getContext("2d");
const lctx = line4dCanvas.getContext("2d");

// Mission state
let running=false;
let simT=0;
let simDT=0.1;

let mission = {
  stage: "IDLE",
  progress: 0,
  tTransfer: 0,
  departEpoch: null,
  arrivalEpoch: null,
  log: []
};

// Orbit phases (toy circular)
let thetaE = 0;  // rad
let thetaM = 0;  // rad

function omega_from_v(v_kms, r_AU){
  const r_km = r_AU * REF.AU_km;
  return (v_kms / r_km); // rad/s
}
const omegaE = omega_from_v(REF.earthOrb_kms, REF.rE_AU);
const omegaM = omega_from_v(REF.marsOrb_kms, REF.rM_AU);

// Helpers
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmt(n, d=2){ return Number(n).toFixed(d); }
function deg(rad){ return rad*180/Math.PI; }
function rad(deg){ return deg*Math.PI/180; }

function rho_atm(alt_km){
  return REF.rho0 * Math.exp(-alt_km/REF.H_km);
}
function dynamicPressure(rho, v_ms){ return 0.5 * rho * v_ms * v_ms; }
function heatingProxy(rho, v_ms){ return rho * Math.pow(v_ms,3); }

function updateClocks(){
  const now = new Date();
  utcOut.textContent = now.toUTCString().slice(17,25);
  const cst = new Intl.DateTimeFormat("en-US", {
    timeZone: "America/Monterrey",
    hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(now);
  cstOut.textContent = cst;
}

function earthSurfaceRot(latDeg){
  return REF.earthEqRot_ms * Math.cos(rad(latDeg));
}

function setStage(s){
  mission.stage = s;
  stageOut.textContent = s;
  phaseOut.textContent = s;
}

/* ========= NEW: Orbit preset helper ========= */
function applyPreset(kind){
  // Keep Earth at thetaE=0 for clarity, set Mars relative phase.
  thetaE = 0;
  if (kind === "opp"){ thetaM = rad(180); presetOut.textContent = "Opposition"; }
  else if (kind === "conj"){ thetaM = rad(0); presetOut.textContent = "Conjunction"; }
  else { thetaM = rad(90); presetOut.textContent = "Average"; }
}

function resetMission(){
  running=false;
  simT=0;
  applyPreset("avg"); // default preset now controls initial geometry
  mission.progress=0;
  mission.tTransfer=0;
  mission.departEpoch=null;
  mission.arrivalEpoch=null;
  mission.log=[];
  setStage("IDLE");
  progOut.textContent = "0.0";
  progBar.style.width = "0%";
  ttOut.textContent = "—";
  arrOut.textContent = "—";
}
</script>
<!-- ======================= PART 4 / 5 ======================= -->
<script>
function updateAeroPanel(){
  const v_kms = parseFloat(vAir.value);
  const h_km = parseFloat(altKm.value);

  vAirOut.textContent = fmt(v_kms,2);
  altOut.textContent = fmt(h_km,1);

  const rho = rho_atm(h_km);
  rhoOut.textContent = rho.toExponential(3);

  const v_ms = v_kms*1000;
  const q = dynamicPressure(rho, v_ms);
  qOut.textContent = `${fmt(q/1000,2)} kPa`;

  const heat = heatingProxy(rho, v_ms);
  const heatNorm = heat / heatingProxy(REF.rho0, 1000);
  heatOut.textContent = `${fmt(heatNorm,3)} × (ref)`;

  const mach = (v_ms / REF.a_sound_ms);
  machOut.textContent = `${fmt(mach,1)} (proxy)`;

  const edge = parseFloat(edgeKm.value);
  const rhoTiny = rho_atm(edge);
  const tiny = rho <= rhoTiny * 1.2;
  const qSoft = q < 20_000;
  const heatSoft = heatNorm < 0.20;

  let status = "ATMOSPHERE-DOMINATED (non-geodesic)";
  let color = "var(--bad)";
  if (tiny && qSoft && heatSoft){
    status = "CORRIDOR OK (ρ tiny → geodesic-like coast possible)";
    color = "var(--good)";
  } else if (h_km > edge*0.7 && (qSoft || heatSoft)){
    status = "APPROACHING CORRIDOR (forces dropping)";
    color = "var(--warn)";
  }
  corridorOut.textContent = status;
  corridorOut.style.color = color;

  const score = clamp(
    (tiny?0.55:0) + (qSoft?0.25:0) + (heatSoft?0.20:0),
    0, 1
  );
  geoScoreOut.textContent = `${fmt(score*100,1)} / 100`;
  geoBar.style.width = `${fmt(score*100,1)}%`;

  // edge label
  edgeOut.textContent = String(parseFloat(edgeKm.value));
}

function drawOrbit(){
  const w = orbitCanvas.width, h = orbitCanvas.height;
  octx.clearRect(0,0,w,h);

  octx.globalAlpha = 1;
  octx.strokeStyle = "rgba(148,163,184,.18)";
  for(let i=1;i<=4;i++){
    octx.beginPath();
    octx.arc(w*0.5,h*0.5, i*55, 0, Math.PI*2);
    octx.stroke();
  }

  octx.fillStyle = "rgba(253,224,71,.85)";
  octx.beginPath();
  octx.arc(w*0.5,h*0.5, 7, 0, Math.PI*2);
  octx.fill();

  const scale = 120;
  const rE = REF.rE_AU*scale;
  const rM = REF.rM_AU*scale;

  octx.strokeStyle = "rgba(56,189,248,.35)";
  octx.beginPath(); octx.arc(w*0.5,h*0.5,rE,0,Math.PI*2); octx.stroke();
  octx.strokeStyle = "rgba(34,197,94,.30)";
  octx.beginPath(); octx.arc(w*0.5,h*0.5,rM,0,Math.PI*2); octx.stroke();

  const ex = w*0.5 + rE*Math.cos(thetaE);
  const ey = h*0.5 + rE*Math.sin(thetaE);

  const mx = w*0.5 + rM*Math.cos(thetaM);
  const my = h*0.5 + rM*Math.sin(thetaM);

  octx.fillStyle = "rgba(56,189,248,.95)";
  octx.beginPath(); octx.arc(ex,ey,6,0,Math.PI*2); octx.fill();

  octx.fillStyle = "rgba(251,146,60,.90)";
  octx.beginPath(); octx.arc(mx,my,5,0,Math.PI*2); octx.fill();

  octx.strokeStyle = "rgba(229,231,235,.35)";
  octx.beginPath();
  octx.moveTo(ex,ey); octx.lineTo(mx,my);
  octx.stroke();

  thE.textContent = fmt((deg(thetaE)%360+360)%360,1);
  thM.textContent = fmt((deg(thetaM)%360+360)%360,1);

  let phase = (deg(thetaM-thetaE));
  phase = ((phase%360)+360)%360;
  phOut.textContent = fmt(phase,1);

  const rEk = REF.rE_AU*REF.AU_km;
  const rMk = REF.rM_AU*REF.AU_km;
  const dx = rEk*Math.cos(thetaE) - rMk*Math.cos(thetaM);
  const dy = rEk*Math.sin(thetaE) - rMk*Math.sin(thetaM);
  const dist_km = Math.hypot(dx,dy);
  distOut.textContent = fmt(dist_km/1e6,3);
}

function draw4DLine(){
  const w = line4dCanvas.width, h = line4dCanvas.height;
  lctx.clearRect(0,0,w,h);

  const ex = REF.rE_AU*Math.cos(thetaE);
  const ey = REF.rE_AU*Math.sin(thetaE);
  const mx = REF.rM_AU*Math.cos(thetaM);
  const my = REF.rM_AU*Math.sin(thetaM);

  const wE = REF.wScale * Math.sin(thetaE);
  const wM = REF.wScale * Math.sin(thetaM);

  const dx = mx-ex, dy = my-ey, dw = wM-wE;
  const sep3 = Math.hypot(dx,dy);
  const sep4 = Math.hypot(dx,dy,dw);
  sep4dOut.textContent = `3D(AU)=${fmt(sep3,4)} · 4D(AU,w)=${fmt(sep4,4)} (toy w)`;

  lctx.strokeStyle = "rgba(148,163,184,.22)";
  lctx.beginPath(); lctx.moveTo(40,h*0.5); lctx.lineTo(w-20,h*0.5); lctx.stroke();
  lctx.beginPath(); lctx.moveTo(40,20); lctx.lineTo(40,h-20); lctx.stroke();

  function mapX(x){ return 40 + (x+2.0)*(w-60)/4.0; }
  function mapY(y){ return h*0.5 - y*(h-50)/4.0; }

  lctx.fillStyle = "rgba(56,189,248,.95)";
  lctx.beginPath(); lctx.arc(mapX(ex), mapY(ey), 5, 0, Math.PI*2); lctx.fill();

  lctx.fillStyle = "rgba(251,146,60,.92)";
  lctx.beginPath(); lctx.arc(mapX(mx), mapY(my), 5, 0, Math.PI*2); lctx.fill();

  lctx.strokeStyle = "rgba(229,231,235,.35)";
  lctx.beginPath();
  lctx.moveTo(mapX(ex), mapY(ey));
  lctx.lineTo(mapX(mx), mapY(my));
  lctx.stroke();

  const wx = w - 46;
  lctx.strokeStyle = "rgba(56,189,248,.35)";
  lctx.beginPath(); lctx.moveTo(wx, h*0.5 - wE*600); lctx.lineTo(wx, h*0.5); lctx.stroke();
  lctx.strokeStyle = "rgba(251,146,60,.35)";
  lctx.beginPath(); lctx.moveTo(wx+12, h*0.5 - wM*600); lctx.lineTo(wx+12, h*0.5); lctx.stroke();

  lctx.fillStyle = "rgba(229,231,235,.75)";
  lctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
  lctx.fillText("x-y plane (AU)", 46, 32);
  lctx.fillText("w channel (toy)", w-140, 32);
}

function missionStep(dt){
  const edge = parseFloat(edgeKm.value);
  const h = parseFloat(altKm.value);
  const v = parseFloat(vAir.value);

  if (mission.stage === "IDLE") return;

  if (mission.stage === "ASCENT"){
    altKm.value = String(clamp(h + dt*0.02*parseFloat(timeScale.value)*10, 0, edge));
    vAir.value = String(clamp(v + dt*0.00035*parseFloat(timeScale.value)*10, 0.2, 3.6));
    if (parseFloat(altKm.value) >= edge - 0.2){
      setStage("EDGE_COAST");
    }
  }
  else if (mission.stage === "EDGE_COAST"){
    vAir.value = String(clamp(v - dt*0.0005*parseFloat(timeScale.value)*10, 0.2, 3.6));
    if (parseFloat(vAir.value) <= 0.35){
      setStage("TRANSFER");
      mission.tTransfer = 0;
    }
  }
  else if (mission.stage === "TRANSFER"){
    mission.tTransfer += dt*parseFloat(timeScale.value);

    const phase = ((deg(thetaM-thetaE)%360)+360)%360;
    const target = 44;
    const err = Math.min(Math.abs(phase-target), 360-Math.abs(phase-target));
    const window = clamp(1 - err/90, 0, 1);

    mission.progress = clamp(mission.progress + dt*0.00002*(0.25 + 0.75*window)*parseFloat(timeScale.value), 0, 1);

    if (mission.progress >= 1){
      setStage("ARRIVAL");
      const now = new Date();
      mission.arrivalEpoch = new Date(now.getTime() + Math.round(mission.tTransfer*1000));
    }
  }

  progOut.textContent = fmt(mission.progress*100,1);
  progBar.style.width = `${fmt(mission.progress*100,1)}%`;

  if (mission.stage === "TRANSFER" || mission.stage === "ARRIVAL"){
    const days = mission.tTransfer/86400;
    ttOut.textContent = `${fmt(days,2)} days (toy)`;
  }

  if (mission.arrivalEpoch){
    const cst = new Intl.DateTimeFormat("en-US", {
      timeZone:"America/Monterrey",
      year:"numeric", month:"short", day:"2-digit",
      hour12:false, hour:"2-digit", minute:"2-digit"
    }).format(mission.arrivalEpoch);
    arrOut.textContent = cst;
  }

  const phaseDeg = ((deg(thetaM-thetaE)%360)+360)%360;
  const rho = rho_atm(parseFloat(altKm.value));
  const vms = parseFloat(vAir.value)*1000;
  const q = dynamicPressure(rho, vms);
  const heatNorm = heatingProxy(rho, vms) / heatingProxy(REF.rho0, 1000);

  mission.log.push({
    t_s: simT,
    stage: mission.stage,
    lat_deg: parseFloat(lat.value),
    alt_km: parseFloat(altKm.value),
    v_air_kms: parseFloat(vAir.value),
    rho: rho,
    q_kPa: q/1000,
    heat_norm: heatNorm,
    thetaE_deg: (deg(thetaE)%360+360)%360,
    thetaM_deg: (deg(thetaM)%360+360)%360,
    phase_deg: phaseDeg,
    progress: mission.progress,
    preset: presetOut.textContent
  });
}

function tick(){
  updateClocks();

  const ts = parseFloat(timeScale.value);
  simDT = 0.1 * ts;
  dtOut.textContent = fmt(simDT,2);
  tsOut.textContent = fmt(ts,2);

  if (running){
    simT += simDT;
    thetaE += omegaE * simDT;
    thetaM += omegaM * simDT;
    missionStep(simDT);
  }

  tOut.textContent = fmt(simT,1);

  drawOrbit();
  draw4DLine();
  updateAeroPanel();

  latOut.textContent = fmt(parseFloat(lat.value),1);
  const vrot = earthSurfaceRot(parseFloat(lat.value));
  vRotOut.textContent = fmt(vrot,1);

  modeOut.textContent = mode.options[mode.selectedIndex].text.split(" ")[0].toUpperCase();

  requestAnimationFrame(tick);
}
</script>
<!-- ======================= PART 5 / 5 ======================= -->
<script>
// Buttons
startBtn.addEventListener("click", ()=>{
  if (mission.stage === "IDLE"){
    setStage("ASCENT");
    mission.departEpoch = new Date();
    mission.progress = 0;
    mission.log = [];
  }
  running=true;
});
pauseBtn.addEventListener("click", ()=> running=false);
resetBtn.addEventListener("click", ()=> resetMission());

// NEW: Preset buttons (do not reset logs unless you hit Reset)
presetOpp.addEventListener("click", ()=>{
  applyPreset("opp");
});
presetAvg.addEventListener("click", ()=>{
  applyPreset("avg");
});
presetConj.addEventListener("click", ()=>{
  applyPreset("conj");
});

csvBtn.addEventListener("click", ()=>{
  const cols = ["t_s","stage","preset","lat_deg","alt_km","v_air_kms","rho","q_kPa","heat_norm","thetaE_deg","thetaM_deg","phase_deg","progress"];
  const lines = [cols.join(",")];
  for (const r of mission.log){
    lines.push(cols.map(k=>{
      const v = r[k];
      if (typeof v === "string") return `"${v.replaceAll('"','""')}"`;
      if (typeof v === "number") return String(v);
      return "";
    }).join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `earth_mars_geodesic_corridor_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

printBtn.addEventListener("click", ()=> window.print());

// UI interactions
[lat, mode, edgeKm, timeScale, vAir, altKm].forEach(el=>{
  el.addEventListener("input", ()=> updateAeroPanel());
});

// Initialize
resetMission();
updateAeroPanel();
tick();
</script>

</body>
</html>
