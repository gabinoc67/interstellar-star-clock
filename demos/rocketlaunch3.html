<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rocket Corridor A→B (Failsafe) — 5 Stages</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --radius:16px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(circle at top,#0a1226,#000 70%);
    color:var(--ink);
    font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, rgba(2,6,23,.98), rgba(2,6,23,.72));
    border-bottom:1px solid var(--line);
    backdrop-filter: blur(10px);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:12px 14px;}
  .title{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
  h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}

  .grid{display:grid; gap:12px; grid-template-columns: 420px 1fr; align-items:start;}
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

  .card{
    background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.86));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card h2{
    margin:0;
    font-size:13px;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    background:rgba(2,6,23,.35);
    letter-spacing:.15px;
  }
  .card .body{padding:10px 12px}

  .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
  label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}

  input, select{
    width:100%;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.22);
    color:var(--ink);
    padding:9px 10px;
    border-radius:12px;
    outline:none;
  }
  input:focus, select:focus{
    border-color:rgba(96,165,250,.6);
    box-shadow:0 0 0 3px rgba(96,165,250,.12)
  }

  .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  button{
    border:1px solid rgba(148,163,184,.22);
    background:rgba(2,6,23,.55);
    color:var(--ink);
    padding:9px 10px;
    border-radius:12px;
    cursor:pointer;
    transition:.15s transform ease, .15s border-color ease;
  }
  button:hover{transform:translateY(-1px); border-color:rgba(96,165,250,.55)}
  button.primary{background:rgba(96,165,250,.22); border-color:rgba(96,165,250,.5)}
  button.good{background:rgba(52,211,153,.14); border-color:rgba(52,211,153,.45)}
  button.danger{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.45)}
  button:disabled{opacity:.45; cursor:not-allowed; transform:none}

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    font-size:12px; padding:6px 10px; border-radius:999px;
    border:1px solid var(--line); background:rgba(2,6,23,.35);
    color:var(--muted);
  }
  .pill b{color:var(--ink); font-weight:700}

  .kv{
    display:grid; grid-template-columns: 1fr auto; gap:8px;
    padding:7px 0; border-bottom:1px dashed rgba(148,163,184,.18);
    font-family: var(--mono); font-size:12px;
  }
  .kv:last-child{border-bottom:none}
  .kv .k{color:var(--muted); font-family: system-ui}
  .kv .v{color:var(--ink)}

  canvas{
    width:100%; height:560px; display:block;
    background:
      radial-gradient(circle at 70% 30%, rgba(96,165,250,.12), rgba(0,0,0,.0) 55%),
      linear-gradient(180deg, rgba(2,6,23,.25), rgba(0,0,0,.0));
  }

  .small{font-size:12px;color:var(--muted)}
  .log{
    font-family:var(--mono);
    font-size:12px;
    background:rgba(2,6,23,.45);
    border:1px solid rgba(148,163,184,.18);
    border-radius:12px;
    padding:8px;
    max-height:210px;
    overflow:auto;
  }

  .hint{
    margin-top:10px;
    padding:10px;
    border:1px solid rgba(148,163,184,.18);
    border-radius:12px;
    background:rgba(2,6,23,.35);
    color:var(--muted);
    font-size:12px;
  }
</style>
</head>
<body>

<header class="noPrint">
  <div class="wrap title">
    <div>
      <h1>Rocket Corridor A→B (Failsafe) — 5 Stages — Calculate → Launch → Stop → Reset</h1>
      <div class="sub">Buttons hardened (inline + listeners + window export). Guaranteed liftoff (toy assist). Rocket icon has outline + fill.</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <span class="pill">UTC <b id="utcNow">—</b></span>
      <span class="pill">Status <b id="status">Idle</b></span>
      <span class="pill">Stage <b id="stageNow">—</b></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <div class="card">
      <h2>Inputs + Controls</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Point A Latitude (deg)</label>
            <input id="lat" type="number" step="0.01" value="25.90">
          </div>
          <div>
            <label>Point A Altitude (m)</label>
            <input id="h0" type="number" step="1" value="10">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Target Point B Altitude (m)</label>
            <input id="hB" type="number" step="1000" value="200000">
          </div>
          <div>
            <label>Stop Mode</label>
            <select id="mode">
              <option value="stage5">Stop after Stage 5 (required)</option>
              <option value="orbit">Also stop if reaches B corridor</option>
              <option value="escape">Also stop if ε ≥ 0 (toy escape)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Max dynamic pressure q<sub>max</sub> (Pa)</label>
            <input id="qmax" type="number" step="1000" value="45000">
          </div>
          <div>
            <label>Max heat proxy Ċ<sub>max</sub> (arb)</label>
            <input id="qdotmax" type="number" step="100" value="12000">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Coolant capacity Q<sub>cap</sub> (arb)</label>
            <input id="coolCap" type="number" step="100" value="90000">
          </div>
          <div>
            <label>Coolant max flow (arb/s)</label>
            <input id="coolFlow" type="number" step="1" value="450">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Drag area CdA (m²)</label>
            <input id="cda" type="number" step="0.1" value="6.5">
          </div>
          <div>
            <label>Lift factor (0–0.15)</label>
            <input id="liftK" type="number" step="0.01" value="0.06">
          </div>
        </div>

        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--line)">
          <div class="small"><b>Mass + guidance</b></div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Total liftoff mass m₀ (kg)</label>
              <input id="m0" type="number" step="1000" value="550000">
            </div>
            <div>
              <label>Dry mass total (kg)</label>
              <input id="mdry" type="number" step="1000" value="80000">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Stage sep mass drop (kg)</label>
              <input id="sepMass" type="number" step="100" value="3500">
            </div>
            <div>
              <label>Vertical lock time (s)</label>
              <input id="vertLock" type="number" step="1" value="25">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Pitch-over start (s)</label>
              <input id="pitchStart" type="number" step="1" value="35">
            </div>
            <div>
              <label>Pitch-over end (s)</label>
              <input id="pitchEnd" type="number" step="1" value="260">
            </div>
          </div>

          <div class="hint">
            If the rocket “won’t go up” in a toy sim, it’s usually T/W &lt; 1.
            This build has a <b>failsafe liftoff assist</b> so it always climbs.
          </div>

          <div class="small" style="margin-top:12px"><b>Stages 1 → 5</b></div>

          <div class="row" style="margin-top:10px">
            <div><label>t1 (s)</label><input id="t1" type="number" value="70"></div>
            <div><label>T1 (N)</label><input id="T1" type="number" value="7600000"></div>
          </div>
          <div class="row">
            <div><label>Isp1 (s)</label><input id="Isp1" type="number" value="300"></div>
            <div><label>t2 (s)</label><input id="t2" type="number" value="80"></div>
          </div>
          <div class="row">
            <div><label>T2 (N)</label><input id="T2" type="number" value="2500000"></div>
            <div><label>Isp2 (s)</label><input id="Isp2" type="number" value="330"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div><label>t3 (s)</label><input id="t3" type="number" value="90"></div>
            <div><label>T3 (N)</label><input id="T3" type="number" value="900000"></div>
          </div>
          <div class="row">
            <div><label>Isp3 (s)</label><input id="Isp3" type="number" value="420"></div>
            <div><label>t4 (s)</label><input id="t4" type="number" value="95"></div>
          </div>
          <div class="row">
            <div><label>T4 (N)</label><input id="T4" type="number" value="650000"></div>
            <div><label>Isp4 (s)</label><input id="Isp4" type="number" value="520"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div><label>t5 (s)</label><input id="t5" type="number" value="110"></div>
            <div><label>T5 (N)</label><input id="T5" type="number" value="420000"></div>
          </div>
          <div class="row">
            <div><label>Isp5 (s)</label><input id="Isp5" type="number" value="650"></div>
            <div>
              <label>After Stage 5</label>
              <select id="stage5End">
                <option value="stop">Stop at end of Stage 5</option>
                <option value="coast">Coast 30s then stop</option>
              </select>
            </div>
          </div>
        </div>

        <div class="btns">
          <button id="btnCalc" class="primary" onclick="calcSim()">Calculate</button>
          <button id="btnLaunch" class="good" onclick="startLaunch()" disabled>Launch</button>
          <button id="btnStop" class="danger" onclick="stopSim()" disabled>Stop</button>
          <button id="btnReset" onclick="hardReset()">Reset</button>
          <button id="btnPrint" onclick="printReport()" disabled>Print Report</button>
        </div>

        <div style="margin-top:10px" class="log" id="log"></div>
      </div>
    </div>

    <div class="card">
      <h2>Trajectory (East x vs Up y) + Live Gauges</h2>
      <div class="body">
        <canvas id="cv" width="900" height="560"></canvas>

        <div class="row3" style="margin-top:10px">
          <div class="kv"><div class="k">t (s)</div><div class="v" id="g_t">—</div></div>
          <div class="kv"><div class="k">h (m)</div><div class="v" id="g_h">—</div></div>
          <div class="kv"><div class="k">v (m/s)</div><div class="v" id="g_v">—</div></div>
        </div>
        <div class="row3">
          <div class="kv"><div class="k">q (Pa)</div><div class="v" id="g_q">—</div></div>
          <div class="kv"><div class="k">heat proxy</div><div class="v" id="g_qdot">—</div></div>
          <div class="kv"><div class="k">coolant used</div><div class="v" id="g_cool">—</div></div>
        </div>
        <div class="row3">
          <div class="kv"><div class="k">mass (kg)</div><div class="v" id="g_m">—</div></div>
          <div class="kv"><div class="k">thrust (N)</div><div class="v" id="g_T">—</div></div>
          <div class="kv"><div class="k">ε (J/kg)</div><div class="v" id="g_eps">—</div></div>
        </div>

        <div class="small" style="margin-top:8px">
          This build always draws atmosphere lines (10–200km) + orbit refs (200/400/800km) and a rocket icon with an outline.
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===================== PART 2 / 4 ===================== */

const $ = (id)=>document.getElementById(id);
let cv, ctx, logEl;
let raf=null;
let sim=null;

function log(msg){
  if(!logEl) return;
  const t=new Date().toLocaleTimeString();
  logEl.innerHTML = `<div>[${t}] ${msg}</div>` + logEl.innerHTML;
}
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function fmt(x,d=2){
  if(!isFinite(x)) return "—";
  const abs=Math.abs(x);
  if(abs>=1e9) return (x/1e9).toFixed(d)+"e9";
  if(abs>=1e6) return (x/1e6).toFixed(d)+"e6";
  if(abs>=1e3) return (x/1e3).toFixed(d)+"k";
  return x.toFixed(d);
}
function fmtInt(x){ return isFinite(x)? Math.round(x).toLocaleString():"—"; }
function setStatus(s){ $("status").textContent=s; }
function nowUTC(){ const d=new Date(); return d.toISOString().replace("T"," ").slice(0,19)+"Z"; }

/* constants */
const Re=6371000;
const mu=3.986004418e14;
const omega=7.2921159e-5;
const g0=9.80665;

/* atmosphere */
const rho0=1.225;
const H=8500;
function rhoAt(h){
  if(h<0) h=0;
  if(h>200000) return 0;
  return rho0*Math.exp(-h/H);
}

/* toy heating */
function heatProxy(rho,v){
  return Math.sqrt(Math.max(0,rho))*v*v*v*1e-5;
}

/* rotation */
function earthRotSpeed(latDeg){
  const lat=latDeg*Math.PI/180;
  return omega*Re*Math.cos(lat);
}

/* energy */
function epsilon(r,v){ return 0.5*v*v - mu/r; }

/* lift dir */
function liftDir(vx,vy){
  const v=Math.hypot(vx,vy)||1;
  return {lx:-vy/v, ly:vx/v};
}

/* pitch program:
   - vertical lock for first vertLock seconds
   - then ease from 90deg to 0deg between pitchStart and pitchEnd
*/
function pitchAngleRad(t, vertLock, pitchStart, pitchEnd){
  if(t < vertLock) return Math.PI/2;
  if(t < pitchStart) return Math.PI/2;

  const u = clamp((t - pitchStart)/Math.max(1,(pitchEnd - pitchStart)), 0, 1);
  const s = u*u*(3-2*u);
  const deg = 90*(1 - s);
  return deg*Math.PI/180;
}

function drawScene(path, rocket, B){
  const W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);

  // keep a stable view so lines are always visible
  let minX=0, maxX=320000, maxY=300000;

  for(const p of path){
    minX=Math.min(minX,p.x);
    maxX=Math.max(maxX,p.x);
    maxY=Math.max(maxY,p.y);
  }
  if(B){
    maxX=Math.max(maxX,B.x);
    maxY=Math.max(maxY,B.y);
  }
  maxY=Math.max(maxY,300000);

  const margin=50;
  const spanX=Math.max(1,maxX-minX);
  const spanY=Math.max(1,maxY);

  const sx=(W-2*margin)/spanX;
  const sy=(H-2*margin)/spanY;
  const s=Math.min(sx,sy);

  function toPx(x,y){
    return {px: margin + (x-minX)*s, py: H - margin - y*s};
  }

  // ground
  ctx.strokeStyle="rgba(148,163,184,.35)";
  ctx.lineWidth=1;
  ctx.beginPath();
  let a=toPx(minX,0), b=toPx(maxX,0);
  ctx.moveTo(a.px,a.py); ctx.lineTo(b.px,b.py); ctx.stroke();

  // atmosphere lines (always)
  const atm=[10000,30000,60000,100000,150000,200000];
  ctx.font="11px system-ui";
  for(const h of atm){
    const p0=toPx(minX,h), p1=toPx(maxX,h);
    ctx.strokeStyle="rgba(96,165,250,.22)";
    ctx.beginPath(); ctx.moveTo(p0.px,p0.py); ctx.lineTo(p1.px,p1.py); ctx.stroke();
    ctx.fillStyle="rgba(229,231,235,.70)";
    ctx.fillText(`${Math.round(h/1000)} km`, p0.px+6, p0.py-4);
  }

  // orbit refs (draw even if above maxY by clamping label area)
  const orb=[200000,400000,800000];
  for(const h of orb){
    if(h>maxY) continue;
    const p0=toPx(minX,h), p1=toPx(maxX,h);
    ctx.strokeStyle="rgba(52,211,153,.18)";
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(p0.px,p0.py); ctx.lineTo(p1.px,p1.py); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle="rgba(52,211,153,.72)";
    ctx.fillText(`orbit ref ${Math.round(h/1000)} km`, p1.px-150, p1.py-4);
  }

  // path
  if(path.length>1){
    ctx.strokeStyle="rgba(96,165,250,.92)";
    ctx.lineWidth=2;
    ctx.beginPath();
    let p=toPx(path[0].x,path[0].y);
    ctx.moveTo(p.px,p.py);
    for(let i=1;i<path.length;i++){
      p=toPx(path[i].x,path[i].y);
      ctx.lineTo(p.px,p.py);
    }
    ctx.stroke();
  }

  // B marker
  if(B){
    const pb=toPx(B.x,B.y);
    ctx.fillStyle="rgba(52,211,153,.96)";
    ctx.beginPath(); ctx.arc(pb.px,pb.py,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(229,231,235,.95)";
    ctx.font="12px system-ui";
    ctx.fillText("Point B", pb.px+10, pb.py-10);
  }

  // rocket icon (outline + fill)
  if(rocket){
    const pr=toPx(rocket.x,rocket.y);
    ctx.save();
    ctx.translate(pr.px,pr.py);
    const ang=Math.atan2(rocket.vy,rocket.vx);
    ctx.rotate(ang);

    // body
    ctx.lineWidth=2.5;
    ctx.strokeStyle="rgba(0,0,0,.85)";
    ctx.fillStyle="rgba(251,191,36,.98)";

    ctx.beginPath();
    ctx.moveTo(16,0);
    ctx.lineTo(-10,-7);
    ctx.lineTo(-7,0);
    ctx.lineTo(-10,7);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // tail fin
    ctx.fillStyle="rgba(96,165,250,.85)";
    ctx.beginPath();
    ctx.moveTo(-7,0);
    ctx.lineTo(-15,-4);
    ctx.lineTo(-14,0);
    ctx.lineTo(-15,4);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.restore();
  }

  // axis hint
  ctx.fillStyle="rgba(229,231,235,.88)";
  ctx.font="12px system-ui";
  ctx.fillText("East →", W-80, 18);
  ctx.fillText("Up ↑", W-55, 34);
}
/* ===================== PART 3 / 4 ===================== */

function readInputs(){
  return {
    lat:+$("lat").value, h0:+$("h0").value, hB:+$("hB").value,
    mode:$("mode").value,
    qmax:+$("qmax").value, qdotmax:+$("qdotmax").value,
    coolCap:+$("coolCap").value, coolFlow:+$("coolFlow").value,
    cda:+$("cda").value, liftK:+$("liftK").value,
    m0:+$("m0").value, mdry:+$("mdry").value, sepMass:+$("sepMass").value,
    vertLock:+$("vertLock").value, pitchStart:+$("pitchStart").value, pitchEnd:+$("pitchEnd").value,

    t1:+$("t1").value, T1:+$("T1").value, Isp1:+$("Isp1").value,
    t2:+$("t2").value, T2:+$("T2").value, Isp2:+$("Isp2").value,
    t3:+$("t3").value, T3:+$("T3").value, Isp3:+$("Isp3").value,
    t4:+$("t4").value, T4:+$("T4").value, Isp4:+$("Isp4").value,
    t5:+$("t5").value, T5:+$("T5").value, Isp5:+$("Isp5").value,
    stage5End:$("stage5End").value
  };
}

function buildPlan(inp){
  const vrot=earthRotSpeed(inp.lat);
  const xB=Math.max(150000, inp.hB*1.9);
  const B={x:xB, y:inp.hB};
  const tEnd=inp.t1+inp.t2+inp.t3+inp.t4+inp.t5;
  return {vrot, B, tEnd};
}

function getStage(sim){
  const i=sim.inp, t=sim.t;
  const c1=i.t1, c2=c1+i.t2, c3=c2+i.t3, c4=c3+i.t4, c5=c4+i.t5;
  if(t<c1) return {stage:1, T:i.T1, Isp:i.Isp1, end:c1};
  if(t<c2) return {stage:2, T:i.T2, Isp:i.Isp2, end:c2};
  if(t<c3) return {stage:3, T:i.T3, Isp:i.Isp3, end:c3};
  if(t<c4) return {stage:4, T:i.T4, Isp:i.Isp4, end:c4};
  if(t<c5) return {stage:5, T:i.T5, Isp:i.Isp5, end:c5};
  return {stage:0, T:0, Isp:1, end:c5};
}

function calcSim(){
  const inp=readInputs();
  const plan=buildPlan(inp);

  sim={
    inp, plan,
    running:false,
    done:false,
    t:0, dt:0.20,
    x:0, y:inp.h0,
    vx:plan.vrot, vy:0,
    m:inp.m0,
    sepCount:0,
    coolUsed:0,
    coolStored:0,
    path:[{x:0,y:inp.h0}],
    hist:[]
  };

  setStatus("Ready (Calculated)");
  $("stageNow").textContent="—";
  $("btnLaunch").disabled=false;
  $("btnStop").disabled=true;
  $("btnPrint").disabled=true;

  log(`Calculated. v_rot ≈ ${fmt(plan.vrot,1)} m/s. Total burn ≈ ${fmt(plan.tEnd,1)} s.`);
  drawScene(sim.path, {x:sim.x,y:sim.y,vx:sim.vx,vy:sim.vy}, plan.B);
}

function updateGauges(s){
  $("g_t").textContent=fmt(s.t,1);
  $("g_h").textContent=fmtInt(s.h);
  $("g_v").textContent=fmt(s.v,1);
  $("g_q").textContent=fmtInt(s.q);
  $("g_qdot").textContent=fmt(s.qdot,1);
  $("g_cool").textContent=`${fmtInt(s.coolUsed)} / ${fmtInt(sim.inp.coolCap)}`;
  $("g_m").textContent=fmtInt(s.m);
  $("g_T").textContent=fmtInt(s.T);
  $("g_eps").textContent=fmt(s.eps,1);
}

function reachedExtraStop(sim){
  if(sim.inp.mode==="orbit"){
    return (sim.y>=sim.plan.B.y && sim.x>=sim.plan.B.x*0.98);
  }
  if(sim.inp.mode==="escape"){
    const r=Re+sim.y;
    const v=Math.hypot(sim.vx,sim.vy);
    return (epsilon(r,v)>=0 && sim.y>120000);
  }
  return false;
}

function stepSim(){
  if(!sim || sim.done) return;

  const i=sim.inp;
  const dt=sim.dt;

  const st=getStage(sim);
  $("stageNow").textContent=(st.stage===0) ? "Coast" : `Stage ${st.stage}`;

  // stage separation drops
  if(st.stage>1){
    const desiredDrops=st.stage-1; // stage2 =>1 ... stage5=>4
    while(sim.sepCount < desiredDrops){
      sim.sepCount++;
      sim.m=Math.max(i.mdry, sim.m - i.sepMass);
      log(`Stage sep #${sim.sepCount}: -${fmtInt(i.sepMass)} kg at t=${fmt(sim.t,1)} s`);
    }
  }

  const r=Re+sim.y;
  const v=Math.hypot(sim.vx,sim.vy)||1e-9;
  const rho=rhoAt(sim.y);

  const q=0.5*rho*v*v;
  const D=q*i.cda;
  const L=q*i.cda*i.liftK;
  const qdot=heatProxy(rho,v);

  // coolant
  let coolNow=0;
  if(qdot>i.qdotmax){
    coolNow=clamp(qdot-i.qdotmax,0,i.coolFlow);
  }
  sim.coolUsed += coolNow*dt;
  const excessHeat=Math.max(0,qdot-i.qdotmax-coolNow);
  sim.coolStored += excessHeat*dt;

  // throttle limits
  let throttle=1;
  if(q>i.qmax) throttle *= clamp(i.qmax/q,0.20,1);
  if(sim.coolUsed>i.coolCap) throttle *= 0.20;

  // guidance
  const ang=pitchAngleRad(sim.t, i.vertLock, i.pitchStart, i.pitchEnd);
  const ux=Math.cos(ang), uy=Math.sin(ang);

  // gravity
  const g=mu/(r*r);

  // FAILSAFE LIFTOFF ASSIST:
  // Ensure vertical thrust component can beat gravity early in flight.
  // If (T*uy/m) < 1.10*g for first 30s, boost throttle temporarily.
  const baseT = st.T * throttle;
  const needAy = 1.10*g; // target upward accel
  const currentAyT = (baseT/sim.m)*uy;
  let assist=1.0;
  if(sim.t < 30 && st.stage>0 && uy>0.5 && currentAyT < needAy){
    assist = clamp(needAy / Math.max(1e-9,currentAyT), 1.0, 2.5);
  }
  const T = baseT * assist;

  // massflow
  let mdot=0;
  if(T>0 && st.stage>0){
    mdot = T/(st.Isp*g0);
  }

  // accel
  const axT=(T/sim.m)*ux;
  const ayT=(T/sim.m)*uy;

  const axD=-(D/sim.m)*(sim.vx/v);
  const ayD=-(D/sim.m)*(sim.vy/v);

  const ld=liftDir(sim.vx,sim.vy);
  const axL=(L/sim.m)*ld.lx;
  const ayL=(L/sim.m)*ld.ly;

  const ayG=-g;

  // integrate
  sim.vx += (axT+axD+axL)*dt;
  sim.vy += (ayT+ayD+ayL+ayG)*dt;

  sim.x += sim.vx*dt;
  sim.y += sim.vy*dt;

  sim.m = Math.max(i.mdry, sim.m - mdot*dt);
  sim.t += dt;

  // snapshot
  const eps=epsilon(Re+sim.y, Math.hypot(sim.vx,sim.vy));
  const snap={
    t:sim.t, stage:st.stage,
    x:sim.x, h:sim.y,
    vx:sim.vx, vy:sim.vy,
    v:Math.hypot(sim.vx,sim.vy),
    rho,q,D,L,qdot,
    coolUsed:sim.coolUsed,
    m:sim.m, T, eps
  };
  sim.hist.push(snap);
  sim.path.push({x:sim.x,y:sim.y});

  updateGauges(snap);
  drawScene(sim.path, {x:sim.x,y:sim.y,vx:sim.vx,vy:sim.vy}, sim.plan.B);

  // stop on failure
  if(sim.y<0 || sim.t>2200 || !isFinite(sim.x+sim.y+sim.vx+sim.vy+sim.m)){
    sim.done=true; sim.running=false;
    setStatus("Stopped (Fail/Timeout)");
    log("Stopped: fail/timeout/numeric.");
    $("btnStop").disabled=true;
    $("btnPrint").disabled=false;
    return;
  }

  // stop at end stage 5 (required)
  if(st.stage===0){
    sim.done=true; sim.running=false;
    setStatus("Stage 5 complete — stopped");
    log("Stage 5 complete. Click Reset.");
    $("btnStop").disabled=true;
    $("btnPrint").disabled=false;
    return;
  }

  // optional extra stops
  if(reachedExtraStop(sim)){
    sim.done=true; sim.running=false;
    setStatus("Stop condition reached");
    log("Stop condition reached (mode).");
    $("btnStop").disabled=true;
    $("btnPrint").disabled=false;
  }
}
/* ===================== PART 4 / 4 ===================== */

function loop(){
  if(!sim || !sim.running) return;
  for(let k=0;k<3;k++){
    if(!sim.running) break;
    stepSim();
  }
  raf=requestAnimationFrame(loop);
}

function startLaunch(){
  if(!sim){ log("Run Calculate first."); return; }
  if(sim.running) return;

  sim.running=true;
  sim.done=false;

  setStatus("Launching...");
  $("btnCalc").disabled=true;
  $("btnLaunch").disabled=true;
  $("btnStop").disabled=false;
  $("btnPrint").disabled=true;

  log("Launch started. 5 stages will run and stop at Stage 5.");
  if(raf) cancelAnimationFrame(raf);
  raf=requestAnimationFrame(loop);
}

function stopSim(){
  if(!sim) return;
  sim.running=false;
  setStatus("Stopped (Manual)");
  log("Stopped manually.");
  $("btnStop").disabled=true;
  $("btnPrint").disabled=false;
}

function hardReset(){
  if(raf) cancelAnimationFrame(raf);
  raf=null;
  sim=null;

  setStatus("Idle");
  $("stageNow").textContent="—";

  $("btnCalc").disabled=false;
  $("btnLaunch").disabled=true;
  $("btnStop").disabled=true;
  $("btnPrint").disabled=true;

  // clear gauges
  ["g_t","g_h","g_v","g_q","g_qdot","g_cool","g_m","g_T","g_eps"].forEach(id=>$(id).textContent="—");

  if(logEl) logEl.innerHTML="";
  drawScene([], null, {x:200000*1.9, y:200000});
  log("Reset complete. Click Calculate → Launch.");
}

function printReport(){
  window.print();
}

/* Add listeners (in addition to onclick) */
function wireEvents(){
  $("btnCalc")?.addEventListener("click", ()=>calcSim());
  $("btnLaunch")?.addEventListener("click", ()=>startLaunch());
  $("btnStop")?.addEventListener("click", ()=>stopSim());
  $("btnReset")?.addEventListener("click", ()=>hardReset());
  $("btnPrint")?.addEventListener("click", ()=>printReport());
}

/* Export to window (so inline onclick always finds them) */
function exportGlobals(){
  window.calcSim = calcSim;
  window.startLaunch = startLaunch;
  window.stopSim = stopSim;
  window.hardReset = hardReset;
  window.printReport = printReport;
}

window.addEventListener("load", ()=>{
  cv=$("cv");
  ctx=cv.getContext("2d");
  logEl=$("log");

  exportGlobals();
  wireEvents();

  setInterval(()=>{ $("utcNow").textContent=nowUTC(); }, 250);

  drawScene([], null, {x:200000*1.9, y:200000});
  setStatus("Idle");
  log("Ready. Click Calculate → Launch. (Failsafe liftoff + outlined rocket).");
});
</script>
</body>
</html>
