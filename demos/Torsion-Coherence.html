<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Torsion-Coherence Cavity Simulation v2</title>
<style>
body {
  margin: 0;
  background: #0c0f18;
  color: #d9e7ff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
#container {
  display: flex;
  flex-direction: row;
  height: 100vh;
}
#controls {
  width: 320px;
  background: #111624;
  padding: 20px;
  border-right: 2px solid #223048;
  overflow-y: auto;
}
h2 {
  margin-top: 0;
}
label {
  display: block;
  margin: 15px 0 3px;
  font-size: 14px;
}
input[type=range] { width: 100%; }
.small {
  font-size: 12px;
  color: #9fb4e8;
}
#readouts {
  margin-top: 20px;
  line-height: 1.6;
  font-size: 13px;
}
#toggles {
  margin-top: 20px;
  font-size: 13px;
}
#toggles label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 4px 0;
}
button {
  margin-top: 16px;
  padding: 6px 10px;
  background: #1f3b72;
  border: 1px solid #31549d;
  border-radius: 4px;
  color: #e4edff;
  font-size: 13px;
  cursor: pointer;
}
button:hover {
  background: #284783;
}
#viewport {
  flex: 1;
  display: flex;
  flex-direction: column;
}
#explanationBox {
  font-size: 12px;
  padding: 8px 15px;
  line-height: 1.5;
  background: rgba(24,34,57,0.95);
  border-bottom: 2px solid #223048;
}
#topBar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  padding: 3px 15px 5px;
  background: #080c15;
  border-bottom: 1px solid #223048;
}
#cstClock {
  font-family: "SF Mono", Menlo, Consolas, monospace;
  color: #9dd8ff;
}
#canvas {
  flex: 1;
  background: #020619;
}
.legend {
  display: flex;
  gap: 16px;
  font-size: 11px;
}
.legend span {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.legend-box {
  width: 10px;
  height: 10px;
  border-radius: 2px;
}
.legend-mag { background: #6f9cff; }
.legend-phase { background: #8ce38a; }
.legend-temp { background: #ffb46b; }
</style>
</head>
<body>

<div id="container">

  <!-- Left control panel -->
  <div id="controls">
    <h2>Cavity Simulation v2</h2>

    <div class="small">
      This simulation visualizes synthetic signatures of a torsion-coherence
      vacuum cavity. It is a numerical model for concept demonstration, not
      experimental proof.
    </div>

    <label>CST Phase Modulation</label>
    <input id="phase" type="range" min="0" max="1" step="0.001" value="0.5">

    <label>Vacuum Torsion Strength</label>
    <input id="torsion" type="range" min="0" max="1" step="0.001" value="0.3">

    <label>Boundary Damping</label>
    <input id="damping" type="range" min="0" max="1" step="0.001" value="0.35">

    <label>Noise Floor</label>
    <input id="noise" type="range" min="0" max="0.05" step="0.001" value="0.01">

    <div id="readouts">
      <div><b>PicoTesla Magnetometer:</b> <span id="mag"></span></div>
      <div><b>Radar Phase Shift:</b> <span id="phaseShift"></span></div>
      <div><b>Thermal Anomaly:</b> <span id="temp"></span></div>
      <div><b>Geometric Stability:</b> <span id="stability"></span></div>
      <div><b>Φ_eff (Geometric Potential):</b> <span id="phi"></span></div>
    </div>

    <div id="toggles">
      <div><b>Show Signals:</b></div>
      <label><input type="checkbox" id="showMag" checked> Magnetometer</label>
      <label><input type="checkbox" id="showPhase" checked> Phase Shift</label>
      <label><input type="checkbox" id="showTemp" checked> Thermal</label>
    </div>

    <button id="downloadCsvBtn">Download CSV Data</button>

    <div class="small" style="margin-top:16px;">
      CSV columns: t, phi, magnetometer, phaseShift, thermal, stability.
      These values are synthetic and derived from the model equations.
    </div>
  </div>

  <!-- Right simulation panel -->
  <div id="viewport">

    <div id="topBar">
      <div class="legend">
        <span><span class="legend-box legend-mag"></span>Magnetometer</span>
        <span><span class="legend-box legend-phase"></span>Phase Shift</span>
        <span><span class="legend-box legend-temp"></span>Thermal</span>
      </div>
      <div id="cstClock"></div>
    </div>

    <div id="explanationBox">
      This simulation models expected signatures of a torsion-coherence vacuum
      cavity, including CST modulation, geometric potential Φ_eff, magnetometer
      drift, radar phase anomalies, thermal fluctuations without resistive
      heating, and cavity stability. It visually demonstrates the central
      prediction: geometry can generate measurable signals without classical
      force or mass motion. However, simulation alone cannot prove torsion
      coherence, because numerical models rely on idealized assumptions and
      boundary conditions. Experimental validation requires an actual vacuum
      cavity with calibrated magnetometry, interferometry, and thermal sensing.
      If laboratory measurements later match the predicted waveforms in this
      model, then experiment confirms the theory and the simulation becomes
      predictive rather than illustrative.
    </div>

    <canvas id="canvas"></canvas>
  </div>

</div>

<script>
/***********************************************************
 Numerical model:
   Phi_eff(t) = torsion * phase * exp(-damping * t) * sin(omega t)
   magnetometer ≈ Phi_eff + noise
   phaseShift  ≈ d(Phi_eff)/dt
   thermal     ≈ Phi_eff^2 (no resistive heating)
   stability   ≈ (1 - damping + torsion)

 This is a conceptual model only.
***********************************************************/
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
resize();
window.addEventListener("resize", resize);

let t = 0;
let dt = 0.05;
let data = []; // {t, phi, mag, phaseShift, temp, stability}

function updateClock() {
  const el = document.getElementById("cstClock");
  const now = new Date();
  // Treat local time as CST display for simplicity
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  el.textContent = "CST Simulation Time: " + hh + ":" + mm + ":" + ss;
}
setInterval(updateClock, 1000);
updateClock();

function step() {
  t += dt;

  const phase   = +document.getElementById("phase").value;
  const torsion = +document.getElementById("torsion").value;
  const damping = +document.getElementById("damping").value;
  const noise   = +document.getElementById("noise").value;

  const omega = 1.2; // nominal cavity oscillation frequency
  const phi = torsion * phase * Math.exp(-damping * t) * Math.sin(omega * t);

  const last = data.length ? data[data.length-1] : null;
  const mag = phi + (Math.random() - 0.5) * noise;

  let phaseShift;
  if (last) {
    phaseShift = (phi - last.phi) / dt;
  } else {
    phaseShift = 0;
  }

  const temp = phi * phi * 5000;
  const stability = 1 - damping + torsion;

  data.push({ t, phi, mag, phaseShift, temp, stability });

  if (data.length > 1500) data.shift();

  document.getElementById("mag").textContent       = mag.toFixed(6) + " pT";
  document.getElementById("phaseShift").textContent = phaseShift.toFixed(4) + " arb.";
  document.getElementById("temp").textContent      = temp.toFixed(3) + " mK";
  document.getElementById("stability").textContent = stability.toFixed(3);
  document.getElementById("phi").textContent       = phi.toExponential(3);

  drawGraph();
  requestAnimationFrame(step);
}

function drawSeries(seriesKey, bandTop, bandHeight, scale, color, visible) {
  if (!visible || data.length < 2) return;

  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = (i / (data.length - 1)) * canvas.width;
    const v = data[i][seriesKey];
    const y = bandTop + bandHeight / 2 - v * scale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.stroke();
}

function drawGraph() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const w = canvas.width;
  const h = canvas.height;
  const bands = 3;
  const bandHeight = h / bands;

  const showMag   = document.getElementById("showMag").checked;
  const showPhase = document.getElementById("showPhase").checked;
  const showTemp  = document.getElementById("showTemp").checked;

  // Draw band separators and labels
  const labels = ["Magnetometer (pT)", "Phase Shift (arb.)", "Thermal (mK)"];
  const colors = ["#6f9cff", "#8ce38a", "#ffb46b"];

  ctx.font = "11px system-ui";
  ctx.textBaseline = "top";

  for (let i = 0; i < bands; i++) {
    const top = i * bandHeight;

    // horizontal midline
    ctx.strokeStyle = "#23354f";
    ctx.beginPath();
    ctx.moveTo(0, top + bandHeight / 2);
    ctx.lineTo(w, top + bandHeight / 2);
    ctx.stroke();

    // label
    ctx.fillStyle = colors[i];
    ctx.fillText(labels[i], 6, top + 4);
  }

  // Scales tuned so curves are visible but not crazy
  drawSeries("mag",        0 * bandHeight, bandHeight, 3000,  "#6f9cff", showMag);
  drawSeries("phaseShift", 1 * bandHeight, bandHeight, 80,    "#8ce38a", showPhase);
  drawSeries("temp",       2 * bandHeight, bandHeight, 0.002, "#ffb46b", showTemp);
}

// CSV export
document.getElementById("downloadCsvBtn").addEventListener("click", () => {
  if (!data.length) return;

  let csv = "t,phi,magnetometer,phaseShift,thermal,stability\n";
  for (const row of data) {
    csv += [
      row.t.toFixed(4),
      row.phi,
      row.mag,
      row.phaseShift,
      row.temp,
      row.stability
    ].join(",") + "\n";
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "torsion_cavity_simulation_data.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

step();
</script>

</body>
</html>
