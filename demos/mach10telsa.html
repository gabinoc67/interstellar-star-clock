<!-- ======================= PART 1 / 4 =======================
MACH-10 TAKEOFF → 500 km → STABLE CRUISE (SIMPLE + RELIABLE)
Fix goals (what this version guarantees):
✅ ALL labels update LIVE every frame (even before START)
✅ Plane is visible on runway, takes off, climbs through ALL bands to 500 km
✅ Atmospheric bands are always drawn + labeled (0 to 500 km)
✅ After 500 km it CONTINUES stable cruise (keeps moving, telemetry live)
✅ Simple single-file HTML (no external assets)
How to use:
1) Copy PART 1, PART 2, PART 3, PART 4 into ONE file in that order
2) Save as: mach10_live.html
3) Open in a browser
============================================================== -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mach-10 Field-Managed Vehicle + CST Sync (LIVE) — 0→500 km</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#060912;
    --panel:#0f172a;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --line:rgba(148,163,184,.20);
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow:0 18px 55px rgba(0,0,0,.45);
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden;}
  canvas{position:fixed; inset:0;}

  .wrap{
    position:fixed; inset:0; display:grid;
    grid-template-columns: 360px 1fr 380px;
    grid-template-rows: auto 1fr auto;
    gap:10px; padding:10px;
    pointer-events:none;
  }
  .panel{
    pointer-events:auto;
    background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.86));
    border:1px solid rgba(120,170,255,.35);
    border-radius:16px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }
  .ph{padding:10px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .ph h3{margin:0; font-size:13px; letter-spacing:.3px; font-weight:900; color:#eaf2ff;}
  .tag{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 8px; border-radius:999px;}
  .pc{padding:10px 12px;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  .grid1{display:grid; grid-template-columns:1fr; gap:8px;}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); border-radius:12px; background:rgba(2,6,23,.35);}
  .row .k{font-size:11px; color:var(--muted);}
  .row .v{font-variant-numeric: tabular-nums; font-size:12px; font-weight:900;}
  .btns{display:flex; gap:8px; flex-wrap:wrap;}
  button{
    cursor:pointer; border:1px solid rgba(120,170,255,.35);
    background:rgba(10,18,40,.7); color:var(--ink);
    border-radius:12px; padding:8px 10px;
    font-weight:900; font-size:12px;
  }
  button:hover{border-color:rgba(160,210,255,.55);}
  button:active{transform:translateY(1px);}
  .btnStart{border-color:rgba(52,211,153,.45);}
  .btnStop{border-color:rgba(251,191,36,.45);}
  .btnReset{border-color:rgba(251,113,133,.45);}
  .hint{font-size:11px; color:var(--muted); line-height:1.35;}

  .sliderRow{display:grid; grid-template-columns: 1fr 92px; gap:10px; align-items:center;}
  input[type="range"]{width:100%;}
  input[type="number"]{
    width:92px; box-sizing:border-box;
    background:rgba(2,6,23,.55); border:1px solid var(--line);
    color:var(--ink); border-radius:10px; padding:7px 8px; font-weight:900;
  }

  .bar{
    height:9px; border-radius:999px; background:rgba(148,163,184,.18);
    overflow:hidden; border:1px solid rgba(148,163,184,.15);
  }
  .bar > i{display:block; height:100%; width:50%; background:rgba(96,165,250,.75);}
  .bar.good > i{background:rgba(52,211,153,.75);}
  .bar.warn > i{background:rgba(251,191,36,.78);}
  .bar.bad > i{background:rgba(251,113,133,.78);}
  .mini{font-size:10px; color:var(--muted);}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}

  .stageBox{
    margin-top:10px;
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    padding:10px;
  }
  .stageTitle{font-weight:950; font-size:12px; letter-spacing:.2px;}
  .stageDesc{margin-top:6px; font-size:11px; color:var(--muted); line-height:1.35;}
  .stageList{margin-top:10px; display:grid; gap:6px;}
  .step{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:7px 9px; border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.22);
  }
  .step b{font-size:11px;}
  .pill{font-size:10px; color:rgba(226,232,240,.95); border:1px solid rgba(148,163,184,.22); padding:2px 7px; border-radius:999px;}
  .step.active{border-color:rgba(96,165,250,.60); background:rgba(96,165,250,.12);}

  /* layout slots */
  #pControls{grid-column:1; grid-row:1 / span 2;}
  #pExplain{grid-column:1; grid-row:3;}
  #pFlight{grid-column:2; grid-row:1 / span 3;}
  #pBands{grid-column:3; grid-row:1;}
  #pData{grid-column:3; grid-row:2;}
  #pEnergy{grid-column:3; grid-row:3;}
</style>
</head>
<body>
<canvas id="cv"></canvas>

<div class="wrap">
  <!-- LEFT: Controls -->
  <section class="panel" id="pControls">
    <div class="ph">
      <h3>Controls & Inputs</h3>
      <span class="tag">Runway → Takeoff → Mach 10 → 500 km Cruise</span>
    </div>
    <div class="pc grid1">
      <div class="btns">
        <button class="btnStart" id="btnStart">START</button>
        <button class="btnStop" id="btnStop">STOP</button>
        <button class="btnReset" id="btnReset">RESET</button>
      </div>

      <div class="row">
        <div>
          <div class="k">Mode</div>
          <div class="v" id="uiMode">Ready</div>
        </div>
        <div style="text-align:right">
          <div class="k">Sim Time</div>
          <div class="v mono" id="uiT">0.0 s</div>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="k">Target</div>
          <div class="v">Mach 10 → 500 km → Stable Cruise</div>
        </div>
        <div style="text-align:right">
          <div class="k">CST Sync</div>
          <div class="v mono" id="uiCST">0.00</div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Vehicle / Mission</div>
        <div class="grid2">
          <div>
            <div class="mini">Takeoff Mass (kg)</div>
            <div class="sliderRow">
              <input id="m0" type="range" min="80000" max="400000" step="1000" value="180000">
              <input id="m0n" type="number" value="180000">
            </div>
          </div>
          <div>
            <div class="mini">Fuel (kg)</div>
            <div class="sliderRow">
              <input id="fuel0" type="range" min="15000" max="220000" step="1000" value="90000">
              <input id="fuel0n" type="number" value="90000">
            </div>
          </div>
          <div>
            <div class="mini">Thrust Max (kN)</div>
            <div class="sliderRow">
              <input id="thkN" type="range" min="200" max="3200" step="10" value="1400">
              <input id="thkNn" type="number" value="1400">
            </div>
          </div>
          <div>
            <div class="mini">Cd Base</div>
            <div class="sliderRow">
              <input id="cd0" type="range" min="0.06" max="0.35" step="0.01" value="0.16">
              <input id="cd0n" type="number" step="0.01" value="0.16">
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Tesla-style “Air as Medium” knobs (simple)</div>
        <div class="grid2">
          <div>
            <div class="mini">Ionization χ (0–1)</div>
            <div class="sliderRow">
              <input id="chi" type="range" min="0" max="1" step="0.01" value="0.25">
              <input id="chin" type="number" step="0.01" value="0.25">
            </div>
          </div>
          <div>
            <div class="mini">MHD Coupling K (0–1)</div>
            <div class="sliderRow">
              <input id="kmhd" type="range" min="0" max="1" step="0.01" value="0.35">
              <input id="kmhdn" type="number" step="0.01" value="0.35">
            </div>
          </div>
          <div>
            <div class="mini">CST Phase Coherence C (0–1)</div>
            <div class="sliderRow">
              <input id="csync" type="range" min="0" max="1" step="0.01" value="0.55">
              <input id="csyncn" type="number" step="0.01" value="0.55">
            </div>
          </div>
          <div>
            <div class="mini">HV Pulse Duty (0–1)</div>
            <div class="sliderRow">
              <input id="duty" type="range" min="0" max="1" step="0.01" value="0.28">
              <input id="dutyn" type="number" step="0.01" value="0.28">
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:8px;">
          Simple rule: higher χ×K×C = stronger control → lower Cd′ + lower heating proxy + higher stability.
        </div>
      </div>
    </div>
  </section>

  <!-- CENTER: Flight view -->
  <section class="panel" id="pFlight">
    <div class="ph">
      <h3>Flight View + Stage-by-Stage (LIVE)</h3>
      <span class="tag mono" id="uiMachTag">Mach 0.00</span>
    </div>
    <div class="pc">
      <div class="hint">
        You will see: runway (plane visible) → takeoff → climb through labeled bands → reach <b>500 km</b> →
        <b>stable cruise continues</b> (keeps moving) while all numbers stay live.
      </div>

      <div class="stageBox">
        <div class="stageTitle" id="uiStepTitle">Stage: —</div>
        <div class="stageDesc" id="uiStepDesc">—</div>

        <div class="stageList">
          <div class="step" id="s0"><b>0) Runway Roll</b><span class="pill" id="p0">—</span></div>
          <div class="step" id="s1"><b>1) Takeoff + Initial Climb</b><span class="pill" id="p1">—</span></div>
          <div class="step" id="s2"><b>2) Dense Air Accel</b><span class="pill" id="p2">—</span></div>
          <div class="step" id="s3"><b>3) Upper Atmosphere Push</b><span class="pill" id="p3">—</span></div>
          <div class="step" id="s4"><b>4) Near-Space Transition</b><span class="pill" id="p4">—</span></div>
          <div class="step" id="s5"><b>5) 500 km Stable Cruise</b><span class="pill" id="p5">—</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT TOP: Bands -->
  <section class="panel" id="pBands">
    <div class="ph">
      <h3>Altitude Bands (0 → 500 km)</h3>
      <span class="tag">Always Visible</span>
    </div>
    <div class="pc grid1">
      <div class="row">
        <div>
          <div class="k">Current Band</div>
          <div class="v" id="uiBand">—</div>
        </div>
        <div style="text-align:right">
          <div class="k">Altitude</div>
          <div class="v mono" id="uiAlt">0 m</div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Progress to 500 km</div>
        <div class="bar good"><i id="barAlt" style="width:0%"></i></div>
        <div class="mini" id="uiBandNote" style="margin-top:6px;">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Stability (toy)</div>
        <div class="bar"><i id="barStab" style="width:35%"></i></div>
        <div class="mini" id="uiStab">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Field Effectiveness χ×K×C</div>
        <div class="bar"><i id="barEff" style="width:0%"></i></div>
        <div class="mini" id="uiEff">—</div>
      </div>
    </div>
  </section>
<!-- ======================= PART 2 / 4 ======================= -->
  <!-- RIGHT MID: Data -->
  <section class="panel" id="pData">
    <div class="ph">
      <h3>Live Flight Data</h3>
      <span class="tag">Always Live</span>
    </div>
    <div class="pc grid1">
      <div class="grid2">
        <div class="row"><div class="k">Speed</div><div class="v mono" id="uiV">0 m/s</div></div>
        <div class="row"><div class="k">Mach</div><div class="v mono" id="uiMach">0.00</div></div>

        <div class="row"><div class="k">ρ (proxy)</div><div class="v mono" id="uiRho">—</div></div>
        <div class="row"><div class="k">q̄ (proxy)</div><div class="v mono" id="uiQ">—</div></div>

        <div class="row"><div class="k">Drag (proxy)</div><div class="v mono" id="uiD">—</div></div>
        <div class="row"><div class="k">Cd′ (modified)</div><div class="v mono" id="uiCd">—</div></div>

        <div class="row"><div class="k">Heat (proxy)</div><div class="v mono" id="uiHeat">—</div></div>
        <div class="row"><div class="k">Heat′ (reduced)</div><div class="v mono" id="uiHeat2">—</div></div>

        <div class="row"><div class="k">Skin Temp</div><div class="v mono" id="uiTemp">—</div></div>
        <div class="row"><div class="k">Coolant</div><div class="v mono" id="uiCool">—</div></div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Thermal Margin</div>
        <div class="bar"><i id="barTherm" style="width:100%"></i></div>
        <div class="mini" id="uiTherm">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Plasma Layer (proxy)</div>
        <div class="bar"><i id="barPlasma" style="width:0%"></i></div>
        <div class="mini" id="uiPlasma">—</div>
      </div>
    </div>
  </section>

  <!-- RIGHT BOT: Energy -->
  <section class="panel" id="pEnergy">
    <div class="ph">
      <h3>Fuel • Electricity • Control</h3>
      <span class="tag">Simple</span>
    </div>
    <div class="pc grid1">
      <div class="grid2">
        <div class="row"><div class="k">Mass</div><div class="v mono" id="uiM">—</div></div>
        <div class="row"><div class="k">Fuel Left</div><div class="v mono" id="uiFuel">—</div></div>

        <div class="row"><div class="k">Throttle</div><div class="v mono" id="uiThr">—</div></div>
        <div class="row"><div class="k">T/W (toy)</div><div class="v mono" id="uiTW">—</div></div>

        <div class="row"><div class="k">HV Power</div><div class="v mono" id="uiHV">—</div></div>
        <div class="row"><div class="k">Battery</div><div class="v mono" id="uiBatt">—</div></div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Battery State</div>
        <div class="bar good"><i id="barBatt" style="width:92%"></i></div>
        <div class="mini" id="uiBattNote">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">CST Sync Health</div>
        <div class="bar"><i id="barCST" style="width:45%"></i></div>
        <div class="mini" id="uiCSTNote">—</div>
      </div>
    </div>
  </section>

  <!-- LEFT BOTTOM: Explanation -->
  <section class="panel" id="pExplain">
    <div class="ph">
      <h3>What This Simulator Shows</h3>
      <span class="tag">Narrative</span>
    </div>
    <div class="pc">
      <div class="hint">
        <b>Simple CST + field-control story:</b><br>
        1) Plane starts on the runway (visible) and accelerates from v=0.<br>
        2) It climbs through labeled altitude bands all the way to <b>500 km</b>.<br>
        3) “Field Effectiveness” χ×K×C reduces Cd′ and heating proxies and increases stability proxy.<br>
        4) At 500 km it transitions to <b>stable cruise</b> and keeps moving while all panels stay live.
      </div>
    </div>
  </section>
</div>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
/* ============================================================
   SINGLE SCRIPT (all IDs verified) — SIMPLE RELIABLE ANIMATION
============================================================ */
"use strict";

/* ---------- tiny helpers ---------- */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const fmt=(x,d=2)=>Number.isFinite(x)?x.toFixed(d):"—";

/* ---------- canvas ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d",{alpha:true});
function resize(){
  const dpr=window.devicePixelRatio||1;
  cv.width=Math.floor(innerWidth*dpr);
  cv.height=Math.floor(innerHeight*dpr);
}
addEventListener("resize",resize); resize();

/* ---------- UI refs ---------- */
const UI={
  mode:document.getElementById("uiMode"),
  t:document.getElementById("uiT"),
  machTag:document.getElementById("uiMachTag"),

  band:document.getElementById("uiBand"),
  alt:document.getElementById("uiAlt"),
  bandNote:document.getElementById("uiBandNote"),

  v:document.getElementById("uiV"),
  mach:document.getElementById("uiMach"),
  rho:document.getElementById("uiRho"),
  q:document.getElementById("uiQ"),
  drag:document.getElementById("uiD"),
  cd:document.getElementById("uiCd"),
  heat:document.getElementById("uiHeat"),
  heat2:document.getElementById("uiHeat2"),
  temp:document.getElementById("uiTemp"),
  cool:document.getElementById("uiCool"),
  therm:document.getElementById("uiTherm"),
  plasma:document.getElementById("uiPlasma"),

  m:document.getElementById("uiM"),
  fuel:document.getElementById("uiFuel"),
  thr:document.getElementById("uiThr"),
  tw:document.getElementById("uiTW"),
  hv:document.getElementById("uiHV"),
  batt:document.getElementById("uiBatt"),
  battNote:document.getElementById("uiBattNote"),

  cst:document.getElementById("uiCST"),
  cstNote:document.getElementById("uiCSTNote"),

  stab:document.getElementById("uiStab"),
  eff:document.getElementById("uiEff"),

  barAlt:document.getElementById("barAlt"),
  barStab:document.getElementById("barStab"),
  barEff:document.getElementById("barEff"),
  barTherm:document.getElementById("barTherm"),
  barPlasma:document.getElementById("barPlasma"),
  barBatt:document.getElementById("barBatt"),
  barCST:document.getElementById("barCST"),

  stepTitle:document.getElementById("uiStepTitle"),
  stepDesc:document.getElementById("uiStepDesc"),
  s0:document.getElementById("s0"),
  s1:document.getElementById("s1"),
  s2:document.getElementById("s2"),
  s3:document.getElementById("s3"),
  s4:document.getElementById("s4"),
  s5:document.getElementById("s5"),
  p0:document.getElementById("p0"),
  p1:document.getElementById("p1"),
  p2:document.getElementById("p2"),
  p3:document.getElementById("p3"),
  p4:document.getElementById("p4"),
  p5:document.getElementById("p5"),
};

/* ---------- inputs ---------- */
const inp={
  m0:document.getElementById("m0"), m0n:document.getElementById("m0n"),
  fuel0:document.getElementById("fuel0"), fuel0n:document.getElementById("fuel0n"),
  thkN:document.getElementById("thkN"), thkNn:document.getElementById("thkNn"),
  cd0:document.getElementById("cd0"), cd0n:document.getElementById("cd0n"),
  chi:document.getElementById("chi"), chin:document.getElementById("chin"),
  kmhd:document.getElementById("kmhd"), kmhdn:document.getElementById("kmhdn"),
  csync:document.getElementById("csync"), csyncn:document.getElementById("csyncn"),
  duty:document.getElementById("duty"), dutyn:document.getElementById("dutyn"),
};

function bindPair(r,n,onChange){
  r.addEventListener("input",()=>{ n.value=r.value; onChange(); });
  n.addEventListener("input",()=>{ r.value=n.value; onChange(); });
}

/* ---------- altitude bands (0 → 500 km) ---------- */
const ALT_MAX=500000; // 500 km
const bands=[
  {name:"Runway / Ground", a0:0,      a1:2000,   note:"Runway and low altitude."},
  {name:"Troposphere",    a0:2000,   a1:12000,  note:"Dense air: drag/heating strongest."},
  {name:"Stratosphere",   a0:12000,  a1:50000,  note:"Thinning air; Mach can build."},
  {name:"Mesosphere",     a0:50000,  a1:85000,  note:"Very thin; plasma control easier."},
  {name:"Thermosphere",   a0:85000,  a1:200000, note:"Near-space transition."},
  {name:"Exosphere",      a0:200000, a1:ALT_MAX, note:"Very thin; stable cruise regime."},
];
function currentBand(alt){
  for(const b of bands) if(alt>=b.a0 && alt<b.a1) return b;
  return bands[bands.length-1];
}

/* ---------- simple atmosphere proxy ---------- */
function rhoProxy(altM){
  // Exponential drop, clamped so UI stays readable
  const rho0=1.225, H=7500;
  return clamp(rho0*Math.exp(-altM/H), 0.000001, rho0);
}

/* ---------- field effectiveness ---------- */
function fieldEffect(chi,kmhd,csync){
  const eff=clamp(chi*kmhd*csync,0,1);
  return {
    eff,
    cdMul:clamp(1-0.60*eff, 0.30, 1.0),
    heatMul:clamp(1-0.70*eff, 0.20, 1.0),
    stab:clamp(0.30+0.70*eff, 0, 1),
  };
}

/* ---------- schedules (simple, predictable) ---------- */
const TARGET_MACH=10;
function altSchedule(t){
  // 0–35s runway, 35–80s climb to 5 km, then climb to 500 km by ~900s, then hold
  if(t<=35) return 0;
  if(t<=80){
    const u=(t-35)/(80-35);
    return 5000*(u*u*(3-2*u));
  }
  const u=clamp((t-80)/(900-80),0,1);
  const s=u*u*(3-2*u);
  return ALT_MAX*s;
}
function machSchedule(altM){
  // builds slowly then approaches Mach 10 as altitude approaches 500 km
  const u=clamp(altM/ALT_MAX,0,1);
  const s=u*u*(3-2*u);
  return 0.2 + 9.8*s; // ~0.2 → 10.0
}
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
/* ---------- sim state ---------- */
let running=false;
let t=0;
let alt=0;
let v=0;
let xMeters=0;

let m=0;
let fuel=0;
let batt=0.92;
let skinT=300;
let coolant=0.85;

let cache={
  mach:0, rho:1.225, q:0, Cd:0.16, drag:0,
  throttle:0, hvPower:0,
  chi:0.25, kmhd:0.35, csync:0.55, duty:0.28,
  fx:{eff:0,cdMul:1,heatMul:1,stab:0.30},
  cstHealth:0.50, plasma:0.20,
  heatRaw:0, heatRed:0
};

function resetToInputs(){
  t=0; alt=0; v=0; xMeters=0;
  m=+inp.m0.value;
  fuel=clamp(+inp.fuel0.value,0,m*0.9);
  batt=0.92; skinT=300; coolant=0.85;
  running=false;
  UI.mode.textContent="Ready (on runway)";
  syncUI();
  render();
}

/* bind pairs */
bindPair(inp.m0,inp.m0n,resetToInputs);
bindPair(inp.fuel0,inp.fuel0n,resetToInputs);
bindPair(inp.thkN,inp.thkNn,()=>{});
bindPair(inp.cd0,inp.cd0n,()=>{});
bindPair(inp.chi,inp.chin,()=>{});
bindPair(inp.kmhd,inp.kmhdn,()=>{});
bindPair(inp.csync,inp.csyncn,()=>{});
bindPair(inp.duty,inp.dutyn,()=>{});

document.getElementById("btnStart").addEventListener("click",()=>{ running=true; lastMs=performance.now(); });
document.getElementById("btnStop").addEventListener("click",()=>{ running=false; });
document.getElementById("btnReset").addEventListener("click",()=>{ resetToInputs(); });

/* ---------- stage logic ---------- */
function stageLogic(){
  if(t<35) return {idx:0, title:"0) Runway Roll", desc:"Plane is on the runway and accelerates from v=0."};
  if(alt<5000) return {idx:1, title:"1) Takeoff + Initial Climb", desc:"Liftoff and climb-out. Controls stabilize early flow."};
  if(alt<50000) return {idx:2, title:"2) Dense Air Accel", desc:"Lower altitude: drag/heating proxies highest; χ×K×C helps."};
  if(alt<120000) return {idx:3, title:"3) Upper Atmosphere Push", desc:"Air thins; speed builds more easily; stability improves."};
  if(alt<ALT_MAX) return {idx:4, title:"4) Near-Space Transition", desc:"Approaching 500 km. Mach approaches 10, drag drops."};
  return {idx:5, title:"5) 500 km Stable Cruise", desc:"Holds altitude ~500 km and continues moving steadily."};
}
function highlightStage(idx){
  const steps=[UI.s0,UI.s1,UI.s2,UI.s3,UI.s4,UI.s5];
  steps.forEach((el,i)=>el.classList.toggle("active", i===idx));
}

/* ---------- update ---------- */
let lastMs=performance.now();
function update(dt){
  if(!running) return;

  t += dt;

  const chi=clamp(+inp.chi.value,0,1);
  const kmhd=clamp(+inp.kmhd.value,0,1);
  const csync=clamp(+inp.csync.value,0,1);
  const duty=clamp(+inp.duty.value,0,1);

  const fx=fieldEffect(chi,kmhd,csync);

  // altitude follows schedule (smooth)
  const altTarget=altSchedule(t);
  alt = lerp(alt, altTarget, clamp(dt*1.5,0,1));

  // Mach target from altitude, and speed target from Mach (use a stable "sound speed" proxy)
  const machT=machSchedule(alt);
  const aProxy=300; // keep stable for a clean toy animation
  const vTarget=machT*aProxy;

  // simple throttle controller
  let throttle=0;
  if(t<35) throttle=clamp(0.35 + 0.015*t, 0.35, 0.90);          // runway
  else if(alt<ALT_MAX) throttle=clamp(0.65 + 0.20*(1-fx.eff), 0.35, 1.0); // climb
  else throttle=0.22;                                            // cruise

  // fuel + mass
  const thrustMax=(+inp.thkN.value)*1000; // N
  const Isp=520; // simple constant for toy
  const g0=9.80665;
  const mdot=(throttle*thrustMax)/(Isp*g0);
  const fuelUse=Math.min(fuel, mdot*dt);
  fuel -= fuelUse;
  m = clamp(m - fuelUse, 5000, 1e12);
  if(fuel<=0) throttle=0.10;

  // approach target speed smoothly (guaranteed motion)
  const accel = (vTarget - v) * (0.35 + 0.35*throttle);
  v = clamp(v + accel*dt, 0, 4500);
  xMeters += v*dt;

  // proxies
  const rho=rhoProxy(alt);
  const Cd0=+inp.cd0.value;
  const Cd=Cd0*fx.cdMul;

  const q = 0.5*rho*v*v;                 // proxy dynamic pressure
  const drag = q*Cd*7.5;                 // proxy drag

  const heatRaw = rho*Math.pow(Math.max(v,1),3) * 2.0e-7;  // proxy heating
  const heatRed = heatRaw*fx.heatMul;

  // simple thermal + coolant behavior
  const coolEff = clamp(coolant*(0.55+0.55*csync),0,1);
  skinT = clamp(skinT + (heatRed*1.3 - coolEff*16)*dt, 220, 2400);
  coolant = clamp(coolant - heatRed*0.0025*dt + 0.006*dt, 0, 1);

  // HV + battery
  const hvBase=0.6e6;
  const hvPower = hvBase*duty*(0.6+0.9*chi)*(0.7+0.6*kmhd)*(1.0+(1-csync)*0.8);
  batt = clamp(batt - (hvPower/4.2e6)*dt, 0, 1);

  // CST/Plasma health (toy)
  const plasma = clamp(0.20 + 0.80*chi*(0.6+0.4*duty), 0, 1);
  const cstHealth = clamp(csync*(0.45+0.55*batt)*(0.6+0.4*plasma), 0, 1);

  cache={
    mach: v/aProxy,
    rho, q, Cd, drag,
    throttle, hvPower,
    chi, kmhd, csync, duty,
    fx, cstHealth, plasma,
    heatRaw, heatRed
  };
}

/* ---------- UI sync (ALWAYS live) ---------- */
function syncUI(){
  const b=currentBand(alt);
  const st=stageLogic();

  UI.mode.textContent = !running ? (t===0 ? "Ready (on runway)" : "Stopped") : (st.idx===5 ? "Stable Cruise @ 500 km" : "Flight");

  UI.t.textContent = `${fmt(t,1)} s`;
  UI.machTag.textContent = `Mach ${fmt(cache.mach,2)}`;

  UI.band.textContent=b.name;
  UI.alt.textContent = `${fmt(alt,0)} m`;
  UI.bandNote.textContent=b.note;

  UI.v.textContent = `${fmt(v,0)} m/s`;
  UI.mach.textContent = fmt(cache.mach,2);
  UI.rho.textContent = `${fmt(cache.rho,6)} kg/m³`;
  UI.q.textContent = `${fmt((cache.q||0)/1000,2)} kPa`;
  UI.drag.textContent = `${fmt((cache.drag||0)/1000,2)} kN`;
  UI.cd.textContent = fmt(cache.Cd,3);

  UI.heat.textContent = `${fmt(cache.heatRaw,3)} (proxy)`;
  UI.heat2.textContent = `${fmt(cache.heatRed,3)} (proxy)`;
  UI.temp.textContent = `${fmt(skinT,0)} K`;
  UI.cool.textContent = `${fmt(coolant*100,0)}%`;

  UI.m.textContent = `${fmt(m,0)} kg`;
  UI.fuel.textContent = `${fmt(fuel,0)} kg`;
  UI.thr.textContent = `${fmt((cache.throttle||0)*100,0)}%`;
  UI.tw.textContent = fmt(((cache.throttle||0) * (+inp.thkN.value*1000)) / (m*9.80665), 2);

  UI.hv.textContent = `${fmt((cache.hvPower||0)/1e6,2)} MW`;
  UI.batt.textContent = `${fmt(batt*100,0)}%`;

  UI.cst.textContent = fmt(cache.cstHealth,2);
  UI.cstNote.textContent = "Toy CST health: csync × battery × plasma";

  // bars
  UI.barAlt.style.width = `${clamp(alt/ALT_MAX,0,1)*100}%`;
  UI.barStab.style.width = `${(cache.fx?.stab||0)*100}%`;
  UI.barEff.style.width  = `${(cache.fx?.eff||0)*100}%`;

  UI.stab.textContent = `Stability ${fmt((cache.fx?.stab||0)*100,0)}%`;
  UI.eff.textContent  = `Effect χ×K×C = ${fmt((cache.fx?.eff||0),2)}`;

  const thermMargin=clamp(1 - (skinT-900)/900, 0, 1);
  UI.barTherm.style.width = `${thermMargin*100}%`;
  UI.uiThermText = UI.therm; // (no-op guard)
  UI.therm.textContent = `Thermal margin ${fmt(thermMargin*100,0)}%`;

  UI.barPlasma.style.width = `${(cache.plasma||0)*100}%`;
  UI.plasma.textContent = `Plasma ${fmt((cache.plasma||0)*100,0)}%`;

  UI.barBatt.style.width = `${batt*100}%`;
  UI.battNote.textContent = batt>0.2 ? "Battery OK" : "Low battery (field weak)";

  UI.barCST.style.width = `${(cache.cstHealth||0)*100}%`;
  UI.cstNote.textContent = "Higher = cleaner phasing / stability (toy)";

  // middle stage box
  UI.stepTitle.textContent = `Stage: ${st.title}`;
  UI.stepDesc.textContent  = st.desc;
  highlightStage(st.idx);

  UI.p0.textContent = (t<35) ? "ACTIVE" : "DONE";
  UI.p1.textContent = (t>=35 && alt<5000) ? "ACTIVE" : (alt>=5000 ? "DONE" : "—");
  UI.p2.textContent = (alt>=5000 && alt<50000) ? "ACTIVE" : (alt>=50000 ? "DONE" : "—");
  UI.p3.textContent = (alt>=50000 && alt<120000) ? "ACTIVE" : (alt>=120000 ? "DONE" : "—");
  UI.p4.textContent = (alt>=120000 && alt<ALT_MAX) ? "ACTIVE" : (alt>=ALT_MAX ? "DONE" : "—");
  UI.p5.textContent = (alt>=ALT_MAX) ? "ACTIVE" : "—";
}

/* ---------- drawing ---------- */
function drawRoundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
function drawAircraft(cx, cy, scale, glow, pitch){
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(pitch);
  ctx.scale(scale,scale);

  if(glow>0){
    ctx.shadowColor = `rgba(96,165,250,${0.55*glow})`;
    ctx.shadowBlur = 26*glow;
  }

  ctx.lineWidth = 2/scale;
  ctx.strokeStyle = "rgba(226,232,240,.95)";
  ctx.fillStyle   = "rgba(15,23,42,.75)";

  // fuselage
  ctx.beginPath();
  ctx.moveTo(-44, 0);
  ctx.quadraticCurveTo(-12, -9, 24, -7);
  ctx.quadraticCurveTo(50, -5, 64, 0);
  ctx.quadraticCurveTo(50, 5, 24, 7);
  ctx.quadraticCurveTo(-12, 9, -44, 0);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // wings
  ctx.beginPath();
  ctx.moveTo(-6, -2);
  ctx.lineTo(16, -24);
  ctx.lineTo(28, -24);
  ctx.lineTo(10, -2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-6, 2);
  ctx.lineTo(16, 24);
  ctx.lineTo(28, 24);
  ctx.lineTo(10, 2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // tail
  ctx.beginPath();
  ctx.moveTo(-26, -1);
  ctx.lineTo(-40, -16);
  ctx.lineTo(-30, -16);
  ctx.lineTo(-14, -2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // nose line
  ctx.beginPath();
  ctx.moveTo(64, 0);
  ctx.lineTo(76, 0);
  ctx.stroke();

  ctx.restore();
}
function drawBands(vp){
  const {x,y,w,h}=vp;
  const dpr=window.devicePixelRatio||1;

  // background gradient
  const g=ctx.createLinearGradient(0,y+h,0,y);
  g.addColorStop(0,"rgba(2,6,23,1)");
  g.addColorStop(0.45,"rgba(5,14,36,1)");
  g.addColorStop(0.80,"rgba(6,20,52,1)");
  g.addColorStop(1,"rgba(0,0,0,1)");
  ctx.fillStyle=g;
  ctx.fillRect(x,y,w,h);

  // stars
  ctx.globalAlpha=0.40;
  for(let i=0;i<170;i++){
    const sx = (Math.sin(i*999.1 + t*0.03)*0.5+0.5)*w + x;
    const sy = (Math.sin(i*333.7 + i*0.17)*0.5+0.5)*h + y;
    ctx.fillStyle="rgba(226,232,240,.95)";
    ctx.fillRect(sx,sy,(i%7===0)?2:1,(i%7===0)?2:1);
  }
  ctx.globalAlpha=1;

  // ground + runway
  const groundY=y+h*0.90;
  ctx.fillStyle="rgba(2,6,23,.96)";
  ctx.fillRect(x,groundY,w,y+h-groundY);

  ctx.fillStyle="rgba(10,18,40,.86)";
  ctx.fillRect(x+20*dpr,groundY-16*dpr,w-40*dpr,22*dpr);

  ctx.strokeStyle="rgba(226,232,240,.62)";
  ctx.lineWidth=2;
  ctx.setLineDash([18*dpr,14*dpr]);
  ctx.beginPath();
  ctx.moveTo(x+40*dpr,groundY-5*dpr);
  ctx.lineTo(x+w-40*dpr,groundY-5*dpr);
  ctx.stroke();
  ctx.setLineDash([]);

  // horizon curve (visual)
  const horizonY=y+h*0.74;
  ctx.strokeStyle="rgba(96,165,250,.55)";
  ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let i=0;i<=70;i++){
    const px = x + (i/70)*w;
    const dx = (i/70 - 0.5);
    const py = horizonY + dx*dx*(h*0.20);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();

  // altitude lines 0..500km (high contrast)
  const marks=[
    {km:0,   label:"0 km Ground / Runway", bold:true},
    {km:12,  label:"12 km Troposphere"},
    {km:50,  label:"50 km Stratosphere"},
    {km:85,  label:"85 km Mesosphere"},
    {km:120, label:"120 km Thermosphere"},
    {km:200, label:"200 km Exosphere"},
    {km:300, label:"300 km"},
    {km:400, label:"400 km"},
    {km:500, label:"500 km Cruise", bold:true},
  ];
  const topY = y + 26*dpr;
  const botY = groundY - 18*dpr;

  function yForKm(km){
    const u=clamp((km*1000)/ALT_MAX,0,1);
    return lerp(botY, topY, u);
  }

  ctx.font=`${12*dpr}px ui-monospace, Menlo, Consolas, monospace`;
  for(const m of marks){
    const py = yForKm(m.km);
    ctx.strokeStyle = m.bold ? "rgba(226,232,240,.92)" : "rgba(226,232,240,.60)";
    ctx.lineWidth   = m.bold ? 2.8 : 2.0;
    ctx.beginPath();
    ctx.moveTo(x+14*dpr,py);
    ctx.lineTo(x+w-14*dpr,py);
    ctx.stroke();

    ctx.fillStyle = m.bold ? "rgba(226,232,240,.96)" : "rgba(226,232,240,.78)";
    ctx.fillText(` ${m.label}`, x+18*dpr, py-7*dpr);
  }
}

function render(){
  const W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);

  const dpr=window.devicePixelRatio||1;
  const pad=10*dpr;
  const colL=360*dpr + pad*2;
  const colR=380*dpr + pad*2;
  const vp={ x:colL, y:pad, w:W-colL-colR, h:H-pad*2 };

  drawBands(vp);

  const groundY=vp.y+vp.h*0.90;
  const topY=vp.y+26*dpr;
  const botY=groundY-18*dpr;

  // craft position based on 0..500 km
  const uAlt=clamp(alt/ALT_MAX,0,1);
  const yCraft = lerp(botY-4*dpr, topY+12*dpr, uAlt);

  // always move left→right (stable cruise continues)
  const pxPerMeter=0.018*dpr;
  const xScroll=(xMeters*pxPerMeter)%(vp.w*0.86);
  const xCraft=vp.x + vp.w*0.07 + xScroll;

  const glow=clamp((cache.plasma||0)*(0.55+0.45*(cache.cstHealth||0)),0,1);
  const pitch = (t<35)?0:clamp(uAlt,0,1)*(-0.10);

  // plasma ring
  ctx.save();
  ctx.globalAlpha=0.88;
  ctx.strokeStyle=`rgba(96,165,250,${0.22+0.60*glow})`;
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.ellipse(xCraft, yCraft, 44*dpr, 18*dpr, pitch, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();

  drawAircraft(xCraft,yCraft,dpr*1.15,glow,pitch);

  // overlay telemetry box
  ctx.save();
  ctx.fillStyle="rgba(2,6,23,.62)";
  drawRoundedRect(vp.x+14, vp.y+14, 480*dpr, 118*dpr, 14*dpr);
  ctx.fill();
  ctx.strokeStyle="rgba(120,170,255,.28)";
  ctx.lineWidth=1;
  ctx.stroke();

  ctx.fillStyle="rgba(226,232,240,.95)";
  ctx.font=`${12*dpr}px ui-monospace, Menlo, Consolas, monospace`;
  ctx.fillText(`ALT ${Math.round(alt/1000)} km   V ${Math.round(v)} m/s   Mach ${fmt(cache.mach,2)}`, vp.x+26*dpr, vp.y+40*dpr);
  ctx.fillText(`ρ ${fmt(cache.rho,6)}   q̄ ${(cache.q/1000).toFixed(2)} kPa   Cd′ ${fmt(cache.Cd,3)}`, vp.x+26*dpr, vp.y+62*dpr);
  ctx.fillText(`χ ${fmt(cache.chi,2)} K ${fmt(cache.kmhd,2)} C ${fmt(cache.csync,2)} duty ${fmt(cache.duty,2)} CST ${fmt(cache.cstHealth,2)}`, vp.x+26*dpr, vp.y+84*dpr);
  ctx.fillText(`Heat×${fmt(cache.fx?.heatMul||1,2)}  Stab ${fmt(cache.fx?.stab||0,2)}  Batt ${Math.round(batt*100)}%`, vp.x+26*dpr, vp.y+106*dpr);
  ctx.restore();
}

/* ---------- loop ---------- */
function loop(){
  const now=performance.now();
  const dt=clamp((now-lastMs)/1000,0,0.05);
  lastMs=now;

  update(dt);
  syncUI();
  render();

  requestAnimationFrame(loop);
}

/* ---------- init ---------- */
resetToInputs();
requestAnimationFrame(loop);
syncUI();
render();
</script>
</body>
</html>
