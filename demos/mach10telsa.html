<!-- ======================= PART 1 / 4 =======================
SINGLE-FILE FULL HTML (all IDs verified, all panels LIVE)
What this version fixes vs your broken one:
✅ One single <script> (no split-script copy/paste breakage)
✅ Every UI id exists and is updated every frame (even before START)
✅ Takeoff starts on runway (v=0), accelerates, rotates, climbs gradually
✅ Mach builds toward 10 near edge-of-space, then holds stable cruise
✅ Altitude band lines are high-contrast and always visible
✅ Middle panel shows stage-by-stage LIVE status + explanation
============================================================== -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mach-10 Field-Managed Vehicle + CST Sync (LIVE)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#060912;
    --panel:#0f172a;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --line:rgba(148,163,184,.20);
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow:0 18px 55px rgba(0,0,0,.45);
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden;}
  canvas{position:fixed; inset:0;}

  .wrap{
    position:fixed; inset:0; display:grid;
    grid-template-columns: 360px 1fr 380px;
    grid-template-rows: auto 1fr auto;
    gap:10px; padding:10px;
    pointer-events:none;
  }
  .panel{
    pointer-events:auto;
    background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.86));
    border:1px solid rgba(120,170,255,.35);
    border-radius:16px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }
  .ph{padding:10px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .ph h3{margin:0; font-size:13px; letter-spacing:.3px; font-weight:800; color:#eaf2ff;}
  .tag{font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 8px; border-radius:999px;}
  .pc{padding:10px 12px;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  .grid1{display:grid; grid-template-columns:1fr; gap:8px;}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); border-radius:12px; background:rgba(2,6,23,.35);}
  .row .k{font-size:11px; color:var(--muted);}
  .row .v{font-variant-numeric: tabular-nums; font-size:12px; font-weight:800;}
  .btns{display:flex; gap:8px; flex-wrap:wrap;}
  button{
    cursor:pointer;
    border:1px solid rgba(120,170,255,.35);
    background:rgba(10,18,40,.7);
    color:var(--ink);
    border-radius:12px;
    padding:8px 10px;
    font-weight:800;
    font-size:12px;
  }
  button:hover{border-color:rgba(160,210,255,.55);}
  button:active{transform:translateY(1px);}
  .btnStart{border-color:rgba(52,211,153,.45);}
  .btnStop{border-color:rgba(251,191,36,.45);}
  .btnReset{border-color:rgba(251,113,133,.45);}
  .hint{font-size:11px; color:var(--muted); line-height:1.35;}

  .sliderRow{display:grid; grid-template-columns: 1fr 92px; gap:10px; align-items:center;}
  input[type="range"]{width:100%;}
  input[type="number"]{
    width:92px; box-sizing:border-box;
    background:rgba(2,6,23,.55); border:1px solid var(--line);
    color:var(--ink); border-radius:10px; padding:7px 8px; font-weight:800;
  }

  .bar{
    height:9px; border-radius:999px; background:rgba(148,163,184,.18);
    overflow:hidden; border:1px solid rgba(148,163,184,.15);
  }
  .bar > i{display:block; height:100%; width:50%; background:rgba(96,165,250,.75);}
  .bar.good > i{background:rgba(52,211,153,.75);}
  .bar.warn > i{background:rgba(251,191,36,.78);}
  .bar.bad > i{background:rgba(251,113,133,.78);}
  .mini{font-size:10px; color:var(--muted);}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}

  /* center stage box */
  .stageBox{
    margin-top:10px;
    border:1px solid rgba(148,163,184,.22);
    border-radius:14px;
    background:rgba(2,6,23,.35);
    padding:10px;
  }
  .stageTitle{font-weight:900; font-size:12px; letter-spacing:.2px;}
  .stageDesc{margin-top:6px; font-size:11px; color:var(--muted); line-height:1.35;}
  .stageList{margin-top:10px; display:grid; gap:6px;}
  .step{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:7px 9px; border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.22);
  }
  .step b{font-size:11px;}
  .pill{
    font-size:10px; color:rgba(226,232,240,.95);
    border:1px solid rgba(148,163,184,.22);
    padding:2px 7px; border-radius:999px;
  }
  .step.active{
    border-color:rgba(96,165,250,.60);
    background:rgba(96,165,250,.12);
  }

  /* layout slots */
  #pControls{grid-column:1; grid-row:1 / span 2;}
  #pExplain{grid-column:1; grid-row:3;}
  #pFlight{grid-column:2; grid-row:1 / span 3;}
  #pStages{grid-column:3; grid-row:1;}
  #pData{grid-column:3; grid-row:2;}
  #pEnergy{grid-column:3; grid-row:3;}
</style>
</head>
<body>
<canvas id="cv"></canvas>

<div class="wrap">
  <!-- LEFT: Controls -->
  <section class="panel" id="pControls">
    <div class="ph">
      <h3>Controls & Inputs</h3>
      <span class="tag">Runway → Takeoff → Mach 10 → Edge-of-Space Cruise</span>
    </div>
    <div class="pc grid1">
      <div class="btns">
        <button class="btnStart" id="btnStart">START</button>
        <button class="btnStop" id="btnStop">STOP</button>
        <button class="btnReset" id="btnReset">RESET</button>
      </div>

      <div class="row">
        <div>
          <div class="k">Mode</div>
          <div class="v" id="uiMode">Ready</div>
        </div>
        <div style="text-align:right">
          <div class="k">Sim Time</div>
          <div class="v mono" id="uiT">0.0 s</div>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="k">Target</div>
          <div class="v">Mach 10 → ~100 km → Stable Cruise</div>
        </div>
        <div style="text-align:right">
          <div class="k">CST Sync</div>
          <div class="v mono" id="uiCST">0.00</div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Vehicle / Mission</div>
        <div class="grid2">
          <div>
            <div class="mini">Takeoff Mass (kg)</div>
            <div class="sliderRow">
              <input id="m0" type="range" min="80000" max="400000" step="1000" value="180000">
              <input id="m0n" type="number" value="180000">
            </div>
          </div>
          <div>
            <div class="mini">Fuel (kg)</div>
            <div class="sliderRow">
              <input id="fuel0" type="range" min="15000" max="220000" step="1000" value="90000">
              <input id="fuel0n" type="number" value="90000">
            </div>
          </div>
          <div>
            <div class="mini">Thrust Max (kN)</div>
            <div class="sliderRow">
              <input id="thkN" type="range" min="200" max="3200" step="10" value="1400">
              <input id="thkNn" type="number" value="1400">
            </div>
          </div>
          <div>
            <div class="mini">Cd Base</div>
            <div class="sliderRow">
              <input id="cd0" type="range" min="0.06" max="0.35" step="0.01" value="0.16">
              <input id="cd0n" type="number" step="0.01" value="0.16">
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Tesla-style “Air as Medium” knobs (live control loop)</div>
        <div class="grid2">
          <div>
            <div class="mini">Ionization χ (0–1)</div>
            <div class="sliderRow">
              <input id="chi" type="range" min="0" max="1" step="0.01" value="0.25">
              <input id="chin" type="number" step="0.01" value="0.25">
            </div>
          </div>
          <div>
            <div class="mini">MHD Coupling K (0–1)</div>
            <div class="sliderRow">
              <input id="kmhd" type="range" min="0" max="1" step="0.01" value="0.35">
              <input id="kmhdn" type="number" step="0.01" value="0.35">
            </div>
          </div>
          <div>
            <div class="mini">CST Phase Coherence C (0–1)</div>
            <div class="sliderRow">
              <input id="csync" type="range" min="0" max="1" step="0.01" value="0.55">
              <input id="csyncn" type="number" step="0.01" value="0.55">
            </div>
          </div>
          <div>
            <div class="mini">HV Pulse Duty (0–1)</div>
            <div class="sliderRow">
              <input id="duty" type="range" min="0" max="1" step="0.01" value="0.28">
              <input id="dutyn" type="number" step="0.01" value="0.28">
            </div>
          </div>
        </div>
        <div class="hint" style="margin-top:8px;">
          HV pulses create a controllable ion layer. With coupling (K), EM forces push the ionized flow (J×B)
          to reshape shocks / boundary layer. CST coherence (C) is timing health for phased actuation stability.
        </div>
      </div>
    </div>
  </section>

  <!-- CENTER: Flight view -->
  <section class="panel" id="pFlight">
    <div class="ph">
      <h3>Flight View + Stage-by-Stage (LIVE)</h3>
      <span class="tag mono" id="uiMachTag">Mach 0.00</span>
    </div>
    <div class="pc">
      <div class="hint">
        <b>Watch:</b> runway takeoff (v rises from 0) → climb through altitude bands → Mach builds toward 10
        near ~100 km → then holds stable cruise while all panels remain live.
      </div>

      <div class="stageBox">
        <div class="stageTitle" id="uiStepTitle">Stage: —</div>
        <div class="stageDesc" id="uiStepDesc">—</div>

        <div class="stageList">
          <div class="step" id="s0"><b>0) Airfield Takeoff Roll</b><span class="pill" id="p0">—</span></div>
          <div class="step" id="s1"><b>1) Rotation + Initial Climb</b><span class="pill" id="p1">—</span></div>
          <div class="step" id="s2"><b>2) Dense-Air Accel (drag/heat control)</b><span class="pill" id="p2">—</span></div>
          <div class="step" id="s3"><b>3) Max-Q Management + Climb</b><span class="pill" id="p3">—</span></div>
          <div class="step" id="s4"><b>4) High-Altitude Mach Push</b><span class="pill" id="p4">—</span></div>
          <div class="step" id="s5"><b>5) Edge-of-Space Stable Cruise</b><span class="pill" id="p5">—</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT TOP: Bands -->
  <section class="panel" id="pStages">
    <div class="ph">
      <h3>Atmospheric Bands</h3>
      <span class="tag">Auto</span>
    </div>
    <div class="pc grid1">
      <div class="row">
        <div>
          <div class="k">Current Band</div>
          <div class="v" id="uiBand">—</div>
        </div>
        <div style="text-align:right">
          <div class="k">Altitude</div>
          <div class="v mono" id="uiAlt">0 m</div>
        </div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Band Progress</div>
        <div class="bar good"><i id="barBand" style="width:0%"></i></div>
        <div class="mini" id="uiBandNote" style="margin-top:6px;">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Inlet / Shock Stability (toy margin)</div>
        <div class="bar"><i id="barStab" style="width:35%"></i></div>
        <div class="mini" id="uiStab">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">“Air as Medium” Effectiveness</div>
        <div class="bar"><i id="barEff" style="width:0%"></i></div>
        <div class="mini" id="uiEff">—</div>
      </div>
    </div>
  </section>
<!-- ======================= PART 2 / 4 ======================= -->
  <!-- RIGHT MID: Data -->
  <section class="panel" id="pData">
    <div class="ph">
      <h3>Live Flight Data</h3>
      <span class="tag">All Live</span>
    </div>
    <div class="pc grid1">
      <div class="grid2">
        <div class="row"><div class="k">Speed</div><div class="v mono" id="uiV">0 m/s</div></div>
        <div class="row"><div class="k">Mach</div><div class="v mono" id="uiMach">0.00</div></div>

        <div class="row"><div class="k">ρ (air density)</div><div class="v mono" id="uiRho">—</div></div>
        <div class="row"><div class="k">q̄ (dyn pressure)</div><div class="v mono" id="uiQ">—</div></div>

        <div class="row"><div class="k">Drag (kN)</div><div class="v mono" id="uiD">—</div></div>
        <div class="row"><div class="k">Cd′ (field-modified)</div><div class="v mono" id="uiCd">—</div></div>

        <div class="row"><div class="k">Heat Flux (toy)</div><div class="v mono" id="uiHeat">—</div></div>
        <div class="row"><div class="k">Heat q̇′ (reduced)</div><div class="v mono" id="uiHeat2">—</div></div>

        <div class="row"><div class="k">Skin Temp</div><div class="v mono" id="uiTemp">—</div></div>
        <div class="row"><div class="k">Coolant</div><div class="v mono" id="uiCool">—</div></div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Thermal Margin</div>
        <div class="bar"><i id="barTherm" style="width:100%"></i></div>
        <div class="mini" id="uiTherm">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Plasma Layer (conductivity proxy)</div>
        <div class="bar"><i id="barPlasma" style="width:0%"></i></div>
        <div class="mini" id="uiPlasma">—</div>
      </div>
    </div>
  </section>

  <!-- RIGHT BOT: Energy -->
  <section class="panel" id="pEnergy">
    <div class="ph">
      <h3>Fuel • Electricity • Control</h3>
      <span class="tag">HV + Phasing</span>
    </div>
    <div class="pc grid1">
      <div class="grid2">
        <div class="row"><div class="k">Mass</div><div class="v mono" id="uiM">—</div></div>
        <div class="row"><div class="k">Fuel Left</div><div class="v mono" id="uiFuel">—</div></div>

        <div class="row"><div class="k">Throttle</div><div class="v mono" id="uiThr">—</div></div>
        <div class="row"><div class="k">T/W (toy)</div><div class="v mono" id="uiTW">—</div></div>

        <div class="row"><div class="k">HV Power</div><div class="v mono" id="uiHV">—</div></div>
        <div class="row"><div class="k">Battery</div><div class="v mono" id="uiBatt">—</div></div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">Battery State</div>
        <div class="bar good"><i id="barBatt" style="width:92%"></i></div>
        <div class="mini" id="uiBattNote">—</div>
      </div>

      <div class="row" style="display:block;">
        <div class="k" style="margin-bottom:6px;">CST Sync Health</div>
        <div class="bar"><i id="barCST" style="width:45%"></i></div>
        <div class="mini" id="uiCSTNote">—</div>
      </div>
    </div>
  </section>

  <!-- LEFT BOTTOM: Explanation -->
  <section class="panel" id="pExplain">
    <div class="ph">
      <h3>What This Proves (in the simulator)</h3>
      <span class="tag">Narrative</span>
    </div>
    <div class="pc">
      <div class="hint">
        <b>Air becomes a controllable medium:</b> HV pulses raise ionization (χ). With coupling (K),
        EM forces act on the charged flow (J×B) to reshape shocks/boundary layer (lower Cd′, reduce peak heating q̇′, improve stability).<br><br>
        <b>CST time synchronization:</b> phased pulses must stay coherent as density/temperature changes with altitude.
        Higher coherence (C) keeps the actuation aligned, preventing instability.<br><br>
        <b>Goal shown:</b> runway start → gradual climb → Mach builds toward 10 near ~100 km → stable cruise with live telemetry.
      </div>
    </div>
  </section>
</div>

<script>
/* ============================================================
   ONE SCRIPT ONLY (prevents “split parts broke the JS” errors)
============================================================ */

/* ========= Utility ========= */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const fmt=(x,d=2)=>Number.isFinite(x)?x.toFixed(d):"—";

/* ========= Canvas ========= */
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d');
function resize(){ cv.width=Math.floor(innerWidth*devicePixelRatio); cv.height=Math.floor(innerHeight*devicePixelRatio); }
addEventListener('resize',resize); resize();

/* ========= UI refs (EVERY ID EXISTS IN HTML ABOVE) ========= */
const UI={
  mode:document.getElementById('uiMode'),
  t:document.getElementById('uiT'),
  machTag:document.getElementById('uiMachTag'),

  band:document.getElementById('uiBand'),
  alt:document.getElementById('uiAlt'),
  bandNote:document.getElementById('uiBandNote'),

  v:document.getElementById('uiV'),
  mach:document.getElementById('uiMach'),
  rho:document.getElementById('uiRho'),
  q:document.getElementById('uiQ'),
  drag:document.getElementById('uiD'),
  cd:document.getElementById('uiCd'),
  heat:document.getElementById('uiHeat'),
  heat2:document.getElementById('uiHeat2'),
  temp:document.getElementById('uiTemp'),
  cool:document.getElementById('uiCool'),

  therm:document.getElementById('uiTherm'),
  plasma:document.getElementById('uiPlasma'),

  m:document.getElementById('uiM'),
  fuel:document.getElementById('uiFuel'),
  thr:document.getElementById('uiThr'),
  tw:document.getElementById('uiTW'),
  hv:document.getElementById('uiHV'),
  batt:document.getElementById('uiBatt'),
  battNote:document.getElementById('uiBattNote'),

  cst:document.getElementById('uiCST'),
  cstNote:document.getElementById('uiCSTNote'),
  stab:document.getElementById('uiStab'),
  eff:document.getElementById('uiEff'),

  barBand:document.getElementById('barBand'),
  barStab:document.getElementById('barStab'),
  barEff:document.getElementById('barEff'),
  barTherm:document.getElementById('barTherm'),
  barPlasma:document.getElementById('barPlasma'),
  barBatt:document.getElementById('barBatt'),
  barCST:document.getElementById('barCST'),

  stepTitle:document.getElementById('uiStepTitle'),
  stepDesc:document.getElementById('uiStepDesc'),
  s0:document.getElementById('s0'),
  s1:document.getElementById('s1'),
  s2:document.getElementById('s2'),
  s3:document.getElementById('s3'),
  s4:document.getElementById('s4'),
  s5:document.getElementById('s5'),
  p0:document.getElementById('p0'),
  p1:document.getElementById('p1'),
  p2:document.getElementById('p2'),
  p3:document.getElementById('p3'),
  p4:document.getElementById('p4'),
  p5:document.getElementById('p5')
};

/* ========= Inputs ========= */
const inp={
  m0:document.getElementById('m0'),
  m0n:document.getElementById('m0n'),
  fuel0:document.getElementById('fuel0'),
  fuel0n:document.getElementById('fuel0n'),
  thkN:document.getElementById('thkN'),
  thkNn:document.getElementById('thkNn'),
  cd0:document.getElementById('cd0'),
  cd0n:document.getElementById('cd0n'),
  chi:document.getElementById('chi'),
  chin:document.getElementById('chin'),
  kmhd:document.getElementById('kmhd'),
  kmhdn:document.getElementById('kmhdn'),
  csync:document.getElementById('csync'),
  csyncn:document.getElementById('csyncn'),
  duty:document.getElementById('duty'),
  dutyn:document.getElementById('dutyn')
};
function bindPair(r,n,onChange){
  r.addEventListener('input',()=>{ n.value=r.value; onChange(); });
  n.addEventListener('input',()=>{ r.value=n.value; onChange(); });
}
</script>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
/* ========= Bands + atmosphere ========= */
const bands=[
  {name:"Troposphere",a0:0,a1:12000,note:"Dense air: drag/heat spikes. Field control most valuable for shock/boundary stability."},
  {name:"Stratosphere",a0:12000,a1:50000,note:"Thinner air: Mach climbs faster, heating still significant."},
  {name:"Mesosphere",a0:50000,a1:85000,note:"Very thin air: ionization easier to sustain with HV pulsing."},
  {name:"Thermosphere",a0:85000,a1:120000,note:"Near-space: aerodynamic drag fades; plasma/EM becomes sheath control + trim."},
  {name:"Exo/Edge of Space",a0:120000,a1:220000,note:"Stable cruise: drag minimal; readings remain live."},
];
function currentBand(a){
  for(const b of bands) if(a>=b.a0 && a<b.a1) return b;
  return bands[bands.length-1];
}
function atmos(altM){
  const rho0=1.225, H=7200;
  const rho=rho0*Math.exp(-altM/H);

  let a=340;
  if(altM<11000) a=340 - 0.003*altM;
  else if(altM<20000) a=295;
  else if(altM<50000) a=295 + 0.0015*(altM-20000);
  else a=340 + 0.0005*(altM-50000);
  a=clamp(a,250,380);

  return {rho,a};
}

/* ========= “Air as Medium” ========= */
function fieldEffect(chi,kmhd,csync){
  const eff=clamp(chi*kmhd*csync,0,1);
  return {
    eff,
    cdMul:clamp(1-0.55*eff,0.35,1.0),
    heatMul:clamp(1-0.65*eff,0.25,1.0),
    stab:clamp(0.35+0.65*eff,0,1)
  };
}

/* ========= Flight schedule (slow runway → slow climb) ========= */
const EDGE=100000;           // ~100 km
const TARGET_MACH=10;

function altSchedule(t){
  const tRoll=35;    // runway roll time
  const tLift=55;    // gentle lift to 500 m
  const tClimb=720;  // climb to 100 km over ~12 min

  if(t<=tRoll) return 0;
  if(t<=tLift){
    const u=clamp((t-tRoll)/(tLift-tRoll),0,1);
    return 500*(u*u*(3-2*u));
  }
  const u=clamp((t-tLift)/tClimb,0,1);
  const s=u*u*(3-2*u);
  const aEdge=EDGE*s;

  if(u>=1){
    const u2=clamp((t-(tLift+tClimb))/360,0,1);
    return EDGE + 20000*u2; // up to 120 km
  }
  return aEdge;
}

/* ========= State ========= */
let running=false;
let t=0;
let alt=0;
let v=0;
let xMeters=0;

let m=0;
let fuel=0;
let batt=0.92;
let skinT=300;
let coolant=0.85;

let lastMs=performance.now();

let simCache={
  mach:0, rho:1.225, q:0, Cd:0.16, Duse:0,
  throttle:0, hvPower:0,
  chi:0.25, kmhd:0.35, csync:0.55, duty:0.28,
  fx:{eff:0,cdMul:1,heatMul:1,stab:0.35},
  cstHealth:0.5, plasmaProxy:0.2,
  heatRaw:0, heatReduced:0
};

function resetToInputs(){
  t=0; alt=0; v=0; xMeters=0;
  m=+inp.m0.value;
  fuel=clamp(+inp.fuel0.value,0,m*0.9);
  batt=0.92; skinT=300; coolant=0.85;
  running=false;
  UI.mode.textContent="Ready (on runway)";
  syncUI(); render();
}

/* bind sliders AFTER reset exists */
bindPair(inp.m0,inp.m0n,resetToInputs);
bindPair(inp.fuel0,inp.fuel0n,resetToInputs);
bindPair(inp.thkN,inp.thkNn,resetToInputs);
bindPair(inp.cd0,inp.cd0n,resetToInputs);
bindPair(inp.chi,inp.chin,()=>{});
bindPair(inp.kmhd,inp.kmhdn,()=>{});
bindPair(inp.csync,inp.csyncn,()=>{});
bindPair(inp.duty,inp.dutyn,()=>{});

resetToInputs();

/* Buttons */
document.getElementById('btnStart').addEventListener('click',()=>{ running=true; lastMs=performance.now(); });
document.getElementById('btnStop').addEventListener('click',()=>{ running=false; });
document.getElementById('btnReset').addEventListener('click',()=>{ resetToInputs(); });

/* ========= Stage logic for the middle panel ========= */
function stageLogic(){
  const q=simCache.q||0;
  const qMax=52000; // Pa (toy)
  const nearMaxQ = (q > 0.75*qMax && alt < 45000);

  let idx=0, title="0) Airfield Takeoff Roll", desc="Accelerate along runway. Speed rises from 0. Rotate at takeoff speed.";
  if(t < 35){
    idx=0; title="0) Airfield Takeoff Roll";
    desc="Runway acceleration. Panels are live. Field control is light but stabilizes early boundary layer/inlet.";
  } else if(alt < 2500){
    idx=1; title="1) Rotation + Initial Climb";
    desc="Lift-off and climb-out. Drag/heat rise. CST coherence keeps pulse timing aligned while air changes fast.";
  } else if(alt < 18000 && !nearMaxQ){
    idx=2; title="2) Dense-Air Accel (drag/heat control)";
    desc="Thick air = heavy drag/heating. χ×K×C reduces Cd′ and heat, and increases stability margin.";
  } else if(nearMaxQ){
    idx=3; title="3) Max-Q Management + Climb";
    desc="Dynamic pressure peaks. Controller manages q̄ while continuing climb and acceleration without instability.";
  } else if(alt < EDGE){
    idx=4; title="4) High-Altitude Mach Push";
    desc="Air thins, drag drops. Mach climbs strongly toward 10 while heating reduces; plasma layer control becomes cleaner.";
  } else {
    idx=5; title="5) Edge-of-Space Stable Cruise";
    desc="Near ~100 km+, drag becomes tiny. Controller holds near Mach 10 cruise while all telemetry stays live.";
  }
  return {idx,title,desc,qMax};
}
function highlightStage(idx){
  const steps=[UI.s0,UI.s1,UI.s2,UI.s3,UI.s4,UI.s5];
  steps.forEach((el,i)=>el.classList.toggle('active', i===idx));
}
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
/* ========= Update physics (RUNWAY→MACH10→CRUISE) ========= */
function update(dt){
  if(!running) return;

  t += dt;

  // read knobs
  const chi=clamp(+inp.chi.value,0,1);
  const kmhd=clamp(+inp.kmhd.value,0,1);
  const csync=clamp(+inp.csync.value,0,1);
  const duty=clamp(+inp.duty.value,0,1);

  // altitude target + smooth approach
  const altTarget=altSchedule(t);
  alt = lerp(alt, altTarget, clamp(0.75*dt*2.0,0,1));

  const at=atmos(alt);
  const rho=at.rho, a=at.a;
  const fx=fieldEffect(chi,kmhd,csync);

  const Cd0=+inp.cd0.value;
  const Cd=Cd0*fx.cdMul;
  const Aref=7.5;
  const q=0.5*rho*v*v;
  const D=q*Cd*Aref;

  const thrustMax=(+inp.thkN.value)*1000;

  // Controller: build speed from 0, then hold near Mach 10 in cruise.
  let throttle=0;

  const mach = (a>0)?(v/a):0;

  if(t < 35){
    // runway: smooth ramp to takeoff
    throttle = clamp(0.35 + 0.015*t, 0.35, 0.92);
  } else if(alt < EDGE){
    // climb: manage q + push mach
    const qTarget=48000; // Pa
    const qErr=(qTarget - q)/qTarget;
    throttle = clamp(0.55 + 0.45*qErr, 0.25, 1.0);

    const mErr=(TARGET_MACH - mach)/TARGET_MACH;
    throttle = clamp(throttle + 0.22*mErr, 0.25, 1.0);
  } else {
    // cruise: hold near Mach 10
    const mErr=(TARGET_MACH - mach)/TARGET_MACH;
    throttle = clamp(0.16 + 0.55*mErr, 0.08, 0.45);
  }

  // fuel usage
  const Isp = (alt<30000)?320 : (alt<EDGE?540:820);
  const g0=9.80665;
  const mdot=(throttle*thrustMax)/(Isp*g0);
  const fuelUse=Math.min(fuel, mdot*dt);
  fuel -= fuelUse;
  m = clamp(m - fuelUse, 5000, 1e12);
  if(fuel<=0) throttle = (alt>=EDGE)?0.08:0.0;

  // HV power + battery drain
  const hvBase=0.8e6;
  const hvPower = hvBase*duty*(0.55+0.8*chi)*(0.8+0.6*kmhd)*(1.0+(1-csync)*0.9);
  batt = clamp(batt - (hvPower/4.5e6)*dt, 0, 1);

  // heating + coolant
  const heatRaw = (rho*Math.pow(Math.max(v,1),3))*2.2e-7;
  const heatReduced = heatRaw*fx.heatMul;
  const coolEff = clamp(coolant*(0.55+0.55*csync),0,1);
  skinT = clamp(skinT + (heatReduced*1.5 - coolEff*18)*dt, 220, 2400);
  coolant = clamp(coolant - (heatReduced*0.003)*dt + 0.006*dt, 0, 1);

  // longitudinal acceleration
  let Duse=D;
  if(alt>=EDGE) Duse *= 0.02; // thin air
  const thrust=throttle*thrustMax;
  const aLong=(thrust - Duse)/Math.max(m,1);

  const vMin = (t<35)?0:80;
  v = clamp(v + aLong*dt, vMin, 3800);
  xMeters += v*dt;

  // CST/Plasma proxies
  const plasmaStab = clamp(0.6 + 0.4*chi - 0.25*(skinT-900)/900, 0, 1);
  const cstHealth = clamp(csync*(0.4+0.6*batt)*plasmaStab, 0, 1);
  const plasmaProxy = clamp(0.25 + 0.75*chi*(0.6+0.4*duty), 0, 1);

  simCache = {mach:(v/a), rho, q, Cd, Duse, throttle, hvPower, chi, kmhd, csync, duty, fx, cstHealth, plasmaProxy, heatRaw, heatReduced};
}

/* ========= UI sync (ALWAYS updates, running or not) ========= */
function syncUI(){
  const band=currentBand(alt);
  const st=stageLogic();

  // Mode
  if(!running) UI.mode.textContent = (t===0 ? "Ready (on runway)" : "Stopped");
  else UI.mode.textContent =
    (st.idx===0 ? "Takeoff Roll (airfield)" :
     st.idx===1 ? "Rotation + Initial Climb" :
     st.idx===5 ? "Edge of Space → Stable Cruise" :
     "Ascent + Field Management");

  // Time + Mach tag
  UI.t.textContent = `${fmt(t,1)} s`;
  UI.machTag.textContent = `Mach ${fmt(simCache.mach,2)}`;

  // Band panel
  UI.band.textContent = band.name;
  UI.alt.textContent = `${fmt(alt,0)} m`;
  UI.bandNote.textContent = band.note;

  // Live data
  UI.v.textContent = `${fmt(v,0)} m/s`;
  UI.mach.textContent = fmt(simCache.mach,2);
  UI.rho.textContent = `${fmt(simCache.rho,4)} kg/m³`;
  UI.q.textContent = `${fmt((simCache.q||0)/1000,1)} kPa`;

  UI.drag.textContent = `${fmt((simCache.Duse||0)/1000,1)} kN`;
  UI.cd.textContent = fmt(simCache.Cd,3);

  UI.heat.textContent = `${fmt(simCache.heatRaw,3)} (toy)`;
  UI.heat2.textContent = `${fmt(simCache.heatReduced,3)} (toy)`;
  UI.temp.textContent = `${fmt(skinT,0)} K`;
  UI.cool.textContent = `${fmt(coolant*100,0)}%`;

  UI.m.textContent = `${fmt(m,0)} kg`;
  UI.fuel.textContent = `${fmt(fuel,0)} kg`;
  UI.thr.textContent = `${fmt((simCache.throttle||0)*100,0)}%`;
  UI.tw.textContent = fmt(((simCache.throttle||0) * (+inp.thkN.value*1000)) / (m*9.80665), 2);

  UI.hv.textContent = `${fmt((simCache.hvPower||0)/1e6,2)} MW`;
  UI.batt.textContent = `${fmt(batt*100,0)}%`;

  UI.cst.textContent = fmt(simCache.cstHealth,2);
  UI.cstNote.textContent = "CST health = csync × battery × plasma stability (toy)";

  // Bars
  const bandProg = clamp((alt - band.a0)/(band.a1-band.a0), 0, 1);
  UI.barBand.style.width = `${bandProg*100}%`;

  UI.barStab.style.width = `${(simCache.fx?.stab||0)*100}%`;
  UI.stab.textContent = `Margin ${fmt((simCache.fx?.stab||0)*100,0)}% (higher = steadier inlet/shock control)`;

  UI.barEff.style.width = `${(simCache.fx?.eff||0)*100}%`;
  UI.eff.textContent = `Effect = χ×K×C = ${fmt((simCache.fx?.eff||0),2)} → Cd and heat reduced`;

  const thermMargin = clamp(1 - (skinT-900)/900, 0, 1);
  UI.barTherm.style.width = `${thermMargin*100}%`;
  UI.therm.textContent = `Thermal margin ${fmt(thermMargin*100,0)}% (target keep > 25%)`;

  UI.barPlasma.style.width = `${(simCache.plasmaProxy||0)*100}%`;
  UI.plasma.textContent = `Plasma proxy ${fmt((simCache.plasmaProxy||0)*100,0)}% (ion layer controllability)`;

  UI.barBatt.style.width = `${batt*100}%`;
  UI.battNote.textContent = (batt>0.2) ? "Battery supports HV pulsing + phased control." : "Low battery: field control weakens.";

  UI.barCST.style.width = `${(simCache.cstHealth||0)*100}%`;

  // Middle stage panel
  UI.stepTitle.textContent = `Stage: ${st.title}`;
  UI.stepDesc.textContent = st.desc;
  highlightStage(st.idx);

  // pills
  UI.p0.textContent = (t<35) ? "ACTIVE" : "DONE";
  UI.p1.textContent = (t>=35 && alt<2500) ? "ACTIVE" : (alt>=2500 ? "DONE" : "—");
  UI.p2.textContent = (alt>=2500 && alt<18000) ? "ACTIVE" : (alt>=18000 ? "DONE" : "—");
  UI.p3.textContent = ((simCache.q||0) > 0.75*st.qMax && alt<45000) ? "ACTIVE" : (alt>=45000 ? "DONE" : "—");
  UI.p4.textContent = (alt>=18000 && alt<EDGE) ? "ACTIVE" : (alt>=EDGE ? "DONE" : "—");
  UI.p5.textContent = (alt>=EDGE) ? "ACTIVE" : "—";
}

/* ========= Drawing ========= */
function drawRoundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
function drawAircraft(cx, cy, scale, glow, pitch){
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(pitch);
  ctx.scale(scale, scale);

  if(glow>0){
    ctx.shadowColor = `rgba(96,165,250,${0.55*glow})`;
    ctx.shadowBlur = 24*glow;
  }

  ctx.lineWidth = 2/scale;
  ctx.strokeStyle = 'rgba(226,232,240,.92)';
  ctx.fillStyle = 'rgba(15,23,42,.70)';

  // fuselage
  ctx.beginPath();
  ctx.moveTo(-42, 0);
  ctx.quadraticCurveTo(-10, -8, 22, -6);
  ctx.quadraticCurveTo(48, -4, 60, 0);
  ctx.quadraticCurveTo(48, 4, 22, 6);
  ctx.quadraticCurveTo(-10, 8, -42, 0);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // wings
  ctx.beginPath();
  ctx.moveTo(-6, -2);
  ctx.lineTo(14, -22);
  ctx.lineTo(24, -22);
  ctx.lineTo(8, -2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-6, 2);
  ctx.lineTo(14, 22);
  ctx.lineTo(24, 22);
  ctx.lineTo(8, 2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // tail
  ctx.beginPath();
  ctx.moveTo(-24, -1);
  ctx.lineTo(-36, -14);
  ctx.lineTo(-28, -14);
  ctx.lineTo(-14, -2);
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // nose line
  ctx.beginPath();
  ctx.moveTo(60, 0);
  ctx.lineTo(70, 0);
  ctx.stroke();

  ctx.restore();
}
function drawBands(vp){
  const {x,y,w,h}=vp;

  // sky gradient
  const g=ctx.createLinearGradient(0,y+h,0,y);
  g.addColorStop(0,'rgba(2,6,23,1)');
  g.addColorStop(0.28,'rgba(3,10,26,1)');
  g.addColorStop(0.62,'rgba(6,16,44,1)');
  g.addColorStop(1,'rgba(0,0,0,1)');
  ctx.fillStyle=g; ctx.fillRect(x,y,w,h);

  // stars
  ctx.globalAlpha=0.45;
  for(let i=0;i<170;i++){
    const sx = (Math.sin(i*999.1 + t*0.03)*0.5+0.5)*w + x;
    const sy = (Math.sin(i*333.7 + i*0.17)*0.5+0.5)*h + y;
    const r = (i%7===0)?2:1;
    ctx.fillStyle='rgba(226,232,240,.95)';
    ctx.fillRect(sx,sy,r,r);
  }
  ctx.globalAlpha=1;

  // ground + runway
  const groundY=y+h*0.90;
  ctx.fillStyle='rgba(2,6,23,.95)';
  ctx.fillRect(x, groundY, w, y+h-groundY);

  ctx.fillStyle='rgba(10,18,40,.85)';
  ctx.fillRect(x+20*devicePixelRatio, groundY-16*devicePixelRatio, w-40*devicePixelRatio, 22*devicePixelRatio);

  ctx.strokeStyle='rgba(226,232,240,.55)';
  ctx.lineWidth=2;
  ctx.setLineDash([18*devicePixelRatio, 14*devicePixelRatio]);
  ctx.beginPath();
  ctx.moveTo(x+40*devicePixelRatio, groundY-5*devicePixelRatio);
  ctx.lineTo(x+w-40*devicePixelRatio, groundY-5*devicePixelRatio);
  ctx.stroke();
  ctx.setLineDash([]);

  // horizon
  const horizonY=y+h*0.74;
  ctx.strokeStyle='rgba(96,165,250,.55)';
  ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let i=0;i<=70;i++){
    const px = x + (i/70)*w;
    const dx = (i/70 - 0.5);
    const py = horizonY + dx*dx*(h*0.20);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();

  // altitude lines (high contrast)
  function bandLine(altM){
    const u=clamp(altM/120000,0,1);
    return horizonY - u*(h*0.58);
  }
  const lines=[
    {a:0, label:'Runway', alpha:.55},
    {a:12000, label:'Troposphere', alpha:.62},
    {a:50000, label:'Stratosphere', alpha:.56},
    {a:85000, label:'Mesosphere', alpha:.52},
    {a:100000, label:'Edge ~100 km', alpha:.70},
    {a:120000, label:'Thermosphere', alpha:.42}
  ];
  ctx.font=`${13*devicePixelRatio}px ui-monospace, Menlo, Consolas, monospace`;
  for(const L of lines){
    const py = (L.a===0) ? (groundY-18*devicePixelRatio) : bandLine(L.a);
    ctx.strokeStyle=`rgba(226,232,240,${L.alpha})`;
    ctx.lineWidth = (L.a===100000)?2.8:2.1;
    ctx.beginPath();
    ctx.moveTo(x+14*devicePixelRatio,py);
    ctx.lineTo(x+w-14*devicePixelRatio,py);
    ctx.stroke();

    ctx.fillStyle=`rgba(226,232,240,${Math.min(0.95, L.alpha+0.25)})`;
    const km=(L.a/1000).toFixed(0);
    const label=(L.a===0)?` ${L.label}`:` ${L.label} (${km} km)`;
    ctx.fillText(label, x+18*devicePixelRatio, py-7*devicePixelRatio);
  }
}
function render(){
  const W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);

  const pad=10*devicePixelRatio;
  const colL=360*devicePixelRatio + pad*2;
  const colR=380*devicePixelRatio + pad*2;
  const vp={ x:colL, y:pad, w:W-colL-colR, h:H-pad*2 };

  drawBands(vp);

  const groundY=vp.y+vp.h*0.90;
  const horizonY=vp.y+vp.h*0.74;

  const uAlt=clamp(alt/120000,0,1);
  let yCraft = lerp(groundY-22*devicePixelRatio, horizonY, clamp(alt/1200,0,1));
  yCraft = lerp(yCraft, horizonY - uAlt*(vp.h*0.58), clamp(uAlt,0,1));

  const pxPerMeter=0.020*devicePixelRatio;
  const xScroll=(xMeters*pxPerMeter)%(vp.w*0.86);
  const xCraft=vp.x + vp.w*0.07 + xScroll;

  const glow=clamp((simCache.plasmaProxy||0)*(0.55+0.45*(simCache.cstHealth||0)),0,1);
  const pitch = (t<35)?0:clamp(alt/6000,0,1)*(-0.10);

  // plasma ring
  ctx.save();
  ctx.globalAlpha=0.88;
  ctx.strokeStyle=`rgba(96,165,250,${0.22+0.60*glow})`;
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.ellipse(xCraft, yCraft, 44*devicePixelRatio, 18*devicePixelRatio, pitch, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();

  drawAircraft(xCraft, yCraft, devicePixelRatio*1.18, glow, pitch);

  // overlay box
  ctx.save();
  ctx.fillStyle='rgba(2,6,23,.60)';
  drawRoundedRect(vp.x+14, vp.y+14, 460*devicePixelRatio, 114*devicePixelRatio, 14*devicePixelRatio);
  ctx.fill();
  ctx.strokeStyle='rgba(120,170,255,.28)'; ctx.lineWidth=1; ctx.stroke();

  ctx.fillStyle='rgba(226,232,240,.94)';
  ctx.font = `${12*devicePixelRatio}px ui-monospace, Menlo, Consolas, monospace`;
  ctx.fillText(`ALT ${Math.round(alt/1000)} km   V ${Math.round(v)} m/s   Mach ${fmt(simCache.mach,2)}`, vp.x+26*devicePixelRatio, vp.y+40*devicePixelRatio);
  ctx.fillText(`q̄ ${(simCache.q/1000).toFixed(1)} kPa   ρ ${fmt(simCache.rho,4)}   Cd′ ${fmt(simCache.Cd,3)}`, vp.x+26*devicePixelRatio, vp.y+62*devicePixelRatio);
  ctx.fillText(`χ ${fmt(simCache.chi,2)} K ${fmt(simCache.kmhd,2)} C ${fmt(simCache.csync,2)} duty ${fmt(simCache.duty,2)} CST ${fmt(simCache.cstHealth,2)}`, vp.x+26*devicePixelRatio, vp.y+84*devicePixelRatio);
  ctx.fillText(`Heat×${fmt(simCache.fx?.heatMul||1,2)}  Stab ${fmt(simCache.fx?.stab||0,2)}  Batt ${Math.round(batt*100)}%`, vp.x+26*devicePixelRatio, vp.y+106*devicePixelRatio);
  ctx.restore();
}

/* ========= Loop ========= */
function loop(){
  const now=performance.now();
  const dt=clamp((now-lastMs)/1000, 0, 0.05);
  lastMs=now;

  update(dt);
  syncUI();
  render();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// initial draw (live labels even before START)
syncUI();
render();
</script>
</body>
</html>
