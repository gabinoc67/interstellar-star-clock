<!-- ======================= PART 1 / 3 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live RSS Keyword Monitor (Simple + Working)</title>

<style>
:root{
  --bg:#070b14; --panel:#0f172a; --ink:#e5e7eb; --muted:#9aa4c7;
  --accent:#60a5fa; --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
  --line:rgba(148,163,184,.25); --radius:16px; --mono: ui-monospace, Consolas, monospace;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:20px auto;padding:14px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:14px}
h1{margin:0 0 8px;font-size:22px}
h3{margin:0 0 10px;font-size:14px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,textarea,select,button{background:#020617;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
textarea{min-height:130px;width:100%;font-family:var(--mono)}
button{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#020617;font-weight:900;cursor:pointer;border:0}
button.secondary{background:#111827;color:var(--ink);border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
th{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.12em}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.small{font-size:12px;color:var(--muted);line-height:1.5}
.mono{font-family:var(--mono)}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);margin-right:8px;margin-top:8px}
.pill b{color:var(--ink)}
.good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.log{background:rgba(2,6,23,.4);border:1px solid var(--line);border-radius:12px;padding:10px;max-height:220px;overflow:auto;white-space:pre-wrap;font-family:var(--mono);font-size:12px;color:var(--muted)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="wrap">
  <h1>Live RSS Keyword Monitor <span class="small">(buttons + matching made obvious)</span></h1>

  <div class="card">
    <div class="row">
      <input id="query" placeholder="Example: Minnesota groups protest" style="flex:1;min-width:280px"/>
      <select id="mode">
        <option value="proxy" selected>Proxy (recommended)</option>
        <option value="direct">Direct (often blocked)</option>
      </select>

      <label class="small"><input id="strictAll" type="checkbox" checked/> Require ALL words</label>
      <label class="small"><input id="smartMatch" type="checkbox" checked/> Smart match (plural/suffix)</label>
      <label class="small"><input id="showNear" type="checkbox" checked/> Show near matches</label>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnStart">Start</button>
      <button id="btnRunOnce" class="secondary">Run Once</button>
      <button id="btnPause" class="secondary">Pause</button>
      <button id="btnStop" class="secondary">Stop</button>
      <button id="btnReset" class="secondary">Reset</button>
      <span class="pill">Clicks: <b id="kClicks">0</b></span>
      <span class="pill">Feeds: <b id="kFeeds">0</b></span>
      <span class="pill">Fetched: <b id="kFetched">0</b></span>
      <span class="pill">Matched: <b id="kMatched">0</b></span>
      <span class="pill">Near: <b id="kNear">0</b></span>
      <span class="pill">Errors: <b id="kErrors">0</b></span>
      <span class="pill">Last Run: <b id="kLast">—</b></span>
    </div>

    <div class="small" style="margin-top:10px">
      If you get <b>Fetched &gt; 0</b> but <b>Matched = 0</b>, that means the feeds did not contain your words.
      The <b>Near Matches</b> panel will prove the monitor is alive by showing partial hits (1–2 words).
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h3>Feeds (one per line)</h3>
      <textarea id="feeds"></textarea>
      <div class="small">Use Proxy mode if Direct returns 0 fetched. The log will show which feeds fail.</div>
    </div>

    <div class="card">
      <h3>Feed Health / Debug Log</h3>
      <div id="log" class="log">Idle.</div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h3>Matched Articles (ALL words)</h3>
      <table>
        <thead><tr><th>Status</th><th>Article</th><th>Source</th><th>Hits</th></tr></thead>
        <tbody id="results"><tr><td colspan="4" class="small">Waiting…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Near Matches (partial hits)</h3>
      <table>
        <thead><tr><th>Hits</th><th>Article</th><th>Source</th></tr></thead>
        <tbody id="near"><tr><td colspan="3" class="small">Waiting…</td></tr></tbody>
      </table>
    </div>
  </div>
<!-- ======================= PART 2 / 3 ======================= -->
<script>
/* Defaults include Minnesota-relevant sources + broad baseline sources */
const DEFAULT_FEEDS = [
  "https://feeds.publicradio.org/public_feeds/mpr-news-update",
  "http://www.startribune.com/rss-index/112994779/",
  "https://feeds.bbci.co.uk/news/world/rss.xml",
  "https://feeds.npr.org/1004/rss.xml",
  "https://www.nasa.gov/rss/dyn/breaking_news.rss",
  "https://www.usgs.gov/feeds/earthquakes/feed",
  "https://www.noaa.gov/rss.xml"
].join("\n");

let timer=null;
let paused=false;
let cycleNo=0;
let clickCount=0;

const $ = id => document.getElementById(id);
const norm = s => (s||"").toLowerCase();

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}
function setKpi(id, v){ $(id).textContent = String(v); }
function logReset(lines){ $("log").textContent = lines.join("\n"); }
function logLine(line){ $("log").textContent = ($("log").textContent.trim()? $("log").textContent+"\n":"") + line; }

function hostFromUrl(u){
  try{ return new URL(u).hostname.replace(/^www\./,""); }catch{ return ""; }
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function parseWords(q){
  return norm(q).split(/\s+/).map(x=>x.trim()).filter(Boolean);
}

/* Smart variants: protest -> protests, protesting, protested */
function variants(word){
  const w = word.trim().toLowerCase();
  if(!w) return [];
  const set = new Set([w]);

  // simple plural/tense
  set.add(w+"s");
  set.add(w+"es");
  set.add(w+"ed");
  set.add(w+"ing");

  // if ends with 's' already, include singular-ish
  if(w.endsWith("s") && w.length>3) set.add(w.slice(0,-1));

  // allow prefix match for long words (e.g., "protest" matches "protests")
  // represented by a special token "prefix:protest"
  if(w.length>=5) set.add("prefix:"+w);

  return [...set];
}

function itemBlob(it){
  return norm([it.title,it.desc,it.source,it.link].join(" "));
}

function hitWord(blob, token){
  if(token.startsWith("prefix:")){
    const p = token.slice(7);
    return blob.includes(p); // cheap but effective for plural/suffix cases
  }
  return blob.includes(token);
}

function hitsForItem(it, words){
  const blob = itemBlob(it);
  const smart = $("smartMatch").checked;

  const hits = [];
  for(const w of words){
    if(!smart){
      if(blob.includes(w)) hits.push(w);
      continue;
    }
    const vars = variants(w);
    if(vars.some(v => hitWord(blob, v))){
      hits.push(w);
    }
  }
  return hits;
}

async function fetchText(url){
  const mode = $("mode").value;
  if(mode==="direct"){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.text();
  }
  const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const r = await fetch(proxy, {cache:"no-store"});
  if(!r.ok) throw new Error("Proxy HTTP "+r.status);
  return await r.text();
}

function parseFeed(xmlText, fallbackSource){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  if(doc.querySelector("parsererror")) throw new Error("Invalid XML (not RSS/Atom).");

  const channelTitle =
    doc.querySelector("channel>title")?.textContent?.trim()
    || doc.querySelector("feed>title")?.textContent?.trim()
    || fallbackSource
    || "unknown";

  const rss = [...doc.querySelectorAll("item")].map(it=>({
    title: it.querySelector("title")?.textContent?.trim() || "",
    link:  it.querySelector("link")?.textContent?.trim() || "",
    desc:  it.querySelector("description")?.textContent?.trim() || "",
    source: channelTitle
  }));

  const atom = [...doc.querySelectorAll("entry")].map(en=>{
    const linkEl = en.querySelector("link[rel='alternate']") || en.querySelector("link") || null;
    const href = linkEl?.getAttribute("href") || linkEl?.textContent || "";
    return {
      title: en.querySelector("title")?.textContent?.trim() || "",
      link:  (href||"").trim(),
      desc:  en.querySelector("summary")?.textContent?.trim()
          || en.querySelector("content")?.textContent?.trim()
          || "",
      source: channelTitle
    };
  });

  return [...rss, ...atom].filter(x => x.title || x.link);
}

function renderMatches(rows){
  const tb = $("results");
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="4">No matches. (Check Near Matches to confirm it’s alive.)</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>{
    const host = hostFromUrl(r.link) || hostFromUrl(r.feed) || "unknown";
    const hits = r.hits.join(", ");
    return `
      <tr>
        <td class="good">OK</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title||"(untitled)")}</a></td>
        <td>${escapeHtml(host)} <span class="small">(${escapeHtml(r.source)})</span></td>
        <td class="mono">${escapeHtml(hits)}</td>
      </tr>
    `;
  }).join("");
}

function renderNear(rows){
  const tb = $("near");
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="3">No near matches found.</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>{
    const host = hostFromUrl(r.link) || hostFromUrl(r.feed) || "unknown";
    return `
      <tr>
        <td class="mono">${r.hits.length}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title||"(untitled)")}</a></td>
        <td>${escapeHtml(host)}</td>
      </tr>
    `;
  }).join("");
}
</script>
<!-- ======================= PART 3 / 3 ======================= -->
<script>
async function runCycle(){
  if(paused) return;
  cycleNo++;

  const words = parseWords($("query").value);
  const strictAll = $("strictAll").checked;
  const showNear = $("showNear").checked;

  const feeds = $("feeds").value.split("\n").map(x=>x.trim()).filter(Boolean);
  setKpi("kFeeds", feeds.length);
  setKpi("kLast", nowTime());

  if(!words.length){
    logReset([`Cycle ${cycleNo} @ ${nowTime()}`, "Type keywords first. Example: Minnesota groups protest"]);
    setKpi("kFetched", 0); setKpi("kMatched", 0); setKpi("kNear", 0); setKpi("kErrors", 0);
    renderMatches([]); renderNear([]);
    return;
  }

  let fetched=0, errors=0;
  const matched=[], near=[];

  logReset([`Cycle ${cycleNo} @ ${nowTime()}`, `Mode: ${$("mode").value}`, `Words: [${words.join(", ")}]  StrictAll=${strictAll}  SmartMatch=${$("smartMatch").checked}`, "---"]);

  for(const feed of feeds){
    const label = hostFromUrl(feed) || feed;
    try{
      const xml = await fetchText(feed);
      const items = parseFeed(xml, label);
      fetched += items.length;

      let localMatch=0, localNear=0;

      for(const it of items){
        const hits = hitsForItem({...it, feed}, words);

        if(strictAll){
          if(hits.length === words.length){
            matched.push({...it, feed, hits});
            localMatch++;
          }else if(showNear && hits.length>0){
            near.push({...it, feed, hits});
            localNear++;
          }
        }else{
          if(hits.length>0){
            matched.push({...it, feed, hits});
            localMatch++;
          }
        }
      }

      logLine(`OK   ${label}  items=${items.length}  match=${localMatch}${showNear?`  near=${localNear}`:""}`);
    }catch(e){
      errors++;
      logLine(`FAIL ${label}  (${e.message || e})`);
    }
  }

  // Sort matched by hits then title length
  matched.sort((a,b)=> (b.hits.length-a.hits.length) || ((b.title||"").length-(a.title||"").length));
  near.sort((a,b)=> (b.hits.length-a.hits.length) || ((b.title||"").length-(a.title||"").length));

  setKpi("kFetched", fetched);
  setKpi("kMatched", matched.length);
  setKpi("kNear", near.length);
  setKpi("kErrors", errors);

  renderMatches(matched.slice(0,60));
  renderNear(showNear ? near.slice(0,60) : []);
}

function clickMark(){
  clickCount++;
  setKpi("kClicks", clickCount);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("feeds").value = DEFAULT_FEEDS;
  setKpi("kFeeds", DEFAULT_FEEDS.split("\n").filter(Boolean).length);
  logReset(["Idle. Choose Proxy mode and click Start."]);

  $("btnStart").addEventListener("click", ()=>{
    clickMark();
    if(timer) { logLine("Start ignored (already running)."); return; }
    paused=false;
    runCycle();
    timer=setInterval(runCycle, 15000);
    logLine("---");
    logLine("Started (every 15s).");
  });

  $("btnRunOnce").addEventListener("click", ()=>{
    clickMark();
    paused=false;
    runCycle();
    logLine("Run once complete.");
  });

  $("btnPause").addEventListener("click", ()=>{
    clickMark();
    paused=!paused;
    logLine(paused ? "Paused." : "Resumed.");
  });

  $("btnStop").addEventListener("click", ()=>{
    clickMark();
    clearInterval(timer);
    timer=null;
    paused=false;
    logLine("Stopped.");
  });

  $("btnReset").addEventListener("click", ()=>{
    clickMark();
    clearInterval(timer);
    timer=null;
    paused=false;
    cycleNo=0;

    $("query").value="";
    $("mode").value="proxy";
    $("strictAll").checked=true;
    $("smartMatch").checked=true;
    $("showNear").checked=true;

    $("feeds").value=DEFAULT_FEEDS;
    $("results").innerHTML = `<tr><td colspan="4">Reset complete.</td></tr>`;
    $("near").innerHTML = `<tr><td colspan="3">Reset complete.</td></tr>`;
    setKpi("kFetched",0); setKpi("kMatched",0); setKpi("kNear",0); setKpi("kErrors",0);
    setKpi("kLast","—");
    logReset(["Reset complete. Click Start."]);
  });
});
</script>

</body>
</html>
