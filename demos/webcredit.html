<!-- ======================= PART 1 / 3 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>5-Minute Facts RSS Monitor (Persistent + CSV/Print)</title>

<style>
:root{
  --bg:#070b14; --panel:#0f172a; --ink:#e5e7eb; --muted:#9aa4c7;
  --accent:#60a5fa; --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
  --line:rgba(148,163,184,.25); --radius:16px; --mono: ui-monospace, Consolas, monospace;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:20px auto;padding:14px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:14px}
h1{margin:0 0 8px;font-size:22px}
h3{margin:0 0 10px;font-size:14px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,textarea,select,button{background:#020617;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
textarea{min-height:140px;width:100%;font-family:var(--mono)}
button{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#020617;font-weight:900;cursor:pointer;border:0}
button.secondary{background:#111827;color:var(--ink);border:1px solid var(--line)}
button.danger{background:#3b0f18;color:#ffd7df;border:1px solid rgba(251,113,133,.45)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
th{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.12em}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.small{font-size:12px;color:var(--muted);line-height:1.5}
.mono{font-family:var(--mono)}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);margin-right:8px;margin-top:8px}
.pill b{color:var(--ink)}
.good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:11px;margin-right:6px;color:var(--muted)}
.log{background:rgba(2,6,23,.4);border:1px solid var(--line);border-radius:12px;padding:10px;max-height:220px;overflow:auto;white-space:pre-wrap;font-family:var(--mono);font-size:12px;color:var(--muted)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="wrap">
  <h1>5-Minute Facts RSS Monitor <span class="small">(persistent results + CSV/Print)</span></h1>

  <div class="card">
    <div class="row">
      <input id="query" placeholder="Example: Minnesota groups protest" style="flex:1;min-width:280px"/>
      <label class="small"><input id="strictAll" type="checkbox" checked/> Require ALL words</label>
      <label class="small"><input id="smartMatch" type="checkbox" checked/> Smart match (plural/suffix)</label>
      <label class="small">Min Trust:
        <input id="minTrust" type="number" min="0" max="100" value="70" style="width:84px"/>
      </label>
      <label class="small">Run time:
        <select id="runMins">
          <option value="1">1 min</option>
          <option value="3">3 min</option>
          <option value="5" selected>5 min</option>
          <option value="10">10 min</option>
        </select>
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnStart">Start (5 min)</button>
      <button id="btnStop" class="secondary">Stop</button>
      <button id="btnReset" class="secondary">Reset</button>
      <button id="btnCSV" class="secondary">Download CSV</button>
      <button id="btnPrint" class="secondary">Print</button>
      <button id="btnClearSaved" class="danger">Clear Saved Results</button>

      <span class="pill">Status: <b id="kStatus">Idle</b></span>
      <span class="pill">Time left: <b id="kLeft">—</b></span>
      <span class="pill">Fetched: <b id="kFetched">0</b></span>
      <span class="pill">Matched: <b id="kMatched">0</b></span>
      <span class="pill">Errors: <b id="kErrors">0</b></span>
    </div>

    <div class="small" style="margin-top:10px">
      Results are <b>saved</b>. If you refresh or go back, they will still be here.
      This tool labels source trust (High/Medium/Unknown) and flags “low quality” patterns,
      but it cannot mathematically “prove truth” in a browser.
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h3>Feeds (one per line)</h3>
      <textarea id="feeds"></textarea>
      <div class="small">
        If you only see one website (like mprnews.org), it’s because your other feeds are failing or not real RSS/Atom endpoints.
        Check the log to see which fail.
      </div>
    </div>

    <div class="card">
      <h3>Feed Health / Debug Log</h3>
      <div id="log" class="log">Idle.</div>
    </div>
  </div>

  <div class="card">
    <h3>Matched Articles (persisted)</h3>
    <table>
      <thead>
        <tr>
          <th>Trust</th>
          <th>Quality</th>
          <th>Article</th>
          <th>Source</th>
          <th>Matched</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="results">
        <tr><td colspan="6" class="small">Waiting…</td></tr>
      </tbody>
    </table>
  </div>
<!-- ======================= PART 2 / 3 ======================= -->
<script>
/* ========= Defaults =========
   You can edit this list anytime.
   Note: Many TV networks do NOT expose clean RSS for every section, so some URLs may fail.
*/
const DEFAULT_FEEDS = [
  // Local / Minnesota (works often)
  "https://feeds.publicradio.org/public_feeds/mpr-news-update",

  // National / general (commonly works)
  "http://feeds.nbcnews.com/feeds/topstories",
  "http://rss.cnn.com/rss/cnn_topstories.rss",
  "http://www.cbsnews.com/latest/rss/main",
  "https://feeds.texastribune.org/feeds/main/",
  "https://feeds.bbci.co.uk/news/world/rss.xml",
  "https://feeds.npr.org/1004/rss.xml"
].join("\n");

/* ========= Trust map (domain-based) ========= */
const TRUST = {
  "mprnews.org":80,
  "publicradio.org":80,

  "nbcnews.com":80,
  "feeds.nbcnews.com":80,

  "cnn.com":75,
  "rss.cnn.com":75,

  "cbsnews.com":75,

  "texastribune.org":75,
  "feeds.texastribune.org":75,

  "bbc.co.uk":85,
  "npr.org":85,
  "feeds.npr.org":85
};

const STORE_KEY = "facts_rss_saved_v1";

let timer = null;
let stopTimer = null;
let paused = false;

let fetchedTotal = 0;
let errorTotal = 0;

// persisted results (unique by link)
let saved = loadSaved(); // { items: [...], byLink: {link:true} }

const $ = id => document.getElementById(id);
const norm = s => (s||"").toLowerCase();

function nowStamp(){
  const d = new Date();
  return d.toLocaleString();
}
function hostFromUrl(u){
  try{ return new URL(u).hostname.replace(/^www\./,""); }catch{ return ""; }
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function logReset(lines){ $("log").textContent = lines.join("\n"); }
function logLine(line){ $("log").textContent = ($("log").textContent.trim()? $("log").textContent+"\n":"") + line; }

function setStatus(s){ $("kStatus").textContent = s; }
function setKpi(id,v){ $(id).textContent = String(v); }

function loadSaved(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return {items:[], byLink:{}};
    const items = JSON.parse(raw);
    const byLink = {};
    for(const it of items){ if(it.link) byLink[it.link] = true; }
    return {items, byLink};
  }catch{
    return {items:[], byLink:{}};
  }
}
function persist(){
  try{
    localStorage.setItem(STORE_KEY, JSON.stringify(saved.items.slice(0, 400)));
  }catch{}
}

/* Words parsing + smart variants */
function parseWords(q){
  return norm(q).split(/\s+/).map(x=>x.trim()).filter(Boolean);
}
function variants(word){
  const w = word.trim().toLowerCase();
  const set = new Set([w]);
  set.add(w+"s"); set.add(w+"es"); set.add(w+"ed"); set.add(w+"ing");
  if(w.endsWith("s") && w.length>3) set.add(w.slice(0,-1));
  if(w.length>=5) set.add("prefix:"+w);
  return [...set];
}
function blob(it){
  return norm([it.title,it.desc,it.source,it.link,it.host].join(" "));
}
function hit(blobText, token){
  if(token.startsWith("prefix:")) return blobText.includes(token.slice(7));
  return blobText.includes(token);
}
function hitsForItem(it, words){
  const b = blob(it);
  const smart = $("smartMatch").checked;
  const hits = [];
  for(const w of words){
    if(!smart){
      if(b.includes(w)) hits.push(w);
    }else{
      const vars = variants(w);
      if(vars.some(v => hit(b, v))) hits.push(w);
    }
  }
  return hits;
}

/* Simple “quality warning” (not truth detection) */
function qualityFlag(text){
  const t = norm(text || "");
  const ex = (t.match(/!/g)||[]).length;
  const caps = (text||"").match(/\b[A-Z]{6,}\b/g)?.length || 0;
  const clickbait = /\b(shocking|unbelievable|you won't believe|miracle|secret revealed)\b/i.test(text||"");
  const aiish = /\b(as an ai|as a language model|in conclusion|delve into|tapestry|robust framework)\b/i.test(text||"");
  let risk = 0;
  if(ex>=5) risk += 20;
  if(caps>=3) risk += 15;
  if(clickbait) risk += 35;
  if(aiish) risk += 25;
  return Math.min(100, risk);
}

/* Proxy fetch (browser-safe) */
async function fetchText(url){
  const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const r = await fetch(proxy, {cache:"no-store"});
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.text();
}

/* Parse RSS + Atom */
function parseFeed(xmlText, fallbackSource){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  if(doc.querySelector("parsererror")) throw new Error("Invalid XML (not RSS/Atom).");

  const channelTitle =
    doc.querySelector("channel>title")?.textContent?.trim()
    || doc.querySelector("feed>title")?.textContent?.trim()
    || fallbackSource
    || "unknown";

  const rss = [...doc.querySelectorAll("item")].map(it=>({
    title: it.querySelector("title")?.textContent?.trim() || "",
    link:  it.querySelector("link")?.textContent?.trim() || "",
    desc:  it.querySelector("description")?.textContent?.trim() || "",
    source: channelTitle
  }));

  const atom = [...doc.querySelectorAll("entry")].map(en=>{
    const linkEl = en.querySelector("link[rel='alternate']") || en.querySelector("link") || null;
    const href = linkEl?.getAttribute("href") || linkEl?.textContent || "";
    return {
      title: en.querySelector("title")?.textContent?.trim() || "",
      link:  (href||"").trim(),
      desc:  en.querySelector("summary")?.textContent?.trim()
          || en.querySelector("content")?.textContent?.trim()
          || "",
      source: channelTitle
    };
  });

  return [...rss, ...atom].filter(x => x.title || x.link);
}

function trustForHost(h){
  return TRUST[h] ?? 50;
}
function trustLabel(score){
  if(score>=80) return {txt:"High", cls:"good"};
  if(score>=65) return {txt:"Medium", cls:"warn"};
  return {txt:"Unknown", cls:"bad"};
}
<!-- ======================= PART 3 / 3 ======================= -->
<script>
function render(){
  const tb = $("results");

  if(!saved.items.length){
    tb.innerHTML = `<tr><td colspan="6">No saved results yet. Run Start.</td></tr>`;
    return;
  }

  tb.innerHTML = saved.items.slice(0, 300).map(it=>{
    const tl = trustLabel(it.trust);
    const q = it.qRisk;
    const qTxt = q>=60 ? "Warning" : (q>=30 ? "Check" : "OK");
    const qCls = q>=60 ? "bad" : (q>=30 ? "warn" : "good");

    return `
      <tr>
        <td class="${tl.cls}">${tl.txt} <span class="small">(${it.trust})</span></td>
        <td class="${qCls}">${qTxt} <span class="small">(${q})</span></td>
        <td><a href="${it.link}" target="_blank" rel="noopener">${escapeHtml(it.title||"(untitled)")}</a></td>
        <td>${escapeHtml(it.host)} <span class="small">(${escapeHtml(it.source)})</span></td>
        <td class="mono">${escapeHtml((it.hits||[]).join(", "))}</td>
        <td class="small">${escapeHtml(it.time || "")}</td>
      </tr>
    `;
  }).join("");
}

function addItem(raw, hits){
  const h = hostFromUrl(raw.link) || hostFromUrl(raw.feed) || "unknown";
  const trust = trustForHost(h);
  const qRisk = qualityFlag((raw.title||"") + " " + (raw.desc||""));

  const item = {
    title: raw.title || "",
    link: raw.link || "",
    desc: raw.desc || "",
    source: raw.source || "",
    host: h,
    trust,
    qRisk,
    hits,
    time: nowStamp()
  };

  if(!item.link) return;
  if(saved.byLink[item.link]) return;

  saved.byLink[item.link] = true;
  saved.items.unshift(item);          // newest first
  saved.items = saved.items.slice(0, 400);
  persist();
}

async function runCycle(){
  if(paused) return;

  const words = parseWords($("query").value);
  const strictAll = $("strictAll").checked;
  const minTrust = Math.max(0, Math.min(100, +$("minTrust").value || 0));

  const feeds = $("feeds").value.split("\n").map(x=>x.trim()).filter(Boolean);

  if(!words.length){
    logLine("Type keywords first (example: Minnesota groups protest).");
    return;
  }

  for(const feed of feeds){
    const label = hostFromUrl(feed) || feed;
    try{
      const xml = await fetchText(feed);
      const items = parseFeed(xml, label);
      fetchedTotal += items.length;

      let localAdd = 0;

      for(const it of items){
        const host = hostFromUrl(it.link) || hostFromUrl(feed) || "";
        const trust = trustForHost(host);
        if(trust < minTrust) continue;

        const hits = hitsForItem({...it, host}, words);

        if(strictAll){
          if(hits.length !== words.length) continue;
        }else{
          if(hits.length === 0) continue;
        }

        addItem({...it, feed, host}, hits);
        localAdd++;
      }

      logLine(`OK   ${label}  items=${items.length}  added=${localAdd}`);
    }catch(e){
      errorTotal++;
      logLine(`FAIL ${label}  (${e.message || e})`);
    }
  }

  setKpi("kFetched", fetchedTotal);
  setKpi("kMatched", saved.items.length);
  setKpi("kErrors", errorTotal);
  render();
}

/* ===== 5-minute run control ===== */
function startTimedRun(){
  const mins = Math.max(1, +$("runMins").value || 5);
  const totalMs = mins * 60 * 1000;
  const start = Date.now();

  // Clear any old timers
  if(timer) clearInterval(timer);
  if(stopTimer) clearTimeout(stopTimer);

  paused = false;
  fetchedTotal = 0;
  errorTotal = 0;

  setStatus("Running");
  logReset([`Started @ ${nowStamp()}`, `Will auto-stop after ${mins} minute(s).`, "---"]);

  // run immediately + every 15 seconds
  runCycle();
  timer = setInterval(runCycle, 15000);

  // countdown UI
  const countdown = setInterval(()=>{
    const left = Math.max(0, totalMs - (Date.now() - start));
    const sec = Math.ceil(left/1000);
    setKpi("kLeft", sec>0 ? `${sec}s` : "0s");
    if(left<=0){
      clearInterval(countdown);
    }
  }, 250);

  // auto-stop
  stopTimer = setTimeout(()=>{
    stopRun();
    logLine("---");
    logLine("Auto-stopped (time limit reached).");
  }, totalMs);
}

function stopRun(){
  if(timer) clearInterval(timer);
  if(stopTimer) clearTimeout(stopTimer);
  timer = null;
  stopTimer = null;
  paused = false;
  setStatus("Stopped");
  setKpi("kLeft", "—");
}

function downloadCSV(){
  const rows = saved.items.slice().reverse(); // oldest -> newest in CSV
  const header = ["time","trust","qualityRisk","host","source","title","link","matchedWords"];
  const csv = [
    header.join(","),
    ...rows.map(it=>{
      const line = [
        it.time, it.trust, it.qRisk, it.host, it.source, it.title, it.link, (it.hits||[]).join(" ")
      ].map(v => `"${String(v||"").replace(/"/g,'""')}"`).join(",");
      return line;
    })
  ].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "facts_rss_results.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("feeds").value = DEFAULT_FEEDS;

  // load any saved results on page load (so they DON'T disappear)
  render();
  setKpi("kMatched", saved.items.length);

  $("btnStart").addEventListener("click", startTimedRun);
  $("btnStop").addEventListener("click", ()=>{ stopRun(); logLine("Stopped by user."); });

  $("btnReset").addEventListener("click", ()=>{
    stopRun();
    fetchedTotal = 0;
    errorTotal = 0;
    setKpi("kFetched",0); setKpi("kErrors",0); setKpi("kLeft","—");
    setStatus("Idle");
    logReset(["Reset complete. Saved results are still kept unless you clear them."]);
  });

  $("btnCSV").addEventListener("click", downloadCSV);
  $("btnPrint").addEventListener("click", ()=>window.print());

  $("btnClearSaved").addEventListener("click", ()=>{
    stopRun();
    localStorage.removeItem(STORE_KEY);
    saved = {items:[], byLink:{}};
    render();
    setKpi("kMatched",0);
    logReset(["Saved results cleared."]);
  });

  setStatus("Idle");
});
</script>

</body>
</html>
