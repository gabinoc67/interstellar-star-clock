<!-- ======================= PART 1 / 3 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simple Live RSS Match Monitor (Working)</title>

<style>
:root{
  --bg:#070b14;
  --panel:#0f172a;
  --ink:#e5e7eb;
  --muted:#9aa4c7;
  --accent:#60a5fa;
  --good:#34d399;
  --warn:#fbbf24;
  --bad:#fb7185;
  --line:rgba(148,163,184,.25);
  --radius:16px;
  --mono: ui-monospace, Consolas, monospace;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:20px auto;padding:14px}
.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
}
h1{margin:0 0 8px;font-size:22px}
h3{margin:0 0 10px;font-size:14px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,textarea,select,button{
  background:#020617;
  color:var(--ink);
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 10px;
}
textarea{min-height:140px;width:100%;font-family:var(--mono)}
button{
  background:linear-gradient(180deg,#60a5fa,#3b82f6);
  color:#020617;
  font-weight:900;
  cursor:pointer;
  border:0;
}
button.secondary{
  background:#111827;
  color:var(--ink);
  border:1px solid var(--line);
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
th{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.12em}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.muted{color:var(--muted)}
.mono{font-family:var(--mono)}
.pill{
  display:inline-block;border:1px solid var(--line);
  border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);
  margin-right:8px;margin-top:8px;
}
.pill b{color:var(--ink)}
.good{color:var(--good)}
.warn{color:var(--warn)}
.bad{color:var(--bad)}
.log{
  background:rgba(2,6,23,.4);
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  max-height:220px;
  overflow:auto;
  white-space:pre-wrap;
  font-family:var(--mono);
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Simple Live RSS Match Monitor <span class="muted" style="font-size:12px">(browser-safe / working)</span></h1>

  <div class="card">
    <div class="row">
      <input id="query" placeholder='Example: Minnesota groups protests' style="flex:1;min-width:280px"/>
      <select id="mode" title="Proxy is required in most browsers.">
        <option value="proxy" selected>Proxy (recommended)</option>
        <option value="direct">Direct (often blocked)</option>
      </select>
      <label class="muted" style="font-size:12px">
        <input id="strictAll" type="checkbox" checked/> Require ALL words
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnStart">Start</button>
      <button id="btnPause" class="secondary">Pause</button>
      <button id="btnStop" class="secondary">Stop</button>
      <button id="btnReset" class="secondary">Reset</button>
      <span class="pill"><b id="kFeeds">0</b> feeds</span>
      <span class="pill"><b id="kFetched">0</b> items fetched</span>
      <span class="pill"><b id="kMatched">0</b> matched</span>
      <span class="pill"><b id="kErrors">0</b> feed errors</span>
    </div>

    <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.5">
      Why you saw “0 fetched”: Direct fetch is blocked by CORS. Use <b>Proxy</b>.
      This version also shows a live <b>Feed Health log</b> so you can see which feeds fail.
    </div>
  </div>

  <div class="card">
    <h3>RSS / Atom Feeds (one per line)</h3>
    <textarea id="feeds"></textarea>
    <div class="muted" style="margin-top:8px;font-size:12px">
      Tip: pick feeds that are true RSS/Atom XML endpoints. If a feed fails, the log will tell you.
    </div>
  </div>

  <div class="card">
    <h3>Articles (live matches)</h3>
    <table>
      <thead>
        <tr>
          <th>Status</th>
          <th>Article</th>
          <th>Source</th>
          <th>Matched Words</th>
        </tr>
      </thead>
      <tbody id="results">
        <tr><td colspan="4" class="muted">Waiting…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>Feed Health / Errors (this is your debugger)</h3>
    <div id="log" class="log">Idle.</div>
  </div>

</div>
<!-- ======================= PART 2 / 3 ======================= -->
<script>
/* IMPORTANT: These defaults are known RSS/Atom endpoints more often than not.
   If any fail, the log will show it. */
const DEFAULT_FEEDS = [
  "https://feeds.bbci.co.uk/news/world/rss.xml",
  "https://feeds.npr.org/1004/rss.xml",
  "https://www.nasa.gov/rss/dyn/breaking_news.rss",
  "https://www.usgs.gov/feeds/earthquakes/feed",
  "https://www.noaa.gov/rss.xml",
  "https://news.un.org/feed/subscribe/en/news/all/rss.xml",
  "https://www.who.int/feeds/entity/csr/don/en/rss.xml"
].join("\n");

let timer = null;
let paused = false;
let cycleNo = 0;

const $ = id => document.getElementById(id);
const norm = s => (s||"").toLowerCase();

function hostFromUrl(u){
  try{ return new URL(u).hostname.replace(/^www\./,""); }catch{ return ""; }
}

function setLog(lines){
  $("log").textContent = lines.join("\n");
}
function appendLog(line){
  $("log").textContent = ( $("log").textContent.trim() ? $("log").textContent + "\n" : "" ) + line;
}
function setKPIs({feeds,fetched,matched,errors}){
  $("kFeeds").textContent   = String(feeds);
  $("kFetched").textContent = String(fetched);
  $("kMatched").textContent = String(matched);
  $("kErrors").textContent  = String(errors);
}

function parseWords(q){
  return norm(q).split(/\s+/).map(x=>x.trim()).filter(Boolean);
}

function itemText(it){
  return norm([it.title,it.desc,it.source,it.link].join(" "));
}

function matchedWords(it, words){
  const blob = itemText(it);
  const hits = [];
  for(const w of words){ if(blob.includes(w)) hits.push(w); }
  return hits;
}

/* Fetch text with proxy fallback */
async function fetchText(url){
  const mode = $("mode").value;
  if(mode === "direct"){
    // direct (often blocked)
    const r = await fetch(url, {cache:"no-store"});
    return await r.text();
  }
  // proxy mode (recommended)
  const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const r = await fetch(proxyUrl, {cache:"no-store"});
  return await r.text();
}

/* Parse RSS (<item>) + Atom (<entry>) */
function parseFeed(xmlText, fallbackSource){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");

  // If parser hit an error, many browsers include <parsererror>
  if(doc.querySelector("parsererror")){
    throw new Error("Not valid XML (parsererror). Feed may not be RSS/Atom.");
  }

  const channelTitle =
    doc.querySelector("channel>title")?.textContent?.trim()
    || doc.querySelector("feed>title")?.textContent?.trim()
    || fallbackSource
    || "unknown";

  // RSS items
  const rssItems = [...doc.querySelectorAll("item")].map(it => ({
    title: it.querySelector("title")?.textContent?.trim() || "",
    link:  it.querySelector("link")?.textContent?.trim() || "",
    desc:  it.querySelector("description")?.textContent?.trim() || "",
    source: channelTitle
  }));

  // Atom entries
  const atomItems = [...doc.querySelectorAll("entry")].map(en => {
    // Atom links can be <link href="...">
    const linkEl = en.querySelector("link[rel='alternate']") || en.querySelector("link") || null;
    const href = linkEl?.getAttribute("href") || linkEl?.textContent || "";
    return {
      title: en.querySelector("title")?.textContent?.trim() || "",
      link:  (href||"").trim(),
      desc:  en.querySelector("summary")?.textContent?.trim()
          || en.querySelector("content")?.textContent?.trim()
          || "",
      source: channelTitle
    };
  });

  const items = [...rssItems, ...atomItems]
    .filter(x => x.title || x.link); // keep valid-ish

  return items;
}

function renderRows(rows){
  const tb = $("results");
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="4">No matches (try fewer words or add a relevant feed).</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>{
    const status = r.verified ? `<span class="good">Likely</span>` : `<span class="warn">Unknown</span>`;
    const host = hostFromUrl(r.link) || hostFromUrl(r.feed) || "unknown";
    const mw = r.hits.length ? r.hits.join(", ") : "";
    return `
      <tr>
        <td>${status}</td>
        <td><a href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title || "(untitled)")}</a></td>
        <td>${escapeHtml(host)} <span class="muted">(${escapeHtml(r.source)})</span></td>
        <td class="mono">${escapeHtml(mw)}</td>
      </tr>
    `;
  }).join("");
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
</script>
<!-- ======================= PART 3 / 3 ======================= -->
<script>
async function runCycle(){
  if(paused) return;
  cycleNo++;

  const q = $("query").value;
  const words = parseWords(q);
  const strictAll = $("strictAll").checked;

  const feeds = $("feeds").value.split("\n").map(x=>x.trim()).filter(Boolean);

  let fetchedTotal = 0;
  let errors = 0;
  let matches = [];

  setLog([
    `Cycle: ${cycleNo}`,
    `Mode: ${$("mode").value}`,
    `Words: [${words.join(", ")}]  StrictAll: ${strictAll}`,
    `Feeds: ${feeds.length}`,
    `---`
  ]);

  if(!words.length){
    appendLog("Type at least 1 keyword. Example: Minnesota groups protests");
    setKPIs({feeds:feeds.length,fetched:0,matched:0,errors:0});
    renderRows([]);
    return;
  }

  for(const feed of feeds){
    try{
      const xmlText = await fetchText(feed);
      const items = parseFeed(xmlText, hostFromUrl(feed) || feed);
      fetchedTotal += items.length;

      let localMatches = 0;

      for(const it of items){
        const hits = matchedWords(it, words);

        // Must include ALL words if strictAll
        if(strictAll){
          if(hits.length !== words.length) continue;
        }else{
          if(hits.length === 0) continue;
        }

        matches.push({
          ...it,
          hits,
          feed,
          verified: true
        });
        localMatches++;
      }

      appendLog(`OK  ${hostFromUrl(feed) || feed}  items=${items.length}  matches=${localMatches}`);
    }catch(e){
      errors++;
      appendLog(`FAIL ${hostFromUrl(feed) || feed}  (${e.message || e})`);
    }
  }

  // Sort by “most complete / longest title” as simple tie-breakers
  matches.sort((a,b)=>{
    if(b.hits.length !== a.hits.length) return b.hits.length - a.hits.length;
    return (b.title||"").length - (a.title||"").length;
  });

  setKPIs({feeds:feeds.length,fetched:fetchedTotal,matched:matches.length,errors});
  renderRows(matches.slice(0, 60));
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("feeds").value = DEFAULT_FEEDS;
  setKPIs({feeds: DEFAULT_FEEDS.split("\n").filter(Boolean).length, fetched:0, matched:0, errors:0});
  setLog(["Idle. Click Start. (Use Proxy mode if Direct fails.)"]);

  $("btnStart").onclick = ()=>{
    if(timer) return;
    paused = false;
    runCycle();
    timer = setInterval(runCycle, 15000);
    appendLog("---");
    appendLog("Started.");
  };

  $("btnPause").onclick = ()=>{
    paused = !paused;
    appendLog(paused ? "Paused." : "Resumed.");
  };

  $("btnStop").onclick = ()=>{
    clearInterval(timer);
    timer = null;
    paused = false;
    appendLog("Stopped.");
  };

  $("btnReset").onclick = ()=>{
    clearInterval(timer);
    timer = null;
    paused = false;
    cycleNo = 0;
    $("query").value = "";
    $("mode").value = "proxy";
    $("strictAll").checked = true;
    $("feeds").value = DEFAULT_FEEDS;
    $("results").innerHTML = `<tr><td colspan="4">Reset complete.</td></tr>`;
    setKPIs({feeds: DEFAULT_FEEDS.split("\n").filter(Boolean).length, fetched:0, matched:0, errors:0});
    setLog(["Reset complete. Click Start."]);
  };
});
</script>

</body>
</html>
