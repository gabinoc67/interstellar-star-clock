<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CST-Locked v-RMS — Open Toroid (Animated) + Solar System Selector</title>
<meta name="description" content="Live v-RMS wave with CST clock, G ≈ vRMS²/(8πc²), animated open-toroid influx/outflux visualization, body-specific tolerances, mode library, and data hooks. Includes Auto-Scan 10× log with Pass/Fail and Excel-compatible export." />
<style>
  :root{
    /* Gabino site palette */
    --bg:#0b1222;--panel:#111a34;--ink:#eaf0ff;--muted:#a7b7e6;--accent:#8fb4ff;--grid:#1b2550;
    --ok:#7bffb1;--warn:#ffd37a;--bad:#ff8c8c;--card:#0e1740;--border:#213067;--btn:#162455;--btnHover:#1d2e6e
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1320px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-size:1.35rem}
  .sub{color:var(--muted);margin:0 0 14px;font-size:0.92rem}
  .grid{display:grid;grid-template-columns:1.15fr 0.85fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .card h2{margin:0 0 8px;font-size:1.05rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .small{font-size:0.88rem;color:var(--muted)}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
  .kpi div{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
  .kpi .v{font-size:1rem}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  button{background:var(--btn);color:var(--ink);border:1px solid var(--accent);border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{background:var(--btnHover)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .toggle{display:flex;align-items:center;gap:8px;margin:6px 0}
  input[type="range"], select, input[type="number"], textarea{width:100%}
  canvas{display:block;background:linear-gradient(transparent,transparent),
    repeating-linear-gradient(0deg,transparent 0 22px,var(--grid) 22px 23px);
    border-radius:12px;border:1px solid var(--border)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:.8rem;color:var(--muted)}
  .good{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .topbar a.btn{background:var(--btn);border:1px solid var(--accent);padding:8px 12px;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left}
  th{color:var(--muted);font-weight:600}
  tbody tr:hover{background:rgba(143,180,255,0.06)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.8rem}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .legend .item{display:flex;align-items:center;gap:6px}
  .legend .dot{width:10px;height:10px;border-radius:999px;border:1px solid var(--border);background:#7bffb1}
  .muted{opacity:.85}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <a class="btn" href="https://gabinoc67.github.io/interstellar-star-clock/">← Back to Quick Links</a>
    <span class="pill">CST-Locked</span>
    <span class="pill">Live</span>
  </div>

  <h1>CST-Locked v-RMS Gravity Equivalence</h1>
  <p class="sub">
    Continuous v-RMS wave shows gravity as an energy-density gradient in a dynamic medium—<em>Vibrational form ≡ Influx form</em>.
    Calibrated from Earth’s ~54-minute reference; density-scaled to Sun & planets (incl. Pluto).
    Real-time \(G_{\text{est}} = v_{\rm RMS}^2/(8\pi c^2)\). Includes body-specific tolerances, mode library, and external data hooks.
    <span class="badge">Always Running</span>
  </p>

  <div class="grid">
    <!-- LEFT: Live Wave + Results + Controls + Auto-Scan Panel -->
    <div class="card">
      <h2>Live Wave &amp; Results</h2>
      <canvas id="wave" width="1000" height="260" aria-label="v-RMS live wave"></canvas>

      <div class="kpi">
        <div>
          <div class="small">v-RMS (m/s)</div>
          <div id="vOut" class="v mono">0.000000</div>
        </div>
        <div>
          <div class="small">G_est (m³·kg⁻¹·s⁻²)</div>
          <div id="gOut" class="v mono">0.00000000000e+00</div>
        </div>
        <div>
          <div class="small">Δ vs G₀</div>
          <div id="errOut" class="v mono">0.00%</div>
        </div>
        <div>
          <div class="small">Tolerance (auto)</div>
          <div id="tolOut" class="v mono">±5.0%</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2 style="margin-bottom:6px">Body &amp; Calibration</h2>
          <label class="small">Select body
            <select id="bodySel">
              <option>Earth</option>
              <option>Sun</option>
              <option>Mercury</option>
              <option>Venus</option>
              <option>Mars</option>
              <option>Jupiter</option>
              <option>Saturn</option>
              <option>Uranus</option>
              <option>Neptune</option>
              <option>Pluto</option>
            </select>
          </label>

          <label class="small">Mode library (Earth reference)
            <select id="modeSel">
              <option value="54">Reference: 54 min</option>
              <option value="60">Alt: 60 min</option>
              <option value="45">Alt: 45 min</option>
              <option value="30">Alt: 30 min</option>
              <option value="custom">Custom (minutes below)</option>
            </select>
          </label>
          <label class="small">Custom mode (minutes)
            <input id="modeCustom" type="number" min="1" step="0.1" value="54">
          </label>

          <div class="small">
            Density-scaled period estimate:
            <span id="periodS" class="mono"></span> s
            (<span id="periodMin" class="mono"></span> min)
          </div>
          <div class="small">Method: <span class="mono">T_body = T_EarthMode × √(ρ⊕ / ρ_body) × fine-tune</span></div>

          <label class="small">Fine tune period (±20%)<br/>
            <input id="periodFine" type="range" min="0.8" max="1.2" step="0.005" value="1.000">
          </label>
          <label class="small">Base amplitude (m/s)
            <input id="amp" type="range" min="0" max="0.06" step="0.0005" value="0.030">
          </label>
          <label class="small">Noise mix
            <input id="noise" type="range" min="0" max="1" step="0.02" value="0.18">
          </label>
          <label class="small">Vibrational ↔ Influx blend
            <input id="blend" type="range" min="0" max="1" step="0.01" value="0.50">
          </label>
        </div>

        <div class="card">
          <h2 style="margin-bottom:6px">CST Phase / Clock</h2>
          <div class="small">All timestamps use America/Chicago (CST/CDT).</div>
          <canvas id="phaseDial" width="220" height="160" aria-label="CST phase dial"></canvas>
          <div class="small">Phase (rad): <span id="phaseOut" class="mono">0.000</span></div>
          <div class="small">CST Time: <span id="timeOut" class="mono">--:--:--</span></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2 style="margin-bottom:6px">Controls</h2>
          <div class="btns">
            <button id="scan10">Auto-Scan 10×</button>
            <button id="clearScan">Clear Scan</button>
            <button id="pauseBtn">Pause</button>
            <button id="resumeBtn" disabled>Resume</button>
          </div>
          <div class="small">Always-live rendering (requestAnimationFrame + fallback). “Pause” halts drawing; CST phase continues for timing consistency.</div>
        </div>

        <div class="card">
          <h2 style="margin-bottom:6px">Equation (Displayed)</h2>
          <div class="small mono">
            G_est = vRMS² / (8·π·c²), &nbsp; c = 299,792,458 m/s, &nbsp; G₀ = 6.67430×10⁻¹¹
          </div>
          <div class="small">This shows <em>vibrational</em> and <em>influx</em> forms map to the same surface g via the shared kinetic relic v-RMS.</div>
        </div>
      </div>

      <!-- Auto-Scan Panel (10 entries) -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h2 style="margin-bottom:6px">Auto-Scan Log (10)</h2>
          <div class="right">
            <button id="exportCsv">Export CSV (Excel)</button>
          </div>
        </div>
        <div class="small">Each Auto-Scan captures v-RMS, G_est, Δ vs G₀, and Pass/Fail (body-specific tolerance) with a CST timestamp and body/mode selection.</div>
        <table id="scanTable" aria-label="Auto-scan results table">
          <thead>
            <tr>
              <th>#</th>
              <th>Time (CST)</th>
              <th>Body</th>
              <th>Mode (min)</th>
              <th>v-RMS (m/s)</th>
              <th>G_est (m³·kg⁻¹·s⁻²)</th>
              <th>Δ vs G₀</th>
              <th>Pass/Fail</th>
            </tr>
          </thead>
          <tbody id="scanBody"></tbody>
        </table>
        <div class="small" id="scanStatus"></div>
      </div>

      <!-- Data Hooks -->
      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:6px">External Data Hook (optional)</h2>
        <p class="small">
          Paste external v-RMS values (m/s). Use commas, spaces, or new lines. When enabled, the **latest** value overrides the internal model for all readouts, scans, and Pass/Fail.
        </p>
        <label class="small">External v-RMS samples
          <textarea id="extData" rows="4" placeholder="e.g. 0.024, 0.026, 0.0259"></textarea>
        </label>
        <div class="toggle">
          <input id="extEnable" type="checkbox" />
          <label for="extEnable" class="small">Use external v-RMS override (latest parsed value)</label>
        </div>
        <div class="small muted">Parsed latest value: <span id="extLatest" class="mono">—</span></div>
      </div>

      <!-- About -->
      <div class="card" style="margin-top:12px">
        <h2>About the 54-minute reference</h2>
        <p class="small">
          The ~54-minute period anchors the simulator to a plausible near-surface free-oscillation timescale.
          Locking the phase to CST ensures repeatable comparisons. Selecting other periods in the mode library
          tests robustness: if the mechanism is universal, both **Vibrational** and **Influx** forms should still
          converge on the same gravity behavior via v-RMS, with differences reflected in Δ and Pass/Fail.
        </p>
      </div>
    </div>

    <!-- RIGHT: Explanations + Animated Toroid -->
    <div class="card">
      <h2>Dynamic Matter ↔ Dynamic Energy (Physical Substrate)</h2>
      <p class="small">
        Near-surface field is modeled as a dual substrate: <strong>Dynamic Matter</strong> supports compressional/elastic modes (vibrational form),
        while <strong>Dynamic Energy</strong> carries directed influx/outflux momentum (influx form). The live v-RMS is the measurable kinetic
        statistic both share. A stable g field appears when the energy-density gradient is stationary in the CST phase frame.
      </p>

      <h2 style="margin-top:12px">Open-Toroidal Boundary (Animated)</h2>
      <div class="toggle">
        <input id="toroidToggle" type="checkbox" />
        <label for="toroidToggle" class="small">Show open-toroid visualization (blink + motion)</label>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
        <div class="card">
          <label class="small">Flow direction
            <select id="flowDir">
              <option value="in">Influx (arrows point inward)</option>
              <option value="out">Outflux (arrows point outward)</option>
            </select>
          </label>
          <label class="small">Arrow blink speed
            <input id="blinkSpeed" type="range" min="0.5" max="3" step="0.05" value="1.2">
          </label>
          <label class="small">Packet travel speed
            <input id="packetSpeed" type="range" min="0.2" max="3" step="0.05" value="1.4">
          </label>
        </div>
        <div class="card">
          <label class="small">Ring radius (visual)
            <input id="ringScale" type="range" min="0.6" max="1.4" step="0.02" value="1.00">
          </label>
          <label class="small">Arrow count
            <input id="arrowCount" type="range" min="4" max="16" step="1" value="8">
          </label>
          <label class="small">Packet density
            <input id="packetCount" type="range" min="4" max="60" step="1" value="18">
          </label>
        </div>
      </div>

      <canvas id="toroid" width="520" height="320" aria-label="Animated toroidal boundary"></canvas>
      <div class="legend small" style="margin-top:6px">
        <div class="item"><span class="dot"></span> Bubbles (packets)</div>
        <div class="item"><span class="mono">→</span> Arrow direction = flow</div>
      </div>

      <div class="footer">
        <strong>Safety &amp; Disclaimer:</strong> Conceptual research visualizer. Periods for non-Earth bodies use density-scaled estimates for demonstration;
        replace with observed free-oscillation modes as data become available. Validate with independent instrumentation.
      </div>
    </div>
  </div>
</div>

<script>
(()=>{
  // ======= Config =======
  // Body-specific pass tolerances (Δ vs G0 in percent)
  const BODY_TOL = {
    "Sun": 10.0,
    "Mercury": 5.0, "Venus": 5.0, "Earth": 5.0, "Mars": 5.0,
    "Jupiter": 8.0, "Saturn": 8.0, "Uranus": 8.0, "Neptune": 8.0,
    "Pluto": 7.0
  };

  // ======= Physical constants & body data =======
  const c = 299792458;                // m/s
  const G0 = 6.67430e-11;             // m^3 kg^-1 s^-2 (reference)
  const rhoEarth = 5514;              // kg/m^3

  // Mean densities (kg/m^3). Pluto included.
  const bodies = {
    "Sun":     { rho: 1408 },
    "Mercury": { rho: 5427 },
    "Venus":   { rho: 5243 },
    "Earth":   { rho: 5514 },
    "Mars":    { rho: 3933 },
    "Jupiter": { rho: 1326 },
    "Saturn":  { rho:   687 },
    "Uranus":  { rho:  1270 },
    "Neptune": { rho:  1638 },
    "Pluto":   { rho:  1850 }
  };

  // ======= DOM =======
  const wave = document.getElementById('wave');
  const ctx = wave.getContext('2d');
  const vOut = document.getElementById('vOut');
  const gOut = document.getElementById('gOut');
  const errOut = document.getElementById('errOut');
  const tolOut = document.getElementById('tolOut');

  const phaseDial = document.getElementById('phaseDial');
  const pctx = phaseDial.getContext('2d');
  const timeOut = document.getElementById('timeOut');
  const phaseOut = document.getElementById('phaseOut');

  const bodySel = document.getElementById('bodySel');
  const modeSel = document.getElementById('modeSel');
  const modeCustom = document.getElementById('modeCustom');

  const periodSOut = document.getElementById('periodS');
  const periodMinOut = document.getElementById('periodMin');
  const periodFine = document.getElementById('periodFine');

  const amp = document.getElementById('amp');
  const noise = document.getElementById('noise');
  const blend = document.getElementById('blend');

  const scan10 = document.getElementById('scan10');
  const clearScan = document.getElementById('clearScan');
  const pauseBtn = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');

  const toroidToggle = document.getElementById('toroidToggle');
  const flowDir = document.getElementById('flowDir');
  const blinkSpeed = document.getElementById('blinkSpeed');
  const packetSpeed = document.getElementById('packetSpeed');
  const ringScale = document.getElementById('ringScale');
  const arrowCount = document.getElementById('arrowCount');
  const packetCount = document.getElementById('packetCount');

  const toroid = document.getElementById('toroid');
  const tctx = toroid.getContext('2d');

  const scanBody = document.getElementById('scanBody');
  const scanStatus = document.getElementById('scanStatus');
  const exportCsvBtn = document.getElementById('exportCsv');

  const extData = document.getElementById('extData');
  const extEnable = document.getElementById('extEnable');
  const extLatest = document.getElementById('extLatest');

  // ======= State =======
  let running = true;
  let scanMarks = [];
  let period = 54*60; // seconds, dynamic via mode+body scaling
  let earthModeMinutes = 54; // from mode library or custom
  let scanRows = []; // {idx,time,body,modeMin,v,g,err,pass}
  let isScanning = false;

  // ======= Helpers: CST clock =======
  function cstTimestamp(){
    const optsDate = { timeZone: 'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' };
    const optsTime = { timeZone: 'America/Chicago', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
    const d = new Date();
    const df = new Intl.DateTimeFormat('en-CA', optsDate).format(d).replaceAll('/','-'); // YYYY-MM-DD
    const tf = new Intl.DateTimeFormat('en-GB', optsTime).format(d); // HH:MM:SS
    return `${df} ${tf}`;
  }
  function setCSTClock(){ timeOut.textContent = cstTimestamp(); }

  // ======= Mode library handling =======
  function currentEarthModeMinutes(){
    if(modeSel.value === 'custom'){
      const m = Math.max(1, parseFloat(modeCustom.value)||54);
      return m;
    }
    return parseFloat(modeSel.value); // 54, 60, 45, 30
  }

  // ======= Period handling (scaled by density & fine-tune) =======
  function densityScaledPeriodSeconds(){
    const body = bodySel.value;
    const rho = bodies[body]?.rho ?? rhoEarth;
    const baseEarthMin = currentEarthModeMinutes();
    const fine = parseFloat(periodFine.value);
    return baseEarthMin*60 * Math.sqrt(rhoEarth/rho) * fine;
  }

  function updatePeriodUI(){
    earthModeMinutes = currentEarthModeMinutes();
    period = densityScaledPeriodSeconds();
    periodSOut.textContent = period.toFixed(1);
    periodMinOut.textContent = (period/60).toFixed(2);
    // Update tolerance display
    const tol = BODY_TOL[bodySel.value] ?? 5.0;
    tolOut.textContent = `±${tol.toFixed(1)}%`;
  }

  // ======= Phase & time =======
  const twoPi = Math.PI*2;
  function nowSec(){ return Date.now()/1000; }
  function phaseNow(){ return ((nowSec() % period) / period) * twoPi; } // [0, 2π)

  // ======= External data parse =======
  function parseExternalLatest(){
    const txt = extData.value.trim();
    if(!txt) return null;
    const parts = txt.split(/[\s,;]+/).map(Number).filter(v=>isFinite(v) && v>=0);
    if(!parts.length) return null;
    return parts[parts.length-1];
  }
  function extRefresh(){
    const v = parseExternalLatest();
    extLatest.textContent = (v==null)? '—' : v.toFixed(6);
  }

  // ======= vRMS model =======
  function modelVRMS(ph){
    const A = parseFloat(amp.value);
    const n = parseFloat(noise.value);
    const b = parseFloat(blend.value);

    const vib = Math.sin(ph); // vibrational
    const tri = 2*Math.abs((ph/Math.PI)%2 - 1) - 1;
    const saw = (ph/Math.PI)%2 - 1;
    const inf = 0.6*tri + 0.4*saw; // influx profile

    const base = (1-b)*vib + b*inf;
    const rnd = (Math.random()*2-1)*0.5;
    const colored = 0.7*rnd + 0.3*Math.sin(ph*3.7+0.5);

    return Math.abs(A*((1-n)*base + n*colored));
  }
  function currentVRMS(ph){
    if(extEnable.checked){
      const v = parseExternalLatest();
      if(v!=null) return Math.abs(v);
    }
    return modelVRMS(ph);
  }
  function gFromVRMS(v){ return (v*v)/(8*Math.PI*c*c); }

  // ======= Drawing: Wave =======
  function drawWave(){
    const W = wave.width, H = wave.height;
    ctx.clearRect(0,0,W,H);

    // baseline
    ctx.strokeStyle = '#28407f'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(0,H-30); ctx.lineTo(W,H-30); ctx.stroke();

    // gather recent samples across 6s window
    const N = W;
    const samples = [];
    for(let i=0;i<N;i++){
      const tBack = (N-i)/N * 6;
      const ph = (((nowSec()-tBack) % period)/period) * twoPi;
      samples.push(currentVRMS(ph));
    }

    const vmax = Math.max(0.001, parseFloat(amp.value)*1.2, (parseExternalLatest()||0)*1.2);
    ctx.strokeStyle = '#8fb4ff'; ctx.lineWidth = 2;
    ctx.beginPath();
    for(let x=0;x<N;x++){
      const v = samples[x];
      const y = H-30 - (v/vmax)*(H-50);
      if(x===0) ctx.moveTo(x+2,y); else ctx.lineTo(x+2,y);
    }
    ctx.stroke();

    // scan markers
    if(scanMarks.length){
      ctx.strokeStyle = '#7bffb1'; ctx.lineWidth = 1.5;
      scanMarks.forEach(m=>{
        const x = W - ((nowSec()-m.t)/6)*W;
        if(x>=0){
          ctx.beginPath(); ctx.moveTo(x,10); ctx.lineTo(x,H-35); ctx.stroke();
        }
      });
    }
  }

  // ======= Drawing: KPIs =======
  function drawKPIs(v,g){
    vOut.textContent = v.toFixed(6);
    gOut.textContent = g.toExponential(11);
    const err = ((g - G0)/G0)*100;
    const e = isFinite(err)? err.toFixed(3)+'%' : '—';
    errOut.textContent = e;
    const tol = BODY_TOL[bodySel.value] ?? 5.0;
    errOut.className = 'v mono ' + (Math.abs(err)<=tol?'good':Math.abs(err)<=tol*2?'warn':'bad');
  }

  // ======= Drawing: Phase Dial & Clock =======
  function drawPhase(ph){
    const W = phaseDial.width, H = phaseDial.height;
    pctx.clearRect(0,0,W,H);
    const cx=W/2, cy=H/2+10, r=60;

    // dial
    pctx.strokeStyle='#28407f'; pctx.lineWidth=2;
    pctx.beginPath(); pctx.arc(cx,cy,r,0,Math.PI*2); pctx.stroke();

    // ticks
    pctx.strokeStyle='#213067'; pctx.lineWidth=1;
    for(let k=0;k<12;k++){
      const ang=k*(Math.PI/6);
      const tx1=cx + (r-8)*Math.cos(ang - Math.PI/2);
      const ty1=cy + (r-8)*Math.sin(ang - Math.PI/2);
      const tx2=cx + (r)*Math.cos(ang - Math.PI/2);
      const ty2=cy + (r)*Math.sin(ang - Math.PI/2);
      pctx.beginPath(); pctx.moveTo(tx1,ty1); pctx.lineTo(tx2,ty2); pctx.stroke();
    }

    // hand
    pctx.strokeStyle='#8fb4ff'; pctx.lineWidth=3;
    const x=cx + r*Math.cos(ph - Math.PI/2);
    const y=cy + r*Math.sin(ph - Math.PI/2);
    pctx.beginPath(); pctx.moveTo(cx,cy); pctx.lineTo(x,y); pctx.stroke();

    phaseOut.textContent = ph.toFixed(3);
    setCSTClock();
  }

  // ======= Animated Toroid =======
  function drawToroid(ph){
    const W=toroid.width, H=toroid.height;
    tctx.clearRect(0,0,W,H);
    if(!toroidToggle.checked) return;

    const dir = flowDir.value; // 'in' or 'out'
    const blink = parseFloat(blinkSpeed.value);
    const pSpeed = parseFloat(packetSpeed.value);
    const scale = parseFloat(ringScale.value);
    const nArrows = parseInt(arrowCount.value,10);
    const nPackets = parseInt(packetCount.value,10);

    const cx=W/2, cy=H/2;
    const R=110*scale, r=40*scale;

    // Outer ring
    tctx.strokeStyle='#28407f'; tctx.lineWidth=2;
    tctx.beginPath(); tctx.ellipse(cx,cy,R,r,0,0,Math.PI*2); tctx.stroke();

    // inner pulse synced to phase
    const pulse = 0.10*Math.sin(ph*2);
    const Rin = R*(1-0.25+pulse), rin = r*(1-0.25+pulse);
    tctx.beginPath(); tctx.ellipse(cx,cy,Rin,rin,0,0,Math.PI*2); tctx.stroke();

    // Blinking arrows
    const alpha = 0.35 + 0.65*(0.5*(1+Math.sin(ph*blink*2))); // 0.35..1.0
    for(let k=0;k<nArrows;k++){
      const ang = k*(twoPi/nArrows);
      const ax = cx + R*Math.cos(ang);
      const ay = cy + r*Math.sin(ang);
      const baseDir = Math.atan2(cy - ay, cx - ax); // toward center
      const theta = (dir==='in') ? baseDir : baseDir + Math.PI;

      tctx.save();
      tctx.globalAlpha = alpha;
      tctx.translate(ax,ay); tctx.rotate(theta);
      tctx.strokeStyle='#8fb4ff'; tctx.lineWidth=2;
      const len=26*scale;
      tctx.beginPath(); tctx.moveTo(0,0); tctx.lineTo(len,0); tctx.stroke();
      tctx.beginPath();
      tctx.moveTo(len,0); tctx.lineTo(len-6,4); tctx.lineTo(len-6,-4); tctx.closePath(); tctx.stroke();
      tctx.restore();
    }

    // Traveling packets
    const sign = (dir==='in') ? 1 : -1;
    const baseRate = pSpeed * 0.9; // radians/sec
    const t = nowSec();
    for(let j=0;j<nPackets;j++){
      const phaseJ = (j/nPackets)*twoPi;
      const psi = (phaseJ + sign*(t*baseRate)) % twoPi;
      const px = cx + R*Math.cos(psi);
      const py = cy + r*Math.sin(psi);
      const s = 3.0*scale*(1.0+0.2*Math.sin(ph*3 + j));
      tctx.beginPath();
      tctx.fillStyle = '#7bffb1';
      tctx.arc(px,py,s,0,twoPi); tctx.fill();
    }
  }

  // ======= Pass/Fail =======
  function passFail(errPct, bodyName){
    const tol = BODY_TOL[bodyName] ?? 5.0;
    return Math.abs(errPct) <= tol ? 'Pass' : 'Fail';
  }

  // ======= Auto-Scan (10) =======
  function appendScanRow(row){
    // row: {idx,time,body,modeMin,v,g,err,pass}
    const tr = document.createElement('tr');
    const cls = (row.pass==='Pass') ? 'good' : 'bad';
    tr.innerHTML = `
      <td>${row.idx}</td>
      <td class="mono">${row.time}</td>
      <td>${row.body}</td>
      <td class="mono">${row.modeMin.toFixed(2)}</td>
      <td class="mono">${row.v.toFixed(6)}</td>
      <td class="mono">${row.g.toExponential(11)}</td>
      <td class="mono">${row.err.toFixed(3)}%</td>
      <td class="mono ${cls}">${row.pass}</td>
    `;
    scanBody.appendChild(tr);
  }

  function rebuildTable(){
    scanBody.innerHTML = '';
    scanRows.forEach(r=>appendScanRow(r));
  }

  function clearScanAll(){
    scanRows = [];
    scanMarks = [];
    rebuildTable();
    scanStatus.textContent = 'Cleared.';
  }

  async function runAutoScan10(){
    if(isScanning) return;
    isScanning = true;
    scanStatus.textContent = 'Auto-Scan running… (10 samples)';
    scanRows = [];
    scanMarks = [];

    const body = bodySel.value;
    const modeMin = currentEarthModeMinutes();
    const stepMs = 400; // spacing
    for(let i=1;i<=10;i++){
      if(i>1) await new Promise(res=>setTimeout(res, stepMs));
      const ph = phaseNow();
      const v = currentVRMS(ph);
      const g = gFromVRMS(v);
      const err = ((g - G0)/G0)*100;
      const pf = passFail(err, body);
      scanMarks.push({t: nowSec()});
      const row = { idx:i, time:cstTimestamp(), body, modeMin, v, g, err, pass: pf };
      scanRows.push(row);
      appendScanRow(row);
    }
    scanStatus.textContent = 'Auto-Scan complete.';
    isScanning = false;
  }

  function exportCSV(){
    if(!scanRows.length){
      scanStatus.textContent = 'Nothing to export — run Auto-Scan first.';
      return;
    }
    const tol = BODY_TOL[bodySel.value] ?? 5.0;
    const hdr = ['Index','Time_CST','Body','Mode_min','vRMS_m_per_s','G_est_m3kg-1s-2','Delta_vs_G0_percent',`PassFail(|Δ|≤${tol}%)`];
    const lines = [hdr.join(',')];
    scanRows.forEach(r=>{
      lines.push([r.idx, r.time, r.body, r.modeMin.toFixed(2), r.v.toFixed(6), r.g.toExponential(11), r.err.toFixed(3), r.pass].join(','));
    });
    const csv = lines.join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const ts = cstTimestamp().replace(/[: ]/g,'-');
    const fname = `vrms_autoscan_${bodySel.value}_${ts}.csv`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    a.click();
    URL.revokeObjectURL(a.href);
    scanStatus.textContent = `Exported ${fname}`;
  }

  // ======= Animation loop =======
  let rafId=null, fallbackId=null;
  function loop(){
    if(!running){ rafId = requestAnimationFrame(loop); return; }
    const ph = phaseNow();
    const v = currentVRMS(ph);
    const g = gFromVRMS(v);

    drawWave();
    drawKPIs(v,g);
    drawPhase(ph);
    drawToroid(ph);

    rafId = requestAnimationFrame(loop);
  }
  function start(){
    if(rafId==null) rafId = requestAnimationFrame(loop);
    if(fallbackId==null){
      fallbackId = setInterval(()=>{/* keep UI alive if rAF throttles */}, 600);
    }
  }

  // ======= Events =======
  scan10.onclick = runAutoScan10;
  clearScan.onclick = clearScanAll;
  exportCsvBtn.onclick = exportCSV;

  pauseBtn.onclick = ()=>{ running=false; pauseBtn.disabled=true; resumeBtn.disabled=false; };
  resumeBtn.onclick = ()=>{ running=true; resumeBtn.disabled=true; pauseBtn.disabled=false; };

  [bodySel, modeSel, modeCustom].forEach(el=> el.addEventListener('input', updatePeriodUI));
  periodFine.oninput = updatePeriodUI;

  extData.addEventListener('input', extRefresh);
  extEnable.addEventListener('change', extRefresh);

  // ======= Init =======
  updatePeriodUI();
  extRefresh();
  setCSTClock();
  start();
})();
</script>
</body>
</html>
