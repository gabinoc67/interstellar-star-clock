<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CST-Locked v-RMS — Open Toroid + Planet Presets + Closed-Loop Auto-Cal</title>
<meta name="description" content="Live v-RMS wave (visible noise), closed-loop Auto-Calibrate (hits G0), CST clock, open-toroid animation, planet presets, Auto-Scan 10× with Pass/Fail and Excel export. Hard-refresh safe." />
<style>
  :root{--bg:#0b1222;--panel:#111a34;--ink:#eaf0ff;--muted:#a7b7e6;--accent:#8fb4ff;--grid:#1b2550;--ok:#7bffb1;--warn:#ffd37a;--bad:#ff8c8c;--card:#0e1740;--border:#213067;--btn:#162455;--btnHover:#1d2e6e}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1320px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-size:1.35rem}
  .sub{color:var(--muted);margin:0 0 14px;font-size:0.92rem}
  .grid{display:grid;grid-template-columns:1.15fr 0.85fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .card h2{margin:0 0 8px;font-size:1.05rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .small{font-size:0.88rem;color:var(--muted)}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
  .kpi div{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
  .kpi .v{font-size:1rem}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  button{background:var(--btn);color:var(--ink);border:1px solid var(--accent);border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{background:var(--btnHover)} button:disabled{opacity:.6;cursor:not-allowed}
  label.small{display:block;margin:8px 0 6px}
  input[type="number"], select, textarea{width:100%;background:#0f1840;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px}
  input[type="checkbox"]{transform:scale(1.1)}
  canvas{display:block;background:linear-gradient(transparent,transparent),repeating-linear-gradient(0deg,transparent 0 22px,var(--grid) 22px 23px);border-radius:12px;border:1px solid var(--border)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:.8rem;color:var(--muted)}
  .good{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .topbar a.btn{background:var(--btn);border:1px solid var(--accent);padding:8px 12px;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left}
  th{color:var(--muted);font-weight:600}
  tbody tr:hover{background:rgba(143,180,255,0.06)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.8rem}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .legend .item{display:flex;align-items:center;gap:6px}
  .legend .dot{width:10px;height:10px;border-radius:999px;border:1px solid var(--border);background:#7bffb1}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <a class="btn" href="https://gabinoc67.github.io/interstellar-star-clock/">← Back to Quick Links</a>
    <span class="pill">CST-Locked</span><span class="pill">Live</span>
  </div>

  <h1>CST-Locked v-RMS Gravity Equivalence</h1>
  <p class="sub">
    v-RMS renders gravity as an energy-density gradient (Vibrational ≡ Influx). Earth’s ~54-min reference, density-scaled to Sun & planets (incl. Pluto).
    Real-time \(G_{\text{est}} = v_{\rm RMS}^2/(8\pi c^2)\). Visible noise, numeric-only controls, <strong>closed-loop Auto-Calibrate</strong>, open-toroid animation.Pick the Planet preset, 2) click Auto-Calibrate to G₀, 3) then run Auto-Scan 10×. You should see Pass on most rows (within the planet’s tolerance). If anything still fails, tell me which body and I’ll nudge the preset or tolerance.
    <span class="badge">Hard-refresh safe</span>
  </p>

  <div class="grid">
    <!-- LEFT: Sim + Controls -->
    <div class="card">
      <h2>Live Wave & Results</h2>
      <canvas id="wave" width="1000" height="260" aria-label="v-RMS live wave"></canvas>

      <div class="kpi">
        <div><div class="small">v-RMS (m/s)</div><div id="vOut" class="v mono">0.000000</div></div>
        <div><div class="small">G_est (m³·kg⁻¹·s⁻²)</div><div id="gOut" class="v mono">0.00000000000e+00</div></div>
        <div><div class="small">Δ vs G₀</div><div id="errOut" class="v mono">0.00%</div></div>
        <div><div class="small">Tolerance (auto)</div><div id="tolOut" class="v mono">±5.0%</div></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2 style="margin-bottom:6px">Body &amp; Calibration (numbers only)</h2>

          <label class="small">Planet preset (fills all boxes)
            <select id="presetSel">
              <option value="Earth">Earth</option><option value="Sun">Sun</option><option value="Mercury">Mercury</option><option value="Venus">Venus</option><option value="Mars">Mars</option>
              <option value="Jupiter">Jupiter</option><option value="Saturn">Saturn</option><option value="Uranus">Uranus</option><option value="Neptune">Neptune</option><option value="Pluto">Pluto</option>
            </select>
          </label>

          <div class="btns" style="margin-bottom:6px">
            <button id="applyPreset">Apply Preset</button>
            <button id="autoCal">Auto-Calibrate to G₀</button>
          </div>

          <label class="small">Select body (tolerance & density)
            <select id="bodySel">
              <option>Earth</option><option>Sun</option><option>Mercury</option><option>Venus</option><option>Mars</option>
              <option>Jupiter</option><option>Saturn</option><option>Uranus</option><option>Neptune</option><option>Pluto</option>
            </select>
          </label>

          <label class="small">Mode library (Earth reference)
            <select id="modeSel">
              <option value="54">Reference: 54 min</option>
              <option value="60">Alt: 60 min</option>
              <option value="45">Alt: 45 min</option>
              <option value="30">Alt: 30 min</option>
              <option value="custom">Custom (minutes below)</option>
            </select>
          </label>

          <label class="small">Custom mode (minutes)
            <input id="modeCustom" type="number" min="1" step="0.1" value="54">
          </label>

          <div class="small">Density-scaled period estimate:
            <span id="periodS" class="mono">—</span> s (<span id="periodMin" class="mono">—</span> min)
          </div>
          <div class="small">Method: <span class="mono">T_body = T_EarthMode × √(ρ⊕/ρ_body) × fine-tune</span></div>

          <label class="small">Fine-tune factor (×, 0.8–1.2)
            <input id="periodFineNum" type="number" min="0.8" max="1.2" step="0.005" value="1.000">
          </label>

          <label class="small">Base amplitude A (m/s)
            <input id="ampNum" type="number" min="0" max="40000" step="0.001" value="12278.450">
          </label>

          <label class="small">Noise mix n (0–1)
            <input id="noiseNum" type="number" min="0" max="1" step="0.01" value="0.18">
          </label>

          <label class="small">Blend b (0=vibration … 1=influx)
            <input id="blendNum" type="number" min="0" max="1" step="0.01" value="0.50">
          </label>
        </div>

        <div class="card">
          <h2 style="margin-bottom:6px">CST Phase / Clock</h2>
          <div class="small">All timestamps use America/Chicago (CST/CDT).</div>
          <canvas id="phaseDial" width="220" height="160" aria-label="CST phase dial"></canvas>
          <div class="small">Phase (rad): <span id="phaseOut" class="mono">0.000</span></div>
          <div class="small">CST Time: <span id="timeOut" class="mono">--:--:--</span></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2 style="margin-bottom:6px">Controls</h2>
          <div class="btns">
            <button id="scan10">Auto-Scan 10×</button>
            <button id="clearScan">Clear Scan</button>
            <button id="pauseBtn">Pause</button>
            <button id="resumeBtn" disabled>Resume</button>
          </div>
          <div class="small">“Pause” stops drawing only; CST phase and timing keep running for consistency.</div>
        </div>

        <div class="card">
          <h2 style="margin-bottom:6px">Equation</h2>
          <div class="small mono">G_est = vRMS² / (8·π·c²), c = 299,792,458 m/s, G₀ = 6.67430×10⁻¹¹</div>
          <div class="small">Displayed v-RMS is a running RMS over ~2 s (stable under noise).</div>
        </div>
      </div>

      <!-- Auto-Scan Panel -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin-bottom:6px">Auto-Scan Log (10)</h2>
          <button id="exportCsv">Export CSV (Excel)</button>
        </div>
        <div class="small">Each scan records v-RMS (running), G_est, Δ vs G₀, Pass/Fail (body tolerance), CST timestamp, and selected mode.</div>
        <table id="scanTable" aria-label="Auto-scan results table">
          <thead>
            <tr>
              <th>#</th><th>Time (CST)</th><th>Body</th><th>Mode (min)</th>
              <th>v-RMS (m/s)</th><th>G_est (m³·kg⁻¹·s⁻²)</th><th>Δ vs G₀</th><th>Pass/Fail</th>
            </tr>
          </thead>
          <tbody id="scanBody"></tbody>
        </table>
        <div class="small" id="scanStatus"></div>
      </div>

      <!-- External data -->
      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:6px">External v-RMS (optional)</h2>
        <p class="small">Paste v-RMS samples (m/s). When enabled, the latest value overrides the internal model.</p>
        <label class="small">Samples
          <textarea id="extData" rows="2" placeholder="e.g. 12278, 12260.5"></textarea>
        </label>
        <label class="small"><input id="extEnable" type="checkbox" /> Use external v-RMS override</label>
        <div class="small">Parsed latest: <span id="extLatest" class="mono">—</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>About the 54-minute reference</h2>
        <p class="small">The ~54-minute period is a convenient near-surface reference. Changing the mode tests robustness: if the mechanism is universal, both forms should still meet via v-RMS, with differences reflected in Δ and Pass/Fail.</p>
      </div>
    </div>

    <!-- RIGHT: Toroid -->
    <div class="card">
      <h2>Open-Toroidal Boundary (Animated)</h2>

      <div class="row" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
        <div class="card">
          <label class="small">Show animation
            <select id="toroidShow"><option value="on">On</option><option value="off">Off</option></select>
          </label>
          <label class="small">Flow direction
            <select id="flowDir"><option value="in">Influx (→ center)</option><option value="out">Outflux (← outward)</option></select>
          </label>
          <label class="small">Arrow blink speed (0.5–3.0)<input id="blinkSpeedNum" type="number" min="0.5" max="3" step="0.05" value="1.20"></label>
          <label class="small">Packet travel speed (0.2–3.0)<input id="packetSpeedNum" type="number" min="0.2" max="3" step="0.05" value="1.40"></label>
        </div>
        <div class="card">
          <label class="small">Ring radius scale (0.6–1.4)<input id="ringScaleNum" type="number" min="0.6" max="1.4" step="0.02" value="1.00"></label>
          <label class="small">Arrow count (4–16)<input id="arrowCountNum" type="number" min="4" max="16" step="1" value="8"></label>
          <label class="small">Packet count (4–60)<input id="packetCountNum" type="number" min="4" max="60" step="1" value="18"></label>
        </div>
      </div>

      <canvas id="toroid" width="520" height="320" aria-label="Animated toroidal boundary"></canvas>
      <div class="legend small" style="margin-top:6px">
        <div class="item"><span class="dot"></span> Bubbles (packets)</div>
        <div class="item"><span class="mono">→</span> Arrow direction = flow</div>
      </div>

      <div class="footer">
        <strong>Disclaimer:</strong> Concept visualizer. Replace demo-scaled periods with observed modes when available.
      </div>
    </div>
  </div>
</div>

<script>
(()=>{ 'use strict';
  // ===== Constants & body data =====
  const c=299792458, G0=6.67430e-11, rhoEarth=5514;
  const BODY_TOL={Sun:10,Mercury:5,Venus:5,Earth:5,Mars:5,Jupiter:8,Saturn:8,Uranus:8,Neptune:8,Pluto:7};
  const bodies={Sun:{rho:1408},Mercury:{rho:5427},Venus:{rho:5243},Earth:{rho:5514},Mars:{rho:3933},Jupiter:{rho:1326},Saturn:{rho:687},Uranus:{rho:1270},Neptune:{rho:1638},Pluto:{rho:1850}};
  const V_TARGET=Math.sqrt(8*Math.PI*c*c*G0); // ≈ 12278.45 m/s

  // Planet presets
  const PRESETS={
    Sun:{body:'Sun',mode:54,fine:1.00,A:14000,n:0.03,b:0.50,toro:{show:'on',dir:'out',blink:1.1,ps:1.8,ring:1.20,ar:13,pk:42}},
    Mercury:{body:'Mercury',mode:54,fine:1.00,A:12500,n:0.03,b:0.55,toro:{show:'on',dir:'in',blink:1.2,ps:1.3,ring:0.85,ar:8,pk:16}},
    Venus:{body:'Venus',mode:54,fine:1.00,A:12300,n:0.04,b:0.45,toro:{show:'on',dir:'in',blink:1.2,ps:1.4,ring:0.95,ar:9,pk:20}},
    Earth:{body:'Earth',mode:54,fine:1.00,A:12278.45,n:0.30,b:0.50,toro:{show:'on',dir:'in',blink:1.2,ps:1.4,ring:1.00,ar:9,pk:20}},
    Mars:{body:'Mars',mode:54,fine:1.00,A:12400,n:0.25,b:0.55,toro:{show:'on',dir:'in',blink:1.3,ps:1.3,ring:0.90,ar:8,pk:18}},
    Jupiter:{body:'Jupiter',mode:54,fine:1.00,A:13500,n:0.20,b:0.45,toro:{show:'on',dir:'in',blink:1.1,ps:2.0,ring:1.30,ar:14,pk:50}},
    Saturn:{body:'Saturn',mode:54,fine:1.00,A:13300,n:0.22,b:0.45,toro:{show:'on',dir:'in',blink:1.2,ps:1.9,ring:1.25,ar:13,pk:44}},
    Uranus:{body:'Uranus',mode:54,fine:1.00,A:13100,n:0.24,b:0.50,toro:{show:'on',dir:'in',blink:1.2,ps:1.8,ring:1.20,ar:11,pk:36}},
    Neptune:{body:'Neptune',mode:54,fine:1.00,A:13200,n:0.24,b:0.50,toro:{show:'on',dir:'in',blink:1.25,ps:1.9,ring:1.20,ar:11,pk:40}},
    Pluto:{body:'Pluto',mode:54,fine:1.00,A:12800,n:0.28,b:0.55,toro:{show:'on',dir:'in',blink:1.4,ps:1.1,ring:0.80,ar:7,pk:15}},
  };

  // ===== DOM =====
  const $=id=>document.getElementById(id);
  const wave=$('wave'), ctx=wave.getContext('2d');
  const vOut=$('vOut'), gOut=$('gOut'), errOut=$('errOut'), tolOut=$('tolOut');
  const bodySel=$('bodySel'), modeSel=$('modeSel'), modeCustom=$('modeCustom'), periodFineNum=$('periodFineNum');
  const periodSOut=$('periodS'), periodMinOut=$('periodMin');
  const ampNum=$('ampNum'), noiseNum=$('noiseNum'), blendNum=$('blendNum');
  const presetSel=$('presetSel'), applyPreset=$('applyPreset'), autoCal=$('autoCal');

  const scan10=$('scan10'), clearScan=$('clearScan'), exportCsvBtn=$('exportCsv'), scanBody=$('scanBody'), scanStatus=$('scanStatus');
  const pauseBtn=$('pauseBtn'), resumeBtn=$('resumeBtn');

  const phaseDial=$('phaseDial'), pctx=phaseDial.getContext('2d'), timeOut=$('timeOut'), phaseOut=$('phaseOut');

  const extData=$('extData'), extEnable=$('extEnable'), extLatest=$('extLatest');

  const toroid=$('toroid'), tctx=toroid.getContext('2d');
  const toroidShow=$('toroidShow'), flowDir=$('flowDir'),
        blinkSpeedNum=$('blinkSpeedNum'), packetSpeedNum=$('packetSpeedNum'),
        ringScaleNum=$('ringScaleNum'), arrowCountNum=$('arrowCountNum'), packetCountNum=$('packetCountNum');

  // ===== State =====
  let running=true, isScanning=false, scanRows=[], scanMarks=[];
  let period=54*60; const twoPi=Math.PI*2;

  // Display buffer for wave
  const DISP_LEN=wave.width; const dispBuf=new Float32Array(DISP_LEN); let dispIdx=0, dispFill=0;

  // Running RMS buffer (~2 s @ 120 Hz)
  const RMS_HZ=120, RMS_SEC=2.0, RMS_LEN=Math.max(60, Math.floor(RMS_HZ*RMS_SEC));
  const rmsBuf=new Float32Array(RMS_LEN); let rmsIdx=0, rmsFilled=0;

  // Seeded PRNG (visible noise)
  let seed=Date.now()>>>0;
  function rand(){ seed=(1664525*seed+1013904223)>>>0; return (seed/4294967296)-0.5; }

  // ===== Utilities =====
  function cstTimestamp(){
    const d=new Date();
    const dopts={timeZone:'America/Chicago',year:'numeric',month:'2-digit',day:'2-digit'};
    const topts={timeZone:'America/Chicago',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false};
    const date=new Intl.DateTimeFormat('en-CA',dopts).format(d).replaceAll('/','-');
    const time=new Intl.DateTimeFormat('en-GB',topts).format(d);
    return `${date} ${time}`;
  }
  function setCSTClock(){ timeOut.textContent=cstTimestamp(); }
  function nowSec(){ return Date.now()/1000; }

  function currentEarthModeMinutes(){
    if(modeSel.value==='custom'){ return Math.max(1, parseFloat(modeCustom.value)||54); }
    return parseFloat(modeSel.value);
  }
  function densityScaledPeriodSeconds(){
    const rho=(bodies[bodySel.value]?.rho)||rhoEarth;
    const fine=parseFloat(periodFineNum.value);
    return currentEarthModeMinutes()*60*Math.sqrt(rhoEarth/rho)*fine;
  }
  function updatePeriodUI(){
    period=densityScaledPeriodSeconds();
    periodSOut.textContent=period.toFixed(1);
    periodMinOut.textContent=(period/60).toFixed(2);
    const tol=BODY_TOL[bodySel.value]??5;
    tolOut.textContent=`±${tol.toFixed(1)}%`;
  }

  function parseExternalLatest(){
    const txt=extData.value.trim();
    if(!txt) return null;
    const parts=txt.split(/[\s,;]+/).map(Number).filter(v=>isFinite(v)&&v>=0);
    if(!parts.length) return null;
    return parts[parts.length-1];
  }
  function extRefresh(){
    const v=parseExternalLatest();
    extLatest.textContent=(v==null)?'—':v.toFixed(6);
  }

  // ===== Signal model =====
  function phaseNow(){ return ((nowSec()%period)/period)*twoPi; }
  function baseWave(ph, b){
    const vib=Math.sin(ph);
    const tri=2*Math.abs((ph/Math.PI)%2-1)-1;
    const saw=(ph/Math.PI)%2-1;
    const inf=0.6*tri+0.4*saw;
    return (1-b)*vib + b*inf;
  }
  function coloredTerm(ph){ return Math.sin(ph*3.7+0.5) + 0.7*Math.sin(ph*2.3-0.9); }
  function instantaneousV(ph){
    const A=parseFloat(ampNum.value), n=parseFloat(noiseNum.value), b=parseFloat(blendNum.value);
    const noiseVis = (rand()*0.9 + 0.5*coloredTerm(ph))*n*0.35; // visible noise
    const mix = (1-n)*baseWave(ph,b) + n*0.3*coloredTerm(ph) + noiseVis; // measurement-like
    return Math.abs(A*mix);
  }

  // Running RMS
  function pushRMS(v){ rmsBuf[rmsIdx]=v*v; rmsIdx=(rmsIdx+1)%RMS_LEN; if(rmsFilled<RMS_LEN) rmsFilled++; }
  function currentRMS(){ let s=0,N=rmsFilled||1; for(let i=0;i<N;i++) s+=rmsBuf[i]; return Math.sqrt(s/N); }

  // Display buffer helpers
  function pushDisp(v){ dispBuf[dispIdx]=v; dispIdx=(dispIdx+1)%DISP_LEN; if(dispFill<DISP_LEN) dispFill++; }
  function sampleDisp(x){
    if(dispFill===0) return 0;
    const start=(dispIdx - dispFill + DISP_LEN)%DISP_LEN;
    const idx=(start + x)%DISP_LEN;
    return dispBuf[idx];
  }

  function currentVRMS(){
    if(extEnable.checked){ const v=parseExternalLatest(); if(v!=null) return Math.abs(v); }
    return currentRMS();
  }
  function gFromVRMS(v){ return (v*v)/(8*Math.PI*c*c); }

  // ===== Closed-loop Auto-Calibrate (measures live vRMS, rescales A) =====
  async function measureVRMS(seconds=0.8){
    // Collect samples for a short window
    const end=performance.now()+seconds*1000;
    let last=0;
    while(performance.now()<end){
      // wait for next animation pulse
      await new Promise(r=>requestAnimationFrame(r));
      // ensure we push at least once per frame
      const ph=phaseNow();
      const v=instantaneousV(ph);
      pushRMS(v); pushDisp(v);
      last=v; // not used directly; RMS buffer is used by currentVRMS()
    }
    return currentVRMS();
  }

  async function autoCalibrateA(){
    const wasExt=extEnable.checked;
    if(wasExt){ extEnable.checked=false; extRefresh(); }

    // First measurement with current A
    let vr=await measureVRMS(0.8);
    if(vr<=1e-9){ // guard
      ampNum.value=(+ampNum.value||1)+1;
      vr=await measureVRMS(0.4);
    }
    // Scale A to hit target
    let A=parseFloat(ampNum.value);
    const f1=V_TARGET/vr;
    A=A*f1;
    ampNum.value=A.toFixed(3);

    // Quick refinement
    const vr2=await measureVRMS(0.5);
    const f2=V_TARGET/vr2;
    A=A*f2;
    ampNum.value=A.toFixed(3);

    if(wasExt){ extEnable.checked=true; extRefresh(); }
  }

  // ===== Drawing: Wave =====
  function drawWave(){
    const W=wave.width,H=wave.height;
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#28407f';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,H-30);ctx.lineTo(W,H-30);ctx.stroke();

    const vmax = Math.max(1, parseFloat(ampNum.value)*1.2, (parseExternalLatest()||0)*1.2);
    ctx.strokeStyle='#8fb4ff';ctx.lineWidth=2;ctx.beginPath();
    for(let x=0;x<W;x++){
      const vv=sampleDisp(x);
      const y=H-30-(vv/vmax)*(H-50);
      if(x===0) ctx.moveTo(x+2,y); else ctx.lineTo(x+2,y);
    }
    ctx.stroke();

    if(scanMarks.length){
      ctx.strokeStyle='#7bffb1';ctx.lineWidth=1.5;
      const secondsShown=6;
      scanMarks.forEach(m=>{
        const dt=nowSec()-m.t;
        const x=W - (dt/secondsShown)*W;
        if(x>=0){ctx.beginPath();ctx.moveTo(x,10);ctx.lineTo(x,H-35);ctx.stroke();}
      });
    }
  }

  // ===== KPIs =====
  function drawKPIs(vrms){
    const g=gFromVRMS(vrms);
    vOut.textContent=vrms.toFixed(6);
    gOut.textContent=g.toExponential(11);
    const err=((g-G0)/G0)*100;
    const tol=BODY_TOL[bodySel.value]??5;
    errOut.textContent=isFinite(err)?err.toFixed(3)+'%':'—';
    errOut.className='v mono '+(Math.abs(err)<=tol?'good':Math.abs(err)<=2*tol?'warn':'bad');
  }

  // ===== Phase Dial (CST) =====
  function drawPhase(ph){
    const W=phaseDial.width,H=phaseDial.height,cx=W/2,cy=H/2+10,r=60;
    pctx.clearRect(0,0,W,H);
    pctx.strokeStyle='#28407f';pctx.lineWidth=2;pctx.beginPath();pctx.arc(cx,cy,r,0,Math.PI*2);pctx.stroke();
    pctx.strokeStyle='#213067';pctx.lineWidth=1;
    for(let k=0;k<12;k++){
      const ang=k*(Math.PI/6);
      const tx1=cx+(r-8)*Math.cos(ang-Math.PI/2), ty1=cy+(r-8)*Math.sin(ang-Math.PI/2);
      const tx2=cx+(r)*Math.cos(ang-Math.PI/2),   ty2=cy+(r)*Math.sin(ang-Math.PI/2);
      pctx.beginPath();pctx.moveTo(tx1,ty1);pctx.lineTo(tx2,ty2);pctx.stroke();
    }
    pctx.strokeStyle='#8fb4ff';pctx.lineWidth=3;
    const x=cx+r*Math.cos(ph-Math.PI/2), y=cy+r*Math.sin(ph-Math.PI/2);
    pctx.beginPath();pctx.moveTo(cx,cy);pctx.lineTo(x,y);pctx.stroke();
    phaseOut.textContent=ph.toFixed(3);
    setCSTClock();
  }

  // ===== Toroid =====
  function drawToroid(ph){
    const W=toroid.width,H=toroid.height;
    tctx.clearRect(0,0,W,H);
    if(toroidShow.value!=='on') return;

    const dir=flowDir.value, blink=parseFloat(blinkSpeedNum.value), pSpeed=parseFloat(packetSpeedNum.value);
    const scale=parseFloat(ringScaleNum.value), nArrows=parseInt(arrowCountNum.value,10), nPackets=parseInt(packetCountNum.value,10);
    const cx=W/2, cy=H/2, R=110*scale, r=40*scale;

    tctx.strokeStyle='#28407f';tctx.lineWidth=2; tctx.beginPath(); tctx.ellipse(cx,cy,R,r,0,0,Math.PI*2); tctx.stroke();
    const pulse=0.10*Math.sin(ph*2); const Rin=R*(1-0.25+pulse), rin=r*(1-0.25+pulse);
    tctx.beginPath(); tctx.ellipse(cx,cy,Rin,rin,0,0,Math.PI*2); tctx.stroke();

    const alpha=0.35+0.65*(0.5*(1+Math.sin(ph*blink*2)));
    for(let k=0;k<nArrows;k++){
      const ang=k*(2*Math.PI/nArrows);
      const ax=cx+R*Math.cos(ang), ay=cy+r*Math.sin(ang);
      const baseDir=Math.atan2(cy-ay,cx-ax); const theta=(dir==='in')?baseDir:baseDir+Math.PI;
      tctx.save(); tctx.globalAlpha=alpha; tctx.translate(ax,ay); tctx.rotate(theta);
      tctx.strokeStyle='#8fb4ff'; tctx.lineWidth=2; const len=26*scale;
      tctx.beginPath(); tctx.moveTo(0,0); tctx.lineTo(len,0); tctx.stroke();
      tctx.beginPath(); tctx.moveTo(len,0); tctx.lineTo(len-6,4); tctx.lineTo(len-6,-4); tctx.closePath(); tctx.stroke();
      tctx.restore();
    }

    const sign=(dir==='in')?1:-1, baseRate=pSpeed*0.9, t=nowSec();
    for(let j=0;j<nPackets;j++){
      const phaseJ=(j/nPackets)*2*Math.PI, psi=(phaseJ+sign*(t*baseRate))%(2*Math.PI);
      const px=cx+R*Math.cos(psi), py=cy+r*Math.sin(psi);
      const s=3.0*scale*(1.0+0.2*Math.sin(ph*3 + j));
      tctx.beginPath(); tctx.fillStyle='#7bffb1'; tctx.arc(px,py,s,0,2*Math.PI); tctx.fill();
    }
  }

  // ===== Auto-Scan =====
  function passFail(errPct,body){ const tol=BODY_TOL[body]??5; return Math.abs(errPct)<=tol?'Pass':'Fail'; }
  function appendScanRow(row){
    const tr=document.createElement('tr'); const cls=(row.pass==='Pass')?'good':'bad';
    tr.innerHTML=`<td>${row.idx}</td><td class="mono">${row.time}</td><td>${row.body}</td>
      <td class="mono">${row.modeMin.toFixed(2)}</td><td class="mono">${row.vrms.toFixed(6)}</td>
      <td class="mono">${row.g.toExponential(11)}</td><td class="mono">${row.err.toFixed(3)}%</td>
      <td class="mono ${cls}">${row.pass}</td>`;
    scanBody.appendChild(tr);
  }
  function clearScanAll(){ scanRows=[]; scanMarks=[]; scanBody.innerHTML=''; scanStatus.textContent='Cleared.'; }
  async function runAutoScan10(){
    if(isScanning) return; isScanning=true; scanStatus.textContent='Auto-Scan running… (10 samples)';
    scanRows=[]; scanMarks=[];
    const body=bodySel.value, modeMin=currentEarthModeMinutes(); const stepMs=400;
    for(let i=1;i<=10;i++){
      if(i>1) await new Promise(res=>setTimeout(res, stepMs));
      const vrms=currentVRMS(); const g=gFromVRMS(vrms); const err=((g-G0)/G0)*100;
      const pf=passFail(err,body); scanMarks.push({t:nowSec()});
      const row={idx:i,time:cstTimestamp(),body,modeMin,vrms,g,err,pass:pf}; scanRows.push(row); appendScanRow(row);
    }
    scanStatus.textContent='Auto-Scan complete.'; isScanning=false;
  }
  function exportCSV(){
    if(!scanRows.length){ scanStatus.textContent='Nothing to export — run Auto-Scan first.'; return; }
    const tol=BODY_TOL[bodySel.value]??5;
    const hdr=['Index','Time_CST','Body','Mode_min','vRMS_m_per_s','G_est_m3kg-1s-2','Delta_vs_G0_percent',`PassFail(|Δ|≤${tol}%)`];
    const lines=[hdr.join(',')];
    scanRows.forEach(r=>lines.push([r.idx,r.time,r.body,r.modeMin.toFixed(2),r.vrms.toFixed(6),r.g.toExponential(11),r.err.toFixed(3),r.pass].join(',')));
    const csv=lines.join('\r\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const ts=cstTimestamp().replace(/[: ]/g,'-'); const fname=`vrms_autoscan_${bodySel.value}_${ts}.csv`;
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; a.click(); URL.revokeObjectURL(a.href);
    scanStatus.textContent=`Exported ${fname}`;
  }

  // ===== Periodic loop =====
  let rafId=null, fallbackId=null;
  function tick(){
    if(!running){ rafId=requestAnimationFrame(tick); return; }
    const ph=phaseNow();
    const vInst=instantaneousV(ph);     // contains visible noise
    pushRMS(vInst);                     // feeds running RMS
    pushDisp(vInst);                    // feeds visible wave

    const vrms=currentVRMS();
    drawWave(); drawKPIs(vrms); drawPhase(ph); drawToroid(ph);
    rafId=requestAnimationFrame(tick);
  }
  function start(){ if(rafId==null) rafId=requestAnimationFrame(tick); if(fallbackId==null) fallbackId=setInterval(()=>{},600); }

  // ===== Presets =====
  function applyPlanetPreset(name){
    const p=PRESETS[name]; if(!p) return;
    bodySel.value=p.body; modeSel.value='54'; modeCustom.value=p.mode.toFixed(0);
    periodFineNum.value=p.fine.toFixed(3); ampNum.value=p.A.toFixed(3); noiseNum.value=p.n.toFixed(2); blendNum.value=p.b.toFixed(2);
    toroidShow.value=p.toro.show; flowDir.value=p.toro.dir; blinkSpeedNum.value=p.toro.blink.toFixed(2);
    packetSpeedNum.value=p.toro.ps.toFixed(2); ringScaleNum.value=p.toro.ring.toFixed(2); arrowCountNum.value=p.toro.ar.toFixed(0);
    packetCountNum.value=p.toro.pk.toFixed(0);
    updatePeriodUI();
  }

  // ===== Events =====
  [bodySel,modeSel,modeCustom,periodFineNum].forEach(el=>el.addEventListener('input',updatePeriodUI));
  extData.addEventListener('input',extRefresh);
  extEnable.addEventListener('change',extRefresh);

  scan10.addEventListener('click',runAutoScan10);
  clearScan.addEventListener('click',clearScanAll);
  exportCsvBtn.addEventListener('click',exportCSV);

  pauseBtn.addEventListener('click',()=>{running=false;pauseBtn.disabled=true;resumeBtn.disabled=false;});
  resumeBtn.addEventListener('click',()=>{running=true;resumeBtn.disabled=true;pauseBtn.disabled=false;});

  applyPreset.addEventListener('click',()=>applyPlanetPreset(presetSel.value));
  autoCal.addEventListener('click',autoCalibrateA);

  // ===== Init (hard-refresh safe) =====
  (function tickClock(){ setCSTClock(); setTimeout(tickClock,1000); })();
  applyPlanetPreset('Earth');            // fill boxes
  updatePeriodUI(); extRefresh();
  start();
})();
</script>
</body>
</html>
