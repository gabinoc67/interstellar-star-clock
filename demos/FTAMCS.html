<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST–FTAMCS Unified Engine Simulation v7 – Thin-Film Lattice Cone</title>
<style>
  :root{
    --bg:#0b1222;
    --panel:#121a33;
    --ink:#edf2ff;
    --muted:#a1b4ea;
    --accent:#8fb4ff;
    --grid:#1b2550;
    --good:#7bffb1;
    --warn:#ffd37a;
    --bad:#ff8c8c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    font-size:15px;
  }
  .wrap{
    max-width:1300px;
    margin:0 auto;
    padding:16px;
  }
  h1{
    margin:4px 0 14px;
    font-size:1.7rem;
  }
  h2{
    margin:0 0 10px;
    font-size:1.15rem;
    color:var(--muted);
  }
  .grid{
    display:grid;
    grid-template-columns:minmax(0, 420px) minmax(0, 1fr);
    gap:16px;
    align-items:flex-start;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--grid);
    border-radius:14px;
    padding:14px 16px;
    margin-bottom:12px;
  }
  label{
    font-size:0.9rem;
    color:var(--muted);
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:4px 0 8px;
    gap:8px;
    flex-wrap:wrap;
  }
  input[type="number"], input[type="range"], select{
    width:100%;
    padding:5px 7px;
    border-radius:6px;
    border:1px solid #24325a;
    background:#0c1328;
    color:var(--ink);
    font-size:0.9rem;
  }
  input[type="range"]{padding:0;}
  select{background:#0c1328;}
  .small{
    font-size:0.85rem;
    color:var(--muted);
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:0.78rem;
    margin-left:6px;
    border:1px solid var(--grid);
  }
  .tag-good{border-color:var(--good);color:var(--good);}
  .tag-warn{border-color:var(--warn);color:var(--warn);}
  .tag-bad{border-color:var(--bad);color:var(--bad);}
  .kpi{
    margin:5px 0;
    font-size:0.95rem;
  }
  .kpi span.label{
    color:var(--muted);
  }
  .kpi span.value{
    font-weight:600;
  }
  .status-box{
    margin-top:6px;
    padding:8px 10px;
    border-radius:10px;
    font-size:0.88rem;
    background:#101735;
    border:1px solid #222f5b;
  }
  .status-title{
    text-transform:uppercase;
    letter-spacing:0.08em;
    font-size:0.72rem;
    color:var(--muted);
    margin-bottom:4px;
  }
  .bubble-row{
    display:flex;
    justify-content:space-between;
    gap:6px;
    margin-top:8px;
    flex-wrap:wrap;
  }
  .bubble{
    flex:1 1 120px;
    padding:6px 8px;
    border-radius:10px;
    background:#111a3a;
    border:1px solid #202c55;
    font-size:0.8rem;
  }
  .bubble strong{
    display:block;
    font-size:0.8rem;
    color:var(--muted);
    margin-bottom:2px;
  }
  .meter{
    width:100%;
    height:9px;
    border-radius:999px;
    background:#091024;
    overflow:hidden;
    margin-top:4px;
  }
  .meter-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--bad),var(--warn),var(--good));
  }

  /* Generic layout helpers */
  .two-col{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .subgrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    margin-top:8px;
  }

  /* Triple row for the three side-by-side panels */
  .triple-row{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:8px;
    margin-bottom:12px;
  }
  @media (max-width:1100px){
    .grid{
      grid-template-columns:1fr;
    }
    .triple-row{
      grid-template-columns:1fr;
    }
  }

  /* Engine strip */
  .engine-strip{
    width:100%;
    height:14px;
    border-radius:999px;
    background:#090f20;
    border:1px solid #28335c;
    overflow:hidden;
    margin:6px 0 4px;
  }
  .engine-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#44c7ff,#7bffb1);
    transition:width 0.2s ease,opacity 0.2s ease;
  }

  /* Cone engine visualization (thrust from inside to tip) */
  .chamber-diagram{
    margin-top:6px;
    font-size:0.8rem;
    text-align:center;
  }
  .cone-engine{
    position:relative;
    margin-top:6px;
  }
  .cone-wrap{
    position:relative;
    height:210px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
  }
  .cone-body{
    position:relative;
    width:0;
    height:0;
    border-left:70px solid transparent;
    border-right:70px solid transparent;
    border-top:150px solid #1b2550;
    filter:drop-shadow(0 0 16px rgba(143,180,255,0.35));
  }
  .cone-core{
    position:absolute;
    left:-36px;
    bottom:10px;
    width:0;
    height:0;
    border-left:36px solid transparent;
    border-right:36px solid transparent;
    border-top:130px solid rgba(143,180,255,0.45);
    filter:blur(1px);
  }
  .thrust-arrow{
    position:absolute;
    left:-2px;
    bottom:60px;
    width:4px;
    height:70px;
    background:linear-gradient(to top,#8fb4ff,#7bffb1);
    border-radius:999px;
    transform-origin:bottom center;
    transition:transform 0.2s ease,opacity 0.2s ease;
  }
  .cone-plume{
    position:absolute;
    left:-15px;
    bottom:-70px;
    width:30px;
    height:70px;
    border-radius:30px;
    background:radial-gradient(circle at 50% 0,#7bffb1,transparent 70%);
    opacity:0.3;
    transform-origin:50% 0;
    transition:transform 0.2s ease,opacity 0.2s ease;
  }
  /* Bright glow at cone tip */
  .cone-glow{
    position:absolute;
    left:-18px;
    bottom:-8px;
    width:36px;
    height:36px;
    border-radius:50%;
    background:radial-gradient(circle,#ffffff,rgba(143,180,255,0.4),transparent 70%);
    opacity:0.2;
    transform:scale(0.7);
    transition:opacity 0.2s ease,transform 0.2s ease;
    pointer-events:none;
  }

  .corridor-overlay{
    position:absolute;
    top:6px;
    left:50%;
    width:180px;
    height:180px;
    transform:translateX(-50%);
    border-radius:50%;
    background:radial-gradient(circle,rgba(143,180,255,0.25),transparent 70%);
    opacity:0;
    pointer-events:none;
    transition:opacity 0.2s ease;
  }
  .corridor-label{
    margin-top:16px;
    font-size:0.78rem;
    color:#9bb7ff;
    text-shadow:0 0 4px #000;
    opacity:0;
    transition:opacity 0.2s ease;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-top:6px;
  }
  .chip{
    font-size:0.78rem;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid #26345e;
    color:var(--muted);
  }
  button{
    border-radius:8px;
    border:1px solid #304070;
    background:#18244a;
    color:var(--ink);
    padding:6px 10px;
    font-size:0.88rem;
    cursor:pointer;
  }
  button:hover{
    background:#1f2e5d;
  }

  /* Environment white box */
  .env-mode{
    width:100%;
    background:#ffffff;
    color:#111633;
    border-radius:8px;
    padding:6px 8px;
    border:1px solid #d0d4ff;
    font-size:0.9rem;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>CST–FTAMCS Unified Engine Simulation v7 – Thin-Film Lattice Cone</h1>

  <div class="grid">
    <!-- LEFT: INPUTS / COMPONENTS -->
    <div>
      <div class="panel">
        <h2>Phase Presets (Concept Roadmap)</h2>
        <div class="row">
          <label for="phasePreset">Select phase</label>
          <select id="phasePreset">
            <option value="1">Phase 1 – FTAMCS Lab Proof</option>
            <option value="2">Phase 2 – CST Timing Added</option>
            <option value="3" selected>Phase 3 – CST–FTAMCS Vacuum Cone</option>
            <option value="4">Phase 4 – Engine Module</option>
            <option value="5">Phase 5 – Engine Array</option>
          </select>
        </div>
        <div class="small">
          Phase 1–5 mirror your real construction path:<br>
          1) FTAMCS proof → 2) CST timing → 3) cone chamber design → 4) engine module → 5) engine array.
        </div>
      </div>

      <div class="panel">
        <h2>Engine Components & Status</h2>

        <div class="row">
          <div>
            <div>FTAMCS microscopic thrust</div>
            <div class="small">Thin-film asymmetric collapse (inside spacecraft)</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="ftamcsReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>CST resonance + timing</div>
            <div class="small">Keeps collapse events phase-locked in time</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="cstReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Vacuum cone geometry</div>
            <div class="small">Internal reaction cone + clean vacuum (no exhaust)</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="vacReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Real propulsion engine</div>
            <div class="small">All components integrated (simulation only)</div>
          </div>
          <div>
            <span id="engineStateTag" class="tag tag-warn">Concept Only</span>
          </div>
        </div>

        <div class="status-box">
          <div class="status-title">Readiness</div>
          <div id="readinessText">
            Microscopic thrust + CST + vacuum cone: simulated only, FTAMCS still needs lab validation.
          </div>
          <div class="meter">
            <div id="readinessMeter" class="meter-fill"></div>
          </div>
        </div>

        <div class="status-box" style="margin-top:8px;">
          <div class="status-title">Momentum & Reaction</div>
          <div class="small">
            Thrust is generated <strong>inside</strong> the spacecraft cone. Momentum is conserved:
            the reaction goes into the cone wall / internal ring and structure, not exhaust.
            CST ensures thrust vectors add instead of cancelling, and the vacuum chamber
            keeps resonance clean (no air losses). This gives <em>true mechanical thrust</em>
            you can test and falsify in both lab rigs and space.
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Microscopic Source & FTAMCS Scaling</h2>

        <div class="two-col">
          <div class="field">
            <label for="baseThrust">Manual base thrust per tile (nN)</label>
            <input id="baseThrust" type="number" value="20" min="0" step="1" />
          </div>
          <div class="field">
            <label for="tiles">Number of tiles on cone</label>
            <input id="tiles" type="number" value="5000" min="1" step="1" />
          </div>
        </div>
        <div class="small" style="margin-top:6px;">
          You can override theory and type any base thrust per tile, or enable FTAMCS scaling
          to compute it from thin-film lattice parameters. Baseline AFM target is
          <strong>20 ± 10 nN</strong> per CuBr sample.
        </div>

        <div class="row" style="margin-top:8px;">
          <label class="small">
            <input type="checkbox" id="useFtScaling" checked />
            Use FTAMCS thin-film lattice scaling (AFM calibrated)
          </label>
        </div>

        <div class="subgrid">
          <div class="field">
            <label for="asymmetry" class="small">Torsion asymmetry level (0–1)</label>
            <input id="asymmetry" type="range" min="0" max="1" step="0.01" value="1" />
            <div class="small">0 = symmetric (near-zero thrust), 1 = edge/corner asymmetry.</div>
          </div>
          <div class="field">
            <label for="beta" class="small">Residual factor β (0–0.4)</label>
            <input id="beta" type="range" min="0" max="0.4" step="0.01" value="0.1" />
            <div class="small">Higher β keeps more memory, reduces thrust efficiency.</div>
          </div>
        </div>

        <div class="subgrid">
          <div class="field">
            <label for="filmThickness" class="small">Film thickness h (nm)</label>
            <input id="filmThickness" type="range" min="200" max="1000" step="10" value="500" />
            <div class="small">Prediction: Thrust ∝ h<sup>1.5</sup></div>
          </div>
          <div class="field">
            <label for="grainSize" class="small">Grain size d (nm)</label>
            <input id="grainSize" type="range" min="20" max="200" step="5" value="50" />
            <div class="small">Prediction: Thrust ∝ d<sup>−0.5</sup></div>
          </div>
        </div>

        <div class="subgrid">
          <div class="field">
            <label for="pulsePower" class="small">Pulse power P (mW/mm²)</label>
            <input id="pulsePower" type="range" min="1" max="10" step="0.5" value="5" />
            <div class="small">Prediction: Thrust ∝ P<sup>0.8</sup></div>
          </div>
          <div class="field">
            <label for="layers" class="small">Number of layers</label>
            <input id="layers" type="number" min="1" max="10" step="1" value="1" />
            <div class="small">Approx linear multi-layer coupling (Phase III).</div>
          </div>
        </div>

        <div class="status-box"
             title="Testable &amp; falsifiable: this tile thrust is what AFM / thin-film experiments should actually measure for the same parameters.">
          <div class="status-title">Thin-Film Falsifiable Prediction</div>
          <div class="small">
            Modeled FTAMCS thrust per tile:
            <strong><span id="ftamcsComputed">20.0</span> nN</strong><br>
            This is a direct prediction you can confirm or kill using AFM and vacuum rigs.
          </div>
        </div>
      </div>

      <!-- THREE PANELS SIDE BY SIDE -->
      <div class="triple-row">
        <div class="panel">
          <h2>Thin-Film Lattice Mode (CuBr AFM Test)</h2>

          <div class="two-col">
            <div class="field">
              <label for="material" class="small">Thin-film material</label>
              <select id="material">
                <option value="CuBr" selected>CuBr (baseline AFM target)</option>
                <option value="generic">Generic lattice (scaled)</option>
              </select>
            </div>
            <div class="field">
              <label for="coherence" class="small">Coherence length L<sub>c</sub> (µm)</label>
              <input id="coherence" type="range" min="0.5" max="5" step="0.1" value="1" />
              <div class="small">Longer coherence → slightly higher thrust.</div>
            </div>
          </div>

          <div class="two-col" style="margin-top:6px;">
            <div class="field">
              <label for="infoRate" class="small">Information rate (0–1)</label>
              <input id="infoRate" type="range" min="0" max="1" step="0.01" value="0.5" />
              <div class="small">Higher information flow amplifies effective thrust.</div>
            </div>
            <div class="field">
              <label class="small">AFM predicted thrust (single sample)</label>
              <div class="status-box"
                   title="Testable &amp; falsifiable: compare this band directly against AFM thin-film thrust measurements.">
                <div class="status-title">AFM Band Check</div>
                <div class="small">
                  Modeled thin-film thrust per tile/sample:
                  <strong><span id="afmThrust">20.0</span> nN</strong><br>
                  <span id="afmBandText">Inside 20 ± 10 nN band (good AFM test window).</span>
                </div>
              </div>
            </div>
          </div>

          <div class="small" style="margin-top:6px;">
            Falsifiable predictions: adjust h, d, P, asymmetry, L<sub>c</sub>, and information rate to see how
            the AFM-level thrust responds. The band check is tied to the <strong>20 ± 10 nN</strong> target.
          </div>
        </div>

        <div class="panel">
          <h2>Environment Mode &amp; Testability</h2>
          <div class="two-col">
            <div class="field">
              <label for="envMode" class="small">Engine environment</label>
              <select id="envMode" class="env-mode"
                      title="Testable &amp; falsifiable: switch between Earth lab and space vacuum predictions.">
                <option value="earth">Earth (lab / near-surface)</option>
                <option value="space" selected>Space (vacuum / microgravity)</option>
              </select>
            </div>
            <div class="field">
              <div class="status-box" id="envBox">
                <div class="status-title">Environment Explanation</div>
                <div id="envComment" class="small">
                  Space mode: any non-zero internal thrust produces cumulative Δv in vacuum.
                  Best place to prove true propulsion from FTAMCS thin films, independent of gravity.
                </div>
              </div>
            </div>
          </div>
          <div class="small" style="margin-top:6px;">
            Earth mode is for AFM, torsion balances, and near-surface vehicles (rockets / fighters).
            Space mode is for satellites and spacecraft where micro-thrust can accumulate into real Δv.
          </div>
        </div>

        <div class="panel">
          <h2>Resonance &amp; CST Control</h2>

          <div class="subgrid">
            <div class="field">
              <label for="fDrive">Drive frequency (normalized)</label>
              <input id="fDrive" type="range" min="0.1" max="1.0" step="0.01" value="0.49" />
              <div class="small">
                Natural lattice resonance f₀ ≈ 0.49 (dimensionless).
              </div>
            </div>
            <div class="field">
              <label for="cstSync">CST synchronization quality</label>
              <input id="cstSync" type="range" min="0" max="1" step="0.01" value="0.9" />
              <div class="small">
                0 = random timing, 1 = perfect CST lock. Poor sync wastes thrust as internal vibration.
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:6px;">
            <div class="small">
              f₀ (natural): <strong>0.49</strong><br>
              Q (quality factor): <strong>1.07</strong><br>
              Resonance gain: <strong><span id="resGainText">10.0</span> ×</strong>
            </div>
          </div>

          <div class="subgrid" style="margin-top:8px;">
            <div class="field">
              <label for="corridorActive">CST corridor lock</label>
              <div class="row" style="margin:0;">
                <span class="small">
                  <input type="checkbox" id="corridorActive" checked />
                  Locked
                </span>
              </div>
              <div class="small">
                When unlocked, thrust direction wanders inside the ship and partially cancels.
              </div>
            </div>
            <div class="field">
              <label for="chamberEff">Vacuum cone efficiency</label>
              <input id="chamberEff" type="range" min="0" max="1" step="0.01" value="0.8" />
              <div class="small">
                How well the cone geometry converts microscopic impulses into usable translation.
              </div>
            </div>
          </div>

          <div class="subgrid" style="margin-top:8px;">
            <div class="field">
              <label for="ringCoupling">Reaction cone coupling</label>
              <input id="ringCoupling" type="range" min="0" max="1" step="0.01" value="0.7" />
              <div class="small">
                0 = almost all impulse spins internal mass; 1 = almost all impulse couples to COM.
              </div>
            </div>
            <div class="field">
              <label for="craftMass">Spacecraft / vehicle mass (kg)</label>
              <input id="craftMass" type="number" value="500" min="1" step="10" />
              <div class="small">
                Used to compute acceleration and Δv from effective internal thrust (no propellant).
              </div>
            </div>
          </div>

          <div class="subgrid" style="margin-top:8px;">
            <div class="field">
              <label for="burnTime">Continuous burn time (hours)</label>
              <input id="burnTime" type="number" value="24" min="0" step="1" />
              <input id="burnTimeSlider" type="range" min="0" max="1000" step="1" value="24" />
            </div>
            <div class="field">
              <label for="corridorAngle">CST corridor angle (degrees)</label>
              <input id="corridorAngle" type="number" value="0" min="0" max="360" step="1" />
              <input id="corridorAngleSlider" type="range" min="0" max="360" step="1" value="0" />
              <div class="small">
                Direction of the internal thrust vector in the spacecraft frame (0° = along cone axis).
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- END TRIPLE ROW -->
    </div>

    <!-- RIGHT: OUTPUT / VISUALIZATION -->
    <div>
      <div class="panel">
        <h2>Engine Output (Continuous Internal Thrust)</h2>

        <div class="row" style="margin-bottom:6px;justify-content:flex-start;gap:6px;">
          <button id="startBtn">Start</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
          <span class="small" id="runStatus">
            Flight mode: STANDBY – internal thin-film thrust is modeled, visuals at baseline.
          </span>
        </div>

        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustNn" class="value">–</span>
          <span class="small">nN</span>
        </div>
        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustMicroN" class="value">–</span>
          <span class="small">µN</span>
        </div>
        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustMilliN" class="value">–</span>
          <span class="small">mN</span>
        </div>
        <div class="kpi">
          <span class="label">Spacecraft / vehicle acceleration:</span>
          <span id="accel" class="value">–</span>
          <span class="small">mm/s²</span>
        </div>
        <div class="kpi">
          <span class="label">Net accel vs gravity (Earth mode):</span>
          <span id="accelVsG" class="value">–</span>
          <span class="small">mm/s²</span>
        </div>
        <div class="kpi">
          <span class="label">Δv per hour:</span>
          <span id="dVhour" class="value">–</span>
          <span class="small">m/s per hour</span>
        </div>
        <div class="kpi">
          <span class="label">Total Δv (for selected time):</span>
          <span id="dVtotal" class="value">–</span>
          <span class="small">m/s</span>
        </div>

        <div class="kpi">
          <span class="label">Thrust vector components:</span>
          <span id="thrustComponents" class="value">–</span>
          <span class="small">N along X/Y in spacecraft frame</span>
        </div>

        <div class="status-box">
          <div class="status-title">Interpretation</div>
          <div id="thrustComment">
            Adjust presets and sliders to see how FTAMCS thin-film scaling, CST resonance,
            vacuum cone geometry, corridor lock and reaction coupling scale AFM-level thrust
            into a continuous internal engine without violating momentum conservation.
          </div>
        </div>

        <div class="bubble-row">
          <div class="bubble">
            <strong>FTAMCS Source</strong>
            <span id="bubbleFTAMCS">Microscopic thrust only.</span>
          </div>
          <div class="bubble">
            <strong>CST Control</strong>
            <span id="bubbleCST">Resonance + timing active.</span>
          </div>
          <div class="bubble">
            <strong>Vacuum Geometry</strong>
            <span id="bubbleVac">Reaction cone coupled to Δv (no exhaust).</span>
          </div>
        </div>

        <div class="chips" id="chipRow"></div>

        <div style="margin-top:10px;">
          <button id="exportCsvBtn">Export Simulation CSV</button>
          <span class="small">
            Exports time, thrust, acceleration, Δv (engine running internally, momentum conserved in the cone).
          </span>
        </div>
      </div>

      <div class="panel">
        <h2>Internal Cone Engine (Thin-Film Lattice)</h2>
        <div class="chamber-diagram">
          <div class="cone-engine">
            <div class="corridor-overlay" id="corridorOverlay"></div>
            <div class="cone-wrap">
              <div class="cone-body">
                <div class="cone-core"></div>
                <div class="thrust-arrow" id="thrustArrow"></div>
                <div class="cone-plume" id="conePlume"></div>
                <div class="cone-glow" id="coneGlow"></div>
              </div>
            </div>
            <div class="corridor-label" id="corridorLabel">CST Corridor Active</div>
          </div>
          <div class="small" style="margin-top:18px;">
            FTAMCS thin-film tiles line the interior of the cone. Asymmetric torsion &amp; coherence
            collapse generate microscopic thrust vectors inside; CST timing keeps them phase-locked,
            so the net thrust emerges coherently out of the cone tip, while reaction is absorbed
            by the internal structure and ring. In space, any non-zero thrust changes velocity;
            on Earth, it must overcome gravity and drag to move a rocket or fighter-style vehicle.
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Construction Phases (Conceptual)</h2>
        <div class="two-col small">
          <div>
            <strong>Phase 1 — FTAMCS proof</strong><br>
            CuBr thin-film AFM test to detect ~20 ± 10 nN thrust from asymmetric collapses.
          </div>
          <div>
            <strong>Phase 2 — CST timing electronics</strong><br>
            Lock collapse events to CST and drive resonance to create sustained internal thrust.
          </div>
          <div>
            <strong>Phase 3 — CST–FTAMCS vacuum cone</strong><br>
            Cone shape, reaction ring, collapse geometry, navigation vector control.
          </div>
          <div>
            <strong>Phase 4 — Engine module</strong><br>
            Single milli-newton range CST–FTAMCS lattice-cone propulsion unit.
          </div>
          <div>
            <strong>Phase 5 — Engine array</strong><br>
            Multiple modules combined into a spacecraft/vehicle propulsion system
            (internal thrust, no exhaust, momentum conserved).
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Internal Engine Strip (Thrust Display)</h2>
        <div class="engine-strip">
          <div class="engine-fill" id="engineFill"></div>
        </div>
        <div class="small">
          Shows relative internal thrust level. In <strong>STANDBY</strong>, the strip glows steadily.
          In <strong>START</strong> mode, it brightens to match the cone’s afterburner effect.
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function $(id){return document.getElementById(id);}

// Flight mode flag: false = STANDBY (baseline glow), true = START (bright & stretched)
let engineOn = false;

// Compute FTAMCS-based thrust per tile (nN) with thin-film / AFM scaling
function computeFtamcsTileThrust(){
  const T0 = 20;      // nN reference (AFM target)
  const E  = 130;     // asymmetry enhancement
  const h0 = 500;     // nm
  const d0 = 50;      // nm
  const P0 = 5;       // mW/mm^2
  const Lc0 = 1;      // µm baseline coherence
  const R0  = 0.5;    // baseline information rate

  const a    = parseFloat($('asymmetry').value) || 0;
  const beta = parseFloat($('beta').value) || 0;
  const h    = parseFloat($('filmThickness').value) || h0;
  const d    = parseFloat($('grainSize').value) || d0;
  const P    = parseFloat($('pulsePower').value) || P0;
  const L    = Math.max(1, parseInt($('layers').value) || 1);
  const LcEl = $('coherence');
  const REl  = $('infoRate');
  const Lc   = LcEl ? (parseFloat(LcEl.value) || Lc0) : Lc0;
  const R    = REl ? (parseFloat(REl.value) || R0) : R0;

  // Asymmetry factor: 1 → E
  const A_asym = 1 + (E - 1) * a;

  // Residual factor: more beta → less thrust, clamp so it never goes negative
  let F_beta = 1 - beta;
  if(F_beta < 0.2) F_beta = 0.2;

  const thicknessFactor = Math.pow(h / h0, 1.5);
  const grainFactor     = Math.pow(d0 / d, 0.5);
  const powerFactor     = Math.pow(P / P0, 0.8);

  // Coherence & information-driven amplification (mild)
  const coherenceFactor = Math.pow(Lc / Lc0, 0.3);    // long coherence helps
  const infoFactor      = 0.5 + (R / 1.0);           // 0.5 → 1.5

  const tileThrust_nN = T0 * A_asym * F_beta *
    thicknessFactor * grainFactor * powerFactor *
    coherenceFactor * infoFactor * L;

  return tileThrust_nN;
}

// Simple resonance gain curve around f0 ≈ 0.49, Q ≈ 1.07
function computeResonanceGain(){
  const fDrive = parseFloat($('fDrive').value) || 0.49;
  const f0 = 0.49;
  const Gmax = 10;       // about tenfold mechanical amplification
  const width = 0.12;    // how wide the peak is

  const x = (fDrive - f0) / width;
  const G = 1 + (Gmax - 1) * Math.exp(-x * x);
  return G;
}

// AFM band / falsifiable prediction readout
function updateAFMPanel(tileThrust_nN){
  const spanThrust = $('afmThrust');
  const spanBand   = $('afmBandText');
  if(!spanThrust || !spanBand) return;

  spanThrust.textContent = tileThrust_nN.toFixed(2);

  const lower = 10;
  const upper = 30;
  let msg;
  if(tileThrust_nN < lower){
    msg = 'Below 20 ± 10 nN band (too weak for target AFM test).';
  }else if(tileThrust_nN > upper){
    msg = 'Above 20 ± 10 nN band (stronger than baseline AFM target).';
  }else{
    msg = 'Inside 20 ± 10 nN band (good AFM test window, testable & falsifiable).';
  }
  spanBand.textContent = msg;
}

// Apply phase presets
function applyPhase(phase){
  switch(parseInt(phase,10)){
    case 1: // Phase 1 – FTAMCS Lab Proof (single AFM sample)
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = false;
      $('vacReady').checked    = false;

      $('baseThrust').value    = 20;
      $('tiles').value         = 1;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.0;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 1;
      if($('coherence')) $('coherence').value = 1;
      if($('infoRate'))  $('infoRate').value  = 0.5;
      if($('material'))  $('material').value  = 'CuBr';
      if($('envMode'))   $('envMode').value   = 'earth';

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.0;
      $('corridorActive').checked = false;
      $('chamberEff').value    = 0.0;
      $('ringCoupling').value  = 0.2;
      $('craftMass').value     = 1;
      $('burnTime').value      = 1;
      $('burnTimeSlider').value= 1;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 2: // Phase 2 – CST Timing Added
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = false;

      $('baseThrust').value    = 20;
      $('tiles').value         = 10;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.05;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 1;
      if($('coherence')) $('coherence').value = 1;
      if($('infoRate'))  $('infoRate').value  = 0.5;
      if($('material'))  $('material').value  = 'CuBr';
      if($('envMode'))   $('envMode').value   = 'earth';

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.8;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.0;
      $('ringCoupling').value  = 0.3;
      $('craftMass').value     = 50;
      $('burnTime').value      = 4;
      $('burnTimeSlider').value= 4;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 3: // Phase 3 – CST–FTAMCS Vacuum Cone
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 1000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 3;
      if($('coherence')) $('coherence').value = 1.2;
      if($('infoRate'))  $('infoRate').value  = 0.6;
      if($('material'))  $('material').value  = 'CuBr';
      if($('envMode'))   $('envMode').value   = 'space';

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.9;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.7;
      $('ringCoupling').value  = 0.6;
      $('craftMass').value     = 200;
      $('burnTime').value      = 24;
      $('burnTimeSlider').value= 24;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 4: // Phase 4 – Engine Module
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 5000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 6.5;
      $('layers').value        = 5;
      if($('coherence')) $('coherence').value = 1.5;
      if($('infoRate'))  $('infoRate').value  = 0.7;
      if($('material'))  $('material').value  = 'CuBr';
      if($('envMode'))   $('envMode').value   = 'space';

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.95;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.8;
      $('ringCoupling').value  = 0.8;
      $('craftMass').value     = 500;
      $('burnTime').value      = 72;
      $('burnTimeSlider').value= 72;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 5: // Phase 5 – Engine Array
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 20000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 600;
      $('grainSize').value     = 40;
      $('pulsePower').value    = 8;
      $('layers').value        = 7;
      if($('coherence')) $('coherence').value = 2.0;
      if($('infoRate'))  $('infoRate').value  = 0.8;
      if($('material'))  $('material').value  = 'CuBr';
      if($('envMode'))   $('envMode').value   = 'space';

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.97;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.9;
      $('ringCoupling').value  = 0.9;
      $('craftMass').value     = 2000;
      $('burnTime').value      = 168; // 1 week
      $('burnTimeSlider').value= 168;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;
  }
  // Always go back to STANDBY after preset change
  engineOn = false;
  updateEngine();
}

// Core update function
function updateEngine(){
  const ftamcsOn   = $('ftamcsReady').checked;
  const cstOn      = $('cstReady').checked;
  const vacOn      = $('vacReady').checked;
  const corridorOn = $('corridorActive').checked;
  const useScaling = $('useFtScaling').checked;

  const envSel = $('envMode');
  const env    = envSel ? envSel.value : 'space';

  const tiles         = Math.max(1, parseInt($('tiles').value) || 1);
  const craftMassKg   = Math.max(1, parseFloat($('craftMass').value) || 1);
  const burnTimeHours = Math.max(0, parseFloat($('burnTime').value) || 0);
  const corridorDeg   = (parseFloat($('corridorAngle').value) || 0) % 360;

  // Base thrust per tile
  let baseManual = Math.max(0, parseFloat($('baseThrust').value) || 0);
  let tileThrust_nN = useScaling ? computeFtamcsTileThrust() : baseManual;
  if($('ftamcsComputed')){
    $('ftamcsComputed').textContent = tileThrust_nN.toFixed(2);
  }
  updateAFMPanel(tileThrust_nN);

  // Total microscopic thrust before CST/vacuum (nN)
  let thrust_nN = tileThrust_nN * tiles;

  if(!ftamcsOn){
    thrust_nN = 0;
  }else{
    // Resonance gain from drive frequency
    let resonanceGain = computeResonanceGain();
    $('resGainText').textContent = resonanceGain.toFixed(2);

    // CST resonance + timing
    let effectiveGain = 1;
    if(cstOn){
      const cstSync = parseFloat($('cstSync').value);
      const syncFactor = 0.1 + 0.9 * cstSync; // 0.1–1
      effectiveGain = resonanceGain * syncFactor;
    }

    // Vacuum chamber (cone) efficiency
    const chamberEff = parseFloat($('chamberEff').value);
    let chamberFactor = 1;
    if(vacOn){
      chamberFactor = 0.2 + 0.8 * chamberEff; // 0.2–1
    }

    // Corridor lock factor: if corridor not locked, some cancellation
    let corridorFactor = corridorOn ? 1.0 : 0.5;

    // Reaction cone coupling: how much becomes translation
    const ringCoupling = parseFloat($('ringCoupling').value);
    let ringFactor = 0.1 + 0.9 * ringCoupling; // 0.1–1

    thrust_nN *= (effectiveGain * chamberFactor * corridorFactor * ringFactor);
  }

  const thrust_microN = thrust_nN / 1000;
  const thrust_milliN = thrust_microN / 1000;
  const thrust_N      = thrust_milliN / 1000;

  // Acceleration: a = F / m
  const accel_m_s2      = thrust_N / craftMassKg;
  const accel_mm_s2     = accel_m_s2 * 1000;
  const dv_per_hour_m_s = accel_m_s2 * 3600;
  const dv_total_m_s    = dv_per_hour_m_s * burnTimeHours;

  $('thrustNn').textContent      = thrust_nN.toFixed(0);
  $('thrustMicroN').textContent  = thrust_microN.toFixed(3);
  $('thrustMilliN').textContent  = thrust_milliN.toFixed(6);
  $('accel').textContent         = accel_mm_s2.toFixed(6);
  $('dVhour').textContent        = dv_per_hour_m_s.toFixed(6);
  $('dVtotal').textContent       = dv_total_m_s.toFixed(6);

  // Environment-specific explanation and net accel vs gravity
  const envCommentEl = $('envComment');
  if(env === 'earth'){
    const accelVsG_mm_s2 = (accel_m_s2 - 9.81) * 1000; // thrust accel minus g
    $('accelVsG').textContent = accelVsG_mm_s2.toFixed(3);
    if(envCommentEl){
      envCommentEl.textContent =
        'Earth mode: predictions assume your cone engine is mounted near the surface. ' +
        'AFM and torsion-balance tests are directly testable & falsifiable. ' +
        'To lift a rocket or fighter-style vehicle, net accel vs gravity must go positive.';
    }
  }else{
    $('accelVsG').textContent = 'n/a (space)';
    if(envCommentEl){
      envCommentEl.textContent =
        'Space mode: predictions assume microgravity vacuum. Any non-zero internal thrust ' +
        'produces cumulative Δv; this is the cleanest way to falsify or confirm the FTAMCS engine.';
    }
  }

  // Thrust vector components in spacecraft frame
  const rad = corridorDeg * Math.PI/180;
  const Fx = thrust_N * Math.cos(rad);
  const Fy = thrust_N * Math.sin(rad);
  $('thrustComponents').textContent =
    `Fx = ${Fx.toExponential(3)} N, Fy = ${Fy.toExponential(3)} N @ ${corridorDeg.toFixed(0)}°`;

  // Visual thrust level for cone (based on thrust only)
  const baseLevel = thrust_nN > 0 ? Math.min(1, Math.log10(1 + thrust_nN) / 6) : 0;

  // In START mode we stretch and brighten more; in STANDBY we show a steady, weaker glow
  const arrow = $('thrustArrow');
  const plume = $('conePlume');
  const glow  = $('coneGlow');

  if(arrow){
    const stretchFactor = engineOn ? 1.5 : 0.4;
    const scaleY = 1 + baseLevel * stretchFactor;
    arrow.style.transform = `rotate(${corridorDeg}deg) scaleY(${scaleY})`;
    arrow.style.opacity   = baseLevel > 0 ? (engineOn ? 1 : 0.7) : 0.3;
  }
  if(plume){
    const plumeFactor = engineOn ? 1.7 : 0.7;
    const scaleYp = 0.3 + baseLevel * plumeFactor;
    plume.style.transform = `scaleY(${scaleYp})`;
    plume.style.opacity   = baseLevel > 0 ? (engineOn ? 0.3 + baseLevel*0.7 : 0.2 + baseLevel*0.4) : 0.15;
  }
  if(glow){
    const glowFactor = engineOn ? 1.5 : 0.7;
    const glowScale = 0.7 + baseLevel * glowFactor;
    glow.style.transform = `scale(${glowScale})`;
    glow.style.opacity   = baseLevel > 0 ? (engineOn ? 0.2 + baseLevel*0.8 : 0.15 + baseLevel*0.4) : 0.15;
  }

  const overlay = $('corridorOverlay');
  const label   = $('corridorLabel');
  if(overlay){
    overlay.style.opacity = corridorOn ? '1' : '0';
  }
  if(label){
    label.style.opacity   = corridorOn ? '1' : '0';
  }

  // Readiness meter
  let readyCount = 0;
  if(ftamcsOn) readyCount++;
  if(cstOn)    readyCount++;
  if(vacOn)    readyCount++;

  const readinessPct = (readyCount / 3) * 100;
  $('readinessMeter').style.width = readinessPct + '%';

  let readinessText = '';
  let engineTagClass = 'tag-warn';
  let engineTagText  = 'Concept Only';

  if(readyCount === 0){
    readinessText = 'No components active: no internal thrust, no engine.';
    engineTagClass = 'tag-bad';
    engineTagText  = 'Inactive';
  }else if(readyCount === 1){
    readinessText = 'Only one component active. This is a fragment of the full concept (no complete engine behavior).';
    engineTagClass = 'tag-bad';
    engineTagText  = 'Fragment';
  }else if(readyCount === 2){
    readinessText = 'Two components active. You can model partial internal thrust, but not a full CST–FTAMCS cone engine.';
    engineTagClass = 'tag-warn';
    engineTagText  = 'Partial';
  }else if(readyCount === 3){
    readinessText = 'All three components active. This approximates a full CST–FTAMCS lattice cone module, still pending experimental thin-film thrust proof.';
    engineTagClass = 'tag-good';
    engineTagText  = 'Simulated Engine';
  }

  const engineTag = $('engineStateTag');
  engineTag.textContent = engineTagText;
  engineTag.className = 'tag ' + engineTagClass;
  $('readinessText').textContent = readinessText;

  // Bubble texts
  const cstSync       = parseFloat($('cstSync').value);
  const chamberEff    = parseFloat($('chamberEff').value);
  const ringCoupling  = parseFloat($('ringCoupling').value);

  $('bubbleFTAMCS').textContent = ftamcsOn
    ? (useScaling
        ? 'Microscopic thin-film thrust source enabled with FTAMCS lattice scaling (AFM-calibrated, testable & falsifiable).'
        : 'Microscopic thrust source enabled with manual per-tile value.')
    : 'FTAMCS off: no thrust events generated.';

  $('bubbleCST').textContent = cstOn
    ? (corridorOn
        ? `CST resonance + timing + corridor lock keep thrust coherent and aligned (sync ${(cstSync*100).toFixed(0)}%).`
        : 'CST resonance active, but corridor not locked: direction can wander internally.')
    : 'No CST control: collapse phases wander and thrust cancels as vibration.';

  $('bubbleVac').textContent = vacOn
    ? `Vacuum cone routes reaction into the internal structure and spacecraft COM (eff ${(chamberEff*100).toFixed(0)}%).`
    : 'No cone coupling: reaction remains as local stress and vibration, not useful Δv.';

  // Thrust comment
  let comment = '';
  if(!ftamcsOn){
    comment = 'Enable FTAMCS thin-film microscopic thrust to generate any internal impulse at all.';
  }else if(ftamcsOn && !cstOn && !vacOn){
    comment = 'You have microscopic FTAMCS thrust only. This represents a lab-scale AFM effect, not yet a propulsion cone.';
  }else if(ftamcsOn && cstOn && !vacOn){
    comment = 'FTAMCS + CST gives directional internal thrust, but without a vacuum cone and reaction coupling, the momentum routing is inefficient.';
  }else if(ftamcsOn && cstOn && vacOn){
    if(thrust_milliN < 0.001){
      comment = 'You have a full internal cone engine structure, but effective thrust is still in the micro-newton regime. Good for proof-of-concept, micro-attitude control, and AFM-scale demonstrations.';
    }else if(thrust_milliN < 0.1){
      comment = 'Engine is in the milli-newton range in this simulation. Comparable to micro-propulsion used for small satellites, but based entirely on internal thin-film thrust and cone coupling.';
    }else{
      comment = 'Engine is producing significant milli-newton-class internal thrust in this simulation. Real hardware would require detailed thermal, power, and materials constraints.';
    }
  }else{
    comment = 'Toggle CST and vacuum cone on to see how internal FTAMCS thrust scales into a unified propulsion module.';
  }
  $('thrustComment').textContent = comment;

  // Engine strip visualization – always shows thrust, brighter in START
  const strip = $('engineFill');
  if(strip){
    let stripLevel = 0;
    if(thrust_nN > 0){
      stripLevel = Math.min(1, Math.log10(1 + thrust_nN) / 6); // compress big ranges
    }
    strip.style.width = (stripLevel*100).toFixed(1) + '%';
    strip.style.opacity = thrust_nN > 0 ? (engineOn ? 1 : 0.6) : 0.25;
  }

  // Run status text
  $('runStatus').textContent = engineOn
    ? 'Flight mode: START – cone visuals stretched and bright at current thrust.'
    : 'Flight mode: STANDBY – internal thin-film thrust is modeled, visuals at baseline glow.';

  // Chips
  const chipRow = $('chipRow');
  chipRow.innerHTML = '';
  function addChip(text){
    const span = document.createElement('span');
    span.className = 'chip';
    span.textContent = text;
    chipRow.appendChild(span);
  }

  addChip(`Mode: ${engineOn ? 'START' : 'STANDBY'}`);
  addChip(`Env: ${env === 'earth' ? 'Earth lab/vehicle' : 'Space vacuum'}`);
  addChip(`Tiles: ${tiles}`);
  addChip(useScaling ? 'Tile model: FTAMCS thin-film' : 'Tile model: Manual');
  addChip(`Tile thrust: ${tileThrust_nN.toFixed(1)} nN`);
  addChip(`ResGain ≈ ${computeResonanceGain().toFixed(2)}×`);
  addChip(`CST sync ${(cstSync*100).toFixed(0)}%`);
  addChip(`Cone eff ${(chamberEff*100).toFixed(0)}%`);
  addChip(`Cone coup ${(ringCoupling*100).toFixed(0)}%`);
  addChip(`Mass: ${craftMassKg.toFixed(0)} kg`);
  addChip(`Burn: ${burnTimeHours.toFixed(0)} h`);
  addChip(`Angle: ${corridorDeg.toFixed(0)}°`);
}

// CSV export (uses same thrust model; flight mode doesn’t change physics)
function exportCsv(){
  const ftamcsOn   = $('ftamcsReady').checked;
  const cstOn      = $('cstReady').checked;
  const vacOn      = $('vacReady').checked;
  const corridorOn = $('corridorActive').checked;
  const useScaling = $('useFtScaling').checked;

  const envSel = $('envMode');
  const env    = envSel ? envSel.value : 'space';

  const tiles         = Math.max(1, parseInt($('tiles').value) || 1);
  const craftMassKg   = Math.max(1, parseFloat($('craftMass').value) || 1);
  const burnTimeHours = Math.max(0, parseFloat($('burnTime').value) || 0);
  const corridorDeg   = (parseFloat($('corridorAngle').value) || 0) % 360;

  let baseManual = Math.max(0, parseFloat($('baseThrust').value) || 0);
  let tileThrust_nN = useScaling ? computeFtamcsTileThrust() : baseManual;

  let thrust_nN = tileThrust_nN * tiles;
  if(!ftamcsOn){
    thrust_nN = 0;
  }else{
    let resonanceGain = computeResonanceGain();
    const cstSync = parseFloat($('cstSync').value);
    let effectiveGain = 1;
    if(cstOn){
      const syncFactor = 0.1 + 0.9 * cstSync;
      effectiveGain = resonanceGain * syncFactor;
    }
    const chamberEff = parseFloat($('chamberEff').value);
    let chamberFactor = 1;
    if(vacOn){
      chamberFactor = 0.2 + 0.8 * chamberEff;
    }
    let corridorFactor = corridorOn ? 1.0 : 0.5;
    const ringCoupling = parseFloat($('ringCoupling').value);
    let ringFactor = 0.1 + 0.9 * ringCoupling;

    thrust_nN *= (effectiveGain * chamberFactor * corridorFactor * ringFactor);
  }

  const thrust_microN = thrust_nN / 1000;
  const thrust_milliN = thrust_microN / 1000;
  const thrust_N      = thrust_milliN / 1000;
  const accel_m_s2    = thrust_N / craftMassKg;
  const rad           = corridorDeg * Math.PI/180;
  const Fx            = thrust_N * Math.cos(rad);
  const Fy            = thrust_N * Math.sin(rad);

  const dt = 1; // 1 hour step
  const steps = Math.max(1, Math.round(burnTimeHours/dt) || 1);

  let csv = 'env,flight_mode,time_hr,thrust_N,accel_m_s2,dv_m_s,corridor_deg,Fx_N,Fy_N\n';
  let dv = 0;

  for(let i=0;i<=steps;i++){
    const t = i*dt;
    if(i>0){
      dv += accel_m_s2 * 3600 * dt;
    }
    csv += [
      env,
      engineOn ? 'START' : 'STANDBY',
      t.toFixed(3),
      thrust_N.toExponential(6),
      accel_m_s2.toExponential(6),
      dv.toExponential(6),
      corridorDeg.toFixed(2),
      Fx.toExponential(6),
      Fy.toExponential(6)
    ].join(',') + '\n';
  }

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cst_ftamcs_lattice_cone_simulation_v7.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Link UI events (sliders, toggles, presets)
[
  'ftamcsReady','cstReady','vacReady',
  'phasePreset',
  'baseThrust','tiles',
  'useFtScaling','asymmetry','beta',
  'filmThickness','grainSize','pulsePower','layers',
  'material','coherence','infoRate',
  'envMode',
  'fDrive','cstSync','chamberEff','ringCoupling',
  'craftMass','burnTime','burnTimeSlider',
  'corridorAngle','corridorAngleSlider','corridorActive'
].forEach(id=>{
  const el = $(id);
  if(!el) return;
  el.addEventListener('input', (e)=>{
    if(id === 'burnTime'){
      $('burnTimeSlider').value = e.target.value;
    }else if(id === 'burnTimeSlider'){
      $('burnTime').value = e.target.value;
    }else if(id === 'corridorAngle'){
      $('corridorAngleSlider').value = e.target.value;
    }else if(id === 'corridorAngleSlider'){
      $('corridorAngle').value = e.target.value;
    }else if(id === 'phasePreset'){
      applyPhase(e.target.value);
      return;
    }
    updateEngine();
  });
  el.addEventListener('change', (e)=>{
    if(id === 'phasePreset'){
      applyPhase(e.target.value);
      return;
    }
    if(id === 'burnTime'){
      $('burnTimeSlider').value = e.target.value;
    }else if(id === 'burnTimeSlider'){
      $('burnTime').value = e.target.value;
    }else if(id === 'corridorAngle'){
      $('corridorAngleSlider').value = e.target.value;
    }else if(id === 'corridorAngleSlider'){
      $('corridorAngle').value = e.target.value;
    }
    updateEngine();
  });
});

// Start / Stop / Reset buttons – only affect visuals / flight mode
$('startBtn').addEventListener('click', ()=>{
  engineOn = true;
  updateEngine();
});
$('stopBtn').addEventListener('click', ()=>{
  engineOn = false;
  updateEngine();
});
$('resetBtn').addEventListener('click', ()=>{
  applyPhase(3);       // restore CST–FTAMCS vacuum cone defaults
  engineOn = false;    // back to STANDBY
  updateEngine();
});

$('exportCsvBtn').addEventListener('click', exportCsv);

// Initial setup
applyPhase(3);
</script>
</body>
</html>
