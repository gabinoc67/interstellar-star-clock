<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST–FTAMCS Unified Engine Simulation v5</title>
<style>
  :root{
    --bg:#0b1222;
    --panel:#121a33;
    --ink:#edf2ff;
    --muted:#a1b4ea;
    --accent:#8fb4ff;
    --grid:#1b2550;
    --good:#7bffb1;
    --warn:#ffd37a;
    --bad:#ff8c8c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    font-size:15px;
  }
  .wrap{
    max-width:1300px;
    margin:0 auto;
    padding:16px;
  }
  h1{
    margin:4px 0 14px;
    font-size:1.7rem;
  }
  h2{
    margin:0 0 10px;
    font-size:1.15rem;
    color:var(--muted);
  }
  .grid{
    display:grid;
    grid-template-columns:minmax(0, 420px) minmax(0, 1fr);
    gap:16px;
    align-items:flex-start;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--grid);
    border-radius:14px;
    padding:14px 16px;
    margin-bottom:12px;
  }
  label{
    font-size:0.9rem;
    color:var(--muted);
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:4px 0 8px;
    gap:8px;
    flex-wrap:wrap;
  }
  input[type="number"], input[type="range"], select{
    width:100%;
    padding:5px 7px;
    border-radius:6px;
    border:1px solid #24325a;
    background:#0c1328;
    color:var(--ink);
    font-size:0.9rem;
  }
  input[type="range"]{padding:0;}
  select{background:#0c1328;}
  .small{
    font-size:0.85rem;
    color:var(--muted);
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:0.78rem;
    margin-left:6px;
    border:1px solid var(--grid);
  }
  .tag-good{border-color:var(--good);color:var(--good);}
  .tag-warn{border-color:var(--warn);color:var(--warn);}
  .tag-bad{border-color:var(--bad);color:var(--bad);}
  .kpi{
    margin:5px 0;
    font-size:0.95rem;
  }
  .kpi span.label{
    color:var(--muted);
  }
  .kpi span.value{
    font-weight:600;
  }
  .status-box{
    margin-top:6px;
    padding:8px 10px;
    border-radius:10px;
    font-size:0.88rem;
    background:#101735;
    border:1px solid #222f5b;
  }
  .status-title{
    text-transform:uppercase;
    letter-spacing:0.08em;
    font-size:0.72rem;
    color:var(--muted);
    margin-bottom:4px;
  }
  .bubble-row{
    display:flex;
    justify-content:space-between;
    gap:6px;
    margin-top:8px;
    flex-wrap:wrap;
  }
  .bubble{
    flex:1 1 120px;
    padding:6px 8px;
    border-radius:10px;
    background:#111a3a;
    border:1px solid #202c55;
    font-size:0.8rem;
  }
  .bubble strong{
    display:block;
    font-size:0.8rem;
    color:var(--muted);
    margin-bottom:2px;
  }
  .meter{
    width:100%;
    height:9px;
    border-radius:999px;
    background:#091024;
    overflow:hidden;
    margin-top:4px;
  }
  .meter-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--bad),var(--warn),var(--good));
  }
  .chamber-diagram{
    margin-top:6px;
    font-size:0.8rem;
    text-align:center;
  }
  .circle{
    width:190px;
    height:190px;
    border-radius:50%;
    margin:10px auto 4px;
    border:1px solid #293768;
    position:relative;
    box-shadow:0 0 18px rgba(143,180,255,0.2) inset;
    overflow:hidden;
  }
  .circle::before{
    content:"VACUUM CHAMBER";
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:0.78rem;
    color:var(--muted);
    text-align:center;
    pointer-events:none;
  }
  .ring{
    position:absolute;
    inset:14px;
    border-radius:50%;
    border:1px dashed #3a4a80;
  }
  .ring-label{
    position:absolute;
    bottom:6px;
    left:50%;
    transform:translateX(-50%);
    font-size:0.78rem;
    color:var(--muted);
  }
  .thrust-arrow-wrap{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .thrust-arrow{
    width:70px;
    height:3px;
    background:var(--accent);
    position:relative;
    transform-origin:left center;
    transition:transform 0.2s ease, opacity 0.2s ease;
  }
  .thrust-arrow::after{
    content:"";
    position:absolute;
    right:-4px;
    top:-4px;
    border-left:8px solid var(--accent);
    border-top:5px solid transparent;
    border-bottom:5px solid transparent;
  }
  .corridor-overlay{
    position:absolute;
    inset:0;
    border-radius:50%;
    background:conic-gradient(
      rgba(143,180,255,0.15) 0deg,
      rgba(143,180,255,0.35) 15deg,
      rgba(143,180,255,0.0) 40deg,
      rgba(143,180,255,0.0) 320deg,
      rgba(143,180,255,0.35) 345deg,
      rgba(143,180,255,0.15) 360deg
    );
    opacity:0;
    pointer-events:none;
    transition:opacity 0.2s ease;
  }
  .corridor-label{
    position:absolute;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    font-size:0.78rem;
    color:#9bb7ff;
    text-shadow:0 0 4px #000;
    opacity:0;
    transition:opacity 0.2s ease;
  }
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-top:6px;
  }
  .chip{
    font-size:0.78rem;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid #26345e;
    color:var(--muted);
  }
  button{
    border-radius:8px;
    border:1px solid #304070;
    background:#18244a;
    color:var(--ink);
    padding:6px 10px;
    font-size:0.88rem;
    cursor:pointer;
  }
  button:hover{
    background:#1f2e5d;
  }
  .two-col{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  .subgrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    margin-top:8px;
  }
  .engine-strip{
    width:100%;
    height:14px;
    border-radius:999px;
    background:#090f20;
    border:1px solid #28335c;
    overflow:hidden;
    margin:6px 0 4px;
  }
  .engine-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#44c7ff,#7bffb1);
    transition:width 0.2s ease,opacity 0.2s ease;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>CST–FTAMCS Unified Engine Simulation v5</h1>

  <div class="grid">
    <!-- LEFT: INPUTS / COMPONENTS -->
    <div>
      <div class="panel">
        <h2>Phase Presets (Concept Roadmap)</h2>
        <div class="row">
          <label for="phasePreset">Select phase</label>
          <select id="phasePreset">
            <option value="1">Phase 1 – FTAMCS Lab Proof</option>
            <option value="2">Phase 2 – CST Timing Added</option>
            <option value="3" selected>Phase 3 – CST–FTAMCS Vacuum Chamber</option>
            <option value="4">Phase 4 – Engine Module</option>
            <option value="5">Phase 5 – Engine Array</option>
          </select>
        </div>
        <div class="small">
          Phase 1–5 mirror your real construction path:<br>
          1) FTAMCS proof → 2) CST timing → 3) chamber design → 4) engine module → 5) engine array.
        </div>
      </div>

      <div class="panel">
        <h2>Engine Components & Status</h2>

        <div class="row">
          <div>
            <div>FTAMCS microscopic thrust</div>
            <div class="small">Thin-film asymmetric collapse (inside spacecraft)</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="ftamcsReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>CST resonance + timing</div>
            <div class="small">Keeps collapse events phase-locked in time</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="cstReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Vacuum chamber geometry</div>
            <div class="small">Internal reaction ring + clean vacuum (no exhaust)</div>
          </div>
          <div>
            <label class="small">
              <input type="checkbox" id="vacReady" checked />
              Active
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Real propulsion engine</div>
            <div class="small">All components integrated (simulation only)</div>
          </div>
          <div>
            <span id="engineStateTag" class="tag tag-warn">Concept Only</span>
          </div>
        </div>

        <div class="status-box">
          <div class="status-title">Readiness</div>
          <div id="readinessText">
            Microscopic thrust + CST + vacuum: simulated only, FTAMCS still needs lab validation.
          </div>
          <div class="meter">
            <div id="readinessMeter" class="meter-fill"></div>
          </div>
        </div>

        <div class="status-box" style="margin-top:8px;">
          <div class="status-title">Momentum & Reaction</div>
          <div class="small">
            Thrust is generated <strong>inside</strong> the spacecraft. Momentum is conserved:
            the reaction goes into the chamber ring and internal structure, not exhaust.
            CST ensures thrust vectors add instead of cancelling, and the vacuum chamber
            keeps resonance clean (no air losses).
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Microscopic Source & FTAMCS Scaling</h2>

        <div class="row">
          <label for="baseThrust">Manual base thrust per tile (nN)</label>
          <input id="baseThrust" type="number" value="20" min="0" step="1" />
        </div>
        <div class="row">
          <label for="tiles">Number of tiles on ring</label>
          <input id="tiles" type="number" value="5000" min="1" step="1" />
        </div>
        <div class="small">
          You can override the theory and type any base thrust per tile, or enable FTAMCS scaling below
          to compute it from film thickness, grain size, power, asymmetry, β, and layers.
        </div>

        <div class="row" style="margin-top:8px;">
          <label class="small">
            <input type="checkbox" id="useFtScaling" checked />
            Use FTAMCS paper-based scaling
          </label>
        </div>

        <div class="subgrid">
          <div>
            <label for="asymmetry" class="small">Asymmetry level (0–1)</label>
            <input id="asymmetry" type="range" min="0" max="1" step="0.01" value="1" />
            <div class="small">0 = symmetric (near-zero thrust), 1 = edge/corner.</div>
          </div>
          <div>
            <label for="beta" class="small">Residual factor β (0–0.4)</label>
            <input id="beta" type="range" min="0" max="0.4" step="0.01" value="0.1" />
            <div class="small">Higher β keeps more memory, reduces thrust efficiency.</div>
          </div>
        </div>

        <div class="subgrid">
          <div>
            <label for="filmThickness" class="small">Film thickness h (nm)</label>
            <input id="filmThickness" type="range" min="200" max="1000" step="10" value="500" />
            <div class="small">Thrust ∝ h<sup>1.5</sup></div>
          </div>
          <div>
            <label for="grainSize" class="small">Grain size d (nm)</label>
            <input id="grainSize" type="range" min="20" max="200" step="5" value="50" />
            <div class="small">Thrust ∝ d<sup>−0.5</sup></div>
          </div>
        </div>

        <div class="subgrid">
          <div>
            <label for="pulsePower" class="small">Pulse power P (mW/mm²)</label>
            <input id="pulsePower" type="range" min="1" max="10" step="0.5" value="5" />
            <div class="small">Thrust ∝ P<sup>0.8</sup></div>
          </div>
          <div>
            <label for="layers" class="small">Number of layers</label>
            <input id="layers" type="number" min="1" max="10" step="1" value="1" />
            <div class="small">Approx linear multi-layer coupling (Phase III).</div>
          </div>
        </div>

        <div class="status-box" style="margin-top:8px;">
          <div class="status-title">FTAMCS Effective Tile Thrust</div>
          <div class="small">
            Reference: 20 nN at h=500 nm, d=50 nm, P=5 mW/mm², asymmetry=1, β=0, 1 layer.<br>
            Current modeled thrust per tile:
            <strong><span id="ftamcsComputed">20.0</span> nN</strong>
            (used when FTAMCS scaling is enabled).
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Resonance & CST Control</h2>

        <div class="row">
          <label for="fDrive">Drive frequency (normalized)</label>
        </div>
        <input id="fDrive" type="range" min="0.1" max="1.0" step="0.01" value="0.49" />
        <div class="small">
          Natural lattice resonance f₀ ≈ 0.49 (dimensionless). This slider sweeps around that value.
        </div>

        <div class="row" style="margin-top:6px;">
          <div class="small">
            f₀ (natural): <strong>0.49</strong><br>
            Q (quality factor): <strong>1.07</strong><br>
            Resonance gain: <strong><span id="resGainText">10.0</span> ×</strong>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="cstSync">CST synchronization quality</label>
        </div>
        <input id="cstSync" type="range" min="0" max="1" step="0.01" value="0.9" />
        <div class="small">
          0 = random timing, 1 = perfect CST lock. Poor sync wastes thrust as internal vibration.
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="corridorActive">CST corridor lock</label>
          <span class="small">
            <input type="checkbox" id="corridorActive" checked />
            Locked
          </span>
        </div>
        <div class="small">
          When unlocked, thrust direction wanders inside the ship and partially cancels. When locked,
          it stays aligned with the CST navigation corridor.
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="chamberEff">Vacuum chamber efficiency</label>
        </div>
        <input id="chamberEff" type="range" min="0" max="1" step="0.01" value="0.8" />
        <div class="small">
          How well the internal reaction ring + cavity geometry convert microscopic impulses into usable translation.
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="ringCoupling">Reaction ring coupling</label>
        </div>
        <input id="ringCoupling" type="range" min="0" max="1" step="0.01" value="0.7" />
        <div class="small">
          0 = almost all impulse spins internal mass; 1 = almost all impulse couples to spacecraft center of mass.
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="craftMass">Spacecraft mass (kg)</label>
          <input id="craftMass" type="number" value="500" min="1" step="10" />
        </div>
        <div class="small">
          Used to compute acceleration and Δv from effective internal thrust (no propellant).
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="burnTime">Continuous burn time (hours)</label>
          <input id="burnTime" type="number" value="24" min="0" step="1" />
        </div>
        <input id="burnTimeSlider" type="range" min="0" max="1000" step="1" value="24" />
        <div class="small">
          Engine is assumed to be running continuously for this duration (constant internal thrust).
        </div>

        <div class="row" style="margin-top:10px;">
          <label for="corridorAngle">CST corridor angle (degrees)</label>
          <input id="corridorAngle" type="number" value="0" min="0" max="360" step="1" />
        </div>
        <input id="corridorAngleSlider" type="range" min="0" max="360" step="1" value="0" />
        <div class="small">
          Direction of the internal thrust vector in the spacecraft frame (0° = +X direction).
        </div>
      </div>
    </div>

    <!-- RIGHT: OUTPUT / VISUALIZATION -->
    <div>
      <div class="panel">
        <h2>Engine Output (Continuous Internal Thrust)</h2>

        <div class="row" style="margin-bottom:6px;justify-content:flex-start;gap:6px;">
          <button id="startBtn">Start</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
          <span class="small" id="runStatus">Engine status: Running (simulation).</span>
        </div>

        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustNn" class="value">–</span>
          <span class="small">nN</span>
        </div>
        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustMicroN" class="value">–</span>
          <span class="small">µN</span>
        </div>
        <div class="kpi">
          <span class="label">Effective thrust to COM:</span>
          <span id="thrustMilliN" class="value">–</span>
          <span class="small">mN</span>
        </div>
        <div class="kpi">
          <span class="label">Spacecraft acceleration:</span>
          <span id="accel" class="value">–</span>
          <span class="small">mm/s²</span>
        </div>
        <div class="kpi">
          <span class="label">Δv per hour:</span>
          <span id="dVhour" class="value">–</span>
          <span class="small">m/s per hour</span>
        </div>
        <div class="kpi">
          <span class="label">Total Δv (for selected time):</span>
          <span id="dVtotal" class="value">–</span>
          <span class="small">m/s</span>
        </div>

        <div class="kpi">
          <span class="label">Thrust vector components:</span>
          <span id="thrustComponents" class="value">–</span>
          <span class="small">N along X/Y in spacecraft frame</span>
        </div>

        <div class="status-box">
          <div class="status-title">Interpretation</div>
          <div id="thrustComment">
            Adjust presets and sliders to see how FTAMCS scaling, CST resonance, vacuum geometry,
            corridor lock and reaction ring inertia scale microscopic thrust into a continuous internal engine.
          </div>
        </div>

        <div class="bubble-row">
          <div class="bubble">
            <strong>FTAMCS Source</strong>
            <span id="bubbleFTAMCS">Microscopic thrust only.</span>
          </div>
          <div class="bubble">
            <strong>CST Control</strong>
            <span id="bubbleCST">Resonance + timing active.</span>
          </div>
          <div class="bubble">
            <strong>Vacuum Geometry</strong>
            <span id="bubbleVac">Reaction ring coupled to Δv (no exhaust).</span>
          </div>
        </div>

        <div class="chips" id="chipRow"></div>

        <div style="margin-top:10px;">
          <button id="exportCsvBtn">Export Simulation CSV</button>
          <span class="small">
            Exports time, thrust, acceleration, Δv (engine running internally, momentum conserved in the ring).
          </span>
        </div>
      </div>

      <div class="panel">
        <h2>Internal Vacuum Chamber Engine</h2>
        <div class="chamber-diagram">
          <div class="circle">
            <div class="corridor-overlay" id="corridorOverlay"></div>
            <div class="corridor-label" id="corridorLabel">CST Corridor Active</div>
            <div class="ring"></div>
            <div class="ring-label">Internal reaction ring</div>
            <div class="thrust-arrow-wrap">
              <div class="thrust-arrow" id="thrustArrow"></div>
            </div>
          </div>
          <div class="small">
            FTAMCS tiles line the reaction ring. CST timing keeps collapse events
            phase-locked in a CST navigation corridor. Thrust is generated inside the
            spacecraft; momentum is conserved with the reaction absorbed by the ring
            and structure instead of exhaust gases.
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Construction Phases (Conceptual)</h2>
        <div class="two-col small">
          <div>
            <strong>Phase 1 — FTAMCS proof</strong><br>
            Thin-film AFM test to detect ~20 ± 10 nN thrust from asymmetric collapses.
          </div>
          <div>
            <strong>Phase 2 — CST timing electronics</strong><br>
            Lock collapse events to CST and drive resonance to create sustained internal thrust.
          </div>
          <div>
            <strong>Phase 3 — CST–FTAMCS vacuum chamber</strong><br>
            Chamber shape, reaction ring, collapse geometry, navigation vector control.
          </div>
          <div>
            <strong>Phase 4 — Engine module</strong><br>
            Single milli-newton range CST–FTAMCS propulsion unit.
          </div>
          <div>
            <strong>Phase 5 — Engine array</strong><br>
            Multiple modules combined into a spacecraft propulsion system
            (internal thrust, no exhaust, momentum conserved).
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Internal Engine Strip (Thrust Display)</h2>
        <div class="engine-strip">
          <div class="engine-fill" id="engineFill"></div>
        </div>
        <div class="small">
          Shows relative internal thrust level. When the engine is <strong>Stopped</strong>,
          the strip goes dim even if FTAMCS, CST, and vacuum are configured.
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function $(id){return document.getElementById(id);}

let engineOn = true; // start with engine running

// Compute FTAMCS-based thrust per tile (nN)
function computeFtamcsTileThrust(){
  const T0 = 20;      // nN reference
  const E  = 130;     // asymmetry enhancement
  const h0 = 500;     // nm
  const d0 = 50;      // nm
  const P0 = 5;       // mW/mm^2

  const a   = parseFloat($('asymmetry').value) || 0;
  const beta= parseFloat($('beta').value) || 0;
  const h   = parseFloat($('filmThickness').value) || h0;
  const d   = parseFloat($('grainSize').value) || d0;
  const P   = parseFloat($('pulsePower').value) || P0;
  const L   = Math.max(1, parseInt($('layers').value) || 1);

  // Asymmetry factor: 1 → E
  const A_asym = 1 + (E - 1) * a;

  // Residual factor: more beta → less thrust, clamp so it never goes negative
  let F_beta = 1 - beta;
  if(F_beta < 0.2) F_beta = 0.2;

  const thicknessFactor = Math.pow(h / h0, 1.5);
  const grainFactor     = Math.pow(d0 / d, 0.5);
  const powerFactor     = Math.pow(P / P0, 0.8);

  const tileThrust_nN = T0 * A_asym * F_beta *
    thicknessFactor * grainFactor * powerFactor * L;

  return tileThrust_nN;
}

// Simple resonance gain curve around f0 ≈ 0.49, Q ≈ 1.07
function computeResonanceGain(){
  const fDrive = parseFloat($('fDrive').value) || 0.49;
  const f0 = 0.49;
  const Gmax = 10;       // about tenfold mechanical amplification
  const width = 0.12;    // how wide the peak is

  const x = (fDrive - f0) / width;
  const G = 1 + (Gmax - 1) * Math.exp(-x * x);
  return G;
}

// Apply phase presets
function applyPhase(phase){
  switch(parseInt(phase,10)){
    case 1: // Phase 1 – FTAMCS Lab Proof
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = false;
      $('vacReady').checked    = false;

      $('baseThrust').value    = 20;
      $('tiles').value         = 1;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.0;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 1;

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.0;
      $('corridorActive').checked = false;
      $('chamberEff').value    = 0.0;
      $('ringCoupling').value  = 0.2;
      $('craftMass').value     = 1;
      $('burnTime').value      = 1;
      $('burnTimeSlider').value= 1;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 2: // Phase 2 – CST Timing Added
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = false;

      $('baseThrust').value    = 20;
      $('tiles').value         = 10;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.05;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 1;

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.8;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.0;
      $('ringCoupling').value  = 0.3;
      $('craftMass').value     = 50;
      $('burnTime').value      = 4;
      $('burnTimeSlider').value= 4;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 3: // Phase 3 – CST–FTAMCS Vacuum Chamber
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 1000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 5;
      $('layers').value        = 3;

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.9;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.7;
      $('ringCoupling').value  = 0.6;
      $('craftMass').value     = 200;
      $('burnTime').value      = 24;
      $('burnTimeSlider').value= 24;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 4: // Phase 4 – Engine Module
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 5000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 500;
      $('grainSize').value     = 50;
      $('pulsePower').value    = 6.5;
      $('layers').value        = 5;

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.95;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.8;
      $('ringCoupling').value  = 0.8;
      $('craftMass').value     = 500;
      $('burnTime').value      = 72;
      $('burnTimeSlider').value= 72;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;

    case 5: // Phase 5 – Engine Array
      $('ftamcsReady').checked = true;
      $('cstReady').checked    = true;
      $('vacReady').checked    = true;

      $('baseThrust').value    = 20;
      $('tiles').value         = 20000;
      $('useFtScaling').checked= true;

      $('asymmetry').value     = 1;
      $('beta').value          = 0.1;
      $('filmThickness').value = 600;
      $('grainSize').value     = 40;
      $('pulsePower').value    = 8;
      $('layers').value        = 7;

      $('fDrive').value        = 0.49;
      $('cstSync').value       = 0.97;
      $('corridorActive').checked = true;
      $('chamberEff').value    = 0.9;
      $('ringCoupling').value  = 0.9;
      $('craftMass').value     = 2000;
      $('burnTime').value      = 168; // 1 week
      $('burnTimeSlider').value= 168;
      $('corridorAngle').value = 0;
      $('corridorAngleSlider').value = 0;
      break;
  }
  engineOn = true;
  updateEngine();
}

// Core update function
function updateEngine(){
  const ftamcsOn   = $('ftamcsReady').checked;
  const cstOn      = $('cstReady').checked;
  const vacOn      = $('vacReady').checked;
  const corridorOn = $('corridorActive').checked;
  const useScaling = $('useFtScaling').checked;

  const tiles      = Math.max(1, parseInt($('tiles').value) || 1);
  const craftMassKg   = Math.max(1, parseFloat($('craftMass').value) || 1);
  const burnTimeHours = Math.max(0, parseFloat($('burnTime').value) || 0);
  const corridorDeg   = (parseFloat($('corridorAngle').value) || 0) % 360;

  // Base thrust per tile
  let baseManual = Math.max(0, parseFloat($('baseThrust').value) || 0);
  let tileThrust_nN = useScaling ? computeFtamcsTileThrust() : baseManual;
  $('ftamcsComputed').textContent = tileThrust_nN.toFixed(2);

  // Total microscopic thrust before CST/vacuum (nN)
  let thrust_nN = tileThrust_nN * tiles;

  if(!ftamcsOn || !engineOn){
    thrust_nN = 0;
  }else{
    // Resonance gain from drive frequency
    let resonanceGain = computeResonanceGain();
    $('resGainText').textContent = resonanceGain.toFixed(2);

    // CST resonance + timing
    let effectiveGain = 1;
    if(cstOn){
      const cstSync = parseFloat($('cstSync').value);
      const syncFactor = 0.1 + 0.9 * cstSync; // 0.1–1
      effectiveGain = resonanceGain * syncFactor;
    }

    // Vacuum chamber geometry efficiency
    const chamberEff = parseFloat($('chamberEff').value);
    let chamberFactor = 1;
    if(vacOn){
      chamberFactor = 0.2 + 0.8 * chamberEff; // 0.2–1
    }

    // Corridor lock factor: if corridor not locked, some cancellation
    let corridorFactor = corridorOn ? 1.0 : 0.5;

    // Reaction ring coupling: how much becomes translation
    const ringCoupling = parseFloat($('ringCoupling').value);
    let ringFactor = 0.1 + 0.9 * ringCoupling; // 0.1–1

    thrust_nN *= (effectiveGain * chamberFactor * corridorFactor * ringFactor);
  }

  const thrust_microN = thrust_nN / 1000;
  const thrust_milliN = thrust_microN / 1000;
  const thrust_N      = thrust_milliN / 1000;

  // Acceleration: a = F / m
  const accel_m_s2 = thrust_N / craftMassKg;
  const accel_mm_s2 = accel_m_s2 * 1000;
  const dv_per_hour_m_s = accel_m_s2 * 3600;
  const dv_total_m_s = dv_per_hour_m_s * burnTimeHours;

  $('thrustNn').textContent      = thrust_nN.toFixed(0);
  $('thrustMicroN').textContent  = thrust_microN.toFixed(3);
  $('thrustMilliN').textContent  = thrust_milliN.toFixed(6);
  $('accel').textContent         = accel_mm_s2.toFixed(6);
  $('dVhour').textContent        = dv_per_hour_m_s.toFixed(6);
  $('dVtotal').textContent       = dv_total_m_s.toFixed(6);

  // Thrust vector components in spacecraft frame
  const rad = corridorDeg * Math.PI/180;
  const Fx = thrust_N * Math.cos(rad);
  const Fy = thrust_N * Math.sin(rad);
  $('thrustComponents').textContent =
    `Fx = ${Fx.toExponential(3)} N, Fy = ${Fy.toExponential(3)} N @ ${corridorDeg.toFixed(0)}°`;

  // Rotate thrust arrow and corridor overlay
  const arrow = $('thrustArrow');
  arrow.style.transform = `rotate(${corridorDeg}deg)`;
  arrow.style.opacity = corridorOn ? '1' : '0.4';

  const overlay = $('corridorOverlay');
  const label   = $('corridorLabel');
  overlay.style.opacity = corridorOn ? '1' : '0';
  label.style.opacity   = corridorOn ? '1' : '0';

  // Readiness meter
  let readyCount = 0;
  if(ftamcsOn) readyCount++;
  if(cstOn)    readyCount++;
  if(vacOn)    readyCount++;

  const readinessPct = (readyCount / 3) * 100;
  $('readinessMeter').style.width = readinessPct + '%';

  let readinessText = '';
  let engineTagClass = 'tag-warn';
  let engineTagText  = 'Concept Only';

  if(readyCount === 0){
    readinessText = 'No components active: no internal thrust, no engine.';
    engineTagClass = 'tag-bad';
    engineTagText  = 'Inactive';
  }else if(readyCount === 1){
    readinessText = 'Only one component active. This is a fragment of the full concept (no complete engine behavior).';
    engineTagClass = 'tag-bad';
    engineTagText  = 'Fragment';
  }else if(readyCount === 2){
    readinessText = 'Two components active. You can model partial internal thrust, but not a full CST–FTAMCS engine.';
    engineTagClass = 'tag-warn';
    engineTagText  = 'Partial';
  }else if(readyCount === 3){
    readinessText = 'All three components active in this simulation. This approximates a full CST–FTAMCS engine module, still pending experimental FTAMCS thrust proof.';
    engineTagClass = 'tag-good';
    engineTagText  = 'Simulated Engine';
  }

  const engineTag = $('engineStateTag');
  engineTag.textContent = engineTagText;
  engineTag.className = 'tag ' + engineTagClass;
  $('readinessText').textContent = readinessText;

  // Bubble texts
  const cstSync = parseFloat($('cstSync').value);
  const chamberEff = parseFloat($('chamberEff').value);
  const ringCoupling = parseFloat($('ringCoupling').value);

  $('bubbleFTAMCS').textContent = ftamcsOn
    ? (useScaling
        ? 'Microscopic thrust source enabled with FTAMCS paper-based scaling.'
        : 'Microscopic thrust source enabled with manual per-tile value.')
    : 'FTAMCS off: no thrust events generated.';

  $('bubbleCST').textContent = cstOn
    ? (corridorOn
        ? `CST resonance + timing + corridor lock keep thrust coherent and aligned (sync ${(cstSync*100).toFixed(0)}%).`
        : 'CST resonance active, but corridor not locked: direction can wander internally.')
    : 'No CST control: collapse phases wander and thrust cancels as vibration.';

  $('bubbleVac').textContent = vacOn
    ? `Vacuum chamber routes reaction into the internal ring and spacecraft structure (eff ${(chamberEff*100).toFixed(0)}%).`
    : 'No chamber coupling: reaction remains as local stress and vibration, not useful Δv.';

  // Thrust comment
  let comment = '';
  if(!ftamcsOn){
    comment = 'Enable FTAMCS microscopic thrust to generate any internal impulse at all.';
  }else if(!engineOn){
    comment = 'Engine is stopped. Configuration is ready, but internal thrust is gated off by the Start/Stop control.';
  }else if(ftamcsOn && !cstOn && !vacOn){
    comment = 'You have microscopic FTAMCS thrust only. This represents a lab-scale internal effect, not yet a propulsion engine.';
  }else if(ftamcsOn && cstOn && !vacOn){
    comment = 'FTAMCS + CST gives directional internal thrust, but without a vacuum chamber and reaction ring, the momentum routing is inefficient.';
  }else if(ftamcsOn && cstOn && vacOn){
    if(thrust_milliN < 0.001){
      comment = 'You have a full internal engine structure, but effective thrust is still in the micro-newton regime. Good for proof-of-concept, micro-attitude control, and AFM-scale demonstrations.';
    }else if(thrust_milliN < 0.1){
      comment = 'Engine is in the milli-newton range in this simulation. Comparable to micro-propulsion used for small satellites, but based entirely on internal thrust and reaction ring coupling.';
    }else{
      comment = 'Engine is producing significant milli-newton-class internal thrust in this simulation. Real hardware would require detailed thermal, power, and materials constraints.';
    }
  }else{
    comment = 'Toggle CST and vacuum chamber on to see how internal FTAMCS thrust scales into a unified propulsion module.';
  }
  $('thrustComment').textContent = comment;

  // Engine strip visualization
  const strip = $('engineFill');
  if(strip){
    let level = 0;
    if(thrust_nN > 0){
      level = Math.min(1, Math.log10(1 + thrust_nN) / 6); // compress big ranges
    }
    strip.style.width = (level*100).toFixed(1) + '%';
    strip.style.opacity = (engineOn && thrust_nN > 0) ? '1' : '0.25';
  }

  // Run status text
  $('runStatus').textContent = engineOn
    ? 'Engine status: Running (internal thrust active in simulation).'
    : 'Engine status: Stopped (configuration only, no thrust).';

  // Chips
  const chipRow = $('chipRow');
  chipRow.innerHTML = '';
  function addChip(text){
    const span = document.createElement('span');
    span.className = 'chip';
    span.textContent = text;
    chipRow.appendChild(span);
  }

  addChip(`Tiles: ${tiles}`);
  addChip(useScaling ? 'Tile model: FTAMCS' : 'Tile model: Manual');
  addChip(`Tile thrust: ${tileThrust_nN.toFixed(1)} nN`);
  addChip(`ResGain ≈ ${computeResonanceGain().toFixed(2)}×`);
  addChip(`CST sync ${(cstSync*100).toFixed(0)}%`);
  addChip(`Chamber eff ${(chamberEff*100).toFixed(0)}%`);
  addChip(`Ring coup ${(ringCoupling*100).toFixed(0)}%`);
  addChip(`Mass: ${craftMassKg.toFixed(0)} kg`);
  addChip(`Burn: ${burnTimeHours.toFixed(0)} h`);
  addChip(`Angle: ${corridorDeg.toFixed(0)}°`);
}

// CSV export (uses same thrust model + engineOn)
function exportCsv(){
  const ftamcsOn   = $('ftamcsReady').checked;
  const cstOn      = $('cstReady').checked;
  const vacOn      = $('vacReady').checked;
  const corridorOn = $('corridorActive').checked;
  const useScaling = $('useFtScaling').checked;

  const tiles      = Math.max(1, parseInt($('tiles').value) || 1);
  const craftMassKg   = Math.max(1, parseFloat($('craftMass').value) || 1);
  const burnTimeHours = Math.max(0, parseFloat($('burnTime').value) || 0);
  const corridorDeg   = (parseFloat($('corridorAngle').value) || 0) % 360;

  let baseManual = Math.max(0, parseFloat($('baseThrust').value) || 0);
  let tileThrust_nN = useScaling ? computeFtamcsTileThrust() : baseManual;

  let thrust_nN = tileThrust_nN * tiles;
  if(!ftamcsOn || !engineOn){
    thrust_nN = 0;
  }else{
    let resonanceGain = computeResonanceGain();
    const cstSync = parseFloat($('cstSync').value);
    let effectiveGain = 1;
    if(cstOn){
      const syncFactor = 0.1 + 0.9 * cstSync;
      effectiveGain = resonanceGain * syncFactor;
    }
    const chamberEff = parseFloat($('chamberEff').value);
    let chamberFactor = 1;
    if(vacOn){
      chamberFactor = 0.2 + 0.8 * chamberEff;
    }
    let corridorFactor = corridorOn ? 1.0 : 0.5;
    const ringCoupling = parseFloat($('ringCoupling').value);
    let ringFactor = 0.1 + 0.9 * ringCoupling;

    thrust_nN *= (effectiveGain * chamberFactor * corridorFactor * ringFactor);
  }

  const thrust_microN = thrust_nN / 1000;
  const thrust_milliN = thrust_microN / 1000;
  const thrust_N      = thrust_milliN / 1000;
  const accel_m_s2    = thrust_N / craftMassKg;
  const rad           = corridorDeg * Math.PI/180;
  const Fx            = thrust_N * Math.cos(rad);
  const Fy            = thrust_N * Math.sin(rad);

  const dt = 1; // 1 hour step
  const steps = Math.max(1, Math.round(burnTimeHours/dt) || 1);

  let csv = 'time_hr,thrust_N,accel_m_s2,dv_m_s,corridor_deg,Fx_N,Fy_N\n';
  let dv = 0;

  for(let i=0;i<=steps;i++){
    const t = i*dt;
    if(i>0){
      dv += accel_m_s2 * 3600 * dt;
    }
    csv += [
      t.toFixed(3),
      thrust_N.toExponential(6),
      accel_m_s2.toExponential(6),
      dv.toExponential(6),
      corridorDeg.toFixed(2),
      Fx.toExponential(6),
      Fy.toExponential(6)
    ].join(',') + '\n';
  }

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cst_ftamcs_engine_simulation_v5.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Link UI events (sliders, toggles, presets)
[
  'ftamcsReady','cstReady','vacReady',
  'phasePreset',
  'baseThrust','tiles',
  'useFtScaling','asymmetry','beta',
  'filmThickness','grainSize','pulsePower','layers',
  'fDrive','cstSync','chamberEff','ringCoupling',
  'craftMass','burnTime','burnTimeSlider',
  'corridorAngle','corridorAngleSlider','corridorActive'
].forEach(id=>{
  const el = $(id);
  el.addEventListener('input', (e)=>{
    if(id === 'burnTime'){
      $('burnTimeSlider').value = e.target.value;
    }else if(id === 'burnTimeSlider'){
      $('burnTime').value = e.target.value;
    }else if(id === 'corridorAngle'){
      $('corridorAngleSlider').value = e.target.value;
    }else if(id === 'corridorAngleSlider'){
      $('corridorAngle').value = e.target.value;
    }else if(id === 'phasePreset'){
      applyPhase(e.target.value);
      return;
    }
    updateEngine();
  });
  el.addEventListener('change', (e)=>{
    if(id === 'phasePreset'){
      applyPhase(e.target.value);
      return;
    }
    if(id === 'burnTime'){
      $('burnTimeSlider').value = e.target.value;
    }else if(id === 'burnTimeSlider'){
      $('burnTime').value = e.target.value;
    }else if(id === 'corridorAngle'){
      $('corridorAngleSlider').value = e.target.value;
    }else if(id === 'corridorAngleSlider'){
      $('corridorAngle').value = e.target.value;
    }
    updateEngine();
  });
});

// Start / Stop / Reset buttons
$('startBtn').addEventListener('click', ()=>{
  engineOn = true;
  updateEngine();
});
$('stopBtn').addEventListener('click', ()=>{
  engineOn = false;
  updateEngine();
});
$('resetBtn').addEventListener('click', ()=>{
  engineOn = false;
  $('burnTime').value = 0;
  $('burnTimeSlider').value = 0;
  updateEngine();
});

$('exportCsvBtn').addEventListener('click', exportCsv);

// Initial setup
applyPhase(3);
</script>
</body>
</html>
