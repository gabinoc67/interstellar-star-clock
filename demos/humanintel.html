<!-- ======================= PART 1 / 4 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Human Intelligence Continuum ‚Äî Dual-Clock + Demography + Biogeography + Instrument Layer</title>

<style>
  :root{
    color-scheme: dark;
    --bg:#020617;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --line: rgba(148,163,184,.28);
    --brand:#38bdf8;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --vio:#a855f7;
    --shadow: 0 18px 45px rgba(0,0,0,.55);
    --radius: 18px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background: radial-gradient(circle at top, #020617 0, #000 55%, #000 100%);
    color:var(--ink);
  }
  header{
    padding:18px 22px;
    border-bottom:1px solid var(--line);
    background: radial-gradient(circle at top left, rgba(56,189,248,.95) 0, rgba(15,23,42,.92) 40%, #000 100%);
  }
  header h1{margin:0 0 6px;font-size:22px;letter-spacing:.03em}
  header p{margin:4px 0;font-size:13px;color:#bae6fd}
  header .sub{color:var(--muted);font-size:12px;line-height:1.35}

  .wrap{padding:16px; max-width: 1560px; margin:0 auto;}
  .grid{
    display:grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap:14px;
    align-items:start;
  }
  .panel{
    background: radial-gradient(circle at top, rgba(56,189,248,.14), rgba(15,23,42,.98));
    border-radius: var(--radius);
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-width:0;
  }
  .panel h2{
    margin:0;
    font-size:15px;
    font-weight:650;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .badge{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background: rgba(2,6,23,.55);
    color:#cfefff;
    white-space:nowrap;
  }
  .muted{color:var(--muted)}
  .mini{font-size:12px; line-height:1.35}

  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  input[type="text"], select{
    background: rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.55);
    border-radius:999px;
    color:var(--ink);
    padding:7px 12px;
    font-size:13px;
    outline:none;
  }
  select{padding-right:30px}

  .btn{
    cursor:pointer;
    user-select:none;
    border-radius:999px;
    padding:7px 12px;
    border:1px solid rgba(148,163,184,.55);
    background: rgba(2,6,23,.55);
    color:var(--ink);
    font-size:13px;
  }
  .btn:hover{border-color:rgba(56,189,248,.65)}
  .btn.primary{border-color: rgba(56,189,248,.75); background: rgba(56,189,248,.10);}
  .btn.warn{border-color: rgba(251,191,36,.75); background: rgba(251,191,36,.10);}

  .toggle{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border:1px solid rgba(148,163,184,.45);
    border-radius:999px;
    background: rgba(2,6,23,.45);
    font-size:12px;
  }
  .toggle input{transform: translateY(1px)}

  hr.sep{border:0; border-top:1px solid rgba(148,163,184,.22); margin:2px 0;}

  .tableWrap{
    max-height:460px;
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22)
  }
  table{width:100%; border-collapse:collapse; font-size:12.5px}
  th,td{padding:8px 9px; border-bottom:1px solid rgba(56,189,248,.18)}
  th{
    position:sticky; top:0;
    background: rgba(2,6,23,.85);
    text-transform:uppercase;
    font-size:10.5px;
    letter-spacing:.06em;
    color:var(--muted);
    border-bottom:1px solid rgba(148,163,184,.25);
  }
  tbody tr{cursor:pointer}
  tbody tr:hover{background:rgba(56,189,248,.12)}
  tbody tr.active-row{
    background: radial-gradient(circle at left, rgba(125,211,252,.30), rgba(15,23,42,.95));
  }

  .kpiRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .kpi{
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.35);
    padding:10px;
  }
  .kpi .label{font-size:11px;color:var(--muted)}
  .kpi .value{font-size:18px;font-weight:700;margin-top:2px}
  .kpi .hint{font-size:11px;color:#b7c7d8;margin-top:4px}

  .bar-row{display:flex;align-items:center;gap:10px;margin:3px 0}
  .bar-label{width:180px;font-size:11.5px;color:var(--muted)}
  .bar-track{
    flex:1;height:8px;border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.22);
    overflow:hidden;
  }
  .bar-fill{height:100%;border-radius:999px}

  .card{
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.35);
    border-radius:14px;
    padding:10px;
    min-width:0;
  }
  .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  canvas, svg{
    width:100%;
    height:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.30);
  }

  .sliderRow{
    display:grid;
    grid-template-columns: 180px 1fr 70px;
    align-items:center;
    gap:10px;
    margin:6px 0;
  }
  .sliderRow label{font-size:11.5px;color:var(--muted)}
  .sliderRow input[type="range"]{width:100%}
  .sliderRow .num{font-family: var(--mono); font-size:11.5px; color:#cfe7ff; text-align:right;}

  .callout{
    border-radius:14px;
    border:1px solid rgba(56,189,248,.30);
    background: rgba(56,189,248,.08);
    padding:10px;
  }
  .footer{
    margin-top:14px;
    padding:14px;
    border-radius: var(--radius);
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.35);
  }

  /* Heatmap */
  .heat{
    display:grid;
    grid-template-columns: repeat(10, 1fr);
    gap:3px;
    padding:6px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.25);
  }
  .cell{aspect-ratio: 1 / 1;border-radius:5px;border:1px solid rgba(148,163,184,.10);}

  /* Biogeography legend */
  .mapGrid{display:grid; grid-template-columns: 1.3fr .9fr; gap:10px;}
  .mapLegend{display:flex; flex-direction:column; gap:10px;}
  .pill{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px; border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.35);
    font-size:12px;
  }
  .pill .name{color:#cfefff}
  .pill .val{font-family:var(--mono); color:#cfe7ff}
  .tag{
    font-size:11px; padding:2px 8px; border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.35);
    color:#cfefff;
  }
  .smallBtnRow{display:flex; gap:8px; flex-wrap:wrap}

  /* Event log */
  .log{
    max-height:180px;
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background: rgba(2,6,23,.28);
    padding:8px;
    font-family: var(--mono);
    font-size:11.2px;
    line-height:1.35;
  }
  .log .row{padding:5px 6px; border-bottom:1px dashed rgba(148,163,184,.18)}
  .log .row:last-child{border-bottom:0}
  .log .t{color:#93c5fd}
  .log .m{color:#e5e7eb}
  .log .tag{margin-left:8px}

  /* Print-only */
  @media print{
    header, .footer, .controls, #tableHint, #mapHint, .toggle, #logHint { display:none !important; }
    body{ background:#fff !important; color:#000 !important; }
    .panel{ box-shadow:none !important; background:#fff !important; border:1px solid #bbb !important; }
    .card{ background:#fff !important; border:1px solid #ccc !important; }
    .muted{ color:#333 !important; }
    canvas, svg{ border:1px solid #ccc !important; }
    .grid{ gap:10px !important; }
  }
  @media(max-width: 980px){
    .grid{grid-template-columns:1fr}
    .tableWrap{max-height:340px}
    .kpiRow{grid-template-columns:1fr}
    .twoCol{grid-template-columns:1fr}
    .mapGrid{grid-template-columns:1fr}
  }
</style>
</head>

<body>
<header>
  <h1>Human Intelligence Continuum</h1>
  <p>
    A grounded, non-teleological model: <strong>dual evolutionary clocks</strong>, <strong>demography</strong>,
    <strong>biogeography</strong>, <strong>multi-hominid branching</strong>, <strong>regression/shocks</strong>,
    plus an <strong>auditable instrument layer</strong> (Terminal Q, S‚ÇçMoio‚Çé, OFN/TCFQ, Entropy, W‚ÇÇ¬≤).
  </p>
  <p class="sub">
    Provenance is explicit: timeline = widely-known milestones (illustrative), map = schematic network,
    numbers = stage presets + slider-driven ‚Äúwhat-if‚Äù controls, instrument meters = computed from visible formulas.
  </p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- ================= LEFT COLUMN (4 panels) ================= -->
    <div class="col">

      <section class="panel">
        <h2>üìú Timeline & Stages <span class="badge" id="modeBadge">Mode: Coupled (Bio√óCulture)</span></h2>

        <div class="controls">
          <input id="searchBox" type="text" placeholder="search year, region, lineage, idea‚Ä¶" />
          <select id="modeSelect" title="Evolution engine mode">
            <option value="coupled">Coupled (Bio √ó Culture)</option>
            <option value="bio">Biological emphasis</option>
            <option value="culture">Cultural emphasis</option>
          </select>

          <span class="toggle" title="Show academic definitions and assumptions">
            <input id="reviewerToggle" type="checkbox" />
            <label for="reviewerToggle">Reviewer Mode</label>
          </span>

          <span class="toggle" title="Show equations + live substitutions (auditability)">
            <input id="auditToggle" type="checkbox" />
            <label for="auditToggle">Show formulas</label>
          </span>

          <button class="btn" id="resetTuning">Reset tuning</button>
          <button class="btn primary" id="printSelected">Print selected</button>
        </div>

        <div class="callout mini muted">
          <strong>What changed (per critique + your new paragraph):</strong>
          acceleration explained by Bio‚ÜîCulture crossover; demography + biogeography constrain retention/diffusion;
          regression is possible; plus an auditable ‚Äúinstrument layer‚Äù (Terminal Q / S‚ÇçMoio‚Çé / OFN‚ÄìTCFQ / Entropy / W‚ÇÇ¬≤)
          that is <em>computed</em> (not claimed as experimental measurement).
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Region</th>
                <th>Lineage</th>
                <th>Key advance</th>
                <th>Physics maturity</th>
                <th>Retention</th>
              </tr>
            </thead>
            <tbody id="eventTable"></tbody>
          </table>
        </div>
        <div class="mini muted" id="tableHint">Click a row to update all panels. Pinned region is included in Print Selected.</div>
      </section>

      <section class="panel">
        <h2>üëµ Longevity & Intergenerational Teaching <span class="badge">Grandmother / teaching fit</span></h2>
        <div class="mini muted">Complex skills persist when learning time fits within lifespan + elder teaching window.</div>

        <div class="sliderRow">
          <label for="lifespanSlider">Average lifespan</label>
          <input id="lifespanSlider" type="range" min="15" max="80" step="1" />
          <div class="num" id="lifespanNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="learnSlider">Skill learning years</label>
          <input id="learnSlider" type="range" min="1" max="30" step="1" />
          <div class="num" id="learnNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="elderSlider">Elder teaching years</label>
          <input id="elderSlider" type="range" min="0" max="25" step="1" />
          <div class="num" id="elderNum">‚Äî</div>
        </div>

        <div id="longevityBars"></div>
      </section>

      <section class="panel">
        <h2>üß¨ Multi-Hominid Branch View <span class="badge">Non-linear selection landscape</span></h2>
        <div class="mini muted">Extinction is modeled as buffers + network reach + volatility‚Äînot ‚Äúinferiority.‚Äù</div>

        <div class="controls">
          <select id="speciesSelect" title="Select lineage">
            <option value="sapiens">Homo sapiens</option>
            <option value="neanderthal">Neanderthals</option>
            <option value="denisovan">Denisovans</option>
            <option value="hybrid">Hybrid / Admixed populations</option>
          </select>
          <button class="btn primary" id="compareAll">Compare all</button>
        </div>

        <svg id="branchSvg" viewBox="0 0 900 220"></svg>
        <div id="speciesBars"></div>
      </section>

      <section class="panel">
        <h2>üßØ Regression, Shocks & Local Optima <span class="badge">Anti-teleology</span></h2>
        <div class="mini muted">Adds collapses, dead-ends, regressions‚Äîprogress is survivability-weighted.</div>

        <div class="sliderRow">
          <label for="shockSlider">Environmental shock</label>
          <input id="shockSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="shockNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="resilienceSlider">Resilience policy</label>
          <input id="resilienceSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="resilienceNum">‚Äî</div>
        </div>

        <div id="riskBars"></div>
        <div class="mini muted" id="riskNote"></div>
      </section>

    </div>

    <!-- ================= RIGHT COLUMN (4 panels) ================= -->
    <div class="col">

      <section class="panel">
        <h2>üß† Results & Interpretation <span class="badge" id="selectedBadge">No stage selected</span></h2>

        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Computed intelligence index</div>
            <div class="value" id="kpiInt">‚Äî</div>
            <div class="hint">Core (Bio‚ÜîCulture) √ó retention √ó teaching fit. Not a destiny curve.</div>
          </div>
          <div class="kpi">
            <div class="label">Collapse probability</div>
            <div class="value" id="kpiCollapse">‚Äî</div>
            <div class="hint">Higher when fragility + shock exceed resilience.</div>
          </div>
        </div>

        <div class="twoCol">
          <div class="card">
            <div class="mini muted"><strong>Dual-clock crossover</strong> (biological ‚Üí cultural)</div>
            <canvas id="crossoverCanvas" width="900" height="260"></canvas>
            <div class="mini muted">Acceleration emerges when external memory crosses a threshold.</div>
          </div>
          <div class="card">
            <div class="mini muted"><strong>Intelligence as a distribution</strong> (not a scalar)</div>
            <div id="distBars"></div>
            <div class="mini muted">Toolmaking ‚Ä¢ Social ‚Ä¢ Symbolic ‚Ä¢ Planning ‚Ä¢ Environmental modeling.</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h2 style="margin:0 0 6px; font-size:14px;">üß† Efficiency-first Perception (Compression)</h2>
          <div class="callout mini muted" style="margin:6px 0 8px;">
            <strong>Design principle:</strong> perception prioritizes efficiency. Signal is compressed into manageable models;
            ‚Äústability‚Äù can reflect pruning, not perfect accuracy.
          </div>

          <div class="sliderRow">
            <label for="signalSlider">Signal load (inputs)</label>
            <input id="signalSlider" type="range" min="0" max="10" step="1" />
            <div class="num" id="signalNum">‚Äî</div>
          </div>
          <div class="sliderRow">
            <label for="accuracySlider">Accuracy demand</label>
            <input id="accuracySlider" type="range" min="0" max="10" step="1" />
            <div class="num" id="accuracyNum">‚Äî</div>
          </div>

          <div id="perceptionBars"></div>
          <div class="mini muted" id="perceptionNote"></div>
        </div>
      </section>

      <section class="panel">
        <h2>üß™ Instrument Layer (Terminal Q ‚Ä¢ S‚ÇçMoio‚Çé ‚Ä¢ OFN/TCFQ) <span class="badge" id="gateBadge">Gate: ‚Äî</span></h2>

        <div class="mini muted">
          These meters are <strong>computed</strong> from your sliders + explicit formulas (see ‚ÄúShow formulas‚Äù).
          They are <em>not experimental measurements</em>‚Äîthey are an auditable control-panel metaphor.
        </div>

        <div class="card">
          <h2 style="margin:0 0 6px; font-size:14px;">Terminal Q (Pivot / Maturity Gate)</h2>
          <div class="sliderRow">
            <label for="terminalQSlider">Terminal Q</label>
            <input id="terminalQSlider" type="range" min="0" max="100" step="1" />
            <div class="num" id="terminalQNum">‚Äî</div>
          </div>
          <div id="terminalQBars"></div>
          <div class="mini muted" id="terminalQNote"></div>
        </div>

        <div class="twoCol">
          <div class="card">
            <h2 style="margin:0 0 6px; font-size:14px;">Structural Synchrony S‚ÇçMoio‚Çé</h2>
            <div class="controls" style="margin-bottom:6px;">
              <select id="materialSelect" title="Simulation preset (not a lab claim)">
                <option value="AlN_Mo">Preset: AlN / Mo stack</option>
                <option value="SiC_Ti">Preset: SiC / Ti stack</option>
                <option value="Graphene_Al">Preset: Graphene / Al stack</option>
                <option value="Generic">Preset: Generic</option>
              </select>
              <span class="toggle" title="Phase-only vs geometry-emergent framing">
                <input id="metricToggle" type="checkbox" />
                <label for="metricToggle">Einstein metric emergent</label>
              </span>
            </div>
            <div id="syncBars"></div>
            <div class="mini muted" id="syncNote"></div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 6px; font-size:14px;">OFN / TCFQ terms</h2>
            <div class="mini muted">Constants shown as <em>named knobs</em> (defaults are placeholders, not claims).</div>

            <div class="sliderRow">
              <label for="xiSlider">Œæ (xi)</label>
              <input id="xiSlider" type="range" min="0" max="100" step="1" />
              <div class="num" id="xiNum">‚Äî</div>
            </div>
            <div class="sliderRow">
              <label for="betaSlider">Œ≤ (beta)</label>
              <input id="betaSlider" type="range" min="0" max="100" step="1" />
              <div class="num" id="betaNum">‚Äî</div>
            </div>

            <div id="ofnBars"></div>
            <div class="mini muted" id="ofnNote"></div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 6px; font-size:14px;">Event Log</h2>
          <div class="mini muted" id="logHint">Every change records a line (gate open/close, stabilizes, W‚ÇÇ¬≤ threshold, toggle flips).</div>
          <div class="log" id="eventLog"></div>
        </div>

        <div class="card" id="auditCard" style="display:none;">
          <h2 style="margin:0 0 6px; font-size:14px;">Formula Audit (Equations + Live Substitutions)</h2>
          <div class="mini muted">
            This panel is the ‚Äúanti-made-up‚Äù proof: every meter shows its formula and the substituted numbers used right now.
          </div>
          <div id="auditText" class="mini" style="margin-top:8px;"></div>
        </div>
      </section>

      <section class="panel">
        <h2>üß¨ Demography & Network Density <span class="badge">critical mass + contact</span></h2>
        <div class="mini muted">Innovation retention depends on effective population, inter-group contact, and loss risk.</div>

        <div class="sliderRow">
          <label for="popSlider">Effective population</label>
          <input id="popSlider" type="range" min="1" max="10" step="1" />
          <div class="num" id="popNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="contactSlider">Inter-group contact</label>
          <input id="contactSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="contactNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="lossSlider">Knowledge loss risk</label>
          <input id="lossSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="lossNum">‚Äî</div>
        </div>

        <div class="mini muted" style="margin-top:6px;"><strong>Retention heat map</strong></div>
        <div class="heat" id="heatMap"></div>
      </section>

      <section class="panel">
        <h2>üåç Biogeography Distribution Map <span class="badge">schematic network</span></h2>
        <div class="mini muted">
          Regionality prevents a single global line. This map is schematic (not GIS): nodes + links show diffusion constraints.
          Click a region to pin it; shift-click clears.
        </div>

        <div class="mapGrid" style="margin-top:8px;">
          <div>
            <svg id="worldMap" viewBox="0 0 900 440"></svg>
            <div class="mini muted" id="mapHint">Pinned region is included in Print Selected.</div>
          </div>
          <div class="mapLegend">
            <div class="pill"><div class="name">Pinned region</div><div class="val" id="pinName">None</div></div>
            <div class="pill"><div class="name">Pinned retention</div><div class="val" id="pinRetention">‚Äî</div></div>
            <div class="pill"><div class="name">Pinned intensity</div><div class="val" id="pinIntensity">‚Äî</div></div>
            <div class="pill"><div class="name">Diffusion pressure</div><div class="val" id="pinDiffusion">‚Äî</div></div>
            <div class="smallBtnRow">
              <span class="tag">Nodes: 10</span>
              <span class="tag">Links: contact</span>
              <span class="tag">Friction: distance</span>
            </div>

            <div class="callout mini muted">
              <strong>Data provenance (so reviewers don‚Äôt assume ‚Äúmade up‚Äù):</strong><br>
              ‚Ä¢ Timeline labels summarize widely-known milestones (illustrative).<br>
              ‚Ä¢ Map is explicitly a schematic network, not a geographic dataset.<br>
              ‚Ä¢ All stage numbers are heuristic presets for ‚Äúwhat-if‚Äù exploration.<br>
              ‚Ä¢ Instrument meters (Terminal Q / S‚ÇçMoio‚Çé / Entropy / W‚ÇÇ¬≤) are computed from visible formulas + your sliders.
            </div>
          </div>
        </div>

        <div class="footer" id="reviewerBox" style="display:none;">
          <h2 style="margin:0 0 6px; font-size:14px;">üßæ Reviewer Mode Notes</h2>
          <div class="mini muted" id="reviewerText"></div>
        </div>

        <div id="printArea" style="display:none;"></div>

        <div class="footer">
          <div class="mini muted"><strong>Printing:</strong> select a stage, optionally pin a region, then click <em>Print selected</em>.</div>
        </div>
      </section>

    </div>
  </div>
</div>
<!-- ======================= PART 2 / 4 ======================= -->
<script>
/* ========= Utilities ========= */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const sigmoid=(x)=>1/(1+Math.exp(-x));
const norm10=(x)=>clamp(x/10,0,1);
const fmtPct=(x)=>`${Math.round(x*100)}%`;

function hslColor(v){
  const hue = lerp(0,120,clamp(v,0,1));
  return `hsl(${hue} 85% 45%)`;
}
function barRow(label,val,color){
  const w = clamp(val,0,1)*100;
  return `
    <div class="bar-row">
      <div class="bar-label">${label}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${w}%;background:${color}"></div>
      </div>
    </div>
  `;
}

/* ========= Stage Data (heuristic presets, not measurements) ========= */
const stages = [
  {id:"s0",year:"~300,000 BCE",region:"East Africa",lineage:"Homo sapiens (early)",advance:"Symbolic scaffolding, language",physics:"Implicit / Embodied Physics",
   why:"Embodied mastery exists long before formal equations; cultural storage is limited, so knowledge can be fragile regionally.",
   constraint:4, info:3, tools:2, imagination:7, plasticity:7, brainLimit:4, symbolRate:2, externalMemory:1, teachingEff:2,
   pop:2, contact:2, loss:7, lifespan:28, learnYears:6, elderYears:3, dist:{tool:3,social:6,symbolic:4,planning:5,env:5}, shock:4, resilience:2},

  {id:"s1",year:"~40,000 BCE",region:"Europe & Central Asia",lineage:"H. sapiens + Neanderthals (overlap)",advance:"Art, music, compound tools",physics:"Implicit mechanics ‚Üí proto-formal heuristics",
   why:"Network density and contact control retention; coexisting lineages can be sophisticated without being linear steps.",
   constraint:8, info:5, tools:4, imagination:9, plasticity:7, brainLimit:5, symbolRate:5, externalMemory:3, teachingEff:5,
   pop:3, contact:4, loss:6, lifespan:30, learnYears:8, elderYears:4, dist:{tool:5,social:6,symbolic:7,planning:7,env:6}, shock:7, resilience:3},

  {id:"s2",year:"~10,000 BCE",region:"Fertile Crescent",lineage:"Homo sapiens",advance:"Agriculture, settlement, writing precursors",physics:"Measurement & counting (proto-formal)",
   why:"Surplus increases specialization; external memory rises; acceleration is cultural (exosomatic), not genetic.",
   constraint:5, info:7, tools:6, imagination:7, plasticity:6, brainLimit:6, symbolRate:7, externalMemory:6, teachingEff:7,
   pop:6, contact:6, loss:4, lifespan:32, learnYears:10, elderYears:5, dist:{tool:6,social:7,symbolic:7,planning:7,env:6}, shock:5, resilience:5},

  {id:"s3",year:"~600 BCE",region:"Mediterranean",lineage:"Homo sapiens",advance:"Logic, axioms, debate culture",physics:"Formal reasoning",
   why:"Formalism reduces loss by compressing knowledge into symbols; institutions stabilize transmission.",
   constraint:3, info:8, tools:5, imagination:8, plasticity:5, brainLimit:6, symbolRate:8, externalMemory:7, teachingEff:7,
   pop:6, contact:7, loss:3, lifespan:35, learnYears:12, elderYears:6, dist:{tool:5,social:7,symbolic:8,planning:8,env:7}, shock:3, resilience:6},

  {id:"s4",year:"1687",region:"England",lineage:"Homo sapiens",advance:"Classical mechanics",physics:"Predictive physics (models ‚Üí predictions)",
   why:"Instrumentation + publishing increase cultural storage; knowledge becomes more resilient to local shocks.",
   constraint:2, info:8, tools:6, imagination:7, plasticity:5, brainLimit:6, symbolRate:8, externalMemory:8, teachingEff:8,
   pop:7, contact:8, loss:2, lifespan:40, learnYears:14, elderYears:8, dist:{tool:7,social:6,symbolic:8,planning:7,env:8}, shock:2, resilience:7},

  {id:"s5",year:"1905",region:"Europe",lineage:"Homo sapiens",advance:"Relativity (conceptual reframing)",physics:"Spacetime physics (formal + counterfactual)",
   why:"Global networks expand contact; formal tools enable counterfactual reasoning without teleology.",
   constraint:2, info:9, tools:6, imagination:9, plasticity:5, brainLimit:6, symbolRate:9, externalMemory:9, teachingEff:8,
   pop:8, contact:8, loss:2, lifespan:50, learnYears:16, elderYears:10, dist:{tool:7,social:6,symbolic:9,planning:8,env:8}, shock:2, resilience:7},

  {id:"s6",year:"2020s",region:"Global",lineage:"Homo sapiens",advance:"Human‚ÄìAI co-reasoning",physics:"Tool-augmented physics (simulation)",
   why:"Acceleration is computational + cultural storage. Still vulnerable to institutional fragility and shocks.",
   constraint:6, info:10, tools:10, imagination:9, plasticity:5, brainLimit:6, symbolRate:10, externalMemory:10, teachingEff:9,
   pop:9, contact:10, loss:3, lifespan:72, learnYears:18, elderYears:14, dist:{tool:9,social:7,symbolic:9,planning:9,env:9}, shock:4, resilience:6},

  {id:"s7",year:"Future",region:"Planetary / Space-based",lineage:"Multiple lineages / designed intelligence",advance:"Spacetime engineering (hypothesis)",physics:"Experimental spacetime control (hypothesis)",
   why:"If achieved, it emerges from durable institutions + tooling + ethics‚Äînot inevitable progress.",
   constraint:7, info:10, tools:10, imagination:10, plasticity:5, brainLimit:6, symbolRate:10, externalMemory:10, teachingEff:10,
   pop:10, contact:10, loss:2, lifespan:80, learnYears:22, elderYears:18, dist:{tool:10,social:8,symbolic:10,planning:10,env:10}, shock:3, resilience:8}
];

/* ========= Multi-hominid model knobs (heuristic) ========= */
const species = {
  sapiens:{name:"Homo sapiens", buf:7, net:7, vol:5, sym:8, tool:8},
  neanderthal:{name:"Neanderthals", buf:4, net:4, vol:7, sym:6, tool:7},
  denisovan:{name:"Denisovans", buf:3, net:3, vol:7, sym:5, tool:6},
  hybrid:{name:"Hybrid / Admixed", buf:5, net:6, vol:6, sym:7, tool:7}
};

/* ========= Base Engine functions ========= */
function bioCapacity(s){
  const lifeN = clamp((s.lifespan-15)/(80-15),0,1);
  return (norm10(s.plasticity)*0.45 + norm10(s.brainLimit)*0.25 + lifeN*0.30);
}
function culturalStorage(s){
  return (norm10(s.symbolRate)*0.33 + norm10(s.externalMemory)*0.42 + norm10(s.teachingEff)*0.25);
}
function retentionScore(pop, contact, loss){
  const p = norm10(pop), c = norm10(contact), l = norm10(loss);
  const critical = sigmoid((pop-4)*0.9);        // ‚Äúcritical mass‚Äù threshold
  const raw = (0.55*p + 0.35*c) * (1 - 0.55*l) * critical;
  return clamp(raw,0,1);
}
function longevityTeachingFactor(lifespan, learnYears, elderYears){
  const productive = clamp(lifespan-12,0,80);
  const teachWindow = clamp(productive*0.25 + elderYears, 0, 80);
  const fit = clamp((teachWindow - learnYears)/Math.max(learnYears,1), -2, 2);
  return clamp(sigmoid(fit*1.2),0,1);
}
function collapseProbability(s, ret, teach){
  const shock = norm10(s.shock);
  const resilience = norm10(s.resilience);
  const fragility = clamp(1 - (0.62*ret + 0.38*teach), 0, 1);
  const x = (0.60*shock + 0.55*fragility - 0.55*resilience);
  return clamp(sigmoid((x-0.35)*3.2), 0, 1);
}
function intelligenceIndex(s, mode, ret, teach){
  const bio = bioCapacity(s);
  const cul = culturalStorage(s);
  const ext = norm10(s.externalMemory);
  const crossover = sigmoid((ext - 0.45)*7);

  let core;
  if(mode==="bio"){
    core = bio*(0.65 + 0.35*(1-crossover)) + cul*0.10;
  }else if(mode==="culture"){
    core = cul*(0.65 + 0.35*crossover) + bio*0.10;
  }else{
    core = (bio*0.55 + cul*0.65) * (0.75 + 0.25*crossover);
  }
  return clamp(core * (0.60 + 0.40*ret) * (0.65 + 0.35*teach), 0, 1);
}

/* ========= Efficiency vs Accuracy perception model (computed meter) ========= */
function perceptionCompression(signalLoad, accuracyDemand, brainLimit){
  // Inputs are 0‚Äì10.
  const loadN = norm10(signalLoad);
  const accN = norm10(accuracyDemand);
  const brainN = norm10(brainLimit);

  // Efficiency pressure increases with load and limited capacity.
  const eff = clamp(0.62*loadN + 0.28*(1-accN) + 0.10*(1-brainN), 0, 1);

  // Compression = prune tendency vs accuracy.
  const compression = clamp(sigmoid((eff - accN)*4.2), 0, 1);

  // Perceived stability can increase with compression.
  const perceivedStability = clamp(0.20 + 0.80*compression*(1 - 0.35*loadN), 0, 1);

  // Error sensitivity rises when compression is low.
  const errorSensitivity = clamp(1 - compression, 0, 1);

  // Processing cost proxy (UI meter only).
  const processingCost = clamp(0.20 + 0.80*loadN*(1 - 0.55*compression), 0, 1);

  return {eff, compression, perceivedStability, errorSensitivity, processingCost, loadN, accN, brainN};
}

/* ========= Crossover plot helper points ========= */
const timePoints = [{t:"~300k"},{t:"~40k"},{t:"~10k"},{t:"~600"},{t:"1687"},{t:"1905"},{t:"2020"},{t:"fut"}];
</script>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
/* ========= Biogeography (schematic network) ========= */
let pinnedRegionId = null;
const regions = [
  {id:"eaf", name:"East Africa", x:430, y:240, hub:0.75, stab:0.70, fric:0.20},
  {id:"naf", name:"North Africa", x:430, y:195, hub:0.65, stab:0.55, fric:0.25},
  {id:"lev", name:"Levant", x:480, y:190, hub:0.85, stab:0.60, fric:0.18},
  {id:"eur", name:"Europe", x:500, y:150, hub:0.80, stab:0.55, fric:0.22},
  {id:"csa", name:"Central Asia", x:560, y:165, hub:0.55, stab:0.45, fric:0.35},
  {id:"sas", name:"South Asia", x:600, y:225, hub:0.75, stab:0.55, fric:0.30},
  {id:"eas", name:"East Asia", x:680, y:185, hub:0.85, stab:0.55, fric:0.25},
  {id:"sea", name:"SE Asia", x:660, y:255, hub:0.70, stab:0.50, fric:0.30},
  {id:"aus", name:"Australia", x:740, y:330, hub:0.40, stab:0.40, fric:0.55},
  {id:"ame", name:"Americas", x:250, y:210, hub:0.60, stab:0.45, fric:0.50}
];
const links = [
  ["eaf","naf"],["naf","lev"],["lev","eur"],["lev","csa"],["csa","eas"],["csa","sas"],["sas","sea"],["sea","eas"],
  ["sea","aus"],["eas","ame"],["eur","ame"],["eaf","lev"],["sas","eas"]
];

function computeRegional(s, mode){
  const retGlobal = retentionScore(s.pop, s.contact, s.loss);
  const teach = longevityTeachingFactor(s.lifespan, s.learnYears, s.elderYears);
  const idx = intelligenceIndex(s, mode, retGlobal, teach);
  const contactN = norm10(s.contact);
  const diffusion = clamp(0.25 + 0.75*contactN, 0, 1);
  const lossN = norm10(s.loss);

  const computed = regions.map(r=>{
    const fricEff = clamp(r.fric * (1 - 0.55*contactN), 0, 1);
    const baseRet = retGlobal * r.stab * (1 - fricEff);
    const localRet = clamp(baseRet * (1 - 0.35*lossN) * (0.70 + 0.30*r.hub), 0, 1);
    const intensity = clamp(idx * localRet * (0.55 + 0.45*r.hub) * (0.50 + 0.50*diffusion), 0, 1);
    return {...r, friction:fricEff, retention:localRet, intensity, diffusion, idx, retGlobal};
  });

  const linkStrength = links.map(([a,b])=>{
    const A = computed.find(x=>x.id===a);
    const B = computed.find(x=>x.id===b);
    const base = (A.intensity + B.intensity)/2;
    const dist = Math.hypot(A.x-B.x, A.y-B.y);
    const distN = clamp(dist/600, 0, 1);
    const contactN2 = norm10(s.contact);
    const strength = clamp(base * (1 - 0.55*distN) * (0.55 + 0.45*contactN2), 0, 1);
    return {a,b,strength};
  });

  return {computed, linkStrength, idx, retGlobal, diffusion, teach};
}

function mapBg(){
  return `
  <defs>
    <radialGradient id="ocean" cx="35%" cy="25%" r="80%">
      <stop offset="0%" stop-color="rgba(56,189,248,.10)"/>
      <stop offset="55%" stop-color="rgba(2,6,23,.55)"/>
      <stop offset="100%" stop-color="rgba(2,6,23,.85)"/>
    </radialGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2.5" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
  <rect x="0" y="0" width="900" height="440" fill="url(#ocean)"/>
  <path d="M160,120 C220,80 320,80 370,120 C410,155 410,220 360,260 C320,290 240,280 210,240 C170,200 120,165 160,120 Z"
        fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
  <path d="M420,110 C470,70 560,70 610,110 C650,145 660,200 620,245 C580,285 500,300 455,260 C420,228 390,160 420,110 Z"
        fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
  <path d="M650,250 C700,220 780,235 810,280 C830,315 810,360 765,375 C720,390 670,370 650,330 C635,300 630,275 650,250 Z"
        fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
  <path d="M420,250 C450,230 500,235 525,265 C545,290 540,330 510,350 C475,372 435,360 420,330 C405,300 400,275 420,250 Z"
        fill="rgba(148,163,184,.08)" stroke="rgba(148,163,184,.08)"/>
  <text x="16" y="22" fill="rgba(156,163,175,.95)" font-size="12">Regional distribution (schematic)</text>
  `;
}

/* ========= NEW Instrument Layer math =========
   Important: these are computed meters (UI model), not experimental claims.
*/
const MATERIAL_PRESETS = {
  AlN_Mo: {name:"AlN / Mo", factor:1.00},
  SiC_Ti: {name:"SiC / Ti", factor:0.94},
  Graphene_Al: {name:"Graphene / Al", factor:0.90},
  Generic: {name:"Generic", factor:0.92}
};

// Entropy score (0..1): higher with shock/loss/processing cost, lower with retention/teaching/synchrony.
function entropyScore(lossN, shockN, processingCost, ret, teach, sync){
  const drift = clamp(0.40*lossN + 0.35*shockN + 0.25*processingCost, 0, 1);
  const damping = clamp(0.45*ret + 0.25*teach + 0.30*sync, 0, 1);
  return clamp(drift*(1 - 0.65*damping), 0, 1);
}

// W2 distance proxy (0..1): distance-to-target between ‚Äúdesired accuracy‚Äù and ‚Äúachieved stability under compression‚Äù.
// Interpreted as a convergence dial, not an actual Wasserstein computation.
function w2DistanceProxy(accN, perceivedStability, errorSensitivity, metricEmergent){
  const target = accN;
  const achieved = clamp(0.60*perceivedStability + 0.40*(1-errorSensitivity), 0, 1);
  const base = Math.abs(target - achieved);               // 0..1
  const geoPenalty = metricEmergent ? 0.00 : 0.10;        // ‚Äúgeometry dissolves‚Äù increases mismatch penalty a bit
  return clamp(base + geoPenalty, 0, 1);
}

// Structural synchrony S_Moio (0..1): coherence-like stability built from retention/teaching/perception + material factor + toggle.
function structuralSynchrony(ret, teach, perceivedStability, errorSensitivity, materialFactor, metricEmergent){
  const base = clamp(0.42*ret + 0.28*teach + 0.30*perceivedStability, 0, 1);
  const errPenalty = clamp(0.35*errorSensitivity, 0, 1);
  const metricBoost = metricEmergent ? 1.00 : 0.92;
  return clamp((base*(1 - errPenalty))*materialFactor*metricBoost, 0, 1);
}

// Residual error proxy (km): scaled from W2 distance and contact friction.
// (Again: UI proxy, not a measured distance.)
function residualErrorKm(w2, contactN){
  const scale = 1200; // km scale chosen for readable UI (not a physical claim)
  const friction = (1 - 0.55*contactN);
  return clamp(w2*scale*(0.65 + 0.35*friction), 0, 2000);
}

// Terminal Q gate logic: uses Q slider + synchrony + low entropy + W2 threshold + low collapse
function terminalQGate(q, sync, entropy, w2, collapse){
  const cond = (q>=0.70) && (sync>=0.65) && (entropy<=0.45) && (w2<=0.35) && (collapse<=0.55);
  return cond;
}

/* ========= Event log helpers ========= */
function nowStamp(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function pushLog(state, kind, msg){
  if(!state || !state.logEl) return;
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `<span class="t">[${nowStamp()}]</span> <span class="m">${msg}</span> <span class="tag">${kind}</span>`;
  state.logEl.prepend(row);

  // Cap log size
  const rows = state.logEl.querySelectorAll(".row");
  if(rows.length > 120){
    for(let i=rows.length-1;i>=120;i--) rows[i].remove();
  }
}

/* ========= Crossover plot ========= */
function drawCrossover(canvas, selected){
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle = "rgba(2,6,23,.25)";
  ctx.fillRect(0,0,w,h);

  const padL=46, padR=14, padT=18, padB=34;
  const gx0=padL, gx1=w-padR, gy0=padT, gy1=h-padB;

  ctx.strokeStyle="rgba(148,163,184,.22)";
  ctx.lineWidth=1;
  for(let i=0;i<=5;i++){
    const y = lerp(gy1, gy0, i/5);
    ctx.beginPath(); ctx.moveTo(gx0,y); ctx.lineTo(gx1,y); ctx.stroke();
  }

  const xs = timePoints.map((_,i)=> lerp(gx0,gx1, i/(timePoints.length-1)) );
  ctx.fillStyle="rgba(156,163,175,.95)";
  ctx.font="11px "+getComputedStyle(document.body).fontFamily;
  timePoints.forEach((p,i)=> ctx.fillText(p.t, xs[i]-10, h-12));

  if(!selected){
    ctx.fillStyle="rgba(186,230,253,.85)";
    ctx.font="12px "+getComputedStyle(document.body).fontFamily;
    ctx.fillText("Select a stage to plot Bio vs Culture contributions.", gx0+10, gy0+20);
    return;
  }

  const baseBio = bioCapacity(selected);
  const baseCul = culturalStorage(selected);

  const series = timePoints.map((_,i)=>{
    const t = i/(timePoints.length-1);
    const culRamp = sigmoid((t-0.40)*8);
    const bio = clamp(lerp(baseBio*0.95, baseBio*1.05, t*0.35),0,1);
    const cul = clamp(baseCul * lerp(0.35, 1.25, culRamp),0,1);
    return {bio, cul};
  });

  function plot(getY, stroke){
    ctx.strokeStyle=stroke;
    ctx.lineWidth=2.4;
    ctx.beginPath();
    series.forEach((pt,i)=>{
      const x = xs[i];
      const y = lerp(gy1, gy0, getY(pt));
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  plot(pt=>pt.bio, "rgba(34,211,238,.95)");
  plot(pt=>pt.cul, "rgba(74,222,128,.95)");
}

/* ========= World map renderer ========= */
function renderWorldMap(worldMap, model, state){
  if(!worldMap || !model) return;
  const {computed, linkStrength} = model;

  const linkSvg = linkStrength.map(L=>{
    const A = computed.find(r=>r.id===L.a);
    const B = computed.find(r=>r.id===L.b);
    const alpha = lerp(0.05, 0.55, L.strength);
    const width = lerp(0.8, 3.8, L.strength);
    return `<line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}"
                  stroke="rgba(56,189,248,${alpha})" stroke-width="${width}" stroke-linecap="round"/>`;
  }).join("");

  const nodesSvg = computed.map(r=>{
    const pin = (pinnedRegionId===r.id);
    const rad = pin ? 11 : 9;
    const stroke = pin ? "rgba(236,72,153,.95)" : "rgba(229,231,235,.25)";
    const strokeW = pin ? 2.5 : 1.2;
    const glow = pin ? `filter="url(#glow)"` : "";
    const title = `${r.name}
Intensity: ${Math.round(r.intensity*100)}%
Retention: ${Math.round(r.retention*100)}%
Friction: ${Math.round(r.friction*100)}%`;
    return `
      <g class="node" data-id="${r.id}" style="cursor:pointer">
        <circle cx="${r.x}" cy="${r.y}" r="${rad}" fill="${hslColor(r.intensity)}"
                stroke="${stroke}" stroke-width="${strokeW}" ${glow}>
          <title>${title}</title>
        </circle>
        <text x="${r.x+14}" y="${r.y+4}" font-size="12" fill="rgba(229,231,235,.85)">${r.name}</text>
      </g>
    `;
  }).join("");

  worldMap.innerHTML = mapBg() + linkSvg + nodesSvg;

  worldMap.querySelectorAll(".node").forEach(g=>{
    g.addEventListener("click", (ev)=>{
      const id = g.getAttribute("data-id");
      if(ev.shiftKey) pinnedRegionId = null;
      else pinnedRegionId = (pinnedRegionId===id) ? null : id;

      // log pin changes
      if(state){
        pushLog(state, `<span class="tag">MAP</span>`, pinnedRegionId ? `Pinned region ‚Üí ${regions.find(x=>x.id===pinnedRegionId).name}` : `Cleared pinned region`);
      }
      state && state.recalc && state.recalc();
    });
  });
}
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
document.addEventListener("DOMContentLoaded", ()=>{

/* ========= DOM refs ========= */
const tableBody = document.getElementById("eventTable");
const searchBox = document.getElementById("searchBox");
const modeSelect = document.getElementById("modeSelect");
const modeBadge = document.getElementById("modeBadge");
const selectedBadge = document.getElementById("selectedBadge");

const reviewerToggle = document.getElementById("reviewerToggle");
const reviewerBox = document.getElementById("reviewerBox");
const reviewerText = document.getElementById("reviewerText");

const auditToggle = document.getElementById("auditToggle");
const auditCard = document.getElementById("auditCard");
const auditText = document.getElementById("auditText");

const resetTuningBtn = document.getElementById("resetTuning");
const printBtn = document.getElementById("printSelected");
const printArea = document.getElementById("printArea");

const kpiInt = document.getElementById("kpiInt");
const kpiCollapse = document.getElementById("kpiCollapse");

const crossoverCanvas = document.getElementById("crossoverCanvas");
const distBars = document.getElementById("distBars");

const popSlider = document.getElementById("popSlider");
const contactSlider = document.getElementById("contactSlider");
const lossSlider = document.getElementById("lossSlider");
const popNum = document.getElementById("popNum");
const contactNum = document.getElementById("contactNum");
const lossNum = document.getElementById("lossNum");
const heatMap = document.getElementById("heatMap");

const lifespanSlider = document.getElementById("lifespanSlider");
const learnSlider = document.getElementById("learnSlider");
const elderSlider = document.getElementById("elderSlider");
const lifespanNum = document.getElementById("lifespanNum");
const learnNum = document.getElementById("learnNum");
const elderNum = document.getElementById("elderNum");
const longevityBars = document.getElementById("longevityBars");

const shockSlider = document.getElementById("shockSlider");
const resilienceSlider = document.getElementById("resilienceSlider");
const shockNum = document.getElementById("shockNum");
const resilienceNum = document.getElementById("resilienceNum");
const riskBars = document.getElementById("riskBars");
const riskNote = document.getElementById("riskNote");

const signalSlider = document.getElementById("signalSlider");
const accuracySlider = document.getElementById("accuracySlider");
const signalNum = document.getElementById("signalNum");
const accuracyNum = document.getElementById("accuracyNum");
const perceptionBars = document.getElementById("perceptionBars");
const perceptionNote = document.getElementById("perceptionNote");

const speciesSelect = document.getElementById("speciesSelect");
const compareAllBtn = document.getElementById("compareAll");
const branchSvg = document.getElementById("branchSvg");
const speciesBars = document.getElementById("speciesBars");

const worldMap = document.getElementById("worldMap");
const pinName = document.getElementById("pinName");
const pinRetention = document.getElementById("pinRetention");
const pinIntensity = document.getElementById("pinIntensity");
const pinDiffusion = document.getElementById("pinDiffusion");

/* Instrument layer DOM */
const gateBadge = document.getElementById("gateBadge");
const terminalQSlider = document.getElementById("terminalQSlider");
const terminalQNum = document.getElementById("terminalQNum");
const terminalQBars = document.getElementById("terminalQBars");
const terminalQNote = document.getElementById("terminalQNote");

const materialSelect = document.getElementById("materialSelect");
const metricToggle = document.getElementById("metricToggle");
const syncBars = document.getElementById("syncBars");
const syncNote = document.getElementById("syncNote");

const xiSlider = document.getElementById("xiSlider");
const betaSlider = document.getElementById("betaSlider");
const xiNum = document.getElementById("xiNum");
const betaNum = document.getElementById("betaNum");
const ofnBars = document.getElementById("ofnBars");
const ofnNote = document.getElementById("ofnNote");

const eventLog = document.getElementById("eventLog");

/* ========= State ========= */
let selectedStage = stages[0];
let compareAll = false;

// For event log change detection
let prev = {
  gate:null, metric:null, pinned:null,
  w2:null, entropy:null, sync:null
};

const state = {
  logEl: eventLog,
  recalc: null
};

/* ========= Reviewer copy ========= */
const reviewerCopy = `
<strong>Why acceleration happens (no magic jumps)</strong><br>
‚Ä¢ Two coupled clocks: slow <em>biological</em> + fast <em>cultural</em> (external memory).<br>
‚Ä¢ When external memory density crosses a threshold, growth becomes network-driven.<br><br>

<strong>Demography + biogeography</strong><br>
‚Ä¢ Retention depends on effective population (critical mass), inter-group contact, and loss risk.<br>
‚Ä¢ Map prevents a single global line; diffusion is constrained by distance/contact (schematic).<br><br>

<strong>Physics maturity labels</strong><br>
‚Ä¢ ‚ÄúPre-physical‚Äù removed: early humans use <em>Implicit / Embodied Physics</em> without formal math.<br><br>

<strong>Non-linear intelligence history</strong><br>
‚Ä¢ Multi-hominid tracks are explicit; extinction modeled via buffers + reach + volatility.<br>
‚Ä¢ Regression is possible via shocks and fragility; progress is survivability-weighted.<br><br>

<strong>Instrument layer (Terminal Q / S‚ÇçMoio‚Çé / Entropy / W‚ÇÇ¬≤)</strong><br>
‚Ä¢ These are computed UI meters from visible formulas + your sliders.<br>
‚Ä¢ They are not experimental measurements; they are an auditable control-panel metaphor.
`;

/* ========= UI helpers ========= */
function updateModeBadge(){
  const m = modeSelect.value;
  const label = m==="bio" ? "Biological emphasis" : (m==="culture" ? "Cultural emphasis" : "Coupled (Bio√óCulture)");
  modeBadge.textContent = "Mode: " + label;
}

function syncSliderLabels(){
  popNum.textContent = `${popSlider.value}/10`;
  contactNum.textContent = `${contactSlider.value}/10`;
  lossNum.textContent = `${lossSlider.value}/10`;

  lifespanNum.textContent = `${lifespanSlider.value}y`;
  learnNum.textContent = `${learnSlider.value}y`;
  elderNum.textContent = `${elderSlider.value}y`;

  shockNum.textContent = `${shockSlider.value}/10`;
  resilienceNum.textContent = `${resilienceSlider.value}/10`;

  signalNum.textContent = `${signalSlider.value}/10`;
  accuracyNum.textContent = `${accuracySlider.value}/10`;

  terminalQNum.textContent = `${terminalQSlider.value}/100`;
  xiNum.textContent = `${(xiSlider.value/100).toFixed(2)}`;
  betaNum.textContent = `${(betaSlider.value/100).toFixed(2)}`;
}

function renderDistributionBars(s){
  const d = s.dist;
  distBars.innerHTML =
    barRow("Toolmaking", norm10(d.tool), "linear-gradient(to right, rgba(34,197,94,.95), rgba(74,222,128,.95))") +
    barRow("Social reasoning", norm10(d.social), "linear-gradient(to right, rgba(56,189,248,.95), rgba(34,197,94,.95))") +
    barRow("Symbolic compression", norm10(d.symbolic), "linear-gradient(to right, rgba(168,85,247,.95), rgba(56,189,248,.95))") +
    barRow("Long-term planning", norm10(d.planning), "linear-gradient(to right, rgba(251,191,36,.95), rgba(236,72,153,.95))") +
    barRow("Environmental modeling", norm10(d.env), "linear-gradient(to right, rgba(234,179,8,.95), rgba(34,197,94,.95))");
}

function renderHeat(loss){
  heatMap.innerHTML="";
  for(let r=10;r>=1;r--){
    for(let c=0;c<=9;c++){
      const ret = retentionScore(r, c, loss);
      const div = document.createElement("div");
      div.className="cell";
      div.style.background = hslColor(ret);
      div.title = `pop ${r}, contact ${c}, loss ${loss} ‚Üí retention ${Math.round(ret*100)}%`;
      heatMap.appendChild(div);
    }
  }
}

function renderLongevityBars(lifespan, learnYears, elderYears){
  const teach = longevityTeachingFactor(lifespan, learnYears, elderYears);
  const productive = clamp(lifespan-12,0,80);
  const teachWindow = clamp(productive*0.25 + elderYears, 0, 80);

  longevityBars.innerHTML =
    barRow("Teaching fit (0‚Äì1)", teach, "linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))") +
    barRow("Teach window / learning", clamp(teachWindow/Math.max(learnYears,1),0,1), "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))") +
    `<div class="mini muted" style="margin-top:6px;">
      Productive years: <span style="font-family:var(--mono);color:#cfe7ff">${productive.toFixed(0)}y</span> ¬∑
      Teaching window: <span style="font-family:var(--mono);color:#cfe7ff">${teachWindow.toFixed(1)}y</span>.
    </div>`;
  return teach;
}

function renderRiskBars(s, ret, teach){
  const collapse = collapseProbability(s, ret, teach);
  const fragility = clamp(1 - (0.62*ret + 0.38*teach), 0, 1);
  const shock = norm10(s.shock);
  const resilience = norm10(s.resilience);

  riskBars.innerHTML =
    barRow("Retention stability", ret, "linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))") +
    barRow("Knowledge fragility", fragility, "linear-gradient(to right, rgba(74,222,128,.95), rgba(251,113,133,.95))") +
    barRow("Shock intensity", shock, "linear-gradient(to right, rgba(100,116,139,.95), rgba(251,113,133,.95))") +
    barRow("Resilience policy", resilience, "linear-gradient(to right, rgba(251,191,36,.95), rgba(34,197,94,.95))") +
    barRow("Collapse probability", collapse, "linear-gradient(to right, rgba(251,191,36,.95), rgba(251,113,133,.95))");

  const note = collapse < 0.33 ? "Low: buffers likely preserve complex knowledge." :
               collapse < 0.66 ? "Medium: regression is plausible; complex systems are fragile under shocks." :
               "High: collapses likely; knowledge may fragment and require rediscovery.";
  riskNote.innerHTML = `<strong style="color:#cfefff">Interpretation:</strong> <span class="muted">${note}</span>`;
  return collapse;
}

function renderPerceptionPanel(s){
  const P = perceptionCompression(+signalSlider.value, +accuracySlider.value, s.brainLimit);

  perceptionBars.innerHTML =
    barRow("Compression / pruning", P.compression, "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))") +
    barRow("Perceived stability", P.perceivedStability, "linear-gradient(to right, rgba(74,222,128,.95), rgba(56,189,248,.95))") +
    barRow("Error sensitivity", P.errorSensitivity, "linear-gradient(to right, rgba(251,191,36,.95), rgba(236,72,153,.95))") +
    barRow("Processing cost proxy", P.processingCost, "linear-gradient(to right, rgba(168,85,247,.95), rgba(56,189,248,.95))");

  const line = P.compression > 0.66 ? "High compression: coherence feels strong; fine detail is pruned." :
               P.compression > 0.33 ? "Balanced: stable perception with moderate error-checking." :
               "Low compression: higher accuracy pursuit, but higher cost and mismatch salience.";
  perceptionNote.innerHTML = `<strong style="color:#cfefff">Readout:</strong> <span class="muted">${line}</span>`;
  return P;
}

/* ========= Branch SVG ========= */
function renderBranchSvg(selectedKey){
  const lines = {
    sapiens:{y:70, x0:70, x1:860, start:"~300k", end:"Now+"},
    neanderthal:{y:120, x0:210, x1:560, start:"~400k", end:"~40k"},
    denisovan:{y:160, x0:260, x1:520, start:"~300k", end:"~50k?"},
    hybrid:{y:195, x0:380, x1:820, start:"~60k", end:"Now"}
  };
  const highlight = (k)=> k===selectedKey ? "rgba(56,189,248,.95)" : "rgba(148,163,184,.35)";
  const thick = (k)=> k===selectedKey ? 4 : 2;

  branchSvg.innerHTML = `
    <rect x="0" y="0" width="900" height="220" fill="rgba(2,6,23,.25)"/>
    <text x="16" y="22" fill="rgba(156,163,175,.95)" font-size="12">Branching view (schematic)</text>
    ${Object.keys(lines).map(k=>{
      const L = lines[k];
      const name = species[k].name;
      return `
        <line x1="${L.x0}" y1="${L.y}" x2="${L.x1}" y2="${L.y}"
              stroke="${highlight(k)}" stroke-width="${thick(k)}" stroke-linecap="round"/>
        <circle cx="${L.x0}" cy="${L.y}" r="5" fill="${highlight(k)}"/>
        <text x="${L.x0+10}" y="${L.y-8}" fill="rgba(229,231,235,.85)" font-size="12">${name}</text>
        <text x="${L.x0+10}" y="${L.y+14}" fill="rgba(156,163,175,.95)" font-size="11">${L.start} ‚Üí ${L.end}</text>
      `;
    }).join("")}
    <path d="M 520 120 C 620 105, 690 85, 770 70"
          stroke="rgba(168,85,247,.70)" stroke-width="2" fill="none" stroke-dasharray="6 6"/>
    <text x="560" y="98" fill="rgba(168,85,247,.85)" font-size="11">admixture / gene flow</text>
  `;
}

function renderSpeciesBars(selectedKey){
  const s = species[selectedKey];
  const buf = norm10(s.buf), net = norm10(s.net), vol = norm10(s.vol), sym = norm10(s.sym), tool = norm10(s.tool);

  let html =
    barRow("Population buffer", buf, "linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))") +
    barRow("Network reach", net, "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))") +
    barRow("Environmental volatility", vol, "linear-gradient(to right, rgba(100,116,139,.95), rgba(251,113,133,.95))") +
    barRow("Symbolic culture", sym, "linear-gradient(to right, rgba(168,85,247,.95), rgba(236,72,153,.95))") +
    barRow("Tool sophistication", tool, "linear-gradient(to right, rgba(34,197,94,.95), rgba(74,222,128,.95))");

  if(compareAll){
    const keys = Object.keys(species);
    const rows = keys.map(k=>{
      const X = species[k];
      return `<tr>
        <td>${X.name}</td>
        <td style="font-family:var(--mono)">${X.buf}/10</td>
        <td style="font-family:var(--mono)">${X.net}/10</td>
        <td style="font-family:var(--mono)">${X.vol}/10</td>
        <td style="font-family:var(--mono)">${X.sym}/10</td>
        <td style="font-family:var(--mono)">${X.tool}/10</td>
      </tr>`;
    }).join("");

    html += `
      <div class="mini muted" style="margin-top:10px;"><strong>Compare all lineages</strong></div>
      <div style="overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.22);">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Lineage</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Buffer</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Reach</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Volatility</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Symbol</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Tools</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  speciesBars.innerHTML = html;
}

/* ========= Table render ========= */
function renderTable(){
  tableBody.innerHTML="";
  const q = searchBox.value.trim().toLowerCase();

  stages.filter(s=>{
    if(!q) return true;
    const blob = (s.year+" "+s.region+" "+s.lineage+" "+s.advance+" "+s.physics+" "+s.why).toLowerCase();
    return blob.includes(q);
  }).forEach(s=>{
    const tr = document.createElement("tr");
    const ret = retentionScore(s.pop, s.contact, s.loss);
    tr.innerHTML = `
      <td>${s.year}</td>
      <td>${s.region}</td>
      <td>${s.lineage}</td>
      <td>${s.advance}</td>
      <td>${s.physics}</td>
      <td style="font-family:var(--mono); color:${hslColor(ret)}">${Math.round(ret*100)}%</td>
    `;
    tr.onclick = ()=>selectStage(s, tr);
    if(selectedStage && selectedStage.id===s.id) tr.classList.add("active-row");
    tableBody.appendChild(tr);
  });
}

/* ========= Pinned region readout ========= */
function updatePinnedRegion(model){
  const {computed, diffusion} = model;
  if(!pinnedRegionId){
    pinName.textContent = "None";
    pinRetention.textContent = "‚Äî";
    pinIntensity.textContent = "‚Äî";
    pinDiffusion.textContent = `${Math.round(diffusion*100)}%`;
    return null;
  }
  const r = computed.find(x=>x.id===pinnedRegionId);
  pinName.textContent = r.name;
  pinRetention.textContent = `${Math.round(r.retention*100)}%`;
  pinIntensity.textContent = `${Math.round(r.intensity*100)}%`;
  pinDiffusion.textContent = `${Math.round(r.diffusion*100)}%`;
  return r;
}

/* ========= Instrument layer render ========= */
function renderInstrumentLayer(s, ret, teach, collapse, P){
  const q = (+terminalQSlider.value)/100;
  const xi = (+xiSlider.value)/100;
  const beta = (+betaSlider.value)/100;

  const contactN = norm10(+contactSlider.value);
  const lossN = norm10(+lossSlider.value);
  const shockN = norm10(+shockSlider.value);

  const metricEmergent = !!metricToggle.checked;
  const mat = MATERIAL_PRESETS[materialSelect.value] || MATERIAL_PRESETS.Generic;

  const w2 = w2DistanceProxy(P.accN, P.perceivedStability, P.errorSensitivity, metricEmergent);
  const sync = structuralSynchrony(ret, teach, P.perceivedStability, P.errorSensitivity, mat.factor, metricEmergent);
  const entropy = entropyScore(lossN, shockN, P.processingCost, ret, teach, sync);

  const residualKm = residualErrorKm(w2, contactN);

  // Gate logic
  const gateOpen = terminalQGate(q, sync, entropy, w2, collapse);

  // Update badges + bars
  gateBadge.textContent = gateOpen ? "Gate: OPEN" : "Gate: CLOSED";
  gateBadge.style.borderColor = gateOpen ? "rgba(74,222,128,.75)" : "rgba(251,113,133,.75)";
  gateBadge.style.background = gateOpen ? "rgba(74,222,128,.10)" : "rgba(251,113,133,.10)";

  terminalQBars.innerHTML =
    barRow("Terminal Q", q, "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))") +
    barRow("Gate readiness (computed)", clamp(0.22*q + 0.30*sync + 0.26*(1-entropy) + 0.22*(1-w2),0,1),
           "linear-gradient(to right, rgba(251,191,36,.95), rgba(74,222,128,.95))");
  terminalQNote.innerHTML =
    `<strong style="color:#cfefff">Gate rule:</strong> <span class="muted">Q‚â•0.70, S‚ÇçMoio‚Çé‚â•0.65, Entropy‚â§0.45, W‚ÇÇ¬≤‚â§0.35, Collapse‚â§0.55</span>`;

  syncBars.innerHTML =
    barRow("S‚ÇçMoio‚Çé synchrony", sync, "linear-gradient(to right, rgba(168,85,247,.95), rgba(56,189,248,.95))") +
    barRow("Residual error proxy (km)", clamp(residualKm/2000,0,1), "linear-gradient(to right, rgba(251,191,36,.95), rgba(236,72,153,.95))") +
    `<div class="mini muted" style="margin-top:6px;">
      Residual error: <span style="font-family:var(--mono);color:#cfe7ff">${residualKm.toFixed(0)} km</span> ¬∑
      Material preset: <span style="font-family:var(--mono);color:#cfe7ff">${mat.name}</span> ¬∑
      Metric emergent: <span style="font-family:var(--mono);color:#cfe7ff">${metricEmergent ? "ON" : "OFF"}</span>
    </div>`;
  syncNote.innerHTML =
    `<strong style="color:#cfefff">Meaning:</strong> <span class="muted">computed coherence from retention + teaching + perceived stability, penalized by error sensitivity.</span>`;

  // OFN/TCFQ: display constants + entropy + W2
  ofnBars.innerHTML =
    barRow("Œæ (xi)", xi, "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))") +
    barRow("Œ≤ (beta)", beta, "linear-gradient(to right, rgba(251,191,36,.95), rgba(56,189,248,.95))") +
    barRow("Entropy score", entropy, "linear-gradient(to right, rgba(100,116,139,.95), rgba(251,113,133,.95))") +
    barRow("W‚ÇÇ¬≤ distance-to-target", w2, "linear-gradient(to right, rgba(168,85,247,.95), rgba(236,72,153,.95))");
  ofnNote.innerHTML =
    `<strong style="color:#cfefff">Reminder:</strong> <span class="muted">Œæ and Œ≤ are named knobs (placeholders unless you replace them with sourced values).</span>`;

  // Event log triggers (only on meaningful change)
  if(prev.metric === null) prev.metric = metricEmergent;
  if(prev.gate === null) prev.gate = gateOpen;

  const gateFlip = (prev.gate !== gateOpen);
  const metricFlip = (prev.metric !== metricEmergent);

  // W2/entropy/sync change notices
  const w2Step = prev.w2 === null ? null : (w2 - prev.w2);
  const entStep = prev.entropy === null ? null : (entropy - prev.entropy);
  const syncStep = prev.sync === null ? null : (sync - prev.sync);

  if(metricFlip){
    pushLog(state, `<span class="tag">TOGGLE</span>`, metricEmergent ? "Phase‚ÜíGeometry: Einstein metric emergent ON" : "Phase-only mode: Einstein metric emergent OFF");
    prev.metric = metricEmergent;
  }
  if(gateFlip){
    pushLog(state, `<span class="tag">GATE</span>`, gateOpen ? "Terminal Q Gate OPENED (adjacency step allowed)" : "Terminal Q Gate CLOSED (requirements not met)");
    prev.gate = gateOpen;
  }
  if(w2Step !== null && Math.abs(w2Step) > 0.06){
    pushLog(state, `<span class="tag">W2</span>`, w2Step < 0 ? `W‚ÇÇ¬≤ distance decreased (convergence improved)` : `W‚ÇÇ¬≤ distance increased (mismatch grew)`);
  }
  if(entStep !== null && Math.abs(entStep) > 0.06){
    pushLog(state, `<span class="tag">ENT</span>`, entStep < 0 ? `Entropy drift reduced (more stable)` : `Entropy drift increased (more volatile)`);
  }
  if(syncStep !== null && Math.abs(syncStep) > 0.06){
    pushLog(state, `<span class="tag">SYNC</span>`, syncStep > 0 ? `S‚ÇçMoio‚Çé stabilized / increased` : `S‚ÇçMoio‚Çé weakened`);
  }

  prev.w2 = w2; prev.entropy = entropy; prev.sync = sync;

  // Audit panel (equations + substitutions)
  if(auditToggle.checked){
    auditCard.style.display = "block";
    auditText.innerHTML = `
      <div class="callout mini muted">
        <strong>All meters are computed (UI model), not lab data.</strong>
        These are the exact equations used right now with your live numbers substituted.
      </div>

      <div style="margin-top:10px;">
        <strong>1) S‚ÇçMoio‚Çé</strong><br>
        S = [(0.42¬∑ret + 0.28¬∑teach + 0.30¬∑stab) ¬∑ (1 ‚àí 0.35¬∑err)] ¬∑ material ¬∑ metricBoost<br>
        ret=${ret.toFixed(3)}, teach=${teach.toFixed(3)}, stab=${P.perceivedStability.toFixed(3)}, err=${P.errorSensitivity.toFixed(3)}<br>
        material=${mat.factor.toFixed(2)}, metricBoost=${metricEmergent ? "1.00" : "0.92"}<br>
        <strong>S‚ÇçMoio‚Çé=${sync.toFixed(3)}</strong>
      </div>

      <div style="margin-top:10px;">
        <strong>2) Entropy</strong><br>
        drift = 0.40¬∑loss + 0.35¬∑shock + 0.25¬∑procCost<br>
        damping = 0.45¬∑ret + 0.25¬∑teach + 0.30¬∑S<br>
        entropy = drift ¬∑ (1 ‚àí 0.65¬∑damping)<br>
        loss=${lossN.toFixed(3)}, shock=${shockN.toFixed(3)}, procCost=${P.processingCost.toFixed(3)}<br>
        drift=${(0.40*lossN+0.35*shockN+0.25*P.processingCost).toFixed(3)}, damping=${(0.45*ret+0.25*teach+0.30*sync).toFixed(3)}<br>
        <strong>entropy=${entropy.toFixed(3)}</strong>
      </div>

      <div style="margin-top:10px;">
        <strong>3) W‚ÇÇ¬≤ distance (proxy)</strong><br>
        target=accuracyDemand; achieved=0.60¬∑stab + 0.40¬∑(1‚àíerr)<br>
        W2=|target‚àíachieved| + geoPenalty (0 if metric ON else 0.10)<br>
        target=${P.accN.toFixed(3)}, achieved=${(0.60*P.perceivedStability+0.40*(1-P.errorSensitivity)).toFixed(3)}, geoPenalty=${metricEmergent? "0.00":"0.10"}<br>
        <strong>W‚ÇÇ¬≤=${w2.toFixed(3)}</strong>
      </div>

      <div style="margin-top:10px;">
        <strong>4) Terminal Q Gate</strong><br>
        GateOpen = (Q‚â•0.70) ‚àß (S‚â•0.65) ‚àß (entropy‚â§0.45) ‚àß (W2‚â§0.35) ‚àß (collapse‚â§0.55)<br>
        Q=${q.toFixed(2)}, S=${sync.toFixed(2)}, entropy=${entropy.toFixed(2)}, W2=${w2.toFixed(2)}, collapse=${collapse.toFixed(2)}<br>
        <strong>Gate=${gateOpen ? "OPEN" : "CLOSED"}</strong>
      </div>
    `;
  }else{
    auditCard.style.display = "none";
  }

  return {q, xi, beta, w2, entropy, sync, residualKm, gateOpen, metricEmergent, mat};
}

/* ========= Print report ========= */
function renderPrintArea(snapshot){
  const s = snapshot.stage;
  const pinned = snapshot.pinned;
  const I = snapshot.instrument;

  const pinnedHtml = pinned ? `
    <h3 style="margin:10px 0 6px;">Pinned Region Snapshot</h3>
    <div><strong>${pinned.name}</strong></div>
    <ul>
      <li>Retention: ${Math.round(pinned.retention*100)}%</li>
      <li>Innovation intensity: ${Math.round(pinned.intensity*100)}%</li>
      <li>Diffusion pressure: ${Math.round(pinned.diffusion*100)}%</li>
      <li>Friction: ${Math.round(pinned.friction*100)}%</li>
    </ul>
  ` : `<h3 style="margin:10px 0 6px;">Pinned Region Snapshot</h3><div>None</div>`;

  printArea.innerHTML = `
  <div style="font-family:Arial, sans-serif; color:#000;">
    <h1 style="margin:0 0 6px;">Human Intelligence Continuum ‚Äî Selected Stage Report</h1>
    <div style="color:#333;">Generated: ${new Date().toLocaleString()}</div>

    <h2 style="margin:12px 0 6px;">Stage</h2>
    <div><strong>${s.lineage}</strong> ‚Äî ${s.year}</div>
    <div style="margin-top:4px;"><strong>Region:</strong> ${s.region}</div>
    <div style="margin-top:4px;"><strong>Advance:</strong> ${s.advance}</div>
    <div style="margin-top:4px;"><strong>Physics maturity:</strong> ${s.physics}</div>
    <div style="margin-top:6px;color:#333;">${s.why}</div>

    <h2 style="margin:12px 0 6px;">Computed Results</h2>
    <ul>
      <li><strong>Intelligence index:</strong> ${Math.round(snapshot.idx*100)}/100</li>
      <li><strong>Retention (global):</strong> ${Math.round(snapshot.ret*100)}%</li>
      <li><strong>Teaching fit:</strong> ${Math.round(snapshot.teach*100)}%</li>
      <li><strong>Collapse probability:</strong> ${Math.round(snapshot.collapse*100)}%</li>
    </ul>

    <h2 style="margin:12px 0 6px;">Instrument Layer (Computed)</h2>
    <ul>
      <li><strong>Terminal Q:</strong> ${I.q.toFixed(2)} ¬∑ <strong>Gate:</strong> ${I.gateOpen ? "OPEN" : "CLOSED"}</li>
      <li><strong>S‚ÇçMoio‚Çé:</strong> ${I.sync.toFixed(3)} ¬∑ Residual error proxy: ${I.residualKm.toFixed(0)} km</li>
      <li><strong>Entropy score:</strong> ${I.entropy.toFixed(3)} ¬∑ <strong>W‚ÇÇ¬≤:</strong> ${I.w2.toFixed(3)}</li>
      <li><strong>Metric emergent:</strong> ${I.metricEmergent ? "ON" : "OFF"} ¬∑ Material preset: ${I.mat.name}</li>
      <li><strong>Œæ:</strong> ${I.xi.toFixed(2)} ¬∑ <strong>Œ≤:</strong> ${I.beta.toFixed(2)}</li>
    </ul>

    ${pinnedHtml}

    <p style="margin-top:12px;color:#333;">
      Notes: Timeline is illustrative. Map is schematic (nodes/links). All values are stage presets + user sliders.
      Instrument meters are computed from visible formulas (audit toggle).
    </p>
  </div>`;
}

/* ========= Main recompute loop ========= */
function recalcAndRenderAll(){
  updateModeBadge();
  syncSliderLabels();

  // tuned stage snapshot from sliders
  const s = {...selectedStage};
  s.pop = +popSlider.value;
  s.contact = +contactSlider.value;
  s.loss = +lossSlider.value;
  s.lifespan = +lifespanSlider.value;
  s.learnYears = +learnSlider.value;
  s.elderYears = +elderSlider.value;
  s.shock = +shockSlider.value;
  s.resilience = +resilienceSlider.value;

  const ret = retentionScore(s.pop, s.contact, s.loss);
  const teach = renderLongevityBars(s.lifespan, s.learnYears, s.elderYears);
  const collapse = renderRiskBars(s, ret, teach);
  const idx = intelligenceIndex(s, modeSelect.value, ret, teach);

  kpiInt.textContent = `${Math.round(idx*100)}/100`;
  kpiCollapse.textContent = fmtPct(collapse);

  renderDistributionBars(s);
  drawCrossover(crossoverCanvas, s);
  renderHeat(+lossSlider.value);

  const P = renderPerceptionPanel(s);

  renderBranchSvg(speciesSelect.value);
  renderSpeciesBars(speciesSelect.value);

  const model = computeRegional(s, modeSelect.value);
  renderWorldMap(worldMap, model, state);
  const pinned = updatePinnedRegion(model);

  // reviewer + audit toggles
  reviewerBox.style.display = reviewerToggle.checked ? "block" : "none";
  reviewerText.innerHTML = reviewerCopy;

  // Instrument layer
  const instrument = renderInstrumentLayer(s, ret, teach, collapse, P);

  // Print area snapshot
  renderPrintArea({stage:s, mode:modeSelect.value, idx, ret, teach, collapse, pinned, instrument});

  // Refresh table highlighting
  renderTable();

  // Log stage selection summary occasionally
  if(prev.stageId !== s.id){
    pushLog(state, `<span class="tag">STAGE</span>`, `Selected stage ‚Üí ${s.lineage} ¬∑ ${s.year} ¬∑ ${s.region}`);
    prev.stageId = s.id;
  }
}
state.recalc = recalcAndRenderAll;

/* ========= Selection + slider sync ========= */
function setSlidersFromStage(s){
  popSlider.value = s.pop;
  contactSlider.value = s.contact;
  lossSlider.value = s.loss;
  lifespanSlider.value = s.lifespan;
  learnSlider.value = s.learnYears;
  elderSlider.value = s.elderYears;
  shockSlider.value = s.shock;
  resilienceSlider.value = s.resilience;

  // stable defaults for perception & instrument layer
  signalSlider.value = 6;
  accuracySlider.value = 5;

  terminalQSlider.value = 70; // start near readiness
  xiSlider.value = 75;        // default Œæ=0.75
  betaSlider.value = 25;      // default Œ≤=0.25
  metricToggle.checked = true;
  materialSelect.value = "AlN_Mo";

  syncSliderLabels();
  renderHeat(+lossSlider.value);
}

function selectStage(s, tr){
  selectedStage = s;
  document.querySelectorAll("tbody tr").forEach(r=>r.classList.remove("active-row"));
  if(tr) tr.classList.add("active-row");
  selectedBadge.textContent = `${s.lineage} ¬∑ ${s.year}`;
  setSlidersFromStage(s);
  recalcAndRenderAll();
}

/* ========= Event wiring ========= */
searchBox.addEventListener("input", renderTable);
modeSelect.addEventListener("change", recalcAndRenderAll);
reviewerToggle.addEventListener("change", recalcAndRenderAll);
auditToggle.addEventListener("change", recalcAndRenderAll);

[
  popSlider, contactSlider, lossSlider,
  lifespanSlider, learnSlider, elderSlider,
  shockSlider, resilienceSlider,
  signalSlider, accuracySlider,
  terminalQSlider, xiSlider, betaSlider
].forEach(el=>{
  el.addEventListener("input", recalcAndRenderAll);
});

materialSelect.addEventListener("change", ()=>{
  pushLog(state, `<span class="tag">MAT</span>`, `Material preset ‚Üí ${MATERIAL_PRESETS[materialSelect.value].name}`);
  recalcAndRenderAll();
});
metricToggle.addEventListener("change", recalcAndRenderAll);

speciesSelect.addEventListener("change", ()=>{
  compareAll = false;
  compareAllBtn.textContent = "Compare all";
  recalcAndRenderAll();
});
compareAllBtn.addEventListener("click", ()=>{
  compareAll = !compareAll;
  compareAllBtn.textContent = compareAll ? "Close compare" : "Compare all";
  recalcAndRenderAll();
});

resetTuningBtn.addEventListener("click", ()=>{
  pinnedRegionId = null;
  compareAll = false;
  compareAllBtn.textContent = "Compare all";
  selectedStage = selectedStage || stages[0];

  setSlidersFromStage(selectedStage);
  pushLog(state, `<span class="tag">RESET</span>`, "Reset tuning (sliders + pinned region cleared)");
  recalcAndRenderAll();
});

printBtn.addEventListener("click", ()=>{
  printArea.style.display = "block";
  setTimeout(()=>{
    window.print();
    setTimeout(()=>{ printArea.style.display = "none"; }, 250);
  }, 50);
});

/* ========= Boot (hardened) ========= */
function boot(){
  selectedStage = stages[0];
  selectedBadge.textContent = `${selectedStage.lineage} ¬∑ ${selectedStage.year}`;
  setSlidersFromStage(selectedStage);

  renderTable();

  // highlight first row if present
  const firstRow = document.querySelector("#eventTable tr");
  if(firstRow) firstRow.classList.add("active-row");

  pushLog(state, `<span class="tag">BOOT</span>`, "Simulator booted (DOMContentLoaded). All meters computed from visible formulas.");
  recalcAndRenderAll();
}
boot();

});
</script>
</body>
</html>
