<!-- ======================= PART 1 / 4 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Human Intelligence Continuum ‚Äî Bio‚ÜîCulture ‚Ä¢ Demography ‚Ä¢ Branches ‚Ä¢ Resets ‚Ä¢ Biogeography Map</title>

<style>
:root{
  color-scheme: dark;
  --bg:#020617;
  --panelA: rgba(15,23,42,.98);
  --panelB: rgba(15,23,42,.90);
  --ink:#e5e7eb;
  --muted:#9ca3af;
  --line: rgba(148,163,184,.30);
  --brand:#38bdf8;
  --good:#34d399;
  --warn:#fbbf24;
  --bad:#fb7185;
  --vio:#a855f7;
  --shadow: 0 18px 45px rgba(0,0,0,.55);
  --radius: 18px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background: radial-gradient(circle at top, #020617 0, #000 55%, #000 100%);
  color:var(--ink);
}
header{
  padding:18px 22px;
  border-bottom:1px solid var(--line);
  background: radial-gradient(circle at top left, rgba(56,189,248,.90) 0, rgba(15,23,42,.92) 40%, #000 100%);
}
header h1{margin:0 0 6px;font-size:22px;letter-spacing:.03em}
header p{margin:4px 0;font-size:13px;color:#bae6fd}
header .sub{color:var(--muted);font-size:12px}

.wrap{padding:16px; max-width: 1480px; margin:0 auto;}
.grid{
  display:grid;
  grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
  gap:14px;
}
.panel{
  background: radial-gradient(circle at top, rgba(56,189,248,.14), rgba(15,23,42,.98));
  border-radius: var(--radius);
  border:1px solid var(--line);
  box-shadow: var(--shadow);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:0;
}
.panel h2{
  margin:0;
  font-size:15px;
  font-weight:650;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.muted{color:var(--muted)}
.mini{font-size:12px; line-height:1.35}
.badge{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.35);
  background: rgba(2,6,23,.55);
  color:#cfefff;
}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
input[type="text"], select{
  background: rgba(2,6,23,.55);
  border:1px solid rgba(148,163,184,.55);
  border-radius:999px;
  color:var(--ink);
  padding:7px 12px;
  font-size:13px;
  outline:none;
}
select{padding-right:30px}
.btn{
  cursor:pointer;
  user-select:none;
  border-radius:999px;
  padding:7px 12px;
  border:1px solid rgba(148,163,184,.55);
  background: rgba(2,6,23,.55);
  color:var(--ink);
  font-size:13px;
}
.btn:hover{border-color:rgba(56,189,248,.65)}
.btn.primary{border-color: rgba(56,189,248,.75); background: rgba(56,189,248,.10);}
.toggle{
  display:flex; align-items:center; gap:8px;
  padding:6px 10px;
  border:1px solid rgba(148,163,184,.45);
  border-radius:999px;
  background: rgba(2,6,23,.45);
  font-size:12px;
}
.toggle input{transform: translateY(1px)}
hr.sep{border:0; border-top:1px solid rgba(148,163,184,.22); margin:2px 0;}

.tableWrap{max-height:460px; overflow:auto; border-radius:14px; border:1px solid rgba(148,163,184,.22)}
table{width:100%; border-collapse:collapse; font-size:12.5px}
th,td{padding:8px 9px; border-bottom:1px solid rgba(56,189,248,.18)}
th{
  position:sticky; top:0;
  background: rgba(2,6,23,.85);
  text-transform:uppercase;
  font-size:10.5px;
  letter-spacing:.06em;
  color:var(--muted);
  border-bottom:1px solid rgba(148,163,184,.25);
}
tbody tr{cursor:pointer}
tbody tr:hover{background:rgba(56,189,248,.12)}
tbody tr.active-row{
  background: radial-gradient(circle at left, rgba(125,211,252,.30), rgba(15,23,42,.95));
}

.kpiRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
.kpi{
  border-radius:14px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.35);
  padding:10px;
}
.kpi .label{font-size:11px;color:var(--muted)}
.kpi .value{font-size:18px;font-weight:700;margin-top:2px}
.kpi .hint{font-size:11px;color:#b7c7d8;margin-top:4px}

.bar-row{display:flex;align-items:center;gap:10px;margin:3px 0}
.bar-label{width:165px;font-size:11.5px;color:var(--muted)}
.bar-track{
  flex:1;height:8px;border-radius:999px;
  background:rgba(2,6,23,.55);
  border:1px solid rgba(148,163,184,.22);
  overflow:hidden;
}
.bar-fill{height:100%;border-radius:999px}

.twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
.card{
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.35);
  border-radius:14px;
  padding:10px;
  min-width:0;
}
canvas, svg{
  width:100%;
  height:auto;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.30);
}

.sliderRow{
  display:grid;
  grid-template-columns: 160px 1fr 64px;
  align-items:center;
  gap:10px;
  margin:6px 0;
}
.sliderRow label{font-size:11.5px;color:var(--muted)}
.sliderRow input[type="range"]{width:100%}
.sliderRow .num{
  font-family: var(--mono);
  font-size:11.5px;
  color:#cfe7ff;
  text-align:right;
}

.heat{
  display:grid;
  grid-template-columns: repeat(10, 1fr);
  gap:3px;
  padding:6px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.25);
}
.cell{
  aspect-ratio: 1 / 1;
  border-radius:5px;
  border:1px solid rgba(148,163,184,.10);
}

.footer{
  margin-top:14px;
  padding:14px;
  border-radius: var(--radius);
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.35);
}
.callout{
  border-radius:14px;
  border:1px solid rgba(56,189,248,.30);
  background: rgba(56,189,248,.08);
  padding:10px;
}

/* Biogeography panel specifics */
.mapGrid{
  display:grid;
  grid-template-columns: 1.3fr .9fr;
  gap:10px;
}
.mapLegend{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.pill{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.35);
  font-size:12px;
}
.pill .name{color:#cfefff}
.pill .val{font-family:var(--mono); color:#cfe7ff}
.mapHint{font-size:11.5px;color:var(--muted)}
.smallBtnRow{display:flex; gap:8px; flex-wrap:wrap}
.tag{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.35);
  color:#cfefff;
}

@media(max-width: 980px){
  .grid{grid-template-columns:1fr}
  .tableWrap{max-height:340px}
  .kpiRow{grid-template-columns:1fr}
  .twoCol{grid-template-columns:1fr}
  .mapGrid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<header>
  <h1>Human Intelligence Continuum</h1>
  <p>Now includes an interactive <strong>biogeography distribution map</strong> that responds to population/contact, so it‚Äôs not a single global line.</p>
  <p class="sub">No teleology: survivability (retention + teaching + resilience) controls outcomes; shocks can cause regression.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: TIMELINE TABLE -->
    <section class="panel">
      <h2>üìú Timeline & Stages <span class="badge" id="modeBadge">Mode: Coupled (Bio√óCulture)</span></h2>

      <div class="controls">
        <input id="searchBox" type="text" placeholder="search year, region, hominid, idea‚Ä¶" />
        <select id="modeSelect" title="Evolution engine mode">
          <option value="coupled">Coupled (Bio √ó Culture)</option>
          <option value="bio">Biological emphasis</option>
          <option value="culture">Cultural emphasis</option>
        </select>

        <span class="toggle" title="Show academic definitions and assumptions">
          <input id="reviewerToggle" type="checkbox" />
          <label for="reviewerToggle">Reviewer Mode</label>
        </span>

        <button class="btn" id="resetTuning">Reset tuning</button>
      </div>

      <div class="callout mini muted">
        <strong>Upgrade:</strong> The map below shows <em>regional</em> retention + innovation intensity instead of implying a single ‚Äúhumanity line.‚Äù
        Regional scores are computed from <strong>population</strong>, <strong>contact</strong>, and <strong>distance/network friction</strong>.
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Region</th>
              <th>Lineage</th>
              <th>Key advance</th>
              <th>Physics maturity</th>
              <th>Retention</th>
            </tr>
          </thead>
          <tbody id="eventTable"></tbody>
        </table>
      </div>

      <div class="mini muted" id="tableHint">
        Click a row to update all panels, including the regional distribution map.
      </div>
    </section>

    <!-- RIGHT: DETAILS + ENGINE PANELS -->
    <section class="panel" id="rightPanel">
      <h2>üß† Results & Interpretation <span class="badge" id="selectedBadge">No stage selected</span></h2>

      <div class="kpiRow">
        <div class="kpi">
          <div class="label">Computed intelligence index</div>
          <div class="value" id="kpiInt">‚Äî</div>
          <div class="hint">Bio‚ÜîCulture engine √ó retention √ó longevity teaching.</div>
        </div>
        <div class="kpi">
          <div class="label">Collapse probability</div>
          <div class="value" id="kpiCollapse">‚Äî</div>
          <div class="hint">Higher when fragility + shocks exceed resilience.</div>
        </div>
      </div>

      <div class="twoCol">
        <div class="card">
          <div class="mini muted"><strong>Bio‚ÜîCulture crossover</strong> (phase transition)</div>
          <canvas id="crossoverCanvas" width="900" height="260"></canvas>
          <div class="mini muted" id="crossoverNote">Select a stage to display Bio vs Culture contributions across time points.</div>
        </div>

        <div class="card">
          <div class="mini muted"><strong>Distribution (not a single scalar)</strong></div>
          <div id="distBars"></div>
          <div class="mini muted">Five dimensions: toolmaking, social reasoning, symbolic compression, planning, environmental modeling.</div>
        </div>
      </div>

      <hr class="sep" />

      <div class="card">
        <h2 style="margin:0 0 6px; font-size:14px;">üåç Biogeography Distribution Map</h2>
        <div class="mini muted">
          Regions brighten when network reach + retention are high. Contact increases diffusion; distance/friction creates uneven regional outcomes.
        </div>

        <div class="mapGrid" style="margin-top:8px;">
          <div>
            <svg id="worldMap" viewBox="0 0 900 440" role="img" aria-label="Stylized world biogeography map"></svg>
            <div class="mapHint" id="mapHint">
              Click a region node to pin it. Shift-click to clear pin.
            </div>
          </div>
          <div class="mapLegend">
            <div class="pill">
              <div class="name">Pinned region</div>
              <div class="val" id="pinName">None</div>
            </div>
            <div class="pill">
              <div class="name">Pinned retention</div>
              <div class="val" id="pinRetention">‚Äî</div>
            </div>
            <div class="pill">
              <div class="name">Pinned innovation intensity</div>
              <div class="val" id="pinIntensity">‚Äî</div>
            </div>
            <div class="pill">
              <div class="name">Diffusion pressure</div>
              <div class="val" id="pinDiffusion">‚Äî</div>
            </div>

            <div class="smallBtnRow">
              <span class="tag">Nodes: 10 regions</span>
              <span class="tag">Links: contact-driven</span>
              <span class="tag">Friction: distance</span>
            </div>

            <div class="mini muted">
              <strong>How it works:</strong> each region has a baseline (climate corridor + coast access + ‚Äúhubness‚Äù).
              Global sliders change <em>diffusion strength</em> and <em>knowledge survival</em>. This breaks the ‚Äúsingle timeline‚Äù criticism.
            </div>
          </div>
        </div>
      </div>

      <!-- (More panels continue in Part 2) -->
<!-- ======================= PART 2 / 4 ======================= -->
      <div class="card">
        <h2 style="margin:0 0 6px; font-size:14px;">üß¨ Demography, Networks & Knowledge Retention</h2>
        <div class="mini muted">Tune population + contact + loss to see why innovation can vanish (no ‚Äúinevitable progress‚Äù).</div>

        <div class="sliderRow">
          <label for="popSlider">Effective population</label>
          <input id="popSlider" type="range" min="1" max="10" step="1" />
          <div class="num" id="popNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="contactSlider">Inter-group contact</label>
          <input id="contactSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="contactNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="lossSlider">Knowledge loss risk</label>
          <input id="lossSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="lossNum">‚Äî</div>
        </div>

        <div class="mini muted" style="margin-top:6px;">
          <strong>Retention heat map</strong> (higher = stable transmission; lower = frequent loss/rediscovery).
        </div>
        <div class="heat" id="heatMap"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px; font-size:14px;">üëµ Longevity & Intergenerational Teaching</h2>
        <div class="mini muted">
          Models the elder-teaching effect: complex skills persist only when learning time fits inside lifespan + teaching years.
        </div>

        <div class="sliderRow">
          <label for="lifespanSlider">Average lifespan</label>
          <input id="lifespanSlider" type="range" min="15" max="80" step="1" />
          <div class="num" id="lifespanNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="learnSlider">Skill learning years</label>
          <input id="learnSlider" type="range" min="1" max="30" step="1" />
          <div class="num" id="learnNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="elderSlider">Elder teaching years</label>
          <input id="elderSlider" type="range" min="0" max="25" step="1" />
          <div class="num" id="elderNum">‚Äî</div>
        </div>

        <div id="longevityBars"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px; font-size:14px;">üß¨ Multi-Hominid Branch View (Non-Linear)</h2>
        <div class="mini muted">
          Extinction ‚â† cognitive inferiority. This view compares lineages under population buffers, network reach, and environmental volatility.
        </div>

        <div class="controls" style="margin-top:6px;">
          <select id="speciesSelect" title="Select lineage">
            <option value="sapiens">Homo sapiens</option>
            <option value="neanderthal">Neanderthals</option>
            <option value="denisovan">Denisovans</option>
            <option value="hybrid">Hybrid / Admixed populations</option>
          </select>
          <button class="btn primary" id="compareAll">Compare all</button>
        </div>

        <svg id="branchSvg" viewBox="0 0 900 220"></svg>
        <div id="speciesBars"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px; font-size:14px;">üßØ Regression, Shocks & Local Optima</h2>
        <div class="mini muted">
          Adds non-teleological dynamics: collapses, dead-ends, and knowledge fragility. ‚ÄúProgress‚Äù must survive resets.
        </div>

        <div class="sliderRow">
          <label for="shockSlider">Environmental shock</label>
          <input id="shockSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="shockNum">‚Äî</div>
        </div>
        <div class="sliderRow">
          <label for="resilienceSlider">Resilience policy</label>
          <input id="resilienceSlider" type="range" min="0" max="10" step="1" />
          <div class="num" id="resilienceNum">‚Äî</div>
        </div>

        <div id="riskBars"></div>
        <div class="mini muted" id="riskNote"></div>
      </div>

      <div class="footer" id="reviewerBox" style="display:none;">
        <h2 style="margin:0 0 6px; font-size:14px;">üßæ Reviewer Mode Notes (Assumptions & Definitions)</h2>
        <div class="mini muted" id="reviewerText"></div>
      </div>

    </section>
  </div>

  <div class="footer">
    <div class="mini muted">
      <strong>Biogeography add-on:</strong> each region has baseline ‚Äúhubness‚Äù and geography friction. Population/contact sliders change diffusion and
      retention, producing uneven regional outcomes that better match archaeological reality.
    </div>
  </div>

</div>

<script>
/* ========= Utility ========= */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const fmtPct=(x)=>`${Math.round(x*100)}%`;
const sigmoid=(x)=>1/(1+Math.exp(-x));

function hslColor(v){
  // v in [0,1] -> red(low) to green(high)
  const hue = lerp(0,120,v); // 0=red 120=green
  return `hsl(${hue} 85% 45%)`;
}
function barRow(label,val,color){
  const w = clamp(val,0,1)*100;
  return `
    <div class="bar-row">
      <div class="bar-label">${label}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${w}%;background:${color}"></div>
      </div>
    </div>`;
}
function norm10(x){return clamp(x/10,0,1);}

/* ========= Timeline Data ========= */
const timePoints = [
  {t:"~300k", label:"300k BCE"},
  {t:"~40k", label:"40k BCE"},
  {t:"~10k", label:"10k BCE"},
  {t:"~600", label:"600 BCE"},
  {t:"1687", label:"1687"},
  {t:"1905", label:"1905"},
  {t:"2020", label:"2020s"},
  {t:"fut", label:"Future"}
];

const stages = [
  {
    id:"s0",
    year:"~300,000 BCE",
    region:"East Africa",
    lineage:"Homo sapiens (early)",
    advance:"Symbolic thought, language scaffolding",
    physics:"Implicit / Embodied Physics",
    why:"Embodied mechanics emerges from hunting, balance, thrown projectiles; cultural storage remains low.",
    constraint:4, info:3, tools:2, imagination:7,
    plasticity:7, brainLimit:4,
    symbolRate:2, externalMemory:1, teachingEff:2,
    pop:2, contact:2, loss:7,
    lifespan:28, learnYears:6, elderYears:3,
    dist:{tool:3, social:6, symbolic:4, planning:5, env:5},
    shock:4, resilience:2
  },
  {
    id:"s1",
    year:"~40,000 BCE",
    region:"Europe & Central Asia",
    lineage:"H. sapiens + Neanderthals (overlap)",
    advance:"Art, music, compound tools",
    physics:"Implicit mechanics ‚Üí proto-formal heuristics",
    why:"Glacial pressure rewards planning and social learning; symbolic artifacts increase memory, but retention varies with network density.",
    constraint:8, info:5, tools:4, imagination:9,
    plasticity:7, brainLimit:5,
    symbolRate:5, externalMemory:3, teachingEff:5,
    pop:3, contact:4, loss:6,
    lifespan:30, learnYears:8, elderYears:4,
    dist:{tool:5, social:6, symbolic:7, planning:7, env:6},
    shock:7, resilience:3
  },
  {
    id:"s2",
    year:"~10,000 BCE",
    region:"Fertile Crescent",
    lineage:"Homo sapiens",
    advance:"Agriculture, settlement, writing precursors",
    physics:"Measurement & counting (proto-formal)",
    why:"Surplus increases specialization; network density rises; external memory accelerates via marks, tallies, early scripts.",
    constraint:5, info:7, tools:6, imagination:7,
    plasticity:6, brainLimit:6,
    symbolRate:7, externalMemory:6, teachingEff:7,
    pop:6, contact:6, loss:4,
    lifespan:32, learnYears:10, elderYears:5,
    dist:{tool:6, social:7, symbolic:7, planning:7, env:6},
    shock:5, resilience:5
  },
  {
    id:"s3",
    year:"~600 BCE",
    region:"Mediterranean",
    lineage:"Homo sapiens",
    advance:"Logic, axioms, debate culture",
    physics:"Formal reasoning",
    why:"Institutions stabilize knowledge; formal methods reduce loss; written records push cultural clock dominant.",
    constraint:3, info:8, tools:5, imagination:8,
    plasticity:5, brainLimit:6,
    symbolRate:8, externalMemory:7, teachingEff:7,
    pop:6, contact:7, loss:3,
    lifespan:35, learnYears:12, elderYears:6,
    dist:{tool:5, social:7, symbolic:8, planning:8, env:7},
    shock:3, resilience:6
  },
  {
    id:"s4",
    year:"1687",
    region:"England",
    lineage:"Homo sapiens",
    advance:"Classical mechanics",
    physics:"Predictive physics (models ‚Üí predictions)",
    why:"Math ties motion to force; printing & institutions improve retention; instruments amplify measurement feedback loops.",
    constraint:2, info:8, tools:6, imagination:7,
    plasticity:5, brainLimit:6,
    symbolRate:8, externalMemory:8, teachingEff:8,
    pop:7, contact:8, loss:2,
    lifespan:40, learnYears:14, elderYears:8,
    dist:{tool:7, social:6, symbolic:8, planning:7, env:8},
    shock:2, resilience:7
  },
  {
    id:"s5",
    year:"1905",
    region:"Europe",
    lineage:"Homo sapiens",
    advance:"Relativity (conceptual reframing)",
    physics:"Spacetime physics (formal + counterfactual)",
    why:"Thought experiments + formalism; global communication increases contact; institutions stabilize memory and methods.",
    constraint:2, info:9, tools:6, imagination:9,
    plasticity:5, brainLimit:6,
    symbolRate:9, externalMemory:9, teachingEff:8,
    pop:8, contact:8, loss:2,
    lifespan:50, learnYears:16, elderYears:10,
    dist:{tool:7, social:6, symbolic:9, planning:8, env:8},
    shock:2, resilience:7
  },
  {
    id:"s6",
    year:"2020s",
    region:"Global",
    lineage:"Homo sapiens",
    advance:"Human‚ÄìAI co-reasoning",
    physics:"Tool-augmented physics (simulation)",
    why:"External memory density becomes dominant; computation turns counterfactual models routine; retention depends on institutions & network health.",
    constraint:6, info:10, tools:10, imagination:9,
    plasticity:5, brainLimit:6,
    symbolRate:10, externalMemory:10, teachingEff:9,
    pop:9, contact:10, loss:3,
    lifespan:72, learnYears:18, elderYears:14,
    dist:{tool:9, social:7, symbolic:9, planning:9, env:9},
    shock:4, resilience:6
  },
  {
    id:"s7",
    year:"Future",
    region:"Planetary / Space-based",
    lineage:"Multiple lineages / designed intelligence",
    advance:"Spacetime engineering (theoretical)",
    physics:"Experimental spacetime control (hypothesis)",
    why:"If it happens, it won‚Äôt be because brains changed‚Äîbecause cultural storage + tools + governance make long experiments survivable.",
    constraint:7, info:10, tools:10, imagination:10,
    plasticity:5, brainLimit:6,
    symbolRate:10, externalMemory:10, teachingEff:10,
    pop:10, contact:10, loss:2,
    lifespan:80, learnYears:22, elderYears:18,
    dist:{tool:10, social:8, symbolic:10, planning:10, env:10},
    shock:3, resilience:8
  }
];

/* ========= Species baselines ========= */
const species = {
  sapiens:{name:"Homo sapiens", buf:7, net:7, vol:5, sym:8, tool:8},
  neanderthal:{name:"Neanderthals", buf:4, net:4, vol:7, sym:6, tool:7},
  denisovan:{name:"Denisovans", buf:3, net:3, vol:7, sym:5, tool:6},
  hybrid:{name:"Hybrid / Admixed", buf:5, net:6, vol:6, sym:7, tool:7}
};

/* ========= Engine ========= */
function bioCapacity(s){
  const lifeN = clamp((s.lifespan-15)/(80-15),0,1);
  return (norm10(s.plasticity)*0.45 + norm10(s.brainLimit)*0.25 + lifeN*0.30);
}
function culturalStorage(s){
  return (norm10(s.symbolRate)*0.33 + norm10(s.externalMemory)*0.42 + norm10(s.teachingEff)*0.25);
}
function retentionScore(pop, contact, loss){
  const p = norm10(pop), c = norm10(contact), l = norm10(loss);
  const critical = sigmoid((pop-4)*0.9); // pop<4 penalized
  const raw = (0.55*p + 0.35*c) * (1 - 0.55*l) * critical;
  return clamp(raw,0,1);
}
function longevityTeachingFactor(lifespan, learnYears, elderYears){
  const productive = clamp(lifespan-12,0,80);
  const teachWindow = clamp(productive*0.25 + elderYears, 0, 80);
  const fit = clamp((teachWindow - learnYears)/Math.max(learnYears,1), -2, 2);
  return clamp(sigmoid(fit*1.2),0,1);
}
function collapseProbability(s, ret, teach){
  const shock = norm10(s.shock);
  const resilience = norm10(s.resilience);
  const fragility = clamp(1 - (0.62*ret + 0.38*teach), 0, 1);
  const x = (0.60*shock + 0.55*fragility - 0.55*resilience);
  return clamp(sigmoid((x-0.35)*3.2), 0, 1);
}
function intelligenceIndex(s, mode, ret, teach){
  const bio = bioCapacity(s);
  const cul = culturalStorage(s);
  const ext = norm10(s.externalMemory);
  const crossover = sigmoid((ext - 0.45)*7);

  let core;
  if(mode==="bio"){
    core = bio * (0.65 + 0.35*(1-crossover)) + cul*0.10;
  }else if(mode==="culture"){
    core = cul * (0.65 + 0.35*crossover) + bio*0.10;
  }else{
    core = (bio*0.55 + cul*0.65) * (0.75 + 0.25*crossover);
  }
  return clamp(core * (0.60 + 0.40*ret) * (0.65 + 0.35*teach), 0, 1);
}

/* ========= DOM ========= */
const tableBody = document.getElementById("eventTable");
const searchBox = document.getElementById("searchBox");
const modeSelect = document.getElementById("modeSelect");
const modeBadge = document.getElementById("modeBadge");
const reviewerToggle = document.getElementById("reviewerToggle");
const reviewerBox = document.getElementById("reviewerBox");
const reviewerText = document.getElementById("reviewerText");

const selectedBadge = document.getElementById("selectedBadge");
const kpiInt = document.getElementById("kpiInt");
const kpiCollapse = document.getElementById("kpiCollapse");
const distBars = document.getElementById("distBars");

const popSlider = document.getElementById("popSlider");
const contactSlider = document.getElementById("contactSlider");
const lossSlider = document.getElementById("lossSlider");
const popNum = document.getElementById("popNum");
const contactNum = document.getElementById("contactNum");
const lossNum = document.getElementById("lossNum");
const heatMap = document.getElementById("heatMap");

const lifespanSlider = document.getElementById("lifespanSlider");
const learnSlider = document.getElementById("learnSlider");
const elderSlider = document.getElementById("elderSlider");
const lifespanNum = document.getElementById("lifespanNum");
const learnNum = document.getElementById("learnNum");
const elderNum = document.getElementById("elderNum");
const longevityBars = document.getElementById("longevityBars");

const speciesSelect = document.getElementById("speciesSelect");
const compareAllBtn = document.getElementById("compareAll");
const branchSvg = document.getElementById("branchSvg");
const speciesBars = document.getElementById("speciesBars");

const shockSlider = document.getElementById("shockSlider");
const resilienceSlider = document.getElementById("resilienceSlider");
const shockNum = document.getElementById("shockNum");
const resilienceNum = document.getElementById("resilienceNum");
const riskBars = document.getElementById("riskBars");
const riskNote = document.getElementById("riskNote");

const resetTuningBtn = document.getElementById("resetTuning");

const canvas = document.getElementById("crossoverCanvas");
const ctx = canvas.getContext("2d");

/* Biogeography DOM */
const worldMap = document.getElementById("worldMap");
const pinName = document.getElementById("pinName");
const pinRetention = document.getElementById("pinRetention");
const pinIntensity = document.getElementById("pinIntensity");
const pinDiffusion = document.getElementById("pinDiffusion");

let selectedStage = null;
let compareAll = false;
let pinnedRegionId = null;

/* ========= Reviewer text ========= */
const reviewerCopy = `
<strong>Definitions</strong><br>
‚Ä¢ <strong>Biological clock</strong>: bounded by plasticity, brain constraints, lifespan (slow-changing).<br>
‚Ä¢ <strong>Cultural clock</strong>: symbol transmission, external memory, teaching efficiency (fast-changing).<br>
‚Ä¢ <strong>Retention</strong>: demographic/network survivability ‚Äî below a critical population buffer, complex knowledge decays.<br>
‚Ä¢ <strong>Longevity teaching</strong>: complex skills persist when learning time fits in productive + elder teaching windows.<br>
‚Ä¢ <strong>Biogeography map</strong>: regions have baseline ‚Äúhubness‚Äù + geography friction; diffusion scales with contact and distance.<br>
‚Ä¢ <strong>Physics maturity</strong>: operational capability labels (implicit ‚Üí proto-formal ‚Üí formal ‚Üí predictive).<br><br>
<strong>Non-teleology</strong><br>
The model does <em>not</em> assume progress. Intelligence index is survivability-weighted: core capacity √ó retention √ó teaching. Shocks can cause regression; local optima can stall diffusion.
`;

/* ========= Table ========= */
function renderTable(){
  tableBody.innerHTML="";
  const q = searchBox.value.trim().toLowerCase();

  stages.filter(s=>{
    if(!q) return true;
    const blob = (s.year+" "+s.region+" "+s.lineage+" "+s.advance+" "+s.physics+" "+s.why).toLowerCase();
    return blob.includes(q);
  }).forEach(s=>{
    const tr = document.createElement("tr");
    const ret = retentionScore(s.pop, s.contact, s.loss);
    tr.innerHTML = `
      <td>${s.year}</td>
      <td>${s.region}</td>
      <td>${s.lineage}</td>
      <td>${s.advance}</td>
      <td>${s.physics}</td>
      <td style="font-family:var(--mono); color:${hslColor(ret)}">${Math.round(ret*100)}%</td>
    `;
    tr.onclick = ()=>selectStage(s, tr);
    if(selectedStage && selectedStage.id===s.id) tr.classList.add("active-row");
    tableBody.appendChild(tr);
  });
}

/* ========= Heatmap ========= */
function renderHeat(pop, contact, loss){
  heatMap.innerHTML="";
  for(let r=10;r>=1;r--){
    for(let c=0;c<=9;c++){
      const ret = retentionScore(r, c, loss);
      const div = document.createElement("div");
      div.className="cell";
      div.style.background = hslColor(ret);
      div.title = `pop ${r}, contact ${c}, loss ${loss} ‚Üí retention ${Math.round(ret*100)}%`;
      heatMap.appendChild(div);
    }
  }
}

/* ========= Crossover Canvas ========= */
function drawCrossover(selected){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(2,6,23,.25)";
  ctx.fillRect(0,0,w,h);

  const padL=46, padR=14, padT=18, padB=34;
  const gx0=padL, gx1=w-padR, gy0=padT, gy1=h-padB;

  ctx.strokeStyle="rgba(148,163,184,.22)";
  ctx.lineWidth=1;
  for(let i=0;i<=5;i++){
    const y = lerp(gy1, gy0, i/5);
    ctx.beginPath(); ctx.moveTo(gx0,y); ctx.lineTo(gx1,y); ctx.stroke();
  }

  ctx.fillStyle="rgba(229,231,235,.75)";
  ctx.font="12px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText("0", 26, gy1+4);
  ctx.fillText("1", 26, gy0+4);

  ctx.fillStyle="rgba(156,163,175,.95)";
  ctx.font="11px "+getComputedStyle(document.body).fontFamily;

  const xs = timePoints.map((_,i)=> lerp(gx0,gx1, i/(timePoints.length-1)) );
  timePoints.forEach((p,i)=> ctx.fillText(p.t, xs[i]-10, h-12));

  if(!selected){
    ctx.fillStyle="rgba(186,230,253,.8)";
    ctx.font="12px "+getComputedStyle(document.body).fontFamily;
    ctx.fillText("Select a stage to plot Bio vs Culture contributions.", gx0+10, gy0+20);
    return;
  }

  const baseBio = bioCapacity(selected);
  const baseCul = culturalStorage(selected);
  const series = timePoints.map((_,i)=>{
    const t = i/(timePoints.length-1);
    const culRamp = sigmoid((t-0.40)*8);
    const bio = clamp(lerp(baseBio*0.95, baseBio*1.05, t*0.35),0,1);
    const cul = clamp(baseCul * lerp(0.35, 1.25, culRamp),0,1);
    return {bio, cul};
  });

  function plotLine(getY, stroke){
    ctx.strokeStyle=stroke;
    ctx.lineWidth=2.4;
    ctx.beginPath();
    series.forEach((pt,i)=>{
      const x = xs[i];
      const y = lerp(gy1, gy0, getY(pt));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  plotLine(pt=>pt.bio, "rgba(34,211,238,.95)");
  plotLine(pt=>pt.cul, "rgba(74,222,128,.95)");

  ctx.fillStyle="rgba(229,231,235,.9)";
  ctx.font="12px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText("Bio clock", gx0+10, gy0+14);
  ctx.fillStyle="rgba(34,211,238,.95)";
  ctx.fillRect(gx0+78, gy0+6, 16, 4);

  ctx.fillStyle="rgba(229,231,235,.9)";
  ctx.fillText("Culture clock", gx0+110, gy0+14);
  ctx.fillStyle="rgba(74,222,128,.95)";
  ctx.fillRect(gx0+200, gy0+6, 16, 4);
}

/* (Biogeography + remaining logic continues in Part 3) */
</script>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
/* ========= Biogeography Model =========
Stylized regions with:
- baseline hubness: coasts/corridors/trade routes
- baseline stability: climate corridors / refuge availability
- friction: distance from hubs (diffusion penalty)
Computed outputs:
- regionalRetention: global retention √ó region stability √ó (1 - friction)
- innovationIntensity: intelligenceIndex √ó regionalRetention √ó hubness √ó diffusion
*/
const regions = [
  {id:"eaf", name:"East Africa",     x:430, y:240, hub:0.75, stab:0.70, fric:0.20},
  {id:"naf", name:"North Africa",    x:430, y:195, hub:0.65, stab:0.55, fric:0.25},
  {id:"lev", name:"Levant",          x:480, y:190, hub:0.85, stab:0.60, fric:0.18},
  {id:"eur", name:"Europe",          x:500, y:150, hub:0.80, stab:0.55, fric:0.22},
  {id:"csa", name:"Central Asia",    x:560, y:165, hub:0.55, stab:0.45, fric:0.35},
  {id:"sas", name:"South Asia",      x:600, y:225, hub:0.75, stab:0.55, fric:0.30},
  {id:"eas", name:"East Asia",       x:680, y:185, hub:0.85, stab:0.55, fric:0.25},
  {id:"sea", name:"SE Asia",         x:660, y:255, hub:0.70, stab:0.50, fric:0.30},
  {id:"aus", name:"Australia",       x:740, y:330, hub:0.40, stab:0.40, fric:0.55},
  {id:"ame", name:"Americas",        x:250, y:210, hub:0.60, stab:0.45, fric:0.50}
];

// adjacency ‚Äúroutes‚Äù (schematic)
const links = [
  ["eaf","naf"],["naf","lev"],["lev","eur"],["lev","csa"],["csa","eas"],["csa","sas"],["sas","sea"],["sea","eas"],
  ["sea","aus"],["eas","ame"],["eur","ame"],["eaf","lev"],["sas","eas"]
];

function regionById(id){ return regions.find(r=>r.id===id); }

function computeRegional(selectedStageSnapshot, mode){
  const s = selectedStageSnapshot;
  const retGlobal = retentionScore(s.pop, s.contact, s.loss);
  const teach = longevityTeachingFactor(s.lifespan, s.learnYears, s.elderYears);
  const idx = intelligenceIndex(s, mode, retGlobal, teach);

  const contactN = norm10(s.contact);
  const diffusion = clamp(0.25 + 0.75*contactN, 0, 1); // baseline diffusion + contact
  const lossN = norm10(s.loss);

  const computed = regions.map(r=>{
    // friction decreases with contact (more networks reduce distance penalties)
    const fricEff = clamp(r.fric * (1 - 0.55*contactN), 0, 1);
    const baseRet = retGlobal * r.stab * (1 - fricEff);
    // hubness increases ‚Äúmixing‚Äù; loss reduces local stability further
    const localRet = clamp(baseRet * (1 - 0.35*lossN) * (0.70 + 0.30*r.hub), 0, 1);
    const intensity = clamp(idx * localRet * (0.55 + 0.45*r.hub) * (0.50 + 0.50*diffusion), 0, 1);

    return {
      id:r.id, name:r.name, x:r.x, y:r.y,
      hub:r.hub, stab:r.stab,
      friction:fricEff,
      retention:localRet,
      intensity:intensity,
      diffusion:diffusion,
      idx:idx,
      retGlobal:retGlobal
    };
  });

  // compute link strength (for drawing)
  const linkStrength = links.map(([a,b])=>{
    const ra = computed.find(x=>x.id===a);
    const rb = computed.find(x=>x.id===b);
    const base = (ra.intensity + rb.intensity)/2;
    const dist = Math.hypot(ra.x-rb.x, ra.y-rb.y);
    const distN = clamp(dist/600, 0, 1);
    const strength = clamp(base * (1 - 0.55*distN) * (0.55 + 0.45*contactN), 0, 1);
    return {a,b,strength};
  });

  return {computed, linkStrength, idx, retGlobal, diffusion};
}

function mapBg(){
  // stylized ‚Äúcontinents‚Äù blobs (no external assets)
  return `
    <defs>
      <radialGradient id="ocean" cx="35%" cy="25%" r="80%">
        <stop offset="0%" stop-color="rgba(56,189,248,.10)"/>
        <stop offset="55%" stop-color="rgba(2,6,23,.55)"/>
        <stop offset="100%" stop-color="rgba(2,6,23,.85)"/>
      </radialGradient>
      <filter id="glow">
        <feGaussianBlur stdDeviation="2.5" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    <rect x="0" y="0" width="900" height="440" fill="url(#ocean)"/>
    <!-- very rough land shapes -->
    <path d="M160,120 C220,80 320,80 370,120 C410,155 410,220 360,260 C320,290 240,280 210,240 C170,200 120,165 160,120 Z"
      fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
    <path d="M420,110 C470,70 560,70 610,110 C650,145 660,200 620,245 C580,285 500,300 455,260 C420,228 390,160 420,110 Z"
      fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
    <path d="M650,250 C700,220 780,235 810,280 C830,315 810,360 765,375 C720,390 670,370 650,330 C635,300 630,275 650,250 Z"
      fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.10)"/>
    <path d="M420,250 C450,230 500,235 525,265 C545,290 540,330 510,350 C475,372 435,360 420,330 C405,300 400,275 420,250 Z"
      fill="rgba(148,163,184,.08)" stroke="rgba(148,163,184,.08)"/>
    <text x="16" y="22" fill="rgba(156,163,175,.95)" font-size="12">Regional distribution (schematic)</text>
  `;
}

function renderWorldMap(model){
  const {computed, linkStrength} = model;

  // helper for node color: intensity
  const nodeFill = (v)=>hslColor(v);

  // draw links behind nodes
  const linkSvg = linkStrength.map(L=>{
    const A = computed.find(r=>r.id===L.a);
    const B = computed.find(r=>r.id===L.b);
    const alpha = lerp(0.05, 0.55, L.strength);
    const width = lerp(0.8, 3.8, L.strength);
    return `
      <line x1="${A.x}" y1="${A.y}" x2="${B.x}" y2="${B.y}"
        stroke="rgba(56,189,248,${alpha})" stroke-width="${width}" stroke-linecap="round"/>
    `;
  }).join("");

  const nodesSvg = computed.map(r=>{
    const pin = (pinnedRegionId===r.id);
    const rad = pin ? 11 : 9;
    const stroke = pin ? "rgba(236,72,153,.95)" : "rgba(229,231,235,.25)";
    const strokeW = pin ? 2.5 : 1.2;
    const glow = pin ? `filter="url(#glow)"` : "";

    const title = `${r.name}
Intensity: ${Math.round(r.intensity*100)}%
Retention: ${Math.round(r.retention*100)}%
Friction: ${Math.round(r.friction*100)}%`;

    return `
      <g class="node" data-id="${r.id}" style="cursor:pointer">
        <circle cx="${r.x}" cy="${r.y}" r="${rad}" fill="${nodeFill(r.intensity)}" stroke="${stroke}" stroke-width="${strokeW}" ${glow}>
          <title>${title}</title>
        </circle>
        <text x="${r.x+14}" y="${r.y+4}" font-size="12" fill="rgba(229,231,235,.85)">${r.name}</text>
      </g>
    `;
  }).join("");

  worldMap.innerHTML = `
    ${mapBg()}
    ${linkSvg}
    ${nodesSvg}
  `;

  // click handlers
  worldMap.querySelectorAll(".node").forEach(g=>{
    g.addEventListener("click", (ev)=>{
      const id = g.getAttribute("data-id");
      if(ev.shiftKey){
        pinnedRegionId = null;
      }else{
        pinnedRegionId = (pinnedRegionId===id) ? null : id;
      }
      updatePinnedRegion(model);
      renderWorldMap(model); // redraw to show pin ring
    });
  });
}

function updatePinnedRegion(model){
  const {computed, diffusion} = model;
  if(!pinnedRegionId){
    pinName.textContent = "None";
    pinRetention.textContent = "‚Äî";
    pinIntensity.textContent = "‚Äî";
    pinDiffusion.textContent = `${Math.round(diffusion*100)}%`;
    return;
  }
  const r = computed.find(x=>x.id===pinnedRegionId);
  pinName.textContent = r.name;
  pinRetention.textContent = `${Math.round(r.retention*100)}%`;
  pinIntensity.textContent = `${Math.round(r.intensity*100)}%`;
  pinDiffusion.textContent = `${Math.round(r.diffusion*100)}%`;
}

/* ========= Branch SVG ========= */
function renderBranchSvg(selectedKey){
  const lines = {
    sapiens:{y:70, x0:70, x1:860, start:"~300k", end:"Now+"},
    neanderthal:{y:120, x0:210, x1:560, start:"~400k", end:"~40k"},
    denisovan:{y:160, x0:260, x1:520, start:"~300k", end:"~50k?"},
    hybrid:{y:195, x0:380, x1:820, start:"~60k", end:"Now"}
  };
  const highlight = (k)=> k===selectedKey ? "rgba(56,189,248,.95)" : "rgba(148,163,184,.35)";
  const thick = (k)=> k===selectedKey ? 4 : 2;

  branchSvg.innerHTML = `
    <rect x="0" y="0" width="900" height="220" fill="rgba(2,6,23,.25)"/>
    <text x="16" y="22" fill="rgba(156,163,175,.95)" font-size="12">Branching view (schematic)</text>
    ${Object.keys(lines).map(k=>{
      const L = lines[k];
      const name = species[k].name;
      return `
        <line x1="${L.x0}" y1="${L.y}" x2="${L.x1}" y2="${L.y}"
          stroke="${highlight(k)}" stroke-width="${thick(k)}" stroke-linecap="round"/>
        <circle cx="${L.x0}" cy="${L.y}" r="5" fill="${highlight(k)}"/>
        <text x="${L.x0+10}" y="${L.y-8}" fill="rgba(229,231,235,.85)" font-size="12">${name}</text>
        <text x="${L.x0+10}" y="${L.y+14}" fill="rgba(156,163,175,.95)" font-size="11">${L.start} ‚Üí ${L.end}</text>
      `;
    }).join("")}
    <path d="M 520 120 C 620 105, 690 85, 770 70"
      stroke="rgba(168,85,247,.70)" stroke-width="2" fill="none" stroke-dasharray="6 6"/>
    <text x="560" y="98" fill="rgba(168,85,247,.85)" font-size="11">admixture / gene flow</text>
  `;
}

function renderSpeciesBars(selectedKey){
  const s = species[selectedKey];
  const buf = norm10(s.buf), net = norm10(s.net), vol = norm10(s.vol), sym = norm10(s.sym), tool = norm10(s.tool);

  speciesBars.innerHTML = `
    ${barRow("Population buffer", buf, "linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))")}
    ${barRow("Network reach", net, "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))")}
    ${barRow("Environmental volatility", vol, "linear-gradient(to right, rgba(100,116,139,.95), rgba(251,113,133,.95))")}
    ${barRow("Symbolic culture", sym, "linear-gradient(to right, rgba(168,85,247,.95), rgba(236,72,153,.95))")}
    ${barRow("Tool sophistication", tool, "linear-gradient(to right, rgba(34,197,94,.95), rgba(74,222,128,.95))")}
    <div class="mini muted" style="margin-top:6px;">
      Extinction can result from low buffers + low reach under high volatility, even with strong tool competence.
    </div>
  `;

  if(compareAll){
    const keys = Object.keys(species);
    const rows = keys.map(k=>{
      const X = species[k];
      return `<tr>
        <td>${X.name}</td>
        <td style="font-family:var(--mono)">${X.buf}/10</td>
        <td style="font-family:var(--mono)">${X.net}/10</td>
        <td style="font-family:var(--mono)">${X.vol}/10</td>
        <td style="font-family:var(--mono)">${X.sym}/10</td>
        <td style="font-family:var(--mono)">${X.tool}/10</td>
      </tr>`;
    }).join("");
    speciesBars.innerHTML += `
      <div class="mini muted" style="margin-top:10px;"><strong>Compare all lineages</strong> (schematic)</div>
      <div style="overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.22);">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Lineage</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Buffer</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Reach</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Volatility</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Symbol</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(148,163,184,.22);">Tools</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }
}

/* (Selection + recalc continues in Part 4) */
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
/* ========= Bars / panels ========= */
function updateModeBadge(){
  const m = modeSelect.value;
  const label = m==="bio" ? "Biological emphasis" : (m==="culture" ? "Cultural emphasis" : "Coupled (Bio√óCulture)");
  modeBadge.textContent = "Mode: " + label;
}
function setSlidersFromStage(s){
  popSlider.value = s.pop;
  contactSlider.value = s.contact;
  lossSlider.value = s.loss;

  lifespanSlider.value = s.lifespan;
  learnSlider.value = s.learnYears;
  elderSlider.value = s.elderYears;

  shockSlider.value = s.shock;
  resilienceSlider.value = s.resilience;

  syncSliderLabels();
  renderHeat(+popSlider.value, +contactSlider.value, +lossSlider.value);
}
function syncSliderLabels(){
  popNum.textContent = `${popSlider.value}/10`;
  contactNum.textContent = `${contactSlider.value}/10`;
  lossNum.textContent = `${lossSlider.value}/10`;

  lifespanNum.textContent = `${lifespanSlider.value}y`;
  learnNum.textContent = `${learnSlider.value}y`;
  elderNum.textContent = `${elderSlider.value}y`;

  shockNum.textContent = `${shockSlider.value}/10`;
  resilienceNum.textContent = `${resilienceSlider.value}/10`;
}
function renderDistributionBars(s){
  const d = s.dist;
  distBars.innerHTML = `
    ${barRow("Toolmaking", norm10(d.tool), "linear-gradient(to right, rgba(34,197,94,.95), rgba(74,222,128,.95))")}
    ${barRow("Social reasoning", norm10(d.social), "linear-gradient(to right, rgba(56,189,248,.95), rgba(34,197,94,.95))")}
    ${barRow("Symbolic compression", norm10(d.symbolic), "linear-gradient(to right, rgba(168,85,247,.95), rgba(56,189,248,.95))")}
    ${barRow("Long-term planning", norm10(d.planning), "linear-gradient(to right, rgba(251,191,36,.95), rgba(236,72,153,.95))")}
    ${barRow("Environmental modeling", norm10(d.env), "linear-gradient(to right, rgba(234,179,8,.95), rgba(34,197,94,.95))")}
  `;
}
function renderLongevityBars(lifespan, learnYears, elderYears){
  const teach = longevityTeachingFactor(lifespan, learnYears, elderYears);
  const productive = clamp(lifespan-12,0,80);
  const teachWindow = clamp(productive*0.25 + elderYears, 0, 80);

  longevityBars.innerHTML = `
    ${barRow("Teaching fit (0‚Äì1)", teach, `linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))`)}
    ${barRow("Teach window vs learning", clamp(teachWindow/Math.max(learnYears,1),0,1),
      "linear-gradient(to right, rgba(56,189,248,.95), rgba(74,222,128,.95))")}
    <div class="mini muted" style="margin-top:6px;">
      Productive years: <span style="font-family:var(--mono);color:#cfe7ff">${productive.toFixed(0)}y</span> ¬∑
      Teaching window: <span style="font-family:var(--mono);color:#cfe7ff">${teachWindow.toFixed(1)}y</span>.
    </div>
  `;
  return teach;
}
function renderRiskBars(s, ret, teach){
  const collapse = collapseProbability(s, ret, teach);
  const fragility = clamp(1 - (0.62*ret + 0.38*teach), 0, 1);
  const shock = norm10(s.shock);
  const resilience = norm10(s.resilience);

  riskBars.innerHTML = `
    ${barRow("Retention stability", ret, "linear-gradient(to right, rgba(239,68,68,.95), rgba(74,222,128,.95))")}
    ${barRow("Knowledge fragility", fragility, "linear-gradient(to right, rgba(74,222,128,.95), rgba(251,113,133,.95))")}
    ${barRow("Shock intensity", shock, "linear-gradient(to right, rgba(100,116,139,.95), rgba(251,113,133,.95))")}
    ${barRow("Resilience policy", resilience, "linear-gradient(to right, rgba(251,191,36,.95), rgba(34,197,94,.95))")}
    ${barRow("Collapse probability", collapse, "linear-gradient(to right, rgba(251,191,36,.95), rgba(251,113,133,.95))")}
  `;
  const note = collapse < 0.33
    ? "Low: institutions + buffers likely preserve complex knowledge."
    : collapse < 0.66
      ? "Medium: regression is plausible; complex systems are fragile under shocks."
      : "High: collapses likely; knowledge may fragment and require rediscovery.";
  riskNote.innerHTML = `<strong style="color:#cfefff">Interpretation:</strong> <span class="muted">${note}</span>`;
  return collapse;
}

/* ========= Selection + Recalc ========= */
function selectStage(s, tr){
  selectedStage = s;
  document.querySelectorAll("tbody tr").forEach(r=>r.classList.remove("active-row"));
  tr.classList.add("active-row");
  selectedBadge.textContent = `${s.lineage} ¬∑ ${s.year}`;
  setSlidersFromStage(s);
  recalcAndRenderAll();
}
function recalcAndRenderAll(){
  updateModeBadge();
  syncSliderLabels();

  if(!selectedStage) selectedStage = stages[0];

  // Snapshot with current slider tuning
  const s = {...selectedStage};
  s.pop = +popSlider.value;
  s.contact = +contactSlider.value;
  s.loss = +lossSlider.value;

  s.lifespan = +lifespanSlider.value;
  s.learnYears = +learnSlider.value;
  s.elderYears = +elderSlider.value;

  s.shock = +shockSlider.value;
  s.resilience = +resilienceSlider.value;

  const ret = retentionScore(s.pop, s.contact, s.loss);
  const teach = renderLongevityBars(s.lifespan, s.learnYears, s.elderYears);
  const collapse = renderRiskBars(s, ret, teach);
  const idx = intelligenceIndex(s, modeSelect.value, ret, teach);

  kpiInt.textContent = `${Math.round(idx*100)}/100`;
  kpiCollapse.textContent = fmtPct(collapse);

  renderDistributionBars(s);
  drawCrossover(s);
  renderHeat(+popSlider.value, +contactSlider.value, +lossSlider.value);

  // Branch view
  renderBranchSvg(speciesSelect.value);
  renderSpeciesBars(speciesSelect.value);

  // Biogeography model render
  const model = computeRegional(s, modeSelect.value);
  renderWorldMap(model);
  updatePinnedRegion(model);

  // Reviewer mode
  reviewerBox.style.display = reviewerToggle.checked ? "block" : "none";
  reviewerText.innerHTML = reviewerCopy;

  // Table refresh (retention column updates with stage defaults; OK for this dashboard)
  renderTable();
}

/* ========= Wiring ========= */
searchBox.addEventListener("input", renderTable);
modeSelect.addEventListener("change", recalcAndRenderAll);

[popSlider, contactSlider, lossSlider,
 lifespanSlider, learnSlider, elderSlider,
 shockSlider, resilienceSlider].forEach(el=>{
  el.addEventListener("input", recalcAndRenderAll);
});

reviewerToggle.addEventListener("change", recalcAndRenderAll);

speciesSelect.addEventListener("change", ()=>{
  compareAll = false;
  compareAllBtn.textContent = "Compare all";
  recalcAndRenderAll();
});
compareAllBtn.addEventListener("click", ()=>{
  compareAll = !compareAll;
  compareAllBtn.textContent = compareAll ? "Close compare" : "Compare all";
  recalcAndRenderAll();
});

resetTuningBtn.addEventListener("click", ()=>{
  if(!selectedStage) selectedStage = stages[0];
  pinnedRegionId = null;
  setSlidersFromStage(selectedStage);
  compareAll = false;
  compareAllBtn.textContent = "Compare all";
  recalcAndRenderAll();
});

/* ========= Initial boot ========= */
function boot(){
  selectedStage = stages[0];
  setSlidersFromStage(selectedStage);

  renderTable();
  // visually mark first row
  const firstRow = document.querySelector("#eventTable tr");
  if(firstRow){
    firstRow.classList.add("active-row");
    selectedBadge.textContent = `${selectedStage.lineage} ¬∑ ${selectedStage.year}`;
  }

  // initialize pin display
  pinName.textContent = "None";
  pinRetention.textContent = "‚Äî";
  pinIntensity.textContent = "‚Äî";
  pinDiffusion.textContent = "‚Äî";

  recalcAndRenderAll();
}
boot();
</script>

</body>
</html>
