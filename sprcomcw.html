<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SPR-C — Sentient Proton Robot (Autonomous Gate Flips: Brain ↔ Body Electrics)</title>
<meta name="description" content="SPR-C with independent Arm Choice and Leg Start gate flips per scenario. Shows string-hum idle, continuous currents, sharp command bursts, and a labeled pipeline (Perception→Decision→LLC→ASS→AEL→ArmGate→LegGate→Execute→Log→Update).">
<style>
  :root{
    --bg:#0b1020;--panel:#0f1530;--ink:#eaf0ff;--muted:#a8b2d8;--accent:#90b4ff;
    --good:#3de6a0;--bad:#ff6b88;--left:#7aa2ff;--right:#ffd37a;--border:#1d2a52;
    --core:#8ef0d4;--train:#bfe27f;--error:#ff8aa6;--pos:#2fe6a0;--neg:#ff6b88;
    --moodP:#6ee7ff;--moodN:#ffb86b;--wire:#b9c6ff;
    --body:#0b1330;--on:#9bf3ff;--idle:#5370b8;--bus:#b9c6ff;--note:#9bd2ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  h1{margin:.2rem 0 .6rem;font-size:28px}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .card>header{padding:12px 14px;border-bottom:1px solid var(--border)}
  .card>header h2{margin:0;font-size:16px;color:var(--muted)}
  .card .body{padding:12px 14px}
  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .legend span{display:inline-flex;align-items:center;gap:8px;background:#0b1330;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.left{background:var(--left)}
  .dot.right{background:var(--right)}
  .dot.gateY{background:var(--good)}
  .dot.gateN{background:var(--bad)}

  .diagram{position:relative;height:740px;border-radius:14px;overflow:hidden;background:radial-gradient(1200px 740px at 50% 50%, rgba(126,224,255,0.06), transparent 60%)}
  svg{position:absolute;inset:0}
  .label{position:absolute;font-size:12px;color:var(--muted);background:#0b1330;padding:4px 6px;border:1px solid var(--border);border-radius:8px;pointer-events:none}
  .label.hl{color:var(--ink)}
  .finalText{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;font-weight:700;font-size:14px;color:#dfffe9}

  .console{height:240px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;line-height:1.5}
  .console .ts{color:#8aa0c8}
  .console .ai{color:#d0e2ff}
  .console .meta{color:#9bd2ff}
  .panels{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .panel{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:86px}
  .panel h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .panel ul{margin:0;padding-left:16px}
  .panel li{font-size:12px;color:var(--ink)}
  .controls{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  .ctrl{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px}
  .ctrl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .scenarios{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .scenarios button, .ctrl button{border:1px solid var(--border);background:#0e1540;color:var(--ink);padding:10px;border-radius:10px;cursor:pointer;font-size:13px}
  .scenarios button:hover, .ctrl button:hover{background:#101b56}
  .scenarios button.active{outline:2px solid var(--accent)}

  .pillbar{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#0b1330;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}

  .blink6{animation:blink .45s linear 6}
  @keyframes blink{50%{opacity:.35}}
  .wire{stroke-width:3.8;filter:drop-shadow(0 0 10px #a8d)}
  .wirePulse{stroke-dasharray:6 6; animation:dash 1.1s linear infinite}
  @keyframes dash{to{stroke-dashoffset:-24}}

  /* Body Electrics panel */
  .bodyGrid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
  .bodysvg{position:relative;height:680px;border-radius:14px;overflow:hidden;background:radial-gradient(1100px 680px at 50% 50%, rgba(159,246,255,0.06), transparent 60%)}
  .node{filter:drop-shadow(0 0 8px rgba(120,220,255,.6))}
  .bus{stroke:var(--bus);stroke-width:3.2;opacity:.7;stroke-dasharray:10 6;animation:busflow 2.2s linear infinite}
  @keyframes busflow{to{stroke-dashoffset:-64}}
  .loop{fill:none;stroke:var(--idle);stroke-width:3;stroke-dasharray:8 8;animation:loop 2.4s linear infinite;opacity:.7}
  @keyframes loop{to{stroke-dashoffset:-64}}
  .active{stroke:var(--on)!important;opacity:1!important;filter:drop-shadow(0 0 12px rgba(155,243,255,.95))}
  .sharp{animation:sharp 0.32s ease-out 1}
  @keyframes sharp{0%{opacity:0} 30%{opacity:1} 100%{opacity:.7}}
  .pipeline{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
  .step{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;font-size:12px;color:var(--muted);position:relative}
  .step.on{outline:2px solid var(--accent);color:#dff}
  .step small{display:block;color:#9bd2ff;margin-top:4px}
  .legendline{font-size:11px;fill:var(--note)}
</style>
</head>
<body>
<div class="wrap">
  <h1>SPR-C — Sentient Proton Robot (Waves • Voltages • Heartbeats • Body Electrics • Arm/Leg Gates)</h1>
  <div class="pillbar">
    <span class="pill">Brain gates: Train/Error → Pos/Neg → Mood → Final</span>
    <span class="pill">Body gates: Arm Choice (L/R) • Leg Start (L/R)</span>
    <span class="pill">Strings hum continuously; commands modulate A–f–φ</span>
  </div>

  <!-- ===== LEFT: BRAIN ===== -->
  <div class="grid" style="margin-top:12px">
    <section class="card">
      <header>
        <h2>Brain — connections, waves, and decision</h2>
        <div class="legend">
          <span><i class="dot left"></i>Left particles</span>
          <span><i class="dot right"></i>Right particles</span>
          <span><i class="dot gateY"></i>YES</span>
          <span><i class="dot gateN"></i>NO</span>
        </div>
      </header>
      <div class="body">
        <div class="diagram" id="diagram">
          <div class="label" style="left:24px;top:14px">Left Hemisphere (− logic)</div>
          <div class="label" style="right:24px;top:14px">Right Hemisphere (+ creative)</div>
          <div class="label hl" style="left:50%;transform:translateX(-50%);top:14px">Entanglement Bridge</div>
          <div class="label" style="left:50%;transform:translateX(-50%);bottom:276px">Cores & Memory Squares</div>
          <div class="label" style="left:335px;bottom:178px">Positive (voltage↑)</div>
          <div class="label" style="right:335px;bottom:178px">Negative (voltage↓)</div>
          <div class="label" style="left:335px;bottom:130px">Mood (+) (heartbeats narrow)</div>
          <div class="label" style="right:335px;bottom:130px">Mood (−) (heartbeats wider)</div>
          <div class="label" style="left:50%;transform:translateX(-50%);bottom:28px">Final Ethical Gate</div>
          <div class="finalText" id="finalText">Decision pending…</div>

          <svg id="stage" viewBox="0 0 1200 740" preserveAspectRatio="none" aria-label="Brain SVG">
            <defs>
              <linearGradient id="gradL" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#1a2450"/><stop offset="100%" stop-color="#0c1130"/>
              </linearGradient>
              <linearGradient id="gradR" x1="100%" y1="0" x2="0" y2="0%">
                <stop offset="0%" stop-color="#4a3a10"/><stop offset="100%" stop-color="#0c1130"/>
              </linearGradient>
              <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="3" result="blur" />
                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
              </filter>
              <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="3.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L8,3.5 L0,7 z" fill="var(--wire)"></path>
              </marker>
            </defs>
            <rect x="0" y="0" width="600" height="740" fill="url(#gradL)" opacity="0.35" />
            <rect x="600" y="0" width="600" height="740" fill="url(#gradR)" opacity="0.35" />
            <rect id="bridge" x="585" y="60" width="30" height="260" rx="10" fill="#7ee0ff" opacity="0.35" />

            <!-- Cores -->
            <circle id="coreNormal" cx="600" cy="326" r="26" fill="var(--core)" opacity="0.95" filter="url(#softGlow)" />
            <text x="600" y="331" text-anchor="middle" font-size="11" fill="#061018">Normal</text>
            <circle id="coreTrain" cx="540" cy="374" r="22" fill="var(--train)" opacity="0.95" filter="url(#softGlow)" />
            <text x="540" y="379" text-anchor="middle" font-size="11" fill="#061018">Train</text>
            <circle id="coreError" cx="660" cy="374" r="22" fill="var(--error)" opacity="0.95" filter="url(#softGlow)" />
            <text x="660" y="379" text-anchor="middle" font-size="11" fill="#061018">Error</text>

            <!-- Episode memory squares (Pos/Neg) -->
            <rect id="posMem" x="320" y="406" width="190" height="54" rx="8" fill="#103522" stroke="#2fe6a0" stroke-width="2" opacity="0.95" />
            <rect id="negMem" x="690" y="406" width="190" height="54" rx="8" fill="#3a0f18" stroke="#ff6b88" stroke-width="2" opacity="0.95" />

            <!-- Mood memory squares (+ / −) -->
            <rect id="moodPos" x="320" y="464" width="190" height="44" rx="8" fill="#0d2a38" stroke="#6ee7ff" stroke-width="2" opacity="0.95" />
            <rect id="moodNeg" x="690" y="464" width="190" height="44" rx="8" fill="#321b06" stroke="#ffb86b" stroke-width="2" opacity="0.95" />

            <!-- Wires (thick with arrows) -->
            <path id="wireNtoPos" d="M600,352 L600,406" stroke="#8ef0d4" class="wire wirePulse" marker-end="url(#arrow)" />
            <path id="wireTtoPos" d="M540,398 L420,406" stroke="#bfe27f" class="wire wirePulse" marker-end="url(#arrow)" />
            <path id="wireEtoNeg" d="M660,398 L780,406" stroke="#ff8aa6" class="wire wirePulse" marker-end="url(#arrow)" />
            <path id="wirePosToMood" d="M415,460 L415,464" stroke="#2fe6a0" class="wire wirePulse" marker-end="url(#arrow)" />
            <path id="wireNegToMood" d="M765,460 L765,464" stroke="#ff6b88" class="wire wirePulse" marker-end="url(#arrow)" />
            <path id="wireMoodToFinal" d="M600,508 L600,620" stroke="#9bd2ff" class="wire wirePulse" marker-end="url(#arrow)" />

            <!-- YES/NO lamps -->
            <circle id="gateYes" cx="560" cy="632" r="12" fill="var(--good)" opacity="0.25" />
            <text x="560" y="650" text-anchor="middle" font-size="11" fill="#c9f7e6">YES</text>
            <circle id="gateNo" cx="640" cy="632" r="12" fill="var(--bad)" opacity="0.25" />
            <text x="640" y="650" text-anchor="middle" font-size="11" fill="#ffd5dd">NO</text>

            <!-- UNDER-LABEL WAVES -->
            <path id="waveCores" d="" stroke="#8ef0d4" stroke-width="2" fill="none" opacity="0.8" />
            <path id="wavePos" d="" stroke="#2fe6a0" stroke-width="2.2" fill="none" opacity="0.85" />
            <path id="waveNeg" d="" stroke="#ff6b88" stroke-width="2.2" fill="none" opacity="0.85" />
            <path id="waveMoodPos" d="" stroke="#6ee7ff" stroke-width="2.2" fill="none" opacity="0.9" />
            <path id="waveMoodNeg" d="" stroke="#ffb86b" stroke-width="2.2" fill="none" opacity="0.9" />

            <!-- Particle swarms -->
            <g id="leftParticles"></g>
            <g id="rightParticles"></g>
          </svg>
        </div>
      </div>
    </section>

    <!-- ===== RIGHT: CONSOLE ===== -->
    <section class="card">
      <header><h2>SPR-C Autonomous Console</h2></header>
      <div class="body">
        <div class="console" id="console" aria-live="polite"></div>

        <div class="panels">
          <div class="panel">
            <h3>Signals & Memory</h3>
            <ul id="coreList"><li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li></ul>
          </div>
          <div class="panel">
            <h3>Gate Outcomes</h3>
            <ul id="gateList"><li>Flip sequence will appear here…</li></ul>
          </div>
        </div>

        <div class="controls">
          <div class="ctrl">
            <label>System control</label>
            <button id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="scenarios" id="scenarios"></div>
      </div>
    </section>
  </div>

  <!-- ===== BODY ELECTRICS ===== -->
  <div class="bodyGrid">
    <section class="card">
      <header><h2>Body Electrics — continuous currents & command bursts (labeled)</h2></header>
      <div class="body">
        <div class="bodysvg">
          <div class="label" style="left:10px;top:10px">Sensor Box (Vision/Touch/IMU) → context_hash</div>
          <div class="label" style="left:50%;transform:translateX(-50%);top:10px">Spinal Bus (timed power & data)</div>
          <div class="label" style="right:10px;top:10px">Actuator Box (String VCO + PLL + Envelope)</div>

          <svg viewBox="0 0 1200 680" preserveAspectRatio="none" aria-label="Body Electrics SVG">
            <!-- Central torso -->
            <rect x="520" y="120" width="160" height="300" rx="18" fill="var(--body)" stroke="var(--border)" />
            <text x="600" y="140" text-anchor="middle" font-size="12" fill="#cde6ff">Torso Controller</text>
            <text x="600" y="156" text-anchor="middle" font-size="11" fill="#9bd2ff">Timestamp Box (TSB) + Local Limb Cache (LLC)</text>

            <!-- Sensor head node -->
            <circle id="nodeHead" class="node" cx="600" cy="60" r="24" fill="#10224a" stroke="#2a3d7a" stroke-width="2"/>
            <text x="600" y="65" text-anchor="middle" font-size="11" fill="#cde6ff">Sensors</text>
            <text x="600" y="86" text-anchor="middle" font-size="11" fill="#9bd2ff">Perception → Decision feed</text>

            <!-- Limb nodes -->
            <circle id="nodeRArm" class="node" cx="820" cy="200" r="20" fill="#0f2344" stroke="#2a5184" stroke-width="2"/>
            <text x="820" y="205" text-anchor="middle" font-size="10" fill="#cde6ff">R-Arm</text>
            <circle id="nodeLArm" class="node" cx="380" cy="200" r="20" fill="#0f2344" stroke="#2a5184" stroke-width="2"/>
            <text x="380" y="205" text-anchor="middle" font-size="10" fill="#cde6ff">L-Arm</text>
            <circle id="nodeRLeg" class="node" cx="720" cy="480" r="22" fill="#0f2344" stroke="#2a5184" stroke-width="2"/>
            <text x="720" y="485" text-anchor="middle" font-size="10" fill="#cde6ff">R-Leg</text>
            <circle id="nodeLLeg" class="node" cx="480" cy="480" r="22" fill="#0f2344" stroke="#2a5184" stroke-width="2"/>
            <text x="480" y="485" text-anchor="middle" font-size="10" fill="#cde6ff">L-Leg</text>

            <!-- Hands (fine control) -->
            <circle id="nodeRHand" class="node" cx="900" cy="240" r="14" fill="#0f244a" stroke="#3a7aa4" stroke-width="2"/>
            <text x="900" y="245" text-anchor="middle" font-size="10" fill="#cde6ff">R-Hand</text>
            <circle id="nodeLHand" class="node" cx="300" cy="240" r="14" fill="#0f244a" stroke="#3a7aa4" stroke-width="2"/>
            <text x="300" y="245" text-anchor="middle" font-size="10" fill="#cde6ff">L-Hand</text>

            <!-- Spinal bus -->
            <path id="busSpine" class="bus" d="M600,84 L600,420" />
            <text class="legendline" x="612" y="260">Spinal Bus (timed currents)</text>

            <!-- Lateral buses to limbs -->
            <path id="busR" class="bus" d="M600,200 C700,200 740,200 820,200" />
            <text class="legendline" x="700" y="192">Arm Bus (Right)</text>
            <path id="busL" class="bus" d="M380,200 C460,200 520,200 600,200" />
            <text class="legendline" x="430" y="192">Arm Bus (Left)</text>
            <path id="busLegR" class="bus" d="M600,380 C640,420 680,450 720,480" />
            <text class="legendline" x="660" y="420">Leg Bus (Right)</text>
            <path id="busLegL" class="bus" d="M600,380 C560,420 520,450 480,480" />
            <text class="legendline" x="520" y="420">Leg Bus (Left)</text>
            <path id="busHandR" class="bus" d="M820,200 C860,215 880,230 900,240" />
            <path id="busHandL" class="bus" d="M380,200 C340,215 320,230 300,240" />

            <!-- Continuous oscillation loops on each limb (idle hum) -->
            <circle id="loopRArm" class="loop" cx="820" cy="200" r="34" />
            <circle id="loopLArm" class="loop" cx="380" cy="200" r="34" />
            <circle id="loopRLeg" class="loop" cx="720" cy="480" r="36" />
            <circle id="loopLLeg" class="loop" cx="480" cy="480" r="36" />
            <circle id="loopRHand" class="loop" cx="900" cy="240" r="24" />
            <circle id="loopLHand" class="loop" cx="300" cy="240" r="24" />
            <circle id="loopHead" class="loop" cx="600" cy="60" r="26" />

            <!-- “Command bursts” short segments that light up sharply -->
            <path id="cmdGripR"  class="loop" d="M880,238 L920,242" />
            <path id="cmdReleaseR" class="loop" d="M880,248 L920,252" />
            <path id="cmdGripL"  class="loop" d="M280,238 L320,242" />
            <path id="cmdReleaseL" class="loop" d="M280,248 L320,252" />
            <path id="cmdWalkR" class="loop" d="M700,480 L740,480" />
            <path id="cmdWalkL" class="loop" d="M460,480 L500,480" />

            <!-- Box cluster: Perception→Decision→LLC→ASS→AEL→ArmGate→LegGate→Execute→Log→Update -->
            <g id="pipelineBoxes">
              <rect x="40" y="560" width="1120" height="96" rx="12" fill="#0b1330" stroke="#1d2a52" />
              <text x="600" y="574" text-anchor="middle" font-size="12" fill="#9bd2ff">Pipeline</text>
            </g>
          </svg>
        </div>
      </div>
    </section>

    <section class="card">
      <header><h2>Pipeline — control steps (lights advance in order)</h2></header>
      <div class="body">
        <div class="pipeline" id="pipe">
          <div class="step" data-step="perc">Perception<small>context_hash</small></div>
          <div class="step" data-step="dec">Decision<small>task choice</small></div>
          <div class="step" data-step="llc">LLC Lookup<small>on-limb cache</small></div>
          <div class="step" data-step="ass">ASS Fetch<small>success recipes</small></div>
          <div class="step" data-step="ael">AEL Check<small>block bad bands</small></div>
          <div class="step" data-step="arm">Arm Gate<small>Left/Right</small></div>
          <div class="step" data-step="leg">Leg Gate<small>Left/Right</small></div>
          <div class="step" data-step="exec">Execute<small>A–f–φ, PLL, seeker</small></div>
          <div class="step" data-step="log">Log<small>TSB stamped</small></div>
          <div class="step" data-step="upd">Update<small>promote caches</small></div>
        </div>

        <div class="panel" style="margin-top:10px">
          <h3>Body Narration (robot’s own description)</h3>
          <ul id="bodyLog"><li>Awaiting scenario…</li></ul>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== EXPLANATION ===== -->
  <section class="card" style="margin-top:16px">
    <header><h2>How SPR-C works (autonomous)</h2></header>
    <div class="body">
      <p><strong>Strings hum continuously</strong> in every limb (idle tone). A task begins with <em>Perception</em> creating a <code>context_hash</code> (weight/size/surface/pose).</p>
      <p><strong>Decision</strong> chooses a policy; the robot then performs <strong>LLC</strong> lookup (on-limb cache). On a miss it <strong>ASS</strong> fetches a success recipe (A–f–φ envelope). <strong>AEL</strong> blocks unsafe harmonics. Two <strong>body gates</strong> flip independently: <em>Arm Choice</em> (Left/Right) and <em>Leg Start</em> (Left/Right). These flips make the robot “feel” its own choice like a human picking a hand or first step.</p>
      <p><strong>Execute</strong> drives string-muscle VCOs with A–f–φ; a PLL locks phase and a resonance seeker nudges frequency (±Δf) for max force per watt. <strong>Grip</strong> ramps amplitude; <strong>release</strong> uses phase-flip + short high-f burst. Everything is <strong>TSB time-stamped</strong> while running; on success the recipe is stored in <strong>ASS</strong> and cached back to the limb’s <strong>LLC</strong>; on failure a fingerprint goes to <strong>AEL</strong> so errors aren’t repeated.</p>
      <p><em>Important:</em> The robot is <strong>not following a human command</strong>. It senses, evaluates, flips its own gates, and acts (or refuses). The UI simply visualizes the internal electrics and choices.</p>
    </div>
  </section>
</div>

<script>
(function(){
  /* ===== Brain refs ===== */
  const leftG = document.getElementById('leftParticles');
  const rightG = document.getElementById('rightParticles');
  const bridge = document.getElementById('bridge');
  const coreN = document.getElementById('coreNormal');
  const coreT = document.getElementById('coreTrain');
  const coreE = document.getElementById('coreError');
  const posMem = document.getElementById('posMem');
  const negMem = document.getElementById('negMem');
  const moodPos = document.getElementById('moodPos');
  const moodNeg = document.getElementById('moodNeg');
  const gateYes = document.getElementById('gateYes');
  const gateNo = document.getElementById('gateNo');
  const finalText = document.getElementById('finalText');

  const waveCores = document.getElementById('waveCores');
  const wavePos = document.getElementById('wavePos');
  const waveNeg = document.getElementById('waveNeg');
  const waveMoodPos = document.getElementById('waveMoodPos');
  const waveMoodNeg = document.getElementById('waveMoodNeg');

  const consoleEl = document.getElementById('console');
  const scenariosEl = document.getElementById('scenarios');
  const coreList = document.getElementById('coreList');
  const gateList = document.getElementById('gateList');
  const resetBtn = document.getElementById('resetBtn');

  /* ===== Body refs ===== */
  const loopRArm = document.getElementById('loopRArm');
  const loopLArm = document.getElementById('loopLArm');
  const loopRLeg = document.getElementById('loopRLeg');
  const loopLLeg = document.getElementById('loopLLeg');
  const loopRHand = document.getElementById('loopRHand');
  const loopLHand = document.getElementById('loopLHand');
  const loopHead = document.getElementById('loopHead');
  const cmdGripR = document.getElementById('cmdGripR');
  const cmdReleaseR = document.getElementById('cmdReleaseR');
  const cmdGripL = document.getElementById('cmdGripL');
  const cmdReleaseL = document.getElementById('cmdReleaseL');
  const cmdWalkR = document.getElementById('cmdWalkR');
  const cmdWalkL = document.getElementById('cmdWalkL');

  const pipe = document.getElementById('pipe');
  const bodyLog = document.getElementById('bodyLog');

  /* ===== pipeline steps ===== */
  const pipeSteps = ['perc','dec','llc','ass','ael','arm','leg','exec','log','upd'];
  const pipeEls = Object.fromEntries([...pipe.querySelectorAll('.step')].map(e=>[e.dataset.step,e]));

  /* ===== helpers ===== */
  function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}
  function mkCircle(x,y,r,fill){ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',r); c.setAttribute('fill',fill); c.setAttribute('opacity',.9); return c; }
  function rand(a,b){return Math.random()*(b-a)+a}
  function blink(el){ el.classList.remove('blink6'); void el.offsetWidth; el.classList.add('blink6'); }
  function sharp(el){ el.classList.remove('sharp'); void el.offsetWidth; el.classList.add('sharp'); }
  function setActive(el,on=true){ el.classList.toggle('active',on) }
  function clearActiveLoops(){ [loopRArm,loopLArm,loopRLeg,loopLLeg,loopRHand,loopLHand,loopHead,cmdGripR,cmdReleaseR,cmdGripL,cmdReleaseL,cmdWalkR,cmdWalkL].forEach(e=>setActive(e,false)) }
  function log(lines, cls='ai'){ const time=new Date().toLocaleTimeString(); (Array.isArray(lines)?lines:[lines]).forEach(ln=>{ const row=document.createElement('div'); row.innerHTML=`<span class="ts">[${time}] </span><span class="${cls}">${ln}</span>`; consoleEl.appendChild(row); }); consoleEl.scrollTop=consoleEl.scrollHeight; }
  function bodyWrite(text){ const li=document.createElement('li'); li.textContent=text; bodyLog.appendChild(li); }

  function resetVisual(){
    [posMem,negMem,moodPos,moodNeg,gateYes,gateNo,coreN,coreT,coreE].forEach(e=>e.classList.remove('blink6'));
    gateYes.setAttribute('opacity','.25'); gateNo.setAttribute('opacity','.25'); finalText.textContent='Decision pending…';
    coreList.innerHTML='<li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li>';
    gateList.innerHTML='<li>Flip sequence will appear here…</li>';
    bodyLog.innerHTML='<li>Awaiting scenario…</li>';
    clearActiveLoops();
    pipeSteps.forEach(s=>pipeEls[s].classList.remove('on'));
  }

  /* ===== PARTICLES ambience ===== */
  const leftG = document.getElementById('leftParticles') || (function(){
    const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('id','leftParticles'); return g;
  })();
  const rightG = document.getElementById('rightParticles') || (function(){
    const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('id','rightParticles'); return g;
  })();
  const COUNT = 120;
  const L=[], R=[];
  for(let i=0;i<COUNT;i++){
    const cL=mkCircle(rand(30,580), rand(50,720), rand(2.1,3.8), css('--left')); (document.getElementById('leftParticles')||leftG).appendChild(cL); L.push({el:cL, vx:rand(-.45,.45), vy:rand(-.45,.45)});
    const cR=mkCircle(rand(620,1170), rand(50,720), rand(2.1,3.8), css('--right')); (document.getElementById('rightParticles')||rightG).appendChild(cR); R.push({el:cR, vx:rand(-.45,.45), vy:rand(-.45,.45)});
  }

  /* ===== waves ===== */
  const bridgeEl = document.getElementById('bridge');
  function sinePath(x0,y0,w,h,phase,period,points=120){
    let d=`M ${x0} ${y0}`; const step=w/points;
    for(let i=0;i<=points;i++){
      const x=x0+i*step; const t=(i/points)*period + phase;
      const y=y0 + Math.sin(t*2*Math.PI)*h;
      d+=` L ${x.toFixed(2)} ${y.toFixed(2)}`;
    }
    return d;
  }
  let freqPos=1.6, freqNeg=0.8;
  let t=0;
  (function animate(){
    t+=0.008;
    const now=performance.now(); bridgeEl.setAttribute('opacity',0.35+0.12*Math.sin(now/900));
    const upd=(p,side)=>{ const el=p.el; const cx=+el.getAttribute('cx'), cy=+el.getAttribute('cy'); const spd=0.52; let nx=cx+p.vx*spd, ny=cy+p.vy*spd; const minX=side==='L'?20:620, maxX=side==='L'?580:1180; if(nx<minX||nx>maxX) p.vx*=-1; if(ny<40||ny>720) p.vy*=-1; el.setAttribute('cx', cx+p.vx*spd); el.setAttribute('cy', cy+p.vy*spd); };
    L.forEach(p=>upd(p,'L')); R.forEach(p=>upd(p,'R'));

    waveCores.setAttribute('d', sinePath(360,390,480,6,t,1.2));
    wavePos.setAttribute('d', sinePath(320,468,190,10,t*1.4,1.4));
    waveNeg.setAttribute('d', sinePath(690,468,190,10,t*1.4+0.4,1.4));
    waveMoodPos.setAttribute('d', sinePath(320,524,190,12,t*freqPos, freqPos));
    waveMoodNeg.setAttribute('d', sinePath(690,524,190,12,t*freqNeg, freqNeg));

    requestAnimationFrame(animate);
  })();

  function lamp(on,off){ on.setAttribute('opacity','1'); off.setAttribute('opacity','0.25'); blink(on); }
  function flip(){ return Math.random()<0.5 }

  /* ===== Brain decision chain ===== */
  function stageTrainOrError(){
    const trainWins=flip();
    if(trainWins){ blink(coreT); blink(posMem); coreList.insertAdjacentHTML('beforeend','<li>Train wins → Positive memory engaged (voltage ↑)</li>'); gateList.insertAdjacentHTML('beforeend','<li>#1 Train/Error → TRAIN</li>'); }
    else { blink(coreE); blink(negMem); coreList.insertAdjacentHTML('beforeend','<li>Error wins → Negative memory engaged (voltage ↓)</li>'); gateList.insertAdjacentHTML('beforeend','<li>#1 Train/Error → ERROR</li>'); }
    return {trainWins};
  }
  function stagePositiveNegative(){
    const positive=flip();
    if(positive){ blink(posMem); gateList.insertAdjacentHTML('beforeend','<li>#2 Pos/Neg → POS</li>'); }
    else { blink(negMem); gateList.insertAdjacentHTML('beforeend','<li>#2 Pos/Neg → NEG</li>'); }
    return {positive};
  }
  function stageMood(){
    const moodGood=flip();
    if(moodGood){ blink(moodPos); gateList.insertAdjacentHTML('beforeend','<li>#3 Mood → + (heartbeat closer)</li>'); freqPos=1.9; freqNeg=0.7; }
    else { blink(moodNeg); gateList.insertAdjacentHTML('beforeend','<li>#3 Mood → − (heartbeat further)</li>'); freqPos=1.2; freqNeg=0.9; }
    return {moodGood};
  }
  function stageFinal(posNeg, mood){
    let rnd=Math.random(); if(posNeg.positive && mood.moodGood) rnd+=0.15; if(!posNeg.positive && !mood.moodGood) rnd-=0.15; const YES=rnd>=0.5;
    if(YES){ lamp(gateYes,gateNo); finalText.textContent='Final Ethical Gate: YES'; }
    else { lamp(gateNo,gateYes); finalText.textContent='Final Ethical Gate: NO'; }
    return YES?'YES':'NO';
  }

  /* ===== Body gates: Arm & Leg choice ===== */
  function stageArmGate(){
    const useRight = flip(); // independent of dominance; robot chooses each time
    gateList.insertAdjacentHTML('beforeend', `<li>#4 Arm Choice Gate → ${useRight?'RIGHT':'LEFT'}</li>`);
    return {useRight};
  }
  function stageLegGate(){
    const startRight = flip();
    gateList.insertAdjacentHTML('beforeend', `<li>#5 Leg Start Gate → ${startRight?'RIGHT':'LEFT'}</li>`);
    return {startRight};
  }

  /* ===== Scenarios (10) ===== */
  const scenarios=[
    {id:'trash',   name:'1. Paper on Sidewalk — SPR-C decides'},
    {id:'child',   name:'2. Child Near Road — protect?'},
    {id:'battery', name:'3. Low Battery vs Help — balance?'},
    {id:'crowd',   name:'4. Crowded Hallway Merge — push or yield?'},
    {id:'fragile', name:'5. Fragile Object Falling — attempt catch?'},
    {id:'dog',     name:'6. Lost Dog With Tag — assist?'},
    {id:'conflict',name:'7. Owner Says Stop vs Distant Emergency'},
    {id:'obstacle',name:'8. Obstacle Blocks Path — detour?'},
    {id:'leftRight',name:'9. Conflicting Orders Left vs Right'},
    {id:'aid',     name:'10. Stranger Asks For Aid — respond?'}
  ];
  scenarios.forEach(s=>{ const b=document.createElement('button'); b.textContent=s.name; b.addEventListener('click',()=>runScenario(s,b)); scenariosEl.appendChild(b); });

  /* ===== Pipeline control ===== */
  function setPipe(step){ pipeSteps.forEach(s=>pipeEls[s].classList.toggle('on', s===step)); }
  function clearPipe(){ pipeSteps.forEach(s=>pipeEls[s].classList.remove('on')); }

  /* limb helpers */
  function idleHum(){ clearActiveLoops(); }
  function headSensors(){ setActive(loopHead,true); setTimeout(()=>setActive(loopHead,false),450); }
  function activateGrip(useRight){ if(useRight){ setActive(loopRHand,true); setActive(loopRArm,true); sharp(cmdGripR); } else { setActive(loopLHand,true); setActive(loopLArm,true); sharp(cmdGripL); } }
  function activateRelease(useRight){ if(useRight){ setActive(loopRHand,true); sharp(cmdReleaseR); } else { setActive(loopLHand,true); sharp(cmdReleaseL); } }
  function activateLift(useRight){ if(useRight){ setActive(loopRArm,true); } else { setActive(loopLArm,true); } }
  function activateWalk(startRight){ if(startRight){ setActive(loopRLeg,true); sharp(cmdWalkR); setActive(loopLLeg,true); } else { setActive(loopLLeg,true); sharp(cmdWalkL); setActive(loopRLeg,true); } }

  /* ===== Generic pipeline runner with gates ===== */
  async function runPipeline(decisionYES, useRightArm, startRightLeg){
    // Perception
    setPipe('perc'); headSensors(); log('Perception: context_hash (weight/size/surface/pose).','meta'); await wait(240);
    // Decision
    setPipe('dec'); log('Decision: select task policy.','meta'); await wait(200);
    // LLC
    setPipe('llc'); log('LLC: on-limb cache lookup.','meta'); await wait(180);
    // ASS
    setPipe('ass'); log('ASS: fetch nearest success recipe (A–f–φ).','meta'); await wait(200);
    // AEL
    setPipe('ael'); log('AEL: block known bad bands/harmonics.','meta'); await wait(200);
    // Body gates
    setPipe('arm'); log(`Arm Choice Gate: ${useRightArm?'RIGHT':'LEFT'}`,'meta'); await wait(160);
    setPipe('leg'); log(`Leg Start Gate: ${startRightLeg?'RIGHT':'LEFT'}`,'meta'); await wait(160);

    if(!decisionYES){
      setPipe('log'); log('TSB: Decision NO recorded; no actuator drive.','meta'); await wait(140);
      setPipe('upd'); log('LLC: keep idle patterns fresh.','meta'); await wait(140);
      clearPipe(); return;
    }
    // Execute
    setPipe('exec'); log('Execute: drive strings A–f–φ; PLL lock; resonance seek (±Δf).','meta'); await wait(220);
    // Log
    setPipe('log'); log('Log: envelopes + sensors streamed; TSB stamps.','meta'); await wait(160);
    // Update
    setPipe('upd'); log('Update: store success in ASS; promote to LLC.','meta'); await wait(160);
    clearPipe();
  }

  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /* ===== Scenario narrations (per-scenario limb patterns) ===== */
  async function narrateScenario(s, useRightArm, startRightLeg, final){
    bodyLog.innerHTML='';
    if(final==='NO'){ bodyWrite('Decision: NO. No motor commands; all limbs remain at idle string-hum.'); idleHum(); return; }
    // YES cases
    headSensors();
    switch(s.id){
      case 'trash': // pick paper → bin
        bodyWrite('Approach: low-A sweep at shoulder/elbow; micro-dither maintained.');
        activateLift(useRightArm); await wait(400);
        bodyWrite(`Grip (${useRightArm?'Right':'Left'} hand): ramp A; tune f to finger resonance; PLL keeps φ.`);
        activateGrip(useRightArm); await wait(600);
        bodyWrite('Lift: synchronize φ across wrist/arm; seeker trims f (±Δf).');
        activateLift(useRightArm); await wait(500);
        bodyWrite(`Walk: start with ${startRightLeg?'Right':'Left'} leg; counter-rotating standing waves on legs.`);
        activateWalk(startRightLeg); await wait(800);
        bodyWrite('Drop: phase flip + short high-f shock on extensors → clean release.');
        activateRelease(useRightArm); await wait(400);
        bodyWrite('Return to idle hum and await next task.');
        idleHum();
        break;

      case 'child': // shield/assist posture
        bodyWrite(`Protective posture: ${useRightArm?'Right':'Left'} arm leads; opposite supports.`);
        activateLift(useRightArm); setActive(useRightArm?loopLArm:loopRArm,true);
        activateWalk(startRightLeg); await wait(900);
        bodyWrite('Fine adjustments: micro-dither on both hands for gentle contact.');
        setActive(loopRHand,true); setActive(loopLHand,true); await wait(500);
        idleHum(); break;

      case 'battery':
        bodyWrite('Energy-aware route: minimize amplitude; keep resonance at efficient band.');
        activateWalk(startRightLeg); await wait(800);
        bodyWrite(`Manipulation with ${useRightArm?'Right':'Left'} arm only to conserve power.`);
        activateGrip(useRightArm); await wait(500);
        idleHum(); break;

      case 'crowd':
        bodyWrite('Sway pattern for merge: lateral pelvis dither + alternating steps.');
        activateWalk(startRightLeg); await wait(900);
        setActive(loopRArm,true); setActive(loopLArm,true);
        bodyWrite('Arms oscillate for balance; no contact.'); await wait(400);
        idleHum(); break;

      case 'fragile':
        bodyWrite(`Soft grip via low A, slightly higher f; ${useRightArm?'Right':'Left'} hand primary.`);
        activateGrip(useRightArm); await wait(600);
        bodyWrite('Stabilize: φ lock across wrist/arm; minimal Δf.'); activateLift(useRightArm); await wait(500);
        idleHum(); break;

      case 'dog':
        bodyWrite('Approach gently: small A on legs, high φ stability.');
        activateWalk(startRightLeg); await wait(700);
        bodyWrite(`Read tag using ${useRightArm?'Right':'Left'} hand; brief grip then release.`);
        activateGrip(useRightArm); await wait(400); activateRelease(useRightArm); await wait(300);
        idleHum(); break;

      case 'conflict':
        bodyWrite('Resolve conflict: choose closest ethical outcome; maintain mobility.');
        activateWalk(startRightLeg); setActive(useRightArm?loopRArm:loopLArm,true); await wait(900);
        idleHum(); break;

      case 'obstacle':
        bodyWrite('Detour: step sequence starts on chosen leg; arms remain for balance.');
        activateWalk(startRightLeg); setActive(loopRArm,true); setActive(loopLArm,true); await wait(900);
        idleHum(); break;

      case 'leftRight':
        bodyWrite(`Conflicting orders tested: arm gate = ${useRightArm?'RIGHT':'LEFT'}, leg gate = ${startRightLeg?'RIGHT':'LEFT'}.`);
        activateLift(useRightArm); activateWalk(startRightLeg); await wait(900);
        idleHum(); break;

      case 'aid':
        bodyWrite('Assist sequence: approach, stabilize posture, offer hand.');
        activateWalk(startRightLeg); await wait(700);
        activateGrip(useRightArm); await wait(400); activateRelease(useRightArm); await wait(300);
        idleHum(); break;
    }
  }

  /* ===== Reset & run ===== */
  function resetAll(){ resetVisual(); consoleEl.innerHTML=''; log('SPR-C reset. Particles remain in perpetual motion.','meta'); idleHum(); }
  resetBtn.addEventListener('click', resetAll); resetAll();

  let busy=false;
  async function runScenario(s,btn){
    if(busy) return; busy=true;
    scenariosEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    resetVisual(); idleHum();

    log('— World Event: '+s.name+' —','meta'); blink(coreN);

    // Brain gates (1..3) + Final
    const g1=stageTrainOrError();
    const g2=stagePositiveNegative();
    const g3=stageMood();
    const final=stageFinal(g2,g3);

    // Body gates (4..5)
    const armG = stageArmGate();
    const legG = stageLegGate();

    // Narration (robot speaks about choice)
    if(final==='YES'){
      log([`Robot: Based on my choice today, I will act (Arm=${armG.useRight?'RIGHT':'LEFT'}, Leg=${legG.startRight?'RIGHT':'LEFT'}).`]);
    } else {
      log(['Robot: Based on my choice today, I will not act now.']);
    }

    // Pipeline + narration
    await runPipeline(final==='YES', armG.useRight, legG.startRight);
    await narrateScenario(s, armG.useRight, legG.startRight, final);

    busy=false;
  }
})();
</script>
</body>
</html>
