<!-- ======================= PART 1 / 4 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan → Paris Trip Simulator (Live Readout) — Time Zones + Mass/Fuel + Map</title>
<style>
  :root {
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1100px 700px at 25% -10%, rgba(96,165,250,.20), transparent 50%),
                radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.14), transparent 55%),
                linear-gradient(180deg, #050814 0%, #03050c 100%);
    color:var(--ink);
  }
  .wrap{max-width:1500px;margin:0 auto;padding:18px 14px 42px}
  header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}

  /* Layout (balanced): controls left, explanation right (with extra panels moved under explanation) */
  .row{display:grid;grid-template-columns: 480px 1fr;gap:14px;margin-top:14px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.92));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
  .card .hd .t{font-weight:800}
  .card .bd{padding:14px}

  .controls{display:grid;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  button{
    appearance:none;border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.55); color:var(--ink);
    padding:10px 12px;border-radius:12px;font-weight:700;
    cursor:pointer;
  }
  button:hover{border-color:rgba(96,165,250,.55)}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.45;cursor:not-allowed}

  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.24);font-size:.85rem;color:var(--muted);background:rgba(2,6,23,.35)}
  .legend{display:flex;gap:8px;flex-wrap:wrap}

  .stat{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .k{color:var(--muted);font-size:.82rem}
  .v{font-family:var(--mono);font-size:1.05rem;margin-top:4px}
  .mono{font-family:var(--mono)}
  .small{font-size:.92rem;color:var(--muted);line-height:1.25}
  .eq{font-family:var(--mono);font-size:.92rem;background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px;white-space:pre-wrap}

  .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.12);overflow:hidden;border:1px solid rgba(148,163,184,.16)}
  .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85))}

  .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}

  input[type="range"]{width:100%}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .bad{color:var(--bad)}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);color:var(--muted);font-size:.86rem
  }
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.5)}

  /* Extra panels moved under explanation card */
  .extrasGrid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:12px}
  @media (max-width:1100px){.extrasGrid{grid-template-columns:1fr}}
  .extrasStack{display:grid;gap:10px}

  /* Time panel */
  .timeGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  @media (max-width:520px){.timeGrid{grid-template-columns:1fr}}
  .timeBox{background:rgba(2,6,23,.30);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .timeLbl{color:var(--muted);font-size:.82rem}
  .timeVal{font-family:var(--mono);font-size:1.0rem;margin-top:6px;line-height:1.12;white-space:pre-line}
  .timeSub{color:var(--muted);font-size:.82rem;margin-top:6px}

  /* Mass/Fuel meters */
  .meter{display:grid;gap:8px}
  .meterline{display:flex;justify-content:space-between;gap:10px;font-family:var(--mono);font-size:.92rem}
  .meterbar{height:10px;border-radius:999px;background:rgba(148,163,184,.10);border:1px solid rgba(148,163,184,.16);overflow:hidden}
  .meterbar > b{display:block;height:100%;width:0%}
  .bFuel{background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(96,165,250,.45))}
  .bScram{background:linear-gradient(90deg, rgba(251,191,36,.95), rgba(251,191,36,.45))}
  .bCool{background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(52,211,153,.45))}

  /* Map */
  .mapWrap{
    background: radial-gradient(900px 420px at 30% 0%, rgba(96,165,250,.18), transparent 55%),
                radial-gradient(700px 380px at 90% 25%, rgba(52,211,153,.12), transparent 60%),
                rgba(2,6,23,.25);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  canvas{display:block;width:100%;height:260px;border-radius:12px}
  .mapLegend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .miniPill{padding:5px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.35);color:var(--muted);font-size:.82rem}

  /* Timeline table */
  .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
  table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(2,6,23,.25)}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
  th{text-align:left;color:var(--muted);font-size:.85rem;position:sticky;top:0;background:rgba(7,10,20,.85);backdrop-filter: blur(6px)}
  tr.active{outline:2px solid rgba(96,165,250,.55);background:rgba(96,165,250,.08)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.18);font-size:.78rem;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Japan → Paris Trip Simulator (Live Readout)</h1>
      <div class="sub">
        Stable, row-by-row playback with live readouts.
        <b>Balanced layout:</b> time/mass/map moved under Explanation so the left controls stay clean.
      </div>
    </div>
    <div class="legend">
      <span class="pill">Trip length: <b id="tripLen">146 min</b></span>
      <span class="pill">Playback: <b id="spdLbl">60×</b></span>
      <span class="pill">Mass factor: <b id="massFactorLbl">1.00×</b></span>
      <span class="pill">Status: <b id="statusLbl" class="warn">Stopped</b></span>
    </div>
  </header>

  <div class="row">
    <!-- LEFT: Controls + instruments -->
    <section class="card">
      <div class="hd">
        <div class="t">Controls • Instruments</div>
        <div class="pill mono">t = <span id="tNow">0.00</span> min</div>
      </div>
      <div class="bd">
        <div class="controls">
          <div class="btnrow">
            <button id="btnStart" type="button">Start</button>
            <button id="btnStop" type="button" disabled>Stop</button>
            <button id="btnReset" type="button">Reset</button>
          </div>

          <div class="stat">
            <div class="k">Playback speed (sim minutes per real second)</div>
            <input id="spd" type="range" min="1" max="240" value="60"/>
            <div class="small">Effective speed = slider × mass factor (from mass/fuel sliders under Explanation).</div>
            <div class="small mono" style="margin-top:6px">
              Effective: <span id="effSpeedLbl">60.0</span> sim-min/s • ETA (real): <span id="etaRealLbl">—</span>
            </div>
          </div>

          <div class="stat">
            <div class="k">Trip progress</div>
            <div class="bar"><i id="prog"></i></div>
            <div class="small mono"><span id="progPct">0</span>% • step <span id="stepNow">—</span> • <span id="phaseNow">—</span></div>
          </div>

          <div class="split">
            <div class="stat">
              <div class="k">Mach</div>
              <div class="v"><span id="mach">0.00</span></div>
              <div class="small">Interpolated within active step.</div>
            </div>
            <div class="stat">
              <div class="k">Altitude</div>
              <div class="v"><span id="alt">0.0</span> km</div>
              <div class="small">Interpolated within active step.</div>
            </div>

            <div class="stat">
              <div class="k">Medium type</div>
              <div class="v"><span id="medium">Troposphere</span></div>
              <div class="small">Altitude-banded.</div>
            </div>
            <div class="stat">
              <div class="k">Cold index</div>
              <div class="v"><span id="cold">0.00</span></div>
              <div class="small">From ambient temperature (0..1).</div>
            </div>

            <div class="stat">
              <div class="k">Ambient temp</div>
              <div class="v"><span id="Tamb">288.15</span> K</div>
              <div class="small">Interpolated by altitude.</div>
            </div>
            <div class="stat">
              <div class="k">Density</div>
              <div class="v"><span id="rho">1.2250</span> kg/m³</div>
              <div class="small">Interpolated by altitude.</div>
            </div>

            <div class="stat">
              <div class="k">Speed</div>
              <div class="v"><span id="V">0</span> m/s</div>
              <div class="small">V = Mach · a(alt).</div>
            </div>
            <div class="stat">
              <div class="k">Dynamic pressure</div>
              <div class="v"><span id="q">0.0</span> kPa</div>
              <div class="small">q = ½ρV².</div>
            </div>

            <div class="stat">
              <div class="k">Heating proxy</div>
              <div class="v"><span id="H">0.00</span></div>
              <div class="small">H = q/q_ref.</div>
            </div>
            <div class="stat">
              <div class="k">Skin temperature</div>
              <div class="v"><span id="Tskin">288.15</span> K</div>
              <div class="small">Thermal ODE (heating vs cooling).</div>
            </div>

            <div class="stat">
              <div class="k">Coolant flow</div>
              <div class="v"><span id="cool">0.20</span> kg/s</div>
              <div class="small">Tank-limited.</div>
            </div>
            <div class="stat">
              <div class="k">Stability score</div>
              <div class="v"><span id="stab">1.00</span></div>
              <div class="small">Loads + heating + ramps (+ small inertia term).</div>
            </div>
          </div>

          <div class="stat">
            <div class="k">CST discipline (from row)</div>
            <div class="small" id="cstNote">—</div>
          </div>

          <div class="stat">
            <div class="k">Quick status</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
              <span class="chip"><span class="dot" id="dotTherm"></span>Thermal</span>
              <span class="chip"><span class="dot" id="dotLoad"></span>Loads</span>
              <span class="chip"><span class="dot" id="dotNav"></span>Nav/INS</span>
              <span class="chip"><span class="dot" id="dotComm"></span>Comm/Plasma</span>
            </div>
            <div class="small" id="riskTxt" style="margin-top:8px">—</div>
          </div>

        </div>
      </div>
    </section>

    <!-- RIGHT: Explanation + (moved) time/mass/map -->
    <section class="card">
      <div class="hd">
        <div class="t">Explanation • Equations • Tunables • Extra Panels</div>
        <div class="tag">Verified wiring: Start/Stop/Reset</div>
      </div>
      <div class="bd">
        <div class="small">
          The simulator advances simulation time <span class="mono">t</span> (minutes), selects the active step,
          linearly interpolates Mach/altitude, interpolates atmosphere, computes <span class="mono">V</span>, <span class="mono">q</span>, heating proxy <span class="mono">H</span>, coolant flow, and stability.
          <b>Mass/fuel</b> only affects <b>real-time completion</b> via a mass factor (it does not alter the underlying timeline data).
        </div>

        <div style="height:10px"></div>

        <div class="eq"><b>Equations used</b>
1) Step interpolation:
   s = clamp((t - t0)/(t1 - t0), 0..1)
   Mach(t) = Mach0 + s·(Mach1 - Mach0)
   Alt(t)  = Alt0  + s·(Alt1  - Alt0)

2) Atmosphere (by table interpolation):
   Tamb(Alt), rho(Alt), a(Alt)

3) Speed:
   V = Mach · a(Alt)

4) Dynamic pressure:
   q = ½ · rho · V²

5) Heating proxy (dimensionless):
   H = q_kPa / q_ref_kPa

6) Cold index (0..1):
   Cold = clamp((T_warm - Tamb)/(T_warm - T_cold), 0..1)

7) Coolant command (kg/s), tank-limited:
   mDot_cmd = clamp(m_min + gH·H + gCold·Cold + gMach·(Mach/10), m_min..m_max)
   mDot = min(mDot_cmd, coolantRemaining / dtSimSec)

8) Stability score (0..1):
   q_norm = clamp(q_kPa / q_bad_kPa, 0..1)
   H_norm = clamp(H / H_bad, 0..1)
   ramp   = |dMach/dt| + 0.6|dAlt/dt| (scaled to 0..1)
   bandPenalty from plasma/INS flags (0..1)
   inertiaPenalty = small term from totalMass/refMass
   Stability = clamp(1 - (wq·q_norm + wH·H_norm + wRamp·ramp + wBand·bandPenalty + inertiaPenalty), 0..1)

9) Mass factor for real-time completion:
   massFactor = clamp( sqrt(refMass / totalMass), 0.65..1.10 )
   effectiveSpeed = sliderSpeed × massFactor</div>

        <div class="small" style="margin-top:10px">
          Tunables are inside the script (q_ref, gains, weights, fuel burn rates). This remains a stable demo: it’s a consistent instrument cluster + timing.
        </div>

        <!-- Extras moved here for balance -->
        <div class="extrasGrid">
          <div class="extrasStack">
            <div class="stat">
              <div class="k">Departure & Arrival clocks (browser time)</div>
              <div class="timeGrid">
                <div class="timeBox">
                  <div class="timeLbl">Departure (locked when Start is pressed)</div>
                  <div class="timeVal" id="depTimes">—</div>
                  <div class="timeSub" id="depNote">Press Start to lock departure time.</div>
                </div>
                <div class="timeBox">
                  <div class="timeLbl">Arrival (ETA from effective speed)</div>
                  <div class="timeVal" id="arrTimes">—</div>
                  <div class="timeSub" id="arrNote">Updates live from current time + ETA.</div>
                </div>
              </div>
            </div>

            <div class="stat">
              <div class="k">Mass & Fuel (affects effective speed only)</div>

              <div class="split" style="margin-top:10px">
                <div class="stat">
                  <div class="k">Airframe (dry) mass</div>
                  <input id="mAir" type="range" min="10000" max="120000" step="500" value="52000"/>
                  <div class="small mono"><span id="mAirLbl">52000</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Scramjet system mass</div>
                  <input id="mScramSys" type="range" min="500" max="20000" step="100" value="4500"/>
                  <div class="small mono"><span id="mScramSysLbl">4500</span> kg</div>
                </div>

                <div class="stat">
                  <div class="k">Jet fuel mass</div>
                  <input id="mJetFuel" type="range" min="0" max="60000" step="250" value="18000"/>
                  <div class="small mono"><span id="mJetFuelLbl">18000</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Scram fuel mass</div>
                  <input id="mScramFuel" type="range" min="0" max="40000" step="250" value="9000"/>
                  <div class="small mono"><span id="mScramFuelLbl">9000</span> kg</div>
                </div>

                <div class="stat">
                  <div class="k">Coolant mass (tank)</div>
                  <input id="mCoolant" type="range" min="0" max="12000" step="50" value="2200"/>
                  <div class="small mono"><span id="mCoolantLbl">2200</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Unmanned</div>
                  <div class="small">
                    <label style="display:flex;gap:10px;align-items:center">
                      <input id="unmanned" type="checkbox" checked />
                      Unmanned flight (slightly lower inertia penalty)
                    </label>
                  </div>
                  <div class="small mono" style="margin-top:6px">Total mass: <span id="mTotalLbl">—</span> kg</div>
                </div>
              </div>

              <div class="split" style="margin-top:10px">
                <div class="stat">
                  <div class="k">Remaining tanks (live burn)</div>
                  <div class="meter" style="margin-top:8px">
                    <div class="meterline"><span>Jet fuel</span><span><span id="jetRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bFuel" id="jetBar"></b></div>

                    <div class="meterline"><span>Scram fuel</span><span><span id="scramRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bScram" id="scramBar"></b></div>

                    <div class="meterline"><span>Coolant</span><span><span id="coolRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bCool" id="coolBar"></b></div>
                  </div>
                  <div class="small" style="margin-top:8px">
                    Coolant depletion caps flow (display + thermal effect).
                  </div>
                </div>

                <div class="stat">
                  <div class="k">Mass factor model</div>
                  <div class="eq" style="margin-top:8px">
refMass = 75,000 kg
massFactor = clamp( sqrt(refMass / totalMass), 0.65 .. 1.10 )
effectiveSpeed = sliderSpeed × massFactor
ETA_real_seconds = remainingSimMinutes / effectiveSpeed</div>
                </div>
              </div>
            </div>
          </div>

          <div class="extrasStack">
            <div class="stat">
              <div class="k">A → B Track (curved route) • moving aircraft icon</div>
              <div class="mapWrap" style="margin-top:8px">
                <canvas id="map" width="900" height="320"></canvas>
                <div class="mapLegend">
                  <span class="miniPill">A: Tokyo area</span>
                  <span class="miniPill">B: Paris</span>
                  <span class="miniPill">Curve is stylized “curvature”</span>
                </div>
              </div>
            </div>

            <div class="stat">
              <div class="k">Medium type (altitude bands)</div>
              <div class="eq" style="margin-top:8px">0–12 km: Troposphere
12–50 km: Stratosphere
50–85 km: Mesosphere
85+ km: Thermosphere</div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <div style="height:14px"></div>

  <section class="card">
    <div class="hd">
      <div class="t">Event Log • Row-by-row Timeline (from Excel)</div>
      <div class="pill mono">Active row highlights as the trip runs</div>
    </div>
    <div class="bd">
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Step</th>
              <th>Phase</th>
              <th>Start–End (min)</th>
              <th>Speed plan</th>
              <th>Alt band (km)</th>
              <th>Distance (km)</th>
              <th>Fuel / Mode</th>
              <th>EM</th>
              <th>Plasma</th>
              <th>INS reliance</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

</div><!-- wrap -->
<!-- ======================= PART 2 / 4 ======================= -->
<script>
/* ===================== DATA (from your Excel) ===================== */
const TRIP_LEN_MIN = 146.0;

const STEPS = [
  {"step":1,"phase":"Takeoff + initial climb","t0":0.0,"t1":15.0,"mach0":0.0,"mach1":1.0,"alt0":0.0,"alt1":12.0,"speedPlan":"0 → ~Mach 1","avgSpeed":137.0,"distKm":123.0,"fuelMode":"Jet fuel","notes":"Runway to high climb","em":"LOW (surface)","plasma":"NONE","ins":"LOW","cst":"Initialize CST baseline; timestamp discipline begins at takeoff."},
  {"step":2,"phase":"Climb + accelerate to Mach 3 corridor","t0":15.0,"t1":40.0,"mach0":1.0,"mach1":3.0,"alt0":12.0,"alt1":30.0,"speedPlan":"Mach 1 → Mach 3","avgSpeed":617.0,"distKm":926.0,"fuelMode":"Jet fuel","notes":"Transition into thinner air; heating begins to rise.","em":"LOW→MOD (ionosphere begins)","plasma":"NONE→MAYBE (at top)","ins":"LOW→MOD","cst":"Monitor time drift; tighten sensor-fusion timing as heating increases."},
  {"step":3,"phase":"Ramp up (controlled)","t0":40.0,"t1":50.0,"mach0":3.0,"mach1":10.0,"alt0":30.0,"alt1":45.0,"speedPlan":"Mach 3 → Mach 10","avgSpeed":2230.0,"distKm":1338.0,"fuelMode":"Scramjet / mixed-mode","notes":"Peak heating window; plasma and comm risk increases.","em":"MOD→HIGH","plasma":"MAYBE→LIKELY","ins":"HIGH","cst":"Mode switch: predict blackout; increase INS weight; keep clock sync coherent."},
  {"step":4,"phase":"Mach-10 cruise window","t0":50.0,"t1":60.0,"mach0":10.0,"mach1":10.0,"alt0":45.0,"alt1":55.0,"speedPlan":"Mach 10 steady","avgSpeed":3430.0,"distKm":2058.0,"fuelMode":"Scramjet (steady)","notes":"Short Mach-10 window; most sensitive to thermal/structural margins.","em":"HIGH","plasma":"LIKELY","ins":"HIGH","cst":"Hold time coherence through sensor dropouts; deterministic logging."},
  {"step":5,"phase":"Ramp down (controlled)","t0":60.0,"t1":70.0,"mach0":10.0,"mach1":3.0,"alt0":55.0,"alt1":35.0,"speedPlan":"Mach 10 → Mach 3","avgSpeed":2230.0,"distKm":1338.0,"fuelMode":"Scramjet → turbine/ram","notes":"Recover comms; reduce heating; stabilize inlet margin.","em":"HIGH→MOD","plasma":"LIKELY→MAYBE","ins":"HIGH→MOD","cst":"Reacquire/re-sync clocks; smooth handoff back to comm-aided nav."},
  {"step":6,"phase":"Long midcourse at Mach 3","t0":70.0,"t1":126.0,"mach0":3.0,"mach1":3.0,"alt0":25.0,"alt1":30.0,"speedPlan":"Mach 3 steady","avgSpeed":1000.0,"distKm":4138.0,"fuelMode":"Ramjet / turbine","notes":"Main distance segment; lower heating than Mach-10; optimize range.","em":"MOD","plasma":"MAYBE (sporadic)","ins":"MOD","cst":"Maintain long-term timing stability; periodic sync checks."},
  {"step":7,"phase":"Descent + landing","t0":126.0,"t1":146.0,"mach0":3.0,"mach1":0.0,"alt0":30.0,"alt1":0.0,"speedPlan":"Mach 3 → 0","avgSpeed":450.0,"distKm":540.0,"fuelMode":"Turbine + landing","notes":"Thermal cooldown; return to dense air; control authority increases.","em":"MOD→LOW","plasma":"NONE","ins":"LOW","cst":"Finalize logs; compute drift summary; archive mission timeline."}
];

const ATM = [
  {"alt_km":0.0,"T":288.15,"P":101325.0,"rho":1.225000018124288,"a":340.293988026089},
  {"alt_km":5.0,"T":255.65,"P":54019.888188145786,"rho":0.736115547399152,"a":320.5293944425378},
  {"alt_km":10.0,"T":223.15,"P":26436.2425926916,"rho":0.41270613707277716,"a":299.46316487458036},
  {"alt_km":15.0,"T":216.65,"P":12044.552806598,"rho":0.1936734512461432,"a":295.0694935090715},
  {"alt_km":20.0,"T":216.65,"P":5474.9,"rho":0.088035,"a":295.1},
  {"alt_km":25.0,"T":221.65,"P":2511.0,"rho":0.039466,"a":298.5},
  {"alt_km":30.0,"T":226.65,"P":1171.9,"rho":0.018012,"a":301.8},
  {"alt_km":35.0,"T":237.05,"P":558.9,"rho":0.008214,"a":308.6},
  {"alt_km":40.0,"T":251.05,"P":277.5,"rho":0.003851,"a":317.6},
  {"alt_km":45.0,"T":265.05,"P":143.1,"rho":0.001881,"a":326.4},
  {"alt_km":50.0,"T":270.65,"P":75.9,"rho":0.000978,"a":329.8},
  {"alt_km":55.0,"T":259.45,"P":40.0,"rho":0.000537,"a":322.9},
  {"alt_km":60.0,"T":245.45,"P":20.3,"rho":0.000288,"a":314.1},
  {"alt_km":65.0,"T":231.45,"P":9.9,"rho":0.000149,"a":305.0}
];

/* ===================== HELPERS ===================== */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const el = (id)=>document.getElementById(id);

function fmt(x, d=2) { if (!isFinite(x)) return "—"; return Number(x).toFixed(d); }
function fmtInt(x) { if (!isFinite(x)) return "—"; return String(Math.round(x)); }
function interp1(x, x0, y0, x1, y1) { if (x1===x0) return y0; const s=(x-x0)/(x1-x0); return y0+s*(y1-y0); }

function atmAt(altKm) {
  const x = clamp(altKm, ATM[0].alt_km, ATM[ATM.length-1].alt_km);
  for (let i=0;i<ATM.length-1;i++){
    const a0=ATM[i], a1=ATM[i+1];
    if (x>=a0.alt_km && x<=a1.alt_km){
      return {
        T:   interp1(x,a0.alt_km,a0.T,  a1.alt_km,a1.T),
        P:   interp1(x,a0.alt_km,a0.P,  a1.alt_km,a1.P),
        rho: interp1(x,a0.alt_km,a0.rho,a1.alt_km,a1.rho),
        a:   interp1(x,a0.alt_km,a0.a,  a1.alt_km,a1.a),
      };
    }
  }
  return {T:ATM[0].T,P:ATM[0].P,rho:ATM[0].rho,a:ATM[0].a};
}

function stepAt(tMin){
  for (const s of STEPS){ if (tMin>=s.t0 && tMin<s.t1) return s; }
  return STEPS[STEPS.length-1];
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

function mediumType(altKm){
  if (altKm < 12) return "Troposphere";
  if (altKm < 50) return "Stratosphere";
  if (altKm < 85) return "Mesosphere";
  return "Thermosphere";
}

function coldIndex(TambK){
  const T_warm = 288.15;
  const T_cold = 216.65;
  return clamp((T_warm - TambK)/(T_warm - T_cold), 0, 1);
}

function fmtHMS(totalSeconds){
  if (!isFinite(totalSeconds) || totalSeconds < 0) return "—";
  const s = Math.max(0, Math.round(totalSeconds));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}

/* ===================== TABLE BUILD ===================== */
const tbody = el("tbody");
const rowEls = new Map();

function buildTable(){
  tbody.innerHTML = "";
  for (const s of STEPS){
    const tr = document.createElement("tr");
    tr.dataset.step = String(s.step);
    tr.innerHTML = `
      <td class="mono">${s.step}</td>
      <td>${escapeHtml(s.phase)}</td>
      <td class="mono">${fmt(s.t0,0)}–${fmt(s.t1,0)}</td>
      <td>${escapeHtml(s.speedPlan)}</td>
      <td class="mono">${fmt(s.alt0,0)}→${fmt(s.alt1,0)}</td>
      <td class="mono">${fmt(s.distKm,0)}</td>
      <td>${escapeHtml(s.fuelMode)}</td>
      <td>${escapeHtml(s.em)}</td>
      <td>${escapeHtml(s.plasma)}</td>
      <td>${escapeHtml(s.ins)}</td>
      <td>${escapeHtml(s.notes)}</td>
    `;
    tbody.appendChild(tr);
    rowEls.set(s.step, tr);
  }
}

function highlightStep(step){
  for (const [k,tr] of rowEls.entries()){
    tr.classList.toggle("active", step === k);
  }
}
</script>
<!-- ======================= PART 3 / 4 ======================= -->
<script>
/* ===================== UI REFS ===================== */
const btnStart = el("btnStart");
const btnStop  = el("btnStop");
const btnReset = el("btnReset");
const spd = el("spd");
const spdLbl = el("spdLbl");
const statusLbl = el("statusLbl");

const massFactorLbl = el("massFactorLbl");
const effSpeedLbl = el("effSpeedLbl");
const etaRealLbl = el("etaRealLbl");

const tNow = el("tNow");
const prog = el("prog");
const progPct = el("progPct");
const stepNow = el("stepNow");
const phaseNow = el("phaseNow");

const machEl = el("mach");
const altEl = el("alt");
const mediumEl = el("medium");
const coldEl = el("cold");

const TambEl = el("Tamb");
const rhoEl = el("rho");
const VEl = el("V");
const qEl = el("q");
const HEl = el("H");
const TskinEl = el("Tskin");

const coolEl = el("cool");
const stabEl = el("stab");
const cstNote = el("cstNote");

const dotTherm = el("dotTherm");
const dotLoad  = el("dotLoad");
const dotNav   = el("dotNav");
const dotComm  = el("dotComm");
const riskTxt  = el("riskTxt");

const depTimes = el("depTimes");
const arrTimes = el("arrTimes");
const depNote  = el("depNote");
const arrNote  = el("arrNote");

const mAir = el("mAir");
const mScramSys = el("mScramSys");
const mJetFuel = el("mJetFuel");
const mScramFuel = el("mScramFuel");
const mCoolant = el("mCoolant");
const unmanned = el("unmanned");

const mAirLbl = el("mAirLbl");
const mScramSysLbl = el("mScramSysLbl");
const mJetFuelLbl = el("mJetFuelLbl");
const mScramFuelLbl = el("mScramFuelLbl");
const mCoolantLbl = el("mCoolantLbl");
const mTotalLbl = el("mTotalLbl");

const jetRemainLbl = el("jetRemainLbl");
const scramRemainLbl = el("scramRemainLbl");
const coolRemainLbl = el("coolRemainLbl");
const jetBar = el("jetBar");
const scramBar = el("scramBar");
const coolBar = el("coolBar");

const mapCanvas = el("map");
const ctx = mapCanvas.getContext("2d");

/* ===================== TUNABLES (verified) ===================== */
// Loads/heating scaling
const q_ref_kPa = 50.0;
const q_bad_kPa = 120.0;
const H_bad = 2.0;

// Skin thermal model (stable simple ODE)
const k_heat = 0.35;
const k_cool = 0.08;
const deltaHot = 50.0;

// Coolant controller (kg/s)
const m_min = 0.20;
const m_max = 1.20;
const gH = 0.55;
const gCold = 0.18;
const gMach = 0.15;

// Stability weights (sum <= 1 with inertia)
const wq = 0.35;
const wH = 0.35;
const wRamp = 0.20;
const wBand = 0.10;

// Fuel burn rates (kg per sim minute)
const burnJet_takeoff = 55;
const burnJet_mid = 40;
const burnJet_land = 30;
const burnScram_ramp = 85;
const burnScram_cruise = 110;

// Mass factor reference
const refMass = 75000;

/* ===================== STATE ===================== */
let running = false;
let tMin = 0.0;          // sim minutes
let lastTs = null;       // real ms timestamp
let Tskin = atmAt(0).T;  // K

let depReal = null;      // Date (locked at Start)
let jetFuelRemain = 0;
let scramFuelRemain = 0;
let coolantRemain = 0;

/* ===================== DERIVED / MODELS ===================== */
function setStatus(txt, cls){ statusLbl.textContent = txt; statusLbl.className = cls; }
function setButtons(){ btnStart.disabled = running; btnStop.disabled = !running; }
function dotColor(dotEl, level){
  const c = (level < 0.33) ? "rgba(52,211,153,.85)" : (level < 0.66) ? "rgba(251,191,36,.85)" : "rgba(251,113,133,.85)";
  dotEl.style.background = c;
}

function rampMetric(step){
  const dt = Math.max(1e-9, step.t1 - step.t0);
  const dMach = Math.abs(step.mach1 - step.mach0) / dt;
  const dAlt = Math.abs(step.alt1 - step.alt0) / dt;
  const rm = clamp(dMach/1.0, 0, 1);
  const ra = clamp(dAlt/2.0, 0, 1);
  return clamp(rm + 0.6*ra, 0, 1);
}
function bandPenalty(step){
  let p = 0;
  const plasma = String(step.plasma||"").toUpperCase();
  const ins = String(step.ins||"").toUpperCase();
  if (plasma.includes("LIKELY")) p += 0.6;
  else if (plasma.includes("MAYBE")) p += 0.3;
  if (ins.includes("HIGH")) p += 0.5;
  else if (ins.includes("MOD")) p += 0.25;
  return clamp(p/1.2, 0, 1);
}

function coolantCommand(H, Cold, Mach){
  const cmd = m_min + gH*H + gCold*Cold + gMach*(Mach/10);
  return clamp(cmd, m_min, m_max);
}

function stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen){
  const qn = clamp(q_kPa / q_bad_kPa, 0, 1);
  const Hn = clamp(H / H_bad, 0, 1);
  const score = 1 - (wq*qn + wH*Hn + wRamp*ramp + wBand*bandPen + inertiaPen);
  return clamp(score, 0, 1);
}

function burnRatesForStep(step){
  const st = step.step;
  if (st === 1 || st === 2) return {jet: burnJet_takeoff, scram: 0};
  if (st === 6) return {jet: burnJet_mid, scram: 0};
  if (st === 7) return {jet: burnJet_land, scram: 0};
  if (st === 3 || st === 5) return {jet: 0, scram: burnScram_ramp};
  if (st === 4) return {jet: 0, scram: burnScram_cruise};
  return {jet: 0, scram: 0};
}

/* Mass / time effect */
function totalMass(){
  return Number(mAir.value) + Number(mScramSys.value) + Number(mJetFuel.value) + Number(mScramFuel.value) + Number(mCoolant.value);
}
function massFactor(){
  const tm = Math.max(1, totalMass());
  return clamp(Math.sqrt(refMass / tm), 0.65, 1.10);
}
function effectiveSpeedSimMinPerSec(){
  return Number(spd.value) * massFactor();
}

/* Timezones */
const TZ_LOCAL = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
const TZ_CENTRAL = "America/Chicago";
const TZ_MOUNTAIN = "America/Denver";
const TZ_PARIS = "Europe/Paris";

function fmtInTZ(date, timeZone){
  try{
    const f = new Intl.DateTimeFormat(undefined, {
      timeZone,
      weekday:"short", year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });
    return f.format(date);
  }catch(e){
    return date.toISOString();
  }
}

function renderDepTimes(){
  if (!depReal){
    depTimes.textContent =
`Local (${TZ_LOCAL}): —
Central (${TZ_CENTRAL}): —
Mountain (${TZ_MOUNTAIN}): —
Paris (${TZ_PARIS}): —`;
    depNote.textContent = "Press Start to lock departure time.";
    return;
  }
  depTimes.textContent =
`Local (${TZ_LOCAL}): ${fmtInTZ(depReal, TZ_LOCAL)}
Central (${TZ_CENTRAL}): ${fmtInTZ(depReal, TZ_CENTRAL)}
Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(depReal, TZ_MOUNTAIN)}
Paris (${TZ_PARIS}): ${fmtInTZ(depReal, TZ_PARIS)}`;
  depNote.textContent = "Departure is locked (does not change).";
}

function renderArrivalETA(){
  const eff = effectiveSpeedSimMinPerSec();
  const remainingMin = Math.max(0, TRIP_LEN_MIN - tMin);
  const etaSec = (eff > 0) ? (remainingMin / eff) : Infinity;

  effSpeedLbl.textContent = fmt(eff, 1);
  etaRealLbl.textContent = isFinite(etaSec) ? `${fmtHMS(etaSec)} (hh:mm:ss)` : "—";

  const now = new Date();
  const arr = new Date(now.getTime() + (isFinite(etaSec) ? etaSec*1000 : 0));
  arrTimes.textContent =
`Local (${TZ_LOCAL}): ${fmtInTZ(arr, TZ_LOCAL)}
Central (${TZ_CENTRAL}): ${fmtInTZ(arr, TZ_CENTRAL)}
Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(arr, TZ_MOUNTAIN)}
Paris (${TZ_PARIS}): ${fmtInTZ(arr, TZ_PARIS)}`;
  arrNote.textContent = "Computed from current time + ETA.";
}

/* Meters */
function updateMassLabels(){
  mAirLbl.textContent = String(Number(mAir.value));
  mScramSysLbl.textContent = String(Number(mScramSys.value));
  mJetFuelLbl.textContent = String(Number(mJetFuel.value));
  mScramFuelLbl.textContent = String(Number(mScramFuel.value));
  mCoolantLbl.textContent = String(Number(mCoolant.value));
  mTotalLbl.textContent = String(Math.round(totalMass()));
  massFactorLbl.textContent = fmt(massFactor(), 2) + "×";
}

function setTankBars(){
  const jetInit = Number(mJetFuel.value);
  const scramInit = Number(mScramFuel.value);
  const coolInit = Number(mCoolant.value);

  jetRemainLbl.textContent = fmt(jetFuelRemain, 0);
  scramRemainLbl.textContent = fmt(scramFuelRemain, 0);
  coolRemainLbl.textContent = fmt(coolantRemain, 0);

  const jetPct = jetInit>0 ? clamp(jetFuelRemain/jetInit,0,1) : 0;
  const scramPct = scramInit>0 ? clamp(scramFuelRemain/scramInit,0,1) : 0;
  const coolPct = coolInit>0 ? clamp(coolantRemain/coolInit,0,1) : 0;

  jetBar.style.width = (jetPct*100).toFixed(1)+"%";
  scramBar.style.width = (scramPct*100).toFixed(1)+"%";
  coolBar.style.width = (coolPct*100).toFixed(1)+"%";
}

/* Map drawing */
const Apos = {x:0.18, y:0.62};
const Bpos = {x:0.78, y:0.40};

function drawMap(progress01){
  const W = mapCanvas.width, H = mapCanvas.height;
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle = "rgba(2,6,23,0.20)";
  ctx.fillRect(0,0,W,H);

  // grid
  ctx.lineWidth = 1;
  for (let i=0;i<=12;i++){
    const x = (i/12)*W;
    ctx.strokeStyle = "rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for (let j=0;j<=6;j++){
    const y = (j/6)*H;
    ctx.strokeStyle = "rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  // curvature arc (stylized)
  ctx.strokeStyle = "rgba(96,165,250,0.18)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const arcY = H*0.92;
  ctx.arc(W*0.5, arcY, W*0.62, Math.PI*1.05, Math.PI*1.95);
  ctx.stroke();

  const ax = Apos.x*W, ay = Apos.y*H;
  const bx = Bpos.x*W, by = Bpos.y*H;
  const cx1 = W*0.42, cy1 = H*0.10;
  const cx2 = W*0.58, cy2 = H*0.08;

  // path
  ctx.strokeStyle = "rgba(52,211,153,0.35)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(ax, ay);
  ctx.bezierCurveTo(cx1, cy1, cx2, cy2, bx, by);
  ctx.stroke();

  // endpoints
  function dot(x,y, r, color){
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  dot(ax,ay,6,"rgba(96,165,250,0.95)");
  dot(bx,by,6,"rgba(251,191,36,0.95)");

  ctx.fillStyle = "rgba(229,231,235,0.90)";
  ctx.font = "14px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("A", ax+10, ay+5);
  ctx.fillText("B", bx+10, by+5);

  const t = clamp(progress01, 0, 1);
  function bezierPoint(t){
    const x =
      (1-t)**3 * ax +
      3*(1-t)**2*t * cx1 +
      3*(1-t)*t**2 * cx2 +
      t**3 * bx;
    const y =
      (1-t)**3 * ay +
      3*(1-t)**2*t * cy1 +
      3*(1-t)*t**2 * cy2 +
      t**3 * by;
    return {x,y};
  }
  const p = bezierPoint(t);
  const p2 = bezierPoint(clamp(t+0.01,0,1));
  const ang = Math.atan2(p2.y-p.y, p2.x-p.x);

  // plane icon
  ctx.save();
  ctx.translate(p.x, p.y);
  ctx.rotate(ang);
  ctx.fillStyle = "rgba(251,113,133,0.92)";
  ctx.beginPath();
  ctx.moveTo(10,0);
  ctx.lineTo(-8,6);
  ctx.lineTo(-5,0);
  ctx.lineTo(-8,-6);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}
</script>
<!-- ======================= PART 4 / 4 ======================= -->
<script>
/* ===================== RENDER + LOOP (buttons fixed) ===================== */
function setTripLen(){
  const t = el("tripLen");
  if (t) t.textContent = `${TRIP_LEN_MIN.toFixed(0)} min`;
}

function resetAll(){
  running = false;
  lastTs = null;
  tMin = 0.0;
  Tskin = atmAt(0).T;

  depReal = null;

  // reset tanks from sliders
  jetFuelRemain = Number(mJetFuel.value);
  scramFuelRemain = Number(mScramFuel.value);
  coolantRemain = Number(mCoolant.value);

  setStatus("Stopped", "warn");
  setButtons();
  updateMassLabels();
  setTankBars();
  renderDepTimes();
  renderArrivalETA();
  render();
  highlightStep(null);
  drawMap(0);
}

function render(){
  const s = stepAt(tMin);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((tMin - s.t0)/span, 0, 1);

  const Mach = s.mach0 + frac*(s.mach1 - s.mach0);
  const Alt  = s.alt0  + frac*(s.alt1  - s.alt0);

  const Aatm = atmAt(Alt);
  const V = Mach * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0; // Pa->kPa
  const H = q_kPa / q_ref_kPa;

  const med = mediumType(Alt);
  const Cold = coldIndex(Aatm.T);

  const ramp = rampMetric(s);
  const bandPen = bandPenalty(s);

  // inertia penalty from mass (kept small so stability stays meaningful)
  const tm = totalMass();
  const massOver = clamp((tm/refMass) - 1.0, 0, 1.0);
  let inertiaPen = 0.08 * massOver;
  if (unmanned.checked) inertiaPen *= 0.75;

  // coolant command (display cap if tank empty)
  const cmd = coolantCommand(H, Cold, Mach);
  const mDotDisplay = (coolantRemain > 0) ? cmd : 0;

  const stab = stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen);

  // Panels
  tNow.textContent = fmt(tMin, 2);

  const pct = clamp((tMin/TRIP_LEN_MIN)*100, 0, 100);
  prog.style.width = pct.toFixed(1) + "%";
  progPct.textContent = pct.toFixed(0);

  stepNow.textContent = s.step;
  phaseNow.textContent = s.phase;

  machEl.textContent = fmt(Mach, 2);
  altEl.textContent = fmt(Alt, 1);

  mediumEl.textContent = med;
  coldEl.textContent = fmt(Cold, 2);

  TambEl.textContent = fmt(Aatm.T, 2);
  rhoEl.textContent = fmt(Aatm.rho, 4);
  VEl.textContent = fmtInt(V);
  qEl.textContent = fmt(q_kPa, 1);
  HEl.textContent = fmt(H, 2);
  TskinEl.textContent = fmt(Tskin, 2);

  coolEl.textContent = fmt(mDotDisplay, 2);
  stabEl.textContent = fmt(stab, 2);

  cstNote.textContent = s.cst || "—";

  // Risk dots
  const thermRisk = clamp((Tskin - Aatm.T)/120.0, 0, 1);
  const loadRisk  = clamp(q_kPa / q_bad_kPa, 0, 1);
  const navRisk   = bandPen;
  const commRisk  = clamp((String(s.plasma||"").toUpperCase().includes("LIKELY") ? 1 :
                           String(s.plasma||"").toUpperCase().includes("MAYBE") ? 0.5 : 0.1), 0, 1);

  dotColor(dotTherm, thermRisk);
  dotColor(dotLoad, loadRisk);
  dotColor(dotNav, navRisk);
  dotColor(dotComm, commRisk);

  riskTxt.innerHTML =
    `Medium: <span class="mono">${med}</span> • ` +
    `ColdIndex=<span class="mono">${fmt(Cold,2)}</span> • ` +
    `Ramp=<span class="mono">${fmt(ramp,2)}</span> • ` +
    `BandPen=<span class="mono">${fmt(bandPen,2)}</span> • ` +
    `Mass=<span class="mono">${fmt(tm,0)}kg</span> • ` +
    `Stability=<span class="mono">${fmt(stab,2)}</span>`;

  highlightStep(s.step);
  drawMap(tMin / TRIP_LEN_MIN);

  updateMassLabels();
  renderArrivalETA();
}

function loop(ts){
  if (!running) return;
  if (lastTs == null) lastTs = ts;

  const dtReal = (ts - lastTs) / 1000.0;
  lastTs = ts;

  // Effective speed uses mass factor
  const eff = effectiveSpeedSimMinPerSec();
  const dtMin = eff * dtReal;
  tMin += dtMin;

  // Current conditions for integration
  const s = stepAt(tMin);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((tMin - s.t0)/span, 0, 1);

  const Mach = s.mach0 + frac*(s.mach1 - s.mach0);
  const Alt  = s.alt0  + frac*(s.alt1  - s.alt0);
  const Aatm = atmAt(Alt);
  const V = Mach * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;
  const Cold = coldIndex(Aatm.T);

  const dtSimSec = dtMin * 60.0;

  // Coolant: command then cap by remaining tank
  const mDotCmd = coolantCommand(H, Cold, Mach);
  let mDot = mDotCmd;
  if (coolantRemain <= 0){
    mDot = 0;
  } else {
    const maxPossible = coolantRemain / Math.max(1e-9, dtSimSec); // kg/s
    mDot = Math.min(mDotCmd, maxPossible);
  }
  coolantRemain = Math.max(0, coolantRemain - (mDot * dtSimSec));

  // Thermal update: heating toward (Tamb + deltaHot), cooling to Tamb (boosted by mDot)
  const coolBoost = (mDotCmd <= 0) ? 1 : (1 + 1.6*clamp((mDot - m_min)/(m_max - m_min), 0, 1));
  const kCoolEff = k_cool * coolBoost;
  const heatTarget = Aatm.T + deltaHot;
  const dT = (k_heat * H * (heatTarget - Tskin)) - (kCoolEff * (Tskin - Aatm.T));
  Tskin += dT * (dtSimSec/60.0);

  // Fuel burn
  const burns = burnRatesForStep(s);
  jetFuelRemain = Math.max(0, jetFuelRemain - burns.jet * dtMin);
  scramFuelRemain = Math.max(0, scramFuelRemain - burns.scram * dtMin);
  setTankBars();

  // End
  if (tMin >= TRIP_LEN_MIN){
    tMin = TRIP_LEN_MIN;
    running = false;
    setStatus("Ended", "warn");
    setButtons();
  }

  render();
  if (running) requestAnimationFrame(loop);
}

/* ===================== EVENTS (Start/Stop/Reset verified) ===================== */
btnStart.addEventListener("click", ()=>{
  if (tMin >= TRIP_LEN_MIN) tMin = 0;

  if (!depReal) depReal = new Date();
  renderDepTimes();

  running = true;
  lastTs = null;
  setStatus("Running", "good");
  setButtons();
  requestAnimationFrame(loop);
});

btnStop.addEventListener("click", ()=>{
  running = false;
  lastTs = null;
  setStatus("Stopped", "warn");
  setButtons();
});

btnReset.addEventListener("click", resetAll);

spd.addEventListener("input", ()=>{
  spdLbl.textContent = spd.value + "×";
  renderArrivalETA();
});

[mAir,mScramSys,mJetFuel,mScramFuel,mCoolant,unmanned].forEach(x=>{
  x.addEventListener("input", ()=>{
    updateMassLabels();
    renderArrivalETA();
    if (!running){
      // When stopped, keep remaining tanks aligned to slider values only after Reset
      // (so the user sees stable behavior)
    }
  });
});

/* ===================== INIT ===================== */
buildTable();
setTripLen();
spdLbl.textContent = spd.value + "×";

// Live clock refresh (even if stopped)
setInterval(()=>{
  updateMassLabels();
  renderArrivalETA();
  if (!running) drawMap(tMin / TRIP_LEN_MIN);
  if (!depReal) renderDepTimes();
}, 1000);

resetAll();
</script>
</body>
</html>
