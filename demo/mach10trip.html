<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan → Paris Trip Simulator (Live Readout) — Cold Index + Medium Type + Coolant + Stability</title>
<style>
  :root {
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1100px 700px at 25% -10%, rgba(96,165,250,.20), transparent 50%),
                radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.14), transparent 55%),
                linear-gradient(180deg, #050814 0%, #03050c 100%);
    color:var(--ink);
  }
  .wrap{max-width:1400px;margin:0 auto;padding:18px 14px 42px}
  header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}
  .row{display:grid;grid-template-columns: 440px 1fr;gap:14px;margin-top:14px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}
  .card{
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.92));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
  .card .hd .t{font-weight:800}
  .card .bd{padding:14px}
  .controls{display:grid;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  button{
    appearance:none;border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.55); color:var(--ink);
    padding:10px 12px;border-radius:12px;font-weight:700;
    cursor:pointer;
  }
  button:hover{border-color:rgba(96,165,250,.55)}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.45;cursor:not-allowed}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.24);font-size:.85rem;color:var(--muted);background:rgba(2,6,23,.35)}
  .statgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .stat{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .k{color:var(--muted);font-size:.82rem}
  .v{font-family:var(--mono);font-size:1.05rem;margin-top:4px}
  .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.12);overflow:hidden;border:1px solid rgba(148,163,184,.16)}
  .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85))}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}
  .mono{font-family:var(--mono)}
  .small{font-size:.92rem;color:var(--muted);line-height:1.25}
  .eq{font-family:var(--mono);font-size:.92rem;background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px;white-space:pre-wrap}
  .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
  table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(2,6,23,.25)}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
  th{text-align:left;color:var(--muted);font-size:.85rem;position:sticky;top:0;background:rgba(7,10,20,.85);backdrop-filter: blur(6px)}
  tr.active{outline:2px solid rgba(96,165,250,.55);background:rgba(96,165,250,.08)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.18);font-size:.78rem;color:var(--muted)}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  input[type="range"]{width:100%}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .bad{color:var(--bad)}
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);color:var(--muted);font-size:.86rem
  }
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.5)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Japan → Paris Trip Simulator (Live Readout)</h1>
      <div class="sub">
        <p>
  View the live Simulations:
  <a href="https://gabinoc67.github.io/interstellar-star-clock/index.html" target="_blank" rel="noopener">
    Main Index
  </a>
  •
  <a href="https://gabinoc67.github.io/interstellar-star-clock/demo/mach10trip.html" target="_blank" rel="noopener">
    Mach 10 Trip
  </a>
  •
  <a href="https://gabinoc67.github.io/interstellar-star-clock/demo/mach10.html" target="_blank" rel="noopener">
    Mach 10 Panel
  </a>
</p>
        Live row-by-row playback of your Excel timeline with physics readouts.
        <b>Added instruments:</b> Cold Index, Medium Type, Coolant Flow, Stability Score.
      </div>
    </div>
    <div class="legend">
      <span class="pill">Trip length: <b id="tripLen">146 min</b></span>
      <span class="pill">Playback: <b id="spdLbl">60×</b></span>
      <span class="pill">Status: <b id="statusLbl" class="warn">Stopped</b></span>
    </div>
  </header>

  <div class="row">
    <section class="card">
      <div class="hd">
        <div class="t">Controls</div>
        <div class="pill mono">t = <span id="tNow">0.00</span> min</div>
      </div>
      <div class="bd">
        <div class="controls">
          <div class="btnrow">
            <button id="btnStart">Start</button>
            <button id="btnStop" disabled>Stop</button>
            <button id="btnReset">Reset</button>
          </div>

          <div class="stat">
            <div class="k">Playback speed (sim minutes per real second)</div>
            <input id="spd" type="range" min="1" max="240" value="60"/>
            <div class="small">1× = 1 sim minute per 1 real second. Default 60×: 146 sim minutes in ~146 seconds.</div>
          </div>

          <div class="stat">
            <div class="k">Trip progress</div>
            <div class="bar"><i id="prog"></i></div>
            <div class="small mono"><span id="progPct">0</span>% • step <span id="stepNow">—</span> • <span id="phaseNow">—</span></div>
          </div>

          <div class="split">
            <div class="stat">
              <div class="k">Mach</div>
              <div class="v"><span id="mach">0.00</span></div>
              <div class="small">Interpolated within active step.</div>
            </div>
            <div class="stat">
              <div class="k">Altitude</div>
              <div class="v"><span id="alt">0.0</span> km</div>
              <div class="small">Interpolated within active step.</div>
            </div>

            <div class="stat">
              <div class="k">Medium type</div>
              <div class="v"><span id="medium">Troposphere</span></div>
              <div class="small">Classified from altitude bands.</div>
            </div>
            <div class="stat">
              <div class="k">Cold index</div>
              <div class="v"><span id="cold">0.00</span></div>
              <div class="small">0 = warm, 1 = very cold (from ambient T).</div>
            </div>

            <div class="stat">
              <div class="k">Ambient temp</div>
              <div class="v"><span id="Tamb">288.15</span> K</div>
              <div class="small">Atmosphere interpolation by altitude.</div>
            </div>
            <div class="stat">
              <div class="k">Density</div>
              <div class="v"><span id="rho">1.2250</span> kg/m³</div>
              <div class="small">Atmosphere interpolation by altitude.</div>
            </div>

            <div class="stat">
              <div class="k">Speed</div>
              <div class="v"><span id="V">0</span> m/s</div>
              <div class="small">V = Mach · a(alt).</div>
            </div>
            <div class="stat">
              <div class="k">Dynamic pressure</div>
              <div class="v"><span id="q">0.0</span> kPa</div>
              <div class="small">q = ½ρV².</div>
            </div>

            <div class="stat">
              <div class="k">Heating proxy</div>
              <div class="v"><span id="H">0.00</span></div>
              <div class="small">Scaled from q.</div>
            </div>
            <div class="stat">
              <div class="k">Skin temperature</div>
              <div class="v"><span id="Tskin">288.15</span> K</div>
              <div class="small">Thermal ODE (heating vs cooling).</div>
            </div>

            <div class="stat">
              <div class="k">Coolant flow</div>
              <div class="v"><span id="cool">0.20</span> kg/s</div>
              <div class="small">Controller increases flow with heating & risk.</div>
            </div>
            <div class="stat">
              <div class="k">Stability score</div>
              <div class="v"><span id="stab">1.00</span></div>
              <div class="small">1.0 = stable, 0.0 = unstable (loads + heating + transitions).</div>
            </div>
          </div>

          <div class="stat">
            <div class="k">CST discipline (from row)</div>
            <div class="small" id="cstNote">—</div>
          </div>

          <div class="stat">
            <div class="k">Quick status</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
              <span class="chip"><span class="dot" id="dotTherm"></span>Thermal</span>
              <span class="chip"><span class="dot" id="dotLoad"></span>Loads</span>
              <span class="chip"><span class="dot" id="dotNav"></span>Nav/INS</span>
              <span class="chip"><span class="dot" id="dotComm"></span>Comm/Plasma</span>
            </div>
            <div class="small" id="riskTxt" style="margin-top:8px">—</div>
          </div>
        </div>
      </div>
    </section>
    <section class="card">
      <div class="hd">
        <div class="t">Explanation • Equations • Algorithm</div>
        <div class="tag">JavaScript enabled</div>
      </div>
      <div class="bd">
        <div class="small">
          The simulator plays your flight plan as a schedule. At time <span class="mono">t</span> (minutes) it finds the active row (step),
          interpolates Mach/altitude, then computes medium properties, loads, heating, cooling demand, and a stability score.
          Cold Index is derived from ambient temperature; Medium Type is altitude-banded.
        </div>

        <div style="height:10px"></div>

        <div class="eq"><b>Equations used</b>
1) Step interpolation:
   s = clamp((t - t0)/(t1 - t0), 0..1)
   Mach(t) = Mach0 + s·(Mach1 - Mach0)
   Alt(t)  = Alt0  + s·(Alt1  - Alt0)

2) Speed:
   V = Mach · a(Alt)

3) Dynamic pressure:
   q = ½ ρ(Alt) V²

4) Heating proxy:
   H = q / q_ref  (q_ref=50 kPa)

5) Cold Index (0..1):
   Cold = clamp((T_warm - Tamb)/(T_warm - T_cold), 0..1)
   where T_warm=288.15 K, T_cold=216.65 K

6) Coolant flow command (kg/s):
   m_dot = clamp(m_min + gH·H + gCold·Cold + gMach·(Mach/10), m_min..m_max)

7) Stability score (0..1):
   Stability = clamp(1 - wq·q_norm - wH·H_norm - wRamp·ramp - wBand·bandPenalty, 0..1)
   Where:
     q_norm = clamp(q / q_bad, 0..1), q_bad ≈ 120 kPa
     H_norm = clamp(H / H_bad, 0..1), H_bad ≈ 2.0
     ramp   = |dMach/dt| + 0.6|dAlt/dt| (scaled)
     bandPenalty adds during plasma/INS-heavy steps.</div>

        <div style="height:10px"></div>

        <div class="eq"><b>Medium type (altitude bands)</b>
0–12 km: Troposphere
12–50 km: Stratosphere
50–85 km: Mesosphere
85+ km: Thermosphere (not used here)</div>

        <div style="height:10px"></div>

        <div class="eq"><b>Algorithm (high level)</b>
While running:
  • advance t by (speed × real_dt_seconds)
  • identify active step
  • interpolate Mach/Alt
  • interpolate atmosphere (Tamb, rho, a)
  • compute V, q, H, Cold, Medium
  • compute coolant command and stability score
  • integrate skin temp forward
  • update panels + highlight active row
Stop at t = tripLen.</div>

        <div class="small" style="margin-top:10px">
          Tunables are inside the script (q_ref, gains, weights). This is a live “instrument cluster” matching your timeline.
        </div>
      </div>
    </section>
  </div>

  <div style="height:14px"></div>

  <section class="card">
    <div class="hd">
      <div class="t">Event Log • Row-by-row Timeline (from Excel)</div>
      <div class="pill mono">Active row highlights as the trip runs</div>
    </div>
    <div class="bd">
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Step</th>
              <th>Phase</th>
              <th>Start–End (min)</th>
              <th>Speed plan</th>
              <th>Alt band (km)</th>
              <th>Distance (km)</th>
              <th>Fuel / Mode</th>
              <th>EM</th>
              <th>Plasma</th>
              <th>INS reliance</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

</div>

<script>
/* ====== Data (from your Excel) ====== */
const TRIP_LEN_MIN = 146.0;
const STEPS = [{"step": 1, "phase": "Takeoff + initial climb", "t0": 0.0, "t1": 15.0, "mach0": 0.0, "mach1": 1.0, "alt0": 0.0, "alt1": 12.0, "speedPlan": "0 → ~Mach 1", "avgSpeed": 137.0, "distKm": 123.0, "fuelMode": "Jet fuel", "notes": "Runway to high climb", "em": "LOW (surface)", "plasma": "NONE", "ins": "LOW", "cst": "Initialize CST baseline; timestamp discipline begins at takeoff."}, {"step": 2, "phase": "Climb + accelerate to Mach 3 corridor", "t0": 15.0, "t1": 40.0, "mach0": 1.0, "mach1": 3.0, "alt0": 12.0, "alt1": 30.0, "speedPlan": "Mach 1 → Mach 3", "avgSpeed": 617.0, "distKm": 926.0, "fuelMode": "Jet fuel", "notes": "Transition into thinner air; heating begins to rise.", "em": "LOW→MOD (ionosphere begins)", "plasma": "NONE→MAYBE (at top)", "ins": "LOW→MOD", "cst": "Monitor time drift; tighten sensor-fusion timing as heating increases."}, {"step": 3, "phase": "Ramp up (controlled)", "t0": 40.0, "t1": 50.0, "mach0": 3.0, "mach1": 10.0, "alt0": 30.0, "alt1": 45.0, "speedPlan": "Mach 3 → Mach 10", "avgSpeed": 2230.0, "distKm": 1338.0, "fuelMode": "Scramjet / mixed-mode", "notes": "Peak heating window; plasma and comm risk increases.", "em": "MOD→HIGH", "plasma": "MAYBE→LIKELY", "ins": "HIGH", "cst": "Mode switch: predict blackout; increase INS weight; keep clock sync coherent."}, {"step": 4, "phase": "Mach-10 cruise window", "t0": 50.0, "t1": 60.0, "mach0": 10.0, "mach1": 10.0, "alt0": 45.0, "alt1": 55.0, "speedPlan": "Mach 10 steady", "avgSpeed": 3430.0, "distKm": 2058.0, "fuelMode": "Scramjet (steady)", "notes": "Short Mach-10 window; most sensitive to thermal/structural margins.", "em": "HIGH", "plasma": "LIKELY", "ins": "HIGH", "cst": "Hold time coherence through sensor dropouts; deterministic logging."}, {"step": 5, "phase": "Ramp down (controlled)", "t0": 60.0, "t1": 70.0, "mach0": 10.0, "mach1": 3.0, "alt0": 55.0, "alt1": 35.0, "speedPlan": "Mach 10 → Mach 3", "avgSpeed": 2230.0, "distKm": 1338.0, "fuelMode": "Scramjet → turbine/ram", "notes": "Recover comms; reduce heating; stabilize inlet margin.", "em": "HIGH→MOD", "plasma": "LIKELY→MAYBE", "ins": "HIGH→MOD", "cst": "Reacquire/re-sync clocks; smooth handoff back to comm-aided nav."}, {"step": 6, "phase": "Long midcourse at Mach 3", "t0": 70.0, "t1": 126.0, "mach0": 3.0, "mach1": 3.0, "alt0": 25.0, "alt1": 30.0, "speedPlan": "Mach 3 steady", "avgSpeed": 1000.0, "distKm": 4138.0, "fuelMode": "Ramjet / turbine", "notes": "Main distance segment; lower heating than Mach-10; optimize range.", "em": "MOD", "plasma": "MAYBE (sporadic)", "ins": "MOD", "cst": "Maintain long-term timing stability; periodic sync checks."}, {"step": 7, "phase": "Descent + landing", "t0": 126.0, "t1": 146.0, "mach0": 3.0, "mach1": 0.0, "alt0": 30.0, "alt1": 0.0, "speedPlan": "Mach 3 → 0", "avgSpeed": 450.0, "distKm": 540.0, "fuelMode": "Turbine + landing", "notes": "Thermal cooldown; return to dense air; control authority increases.", "em": "MOD→LOW", "plasma": "NONE", "ins": "LOW", "cst": "Finalize logs; compute drift summary; archive mission timeline."}];

const ATM = [{"alt_km": 0.0, "T": 288.15, "P": 101325.0, "rho": 1.225000018124288, "a": 340.293988026089}, {"alt_km": 5.0, "T": 255.64999999999998, "P": 54019.888188145786, "rho": 0.736115547399152, "a": 320.5293944425378}, {"alt_km": 10.0, "T": 223.14999999999998, "P": 26436.2425926916, "rho": 0.41270613707277716, "a": 299.46316487458036}, {"alt_km": 15.0, "T": 216.65, "P": 12044.552806598, "rho": 0.1936734512461432, "a": 295.0694935090715}, {"alt_km": 20.0, "T": 216.65, "P": 5474.9, "rho": 0.088035, "a": 295.1}, {"alt_km": 25.0, "T": 221.65, "P": 2511.0, "rho": 0.039466, "a": 298.5}, {"alt_km": 30.0, "T": 226.65, "P": 1171.9, "rho": 0.018012, "a": 301.8}, {"alt_km": 35.0, "T": 237.05, "P": 558.9, "rho": 0.008214, "a": 308.6}, {"alt_km": 40.0, "T": 251.05, "P": 277.5, "rho": 0.003851, "a": 317.6}, {"alt_km": 45.0, "T": 265.05, "P": 143.1, "rho": 0.001881, "a": 326.4}, {"alt_km": 50.0, "T": 270.65, "P": 75.9, "rho": 0.000978, "a": 329.8}, {"alt_km": 55.0, "T": 259.45, "P": 40.0, "rho": 0.000537, "a": 322.9}, {"alt_km": 60.0, "T": 245.45, "P": 20.3, "rho": 0.000288, "a": 314.1}, {"alt_km": 65.0, "T": 231.45, "P": 9.9, "rho": 0.000149, "a": 305.0}];

/* ====== Helpers ====== */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
function fmt(x, d=2) { if (!isFinite(x)) return "—"; return Number(x).toFixed(d); }
function fmtInt(x) { if (!isFinite(x)) return "—"; return String(Math.round(x)); }
function interp1(x, x0, y0, x1, y1) { if (x1===x0) return y0; const s=(x-x0)/(x1-x0); return y0+s*(y1-y0); }
function atmAt(altKm) {
  const x = clamp(altKm, ATM[0].alt_km, ATM[ATM.length-1].alt_km);
  for (let i=0;i<ATM.length-1;i++){
    const a0=ATM[i], a1=ATM[i+1];
    if (x>=a0.alt_km && x<=a1.alt_km){
      return {
        T: interp1(x,a0.alt_km,a0.T,a1.alt_km,a1.T),
        P: interp1(x,a0.alt_km,a0.P,a1.alt_km,a1.P),
        rho: interp1(x,a0.alt_km,a0.rho,a1.alt_km,a1.rho),
        a: interp1(x,a0.alt_km,a0.a,a1.alt_km,a1.a),
      };
    }
  }
  return {T:ATM[0].T,P:ATM[0].P,rho:ATM[0].rho,a:ATM[0].a};
}
function stepAt(tMin){
  for (const s of STEPS){ if (tMin>=s.t0 && tMin<s.t1) return s; }
  return STEPS[STEPS.length-1];
}
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}
function mediumType(altKm){
  if (altKm < 12) return "Troposphere";
  if (altKm < 50) return "Stratosphere";
  if (altKm < 85) return "Mesosphere";
  return "Thermosphere";
}
function coldIndex(TambK){
  const T_warm = 288.15; // ~15C
  const T_cold = 216.65; // ~-56.5C
  return clamp((T_warm - TambK)/(T_warm - T_cold), 0, 1);
}
/* ====== UI refs ====== */
const el = (id)=>document.getElementById(id);
const btnStart = el("btnStart");
const btnStop  = el("btnStop");
const btnReset = el("btnReset");
const spd = el("spd");
const spdLbl = el("spdLbl");
const statusLbl = el("statusLbl");

const tNow = el("tNow");
const prog = el("prog");
const progPct = el("progPct");
const stepNow = el("stepNow");
const phaseNow = el("phaseNow");

const machEl = el("mach");
const altEl = el("alt");
const mediumEl = el("medium");
const coldEl = el("cold");

const TambEl = el("Tamb");
const rhoEl = el("rho");
const VEl = el("V");
const qEl = el("q");
const HEl = el("H");
const TskinEl = el("Tskin");

const coolEl = el("cool");
const stabEl = el("stab");

const cstNote = el("cstNote");

const dotTherm = el("dotTherm");
const dotLoad  = el("dotLoad");
const dotNav   = el("dotNav");
const dotComm  = el("dotComm");
const riskTxt  = el("riskTxt");

const tbody = el("tbody");

/* ====== Build table ====== */
const rowEls = new Map();
function buildTable(){
  tbody.innerHTML = "";
  for (const s of STEPS){
    const tr = document.createElement("tr");
    tr.dataset.step = String(s.step);
    tr.innerHTML = `
      <td class="mono">${s.step}</td>
      <td>${escapeHtml(s.phase)}</td>
      <td class="mono">${fmt(s.t0,0)}–${fmt(s.t1,0)}</td>
      <td>${escapeHtml(s.speedPlan)}</td>
      <td class="mono">${fmt(s.alt0,0)}→${fmt(s.alt1,0)}</td>
      <td class="mono">${fmt(s.distKm,0)}</td>
      <td>${escapeHtml(s.fuelMode)}</td>
      <td>${escapeHtml(s.em)}</td>
      <td>${escapeHtml(s.plasma)}</td>
      <td>${escapeHtml(s.ins)}</td>
      <td>${escapeHtml(s.notes)}</td>
    `;
    tbody.appendChild(tr);
    rowEls.set(s.step, tr);
  }
}
buildTable();

/* ====== Simulation state ====== */
let running = false;
let tMin = 0.0;       // sim minutes
let lastTs = null;    // real ms
let Tskin = atmAt(0).T;

/* ====== Tunables (you can tweak these) ====== */
// loads/heating scaling
const q_ref_kPa = 50.0;     // heating proxy reference
const q_bad_kPa = 120.0;    // "bad" dynamic pressure for stability normalization
const H_bad = 2.0;          // "bad" heating proxy for stability normalization

// skin thermal model
const k_heat = 0.35;
const k_cool = 0.08;
const deltaHot = 50.0;

// coolant controller
const m_min = 0.20;
const m_max = 1.20;
const gH = 0.55;     // flow gain vs heating
const gCold = 0.18;  // flow gain vs cold (some systems need flow for conditioning)
const gMach = 0.15;  // flow gain vs speed

// stability weights
const wq = 0.35;
const wH = 0.35;
const wRamp = 0.20;
const wBand = 0.10;

/* ====== UI helpers ====== */
function setStatus(txt, cls){ statusLbl.textContent = txt; statusLbl.className = cls; }
function setButtons(){ btnStart.disabled = running; btnStop.disabled = !running; }
function dotColor(dotEl, level){ // level 0..1: 0 green, 0.5 amber, 1 red
  const c = (level < 0.33) ? "rgba(52,211,153,.85)" : (level < 0.66) ? "rgba(251,191,36,.85)" : "rgba(251,113,133,.85)";
  dotEl.style.background = c;
}
function highlightStep(step){
  for (const [k,tr] of rowEls.entries()){
    tr.classList.toggle("active", step===k);
  }
}
function resetAll(){
  running = false;
  lastTs = null;
  tMin = 0.0;
  Tskin = atmAt(0).T;
  setStatus("Stopped", "warn");
  setButtons();
  render();
  highlightStep(null);
}
btnStart.addEventListener("click", ()=>{
  if (tMin >= TRIP_LEN_MIN) tMin = 0;
  running = true;
  lastTs = null;
  setStatus("Running", "good");
  setButtons();
  requestAnimationFrame(loop);
});
btnStop.addEventListener("click", ()=>{
  running = false;
  lastTs = null;
  setStatus("Stopped", "warn");
  setButtons();
});
btnReset.addEventListener("click", resetAll);
spd.addEventListener("input", ()=>{ spdLbl.textContent = spd.value + "×"; });

/* ====== Derived signals ====== */
function rampMetric(step){ // ramp penalty from step endpoints (constant per step)
  const dt = Math.max(1e-9, step.t1 - step.t0); // minutes
  const dMach = Math.abs(step.mach1 - step.mach0) / dt; // per minute
  const dAlt = Math.abs(step.alt1 - step.alt0) / dt;    // km per minute
  // scale to typical ranges: Mach change of 1/min is "big"
  const rm = clamp(dMach/1.0, 0, 1);
  const ra = clamp(dAlt/2.0, 0, 1); // 2 km/min considered big
  return clamp(rm + 0.6*ra, 0, 1);
}
function bandPenalty(step){
  // convert qualitative flags into a stability penalty
  // plasma likely + INS high -> higher penalty
  let p = 0;
  const plasma = String(step.plasma||"").toUpperCase();
  const ins = String(step.ins||"").toUpperCase();
  if (plasma.includes("LIKELY")) p += 0.6;
  else if (plasma.includes("MAYBE")) p += 0.3;
  if (ins.includes("HIGH")) p += 0.5;
  else if (ins.includes("MOD")) p += 0.25;
  return clamp(p/1.2, 0, 1); // normalize
}
function coolantCommand(H, Cold, Mach){
  const cmd = m_min + gH*H + gCold*Cold + gMach*(Mach/10);
  return clamp(cmd, m_min, m_max);
}
function stabilityScore(q_kPa, H, ramp, bandPen){
  const qn = clamp(q_kPa / q_bad_kPa, 0, 1);
  const Hn = clamp(H / H_bad, 0, 1);
  const score = 1 - (wq*qn + wH*Hn + wRamp*ramp + wBand*bandPen);
  return clamp(score, 0, 1);
}
/* ====== Render ====== */
function render(){
  const s = stepAt(tMin);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((tMin - s.t0)/span, 0, 1);

  const Mach = s.mach0 + frac*(s.mach1 - s.mach0);
  const Alt  = s.alt0  + frac*(s.alt1  - s.alt0);

  const A = atmAt(Alt);
  const V = Mach * A.a;
  const q_kPa = 0.5 * A.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;

  const med = mediumType(Alt);
  const Cold = coldIndex(A.T);

  const ramp = rampMetric(s);
  const bandPen = bandPenalty(s);

  const mDot = coolantCommand(H, Cold, Mach);
  const stab = stabilityScore(q_kPa, H, ramp, bandPen);

  // UI
  tNow.textContent = fmt(tMin, 2);
  const pct = clamp((tMin/TRIP_LEN_MIN)*100, 0, 100);
  prog.style.width = pct.toFixed(1) + "%";
  progPct.textContent = pct.toFixed(0);

  stepNow.textContent = s.step;
  phaseNow.textContent = s.phase;

  machEl.textContent = fmt(Mach, 2);
  altEl.textContent = fmt(Alt, 1);

  mediumEl.textContent = med;
  coldEl.textContent = fmt(Cold, 2);

  TambEl.textContent = fmt(A.T, 2);
  rhoEl.textContent = fmt(A.rho, 4);
  VEl.textContent = fmtInt(V);
  qEl.textContent = fmt(q_kPa, 1);
  HEl.textContent = fmt(H, 2);
  TskinEl.textContent = fmt(Tskin, 2);

  coolEl.textContent = fmt(mDot, 2);
  stabEl.textContent = fmt(stab, 2);

  cstNote.textContent = s.cst || "—";

  // Risk dots & message
  const thermRisk = clamp((Tskin - A.T)/120.0, 0, 1); // heuristic
  const loadRisk  = clamp(q_kPa / q_bad_kPa, 0, 1);
  const navRisk   = bandPen; // INS heavy correlates with nav risk in this model
  const commRisk  = clamp((String(s.plasma||"").toUpperCase().includes("LIKELY") ? 1 :
                           String(s.plasma||"").toUpperCase().includes("MAYBE") ? 0.5 : 0.1), 0, 1);

  dotColor(dotTherm, thermRisk);
  dotColor(dotLoad, loadRisk);
  dotColor(dotNav, navRisk);
  dotColor(dotComm, commRisk);

  const riskParts = [];
  riskParts.push(`Medium: <span class="mono">${med}</span>`);
  riskParts.push(`ColdIndex=<span class="mono">${fmt(Cold,2)}</span>`);
  riskParts.push(`Ramp=<span class="mono">${fmt(ramp,2)}</span>`);
  riskParts.push(`BandPen=<span class="mono">${fmt(bandPen,2)}</span>`);
  riskParts.push(`Stability=<span class="mono">${fmt(stab,2)}</span>`);
  riskTxt.innerHTML = riskParts.join(" • ");

  highlightStep(s.step);
}

/* ====== Main loop ====== */
function loop(ts){
  if (!running) return;
  if (lastTs == null) lastTs = ts;
  const dtReal = (ts - lastTs) / 1000.0; // seconds
  lastTs = ts;

  const speed = Number(spd.value); // sim minutes per real second
  const dtMin = speed * dtReal;
  tMin += dtMin;

  // integrate skin temperature with current conditions
  const s = stepAt(tMin);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((tMin - s.t0)/span, 0, 1);
  const Mach = s.mach0 + frac*(s.mach1 - s.mach0);
  const Alt  = s.alt0  + frac*(s.alt1  - s.alt0);
  const A = atmAt(Alt);
  const V = Mach * A.a;
  const q_kPa = 0.5 * A.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;
  const Cold = coldIndex(A.T);

  const dtSimSec = dtMin * 60.0;

  // cooling increases with coolant command
  const mDot = coolantCommand(H, Cold, Mach);
  const coolBoost = 1 + 1.6*((mDot - m_min)/(m_max - m_min)); // 1..2.6
  const kCoolEff = k_cool * coolBoost;

  const heatTarget = A.T + deltaHot;
  const dT = (k_heat * H * (heatTarget - Tskin)) - (kCoolEff * (Tskin - A.T));
  Tskin += dT * (dtSimSec/60.0); // keep stable

  // stop at end
  if (tMin >= TRIP_LEN_MIN){
    tMin = TRIP_LEN_MIN;
    running = false;
    setStatus("Ended", "warn");
    setButtons();
  }

  render();
  if (running) requestAnimationFrame(loop);
}

/* ====== Init ====== */
function setTripLen(){
  const t = document.getElementById("tripLen");
  if (t) t.textContent = `${TRIP_LEN_MIN.toFixed(0)} min`;
}
setTripLen();
spdLbl.textContent = spd.value + "×";
resetAll();
</script>
</body>
</html>
