<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hexagon Saturation → Regulation Simulator</title>

<style>
body { margin:0; font-family:system-ui,Segoe UI,Arial; background:#0b0f14; color:#e8eef6; }
.wrap { display:grid; grid-template-columns:380px 1fr; gap:12px; padding:12px; }
.panel { background:#101823; border:1px solid #1f2c3c; border-radius:12px; padding:12px; }
.panel h2 { margin:0 0 10px; font-size:16px; }
.panel h3 { margin:10px 0 6px; font-size:14px; }
.row { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
button {
  background:#1a2a3d; color:#e8eef6; border:1px solid #2d4764;
  border-radius:10px; padding:8px 10px; cursor:pointer;
}
button:hover { background:#233a55; }
label { display:block; font-size:12px; opacity:.9; margin-top:8px; }
input[type="range"] { width:100%; }
.small { font-size:12px; opacity:.9; line-height:1.4; }
canvas { width:100%; height:calc(100vh - 24px); background:#070a0f;
border-radius:12px; border:1px solid #1f2c3c; }
.pill { display:inline-block; padding:2px 8px; border-radius:999px;
border:1px solid #2d4764; background:#0c131d; font-size:12px; }
.eq {
  font-family:ui-monospace,monospace;
  background:#0c131d; border:1px solid #1f2c3c;
  border-radius:10px; padding:8px;
}
.log {
  height:220px; overflow:auto; padding:8px;
  background:#0c131d; border:1px solid #1f2c3c;
  border-radius:10px; font-size:12px; white-space:pre-wrap;
}
.warn {
  border-left:4px solid #b68b2e;
  background:#191203;
  padding:8px;
  border-radius:8px;
}
</style>
</head>

<body>
<div class="wrap">

<!-- LEFT PANEL -->
<div class="panel">
<h2>Hexagon Saturation → Regulation</h2>

<div class="row">
<button id="add1">+ Add 1 ring</button>
<button id="step">Step</button>
<button id="reset">Reset</button>
</div>

<div class="row">
<span class="pill" id="ringsPill">Rings: 0</span>
<span class="pill" id="cellsPill">Hexes: 1</span>
<span class="pill" id="modePill">Mode: Geometry</span>
</div>

<label>Hex size: <span id="sizeVal"></span></label>
<input id="size" type="range" min="12" max="30" value="18"/>

<label>Container radius (global limit): <span id="RVal"></span></label>
<input id="R" type="range" min="160" max="420" value="240"/>

<label>Regulation strength k: <span id="kVal"></span></label>
<!-- FIXED: continuous float slider -->
<input id="k" type="range" min="0.50" max="2.50" step="0.01" value="1.96"/>

<h3>Regulation Equation</h3>
<div class="eq">
If r<sub>max</sub> ≤ R → pure geometry  
If r<sub>max</sub> &gt; R → s = (R / r<sub>max</sub>)<sup>k</sup>  

x′ = s·x  
y′ = s·y
</div>

<h3>Why 6 → 7 Does NOT Work</h3>
<div class="warn small">
<b>Local hex geometry cannot accept a 7th neighbor.</b><br><br>
A regular hexagon is defined by six equal angles (120°) and six equal edges.
Adding a 7th connection would require:
<ul>
<li>angle distortion, or</li>
<li>edge-length distortion, or</li>
<li>new orthogonal directions</li>
</ul>
<b>None are allowed.</b><br><br>
So the system does NOT become a “7-point hexagon.”  
Instead, growth triggers <b>global regulation</b>: space compresses so that
additional cells fit without altering the six-neighbor rule.
</div>

<h3>Step Log</h3>
<div class="log" id="log"></div>
</div>

<!-- CANVAS -->
<canvas id="c"></canvas>

</div>

<script>
(() => {
const dirs=[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]];
const cells=new Map(); cells.set("0,0",{q:0,r:0});
let rings=0;

const c=document.getElementById("c"),ctx=c.getContext("2d");
const sizeEl=document.getElementById("size");
const REl=document.getElementById("R");
const kEl=document.getElementById("k");
const logEl=document.getElementById("log");

function axialToPixel(q,r,s){
  return [
    s*(Math.sqrt(3)*q+Math.sqrt(3)/2*r),
    s*(3/2*r)
  ];
}
function hexRing(rad){
  if(rad===0) return [[0,0]];
  let q=dirs[4][0]*rad, r=dirs[4][1]*rad, out=[];
  for(let i=0;i<6;i++){
    for(let j=0;j<rad;j++){
      out.push([q,r]);
      q+=dirs[i][0]; r+=dirs[i][1];
    }
  }
  return out;
}
function maxRadius(size){
  let m=0;
  for(const {q,r} of cells.values()){
    const [x,y]=axialToPixel(q,r,size);
    m=Math.max(m,Math.hypot(x,y));
  }
  return m;
}
function log(t){ logEl.textContent+=t+"\n"; logEl.scrollTop=logEl.scrollHeight; }

function draw(){
  const size=+sizeEl.value,R=+REl.value,k=+kEl.value;
  document.getElementById("sizeVal").textContent=size;
  document.getElementById("RVal").textContent=R;
  document.getElementById("kVal").textContent=k.toFixed(2);

  const dpr=window.devicePixelRatio||1;
  c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,c.clientWidth,c.clientHeight);

  const cx=c.clientWidth/2, cy=c.clientHeight/2;
  ctx.strokeStyle="#3a5678"; ctx.beginPath();
  ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

  const rMax=maxRadius(size);
  const regulated=rMax>R;
  const s=regulated?Math.pow(R/rMax,k):1;

  document.getElementById("modePill").textContent=
    "Mode: "+(regulated?"Regulation":"Geometry");

  for(const {q,r} of cells.values()){
    const [x0,y0]=axialToPixel(q,r,size);
    const x=cx+s*x0,y=cy+s*y0;
    ctx.beginPath();
    for(let i=0;i<6;i++){
      const a=Math.PI/180*(60*i-30);
      const px=x+s*size*Math.cos(a);
      const py=y+s*size*Math.sin(a);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.closePath();
    ctx.fillStyle="#0d1a2a"; ctx.fill();
    ctx.strokeStyle="#456784"; ctx.stroke();
  }
}

document.getElementById("step").onclick=()=>{
  rings++;
  let added=0;
  for(const [q,r] of hexRing(rings)){
    const k=q+","+r;
    if(!cells.has(k)){ cells.set(k,{q,r}); added++; }
  }
  log(`Ring ${rings} added (${added} cells).`);
  log(`Local rule unchanged: every interior cell still has exactly 6 neighbors.`);
  log(`Any extra capacity is handled by global compression, not new geometry.`);
  log("—");
  draw();
};

document.getElementById("add1").onclick=()=>document.getElementById("step").click();
document.getElementById("reset").onclick=()=>{
  cells.clear(); cells.set("0,0",{q:0,r:0}); rings=0;
  logEl.textContent="RESET\n—\n"; draw();
};

[sizeEl,REl,kEl].forEach(e=>e.oninput=draw);
draw();
})();
</script>
</body>
</html>
