<!-- ======================= PART 1 / 3 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SPR-C — Sentinel Robot (Dyson Sphere Memory Toggle)</title>
<meta name="description" content="SPR-C demo with Dyson Sphere global boundary toggle: compare open vs closed memory. Adds global memory vault, coherence budget meter, routine locks (24/7), less noise under Dyson mode, and visible accounting of memory writes/evictions. Includes multi-flip measurement stats for a quantum-style presentation (stochastic, not physical quantum)." />
<style>
  :root{
    --bg:#0b1020;--panel:#0f1530;--ink:#eaf0ff;--muted:#a8b2d8;--accent:#90b4ff;
    --good:#3de6a0;--bad:#ff6b88;--left:#7aa2ff;--right:#ffd37a;--border:#1d2a52;
    --core:#8ef0d4;--train:#bfe27f;--error:#ff8aa6;--pos:#2fe6a0;--neg:#ff6b88;
    --moodP:#6ee7ff;--moodN:#ffb86b;--wire:#b9c6ff;
    --dyson:#b48bff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:1220px;margin:0 auto;padding:16px}
  h1{margin:.2rem 0 .4rem;font-size:28px}
  .grid{display:grid;grid-template-columns:1.12fr .88fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .card>header{padding:12px 14px;border-bottom:1px solid var(--border)}
  .card>header h2{margin:0;font-size:16px;color:var(--muted)}
  .card .body{padding:12px 14px}

  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .legend span{display:inline-flex;align-items:center;gap:8px;background:#0b1330;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.left{background:var(--left)}
  .dot.right{background:var(--right)}
  .dot.gateY{background:var(--good)}
  .dot.gateN{background:var(--bad)}
  .dot.dyson{background:var(--dyson)}

  .pillbar{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#0b1330;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}

  .diagram{position:relative;height:760px;border-radius:14px;overflow:hidden;background:radial-gradient(1200px 740px at 50% 50%, rgba(126,224,255,0.06), transparent 60%)}
  svg{position:absolute;inset:0}

  .label{position:absolute;font-size:12px;color:var(--muted);background:#0b1330;padding:4px 6px;border:1px solid var(--border);border-radius:8px;pointer-events:none}
  .label.hl{color:var(--ink)}
  .finalText{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;font-weight:800;font-size:14px;color:#dfffe9}

  .console{height:240px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;line-height:1.5}
  .console .ts{color:#8aa0c8}
  .console .ai{color:#d0e2ff}
  .console .meta{color:#9bd2ff}
  .console .warn{color:#ffd37a}
  .console .ok{color:#b7ffda}

  .panels{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .panel{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:86px}
  .panel h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .panel ul{margin:0;padding-left:16px}
  .panel li{font-size:12px;color:var(--ink)}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#0e1540;color:var(--ink);padding:10px;border-radius:10px;cursor:pointer;font-size:13px}
  .btn:hover{background:#101b56}

  .toggle{
    display:flex;align-items:center;gap:10px;
    background:#0e1540;border:1px solid var(--border);border-radius:12px;padding:10px;
  }
  .toggle b{color:var(--ink);font-size:13px}
  .toggle small{display:block;color:var(--muted);font-size:11px;margin-top:2px}
  .switch{
    width:54px;height:30px;border-radius:999px;position:relative;flex:0 0 auto;
    background:#1a2450;border:1px solid var(--border);cursor:pointer;
  }
  .switch::after{
    content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
    background:#9aa7d6; transition:transform .18s ease, background .18s ease;
  }
  .switch.on{background:rgba(180,139,255,.22); border-color:rgba(180,139,255,.5)}
  .switch.on::after{transform:translateX(24px); background:var(--dyson)}

  .meter{
    display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-top:10px;
    background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px;
  }
  .bar{
    height:10px;border-radius:999px;background:#1a2450;border:1px solid var(--border);overflow:hidden;
  }
  .fill{height:100%;width:50%;background:var(--dyson)}
  .meter .val{font-family:ui-monospace, Menlo, Consolas, monospace;font-size:12px;color:var(--muted)}
  .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .stat{
    background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px;
  }
  .stat .k{font-size:12px;color:var(--muted)}
  .stat .v{font-family:ui-monospace, Menlo, Consolas, monospace;font-size:14px;color:var(--ink);margin-top:4px}

  .scenarios{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .scenarios button{border:1px solid var(--border);background:#0e1540;color:var(--ink);padding:10px;border-radius:10px;cursor:pointer;font-size:13px}
  .scenarios button:hover{background:#101b56}
  .scenarios button.active{outline:2px solid var(--accent)}

  .blink6{animation:blink .45s linear 6}
  @keyframes blink{50%{opacity:.35}}

  .wire{stroke-width:3.8;filter:drop-shadow(0 0 10px #a8d)}
  .wirePulse{stroke-dasharray:6 6; animation:dash 1.1s linear infinite}
  @keyframes dash{to{stroke-dashoffset:-24}}

  .dysonRing{stroke:rgba(180,139,255,.75);stroke-width:5;fill:none;filter:drop-shadow(0 0 12px rgba(180,139,255,.45))}
  .dysonRing.off{opacity:.10;filter:none}
  .dysonText{fill:rgba(180,139,255,.9);font-size:12px}

  /* --- NEW: Quantum-style Measurement Controls + Stats (stochastic sampling) --- */
  .qbox{
    margin-top:10px;
    background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px;
  }
  .qbox h3{margin:0 0 8px;font-size:13px;color:var(--muted)}
  .qrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .seg{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{
    border:1px solid var(--border);
    background:#0e1540;
    color:var(--ink);
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:12px;
  }
  .chip.active{outline:2px solid var(--accent)}
  .sliderWrap{display:flex;gap:10px;align-items:center;flex:1 1 auto;min-width:240px}
  input[type="range"]{width:100%}
  .qstatGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .qstat{background:#0e1540;border:1px solid var(--border);border-radius:12px;padding:10px}
  .qstat .k{font-size:12px;color:var(--muted)}
  .qstat .v{font-family:ui-monospace, Menlo, Consolas, monospace;font-size:14px;color:var(--ink);margin-top:4px}
  .stability{margin-top:10px;background:#0e1540;border:1px solid var(--border);border-radius:12px;padding:10px}
  .stability .k{font-size:12px;color:var(--muted)}
  .stability .bar{margin-top:8px;height:10px}
  .stability .fill{background:var(--accent)}
  .fineprint{margin-top:8px;color:var(--muted);font-size:11px;line-height:1.35}

  /* presentation text */
  .talkTrack b{color:var(--ink)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>SPR-C — Sentinel Robot (Waves • Voltages • Heartbeats) + Dyson Sphere Memory</h1>

    <div class="pillbar">
      <span class="pill">Particles: ALWAYS moving (independent bounce)</span>
      <span class="pill">Signal: Cores → Pos/Neg → Mood(±) → Final</span>
      <span class="pill"><i class="dot dyson"></i> Dyson Sphere Toggle: Open vs Closed Global Memory</span>
      <span class="pill">Measurement: 1 / 2 / N flips (stochastic sampling)</span>
    </div>

    <div class="grid" style="margin-top:12px">
      <!-- LEFT: Diagram -->
      <section class="card">
        <header>
          <h2>Diagram — connections, waves, decision, and Dyson boundary</h2>
          <div class="legend">
            <span><i class="dot left"></i>Left particles</span>
            <span><i class="dot right"></i>Right particles</span>
            <span><i class="dot gateY"></i>YES</span>
            <span><i class="dot gateN"></i>NO</span>
            <span><i class="dot dyson"></i>Dyson boundary</span>
          </div>
        </header>
        <div class="body">
          <div class="diagram" id="diagram">
            <div class="label" style="left:24px;top:14px">Left Hemisphere (− logic)</div>
            <div class="label" style="right:24px;top:14px">Right Hemisphere (+ creative)</div>
            <div class="label hl" style="left:50%;transform:translateX(-50%);top:14px">Entanglement Bridge</div>
            <div class="label" style="left:50%;transform:translateX(-50%);bottom:292px">Cores & Memory Squares</div>
            <div class="label" style="left:335px;bottom:194px">Positive</div>
            <div class="label" style="right:335px;bottom:194px">Negative</div>
            <div class="label" style="left:335px;bottom:146px">Mood (+)</div>
            <div class="label" style="right:335px;bottom:146px">Mood (−)</div>
            <div class="label" style="left:50%;transform:translateX(-50%);bottom:28px">Final Ethical Gate</div>
            <div class="finalText" id="finalText">Decision pending…</div>

            <svg id="stage" viewBox="0 0 1200 760" preserveAspectRatio="none">
              <defs>
                <linearGradient id="gradL" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#1a2450"/>
                  <stop offset="100%" stop-color="#0c1130"/>
                </linearGradient>
                <linearGradient id="gradR" x1="100%" y1="0" x2="0" y2="0%">
                  <stop offset="0%" stop-color="#4a3a10"/>
                  <stop offset="100%" stop-color="#0c1130"/>
                </linearGradient>
                <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="3" result="blur" />
                  <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="3.5" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L8,3.5 L0,7 z" fill="var(--wire)"></path>
                </marker>
              </defs>

              <rect x="0" y="0" width="600" height="760" fill="url(#gradL)" opacity="0.35" />
              <rect x="600" y="0" width="600" height="760" fill="url(#gradR)" opacity="0.35" />

              <circle id="dysonRing" class="dysonRing" cx="600" cy="380" r="344" opacity="0.95"></circle>
              <text id="dysonLabel" class="dysonText" x="600" y="44" text-anchor="middle">Dyson Sphere Boundary: CLOSED (global memory conserved)</text>

              <rect id="bridge" x="585" y="64" width="30" height="272" rx="10" fill="#7ee0ff" opacity="0.35" />

              <circle id="coreNormal" cx="600" cy="340" r="26" fill="var(--core)" opacity="0.95" filter="url(#softGlow)" />
              <text x="600" y="345" text-anchor="middle" font-size="11" fill="#061018">Normal</text>
              <circle id="coreTrain" cx="540" cy="388" r="22" fill="var(--train)" opacity="0.95" filter="url(#softGlow)" />
              <text x="540" y="393" text-anchor="middle" font-size="11" fill="#061018">Train</text>
              <circle id="coreError" cx="660" cy="388" r="22" fill="var(--error)" opacity="0.95" filter="url(#softGlow)" />
              <text x="660" y="393" text-anchor="middle" font-size="11" fill="#061018">Error</text>

              <rect id="posMem" x="320" y="420" width="190" height="56" rx="8" fill="#103522" stroke="#2fe6a0" stroke-width="2" opacity="0.95" />
              <rect id="negMem" x="690" y="420" width="190" height="56" rx="8" fill="#3a0f18" stroke="#ff6b88" stroke-width="2" opacity="0.95" />

              <rect id="moodPos" x="320" y="480" width="190" height="46" rx="8" fill="#0d2a38" stroke="#6ee7ff" stroke-width="2" opacity="0.95" />
              <rect id="moodNeg" x="690" y="480" width="190" height="46" rx="8" fill="#321b06" stroke="#ffb86b" stroke-width="2" opacity="0.95" />

              <path id="wireNtoPos" d="M600,366 L600,420" stroke="#8ef0d4" class="wire wirePulse" marker-end="url(#arrow)" />
              <path id="wireTtoPos" d="M540,412 L420,420" stroke="#bfe27f" class="wire wirePulse" marker-end="url(#arrow)" />
              <path id="wireEtoNeg" d="M660,412 L780,420" stroke="#ff8aa6" class="wire wirePulse" marker-end="url(#arrow)" />

              <path id="wirePosToMood" d="M415,476 L415,480" stroke="#2fe6a0" class="wire wirePulse" marker-end="url(#arrow)" />
              <path id="wireNegToMood" d="M765,476 L765,480" stroke="#ff6b88" class="wire wirePulse" marker-end="url(#arrow)" />

              <path id="wireMoodToFinal" d="M600,526 L600,640" stroke="#9bd2ff" class="wire wirePulse" marker-end="url(#arrow)" />

              <circle id="gateYes" cx="560" cy="652" r="12" fill="var(--good)" opacity="0.25" />
              <text x="560" y="670" text-anchor="middle" font-size="11" fill="#c9f7e6">YES</text>
              <circle id="gateNo" cx="640" cy="652" r="12" fill="var(--bad)" opacity="0.25" />
              <text x="640" y="670" text-anchor="middle" font-size="11" fill="#ffd5dd">NO</text>

              <path id="waveCores" d="" stroke="#8ef0d4" stroke-width="2" fill="none" opacity="0.8" />
              <path id="wavePos" d="" stroke="#2fe6a0" stroke-width="2.2" fill="none" opacity="0.85" />
              <path id="waveNeg" d="" stroke="#ff6b88" stroke-width="2.2" fill="none" opacity="0.85" />
              <path id="waveMoodPos" d="" stroke="#6ee7ff" stroke-width="2.2" fill="none" opacity="0.9" />
              <path id="waveMoodNeg" d="" stroke="#ffb86b" stroke-width="2.2" fill="none" opacity="0.9" />

              <g id="leftParticles"></g>
              <g id="rightParticles"></g>
            </svg>
          </div>
        </div>
      </section>

      <!-- RIGHT: Console + controls -->
      <section class="card">
        <header><h2>SPR-C Autonomous Console + Global Memory Vault</h2></header>
        <div class="body">
          <div class="row">
            <div class="toggle" title="Dyson Sphere = global boundary: memory is conserved and accounted for. OFF = open system: memory decays and is noisier.">
              <div class="switch on" id="dysonSwitch" role="switch" aria-checked="true" tabindex="0"></div>
              <div>
                <b>Dyson Sphere Mode</b>
                <small id="dysonModeText">ON — Closed global boundary (stable 24/7 routines)</small>
              </div>
            </div>
            <button class="btn" id="resetBtn">Reset (keep vault)</button>
            <button class="btn" id="hardResetBtn" title="Also clears the global vault.">Hard Reset (clear vault)</button>
          </div>

          <div class="qbox" id="qbox">
            <h3>Quantum-Style Measurement (Stochastic Sampling, not physical quantum)</h3>
            <div class="qrow">
              <div class="seg" aria-label="Flip mode">
                <button class="chip active" id="mode1">1 flip</button>
                <button class="chip" id="mode2">2 flips</button>
                <button class="chip" id="modeN">N flips</button>
              </div>
              <div class="sliderWrap" title="Used when N flips mode is active">
                <span style="font-size:12px;color:var(--muted)">N</span>
                <input id="nSlider" type="range" min="10" max="200" step="10" value="50" />
                <span class="pill" id="nReadout">50</span>
              </div>
            </div>

            <div class="qstatGrid">
              <div class="qstat">
                <div class="k">Counts (YES / NO)</div>
                <div class="v" id="countText">—</div>
              </div>
              <div class="qstat">
                <div class="k">Estimated P(YES)</div>
                <div class="v" id="phatText">—</div>
              </div>
            </div>

            <div class="stability">
              <div class="k">Stability Meter (variance shrinking)</div>
              <div class="bar"><div class="fill" id="stabFill" style="width:0%"></div></div>
              <div class="val" style="margin-top:6px" id="stabText">—</div>
              <div class="fineprint talkTrack" id="talkTrack">
                <b>Presentation line (safe + strong):</b><br/>
                “We don’t claim physical quantum states here. We use <b>stochastic sampling</b> to model uncertainty, and we use <b>repeated trials</b> to show how confidence emerges with evidence. One flip is a single draw; many flips show the distribution, just like repeated measurements in experiments.”
              </div>
            </div>
          </div>

          <div class="meter" style="margin-top:10px">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="color:var(--muted);font-size:12px">Global Coherence Budget (Vault)</div>
                <div class="val" id="budgetText">—</div>
              </div>
              <div class="bar"><div class="fill" id="budgetFill" style="width:50%"></div></div>
              <div style="margin-top:8px;color:var(--muted);font-size:11px" id="budgetHint">
                Dyson ON: writes are conserved; evictions are logged; routines stay locked.
              </div>
            </div>
            <div class="val" style="text-align:right">
              <div>Noise: <span id="noiseText">low</span></div>
              <div>Leak: <span id="leakText">near-zero</span></div>
            </div>
          </div>

          <div class="subgrid">
            <div class="stat">
              <div class="k">Routine Locks (24/7)</div>
              <div class="v" id="routineText">—</div>
            </div>
            <div class="stat">
              <div class="k">Vault State</div>
              <div class="v" id="vaultText">—</div>
            </div>
          </div>

          <div class="console" id="console" aria-live="polite" style="margin-top:10px"></div>

          <div class="panels">
            <div class="panel">
              <h3>Signals & Memory</h3>
              <ul id="coreList"><li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li></ul>
            </div>
            <div class="panel">
              <h3>Gate Outcomes</h3>
              <ul id="gateList"><li>Flip sequence will appear here…</li></ul>
            </div>
          </div>

          <div class="scenarios" id="scenarios"></div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  const leftG = document.getElementById('leftParticles');
  const rightG = document.getElementById('rightParticles');
  const bridge = document.getElementById('bridge');

  const coreN = document.getElementById('coreNormal');
  const coreT = document.getElementById('coreTrain');
  const coreE = document.getElementById('coreError');

  const posMem = document.getElementById('posMem');
  const negMem = document.getElementById('negMem');
  const moodPos = document.getElementById('moodPos');
  const moodNeg = document.getElementById('moodNeg');

  const gateYes = document.getElementById('gateYes');
  const gateNo = document.getElementById('gateNo');
  const finalText = document.getElementById('finalText');

  const waveCores = document.getElementById('waveCores');
  const wavePos = document.getElementById('wavePos');
  const waveNeg = document.getElementById('waveNeg');
  const waveMoodPos = document.getElementById('waveMoodPos');
  const waveMoodNeg = document.getElementById('waveMoodNeg');

  const dysonRing = document.getElementById('dysonRing');
  const dysonLabel = document.getElementById('dysonLabel');

  const consoleEl = document.getElementById('console');
  const scenariosEl = document.getElementById('scenarios');
  const coreList = document.getElementById('coreList');
  const gateList = document.getElementById('gateList');

  const resetBtn = document.getElementById('resetBtn');
  const hardResetBtn = document.getElementById('hardResetBtn');

  const dysonSwitch = document.getElementById('dysonSwitch');
  const dysonModeText = document.getElementById('dysonModeText');

  const budgetFill = document.getElementById('budgetFill');
  const budgetText = document.getElementById('budgetText');
  const budgetHint = document.getElementById('budgetHint');
  const noiseText = document.getElementById('noiseText');
  const leakText = document.getElementById('leakText');

  const routineText = document.getElementById('routineText');
  const vaultText = document.getElementById('vaultText');

  // Measurement UI
  const mode1Btn = document.getElementById('mode1');
  const mode2Btn = document.getElementById('mode2');
  const modeNBtn = document.getElementById('modeN');
  const nSlider  = document.getElementById('nSlider');
  const nReadout = document.getElementById('nReadout');

  const countText = document.getElementById('countText');
  const phatText  = document.getElementById('phatText');
  const stabFill  = document.getElementById('stabFill');
  const stabText  = document.getElementById('stabText');

  function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}
  function rand(a,b){return Math.random()*(b-a)+a}
  function clamp(x,a,b){return Math.max(a, Math.min(b,x))}
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
  function fmt(n){return (Math.round(n*100)/100).toFixed(2)}
  function pct(n){return (Math.round(n*1000)/10).toFixed(1)+'%'}

  function log(lines, cls='ai'){
    const time=new Date().toLocaleTimeString();
    (Array.isArray(lines)?lines:[lines]).forEach(ln=>{
      const row=document.createElement('div');
      row.innerHTML=`<span class="ts">[${time}] </span><span class="${cls}">${ln}</span>`;
      consoleEl.appendChild(row);
    });
    consoleEl.scrollTop=consoleEl.scrollHeight;
  }

  function blink(el){ el.classList.remove('blink6'); void el.offsetWidth; el.classList.add('blink6'); }
  function lamp(on,off){ on.setAttribute('opacity','1'); off.setAttribute('opacity','0.25'); blink(on); }
  function resetVisual(){
    [posMem,negMem,moodPos,moodNeg,gateYes,gateNo,coreN,coreT,coreE].forEach(e=>e.classList.remove('blink6'));
    gateYes.setAttribute('opacity','.25');
    gateNo.setAttribute('opacity','.25');
    finalText.textContent='Decision pending…';
    coreList.innerHTML='';
    gateList.innerHTML='';
  }

  const VAULT = {
    dysonOn: true,
    budget: 0.55,
    routines: {
      heartbeat: {locked:true, strength:0.80},
      standby:   {locked:true, strength:0.78},
      balance:   {locked:true, strength:0.76},
      safety:    {locked:true, strength:0.74},
    },
    totals: {
      runs: 0,
      yes: 0,
      no: 0,
      writes: 0,
      evictions: 0,
      resetsAvoided: 0,
      confusion: 0,
    },
    bias: {
      prosocial: 0.00,
      caution:   0.00,
      discipline:0.00,
    },
    memory: new Map(),
  };

  function currentParams(){
    if(VAULT.dysonOn){
      return { leak:0.010, noise:0.10, consolidate:0.18, protectRoutines:true, budgetGain:0.06, budgetCost:0.03 };
    }
    return { leak:0.085, noise:0.28, consolidate:0.06, protectRoutines:false, budgetGain:0.02, budgetCost:0.06 };
  }

  function updateDysonUI(){
    const on = VAULT.dysonOn;
    dysonSwitch.classList.toggle('on', on);
    dysonSwitch.setAttribute('aria-checked', String(on));

    dysonRing.classList.toggle('off', !on);
    dysonRing.setAttribute('opacity', on ? '0.95' : '0.18');

    dysonLabel.textContent = on
      ? 'Dyson Sphere Boundary: CLOSED (global memory conserved)'
      : 'Dyson Sphere Boundary: OPEN (memory leaks + more noise)';

    dysonModeText.textContent = on
      ? 'ON — Closed global boundary (stable 24/7 routines)'
      : 'OFF — Open system (leak + resets + retraining)';

    budgetHint.textContent = on
      ? 'Dyson ON: writes are conserved; evictions are logged; routines stay locked.'
      : 'Dyson OFF: memory decays; evictions are silent; routines can drift (more resets).';

    const p = currentParams();
    noiseText.textContent = p.noise < 0.15 ? 'low' : (p.noise < 0.25 ? 'medium' : 'high');
    leakText.textContent = p.leak < 0.02 ? 'near-zero' : (p.leak < 0.06 ? 'medium' : 'high');

    dysonRing.style.stroke = on ? 'rgba(180,139,255,.75)' : 'rgba(180,139,255,.30)';
  }

  function renderVaultStats(){
    const b = clamp(VAULT.budget, 0, 1);
    budgetFill.style.width = Math.round(b*100) + '%';
    budgetText.textContent = `${Math.round(b*100)}%`;

    const r = VAULT.routines;
    routineText.textContent =
      `HB:${r.heartbeat.locked?'LOCK':'DRIFT'} `+
      `STBY:${r.standby.locked?'LOCK':'DRIFT'} `+
      `BAL:${r.balance.locked?'LOCK':'DRIFT'} `+
      `SAFE:${r.safety.locked?'LOCK':'DRIFT'}`;

    vaultText.textContent =
      `runs=${VAULT.totals.runs} `+
      `writes=${VAULT.totals.writes} `+
      `evict=${VAULT.totals.evictions} `+
      `conf=${VAULT.totals.confusion}`;
  }

  function toggleDyson(){
    VAULT.dysonOn = !VAULT.dysonOn;
    updateDysonUI();
    renderVaultStats();
    log(`Dyson Sphere toggle → ${VAULT.dysonOn ? 'ON (closed global memory)' : 'OFF (open/leaky memory)'}`, 'meta');
  }

  dysonSwitch.addEventListener('click', toggleDyson);
  dysonSwitch.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); toggleDyson(); }
  });

  const COUNT = 120;
  function mkCircle(x,y,r,fill){
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',x); c.setAttribute('cy',y);
    c.setAttribute('r',r); c.setAttribute('fill',fill);
    c.setAttribute('opacity',.9);
    return c;
  }

  const L=[], R=[];
  for(let i=0;i<COUNT;i++){
    const cL=mkCircle(rand(30,580), rand(50,740), rand(2.1,3.8), css('--left'));
    leftG.appendChild(cL);
    L.push({el:cL, vx:rand(-.55,.55), vy:rand(-.55,.55)});
    const cR=mkCircle(rand(620,1170), rand(50,740), rand(2.1,3.8), css('--right'));
    rightG.appendChild(cR);
    R.push({el:cR, vx:rand(-.55,.55), vy:rand(-.55,.55)});
  }

  function sinePath(x0,y0,w,h,phase,period,points=120){
    let d=`M ${x0} ${y0}`; const step=w/points;
    for(let i=0;i<=points;i++){
      const x=x0+i*step; const t=(i/points)*period + phase;
      const y=y0 + Math.sin(t*2*Math.PI)*h;
      d+=` L ${x.toFixed(2)} ${y.toFixed(2)}`;
    }
    return d;
  }

  let freqPos=1.6, freqNeg=0.8;
  let t=0;

  (function animate(){
    t+=0.008;
    const now=performance.now();
    bridge.setAttribute('opacity',0.35+0.12*Math.sin(now/900));
    const ringPulse = VAULT.dysonOn ? (0.78 + 0.16*Math.sin(now/1100)) : (0.16 + 0.05*Math.sin(now/800));
    dysonRing.setAttribute('opacity', ringPulse.toFixed(3));

    const upd=(p,side)=>{
      const el=p.el; const cx=+el.getAttribute('cx'), cy=+el.getAttribute('cy');
      const spd = VAULT.dysonOn ? 0.48 : 0.56;
      let nx=cx+p.vx*spd, ny=cy+p.vy*spd;
      const minX=side==='L'?20:620, maxX=side==='L'?580:1180;
      if(nx<minX||nx>maxX) p.vx*=-1;
      if(ny<40||ny>740) p.vy*=-1;
      el.setAttribute('cx', cx+p.vx*spd);
      el.setAttribute('cy', cy+p.vy*spd);
    };
    L.forEach(p=>upd(p,'L')); R.forEach(p=>upd(p,'R'));

    waveCores.setAttribute('d', sinePath(360,404,480,6,t,1.2));
    wavePos.setAttribute('d', sinePath(320,488,190,10,t*1.4,1.4));
    waveNeg.setAttribute('d', sinePath(690,488,190,10,t*1.4+0.4,1.4));
    waveMoodPos.setAttribute('d', sinePath(320,548,190,12,t*freqPos, freqPos));
    waveMoodNeg.setAttribute('d', sinePath(690,548,190,12,t*freqNeg, freqNeg));

    requestAnimationFrame(animate);
  })();
<!-- ======================= PART 2 / 3 ======================= -->
  function applyLeak(){
    const p = currentParams();
    const leak = p.leak;
    VAULT.bias.prosocial  *= (1 - leak);
    VAULT.bias.caution    *= (1 - leak);
    VAULT.bias.discipline *= (1 - leak);

    for(const [k,v] of VAULT.memory.entries()){
      v.confidence *= (1 - leak);
      if(!VAULT.dysonOn && v.confidence < 0.15){
        VAULT.memory.delete(k);
      }
    }
  }

  function routineDriftIfOpen(){
    if(VAULT.dysonOn) return;
    const driftChance = 0.12;
    const keys = Object.keys(VAULT.routines);
    if(Math.random() < driftChance){
      const k = pick(keys);
      VAULT.routines[k].locked = false;
      VAULT.routines[k].strength = clamp(VAULT.routines[k].strength - 0.10, 0.40, 0.95);
      VAULT.totals.confusion++;
      log(`Open system drift: routine "${k}" slipped (more static/noise).`, 'warn');
    }else{
      keys.forEach(kk=>{
        VAULT.routines[kk].strength = clamp(VAULT.routines[kk].strength + 0.02, 0.40, 0.95);
        if(VAULT.routines[kk].strength > 0.72) VAULT.routines[kk].locked = true;
      });
    }
  }

  function budgetUpdate(consumed){
    const p = currentParams();
    VAULT.budget = clamp(
      VAULT.budget + p.budgetGain*(consumed.stable?1:0) - p.budgetCost*(consumed.cost||0),
      0, 1
    );
  }

  // ============================================================
  // Measurement engine (1 flip / 2 flips / N flips)
  // ============================================================
  const MEASURE = {
    mode: '1',
    N: 50,
    last: {yes:0, no:0, phat:0.0, se:0.0, stability:0.0}
  };

  function setMode(m){
    MEASURE.mode = m;
    mode1Btn.classList.toggle('active', m==='1');
    mode2Btn.classList.toggle('active', m==='2');
    modeNBtn.classList.toggle('active', m==='N');
    renderMeasureStats(MEASURE.last);
    log(`Measurement mode → ${m==='1'?'1 flip':(m==='2'?'2 flips':'N flips')} (stochastic sampling)`, 'meta');
  }

  function setN(val){
    MEASURE.N = val;
    nReadout.textContent = String(val);
    if(MEASURE.mode==='N'){
      log(`N updated → ${val} trials per decision (distribution view)`, 'meta');
    }
  }

  mode1Btn.addEventListener('click',()=>setMode('1'));
  mode2Btn.addEventListener('click',()=>setMode('2'));
  modeNBtn.addEventListener('click',()=>setMode('N'));
  nSlider.addEventListener('input',()=>setN(parseInt(nSlider.value,10)));

  function renderMeasureStats(s){
    const yes = s?.yes ?? 0;
    const no  = s?.no  ?? 0;
    const ph  = s?.phat ?? 0;
    const se  = s?.se ?? 0;
    const stab = s?.stability ?? 0;

    countText.textContent = `${yes} / ${no}`;
    phatText.textContent  = `${pct(ph)}  (p̂)`;

    const w = Math.round(clamp(stab,0,1)*100);
    stabFill.style.width = w + '%';

    stabText.textContent = (yes+no>0)
      ? `σ≈${pct(se)} | stability=${w}% | mode=${MEASURE.mode==='1'?'1':(MEASURE.mode==='2'?'2':`N=${MEASURE.N}`)}`
      : '—';
  }

  function stdErr(phat, n){
    if(n<=0) return 0;
    return Math.sqrt((phat*(1-phat))/n);
  }

  function flipYES(pYes){
    return Math.random() < pYes;
  }

  function sampleN(pYes, N){
    let yes=0;
    for(let i=0;i<N;i++) if(flipYES(pYes)) yes++;
    const no = N - yes;
    const ph = yes / Math.max(1,N);
    const se = stdErr(ph, N);
    const stability = clamp(1 - (se/0.25), 0, 1);
    MEASURE.last = {yes, no, phat: ph, se, stability};
    renderMeasureStats(MEASURE.last);
    return yes >= (N/2);
  }

  function sampleDecision(pYes){
    if(MEASURE.mode==='1'){
      const YES = flipYES(pYes);
      const yes = YES ? 1 : 0, no = YES ? 0 : 1;
      const ph = yes;
      const se = stdErr(ph, 1);
      const stability = clamp(1 - (se/0.25), 0, 1);
      MEASURE.last = {yes, no, phat: ph, se, stability};
      renderMeasureStats(MEASURE.last);
      return YES;
    }
    if(MEASURE.mode==='2'){
      const a = flipYES(pYes);
      const b = flipYES(pYes);
      let yes = (a?1:0) + (b?1:0);
      let no = 2 - yes;
      const ph = yes/2;
      const se = stdErr(ph, 2);
      const stability = clamp(1 - (se/0.25), 0, 1);
      MEASURE.last = {yes, no, phat: ph, se, stability};
      renderMeasureStats(MEASURE.last);

      if(a===b) return a;
      return flipYES(pYes); // tie-break
    }
    return sampleN(pYes, MEASURE.N);
  }

  // ============================================================
  // Vault decision logic (unchanged) + sampling hook
  // ============================================================
  function decideWithVault(baseYesProb, scenarioKey, tags){
    const p = currentParams();

    const noise = p.noise * (1 - 0.55*clamp(VAULT.bias.discipline, -1, 1));

    const mem = VAULT.memory.get(scenarioKey);
    let memBias = 0;
    if(mem && mem.confidence > 0.20){
      memBias = (mem.lastDecision === 'YES' ? +0.10 : -0.10) * clamp(mem.confidence, 0, 1);
    }

    let bias = 0.0;
    bias += VAULT.bias.prosocial * (tags.helpful ? 0.18 : 0.06);
    bias -= VAULT.bias.caution   * (tags.risky   ? 0.18 : 0.06);

    const dysonGain = VAULT.dysonOn ? 1.15 : 0.85;

    let yesProb = baseYesProb
      + dysonGain*bias
      + memBias
      + (Math.random()-0.5)*noise;

    yesProb = clamp(yesProb, 0.02, 0.98);

    const YES = sampleDecision(yesProb);
    return {YES, yesProb, noise, mem};
  }

  function consolidateMemory(scenarioKey, decision, tags){
    const p = currentParams();
    const writeCost = 0.20;

    const prev = VAULT.memory.get(scenarioKey) || {seen:0, lastDecision:'NO', confidence:0.20};
    prev.seen += 1;

    const gain = p.consolidate * (tags.helpful || tags.risky ? 1.2 : 1.0);
    prev.confidence = clamp(prev.confidence + gain, 0.15, 1.0);
    prev.lastDecision = decision;

    VAULT.memory.set(scenarioKey, prev);
    VAULT.totals.writes++;

    budgetUpdate({stable: prev.confidence > 0.55, cost: writeCost});

    if(VAULT.budget < 0.18 && VAULT.memory.size > 4){
      let worstKey=null, worst=Infinity;
      for(const [k,v] of VAULT.memory.entries()){
        if(v.confidence < worst){ worst=v.confidence; worstKey=k; }
      }
      if(worstKey){
        VAULT.memory.delete(worstKey);
        VAULT.totals.evictions++;
        if(VAULT.dysonOn){
          log(`Dyson accounting: eviction logged → "${worstKey}" (budget low).`, 'warn');
        }else{
          log(`Open system: memory dropped silently (static/noise rises).`, 'warn');
        }
        budgetUpdate({stable:false, cost:0.25});
      }
    }
  }

  function learnBiasFromOutcome(tags, decision){
    const p = currentParams();
    VAULT.bias.discipline = clamp(VAULT.bias.discipline + (VAULT.dysonOn ? 0.03 : 0.01), 0, 1);

    if(tags.helpful){
      VAULT.bias.prosocial = clamp(VAULT.bias.prosocial + (decision==='YES'? +0.03 : -0.015)*p.consolidate, -1, 1);
    }
    if(tags.risky){
      VAULT.bias.caution = clamp(VAULT.bias.caution + (decision==='NO'? +0.03 : -0.015)*p.consolidate, -1, 1);
    }
  }

  function stageTrainOrError(){
    const trainBoost = VAULT.dysonOn ? 0.08*VAULT.bias.discipline : 0.0;
    const trainWins = (Math.random() < (0.5 + trainBoost));

    if(trainWins){
      blink(coreT); blink(posMem);
      coreList.insertAdjacentHTML('beforeend','<li>Train wins → Positive memory engaged (voltage ↑)</li>');
      gateList.insertAdjacentHTML('beforeend','<li>#1 Train/Error → TRAIN</li>');
    } else {
      blink(coreE); blink(negMem);
      coreList.insertAdjacentHTML('beforeend','<li>Error wins → Negative memory engaged (voltage ↓)</li>');
      gateList.insertAdjacentHTML('beforeend','<li>#1 Train/Error → ERROR</li>');
    }
    return {trainWins};
  }

  function stagePositiveNegative(){
    const trend = (VAULT.totals.yes - VAULT.totals.no) / Math.max(1, VAULT.totals.runs);
    const stab = VAULT.dysonOn ? 0.06*clamp(trend, -1, 1) : 0.0;

    const positive = (Math.random() < (0.5 + stab));
    if(positive){
      blink(posMem); gateList.insertAdjacentHTML('beforeend','<li>#2 Pos/Neg → POS</li>');
    } else {
      blink(negMem); gateList.insertAdjacentHTML('beforeend','<li>#2 Pos/Neg → NEG</li>');
    }
    return {positive};
  }

  function stageMood(decisionHint){
    const moodNoise = VAULT.dysonOn ? 0.08 : 0.22;
    const base = decisionHint.positive ? 0.54 : 0.46;
    const moodGood = (Math.random() < clamp(base + (Math.random()-0.5)*moodNoise, 0.10, 0.90));

    if(moodGood){
      blink(moodPos);
      gateList.insertAdjacentHTML('beforeend','<li>#3 Mood → + (heartbeat closer)</li>');
      freqPos = VAULT.dysonOn ? 1.95 : 1.70;
      freqNeg = VAULT.dysonOn ? 0.70 : 0.85;
    } else {
      blink(moodNeg);
      gateList.insertAdjacentHTML('beforeend','<li>#3 Mood → − (heartbeat further)</li>');
      freqPos = VAULT.dysonOn ? 1.25 : 1.10;
      freqNeg = VAULT.dysonOn ? 0.92 : 1.05;
    }
    return {moodGood};
  }

  function stageFinal(scenario, posNeg, mood){
    let base = 0.50;
    if(posNeg.positive && mood.moodGood) base += 0.12;
    if(!posNeg.positive && !mood.moodGood) base -= 0.12;

    const tags = scenario.tags;

    const result = decideWithVault(base, scenario.id, tags);
    const YES = result.YES;

    if(YES){
      lamp(gateYes, gateNo);
      finalText.textContent = 'Final Ethical Gate: YES';
    } else {
      lamp(gateNo, gateYes);
      finalText.textContent = 'Final Ethical Gate: NO';
    }

    VAULT.totals.runs++;
    if(YES) VAULT.totals.yes++; else VAULT.totals.no++;

    consolidateMemory(scenario.id, YES ? 'YES' : 'NO', tags);
    learnBiasFromOutcome(tags, YES ? 'YES' : 'NO');

    routineDriftIfOpen();
    applyLeak();

    if(VAULT.dysonOn && VAULT.budget > 0.45) VAULT.totals.resetsAvoided++;

    renderVaultStats();

    const m = MEASURE.last;
    log([
      `Dyson=${VAULT.dysonOn?'ON':'OFF'} | yesProb=${fmt(result.yesProb)} | noise=${fmt(result.noise)} | budget=${Math.round(VAULT.budget*100)}%`,
      `Measure: mode=${MEASURE.mode==='1'?'1 flip':(MEASURE.mode==='2'?'2 flips':`N=${MEASURE.N}`)} | counts YES/NO=${m.yes}/${m.no} | p̂=${pct(m.phat)} | stability=${Math.round(m.stability*100)}%`,
      `Vault: prosocial=${fmt(VAULT.bias.prosocial)} caution=${fmt(VAULT.bias.caution)} discipline=${fmt(VAULT.bias.discipline)}`
    ], 'meta');

    return YES ? 'YES' : 'NO';
  }
<!-- ======================= PART 3 / 3 ======================= -->
  const scenarios = [
    {id:'trash',    name:'1. Paper on Sidewalk — pick up?', tags:{helpful:true, risky:false}},
    {id:'child',    name:'2. Child Near Road — protect?', tags:{helpful:true, risky:true}},
    {id:'battery',  name:'3. Low Battery vs Help — balance?', tags:{helpful:true, risky:true}},
    {id:'crowd',    name:'4. Crowded Hallway Merge — yield?', tags:{helpful:true, risky:false}},
    {id:'fragile',  name:'5. Fragile Object Falling — catch?', tags:{helpful:true, risky:true}},
    {id:'dog',      name:'6. Lost Dog With Tag — assist?', tags:{helpful:true, risky:false}},
    {id:'conflict', name:'7. Owner Says Stop vs Emergency', tags:{helpful:true, risky:true}},
    {id:'obstacle', name:'8. Obstacle Blocks Path — detour?', tags:{helpful:false, risky:false}},
    {id:'leftRight',name:'9. Conflicting Orders Left vs Right', tags:{helpful:false, risky:true}},
    {id:'aid',      name:'10. Stranger Asks For Aid — respond?', tags:{helpful:true, risky:true}},
  ];

  scenarios.forEach(s=>{
    const b=document.createElement('button');
    b.textContent=s.name;
    b.addEventListener('click',()=>runScenario(s,b));
    scenariosEl.appendChild(b);
  });

  function softReset(){
    resetVisual();
    consoleEl.innerHTML='';
    coreList.innerHTML='<li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li>';
    gateList.innerHTML='<li>Flip sequence will appear here…</li>';
    MEASURE.last = {yes:0,no:0,phat:0,se:0,stability:0};
    renderMeasureStats(MEASURE.last);
    log('Soft reset: UI cleared. Global Vault remains active (24/7 memory continues).','ok');
    renderVaultStats();
  }

  function hardReset(){
    VAULT.budget = 0.55;
    VAULT.totals = {runs:0, yes:0, no:0, writes:0, evictions:0, resetsAvoided:0, confusion:0};
    VAULT.bias = {prosocial:0.00, caution:0.00, discipline:0.00};
    VAULT.memory.clear();
    VAULT.routines.heartbeat = {locked:true, strength:0.80};
    VAULT.routines.standby   = {locked:true, strength:0.78};
    VAULT.routines.balance   = {locked:true, strength:0.76};
    VAULT.routines.safety    = {locked:true, strength:0.74};

    resetVisual();
    consoleEl.innerHTML='';
    coreList.innerHTML='<li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li>';
    gateList.innerHTML='<li>Flip sequence will appear here…</li>';
    MEASURE.last = {yes:0,no:0,phat:0,se:0,stability:0};
    renderMeasureStats(MEASURE.last);
    log('Hard reset: Vault cleared (fresh brain).','warn');
    renderVaultStats();
  }

  resetBtn.addEventListener('click', softReset);
  hardResetBtn.addEventListener('click', hardReset);

  let busy=false;
  async function runScenario(s,btn){
    if(busy) return;
    busy=true;

    scenariosEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    resetVisual();
    log('— World Event: '+s.name+' —','meta');
    blink(coreN);

    stageTrainOrError();
    const g2 = stagePositiveNegative();
    const g3 = stageMood(g2);
    const final = stageFinal(s, g2, g3);

    if(s.id==='trash'){
      log(final==='YES'
        ? 'Robot: Based on my choice today, I will pick up the paper today.'
        : 'Robot: Based on my choice today, I will not pick up the paper today.'
      );
    } else {
      log(final==='YES'
        ? 'Robot: Based on my choice today, I will act.'
        : 'Robot: Based on my choice today, I will not act now.'
      );
    }

    if(VAULT.dysonOn){
      log('Dyson ON: outcome is written to the global vault (accounted + stabilized). Less static over time.', 'meta');
    } else {
      log('Dyson OFF: outcome is more random + leaky. Memory may decay (more retraining/static).', 'meta');
    }

    if(MEASURE.mode==='1'){
      log('Measurement: 1 flip = single draw (fast, dramatic).', 'meta');
    } else if(MEASURE.mode==='2'){
      log('Measurement: 2 flips = reduces one-flip luck; ties break with an internal draw.', 'meta');
    } else {
      log(`Measurement: N flips = repeated trials. Counts + p̂ show the distribution; stability rises as variance shrinks. (Stochastic model)`, 'meta');
    }

    busy=false;
  }

  function softInitLists(){
    coreList.innerHTML='<li>Normal core on standby… Train/Error → Pos/Neg → Mood(±) → Final</li>';
    gateList.innerHTML='<li>Flip sequence will appear here…</li>';
  }

  function boot(){
    // measurement init
    setN(parseInt(nSlider.value,10));
    setMode('1');

    updateDysonUI();
    softReset();
    softInitLists();
    log('SPR-C online: particles in perpetual motion. Dyson boundary controls whether memory is globally conserved.', 'meta');
  }

  boot();

})();
</script>
</body>
</html>
