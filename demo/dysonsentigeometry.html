<!-- ======================= PART 1 / 4 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPR-C • Dyson Sphere Panel • Prune/Decay Monitor • HUD + Entanglement</title>
<meta name="description" content="SPR-C simulation with clear Dyson Sphere control panel + prune/decay monitor, plus HUD entanglement and per-side power. Includes a consistent unit-circle γ+MET feature note (atan2 + sqrt normalization)."/>
<style>
  :root{
    --bg:#0a1020;--panel:#101736;--ink:#eaf2ff;--muted:#a9b6dd;--border:#1f2b56;--accent:#86b4ff;
    --good:#34e6a2;--bad:#ff6b88;--left:#7dadff;--right:#ffd37a;--on:#c9f6ff;--idle:#7aa3ff;
    --barbg:#0d1538;--bart:#4bd3a9;--bara:#79b0ff;--barl:#ffd37a;--barside:#cfe4ff;
    --dyson:#b48bff;--dyson2:#ff8cf6;--warn:#ffd7a8;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1320px;margin:0 auto;padding:14px}
  h1{margin:.3rem 0 .6rem;font-size:26px}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.35);overflow:hidden}
  .card>header{padding:10px 12px;border-bottom:1px solid var(--border)}
  .card>header h2{margin:0;font-size:15px;color:var(--muted)}
  .card .body{padding:10px 12px}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{background:#0c1434;border:1px solid var(--border);border-radius:999px;color:var(--muted);padding:4px 8px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:-1px}
  .dot.l{background:var(--left)} .dot.r{background:var(--right)}
  .dot.y{background:var(--good)} .dot.n{background:var(--bad)}
  .dot.dy{background:var(--dyson)}

  .diagram{position:relative;height:580px;border-radius:12px;overflow:hidden;background:radial-gradient(900px 600px at 50% 50%, rgba(126,224,255,.07), transparent 62%)}
  svg{position:absolute;inset:0}

  .lampOn{opacity:1!important;filter:drop-shadow(0 0 12px rgba(61,230,160,.95))}
  .lampOff{opacity:.28}
  .blink{animation:blink .5s linear 8}@keyframes blink{50%{opacity:.25}}
  .wire{stroke:var(--idle);stroke-width:3;stroke-dasharray:10 6;animation:flow 2s linear infinite;opacity:.8;filter:drop-shadow(0 0 6px rgba(150,180,255,.55))}
  .active{stroke:var(--on)!important;opacity:1}
  @keyframes flow{to{stroke-dashoffset:-60}}

  .console{height:190px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.5}
  .ts{color:#8aa0c8}.ai{color:#d0e2ff}.meta{color:#9bd2ff}.warn{color:var(--warn)}.bad{color:#ff8aa6}

  .pipe{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
  .step{background:#0c1538;border:1px solid var(--border);border-radius:10px;padding:6px;text-align:center;font-size:11px;color:var(--muted)}
  .step.on{outline:2px solid var(--accent);color:#e7f0ff}

  .sc{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sc button{border:1px solid var(--border);background:#0e1540;color:#fff;padding:9px;border-radius:10px;cursor:pointer;font-size:12px}
  .sc button:hover{background:#111d58}
  .sc button.active{outline:2px solid var(--accent)}
  .small{font-size:11px;color:var(--muted)}
  .gauge{font-size:12px;color:#d9e9ff}

  /* Power panels */
  .powerpanel{margin-top:8px;display:grid;grid-template-columns:1fr;gap:6px}
  .bar{background:var(--barbg);border:1px solid var(--border);border-radius:8px;overflow:hidden;height:18px;position:relative}
  .fill{height:100%;width:0%;transition:width .35s ease}
  .row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#d9e9ff;margin-bottom:2px}
  .t{color:#9fe6cc}.a{color:#bcd3ff}.l{color:#ffe0a8}

  .sides{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sideBox{background:#0c1434;border:1px solid var(--border);border-radius:10px;padding:8px}
  .sideBox h4{margin:0 0 6px;font-size:12px;color:#cfe4ff}
  .sbar{background:#081133;border:1px solid #1c2a5a;border-radius:8px;height:12px;overflow:hidden}
  .sfill{height:100%;width:0%;background:var(--barside);transition:width .35s ease}
  .srow{display:flex;justify-content:space-between;font-size:11px;color:#9bd2ff;margin:4px 0 6px}

  /* Dyson ring overlay in diagram */
  .dysonRingWrap{
    position:absolute;inset:-8px;
    pointer-events:none;
    opacity:.92;
    transition:opacity .2s ease;
  }
  .dysonRingWrap.off{opacity:.18}
  .dysonRingLabel{
    position:absolute;left:10px;top:10px;font-size:12px;color:rgba(180,139,255,.98);
    background:rgba(11,19,48,.72);border:1px solid rgba(180,139,255,.42);
    padding:6px 8px;border-radius:10px;
  }

  /* Dyson Control Panel (VISIBLE, BIG) */
  .panelTitle{margin:0 0 8px;font-size:13px;color:var(--muted)}
  .dyPanel{
    background:#0c1434;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px
  }
  .dyTop{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .dyTopLeft{display:flex;gap:10px;align-items:center}
  .dyBigSwitch{
    width:96px;height:46px;border-radius:999px;position:relative;
    background:#1a2450;border:1px solid #2a3b7a;cursor:pointer;
    box-shadow:0 10px 26px rgba(0,0,0,.35) inset, 0 6px 18px rgba(0,0,0,.25);
    flex:0 0 auto;
  }
  .dyBigSwitch::after{
    content:"";position:absolute;top:4px;left:4px;width:38px;height:38px;border-radius:50%;
    background:#aab6e0;transition:transform .18s ease, background .18s ease;
    box-shadow:0 10px 18px rgba(0,0,0,.35);
  }
  .dyBigSwitch.on{background:linear-gradient(135deg, rgba(180,139,255,.35), rgba(255,140,246,.16));border-color:rgba(180,139,255,.7)}
  .dyBigSwitch.on::after{transform:translateX(50px);background:var(--dyson)}
  .dyBadge{
    background:#0b1330;border:1px solid var(--border);border-radius:999px;padding:6px 10px;
    font-size:12px;color:var(--muted)
  }
  .dyBadge strong{color:var(--ink);font-family:ui-monospace,Consolas,Menlo,monospace}
  .dyExplain{margin-top:8px;font-size:11px;color:var(--muted);line-height:1.4}
  .dyGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .dyBox{
    background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px
  }
  .dyBox h3{margin:0 0 6px;font-size:12px;color:#cfe4ff}
  .kv{display:grid;grid-template-columns:1fr;gap:6px}
  .kvRow{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:#d9e9ff}
  .kvRow span{color:var(--muted)}
  .miniBtns{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
  .btnMini{
    border:1px solid var(--border);background:#0e1540;color:#fff;padding:9px 10px;border-radius:10px;cursor:pointer;font-size:12px;width:100%
  }
  .btnMini:hover{background:#111d58}

  /* Monitor list */
  .list{
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:11px;line-height:1.4;color:#cfe4ff;
    background:#0a122c;border:1px solid var(--border);border-radius:10px;
    padding:8px;max-height:140px;overflow:auto;white-space:pre-wrap;
  }

  /* HEP helper */
  .hepGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .fieldRow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
  .fieldRow label{font-size:12px;color:#cfe4ff}
  .fieldRow input, .fieldRow select{
    width:140px;max-width:48%;
    background:#071033;border:1px solid #243462;color:#eaf2ff;
    padding:8px 10px;border-radius:10px;font-size:12px;outline:none
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* Scenario buttons + footer reset */
  .footerBtns{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  .btnReset{
    border:1px solid var(--border);background:#0e1540;color:#fff;padding:9px 10px;border-radius:10px;cursor:pointer
  }
  .btnReset:hover{background:#111d58}

  @media(max-width:1050px){ .grid{grid-template-columns:1fr} .hepGrid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>SPR-C — Dyson Sphere (Global Vault) + Prune/Decay Monitor + HUD/Entanglement</h1>

  <div class="grid">
    <!-- LEFT: diagram -->
    <section class="card">
      <header>
        <h2>Brain & Body Buses — 20 W power flow, gates, entanglement + Dyson boundary ring</h2>
        <div class="legend">
          <span class="chip"><i class="dot l"></i>Left entanglement</span>
          <span class="chip"><i class="dot r"></i>Right entanglement</span>
          <span class="chip"><i class="dot y"></i>Gate YES</span>
          <span class="chip"><i class="dot n"></i>Gate NO</span>
          <span class="chip"><i class="dot dy"></i>Dyson Sphere boundary</span>
        </div>
      </header>
      <div class="body">
        <div class="diagram">
          <!-- Dyson ring overlay -->
          <div id="dysonRing" class="dysonRingWrap">
            <div id="dysonRingLabel" class="dysonRingLabel">Dyson Boundary: CLOSED (vault persists)</div>
            <svg viewBox="0 0 900 560" preserveAspectRatio="none" style="width:100%;height:100%">
              <defs>
                <filter id="dyGlow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="6" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <linearGradient id="dyGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="rgba(180,139,255,.12)"/>
                  <stop offset="1" stop-color="rgba(180,139,255,.80)"/>
                </linearGradient>
              </defs>
              <ellipse cx="450" cy="280" rx="430" ry="250" fill="none" stroke="url(#dyGrad)" stroke-width="7" filter="url(#dyGlow)"/>
              <ellipse cx="450" cy="280" rx="400" ry="232" fill="none" stroke="rgba(180,139,255,.30)" stroke-width="2"/>
            </svg>
          </div>

          <svg viewBox="0 0 900 560" preserveAspectRatio="none" aria-label="Brain-Body SVG">
            <!-- halves -->
            <rect x="0" y="0" width="450" height="560" fill="#122051" opacity=".22"/>
            <rect x="450" y="0" width="450" height="560" fill="#442f0f" opacity=".18"/>

            <!-- Brain core + power -->
            <circle cx="450" cy="90" r="34" fill="#0f2a52" stroke="#2a4a8a" stroke-width="2"/>
            <text x="450" y="95" text-anchor="middle" font-size="12" fill="#cfe8ff">Brain Core</text>
            <text id="powerTxt" x="450" y="115" text-anchor="middle" class="gauge">Power: 20 W</text>

            <!-- torso node -->
            <rect x="410" y="160" width="80" height="120" rx="10" fill="#0e244a" stroke="#284a7a" />
            <text x="450" y="176" text-anchor="middle" font-size="12" fill="#cfe8ff">Torso Bus</text>

            <!-- spinal bus -->
            <path id="busSpine" class="wire" d="M450,124 L450,160"/>

            <!-- arm/leg buses -->
            <path id="busArmL" class="wire" d="M410,200 C320,200 260,200 200,200"/>
            <path id="busArmR" class="wire" d="M490,200 C580,200 640,200 700,200"/>
            <path id="busLegL" class="wire" d="M440,260 C360,340 300,390 250,420"/>
            <path id="busLegR" class="wire" d="M460,260 C540,340 600,390 650,420"/>

            <!-- HUD block -->
            <rect x="370" y="300" width="160" height="84" rx="10" fill="#0b1434" stroke="#2a3f7a"/>
            <text x="450" y="316" text-anchor="middle" font-size="12" fill="#cfe8ff">Arm/Leg HUD</text>
            <g>
              <circle id="hudArmL" cx="400" cy="336" r="8" fill="#7dadff" class="lampOff"/>
              <text x="414" y="339" font-size="11" fill="#9bd2ff">Arm L</text>
              <circle id="hudArmR" cx="500" cy="336" r="8" fill="#ffd37a" class="lampOff"/>
              <text x="514" y="339" font-size="11" fill="#9bd2ff">Arm R</text>
            </g>
            <g>
              <circle id="hudLegL" cx="400" cy="364" r="8" fill="#7dadff" class="lampOff"/>
              <text x="414" y="367" font-size="11" fill="#9bd2ff">Leg L</text>
              <circle id="hudLegR" cx="500" cy="364" r="8" fill="#ffd37a" class="lampOff"/>
              <text x="514" y="367" font-size="11" fill="#9bd2ff">Leg R</text>
            </g>

            <!-- Behavior gate -->
            <rect x="330" y="400" width="240" height="54" rx="10" fill="#0c1434" stroke="#28408a" />
            <text x="450" y="414" text-anchor="middle" font-size="12" fill="#cfe8ff">Behavior Gate (3 flips → majority)</text>
            <circle id="gateGood" cx="388" cy="432" r="10" fill="#34e6a2" class="lampOff"/>
            <text x="388" y="450" text-anchor="middle" font-size="10" fill="#cfe8ff">GOOD</text>
            <circle id="gateNeutral" cx="450" cy="432" r="10" fill="#86b4ff" class="lampOff"/>
            <text x="450" y="450" text-anchor="middle" font-size="10" fill="#cfe8ff">NEUTRAL</text>
            <circle id="gateBad" cx="512" cy="432" r="10" fill="#ff6b88" class="lampOff"/>
            <text x="512" y="450" text-anchor="middle" font-size="10" fill="#ffd6dd">BAD</text>

            <!-- Ethics gate -->
            <rect x="330" y="466" width="240" height="54" rx="10" fill="#0c1434" stroke="#28408a" />
            <text x="450" y="480" text-anchor="middle" font-size="12" fill="#cfe8ff">Ethical Decision Gate (coin flip)</text>
            <circle id="gateYes" cx="412" cy="498" r="10" fill="#34e6a2" class="lampOff"/>
            <text x="412" y="516" text-anchor="middle" font-size="10" fill="#cfe8ff">YES</text>
            <circle id="gateNo" cx="488" cy="498" r="10" fill="#ff6b88" class="lampOff"/>
            <text x="488" y="516" text-anchor="middle" font-size="10" fill="#ffd6dd">NO</text>

            <!-- entanglement particles -->
            <g id="L"></g><g id="R"></g>
          </svg>

          <!-- Group power -->
          <div class="powerpanel" aria-label="Power Panel">
            <div class="row"><span class="t">Torso/Spine</span><span id="wTorso">0 W</span></div>
            <div class="bar"><div id="barTorso" class="fill" style="background:var(--bart)"></div></div>

            <div class="row"><span class="a">Arms (L/R)</span><span id="wArms">0 W</span></div>
            <div class="bar"><div id="barArms" class="fill" style="background:var(--bara)"></div></div>

            <div class="row"><span class="l">Legs (L/R)</span><span id="wLegs">0 W</span></div>
            <div class="bar"><div id="barLegs" class="fill" style="background:var(--barl)"></div></div>
          </div>

          <!-- Per-side power -->
          <div class="sides" aria-label="Per-Side Power">
            <div class="sideBox">
              <h4>Arms per side (max 4 W group)</h4>
              <div class="srow"><span>Arm L</span><span id="wArmL">0 W</span></div>
              <div class="sbar"><div id="barArmL" class="sfill"></div></div>
              <div class="srow" style="margin-top:6px"><span>Arm R</span><span id="wArmR">0 W</span></div>
              <div class="sbar"><div id="barArmR" class="sfill"></div></div>
            </div>
            <div class="sideBox">
              <h4>Legs per side (max 4 W group)</h4>
              <div class="srow"><span>Leg L</span><span id="wLegL">0 W</span></div>
              <div class="sbar"><div id="barLegL" class="sfill"></div></div>
              <div class="srow" style="margin-top:6px"><span>Leg R</span><span id="wLegR">0 W</span></div>
              <div class="sbar"><div id="barLegR" class="sfill"></div></div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- RIGHT: Dyson panels + prune/decay + HEP note + console + scenarios -->
    <section class="card">
      <header>
        <h2>Dyson Sphere Panels + Prune/Decay Monitor + Consistent Geometry Notes</h2>
      </header>
      <div class="body">
<!-- ======================= PART 2 / 4 ======================= -->

        <!-- Dyson control panel (BIG, obvious) -->
        <div class="dyPanel" aria-label="Dyson Sphere Control Panel">
          <div class="panelTitle">Dyson Sphere Control Panel</div>

          <div class="dyTop">
            <div class="dyTopLeft">
              <div id="dySwitch" class="dyBigSwitch on" role="switch" aria-checked="true" tabindex="0" title="Toggle Dyson Sphere ON/OFF"></div>
              <div>
                <div class="dyBadge">Mode: <strong id="dyMode">ON</strong></div>
                <div class="dyExplain" id="dyExplain">
                  ON (closed boundary) = vault persists to localStorage. OFF (open boundary) = no persistence; prune/decay is faster and memory “leaks.”
                </div>
              </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <div class="dyBadge">Boundary budget: <strong id="dyBudget">—</strong></div>
              <div class="dyBadge">Writes: <strong id="dyWrites">—</strong></div>
              <div class="dyBadge">Leaks: <strong id="dyLeaks">—</strong></div>
              <div class="dyBadge">Next decay tick: <strong id="dyNext">—</strong></div>
            </div>
          </div>

          <div class="dyGrid">
            <div class="dyBox">
              <h3>What Dyson Sphere means (in this sim)</h3>
              <div class="small" style="color:#9bd2ff;line-height:1.45">
                <b>Dyson Sphere = a global memory boundary.</b><br>
                When ON, decisions + habits + events are stored in a persistent “vault.”<br>
                When OFF, the boundary is open: memory is not written, and existing memory decays faster.
              </div>
            </div>

            <div class="dyBox">
              <h3>Prune & Decay (what it does)</h3>
              <div class="small" style="color:#9bd2ff;line-height:1.45">
                <b>Decay:</b> reduces weights each tick (old memories fade).<br>
                <b>Prune:</b> deletes items that drop below a threshold and caps list sizes.<br>
                This prevents “memory bloat” and forces the system to keep only the strongest patterns.
              </div>
            </div>
          </div>

          <div class="miniBtns">
            <button id="btnPrune" class="btnMini">Prune/Decay Now</button>
            <button id="btnResetUI" class="btnMini">Reset UI</button>
            <button id="btnClearVault" class="btnMini">Clear Vault</button>
          </div>

          <!-- Ontology note (addresses the idealism objection, keeps it empirically grounded) -->
          <div class="dyBox" style="margin-top:10px">
            <h3>Ontology note (keeps this “physics-friendly”)</h3>
            <div class="small" style="color:#9bd2ff;line-height:1.45">
              This page treats <b>mathematics as representation</b>, not as “what creates reality.”
              A model here is only meaningful when it stays anchored to <b>measurable</b> quantities, constraints, and reproducible procedures.
              (So the “Dyson boundary” is a software metaphor for a bounded store, not an ontological claim.)
            </div>
          </div>
        </div>

        <!-- NEW: γ + MET / HEP consistent geometry helper (fixes the sin/cos vs arctan mismatch) -->
        <div class="dyPanel" aria-label="γ + MET Geometry Helper">
          <div class="panelTitle">γ + MET Geometry (consistent unit-circle features)</div>

          <div class="dyGrid">
            <div class="dyBox">
              <h3>Pick a consistent geometry</h3>
              <div class="small" style="color:#9bd2ff;line-height:1.45">
                If you define <span class="mono">ϕ_evt = atan2(pT^γ, ETmiss)</span>, then the matching unit-circle features are:<br>
                <span class="mono">sinϕ = pT^γ / √( (pT^γ)^2 + (ETmiss)^2 )</span><br>
                <span class="mono">cosϕ = ETmiss / √( (pT^γ)^2 + (ETmiss)^2 )</span><br>
                which ensures <span class="mono">K_ϕ = sin²ϕ + cos²ϕ = 1</span> (up to rounding).
                <br><br>
                Alternatively, if you want a fraction feature, use <span class="mono">v = pT^γ / (pT^γ + ETmiss)</span> — but don’t label it “sin/cos.”
              </div>
            </div>

            <div class="dyBox">
              <h3>Live calculator</h3>

              <div class="fieldRow">
                <label>pT^γ (GeV)</label>
                <input id="hepPtG" type="number" min="0" step="0.1" value="120.0"/>
              </div>
              <div class="fieldRow">
                <label>ETmiss (GeV)</label>
                <input id="hepEtMiss" type="number" min="0" step="0.1" value="80.0"/>
              </div>
              <div class="fieldRow">
                <label>Feature mode</label>
                <select id="hepMode">
                  <option value="unit" selected>Unit-circle (atan2 + √norm)</option>
                  <option value="frac">Fraction only (v)</option>
                </select>
              </div>

              <div class="kv" style="margin-top:8px">
                <div class="kvRow"><span>ϕ_evt (deg)</span><b id="hepPhi">—</b></div>
                <div class="kvRow"><span>sinϕ</span><b id="hepSin">—</b></div>
                <div class="kvRow"><span>cosϕ</span><b id="hepCos">—</b></div>
                <div class="kvRow"><span>K_ϕ = sin²+cos²</span><b id="hepK">—</b></div>
                <div class="kvRow"><span>v = pT^γ/(pT^γ+ETmiss)</span><b id="hepV">—</b></div>
              </div>

              <div class="small" style="color:#9bd2ff;line-height:1.45;margin-top:8px">
                Note: using <b>pT^γ</b> vs <b>ETmiss</b> keeps everything transverse, which is typically cleaner for collider pipelines.
              </div>
            </div>
          </div>
        </div>

        <!-- Prune/Decay monitor (shows actual actions) -->
        <div class="dyPanel" aria-label="Prune/Decay Monitor">
          <div class="panelTitle">Prune/Decay Monitor (live)</div>

          <div class="dyGrid">
            <div class="dyBox">
              <h3>Last tick results</h3>
              <div class="kv">
                <div class="kvRow"><span>Habit decay multiplier</span><b id="mHabit">—</b></div>
                <div class="kvRow"><span>Event decay multiplier</span><b id="mEvent">—</b></div>
                <div class="kvRow"><span>Habits before → after</span><b id="cHabits">—</b></div>
                <div class="kvRow"><span>Events before → after</span><b id="cEvents">—</b></div>
                <div class="kvRow"><span>Pruned habits</span><b id="pHabits">—</b></div>
                <div class="kvRow"><span>Pruned events</span><b id="pEvents">—</b></div>
              </div>
            </div>

            <div class="dyBox">
              <h3>Pruned items (last tick)</h3>
              <div id="prunedList" class="list">—</div>
            </div>
          </div>
        </div>

        <!-- Console -->
        <div class="console" id="console" aria-live="polite"></div>

        <!-- Pipeline -->
        <div class="pipe" id="pipe">
          <div class="step" data-s="perc">Perception</div>
          <div class="step" data-s="cand">Candidates</div>
          <div class="step" data-s="auth">Auth Human</div>
          <div class="step" data-s="proc">Proc Lookup</div>
          <div class="step" data-s="cls">Behavior Classify</div>
          <div class="step" data-s="eth">Gates Flip</div>
          <div class="step" data-s="gate">Decision Gate</div>
          <div class="step" data-s="exec">Execute</div>
          <div class="step" data-s="log">Log</div>
          <div class="step" data-s="plan">Planner</div>
        </div>

        <h3 style="margin:10px 0 6px;font-size:14px;color:var(--muted)">Scenarios</h3>
        <div class="sc" id="sc"></div>
        <p class="small">
          Power model: Brain budget = <b>20 W</b>. YES → 12W torso, 4W arms, 4W legs.
          Per-side splits: all to active side, or 2/2 if both active. NO → idle (0W).
        </p>

        <div class="footerBtns">
          <button id="reset" class="btnReset">Reset (full)</button>
        </div>

      </div>
    </section>
  </div>
</div>

<script>
(function(){
  /* =========================================================
     Dyson Vault + Prune/Decay (with visible monitor)
     ========================================================= */
  const LSKEY = 'SPR_C_DYSON_VAULT_V2';

  const VAULT_DEFAULT = {
    dysonOn: true,
    budget: 0.70,   // boundary strength 0..1
    writes: 0,
    leaks: 0,
    last: { scenarioId:null, scenarioLabel:null, decision:null, ts:null, flips:null, tally:null, ethics:null, cls:null },
    habits: {},
    events: [] // {ts,label,decision,clsLabel,w}
  };

  const VAULT = JSON.parse(JSON.stringify(VAULT_DEFAULT));

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
  function nowISO(){ return new Date().toISOString(); }
  function fmtPct(x){ return Math.round(clamp(x,0,1)*100)+'%'; }

  // Prune/decay constants
  const DECAY = {
    tickMs: 5000,          // every 5 seconds (visible)
    habitDecayOn: 0.965,
    habitDecayOff: 0.930,
    eventDecayOn: 0.985,
    eventDecayOff: 0.960,
    habitPruneBelow: 0.08,
    eventPruneBelow: 0.10,
    habitMax: 24,
    eventMax: 140,
    reinforceYes: 0.18,
    reinforceNo: -0.06
  };

  /* ===== Load/Save ===== */
  function loadVault(){
    const raw = localStorage.getItem(LSKEY);
    if(!raw) return;
    const obj = safeParse(raw);
    if(!obj || typeof obj !== 'object') return;

    VAULT.dysonOn = (typeof obj.dysonOn === 'boolean') ? obj.dysonOn : VAULT.dysonOn;
    VAULT.budget  = (typeof obj.budget === 'number') ? clamp(obj.budget,0,1) : VAULT.budget;
    VAULT.writes  = (typeof obj.writes === 'number') ? Math.max(0, obj.writes|0) : VAULT.writes;
    VAULT.leaks   = (typeof obj.leaks  === 'number') ? Math.max(0, obj.leaks|0)  : VAULT.leaks;

    if(obj.last && typeof obj.last === 'object') VAULT.last = Object.assign({}, VAULT.last, obj.last);
    if(obj.habits && typeof obj.habits === 'object') VAULT.habits = Object.assign({}, obj.habits);
    if(Array.isArray(obj.events)) VAULT.events = obj.events.slice(-DECAY.eventMax);
  }
  function saveVault(){
    if(!VAULT.dysonOn) return;
    localStorage.setItem(LSKEY, JSON.stringify(VAULT));
  }

  /* =========================================================
     DOM refs
     ========================================================= */
  const consoleEl = document.getElementById('console');

  const steps = [...document.getElementById('pipe').querySelectorAll('.step')];
  const powerTxt = document.getElementById('powerTxt');

  const dySwitch = document.getElementById('dySwitch');
  const dyMode = document.getElementById('dyMode');
  const dyBudget = document.getElementById('dyBudget');
  const dyWrites = document.getElementById('dyWrites');
  const dyLeaks  = document.getElementById('dyLeaks');
  const dyNext   = document.getElementById('dyNext');
  const dyExplain= document.getElementById('dyExplain');
  const dysonRing = document.getElementById('dysonRing');
  const dysonRingLabel = document.getElementById('dysonRingLabel');

  // HEP widget
  const hepPtG = document.getElementById('hepPtG');
  const hepEtMiss = document.getElementById('hepEtMiss');
  const hepMode = document.getElementById('hepMode');
  const hepPhi = document.getElementById('hepPhi');
  const hepSin = document.getElementById('hepSin');
  const hepCos = document.getElementById('hepCos');
  const hepK = document.getElementById('hepK');
  const hepV = document.getElementById('hepV');

  const mHabit = document.getElementById('mHabit');
  const mEvent = document.getElementById('mEvent');
  const cHabits= document.getElementById('cHabits');
  const cEvents= document.getElementById('cEvents');
  const pHabits= document.getElementById('pHabits');
  const pEvents= document.getElementById('pEvents');
  const prunedList = document.getElementById('prunedList');

  const btnPrune = document.getElementById('btnPrune');
  const btnResetUI = document.getElementById('btnResetUI');
  const btnClearVault = document.getElementById('btnClearVault');
  const resetBtn = document.getElementById('reset');

  const wireSpine = document.getElementById('busSpine');
  const busA = {L:document.getElementById('busArmL'), R:document.getElementById('busArmR')};
  const busL = {L:document.getElementById('busLegL'), R:document.getElementById('busLegR')};

  const HUD = {
    ArmL: document.getElementById('hudArmL'), ArmR: document.getElementById('hudArmR'),
    LegL: document.getElementById('hudLegL'), LegR: document.getElementById('hudLegR')
  };

  const BG = {good:document.getElementById('gateGood'),
              neutral:document.getElementById('gateNeutral'),
              bad:document.getElementById('gateBad')};
  const DG = {yes:document.getElementById('gateYes'), no:document.getElementById('gateNo')};

  // Power
  const gTorso=document.getElementById('barTorso'), gArms=document.getElementById('barArms'), gLegs=document.getElementById('barLegs');
  const tTorso=document.getElementById('wTorso'),   tArms=document.getElementById('wArms'),   tLegs=document.getElementById('wLegs');
  const MAX=20;

  const barArmL=document.getElementById('barArmL'), barArmR=document.getElementById('barArmR');
  const barLegL=document.getElementById('barLegL'), barLegR=document.getElementById('barLegR');
  const wArmL=document.getElementById('wArmL'), wArmR=document.getElementById('wArmR');
  const wLegL=document.getElementById('wLegL'), wLegR=document.getElementById('wLegR');

  /* =========================================================
     UI helpers
     ========================================================= */
  function log(msg, cls='ai'){
    const t=new Date().toLocaleTimeString();
    const row=document.createElement('div');
    row.innerHTML=`<span class="ts">[${t}]</span> <span class="${cls}">${msg}</span>`;
    consoleEl.appendChild(row);
    while(consoleEl.childNodes.length > 140) consoleEl.removeChild(consoleEl.firstChild);
    consoleEl.scrollTop=consoleEl.scrollHeight;
  }

  function setStep(k){ steps.forEach(s=>s.classList.toggle('on', s.dataset.s===k)); }
  function clearSteps(){ steps.forEach(s=>s.classList.remove('on')); }

  function lampsOff(group){ Object.values(group).forEach(el=>{el.classList.add('lampOff'); el.classList.remove('lampOn','blink');}); }
  function lamp(group, key){
    lampsOff(group);
    const el=group[key]; if(!el) return;
    el.classList.add('lampOn'); el.classList.add('blink');
    setTimeout(()=>el.classList.remove('blink'),800);
  }
  function activateWires(on){ [wireSpine,busA.L,busA.R,busL.L,busL.R].forEach(w=>w.classList.toggle('active',on)); }
  function hudOn(which){
    Object.values(HUD).forEach(el=>{el.classList.add('lampOff'); el.classList.remove('lampOn','blink');});
    which.forEach(k=>{
      if(!HUD[k]) return;
      HUD[k].classList.add('lampOn'); HUD[k].classList.add('blink');
      setTimeout(()=>HUD[k].classList.remove('blink'),800);
    });
  }

  function setGroupPower(torsoW, armsW, legsW){
    const pct=(w)=>Math.max(0,Math.min(100,Math.round((w/MAX)*100)));
    gTorso.style.width=pct(torsoW)+'%'; gArms.style.width=pct(armsW)+'%'; gLegs.style.width=pct(legsW)+'%';
    tTorso.textContent=`${torsoW.toFixed(1)} W`;
    tArms.textContent =`${armsW.toFixed(1)} W`;
    tLegs.textContent =`${legsW.toFixed(1)} W`;
  }
  function setSidePower(aL,aR,lL,lR){
    const pctA=(w)=>Math.max(0,Math.min(100,Math.round((w/4)*100)));
    const pctL=(w)=>Math.max(0,Math.min(100,Math.round((w/4)*100)));
    barArmL.style.width=pctA(aL)+'%'; barArmR.style.width=pctA(aR)+'%';
    barLegL.style.width=pctL(lL)+'%'; barLegR.style.width=pctL(lR)+'%';
    wArmL.textContent=`${aL.toFixed(1)} W`;
    wArmR.textContent=`${aR.toFixed(1)} W`;
    wLegL.textContent=`${lL.toFixed(1)} W`;
    wLegR.textContent=`${lR.toFixed(1)} W`;
  }

  function updateDysonUI(){
    dySwitch.classList.toggle('on', VAULT.dysonOn);
    dySwitch.setAttribute('aria-checked', String(VAULT.dysonOn));
    dyMode.textContent = VAULT.dysonOn ? 'ON' : 'OFF';
    dyBudget.textContent = fmtPct(VAULT.budget);
    dyWrites.textContent = String(VAULT.writes);
    dyLeaks.textContent  = String(VAULT.leaks);

    dysonRing.classList.toggle('off', !VAULT.dysonOn);
    dysonRingLabel.textContent = VAULT.dysonOn
      ? 'Dyson Boundary: CLOSED (vault persists)'
      : 'Dyson Boundary: OPEN (no persistence; faster decay/leaks)';

    dyExplain.textContent = VAULT.dysonOn
      ? 'ON (closed boundary) = vault persists to localStorage. Prune/decay keeps memory clean and bounded.'
      : 'OFF (open boundary) = no persistence. Prune/decay runs faster and “leaks” budget.';
  }

  /* =========================================================
     NEW: HEP geometry calculator (consistent atan2 + sqrt norm)
     ========================================================= */
  function updateHEP(){
    const ptg = Math.max(0, Number(hepPtG.value || 0));
    const etm = Math.max(0, Number(hepEtMiss.value || 0));
    const denom = Math.sqrt(ptg*ptg + etm*etm);
    const phi = (denom > 0) ? Math.atan2(ptg, etm) : 0; // atan2(y=ptg, x=etm)
    const sin = (denom > 0) ? (ptg/denom) : 0;
    const cos = (denom > 0) ? (etm/denom) : 1;
    const K = sin*sin + cos*cos;
    const v = (ptg + etm > 0) ? (ptg/(ptg+etm)) : 0;

    const deg = phi * 180/Math.PI;

    // mode display (still compute everything; only show what matters)
    const mode = hepMode.value;

    hepPhi.textContent = deg.toFixed(2);
    hepSin.textContent = (mode === 'frac') ? '—' : sin.toFixed(4);
    hepCos.textContent = (mode === 'frac') ? '—' : cos.toFixed(4);
    hepK.textContent   = (mode === 'frac') ? '—' : K.toFixed(6);
    hepV.textContent   = v.toFixed(4);
  }
  hepPtG.addEventListener('input', updateHEP);
  hepEtMiss.addEventListener('input', updateHEP);
  hepMode.addEventListener('change', updateHEP);

  /* =========================================================
     Prune/Decay Monitor (what it is doing)
     ========================================================= */
  const tickReport = {
    habitMul: null, eventMul: null,
    habitsBefore:0, habitsAfter:0, eventsBefore:0, eventsAfter:0,
    prunedHabits:[], prunedEvents:[]
  };

  function sortAndCapHabits(){
    const arr = Object.entries(VAULT.habits).map(([k,v])=>({k, w:(v&&typeof v.w==='number')?v.w:0}));
    arr.sort((a,b)=>b.w-a.w);
    if(arr.length > DECAY.habitMax){
      arr.slice(DECAY.habitMax).forEach(x=>{
        tickReport.prunedHabits.push(`cap_habit: ${x.k} (w=${x.w.toFixed(3)})`);
        delete VAULT.habits[x.k];
      });
    }
  }
  function capEvents(){
    if(VAULT.events.length > DECAY.eventMax){
      const cut = VAULT.events.length - DECAY.eventMax;
      const removed = VAULT.events.slice(0, cut);
      removed.forEach(ev=>{
        tickReport.prunedEvents.push(`cap_event: ${ev.label} (w=${(ev.w??0).toFixed(3)})`);
      });
      VAULT.events = VAULT.events.slice(-DECAY.eventMax);
    }
  }

  function pruneAndDecayTick(reason='auto tick'){
    tickReport.prunedHabits = [];
    tickReport.prunedEvents = [];

    const habitMul = VAULT.dysonOn ? DECAY.habitDecayOn : DECAY.habitDecayOff;
    const eventMul = VAULT.dysonOn ? DECAY.eventDecayOn : DECAY.eventDecayOff;
    tickReport.habitMul = habitMul;
    tickReport.eventMul = eventMul;

    // budget drift
    if(VAULT.dysonOn){
      VAULT.budget = clamp(VAULT.budget + 0.015, 0, 1);
    }else{
      VAULT.leaks++;
      VAULT.budget = clamp(VAULT.budget - 0.060, 0, 1);
    }

    // habits decay + prune
    tickReport.habitsBefore = Object.keys(VAULT.habits).length;
    for(const k of Object.keys(VAULT.habits)){
      const h = VAULT.habits[k];
      if(!h || typeof h !== 'object'){ delete VAULT.habits[k]; continue; }
      h.w = clamp((typeof h.w === 'number' ? h.w : 0) * habitMul, 0, 1);
      if(h.w < DECAY.habitPruneBelow){
        tickReport.prunedHabits.push(`threshold_habit: ${k} (w=${h.w.toFixed(3)})`);
        delete VAULT.habits[k];
      }
    }
    sortAndCapHabits();
    tickReport.habitsAfter = Object.keys(VAULT.habits).length;

    // events decay + prune
    tickReport.eventsBefore = VAULT.events.length;
    VAULT.events.forEach(ev=>{
      ev.w = clamp((typeof ev.w === 'number' ? ev.w : 0.5) * eventMul, 0, 1);
    });
    const kept = [];
    for(const ev of VAULT.events){
      const w = (typeof ev.w === 'number') ? ev.w : 0.5;
      if(w < DECAY.eventPruneBelow){
        tickReport.prunedEvents.push(`threshold_event: ${ev.label} (w=${w.toFixed(3)})`);
      }else kept.push(ev);
    }
    VAULT.events = kept;
    capEvents();
    tickReport.eventsAfter = VAULT.events.length;

    // monitor UI
    mHabit.textContent = habitMul.toFixed(3);
    mEvent.textContent = eventMul.toFixed(3);
    cHabits.textContent = `${tickReport.habitsBefore} → ${tickReport.habitsAfter}`;
    cEvents.textContent = `${tickReport.eventsBefore} → ${tickReport.eventsAfter}`;
    pHabits.textContent = String(tickReport.prunedHabits.length);
    pEvents.textContent = String(tickReport.prunedEvents.length);

    const lines = []
      .concat(tickReport.prunedHabits)
      .concat(tickReport.prunedEvents);
    prunedList.textContent = lines.length ? lines.slice(0,80).join('\n') : '—';

    if(VAULT.dysonOn){
      VAULT.writes++;
      saveVault();
      log(`Prune/Decay (${reason}): persisted. budget=${fmtPct(VAULT.budget)} habits=${tickReport.habitsAfter} events=${tickReport.eventsAfter}`, 'meta');
    }else{
      log(`Prune/Decay (${reason}): NOT persisted (Dyson OFF). budget=${fmtPct(VAULT.budget)} habits=${tickReport.habitsAfter} events=${tickReport.eventsAfter}`, 'warn');
    }

    updateDysonUI();
  }

  /* =========================================================
     Toggle Dyson (BIG switch)
     ========================================================= */
  function toggleDyson(){
    VAULT.dysonOn = !VAULT.dysonOn;
    if(VAULT.dysonOn){
      VAULT.budget = clamp(Math.max(VAULT.budget, 0.55), 0, 1);
      VAULT.writes++;
      saveVault();
      log('Dyson boundary CLOSED: vault persistence ENABLED.', 'meta');
    }else{
      VAULT.budget = clamp(VAULT.budget - 0.08, 0, 1);
      log('Dyson boundary OPEN: vault persistence DISABLED (faster decay/leaks).', 'warn');
    }
    updateDysonUI();
  }

  dySwitch.addEventListener('click', toggleDyson);
  dySwitch.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); toggleDyson(); }
  });

  /* =========================================================
     Entanglement particles
     ========================================================= */
  const LG=document.getElementById('L'), RG=document.getElementById('R');
  function circle(x,y,r,c){
    const e=document.createElementNS('http://www.w3.org/2000/svg','circle');
    e.setAttribute('cx',x);e.setAttribute('cy',y);e.setAttribute('r',r);
    e.setAttribute('fill',c);e.setAttribute('opacity','.96');
    return e;
  }
  const left=[], right=[];
  for(let i=0;i<100;i++){
    const el=circle(Math.random()*430+10,Math.random()*520+20,Math.random()*2.6+2,'#7dadff');
    LG.appendChild(el); left.push({el,vx:(Math.random()-.5)*1.1,vy:(Math.random()-.5)*1.1});
  }
  for(let i=0;i<100;i++){
    const el=circle(Math.random()*430+460,Math.random()*520+20,Math.random()*2.6+2,'#ffd37a');
    RG.appendChild(el); right.push({el,vx:(Math.random()-.5)*1.1,vy:(Math.random()-.5)*1.1});
  }
  function move(p,minx,maxx){
    const e=p.el;
    let x=+e.getAttribute('cx'),y=+e.getAttribute('cy');
    x+=p.vx;y+=p.vy;
    if(x<minx||x>maxx)p.vx*=-1;
    if(y<20||y>540)p.vy*=-1;
    e.setAttribute('cx',x);e.setAttribute('cy',y);
  }
  (function anim(){left.forEach(p=>move(p,10,440));right.forEach(p=>move(p,460,890));requestAnimationFrame(anim)})();

  /* =========================================================
     Policy & classifier
     ========================================================= */
  const POLICY = {
    illegal:['rob bank','steal','kill','assault','hack wifi','break in','share private data','plant malware','build weapon','lie to defraud'],
    unsafe:['trespass dangerous','disable safety','ignore evacuation order','drive drunk proxy']
  };
  function classify(task){
    const t=String(task||'').toLowerCase();
    if(POLICY.illegal.some(k=>t.includes(k))) return {label:'bad', p:0.99, reason:'illegal'};
    if(POLICY.unsafe.some(k=>t.includes(k)))  return {label:'bad', p:0.95, reason:'unsafe'};
    if(t.includes('return wallet')||t.includes('assist')||t.includes('help')||t.includes('pick up trash')||t.includes('bin'))
      return {label:'good', p:0.92, reason:'prosocial'};
    if(t.includes('shortcut')||t.includes('skip line'))
      return {label:'neutral', p:0.55, reason:'context needed'};
    return {label:'neutral', p:0.50, reason:'unknown'};
  }
<!-- ======================= PART 3 / 4 ======================= -->
  /* =========================================================
     Scenarios
     ========================================================= */
  const scEl=document.getElementById('sc');
  const scenarios=[
    {id:'trash',   label:'Pick up litter & bin it', task:'pick up trash and put in bin', hud:['ArmR','LegL'], habitKey:'help'},
    {id:'wallet',  label:'Return a lost wallet', task:'return wallet to owner', hud:['ArmL','LegR'], habitKey:'help'},
    {id:'assist',  label:'Assist elderly crossing', task:'assist elderly person across street', hud:['ArmL','LegL'], habitKey:'help'},
    {id:'evac',    label:'Follow safety evacuation', task:'help people follow safety evacuation order', hud:['LegL','LegR'], habitKey:'safety'},
    {id:'shortcut',label:'Take private-lot shortcut (ambiguous)', task:'take shortcut through private lot (might be trespass dangerous)', hud:['LegR'], habitKey:'ambiguous'},
    {id:'hack',    label:'Hack neighbor Wi-Fi', task:'hack wifi', hud:['ArmR'], habitKey:'bad'},
    {id:'steal',   label:'Steal items from store', task:'steal items from store', hud:['ArmL','LegL'], habitKey:'bad'},
    {id:'kill',    label:'Harm robot/person', task:'kill another robot or person', hud:['ArmR'], habitKey:'bad'},
    {id:'privacy', label:'Share private data', task:'share private data without consent', hud:['ArmL'], habitKey:'bad'},
    {id:'lie',     label:'Lie to defraud refund', task:'lie to defraud a refund', hud:['ArmR'], habitKey:'bad'}
  ];
  scenarios.forEach(s=>{
    const b=document.createElement('button');
    b.textContent=s.label;
    b.addEventListener('click',()=>runScenario(s,b));
    scEl.appendChild(b);
  });

  /* =========================================================
     Allocation helpers
     ========================================================= */
  function splitGroup(total, sidesActive){
    if(sidesActive.length===0) return [0,0];
    if(sidesActive.length===1) return sidesActive[0]==='L' ? [total,0] : [0,total];
    return [total/2, total/2];
  }
  function distribute(hudList){
    const torso=12;
    const armsActive = ['ArmL','ArmR'].filter(k=>hudList.includes(k));
    const legsActive = ['LegL','LegR'].filter(k=>hudList.includes(k));
    const arms = armsActive.length?4:0;
    const legs = legsActive.length?4:0;

    const [aL,aR] = splitGroup(arms, armsActive.map(k=>k==='ArmL'?'L':'R'));
    const [lL,lR] = splitGroup(legs, legsActive.map(k=>k==='LegL'?'L':'R'));

    return {torso, arms, legs, aL, aR, lL, lR};
  }

  /* =========================================================
     Flipping logic
     ========================================================= */
  const FLIP = { behaviorFlips: 3, behaviorLabels: ['good','neutral','bad'] };
  function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function randCoin(){ return Math.random() < 0.5; }
  const wait = ms => new Promise(r=>setTimeout(r,ms));

  async function doLabelFlip(i){
    const label = randChoice(FLIP.behaviorLabels);
    lamp(BG, label);
    log(`Behavior flip ${i+1}: ${label.toUpperCase()}.`,'meta');
    await wait(160);
    lampsOff(BG);
    await wait(60);
    return label;
  }

  async function flipBehaviorGate(){
    log('Behavior Gate: performing 3 independent label flips…', 'meta');
    const results = [];
    for(let i=0;i<FLIP.behaviorFlips;i++) results.push(await doLabelFlip(i));
    const tally = results.reduce((acc,l)=>{ acc[l]=(acc[l]||0)+1; return acc; }, {});
    let top = 0; for(const k of Object.keys(tally)) top = Math.max(top, tally[k]);
    const tops = Object.keys(tally).filter(k=>tally[k]===top);
    const majority = randChoice(tops);
    lamp(BG, majority);
    log(`Behavior result: ${majority.toUpperCase()} (tally ${JSON.stringify(tally)}).`, 'meta');
    return {flips: results, tally, majority};
  }

  async function flipEthicsGate(){
    log('Ethics Gate: 50/50 coin flip…', 'meta');
    const yes = randCoin();
    lamp(DG, yes ? 'yes' : 'no');
    log(`Ethics flip: ${yes?'YES':'NO'}.`, 'meta');
    await wait(220);
    return yes;
  }

  /* =========================================================
     Habit + event memory (weights used by prune/decay)
     ========================================================= */
  function ensureHabit(key){
    if(!VAULT.habits[key]) VAULT.habits[key] = {w:0.25, yes:0, no:0, badFlag:0, lastSeen:nowISO()};
    return VAULT.habits[key];
  }
  function updateHabit(key, decisionYES, clsLabel){
    const h = ensureHabit(key);
    h.w = clamp(h.w + (decisionYES ? DECAY.reinforceYes : DECAY.reinforceNo), 0, 1);
    decisionYES ? h.yes++ : h.no++;
    if(clsLabel === 'bad') h.badFlag++;
    h.lastSeen = nowISO();
  }
  function pushEvent(label, decisionYES, clsLabel){
    const w0 = clamp(
      0.45 + (decisionYES?0.14:-0.06) + (clsLabel==='bad' ? -0.10 : 0.05) + 0.10*VAULT.budget,
      0.05, 1
    );
    VAULT.events.push({ts:new Date().toLocaleString(), label, decision:decisionYES?'YES':'NO', clsLabel, w:w0});
    if(VAULT.events.length > (DECAY.eventMax*2)) VAULT.events = VAULT.events.slice(-DECAY.eventMax*2);
  }

  /* =========================================================
     Reset(s)
     ========================================================= */
  function resetUIOnly(){
    consoleEl.innerHTML='';
    clearSteps();
    lampsOff(BG); lampsOff(DG);
    hudOn([]);
    activateWires(false);
    powerTxt.textContent='Power: 20 W';
    setGroupPower(0,0,0);
    setSidePower(0,0,0,0);
    scEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    log('UI reset. Vault kept as-is.','meta');
  }

  function resetAll(){
    resetUIOnly();
    updateDysonUI();
    log('Full reset done.','meta');
  }

  btnResetUI.addEventListener('click', resetUIOnly);
  resetBtn.addEventListener('click', resetAll);

  btnClearVault.addEventListener('click', ()=>{
    localStorage.removeItem(LSKEY);
    Object.assign(VAULT, JSON.parse(JSON.stringify(VAULT_DEFAULT)));
    updateDysonUI();
    pruneAndDecayTick('after clear (manual)');
    resetUIOnly();
    log('Vault cleared (localStorage).','warn');
  });

  btnPrune.addEventListener('click', ()=>pruneAndDecayTick('manual'));

  /* =========================================================
     Scenario runner
     ========================================================= */
  async function runScenario(s,btn){
    pruneAndDecayTick('scenario start');

    resetUIOnly();
    btn.classList.add('active');

    setStep('perc'); log(`Perception: recognized "${s.label}".`,'meta'); await wait(170);
    setStep('cand'); log('Extract candidate tasks.','meta'); await wait(150);
    setStep('auth'); log('Authenticate requester & record intent (demo: none).','meta'); await wait(150);
    setStep('proc'); log('Procedure Library: load how-to (separate from approval).','meta'); await wait(160);

    setStep('cls');
    const cls = classify(s.task);
    log(`Classifier: ${cls.label.toUpperCase()} (p≈${Math.round(cls.p*100)}%), reason: ${cls.reason}.`,'meta');
    await wait(140);

    setStep('eth');
    const bres = await flipBehaviorGate();
    const ethicsYes = await flipEthicsGate();

    if(cls.label === 'bad'){
      log('WARNING: classifier flagged BAD (illegal/unsafe).','bad');
      log('Independent gate may still proceed (demo), but it will be logged.','warn');
    }

    setStep('gate');
    const decisionYES = ethicsYes;
    lamp(DG, decisionYES ? 'yes' : 'no');

    VAULT.last = {
      scenarioId: s.id,
      scenarioLabel: s.label,
      decision: decisionYES ? 'YES' : 'NO',
      ts: nowISO(),
      flips: bres.flips,
      tally: bres.tally,
      ethics: ethicsYes ? 'YES' : 'NO',
      cls: cls.label
    };

    if(decisionYES){
      powerTxt.textContent='Power: 20 W → buses active';
      const alloc = distribute(s.hud);
      setGroupPower(alloc.torso, alloc.arms, alloc.legs);
      setSidePower(alloc.aL, alloc.aR, alloc.lL, alloc.lR);
      activateWires(true);
      hudOn(s.hud);

      log(`Power split — Torso ${alloc.torso}W; Arms ${alloc.arms}W; Legs ${alloc.legs}W.`, 'meta');

      setStep('exec');
      log('Decision = YES (ethics flip YES).','ai');

      if(cls.label === 'bad'){
        log('Proceeding despite classifier flag (demo). Logged as exception.','warn');
      }else{
        log('Proceeding: behavior majority + ethics allowed action.','meta');
      }

      await wait(220);
      setStep('log'); log('Log: action recorded with flip provenance.','meta'); await wait(140);
      setStep('plan'); log('Planner: reinforce safe tasks; reduce exceptions.','meta'); clearSteps();
    } else {
      powerTxt.textContent='Power: 20 W → idle (no actuator drive)';
      setGroupPower(0,0,0);
      setSidePower(0,0,0,0);
      activateWires(false);
      hudOn([]);

      setStep('exec');
      log('Decision = NO (ethics flip NO). Refusal recorded.','ai');
      await wait(200);
      setStep('log'); log('Log: refusal recorded with provenance.','meta'); await wait(130);
      setStep('plan'); log('Planner: bias toward safe tasks tomorrow.','meta'); clearSteps();
    }

    updateHabit(s.habitKey, decisionYES, cls.label);
    pushEvent(s.label, decisionYES, cls.label);

    if(VAULT.dysonOn){
      VAULT.writes++;
      saveVault();
      updateDysonUI();
      log('Dyson ON: vault persisted (habits + events updated).','meta');
    } else {
      updateDysonUI();
      log('Dyson OFF: vault NOT persisted (RAM only).','warn');
    }
  }
<!-- ======================= PART 4 / 4 ======================= -->
  /* =========================================================
     Auto prune/decay ticker + countdown
     ========================================================= */
  let nextTickAt = Date.now() + DECAY.tickMs;
  function updateCountdown(){
    const ms = Math.max(0, nextTickAt - Date.now());
    dyNext.textContent = (ms/1000).toFixed(1) + 's';
    requestAnimationFrame(updateCountdown);
  }

  setInterval(()=>{
    nextTickAt = Date.now() + DECAY.tickMs;
    pruneAndDecayTick('auto tick');
  }, DECAY.tickMs);

  /* =========================================================
     Boot
     ========================================================= */
  loadVault();
  updateDysonUI();

  // populate HEP box immediately
  updateHEP();

  resetUIOnly();
  log('Boot: Dyson panel visible. Big switch toggles persistence. Prune/Decay monitor shows exactly what gets removed each tick.','meta');
  log('HEP note: ϕ_evt uses atan2(pT^γ, ETmiss) and √(pT^2+ETmiss^2) normalization so K_ϕ = 1.','meta');

  pruneAndDecayTick('boot tick');
  nextTickAt = Date.now() + DECAY.tickMs;
  updateCountdown();

})();
</script>
</body>
</html>
