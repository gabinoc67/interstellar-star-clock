<!-- ======================= PART 1 / 4 ======================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UFO Warp Bubble + CST Dilation Concept (Fixed)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(900px 520px at 30% -10%, rgba(96,165,250,.16), transparent 60%),
      radial-gradient(700px 520px at 95% 0%, rgba(52,211,153,.10), transparent 55%),
      radial-gradient(circle at top, #020617 0, #000 60%, #000 100%);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1260px;margin:0 auto;padding:18px 14px 36px}
  header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.25rem;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}
  .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(11,18,34,.65));
    padding:6px 10px;border-radius:999px;font-size:.85rem;color:var(--muted);
  }

  .grid{display:grid;grid-template-columns: 470px 1fr;gap:14px}
  @media (max-width: 1040px){ .grid{grid-template-columns:1fr} .pillrow{justify-content:flex-start} }

  .card{
    background:linear-gradient(135deg, rgba(15,23,42,.96), rgba(11,18,34,.86));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:14px;
  }
  .card h2{margin:0 0 10px;font-size:1.03rem}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{
    flex:1 1 165px;
    border:1px solid var(--line);
    background:rgba(2,6,23,.35);
    border-radius:14px;
    padding:10px;
    min-width:165px;
  }
  .kpi .label{color:var(--muted);font-size:.78rem}
  .kpi .value{font-family:var(--mono);font-size:1.00rem;margin-top:6px}
  .kpi .hint{color:var(--muted);font-size:.76rem;margin-top:6px;line-height:1.25}

  .controls .group{margin-top:10px;padding-top:10px;border-top:1px solid var(--line)}
  .controls label{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:.85rem}
  .controls input[type="range"]{width:100%}
  .controls input[type="checkbox"]{transform:scale(1.1)}
  .btns{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  button{
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(96,165,250,.22), rgba(15,23,42,.78));
    color:var(--ink);
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
    font-weight:800;
  }
  button:active{transform:translateY(1px)}
  .ghost{background:linear-gradient(180deg, rgba(148,163,184,.10), rgba(15,23,42,.78));color:var(--muted)}
  .danger{background:linear-gradient(180deg, rgba(251,113,133,.18), rgba(15,23,42,.78))}
  .warnBtn{background:linear-gradient(180deg, rgba(251,191,36,.14), rgba(15,23,42,.78))}

  .stageTop{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;margin-bottom:12px}
  .mini{
    flex:1 1 220px;border:1px solid var(--line);background:rgba(2,6,23,.35);
    border-radius:14px;padding:10px;
  }
  .mini .t{color:var(--muted);font-size:.82rem;margin-bottom:6px}
  .mini .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.16);overflow:hidden;border:1px solid rgba(148,163,184,.18)}
  .mini .fill{height:100%;width:0%}
  .mini .v{font-family:var(--mono);margin-top:6px;font-size:.95rem}

  .canvasWrap{
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    background:
      radial-gradient(900px 420px at 55% 40%, rgba(96,165,250,.14), transparent 55%),
      radial-gradient(620px 340px at 35% 65%, rgba(251,191,36,.10), transparent 60%),
      rgba(2,6,23,.35);
    position:relative;
  }
  canvas{display:block;width:100%}
  #cv{height:520px}
  #map{height:74px;border-top:1px solid rgba(148,163,184,.18)}
  #plot{height:160px;border-top:1px solid rgba(148,163,184,.18)}

  .legend{
    position:absolute; left:12px; bottom:250px;
    display:flex; gap:10px; flex-wrap:wrap;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.18);
    padding:8px 10px; border-radius:14px;
    color:var(--muted); font-size:.82rem;
  }
  .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
  .dot.good{background:var(--good)}
  .dot.warn{background:var(--warn)}
  .dot.bad{background:var(--bad)}
  .dot.accent{background:var(--accent)}

  .note{color:var(--muted);font-size:.92rem;line-height:1.35}
  .note code{font-family:var(--mono);font-size:.92em;color:#c7d2fe}
  .callout{
    margin-top:10px;border-left:3px solid rgba(96,165,250,.55);
    padding:10px 12px;background:rgba(96,165,250,.08);
    border-radius:12px;color:var(--muted);line-height:1.35;font-size:.92rem;
  }
  .eqBox{
    border:1px solid var(--line);
    background:rgba(2,6,23,.35);
    border-radius:14px;
    padding:10px;
    margin-top:10px;
    color:var(--muted);
    line-height:1.35;
    font-size:.90rem;
  }
  .eqBox b{color:var(--ink)}
  .eq{font-family:var(--mono);font-size:.90rem;color:#c7d2fe;white-space:pre-wrap}

  /* error overlay */
  #err{
    display:none;
    margin-top:10px;
    border:1px solid rgba(251,113,133,.35);
    background:rgba(251,113,133,.10);
    border-radius:14px;
    padding:10px;
    color:var(--ink);
  }
  #err pre{
    margin:8px 0 0;
    font-family:var(--mono);
    font-size:.85rem;
    color:#ffd1d9;
    white-space:pre-wrap;
  }

  dialog{
    border:1px solid var(--line);
    border-radius:16px;
    background:linear-gradient(135deg, rgba(15,23,42,.96), rgba(11,18,34,.92));
    color:var(--ink);
    padding:14px;
    width:min(860px, 92vw);
  }
  dialog::backdrop{background:rgba(0,0,0,.55)}
  textarea{
    width:100%;
    min-height:260px;
    border:1px solid rgba(148,163,184,.22);
    border-radius:12px;
    background:rgba(2,6,23,.35);
    color:var(--ink);
    font-family:var(--mono);
    font-size:.88rem;
    padding:10px;
    outline:none;
    resize:vertical;
  }
  .dlgRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>UFO Warp Bubble + CST Dilation Concept Simulator (Fixed)</h1>
      <div class="sub">
        Clean build: warp bubble + magnetic shield (visual), tile blinking, map hit-logging, desync plot, print report.
      </div>
    </div>
    <div class="pillrow">
      <div class="pill">Working build</div>
      <div class="pill">Bubble + shield</div>
      <div class="pill">Map + report</div>
    </div>
  </header>

  <div class="grid">
    <section class="card controls">
      <h2>Control Panel</h2>

      <div class="row">
        <div class="kpi">
          <div class="label">Energy input (toy)</div>
          <div class="value" id="kEnergy">0</div>
          <div class="hint">Toy energy scale for visualization.</div>
        </div>
        <div class="kpi">
          <div class="label">Mass-equivalent (kg)</div>
          <div class="value" id="kMassEq">0</div>
          <div class="hint"><code>m = E/c²</code> shown as “field energy mass-equivalent.”</div>
        </div>
      </div>

      <div class="group">
        <label><span>Energy input</span><span class="value" id="sEnergy">50</span></label>
        <input id="energy" type="range" min="0" max="100" value="50" />
      </div>

      <div class="group">
        <label><span>Conversion activity %</span><span class="value" id="sConv">12%</span></label>
        <input id="conv" type="range" min="0" max="100" value="12" />
      </div>

      <div class="group">
        <label><span>EM field strength</span><span class="value" id="sField">40</span></label>
        <input id="field" type="range" min="0" max="100" value="40" />
      </div>

      <div class="group">
        <label><span>Time dilation factor</span><span class="value" id="sTime">1.20×</span></label>
        <input id="timeF" type="range" min="80" max="340" value="120" />
      </div>

      <div class="group">
        <label><span>CST phase-lock strength</span><span class="value" id="sLock">0.30</span></label>
        <input id="lock" type="range" min="0" max="100" value="30" />
      </div>

      <div class="group">
        <label><span>Bubble curvature amplitude</span><span class="value" id="sCurv">0.42</span></label>
        <input id="curv" type="range" min="0" max="100" value="42" />
      </div>

      <div class="group">
        <label><span>Bubble radius</span><span class="value" id="sRadB">1.15×</span></label>
        <input id="bRad" type="range" min="80" max="160" value="115" />
      </div>

      <div class="group">
        <label><span>Magnetic shield strength</span><span class="value" id="sShield">0.65</span></label>
        <input id="shield" type="range" min="0" max="100" value="65" />
      </div>

      <div class="group">
        <label><span>External disturbance</span><span class="value" id="sDisturb">18</span></label>
        <input id="disturb" type="range" min="0" max="100" value="18" />
      </div>

      <div class="group">
        <label><span>Wobble sensitivity</span><span class="value" id="sWob">0.60</span></label>
        <input id="wobble" type="range" min="0" max="100" value="60" />
      </div>

      <div class="group">
        <label><span>Stabilization</span><span class="value" id="sStab">0.55</span></label>
        <input id="stab" type="range" min="0" max="100" value="55" />
      </div>

      <div class="group">
        <label><span>Radiation / exhaust</span><span class="value" id="sRad">25</span></label>
        <input id="rad" type="range" min="0" max="100" value="25" />
      </div>

      <div class="group">
        <label>
          <span><input id="autoBlink" type="checkbox" checked /> Auto blink on threshold</span>
          <span class="value" id="sThresh">TH: 65</span>
        </label>
        <input id="thresh" type="range" min="10" max="95" value="65" />
      </div>

      <div class="group">
        <label><span>Distance A→B (ly proxy)</span><span class="value" id="sDist">4.2 ly</span></label>
        <input id="dist" type="range" min="1" max="500" value="42" />
      </div>

      <div class="btns">
        <button id="btnStart">Start</button>
        <button class="ghost" id="btnPause">Pause</button>
        <button class="ghost" id="btnReset">Reset</button>
        <button class="warnBtn" id="btnReport">Print Report</button>
      </div>

      <div class="callout">
        Status: <b id="statusText">Ready</b><br/>
        If anything fails, the error box below will show the exact error.
      </div>

      <div id="err">
        <b>Script error</b>
        <pre id="errText"></pre>
      </div>

      <div class="group">
        <h2 style="margin:2px 0 10px;font-size:1.03rem">Clock + Field Stack</h2>
        <div class="row">
          <div class="kpi">
            <div class="label">External clock</div>
            <div class="value" id="cExt">00:00:00.000</div>
            <div class="hint">Outside observation reference time.</div>
          </div>
          <div class="kpi">
            <div class="label">Internal clock</div>
            <div class="value" id="cInt">00:00:00.000</div>
            <div class="hint">Scaled by dilation + field boost (visual).</div>
          </div>
          <div class="kpi">
            <div class="label">CST clock</div>
            <div class="value" id="cCst">00:00:00.000</div>
            <div class="hint">Phase-locks toward internal time (stability).</div>
          </div>
          <div class="kpi">
            <div class="label">Desync (Int − Ext)</div>
            <div class="value" id="cDesync">0.000 s</div>
            <div class="hint">Shown in the plot.</div>
          </div>
          <div class="kpi">
            <div class="label">Space compression proxy</div>
            <div class="value" id="cSpace">0%</div>
            <div class="hint">Toy proxy linked to dilation + curvature.</div>
          </div>
          <div class="kpi">
            <div class="label">Total tile hits</div>
            <div class="value" id="cHits">0</div>
            <div class="hint">Count of over-threshold events.</div>
          </div>
        </div>

        <div class="eqBox">
          <b>Alcubierre-style metric (concept)</b>
          <div class="eq">
ds² = -c² dt² + (dx - vₛ f(rₛ) dt)² + dy² + dz²
          </div>
          <b>Budget focus (inverse form)</b>
          <div class="eq">m = E / c²</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Visualization Stage</h2>

      <div class="stageTop">
        <div class="mini">
          <div class="t">Field loading</div>
          <div class="bar"><div class="fill" id="barField"></div></div>
          <div class="v" id="vField">0%</div>
        </div>
        <div class="mini">
          <div class="t">Conversion</div>
          <div class="bar"><div class="fill" id="barConv"></div></div>
          <div class="v" id="vConv">0%</div>
        </div>
        <div class="mini">
          <div class="t">Bubble strength</div>
          <div class="bar"><div class="fill" id="barBubble"></div></div>
          <div class="v" id="vBubble">0%</div>
        </div>
        <div class="mini">
          <div class="t">Perception gap</div>
          <div class="bar"><div class="fill" id="barGap"></div></div>
          <div class="v" id="vGap">0%</div>
        </div>
      </div>

      <div class="canvasWrap">
        <canvas id="cv" width="1100" height="520"></canvas>
        <canvas id="map" width="1100" height="74"></canvas>
        <canvas id="plot" width="1100" height="160"></canvas>

        <div class="legend">
          <span><span class="dot accent"></span>EM tile</span>
          <span><span class="dot good"></span>Stable</span>
          <span><span class="dot warn"></span>High</span>
          <span><span class="dot bad"></span>Blink over TH</span>
        </div>
      </div>

      <dialog id="dlgReport">
        <h2 style="margin:0 0 10px;font-size:1.05rem">Mini Report (copy/print)</h2>
        <textarea id="reportText" spellcheck="false"></textarea>
        <div class="dlgRow">
          <button class="ghost" id="btnCopy">Copy</button>
          <button class="warnBtn" id="btnPrintNow">Print</button>
          <button class="danger" id="btnCloseDlg">Close</button>
        </div>
      </dialog>
<!-- ======================= PART 2 / 4 ======================= -->
<script>
(() => {
  // Error catcher so you SEE what's wrong if something ever breaks
  window.addEventListener("error", (e)=>{
    const box = document.getElementById("err");
    const pre = document.getElementById("errText");
    box.style.display = "block";
    pre.textContent = (e && e.error && e.error.stack) ? e.error.stack : (e.message || String(e));
  });

  const C = 299792458;
  const C2 = C*C;

  const $ = (id)=>document.getElementById(id);

  const cv = $("cv"), ctx = cv.getContext("2d");
  const mv = $("map"), mctx = mv.getContext("2d");
  const pv = $("plot"), pctx = pv.getContext("2d");

  const sliders = {
    energy:$("energy"), conv:$("conv"), field:$("field"),
    timeF:$("timeF"), lock:$("lock"),
    curv:$("curv"), bRad:$("bRad"), shield:$("shield"), disturb:$("disturb"),
    wobble:$("wobble"), stab:$("stab"), rad:$("rad"),
    thresh:$("thresh"), dist:$("dist")
  };
  const flags = { autoBlink:$("autoBlink") };

  const dlg = $("dlgReport");
  const reportText = $("reportText");

  let running = false;
  let last = performance.now();

  const state = {
    // sliders
    energy:+sliders.energy.value,
    conv:+sliders.conv.value,
    field:+sliders.field.value,
    timeF:+sliders.timeF.value,
    lock:+sliders.lock.value,
    curv:+sliders.curv.value,
    bRad:+sliders.bRad.value,
    shield:+sliders.shield.value,
    disturb:+sliders.disturb.value,
    wobble:+sliders.wobble.value,
    stab:+sliders.stab.value,
    rad:+sliders.rad.value,
    thresh:+sliders.thresh.value,
    dist:+sliders.dist.value,

    // derived
    energyJ:0,
    fieldE:0,
    mEqKg:0,

    // clocks
    extT:0,
    intT:0,
    cstT:0,

    // buffers
    plotN:420,
    desyncBuf:[],
    cstErrBuf:[],

    // tiles + logs
    tiles:[],
    lastActivities:[],
    lastHot:[],
    hits:[],
    peaks:[],
    totalHits:0
  };

  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function pct(v){ return Math.round(v) + "%"; }

  function fmtSci(n){
    if (!isFinite(n)) return "—";
    if (n === 0) return "0";
    const abs = Math.abs(n);
    if (abs < 1e-3 || abs >= 1e6) return n.toExponential(3);
    return n.toFixed(6).replace(/0+$/,"").replace(/\.$/,"");
  }

  function hmsms(sec){
    sec = Math.max(0, sec);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = Math.floor(sec%60);
    const ms = Math.floor((sec - Math.floor(sec))*1000);
    const pad = (n,len)=>String(n).padStart(len,"0");
    return `${pad(h,2)}:${pad(m,2)}:${pad(s,2)}.${pad(ms,3)}`;
  }

  function setStatus(t){ $("statusText").textContent = t; }

  function buildTiles(){
    const tiles = [];
    tiles.push({name:"Nose",    kind:"major", k:0.95, ax:0.00, ay:-0.12, rr:0.14});
    tiles.push({name:"Inlet L", kind:"major", k:0.82, ax:-0.26,ay:-0.02, rr:0.12});
    tiles.push({name:"Inlet R", kind:"major", k:0.82, ax: 0.26,ay:-0.02, rr:0.12});
    tiles.push({name:"Core",    kind:"major", k:1.00, ax:0.00, ay: 0.10, rr:0.16});
    tiles.push({name:"Belly",   kind:"major", k:0.62, ax:0.00, ay: 0.28, rr:0.14});

    const seg = 12;
    for (let i=0;i<seg;i++){
      const a = (i/seg)*Math.PI*2;
      tiles.push({
        name:`Rim ${i+1}`,
        kind:"rim",
        k:0.55 + 0.20*Math.sin(a*2)*0.5,
        ang:a,
        ax:0, ay:0, rr:0.095
      });
    }
    state.tiles = tiles;
    const n = tiles.length;
    state.lastActivities = new Array(n).fill(0);
    state.lastHot = new Array(n).fill(false);
    state.hits = new Array(n).fill(0);
    state.peaks = new Array(n).fill(0);
    state.totalHits = 0;
  }
  buildTiles();

  function updateLabels(){
    $("sEnergy").textContent = state.energy;
    $("sConv").textContent = state.conv + "%";
    $("sField").textContent = state.field;
    $("sTime").textContent = (state.timeF/100).toFixed(2) + "×";
    $("sLock").textContent = (state.lock/100).toFixed(2);
    $("sCurv").textContent = (state.curv/100).toFixed(2);
    $("sRadB").textContent = (state.bRad/100).toFixed(2) + "×";
    $("sShield").textContent = (state.shield/100).toFixed(2);
    $("sDisturb").textContent = state.disturb;
    $("sWob").textContent = (state.wobble/100).toFixed(2);
    $("sStab").textContent = (state.stab/100).toFixed(2);
    $("sRad").textContent = state.rad;
    $("sThresh").textContent = "TH: " + state.thresh;
    $("sDist").textContent = (state.dist/10).toFixed(1) + " ly";

    $("vField").textContent = pct(state.field);
    $("vConv").textContent  = pct(state.conv);

    // energy mapping (toy): 1e4..1e14
    const mag = state.energy/100;
    const base = Math.pow(10, lerp(4, 14, mag));
    const activity = state.conv/100;

    state.energyJ = base * (0.15 + 0.85*activity);

    const curv = state.curv/100;
    const f = state.field/100;
    state.fieldE = state.energyJ * clamp(0.08 + 0.62*activity + 0.22*curv + 0.18*f, 0, 1);

    state.mEqKg = state.fieldE / C2;

    $("kEnergy").textContent = fmtSci(state.energyJ) + " J";
    $("kMassEq").textContent = fmtSci(state.mEqKg) + " kg";

    // bars
    $("barField").style.width = state.field + "%";
    $("barConv").style.width  = state.conv + "%";

    const bubble = clamp(
      (state.curv)*0.55 + state.field*0.30 + state.conv*0.15 + state.shield*0.20,
      0, 100
    );
    $("barBubble").style.width = bubble + "%";
    $("vBubble").textContent = pct(bubble);

    const dilation = state.timeF/100;
    const wob = state.wobble/100;
    const gap = clamp((dilation-1)*70 + state.field*0.25 + wob*22 + (state.disturb*0.15), 0, 100);
    $("barGap").style.width = gap + "%";
    $("vGap").textContent = pct(gap);

    $("barField").style.background  = `rgba(96,165,250,${0.20 + 0.70*(state.field/100)})`;
    $("barConv").style.background   = `rgba(52,211,153,${0.20 + 0.70*(state.conv/100)})`;
    $("barBubble").style.background = `rgba(96,165,250,${0.18 + 0.70*(bubble/100)})`;
    $("barGap").style.background    = `rgba(148,163,184,${0.20 + 0.65*(gap/100)})`;

    $("cHits").textContent = String(state.totalHits);
  }

  function readSliders(){
    state.energy  = +sliders.energy.value;
    state.conv    = +sliders.conv.value;
    state.field   = +sliders.field.value;
    state.timeF   = +sliders.timeF.value;
    state.lock    = +sliders.lock.value;
    state.curv    = +sliders.curv.value;
    state.bRad    = +sliders.bRad.value;
    state.shield  = +sliders.shield.value;
    state.disturb = +sliders.disturb.value;
    state.wobble  = +sliders.wobble.value;
    state.stab    = +sliders.stab.value;
    state.rad     = +sliders.rad.value;
    state.thresh  = +sliders.thresh.value;
    state.dist    = +sliders.dist.value;
    updateLabels();
  }

  Object.values(sliders).forEach(el => el.addEventListener("input", readSliders));

  $("btnStart").addEventListener("click", ()=>{ running = true; setStatus("Running"); });
  $("btnPause").addEventListener("click", ()=>{ running = false; setStatus("Paused"); });

  $("btnReset").addEventListener("click", ()=>{
    running=false;
    state.extT=0; state.intT=0; state.cstT=0;
    state.desyncBuf=[]; state.cstErrBuf=[];
    buildTiles();
    updateLabels();
    setStatus("Reset");
  });

  function resizeCanvas(canvas){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = Math.floor(rect.width * dpr);
    const h = Math.floor(rect.height * dpr);
    if (canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
  }

  updateLabels();
  setStatus("Ready");
<!-- ======================= PART 3 / 4 ======================= -->
  function updateClocks(dt){
    const dilation = state.timeF/100;
    const lock = state.lock/100;

    state.extT += dt;

    const fieldBoost = 1 + 0.14*(state.field/100) + 0.10*(state.conv/100) + 0.08*(state.curv/100);
    state.intT += dt * dilation * fieldBoost;

    const err = (state.intT - state.cstT);
    const k = 0.7*lock;
    state.cstT += dt*(1.0 + 0.03*(state.field/100)) + err*k*dt;

    const desync = state.intT - state.extT;
    const cstErr = state.cstT - state.intT;

    $("cExt").textContent = hmsms(state.extT);
    $("cInt").textContent = hmsms(state.intT);
    $("cCst").textContent = hmsms(state.cstT);
    $("cDesync").textContent = (desync>=0?"+":"") + desync.toFixed(3) + " s";

    const space = clamp((dilation-1)*60 + (state.field/100)*25 + (state.conv/100)*15 + (state.curv/100)*30, 0, 260);
    $("cSpace").textContent = Math.round(space) + "%";

    const N = state.plotN;
    state.desyncBuf.push(desync);
    state.cstErrBuf.push(cstErr);
    if (state.desyncBuf.length > N){ state.desyncBuf.shift(); state.cstErrBuf.shift(); }
  }

  function computeTileActivities(simT, uW, uH){
    const tiles = state.tiles;
    const threshold = state.thresh;

    const rimRX = uW*0.50;
    const rimRY = uH*0.27;

    const shield = state.shield/100;
    const disturbEff = (state.disturb/100) * (1 - 0.85*shield);

    for (let i=0;i<tiles.length;i++){
      const t = tiles[i];

      // base activity
      const noise = 0.5 + 0.5*Math.sin(simT*(1.2 + i*0.14) + i*0.7);
      const activity = clamp(
        (state.field*(t.k || 0.6))*0.74 +
        (state.conv)*0.16 +
        (state.curv)*0.12 +
        (state.wobble)*0.06 +
        (disturbEff*25) +
        10*noise,
        0, 100
      );

      const hot = activity > threshold;
      const wasHot = state.lastHot[i];

      if (hot && !wasHot){
        state.hits[i] += 1;
        state.totalHits += 1;
      }
      state.lastHot[i] = hot;

      state.peaks[i] = Math.max(state.peaks[i], activity);
      state.lastActivities[i] = activity;
    }

    $("cHits").textContent = String(state.totalHits);
  }

  function drawMap(){
    resizeCanvas(mv);
    const w = mv.width, h = mv.height;
    mctx.clearRect(0,0,w,h);

    mctx.fillStyle = "rgba(2,6,23,.22)";
    mctx.fillRect(0,0,w,h);

    mctx.fillStyle = "rgba(154,164,199,.92)";
    mctx.font = `${Math.max(11, 13*(w/1100))}px ui-monospace, Menlo, Consolas, monospace`;
    mctx.fillText("SPACE COMPRESSION MAP • hits per tile (over threshold)", 12*(w/1100), 18*(w/1100));

    const tiles = state.tiles;
    const n = tiles.length;
    const padL = 12*(w/1100), padR = 12*(w/1100);
    const top = 26*(w/1100);
    const boxH = h - top - 10*(w/1100);
    const gap = 4*(w/1100);
    const boxW = (w - padL - padR - gap*(n-1)) / n;

    const threshold = state.thresh;
    const blinkOn = flags.autoBlink.checked && (state.field >= threshold);
    const tSec = state.extT;

    for (let i=0;i<n;i++){
      const x = padL + i*(boxW+gap);
      const y = top;

      const act = state.lastActivities[i] || 0;
      const hot = act > threshold;
      const blink = blinkOn && hot && (Math.sin(tSec*10.5 + i) > 0.2);

      const a = clamp(act/100, 0, 1);
      mctx.fillStyle = blink
        ? `rgba(251,113,133,${0.22 + 0.55*a})`
        : `rgba(96,165,250,${0.10 + 0.55*a})`;

      mctx.fillRect(x, y, boxW, boxH);

      mctx.strokeStyle = "rgba(148,163,184,.20)";
      mctx.strokeRect(x+0.5, y+0.5, boxW-1, boxH-1);

      mctx.fillStyle = "rgba(229,231,235,.88)";
      mctx.font = `${Math.max(11, 13*(w/1100))}px ui-monospace, Menlo, Consolas, monospace`;
      mctx.fillText(String(state.hits[i] || 0), x + 3*(w/1100), y + boxH - 5*(w/1100));
    }
  }

  function drawPlot(){
    resizeCanvas(pv);
    const w = pv.width, h = pv.height;
    pctx.clearRect(0,0,w,h);

    pctx.strokeStyle = "rgba(148,163,184,.22)";
    pctx.lineWidth = 1;
    pctx.strokeRect(0.5,0.5,w-1,h-1);

    const padL = 46, padR = 10, padT = 10, padB = 24;
    const X0 = padL, X1 = w - padR;
    const Y0 = padT, Y1 = h - padB;

    pctx.strokeStyle = "rgba(148,163,184,.18)";
    pctx.beginPath();
    pctx.moveTo(X0, (Y0+Y1)/2);
    pctx.lineTo(X1, (Y0+Y1)/2);
    pctx.stroke();

    const buf = state.desyncBuf;
    if (buf.length < 2){
      pctx.fillStyle = "rgba(154,164,199,.85)";
      pctx.font = `${Math.max(12, 14*(w/1100))}px ui-monospace, Menlo, Consolas, monospace`;
      pctx.fillText("Desync plot: start simulation to record drift", X0+8, Y0+18);
      return;
    }

    let maxAbs = 0.001;
    for (const v of buf) maxAbs = Math.max(maxAbs, Math.abs(v));
    maxAbs *= 1.15;

    const mapX = (i)=> X0 + (i/(buf.length-1))*(X1-X0);
    const mapY = (v)=> {
      const t = (v + maxAbs)/(2*maxAbs);
      return Y1 - t*(Y1-Y0);
    };

    // desync
    pctx.strokeStyle = "rgba(96,165,250,.85)";
    pctx.lineWidth = 2;
    pctx.beginPath();
    pctx.moveTo(mapX(0), mapY(buf[0]));
    for (let i=1;i<buf.length;i++) pctx.lineTo(mapX(i), mapY(buf[i]));
    pctx.stroke();

    // CST error
    const eb = state.cstErrBuf;
    pctx.strokeStyle = "rgba(52,211,153,.75)";
    pctx.lineWidth = 1.8;
    pctx.beginPath();
    pctx.moveTo(mapX(0), mapY(eb[0]));
    for (let i=1;i<eb.length;i++) pctx.lineTo(mapX(i), mapY(eb[i]));
    pctx.stroke();

    pctx.fillStyle = "rgba(154,164,199,.9)";
    pctx.font = `${Math.max(11, 13*(w/1100))}px ui-monospace, Menlo, Consolas, monospace`;
    pctx.fillText(`Desync (Int−Ext), range ±${maxAbs.toFixed(3)} s`, X0+6, h-7);
  }
<!-- ======================= PART 4 / 4 ======================= -->
  function makeReportText(){
    const dilation = state.timeF/100;
    const lock = state.lock/100;
    const curv = state.curv/100;
    const shield = state.shield/100;
    const bRad = state.bRad/100;

    const space = clamp((dilation-1)*60 + (state.field/100)*25 + (state.conv/100)*15 + curv*30, 0, 260);
    const distLy = state.dist/10;
    const effDist = distLy / (1 + space/100);

    const lines = [];
    lines.push("UFO WARP BUBBLE + CST DILATION — CONCEPT MINI REPORT");
    lines.push("====================================================");
    lines.push(`Timestamp (ext): ${hmsms(state.extT)}`);
    lines.push("");
    lines.push("FIELD / BUDGET (visual proxies)");
    lines.push("------------------------------");
    lines.push(`Energy input (toy):     ${fmtSci(state.energyJ)} J`);
    lines.push(`Field energy (toy):     ${fmtSci(state.fieldE)} J`);
    lines.push(`Mass-equivalent:        m = E/c² = ${fmtSci(state.mEqKg)} kg`);
    lines.push("");
    lines.push("CLOCK STACK");
    lines.push("-----------");
    lines.push(`External:               ${hmsms(state.extT)}`);
    lines.push(`Internal:               ${hmsms(state.intT)}`);
    lines.push(`CST:                    ${hmsms(state.cstT)}`);
    lines.push(`Desync (Int-Ext):       ${(state.intT-state.extT).toFixed(3)} s`);
    lines.push("");
    lines.push("BUBBLE / SHIELD (visual proxies)");
    lines.push("-------------------------------");
    lines.push(`Dilation factor:        ${dilation.toFixed(2)}×`);
    lines.push(`CST lock strength:      ${lock.toFixed(2)}`);
    lines.push(`Curvature amplitude:    ${curv.toFixed(2)}`);
    lines.push(`Bubble radius:          ${bRad.toFixed(2)}×`);
    lines.push(`Magnetic shield:        ${shield.toFixed(2)}`);
    lines.push(`Disturbance:            ${state.disturb}%`);
    lines.push("");
    lines.push("SPACE COMPRESSION (proxy)");
    lines.push("-------------------------");
    lines.push(`Space compression:      ${Math.round(space)}%`);
    lines.push(`Distance A→B:           ${distLy.toFixed(1)} ly`);
    lines.push(`Effective distance:     ${effDist.toFixed(2)} ly`);
    lines.push("");
    lines.push("TILE THRESHOLD LOG (hits, peak %)");
    lines.push("--------------------------------");
    lines.push(`Threshold: ${state.thresh}%   Total hits: ${state.totalHits}`);
    lines.push("");
    for (let i=0;i<state.tiles.length;i++){
      const name = state.tiles[i].name.padEnd(8," ");
      const hits = String(state.hits[i]).padStart(3," ");
      const peak = (state.peaks[i]||0).toFixed(1).padStart(6," ");
      lines.push(`${name}  hits=${hits}  peak=${peak}%`);
    }
    lines.push("");
    lines.push("NOTES");
    lines.push("-----");
    lines.push("- Concept visualization; not a validated physics engine.");
    lines.push("- Bubble + shield represent a protective time/space/EM envelope (visual).");
    return lines.join("\n");
  }

  $("btnReport").addEventListener("click", ()=>{
    reportText.value = makeReportText();
    if (!dlg.open) dlg.showModal();
  });
  $("btnCloseDlg").addEventListener("click", ()=> dlg.close());
  $("btnCopy").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(reportText.value); setStatus("Report copied"); }
    catch(e){ setStatus("Copy failed (permission)"); }
    setTimeout(()=> setStatus(running?"Running":"Paused"), 900);
  });
  $("btnPrintNow").addEventListener("click", ()=>{
    const w = window.open("", "_blank");
    const safe = reportText.value.replace(/[<>&]/g, s=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[s]));
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">
      <title>UFO Concept Report</title>
      <style>body{font-family:ui-monospace,Menlo,Consolas,monospace;padding:18px}pre{white-space:pre-wrap}</style>
      </head><body><pre>${safe}</pre><script>window.print();</script></body></html>`);
    w.document.close();
  });

  function drawUFO(now){
    resizeCanvas(cv);
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);

    const cx = w*0.55;
    const cy = h*0.48;

    const simT = state.extT;

    const f = state.field/100;
    const conv = state.conv/100;
    const curv = state.curv/100;
    const shield = state.shield/100;
    const disturbEff = (state.disturb/100) * (1 - 0.85*shield);
    const wob = state.wobble/100;
    const stab = state.stab/100;
    const rad = state.rad/100;

    const wobMult = (0.65 + 0.90*wob) * (1 + 0.90*disturbEff) * (1 - 0.55*stab) * (1 - 0.35*shield);
    const wobX = Math.sin(simT*2.2) * (10 + 26*wobMult) * (w/1100);
    const wobY = Math.cos(simT*1.7) * (7 + 18*wobMult) * (w/1100);
    const roll = Math.sin(simT*1.3) * (0.06 + 0.18*wobMult);

    const scale = (w/1100);
    const uW = 560*scale;
    const uH = 240*scale;

    // Update tile activities (also logs hits)
    computeTileActivities(simT, uW, uH);

    // bubble strength proxy
    const bubble = clamp(curv*0.55 + f*0.30 + conv*0.15 + shield*0.20, 0, 1);
    const bubbleR = (state.bRad/100);

    // bubble + shield
    ctx.save();
    ctx.translate(cx+wobX*0.75, cy+wobY*0.75);
    ctx.rotate(roll*0.45);

    const bx = uW*0.78*bubbleR;
    const by = uH*0.55*bubbleR;

    const haloR = Math.max(bx, by) * (1.15 + 0.35*bubble);
    const bg = ctx.createRadialGradient(0,0, haloR*0.12, 0,0, haloR);
    bg.addColorStop(0, `rgba(96,165,250,${0.06 + 0.28*bubble + 0.20*curv})`);
    bg.addColorStop(0.55, `rgba(96,165,250,${0.04 + 0.18*bubble})`);
    bg.addColorStop(1, `rgba(96,165,250,0)`);
    ctx.fillStyle = bg;
    ctx.beginPath();
    ctx.ellipse(0,0, bx*1.25, by*1.25, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.lineWidth = (2 + 5*shield)*scale;
    ctx.strokeStyle = `rgba(52,211,153,${0.10 + 0.35*shield + 0.15*bubble})`;
    ctx.beginPath();
    ctx.ellipse(0,0, bx, by, 0, 0, Math.PI*2);
    ctx.stroke();

    ctx.restore();

    // UFO body
    ctx.save();
    ctx.translate(cx+wobX, cy+wobY);
    ctx.rotate(roll);

    ctx.fillStyle = "rgba(148,163,184,.10)";
    ctx.strokeStyle = "rgba(148,163,184,.26)";
    ctx.lineWidth = 2*scale;
    ctx.beginPath();
    ctx.ellipse(0, 0, uW*0.56, uH*0.32, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    ctx.strokeStyle = `rgba(96,165,250,${0.18 + 0.45*f})`;
    ctx.lineWidth = 3*scale;
    ctx.beginPath();
    ctx.ellipse(0, 0, uW*0.58, uH*0.34, 0, 0, Math.PI*2);
    ctx.stroke();

    // dome
    ctx.fillStyle = "rgba(148,163,184,.14)";
    ctx.strokeStyle = "rgba(148,163,184,.28)";
    ctx.lineWidth = 2*scale;
    ctx.beginPath();
    ctx.ellipse(0,-uH*0.18, uW*0.22, uH*0.18, 0, Math.PI, 0, true);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // underside
    ctx.fillStyle = "rgba(15,23,42,.55)";
    ctx.strokeStyle = "rgba(148,163,184,.22)";
    ctx.lineWidth = 1.6*scale;
    ctx.beginPath();
    ctx.ellipse(0, uH*0.18, uW*0.35, uH*0.18, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    // tiles
    const threshold = state.thresh;
    const blinkOn = flags.autoBlink.checked && (state.field >= threshold);

    const rimRX = uW*0.50;
    const rimRY = uH*0.27;

    for (let i=0;i<state.tiles.length;i++){
      const t = state.tiles[i];
      let tx = t.ax * uW;
      let ty = t.ay * uH;
      let rr = t.rr * uW;

      if (t.kind === "rim"){
        const a = t.ang;
        tx = Math.cos(a)*rimRX;
        ty = Math.sin(a)*rimRY;
        rr = (0.085 + 0.02*Math.sin(a*3))*uW;
      }

      const activity = state.lastActivities[i] || 0;
      const hot = activity > threshold;
      const blink = blinkOn && hot && (Math.sin(simT*10.5 + i) > 0.2);

      ctx.lineWidth = 2.2*scale;
      ctx.strokeStyle = `rgba(96,165,250,${0.16 + 0.50*(activity/100)})`;
      ctx.beginPath();
      ctx.arc(tx, ty, rr, 0, Math.PI*2);
      ctx.stroke();

      if (blink){
        ctx.fillStyle = `rgba(251,113,133,${0.18 + 0.55*(activity/100)})`;
        ctx.beginPath();
        ctx.arc(tx, ty, rr*0.96, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // exhaust cone
    const baseDir = Math.PI/2;
    const dir = baseDir + Math.sin(simT*(2.0 + 3.0*wobMult))*(0.45*wobMult);
    const coneWidth = (0.95 - 0.75*stab - 0.25*shield) * (0.18 + 0.55*wobMult);
    const plume = (0.05 + 0.90*rad) * (0.25 + 0.75*conv);

    if (plume > 0.02){
      const len = uH*(0.50 + 1.10*plume);
      const w0  = uW*(0.04 + 0.10*plume);
      const w1  = uW*(0.12 + 0.28*plume) * (1 + coneWidth);

      ctx.save();
      ctx.translate(0, uH*0.28);
      ctx.rotate(dir - Math.PI/2);

      const pg = ctx.createRadialGradient(0, 0, 1, 0, len*0.70, len*1.2);
      pg.addColorStop(0, `rgba(251,191,36,${0.10 + 0.55*plume})`);
      pg.addColorStop(0.55, `rgba(251,191,36,${0.06 + 0.25*plume})`);
      pg.addColorStop(1, `rgba(251,191,36,0)`);
      ctx.fillStyle = pg;

      ctx.beginPath();
      ctx.moveTo(-w0, 0);
      ctx.lineTo(-w1, len);
      ctx.lineTo( w1, len);
      ctx.lineTo( w0, 0);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
    }

    ctx.restore();

    // HUD
    ctx.save();
    ctx.fillStyle = "rgba(229,231,235,.75)";
    ctx.font = `${Math.max(12, 14*(w/1100))}px ui-monospace, Menlo, Consolas, monospace`;
    ctx.fillText(`Field E: ${fmtSci(state.fieldE)} J   m=E/c²: ${fmtSci(state.mEqKg)} kg`, 16*(w/1100), 24*(w/1100));
    ctx.fillText(`Hits(total): ${state.totalHits}   Threshold: ${state.thresh}%`, 16*(w/1100), 42*(w/1100));
    ctx.restore();
  }

  function tick(now){
    const dt = Math.min(0.05, Math.max(0, (now - last)/1000));
    last = now;

    if (running){
      updateClocks(dt);
    }
    updateLabels();
    drawUFO(now);
    drawMap();
    drawPlot();

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  window.addEventListener("resize", ()=>{ last = performance.now(); });

  setStatus("Ready");
})();
</script>

</section>
</div> <!-- grid -->
</div> <!-- wrap -->
</body>
</html>
