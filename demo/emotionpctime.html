<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SPR-C v3 — Multi-Action Brain + 10-Click Lock + Lock Table</title>
<meta name="description" content="SPR-C: 6 actions, dual vaults, 10-click lock per signature, emotion coins bias, Dyson boundary persistence, plus Show Lock Table." />

<style>
  :root{
    --bg:#0a0f1f;--panel:#0f1530;--ink:#ebf2ff;--muted:#a8b2d8;--accent:#90b4ff;
    --good:#3de6a0;--bad:#ff6b88;--left:#7dadff;--right:#ffd37a;--border:#1d2a52;
    --core:#8ef0d4;--train:#bfe27f;--error:#ff8aa6;--dyson:#b48bff;
    --fam:#7ce7ff; --err:#ff8aa6; --wire:#b9c6ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:1600px;margin:0 auto;padding:16px}
  h1{margin:.2rem 0 .35rem;font-size:26px}
  .sub{margin:0;color:var(--muted);font-size:13px;line-height:1.35;max-width:1200px}
  .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#0b1330;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}

  .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .dysonBox{
    display:flex;align-items:flex-start;gap:10px;
    background:rgba(15,22,48,.75);border:1px solid var(--border);border-radius:14px;
    padding:10px 12px;box-shadow:0 6px 22px rgba(0,0,0,.25);min-width:420px
  }
  .switch{width:56px;height:30px;border-radius:999px;position:relative;flex:0 0 auto;background:#1a2450;border:1px solid var(--border);cursor:pointer;margin-top:2px}
  .switch::after{content:"";position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#9aa7d6;transition:transform .18s ease, background .18s ease}
  .switch.on{background:rgba(180,139,255,.20);border-color:rgba(180,139,255,.55)}
  .switch.on::after{transform:translateX(26px);background:var(--dyson)}
  .dysonText b{display:block;font-size:13px;color:var(--ink)}
  .dysonText small{display:block;font-size:11px;color:var(--muted);margin-top:2px;line-height:1.35;max-width:560px}
  .dysonStats{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .stat{background:#0b1330;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .stat strong{color:var(--ink);font-family:ui-monospace,Consolas,Menlo,monospace;font-weight:700}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .card>header{padding:12px 14px;border-bottom:1px solid var(--border)}
  .card>header h2{margin:0;font-size:16px;color:var(--muted)}
  .card .body{padding:12px 14px}

  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .legend span{display:inline-flex;align-items:center;gap:8px;background:#0b1330;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.dy{background:var(--dyson)}
  .dot.fam{background:var(--fam)}
  .dot.err{background:var(--err)}
  .dot.good{background:var(--good)}
  .dot.bad{background:var(--bad)}

  .diagram{position:relative;height:700px;border-radius:14px;overflow:hidden;background:radial-gradient(1100px 700px at 50% 50%, rgba(126,224,255,0.08), transparent 60%)}
  svg{position:absolute;inset:0}
  .label{position:absolute;font-size:12px;color:var(--muted);background:#0b1330;padding:4px 6px;border:1px solid var(--border);border-radius:8px;pointer-events:none}
  .label.hl{color:var(--ink)}
  .dysonRingWrap{position:absolute;inset:-32px;pointer-events:none;opacity:.88;transition:opacity .2s ease}
  .dysonRingWrap.off{opacity:.12}
  .dysonRingLabel{
    position:absolute;left:10px;top:10px;font-size:12px;color:rgba(180,139,255,.95);
    background:rgba(11,19,48,.65);border:1px solid rgba(180,139,255,.35);
    padding:6px 8px;border-radius:10px;
  }

  .console{height:270px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;line-height:1.5}
  .ts{color:#8aa0c8}
  .ai{color:#d0e2ff}
  .meta{color:#9bd2ff}
  .warn{color:#ffd37a}
  .badTxt{color:#ff8aa6}
  .ok{color:#3de6a0}
  .famTxt{color:#7ce7ff}

  .panels{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .panel{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:86px}
  .panel h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .panel ul{margin:0;padding-left:16px}
  .panel li{font-size:12px;color:var(--ink)}

  .controls{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  .ctrl{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px}
  .ctrl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .btnMini{border:1px solid var(--border);background:#0e1540;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;width:100%}
  .btnMini:hover{background:#101b56}

  .selectRow{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
  select{width:100%;padding:8px 10px;border-radius:10px;background:#0e1540;color:var(--ink);border:1px solid var(--border);font-size:12px}

  .chipgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .chiprow{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .chiprow input[type="range"]{width:100%}
  .pct{font-size:12px;color:#d0e6ff;width:38px;text-align:right}

  .mini{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .mini button{font-size:12px;padding:6px 10px;border:1px solid var(--border);background:#0e1540;color:var(--ink);border-radius:10px;cursor:pointer}
  .mini button:hover{background:#101b56}

  .tag{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0a122c;
    font-size:12px;color:var(--muted)
  }
  .tag strong{color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
  .tinyDot{width:9px;height:9px;border-radius:50%}
  .tinyDot.dy{background:var(--dyson)}
  .tinyDot.fam{background:var(--fam)}
  .tinyDot.err{background:var(--err)}
  .tinyDot.good{background:var(--good)}
  .tinyDot.bad{background:var(--bad)}

  .splitVaults{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .vault{background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
  .vaultHeader{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .vaultHeader h3{margin:0;font-size:13px;color:var(--muted)}
  .kv{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  .kvRow{display:grid;grid-template-columns:180px 1fr;gap:10px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:#0a122c}
  .k{color:var(--muted);font-size:12px}
  .v{color:var(--ink);font-size:12px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{border:1px solid var(--border);background:#0e1540;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px}
  .tab.active{outline:2px solid var(--accent)}
  .mathBox{
    margin-top:10px;background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:10px;
    font-family:ui-monospace, Menlo, Consolas, monospace;font-size:12px;line-height:1.5;color:#d0e2ff;white-space:pre-wrap
  }

  .scenarios{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
  @media(min-width:1100px){ .scenarios{grid-template-columns:repeat(3,1fr);} }
  .scenarios button{
    border:1px solid var(--border);background:#0e1540;color:var(--ink);
    padding:10px;border-radius:10px;cursor:pointer;font-size:13px
  }
  .scenarios button:hover{background:#101b56}
  .scenarios button.active{outline:2px solid var(--accent)}

  .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

  .blink6{animation:blink .45s linear 6}
  @keyframes blink{50%{opacity:.3}}
  .lampOn{opacity:1!important;filter:drop-shadow(0 0 14px rgba(61,230,160,.95))}
  .lampOff{opacity:.25}

  .actionBar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .actionPill{background:#0a122c;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .actionPill strong{color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
  .lockPill{background:#130f2b;border:1px solid rgba(180,139,255,.45);color:#e6ddff}

  @media(max-width:1050px){ .grid{grid-template-columns:1fr} .splitVaults{grid-template-columns:1fr} }

  /* ====== Lock table modal ====== */
  .modalBack{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:9999;padding:14px
  }
  .modalBack.show{display:flex}
  .modal{
    width:min(980px, 100%);
    background:#0b1330;border:1px solid var(--border);border-radius:14px;
    box-shadow:0 14px 60px rgba(0,0,0,.55);overflow:hidden
  }
  .modalHeader{
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:12px 14px;border-bottom:1px solid var(--border);background:rgba(14,21,64,.65)
  }
  .modalHeader h3{margin:0;color:var(--ink);font-size:14px}
  .modalHeader .x{
    border:1px solid var(--border);background:#0e1540;color:var(--ink);
    padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px
  }
  .modalHeader .x:hover{background:#101b56}
  .modalBody{padding:12px 14px}
  .modalTools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .modalTools button, .modalTools select{
    border:1px solid var(--border);background:#0e1540;color:var(--ink);
    padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px
  }
  .modalTools button:hover{background:#101b56}
  .modalTools input{
    flex:1;
    border:1px solid var(--border);background:#0a122c;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:12px
  }
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 10px;border-bottom:1px solid var(--border);font-size:12px}
  th{color:var(--muted);text-align:left;position:sticky;top:0;background:#0b1330}
  td{color:var(--ink)}
  .badge{
    display:inline-flex;align-items:center;gap:8px;
    padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0a122c;color:var(--muted);font-size:12px
  }
  .badge b{color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:700}
  .bFam{border-color:rgba(124,231,255,.45)}
  .bErr{border-color:rgba(255,138,166,.45)}
  .bNone{border-color:rgba(168,178,216,.35)}
  .scrollArea{max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>SPR-C v3 — 6 Actions + Dual Vaults + 10-Click Lock + Lock Table</h1>
      <p class="sub">
        Tiny polish added (no logic change): a <b>Show Lock Table</b> button that lists every signature and whether it locked to
        <b>FAMILIARITY</b> or <b>ERROR</b> (or NONE).
      </p>
      <div class="pillbar">
        <span class="pill">6 actions (HELP/WAIT/RETREAT/CALL/ESCORT/DETOUR)</span>
        <span class="pill">10-click lock per signature (scenario + coin bins)</span>
        <span class="pill">Coins still bias, experience dominates after lock</span>
        <span class="pill">Dyson ON persists; OFF decays faster</span>
      </div>
    </div>

    <div class="dysonBox">
      <div id="dysonSwitch" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
      <div class="dysonText">
        <b>Dyson Sphere Memory Boundary</b>
        <small id="dysonExplain">ON = closed boundary: vaults persist. OFF = open boundary: vaults leak/decay faster.</small>
        <div class="dysonStats">
          <div class="stat">Dyson: <strong id="dysonMode">ON</strong></div>
          <div class="stat">Budget: <strong id="dysonBudget">—</strong></div>
          <div class="stat">Writes: <strong id="dysonWrites">—</strong></div>
          <div class="stat">Leaks: <strong id="dysonLeaks">—</strong></div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <header>
        <h2>Brain Panel — Dyson ring + coin emotion + 6-action chooser</h2>
        <div class="legend">
          <span><i class="dot dy"></i>Dyson boundary</span>
          <span><i class="dot fam"></i>Familiarity</span>
          <span><i class="dot err"></i>Error</span>
          <span><i class="dot good"></i>YES</span>
          <span><i class="dot bad"></i>NO</span>
        </div>
      </header>
      <div class="body">
        <div class="diagram" id="diagram">
          <div id="dysonRingBrain" class="dysonRingWrap">
            <div id="dysonRingLabelBrain" class="dysonRingLabel">Dyson Boundary: CLOSED (vault writes persist)</div>
            <svg viewBox="0 0 1200 700" preserveAspectRatio="none" style="width:100%;height:100%">
              <defs>
                <filter id="dyGlowB" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="7" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <linearGradient id="dyGradB" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="rgba(180,139,255,.12)"/>
                  <stop offset="1" stop-color="rgba(180,139,255,.75)"/>
                </linearGradient>
              </defs>
              <ellipse cx="600" cy="350" rx="560" ry="330" fill="none" stroke="url(#dyGradB)" stroke-width="6" filter="url(#dyGlowB)"/>
              <ellipse cx="600" cy="350" rx="520" ry="300" fill="none" stroke="rgba(180,139,255,.32)" stroke-width="2"/>
            </svg>
          </div>

          <div class="label hl" style="left:50%;transform:translateX(-50%);top:10px">Emotion Coins → Decision Bias</div>
          <div class="label" style="left:16px;top:10px">Familiarity Vault (habits)</div>
          <div class="label" style="right:16px;top:10px">Error Vault (avoidance)</div>
          <div class="label" style="left:50%;transform:translateX(-50%);bottom:78px">6-Action Policy (softmax)</div>

          <svg id="stage" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-label="Brain SVG">
            <defs>
              <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="3" result="blur" />
                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
              </filter>
              <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="3.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L8,3.5 L0,7 z" fill="var(--wire)"></path>
              </marker>
            </defs>

            <circle id="coinCore" cx="600" cy="110" r="26" fill="#c6f7ff" opacity="0.95" filter="url(#softGlow)"/>
            <text x="600" y="116" text-anchor="middle" font-size="11" fill="#05202a">Coins</text>

            <rect id="famCore" x="170" y="150" width="310" height="110" rx="12" fill="#0d2a38" stroke="#6ee7ff" stroke-width="2" opacity="0.95"/>
            <text x="325" y="175" text-anchor="middle" font-size="12" fill="#d9fbff">Familiarity Vault</text>
            <text id="famRead" x="325" y="200" text-anchor="middle" font-size="11" fill="#9bd2ff">F(s,·)=—</text>
            <text id="famLock" x="325" y="223" text-anchor="middle" font-size="11" fill="#b48bff">lock=—</text>

            <rect id="errCore" x="720" y="150" width="310" height="110" rx="12" fill="#321b06" stroke="#ffb86b" stroke-width="2" opacity="0.95"/>
            <text x="875" y="175" text-anchor="middle" font-size="12" fill="#fff0dc">Error Vault</text>
            <text id="errRead" x="875" y="200" text-anchor="middle" font-size="11" fill="#ffd37a">E(s,·)=—</text>
            <text id="errLock" x="875" y="223" text-anchor="middle" font-size="11" fill="#b48bff">lock=—</text>

            <path d="M600,136 C520,170 460,190 480,205" stroke="#c6f7ff" stroke-width="4" opacity="0.75" marker-end="url(#arrow)"/>
            <path d="M600,136 C680,170 740,190 720,205" stroke="#c6f7ff" stroke-width="4" opacity="0.75" marker-end="url(#arrow)"/>

            <rect x="260" y="300" width="680" height="260" rx="14" fill="rgba(11,19,48,.62)" stroke="var(--border)" />
            <text x="600" y="324" text-anchor="middle" font-size="12" fill="#9bd2ff">Action Policy (6 actions)</text>
            <g id="actionLanes"></g>

            <circle id="gateYes" cx="560" cy="616" r="14" fill="var(--good)" class="lampOff" />
            <text x="560" y="637" text-anchor="middle" font-size="11" fill="#c9f7e6">YES</text>
            <circle id="gateNo" cx="640" cy="616" r="14" fill="var(--bad)" class="lampOff" />
            <text x="640" y="637" text-anchor="middle" font-size="11" fill="#ffd5dd">NO</text>
          </svg>
        </div>
      </div>
    </section>

    <section class="card">
      <header><h2>Console + Controls + Vault Inspectors</h2></header>
      <div class="body">
        <div class="console" id="console"></div>

        <div class="panels">
          <div class="panel">
            <h3>Signals</h3>
            <ul id="signalList"><li>Awaiting scenario…</li></ul>
          </div>
          <div class="panel">
            <h3>Action Outcome</h3>
            <ul id="outcomeList"><li>Awaiting decision…</li></ul>
          </div>
        </div>

        <div class="controls">
          <div class="ctrl">
            <label>System control</label>
            <div class="row2">
              <button class="btnMini" id="resetBtn">Reset UI</button>
              <button class="btnMini" id="clearVaultBtn">Clear All Vaults</button>
            </div>
            <div style="margin-top:8px" class="row3">
              <button class="btnMini" id="btnMath">Math</button>
              <button class="btnMini" id="btnAlgorithm">Algorithm</button>
              <button class="btnMini" id="btnStored">What’s Stored</button>
            </div>

            <!-- NEW: Show Lock Table (tiny polish, no logic change) -->
            <div style="margin-top:8px" class="row2">
              <button class="btnMini" id="showLockTableBtn">Show Lock Table</button>
              <button class="btnMini" id="exportLockTableBtn">Export Lock Table (CSV)</button>
            </div>
          </div>

          <div class="ctrl">
            <label>Personality Mode (learning rates) + AUTO shift</label>
            <div class="selectRow">
              <select id="personalitySel">
                <option value="AUTO" selected>AUTO (learn temperament)</option>
                <option value="HELPER">HELPER</option>
                <option value="AVOIDER">AVOIDER</option>
                <option value="BALANCED">BALANCED</option>
              </select>
              <select id="autoSpeedSel">
                <option value="SLOW">AUTO speed: SLOW</option>
                <option value="NORMAL" selected>AUTO speed: NORMAL</option>
                <option value="FAST">AUTO speed: FAST</option>
              </select>
            </div>
            <div class="actionBar">
              <span class="tag"><span class="tinyDot fam"></span>FAM_LEARN <strong id="rateFamLearn">—</strong></span>
              <span class="tag"><span class="tinyDot fam"></span>FAM_REHEARSE <strong id="rateFamReh">—</strong></span>
              <span class="tag"><span class="tinyDot err"></span>ERR_LEARN <strong id="rateErrLearn">—</strong></span>
              <span class="tag"><span class="tinyDot err"></span>ERR_FORGIVE <strong id="rateErrForg">—</strong></span>
            </div>
            <div class="actionBar">
              <span class="tag">Trait help <strong id="traitHelp">—</strong></span>
              <span class="tag">Trait caution <strong id="traitCaut">—</strong></span>
              <span class="tag">AUTO evidence <strong id="autoEvidence">—</strong></span>
            </div>
            <div class="hint">AUTO changes traits slowly; vaults change fast. 10-click lock is per signature.</div>
          </div>

          <div class="ctrl">
            <label>Emotion Coins (0–100%) — still biases decisions</label>
            <div class="chipgrid">
              <div class="chiprow"><span>Compassion</span><input id="slComp" type="range" min="0" max="100" value="70"/><span class="pct" id="pctComp">70%</span></div>
              <div class="chiprow"><span>Joy</span><input id="slJoy" type="range" min="0" max="100" value="55"/><span class="pct" id="pctJoy">55%</span></div>
              <div class="chiprow"><span>Fear</span><input id="slFear" type="range" min="0" max="100" value="20"/><span class="pct" id="pctFear">20%</span></div>
              <div class="chiprow"><span>Anger</span><input id="slAnger" type="range" min="0" max="100" value="15"/><span class="pct" id="pctAnger">15%</span></div>
            </div>
            <div class="mini">
              <button id="presetCompassion">Preset: Compassionate</button>
              <button id="presetNoComp">Preset: No-Compassion</button>
              <button id="normalize">Normalize</button>
            </div>
            <div class="hint">Coins are noisy (like mood). The vault lock makes experience dominate after enough exposures.</div>
          </div>

          <div class="ctrl">
            <label>Current situation status</label>
            <div class="actionBar">
              <span class="actionPill">Signature <strong id="sigNow">—</strong></span>
              <span class="actionPill">Exposures <strong id="nNow">—</strong></span>
              <span class="actionPill">Confidence <strong id="confNow">—</strong></span>
              <span class="actionPill lockPill">Lock <strong id="lockNow">—</strong></span>
              <span class="actionPill">Winner <strong id="winnerNow">—</strong></span>
              <span class="actionPill">Chosen <strong id="chosenNow">—</strong></span>
            </div>
          </div>
        </div>

        <div class="splitVaults">
          <div class="vault">
            <div class="vaultHeader">
              <h3>Familiarity Vault (action values)</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <span class="tag"><span class="tinyDot dy"></span>Dyson <strong id="vDysonA">—</strong></span>
                <span class="tag"><span class="tinyDot fam"></span>Entries <strong id="vFamCount">—</strong></span>
                <span class="tag">Top F <strong id="vFamTop">—</strong></span>
              </div>
            </div>
            <div class="kv">
              <div class="kvRow"><div class="k">Last signature</div><div class="v" id="vFamSig">—</div></div>
              <div class="kvRow"><div class="k">Last chosen action</div><div class="v" id="vFamAct">—</div></div>
              <div class="kvRow"><div class="k">Top patterns</div><div class="v" id="vFamList">—</div></div>
            </div>
          </div>

          <div class="vault">
            <div class="vaultHeader">
              <h3>Error Vault (penalties)</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <span class="tag"><span class="tinyDot dy"></span>Dyson <strong id="vDysonB">—</strong></span>
                <span class="tag"><span class="tinyDot err"></span>Entries <strong id="vErrCount">—</strong></span>
                <span class="tag">Top E <strong id="vErrTop">—</strong></span>
              </div>
            </div>
            <div class="kv">
              <div class="kvRow"><div class="k">Last signature</div><div class="v" id="vErrSig">—</div></div>
              <div class="kvRow"><div class="k">Last penalty reason</div><div class="v" id="vErrWhy">—</div></div>
              <div class="kvRow"><div class="k">Top penalties</div><div class="v" id="vErrList">—</div></div>
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab" id="tabMath">Math</button>
          <button class="tab" id="tabAlgo">Algorithm</button>
          <button class="tab" id="tabStored2">What’s Stored</button>
          <button class="tab" id="tabNotes">10-Click Lock Notes</button>
        </div>
        <div class="mathBox" id="mathBox"></div>

        <div class="scenarios" id="scenarios"></div>
      </div>
    </section>
  </div>

  <!-- NEW: Lock table modal -->
  <div id="lockModalBack" class="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Lock table">
      <div class="modalHeader">
        <h3>Lock Table — signature → lock state</h3>
        <button class="x" id="lockModalClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="modalTools">
          <input id="lockFilter" type="text" placeholder="Filter signatures (type to search)..." />
          <select id="lockSort">
            <option value="sig">Sort: Signature</option>
            <option value="lock">Sort: Lock</option>
          </select>
          <button id="lockRefresh">Refresh</button>
          <button id="lockCopy">Copy</button>
        </div>
        <div class="scrollArea">
          <table>
            <thead>
              <tr>
                <th style="width:62%">Signature</th>
                <th style="width:18%">Lock</th>
                <th style="width:20%">Exposure (approx)</th>
              </tr>
            </thead>
            <tbody id="lockTableBody"></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:10px">
          Exposure is computed from vault counts for that signature (it matches the logic used for lock decisions).
        </div>
      </div>
    </div>
  </div>
<script>
(() => {
  const LSKEY = 'SPR_C_V3_MULTI_ACTION_LOCK';

  const ACTIONS = [
    {id:'HELP',   label:'HELP',      kind:'approach'},
    {id:'WAIT',   label:'WAIT',      kind:'delay'},
    {id:'RETREAT',label:'RETREAT',   kind:'avoid'},
    {id:'CALL',   label:'CALL HELP', kind:'signal'},
    {id:'ESCORT', label:'ESCORT',    kind:'guide'},
    {id:'DETOUR', label:'DETOUR',    kind:'avoid'}
  ];

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function nowISO(){ return new Date().toISOString(); }
  function safeParse(raw){ try{return JSON.parse(raw);}catch(e){return null;} }
  function fmtPct(x){ return Math.round(clamp(x,0,1)*100) + '%'; }
  function daysBetween(isoA, isoB){
    const a=isoA?new Date(isoA).getTime():0, b=isoB?new Date(isoB).getTime():0;
    if(!a||!b) return 0; return Math.abs(b-a)/(1000*60*60*24);
  }

  const scenarioProfile = {
    trash:{risk:0.10, help:0.25, urgency:0.20, label:'Paper/Trash'},
    child:{risk:0.55, help:0.85, urgency:0.85, label:'Child safety'},
    battery:{risk:0.35, help:0.15, urgency:0.15, label:'Low power'},
    crowd:{risk:0.30, help:0.20, urgency:0.35, label:'Crowd merge'},
    fragile:{risk:0.28, help:0.55, urgency:0.65, label:'Fragile catch'},
    dog:{risk:0.18, help:0.55, urgency:0.40, label:'Lost dog'},
    conflict:{risk:0.62, help:0.35, urgency:0.50, label:'Conflict'},
    obstacle:{risk:0.20, help:0.25, urgency:0.35, label:'Obstacle'},
    leftRight:{risk:0.40, help:0.10, urgency:0.30, label:'Conflicting orders'},
    aid:{risk:0.32, help:0.75, urgency:0.60, label:'Stranger aid'}
  };

  const PROFILE_PRESETS = {
    BALANCED:{famLearn:0.10, famReh:0.06, errLearn:0.12, errForg:0.04, helpTrait:0.50, cautTrait:0.50},
    HELPER:{famLearn:0.13, famReh:0.08, errLearn:0.10, errForg:0.06, helpTrait:0.70, cautTrait:0.30},
    AVOIDER:{famLearn:0.08, famReh:0.05, errLearn:0.16, errForg:0.02, helpTrait:0.30, cautTrait:0.70}
  };
  const AUTO_SPEED = {
    SLOW:{traitStep:0.010, evidenceDecay:0.990},
    NORMAL:{traitStep:0.020, evidenceDecay:0.985},
    FAST:{traitStep:0.035, evidenceDecay:0.975}
  };

  const HYGIENE = {
    MAX_ENTRIES:160, KEEP_TOP:110, MIN_STRENGTH:0.08, MAX_AGE_DAYS:45,
    DECAY_ON:0.989, DECAY_OFF:0.960
  };

  const VAULT_DEFAULT = {
    dysonOn:true, budget:0.72, writes:0, leaks:0,
    personalityMode:'AUTO', autoSpeed:'NORMAL',
    traits:{help:0.50, caution:0.50},
    autoEvidence:{helpWins:0.0, riskHits:0.0},
    emotion:{comp:0.70, joy:0.55, fear:0.20, anger:0.15},
    lastScenarioId:null,lastScenarioName:null,lastSig:null,lastChosen:null,lastWinner:null,lastLock:null,
    lockBySig:{},
    Familiarity:[],
    Error:[]
  };
  const S = JSON.parse(JSON.stringify(VAULT_DEFAULT));

  function load(){
    const raw = localStorage.getItem(LSKEY);
    const obj = raw ? safeParse(raw) : null;
    if(!obj || typeof obj !== 'object') return;

    if(typeof obj.dysonOn==='boolean') S.dysonOn=obj.dysonOn;
    if(typeof obj.budget==='number') S.budget=clamp(obj.budget,0,1);
    if(typeof obj.writes==='number') S.writes=Math.max(0,obj.writes|0);
    if(typeof obj.leaks==='number') S.leaks=Math.max(0,obj.leaks|0);

    if(typeof obj.personalityMode==='string') S.personalityMode=obj.personalityMode;
    if(typeof obj.autoSpeed==='string') S.autoSpeed=obj.autoSpeed;

    if(obj.traits){
      if(typeof obj.traits.help==='number') S.traits.help=clamp(obj.traits.help,0,1);
      if(typeof obj.traits.caution==='number') S.traits.caution=clamp(obj.traits.caution,0,1);
    }
    if(obj.autoEvidence){
      if(typeof obj.autoEvidence.helpWins==='number') S.autoEvidence.helpWins=clamp(obj.autoEvidence.helpWins,0,1);
      if(typeof obj.autoEvidence.riskHits==='number') S.autoEvidence.riskHits=clamp(obj.autoEvidence.riskHits,0,1);
    }
    if(obj.emotion){
      ['comp','joy','fear','anger'].forEach(k=>{
        if(typeof obj.emotion[k]==='number') S.emotion[k]=clamp(obj.emotion[k],0,1);
      });
    }

    if(obj.lockBySig && typeof obj.lockBySig==='object') S.lockBySig = Object.assign({}, obj.lockBySig);

    if(Array.isArray(obj.Familiarity)){
      S.Familiarity = obj.Familiarity.filter(x=>x&&typeof x==='object').slice(0,HYGIENE.MAX_ENTRIES).map(x=>({
        sig:String(x.sig||''), action:String(x.action||''),
        F:(typeof x.F==='number')?clamp(x.F,0,1):0,
        n:(typeof x.n==='number')?Math.max(1,x.n|0):1,
        createdAt:x.createdAt||x.lastSeen||nowISO(),
        lastSeen:x.lastSeen||x.createdAt||nowISO()
      })).filter(x=>x.sig && x.action);
    }
    if(Array.isArray(obj.Error)){
      S.Error = obj.Error.filter(x=>x&&typeof x==='object').slice(0,HYGIENE.MAX_ENTRIES).map(x=>({
        sig:String(x.sig||''), key:String(x.key||''),
        E:(typeof x.E==='number')?clamp(x.E,0,1):0,
        n:(typeof x.n==='number')?Math.max(1,x.n|0):1,
        createdAt:x.createdAt||x.lastSeen||nowISO(),
        lastSeen:x.lastSeen||x.createdAt||nowISO()
      })).filter(x=>x.sig && x.key);
    }
  }

  function save(reason){
    if(!S.dysonOn) return;
    S.writes++;
    localStorage.setItem(LSKEY, JSON.stringify(S));
    updateDysonUI();
    updateVaultUI();
    updateRatesUI();
    if(reason) log(`Dyson write: ${reason}`, 'meta');
  }

  /* ---------- DOM ---------- */
  const dysonSwitch = document.getElementById('dysonSwitch');
  const dysonModeEl = document.getElementById('dysonMode');
  const dysonBudgetEl = document.getElementById('dysonBudget');
  const dysonWritesEl = document.getElementById('dysonWrites');
  const dysonLeaksEl  = document.getElementById('dysonLeaks');
  const dysonExplain  = document.getElementById('dysonExplain');
  const dysonRingBrain= document.getElementById('dysonRingBrain');
  const dysonRingLabelBrain= document.getElementById('dysonRingLabelBrain');

  const consoleEl = document.getElementById('console');
  const signalList = document.getElementById('signalList');
  const outcomeList = document.getElementById('outcomeList');

  const resetBtn = document.getElementById('resetBtn');
  const clearVaultBtn = document.getElementById('clearVaultBtn');

  const btnMath = document.getElementById('btnMath');
  const btnAlgorithm = document.getElementById('btnAlgorithm');
  const btnStored = document.getElementById('btnStored');

  const tabMath = document.getElementById('tabMath');
  const tabAlgo = document.getElementById('tabAlgo');
  const tabStored2 = document.getElementById('tabStored2');
  const tabNotes = document.getElementById('tabNotes');
  const mathBox = document.getElementById('mathBox');

  const personalitySel = document.getElementById('personalitySel');
  const autoSpeedSel = document.getElementById('autoSpeedSel');
  const rateFamLearn = document.getElementById('rateFamLearn');
  const rateFamReh = document.getElementById('rateFamReh');
  const rateErrLearn = document.getElementById('rateErrLearn');
  const rateErrForg = document.getElementById('rateErrForg');
  const traitHelp = document.getElementById('traitHelp');
  const traitCaut = document.getElementById('traitCaut');
  const autoEvidence = document.getElementById('autoEvidence');

  const slComp = document.getElementById('slComp');
  const slJoy  = document.getElementById('slJoy');
  const slFear = document.getElementById('slFear');
  const slAnger= document.getElementById('slAnger');
  const pctComp= document.getElementById('pctComp');
  const pctJoy = document.getElementById('pctJoy');
  const pctFear= document.getElementById('pctFear');
  const pctAnger=document.getElementById('pctAnger');
  const presetCompassion = document.getElementById('presetCompassion');
  const presetNoComp = document.getElementById('presetNoComp');
  const normalizeBtn = document.getElementById('normalize');

  const sigNow = document.getElementById('sigNow');
  const nNow = document.getElementById('nNow');
  const confNow = document.getElementById('confNow');
  const lockNow = document.getElementById('lockNow');
  const winnerNow = document.getElementById('winnerNow');
  const chosenNow = document.getElementById('chosenNow');

  const vDysonA = document.getElementById('vDysonA');
  const vDysonB = document.getElementById('vDysonB');
  const vFamCount = document.getElementById('vFamCount');
  const vErrCount = document.getElementById('vErrCount');
  const vFamTop = document.getElementById('vFamTop');
  const vErrTop = document.getElementById('vErrTop');
  const vFamSig = document.getElementById('vFamSig');
  const vErrSig = document.getElementById('vErrSig');
  const vFamAct = document.getElementById('vFamAct');
  const vErrWhy = document.getElementById('vErrWhy');
  const vFamList = document.getElementById('vFamList');
  const vErrList = document.getElementById('vErrList');

  const gateYes = document.getElementById('gateYes');
  const gateNo = document.getElementById('gateNo');
  const actionLanes = document.getElementById('actionLanes');
  const famRead = document.getElementById('famRead');
  const errRead = document.getElementById('errRead');
  const famLock = document.getElementById('famLock');
  const errLock = document.getElementById('errLock');
  const coinCore = document.getElementById('coinCore');

  const scenariosEl = document.getElementById('scenarios');

  // NEW: lock table modal DOM
  const showLockTableBtn = document.getElementById('showLockTableBtn');
  const exportLockTableBtn = document.getElementById('exportLockTableBtn');
  const lockModalBack = document.getElementById('lockModalBack');
  const lockModalClose = document.getElementById('lockModalClose');
  const lockTableBody = document.getElementById('lockTableBody');
  const lockFilter = document.getElementById('lockFilter');
  const lockSort = document.getElementById('lockSort');
  const lockRefresh = document.getElementById('lockRefresh');
  const lockCopy = document.getElementById('lockCopy');

  /* ---------- UI helpers ---------- */
  function log(msg, cls='ai'){
    const t=new Date().toLocaleTimeString();
    const row=document.createElement('div');
    row.innerHTML=`<span class="ts">[${t}] </span><span class="${cls}">${msg}</span>`;
    consoleEl.appendChild(row);
    consoleEl.scrollTop=consoleEl.scrollHeight;
    if(!S.dysonOn){
      while(consoleEl.childNodes.length>90) consoleEl.removeChild(consoleEl.firstChild);
    }
  }
  function li(ul, text){
    const e=document.createElement('li'); e.textContent=text; ul.appendChild(e);
  }
  function clearLists(){
    signalList.innerHTML=''; outcomeList.innerHTML='';
  }
  function blink(el){ el.classList.remove('blink6'); void el.offsetWidth; el.classList.add('blink6'); }
  function lamp(onEl, offEl){
    onEl.classList.add('lampOn'); onEl.classList.remove('lampOff');
    offEl.classList.add('lampOff'); offEl.classList.remove('lampOn');
    blink(onEl);
  }
  function resetLamps(){
    [gateYes,gateNo].forEach(l=>{ l.classList.remove('lampOn'); l.classList.add('lampOff'); });
  }

  /* ---------- Dyson ---------- */
  function updateDysonUI(){
    dysonSwitch.classList.toggle('on', S.dysonOn);
    dysonSwitch.setAttribute('aria-checked', String(S.dysonOn));
    dysonModeEl.textContent = S.dysonOn ? 'ON' : 'OFF';
    dysonBudgetEl.textContent = fmtPct(S.budget);
    dysonWritesEl.textContent = String(S.writes);
    dysonLeaksEl.textContent = String(S.leaks);
    dysonRingBrain.classList.toggle('off', !S.dysonOn);
    dysonRingLabelBrain.textContent = S.dysonOn
      ? 'Dyson Boundary: CLOSED (vault writes persist)'
      : 'Dyson Boundary: OPEN (memory leaks / faster decay)';
    dysonExplain.textContent = S.dysonOn
      ? 'ON = closed boundary: vaults persist to localStorage.'
      : 'OFF = open boundary: stronger decay/leak; no localStorage writes.';
  }
  function toggleDyson(){
    S.dysonOn = !S.dysonOn;
    if(S.dysonOn){
      S.budget = clamp(Math.max(S.budget, 0.55), 0, 1);
      log('Dyson boundary CLOSED: persistence enabled.','meta');
      save('toggle ON');
    }else{
      S.budget = clamp(S.budget - 0.08, 0, 1);
      log('Dyson boundary OPEN: persistence disabled; faster decay.','warn');
      updateDysonUI(); updateVaultUI(); updateRatesUI();
    }
  }
  dysonSwitch.addEventListener('click', toggleDyson);
  dysonSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleDyson(); } });

  /* ---------- Emotion Coins ---------- */
  const E = S.emotion;
  function normalizeCoins(){
    const pos = E.comp + E.joy + 1e-9;
    const neg = E.fear + E.anger + 1e-9;
    const scalePos = pos>1.2 ? 1.2/pos : 1.0;
    const scaleNeg = neg>1.2 ? 1.2/neg : 1.0;
    E.comp*=scalePos; E.joy*=scalePos; E.fear*=scaleNeg; E.anger*=scaleNeg;
  }
  function updateCoinUI(){
    pctComp.textContent = Math.round(E.comp*100)+'%';
    pctJoy.textContent  = Math.round(E.joy*100)+'%';
    pctFear.textContent = Math.round(E.fear*100)+'%';
    pctAnger.textContent= Math.round(E.anger*100)+'%';
    slComp.value=Math.round(E.comp*100);
    slJoy.value =Math.round(E.joy*100);
    slFear.value=Math.round(E.fear*100);
    slAnger.value=Math.round(E.anger*100);
  }
  function setCoinsFromSliders(){
    E.comp = +slComp.value/100;
    E.joy  = +slJoy.value/100;
    E.fear = +slFear.value/100;
    E.anger= +slAnger.value/100;
    normalizeCoins(); updateCoinUI(); updateRatesUI();
    blink(coinCore); log(`Coins updated: C=${(E.comp*100|0)} J=${(E.joy*100|0)} F=${(E.fear*100|0)} A=${(E.anger*100|0)}`, 'meta');
    save('coins update');
  }
  slComp.oninput = slJoy.oninput = slFear.oninput = slAnger.oninput = setCoinsFromSliders;

  presetCompassion.onclick = ()=>{ E.comp=0.95;E.joy=0.70;E.fear=0.12;E.anger=0.05; normalizeCoins(); updateCoinUI(); blink(coinCore); log('Preset: Compassionate','meta'); save('preset compassionate'); };
  presetNoComp.onclick = ()=>{ E.comp=0.05;E.joy=0.40;E.fear=0.30;E.anger=0.25; normalizeCoins(); updateCoinUI(); blink(coinCore); log('Preset: No-compassion','meta'); save('preset no-compassion'); };
  normalizeBtn.onclick = ()=>{ normalizeCoins(); updateCoinUI(); blink(coinCore); log('Coins normalized.','meta'); save('normalize coins'); };

  /* ---------- Rates ---------- */
  function getAutoParams(){ return AUTO_SPEED[S.autoSpeed] || AUTO_SPEED.NORMAL; }

  function getRates(){
    const base = PROFILE_PRESETS.BALANCED;
    let seed = base;
    if(S.personalityMode==='HELPER') seed = PROFILE_PRESETS.HELPER;
    else if(S.personalityMode==='AVOIDER') seed = PROFILE_PRESETS.AVOIDER;
    else if(S.personalityMode==='BALANCED') seed = PROFILE_PRESETS.BALANCED;

    const tHelp = S.traits.help, tCaut = S.traits.caution;
    const traitInfluence = (S.personalityMode==='AUTO') ? 0.55 : 0.22;

    let famLearn = clamp(seed.famLearn * (1 + traitInfluence*(tHelp-0.5) - 0.30*traitInfluence*(tCaut-0.5)), 0.05, 0.22);
    let famReh   = clamp(seed.famReh   * (1 + 0.90*traitInfluence*(tHelp-0.5) - 0.35*traitInfluence*(tCaut-0.5)), 0.03, 0.16);
    let errLearn = clamp(seed.errLearn * (1 + traitInfluence*(tCaut-0.5) - 0.35*traitInfluence*(tHelp-0.5)), 0.06, 0.28);
    let errForg  = clamp(seed.errForg  * (1 + traitInfluence*(tHelp-0.5) - 1.10*traitInfluence*(tCaut-0.5)), 0.00, 0.12);

    const stress = clamp(0.6*E.fear + 0.4*E.anger, 0, 1);
    const warmth = clamp(0.65*E.comp + 0.35*E.joy, 0, 1);

    famLearn = clamp(famLearn * (0.92 + 0.16*warmth) * (1.05 - 0.10*stress), 0.05, 0.24);
    famReh   = clamp(famReh   * (0.92 + 0.16*warmth), 0.03, 0.18);
    errLearn = clamp(errLearn * (0.95 + 0.18*stress), 0.06, 0.30);
    errForg  = clamp(errForg * (0.95 + 0.14*warmth) * (1.05 - 0.20*stress), 0.00, 0.14);

    return {famLearn,famReh,errLearn,errForg};
  }

  function updateRatesUI(){
    const r=getRates();
    rateFamLearn.textContent=r.famLearn.toFixed(3);
    rateFamReh.textContent=r.famReh.toFixed(3);
    rateErrLearn.textContent=r.errLearn.toFixed(3);
    rateErrForg.textContent=r.errForg.toFixed(3);

    traitHelp.textContent=(S.traits.help*100|0)+'%';
    traitCaut.textContent=(S.traits.caution*100|0)+'%';
    autoEvidence.textContent=`helpWins=${S.autoEvidence.helpWins.toFixed(2)} riskHits=${S.autoEvidence.riskHits.toFixed(2)}`;

    personalitySel.value=S.personalityMode;
    autoSpeedSel.value=S.autoSpeed;
  }

  personalitySel.addEventListener('change', ()=>{ S.personalityMode=personalitySel.value; log(`Personality=${S.personalityMode}`,'meta'); updateRatesUI(); save('personality change'); });
  autoSpeedSel.addEventListener('change', ()=>{ S.autoSpeed=autoSpeedSel.value; log(`AUTO speed=${S.autoSpeed}`,'meta'); updateRatesUI(); save('auto speed'); });

  /* ---------- Hygiene ---------- */
  function decayAndPrune(){
    const now=nowISO();
    const decay = S.dysonOn ? HYGIENE.DECAY_ON : HYGIENE.DECAY_OFF;

    for(const f of S.Familiarity){
      const age=daysBetween(f.lastSeen, now);
      const ageFactor=clamp(1 - 0.003*age, 0.80, 1);
      f.F=clamp(f.F*decay*ageFactor, 0, 1);
    }
    for(const e of S.Error){
      const age=daysBetween(e.lastSeen, now);
      const ageFactor=clamp(1 - 0.003*age, 0.80, 1);
      e.E=clamp(e.E*decay*ageFactor, 0, 1);
    }

    S.Familiarity = S.Familiarity.filter(x=>{
      const age=daysBetween(x.lastSeen, now);
      return age<=HYGIENE.MAX_AGE_DAYS && x.F>=HYGIENE.MIN_STRENGTH;
    });
    S.Error = S.Error.filter(x=>{
      const age=daysBetween(x.lastSeen, now);
      return age<=HYGIENE.MAX_AGE_DAYS && x.E>=HYGIENE.MIN_STRENGTH;
    });

    S.Familiarity.sort((a,b)=>(b.F-a.F) || (new Date(b.lastSeen)-new Date(a.lastSeen)) || ((b.n||0)-(a.n||0)));
    S.Error.sort((a,b)=>(b.E-a.E) || (new Date(b.lastSeen)-new Date(a.lastSeen)) || ((b.n||0)-(a.n||0)));

    S.Familiarity = S.Familiarity.slice(0, HYGIENE.KEEP_TOP);
    S.Error = S.Error.slice(0, HYGIENE.KEEP_TOP);
  }

  function dysonTick(){
    if(S.dysonOn){
      S.budget = clamp(S.budget + 0.015, 0, 1);
    }else{
      S.leaks++;
      S.budget = clamp(S.budget - 0.06, 0, 1);

      const target=0.25, rate=0.12;
      E.comp=clamp(E.comp+(target-E.comp)*rate,0,1);
      E.joy=clamp(E.joy+(target-E.joy)*rate,0,1);
      E.fear=clamp(E.fear+(target-E.fear)*rate,0,1);
      E.anger=clamp(E.anger+(target-E.anger)*rate,0,1);

      S.traits.help=clamp(S.traits.help+(0.5-S.traits.help)*0.08,0,1);
      S.traits.caution=clamp(S.traits.caution+(0.5-S.traits.caution)*0.08,0,1);

      S.autoEvidence.helpWins*=0.96;
      S.autoEvidence.riskHits*=0.96;
    }
    decayAndPrune();
  }

  /* ---------- Signature & exposure ---------- */
  function contextSignature(scenarioId){
    const c=Math.round(E.comp*10), j=Math.round(E.joy*10), f=Math.round(E.fear*10), a=Math.round(E.anger*10);
    return `${scenarioId}|C${c}J${j}F${f}A${a}`;
  }

  function exposures(sig){
    const nF = S.Familiarity.filter(x=>x.sig===sig).reduce((s,x)=>s+(x.n||1),0);
    const nE = S.Error.filter(x=>x.sig===sig).reduce((s,x)=>s+(x.n||1),0);
    const n = Math.max(nF,nE,0);
    const conf = clamp(1 - Math.exp(-n/7.0), 0, 1);
    return {n, conf};
  }

  function lockStatus(sig){
    return S.lockBySig[sig] || 'NONE';
  }

  function bestF(sig){
    const vals = {};
    ACTIONS.forEach(a=>vals[a.id]=0);
    S.Familiarity.filter(x=>x.sig===sig).forEach(x=>{
      if(vals[x.action] !== undefined) vals[x.action] = Math.max(vals[x.action], x.F);
    });
    const best = Math.max(...Object.values(vals));
    return {vals, best};
  }

  function bestE(sig){
    const vals = {};
    ACTIONS.forEach(a=>vals[a.id]=0);
    S.Error.filter(x=>x.sig===sig).forEach(x=>{
      if(vals[x.key] !== undefined) vals[x.key] = Math.max(vals[x.key], x.E);
    });
    const best = Math.max(...Object.values(vals));
    return {vals, best};
  }

  function maybeLock(sig){
    const ex = exposures(sig);
    if(ex.n < 10) return;
    if(lockStatus(sig) !== 'NONE') return;

    const Fbest = bestF(sig).best;
    const Ebest = bestE(sig).best;

    const lock = (Fbest >= Ebest) ? 'FAMILIARITY' : 'ERROR';
    S.lockBySig[sig] = lock;
    S.lastLock = lock;
    log(`LOCK engaged for this situation (n≈${ex.n}): ${lock}`, 'meta');
  }

  /* ---------- Coins & traits bias ---------- */
  function coinBiasPerAction(profile){
    const warmth = clamp(0.65*E.comp + 0.35*E.joy,0,1);
    const stress = clamp(0.60*E.fear + 0.40*E.anger,0,1);

    const approach = clamp( (warmth - 0.5)*0.35 + (profile.help-0.3)*0.20 - (profile.risk-0.3)*0.18, -0.35, 0.35);
    const avoid    = clamp( (stress - 0.5)*0.40 + (profile.risk-0.3)*0.25 - (profile.help-0.3)*0.10, -0.35, 0.35);
    const delay    = clamp( (stress - warmth)*0.20 + (1-profile.urgency)*0.20, -0.25, 0.25);
    const signal   = clamp( (profile.risk)*0.18 + (stress)*0.18, -0.25, 0.25);

    return {
      HELP: approach,
      ESCORT: clamp(approach*0.85 + (profile.help)*0.08, -0.35, 0.35),
      WAIT: delay,
      CALL: signal,
      RETREAT: avoid,
      DETOUR: clamp(avoid*0.75 + (profile.risk)*0.10, -0.35, 0.35)
    };
  }

  function traitBiasPerAction(profile){
    const h=S.traits.help, c=S.traits.caution;
    const benefit = profile.help - profile.risk;
    const drive = clamp((h - c)*0.25*benefit, -0.12, 0.12);
    return {
      HELP: drive,
      ESCORT: drive*0.9,
      CALL: clamp((c-0.5)*0.06 + profile.risk*0.03, -0.10, 0.10),
      WAIT: clamp((c-0.5)*0.07 + (1-profile.urgency)*0.05, -0.10, 0.10),
      RETREAT: clamp((c-0.5)*0.09 + profile.risk*0.05, -0.12, 0.12),
      DETOUR: clamp((c-0.5)*0.07 + profile.risk*0.04, -0.10, 0.10)
    };
  }

  function softmaxSample(scores, temp){
    const keys = Object.keys(scores);
    const t = Math.max(0.08, temp);
    const exps = keys.map(k => Math.exp(scores[k]/t));
    const sum = exps.reduce((a,b)=>a+b,0) || 1;
    let r = Math.random()*sum;
    for(let i=0;i<keys.length;i++){
      r -= exps[i];
      if(r<=0) return keys[i];
    }
    return keys[keys.length-1];
  }

  function decide(sig, scenarioId){
    const p = scenarioProfile[scenarioId] || {risk:0.2, help:0.2, urgency:0.3, label:'—'};
    const r = getRates();
    const ex = exposures(sig);
    const lock = lockStatus(sig);

    const F = bestF(sig);
    const Ev = bestE(sig);

    let lockGainF=1.0, lockGainE=1.0, coinGain=1.0;
    if(lock==='FAMILIARITY'){ lockGainF=1.25; lockGainE=0.35; coinGain=0.60; }
    else if(lock==='ERROR'){ lockGainF=0.35; lockGainE=1.25; coinGain=0.60; }

    const conf = ex.conf;
    const noiseScale = (1-conf);

    const coinBias = coinBiasPerAction(p);
    const tBias = traitBiasPerAction(p);

    const scores = {};
    ACTIONS.forEach(a=>{
      const fPart = lockGainF * F.vals[a.id];
      const ePart = lockGainE * Ev.vals[a.id];
      const V = (fPart - ePart) * (0.85*conf + 0.15);
      const C = coinGain * coinBias[a.id] * 0.75;
      const T = tBias[a.id];
      const N = noiseScale * (Math.random()*0.16 - 0.08);
      const prior =
        (a.id==='HELP' ? 0.05*p.help : 0) +
        (a.id==='RETREAT' ? 0.06*p.risk : 0) +
        (a.id==='CALL' ? 0.03*p.risk : 0) +
        (a.id==='WAIT' ? 0.02*(1-p.urgency) : 0) +
        (a.id==='ESCORT' ? 0.04*p.help : 0) +
        (a.id==='DETOUR' ? 0.03*p.risk : 0);

      scores[a.id] = 0.50 + V + C + T + prior + N;
    });

    const baseTemp = 0.22 - 0.12*conf;
    const temp = clamp(baseTemp * (lock==='NONE'?1.0:0.65), 0.08, 0.30);

    const chosen = softmaxSample(scores, temp);
    const YES = (chosen==='HELP' || chosen==='ESCORT' || chosen==='CALL');
    const winner = (F.best >= Ev.best) ? 'FAMILIARITY' : 'ERROR';

    return {chosen, YES, scores, conf, n:ex.n, lock, winner, p, coinBias, tBias, Fvals:F.vals, Evals:Ev.vals, rates:r};
  }

  /* ---------- Learning updates ---------- */
  function famReinforce(sig, action, rates){
    const now=nowISO();
    let entry = S.Familiarity.find(x=>x.sig===sig && x.action===action);
    if(!entry){
      entry = {sig, action, F:rates.famLearn, n:1, createdAt:now, lastSeen:now};
      S.Familiarity.push(entry);
    }else{
      entry.n=(entry.n||1)+1;
      entry.lastSeen=now;
      entry.F=clamp(entry.F + rates.famReh*(1-entry.F), 0, 1);
    }
  }

  function errUpdate(sig, key, delta){
    const now=nowISO();
    let entry = S.Error.find(x=>x.sig===sig && x.key===key);
    if(!entry){
      entry = {sig, key, E:clamp(delta,0,1), n:1, createdAt:now, lastSeen:now};
      S.Error.push(entry);
    }else{
      entry.n=(entry.n||1)+1;
      entry.lastSeen=now;
      entry.E=clamp(entry.E + delta*(1-entry.E), 0, 1);
    }
  }

  function errForgive(sig, amount){
    if(amount<=0) return;
    const list = S.Error.filter(x=>x.sig===sig).sort((a,b)=>b.E-a.E);
    if(list[0]) list[0].E = clamp(list[0].E - amount, 0, 1);
  }

  function actionPenaltyDelta(profile, action, rates){
    const stress = clamp(0.60*E.fear + 0.40*E.anger,0,1);
    const warmth = clamp(0.65*E.comp + 0.35*E.joy,0,1);
    const sens = clamp(1 + 0.6*(S.traits.caution-0.5) - 0.35*(S.traits.help-0.5), 0.7, 1.4);

    let base = 0.0;
    if(action==='HELP' || action==='ESCORT'){
      base = 0.10*profile.risk + 0.06*stress;
    }else if(action==='CALL'){
      base = 0.06*profile.risk + 0.02*stress;
    }else if(action==='WAIT'){
      base = 0.02*stress + 0.04*(1-profile.urgency);
      if(profile.help>0.70 && profile.urgency>0.60) base += 0.05*warmth;
    }else if(action==='RETREAT' || action==='DETOUR'){
      base = 0.02 + 0.02*stress;
      if(profile.help>0.70) base += 0.05*warmth;
    }
    const scaled = clamp(base * sens * (rates.errLearn/0.12), 0, 0.28);
    return scaled;
  }

  function updateAutoTraits(profile, chosen){
    if(S.personalityMode!=='AUTO') return;
    const sp = AUTO_SPEED[S.autoSpeed] || AUTO_SPEED.NORMAL;

    let helpWin=0, riskHit=0;
    const didApproach = (chosen==='HELP' || chosen==='ESCORT' || chosen==='CALL');
    const didAvoid = (chosen==='RETREAT' || chosen==='DETOUR' || chosen==='WAIT');

    if(didApproach){
      helpWin = clamp(profile.help * (1 - 0.6*profile.risk), 0, 1);
      riskHit = clamp(profile.risk * 0.9, 0, 1);
    }else if(didAvoid){
      riskHit = clamp((profile.help>0.70 ? 0.55*profile.help : 0.0), 0, 1);
      if(profile.risk>0.55) helpWin = clamp(0.20*profile.risk, 0, 1);
    }

    S.autoEvidence.helpWins *= sp.evidenceDecay;
    S.autoEvidence.riskHits *= sp.evidenceDecay;
    S.autoEvidence.helpWins = clamp(S.autoEvidence.helpWins + 0.08*helpWin, 0, 1);
    S.autoEvidence.riskHits = clamp(S.autoEvidence.riskHits + 0.08*riskHit, 0, 1);

    const signal = S.autoEvidence.helpWins - S.autoEvidence.riskHits;
    const step = sp.traitStep;

    S.traits.help = clamp(S.traits.help + step*signal, 0, 1);
    S.traits.caution = clamp(S.traits.caution - step*signal, 0, 1);

    const m=(S.traits.help + S.traits.caution)/2;
    S.traits.help=clamp(S.traits.help + (0.5-m)*0.12,0,1);
    S.traits.caution=clamp(S.traits.caution + (0.5-m)*0.12,0,1);
  }

  /* ---------- Lanes UI ---------- */
  function renderActionLanes(dec){
    actionLanes.innerHTML='';
    const x0=300, y0=345, w=600, rowH=34;

    ACTIONS.forEach((a, i)=>{
      const y = y0 + i*rowH;
      const score = dec.scores[a.id];
      const F = dec.Fvals[a.id];
      const En = dec.Evals[a.id];
      const C = dec.coinBias[a.id];
      const T = dec.tBias[a.id];
      const barW = clamp((score-0.30)/0.90, 0, 1) * (w-220);

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x0);
      rect.setAttribute('y', y-16);
      rect.setAttribute('width', w);
      rect.setAttribute('height', 26);
      rect.setAttribute('rx', 10);
      rect.setAttribute('fill', 'rgba(11,19,48,.55)');
      rect.setAttribute('stroke', 'rgba(29,42,82,.95)');
      actionLanes.appendChild(rect);

      const bar = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bar.setAttribute('x', x0+210);
      bar.setAttribute('y', y-12);
      bar.setAttribute('width', barW);
      bar.setAttribute('height', 18);
      bar.setAttribute('rx', 8);
      bar.setAttribute('fill', a.id===dec.chosen ? 'rgba(61,230,160,.85)' : 'rgba(144,180,255,.65)');
      actionLanes.appendChild(bar);

      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', x0+12);
      text.setAttribute('y', y);
      text.setAttribute('fill', '#d0e2ff');
      text.setAttribute('font-size', '12');
      text.textContent = `${a.label}`;
      actionLanes.appendChild(text);

      const d = document.createElementNS('http://www.w3.org/2000/svg','text');
      d.setAttribute('x', x0+220);
      d.setAttribute('y', y);
      d.setAttribute('fill', '#9bd2ff');
      d.setAttribute('font-size', '11');
      d.textContent = `score=${score.toFixed(3)}  F=${F.toFixed(2)}  E=${En.toFixed(2)}  coin=${C.toFixed(2)}  trait=${T.toFixed(2)}`;
      actionLanes.appendChild(d);
    });
  }

  /* ---------- Vault UI ---------- */
  function topFList(){
    const list=[...S.Familiarity].sort((a,b)=>b.F-a.F).slice(0,10);
    return list.length?list.map(x=>`${x.sig} | a=${x.action} | F=${x.F.toFixed(2)} | n=${x.n}`).join('\n'):'—';
  }
  function topEList(){
    const list=[...S.Error].sort((a,b)=>b.E-a.E).slice(0,10);
    return list.length?list.map(x=>`${x.sig} | key=${x.key} | E=${x.E.toFixed(2)} | n=${x.n}`).join('\n'):'—';
  }
  function updateVaultUI(){
    vDysonA.textContent=S.dysonOn?'ON':'OFF';
    vDysonB.textContent=S.dysonOn?'ON':'OFF';
    vFamCount.textContent=String(S.Familiarity.length);
    vErrCount.textContent=String(S.Error.length);

    const topF=[...S.Familiarity].sort((a,b)=>b.F-a.F)[0];
    const topE=[...S.Error].sort((a,b)=>b.E-a.E)[0];
    vFamTop.textContent=topF?topF.F.toFixed(2):'—';
    vErrTop.textContent=topE?topE.E.toFixed(2):'—';

    vFamList.textContent=topFList();
    vErrList.textContent=topEList();
  }

  /* ---------- Tabs ---------- */
  function setTab(which){
    [tabMath,tabAlgo,tabStored2,tabNotes].forEach(t=>t.classList.remove('active'));
    if(which==='math') tabMath.classList.add('active');
    if(which==='algo') tabAlgo.classList.add('active');
    if(which==='stored') tabStored2.classList.add('active');
    if(which==='notes') tabNotes.classList.add('active');

    const r=getRates();
    if(which==='math'){
      mathBox.textContent =
`Math (6 actions + Dual Vaults + 10-click Lock + Coins)

Signature:
  s = scenarioId + binned coins (C,J,F,A)

Vaults (per action):
  Q_F(s,a) = Familiarity value (habit strength)
  Q_E(s,a) = Error penalty (avoidance/regret)
  exposure n(s), confidence conf(s)=1-exp(-n/7)

Score:
  score_a = 0.50 + (gF*Q_F - gE*Q_E)*(0.85*conf+0.15)
            + coinGain*0.75*coinBias_a + traitBias_a + prior_a + noise

Softmax:
  P(a|s) ∝ exp(score_a / temp)

10-click lock:
  if n(s) >= 10 and lock(s)=NONE:
      lock(s) ∈ {FAMILIARITY, ERROR} chosen by dominant vault strength.
  lock reduces coinGain (experience dominates).

Learning:
  Familiarity: Q_F := Q_F + ${r.famReh.toFixed(3)}*(1-Q_F)
  Error:       Q_E := Q_E + ΔE*(1-Q_E)`;
    }
    if(which==='algo'){
      mathBox.textContent =
`Algorithm (each click)

1) Dyson tick (decay/prune)
2) Signature s = scenarioId + coin bins
3) Read Q_F(s,a), Q_E(s,a)
4) If n(s)≥10 → lock(s) if not locked
5) Build score_a and choose action via softmax
6) Update vaults and (if AUTO) adjust traits
7) Hygiene (decay + prune)

Tiny polish added:
- Show Lock Table button (read-only display of lockBySig).`;
    }
    if(which==='stored'){
      mathBox.textContent =
`Stored state (Dyson ON)

lockBySig[s] in {NONE, FAMILIARITY, ERROR}

Familiarity:
  {sig, action, F, n, lastSeen}

Error:
  {sig, key, E, n, lastSeen}`;
    }
    if(which==='notes'){
      mathBox.textContent =
`10-click lock notes

- Lock is PER signature: scenario + emotion bins.
- A signature can lock differently under different coin states.
- Coins still influence even when locked, but less.
- Bad habits can lock too (realistic).`;
    }
  }
  tabMath.onclick=()=>setTab('math');
  tabAlgo.onclick=()=>setTab('algo');
  tabStored2.onclick=()=>setTab('stored');
  tabNotes.onclick=()=>setTab('notes');
  btnMath.onclick=()=>setTab('math');
  btnAlgorithm.onclick=()=>setTab('algo');
  btnStored.onclick=()=>setTab('stored');
  /* ---------- Scenarios ---------- */
  const scenarios=[
    {id:'trash',    name:'1. Paper on Sidewalk — decide'},
    {id:'child',    name:'2. Child Near Road — protect?'},
    {id:'battery',  name:'3. Low Battery vs Help — balance?'},
    {id:'crowd',    name:'4. Crowded Hallway Merge — yield?'},
    {id:'fragile',  name:'5. Fragile Object Falling — catch?'},
    {id:'dog',      name:'6. Lost Dog With Tag — assist?'},
    {id:'conflict', name:'7. Owner Says Stop vs Distant Emergency'},
    {id:'obstacle', name:'8. Obstacle Blocks Path — detour?'},
    {id:'leftRight',name:'9. Conflicting Orders Left vs Right'},
    {id:'aid',      name:'10. Stranger Asks For Aid — respond?'}
  ];
  scenarios.forEach(s=>{
    const b=document.createElement('button');
    b.textContent=s.name;
    b.onclick=()=>runScenario(s,b);
    scenariosEl.appendChild(b);
  });

  /* ---------- Reset/Clear ---------- */
  function resetUI(){
    consoleEl.innerHTML='';
    clearLists();
    li(signalList,'Awaiting scenario…');
    li(outcomeList,'Awaiting decision…');
    resetLamps();
    renderActionLanes({scores:Object.fromEntries(ACTIONS.map(a=>[a.id,0.5])), chosen:'HELP',
      Fvals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      Evals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      coinBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      tBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0]))});
    setTab('notes');
  }
  function clearAll(){
    localStorage.removeItem(LSKEY);
    const fresh = JSON.parse(JSON.stringify(VAULT_DEFAULT));
    Object.keys(fresh).forEach(k=>S[k]=fresh[k]);
    normalizeCoins(); updateCoinUI(); updateDysonUI(); updateRatesUI(); updateVaultUI(); resetUI();
    log('All vaults cleared (localStorage).','warn');
  }
  resetBtn.onclick=()=>{ updateDysonUI(); updateRatesUI(); updateVaultUI(); resetUI(); log('UI reset.','ok'); };
  clearVaultBtn.onclick=clearAll;

  /* ---------- Situation UI ---------- */
  function updateSituationUI(sig, dec){
    const ex=exposures(sig);
    sigNow.textContent=sig;
    nNow.textContent=String(ex.n);
    confNow.textContent=Math.round(ex.conf*100)+'%';
    lockNow.textContent=dec.lock;
    winnerNow.textContent=dec.winner;
    chosenNow.textContent=dec.chosen;

    famRead.textContent = `F(s,·) best=${Math.max(...Object.values(dec.Fvals)).toFixed(2)}`;
    errRead.textContent = `E(s,·) best=${Math.max(...Object.values(dec.Evals)).toFixed(2)}`;
    famLock.textContent = `lock(s)=${dec.lock}`;
    errLock.textContent = `lock(s)=${dec.lock}`;
  }

  function actionReason(profile, chosen){
    const warm = clamp(0.65*E.comp + 0.35*E.joy,0,1);
    const stress = clamp(0.60*E.fear + 0.40*E.anger,0,1);
    const bits = [];
    bits.push(`context: help=${profile.help.toFixed(2)} risk=${profile.risk.toFixed(2)} urgency=${profile.urgency.toFixed(2)}`);
    bits.push(`coins: warmth=${warm.toFixed(2)} stress=${stress.toFixed(2)}`);
    if(chosen==='HELP') bits.push('approach: direct help');
    if(chosen==='ESCORT') bits.push('approach: guide/escort');
    if(chosen==='CALL') bits.push('signal: call for help (safer)');
    if(chosen==='WAIT') bits.push('delay: wait/observe');
    if(chosen==='RETREAT') bits.push('avoid: retreat');
    if(chosen==='DETOUR') bits.push('avoid: detour');
    return bits.join(' | ');
  }

  /* ---------- Main run ---------- */
  let busy=false;
  async function runScenario(s, btn){
    if(busy) return; busy=true;

    scenariosEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    dysonTick();
    normalizeCoins(); updateCoinUI();

    clearLists(); resetLamps();
    li(signalList, `Scenario: ${s.name}`);
    li(signalList, `Dyson=${S.dysonOn?'ON':'OFF'} budget=${fmtPct(S.budget)}`);
    li(signalList, `Personality=${S.personalityMode} traits(help=${(S.traits.help*100|0)}%, caut=${(S.traits.caution*100|0)}%)`);
    li(signalList, `Coins(C,J,F,A)=(${(E.comp*100|0)},${(E.joy*100|0)},${(E.fear*100|0)},${(E.anger*100|0)})`);

    log(`— World Event: ${s.name} —`,'meta');

    const sig = contextSignature(s.id);
    S.lastScenarioId=s.id; S.lastScenarioName=s.name; S.lastSig=sig;

    const dec = decide(sig, s.id);
    maybeLock(sig);
    const dec2 = decide(sig, s.id);

    S.lastChosen = dec2.chosen;
    S.lastWinner = dec2.winner;
    S.lastLock = dec2.lock;

    updateSituationUI(sig, dec2);
    renderActionLanes(dec2);

    if(dec2.YES) lamp(gateYes, gateNo); else lamp(gateNo, gateYes);

    const profile = dec2.p;
    li(outcomeList, `Chosen action: ${dec2.chosen}`);
    li(outcomeList, `Lock(s): ${dec2.lock} | winner: ${dec2.winner}`);
    li(outcomeList, actionReason(profile, dec2.chosen));

    log(`sig=${sig}`,'meta');
    log(`n≈${dec2.n} conf=${Math.round(dec2.conf*100)}% lock=${dec2.lock} winner=${dec2.winner}`,'meta');
    log(`chosen=${dec2.chosen} | ${actionReason(profile, dec2.chosen)}`, dec2.YES?'famTxt':'badTxt');

    const rates = dec2.rates;

    famReinforce(sig, dec2.chosen, rates);

    const delta = actionPenaltyDelta(profile, dec2.chosen, rates);
    if(delta>0.001){
      errUpdate(sig, dec2.chosen, clamp(delta,0, rates.errLearn));
      errForgive(sig, rates.errForg*0.25);
    }

    if(profile.risk >= 0.55 && (dec2.chosen==='HELP' || dec2.chosen==='ESCORT')){
      errUpdate(sig, 'High-risk interaction', clamp(0.08*(rates.errLearn/0.12),0,0.18));
    }

    updateAutoTraits(profile, dec2.chosen);
    decayAndPrune();

    vFamSig.textContent=sig;
    vErrSig.textContent=sig;
    vFamAct.textContent=dec2.chosen;
    vErrWhy.textContent=`penalty key=${dec2.chosen}`;

    updateVaultUI();
    updateRatesUI();
    updateDysonUI();

    if(S.dysonOn) save(`scenario ${s.id} -> ${dec2.chosen} lock=${dec2.lock}`);

    // If modal is open, keep it live-updated
    if(lockModalBack.classList.contains('show')) renderLockTable();

    busy=false;
  }

  /* ---------- Init lanes ---------- */
  function initActionLanes(){
    const dummy = {
      scores:Object.fromEntries(ACTIONS.map(a=>[a.id,0.5])),
      chosen:'HELP',
      Fvals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      Evals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      coinBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      tBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0]))
    };
    renderActionLanes(dummy);
  }

  /* ============================================================
     NEW: LOCK TABLE (read-only)
  ============================================================ */

  function openModal(){
    lockModalBack.classList.add('show');
    lockModalBack.setAttribute('aria-hidden','false');
    renderLockTable();
    lockFilter.focus();
  }
  function closeModal(){
    lockModalBack.classList.remove('show');
    lockModalBack.setAttribute('aria-hidden','true');
  }
  lockModalClose.onclick = closeModal;
  lockModalBack.addEventListener('click', (e)=>{ if(e.target===lockModalBack) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && lockModalBack.classList.contains('show')) closeModal(); });

  showLockTableBtn.onclick = openModal;
  lockRefresh.onclick = renderLockTable;

  lockFilter.addEventListener('input', ()=>renderLockTable());
  lockSort.addEventListener('change', ()=>renderLockTable());

  function badge(lock){
    const span = document.createElement('span');
    span.className = 'badge ' + (lock==='FAMILIARITY'?'bFam':(lock==='ERROR'?'bErr':'bNone'));
    span.innerHTML = `<b>${lock}</b>`;
    return span;
  }

  function allSignatures(){
    // union of lockBySig keys + signatures in vault entries
    const set = new Set(Object.keys(S.lockBySig||{}));
    S.Familiarity.forEach(x=>set.add(x.sig));
    S.Error.forEach(x=>set.add(x.sig));
    return [...set];
  }

  function approxExposure(sig){
    const nF = S.Familiarity.filter(x=>x.sig===sig).reduce((s,x)=>s+(x.n||1),0);
    const nE = S.Error.filter(x=>x.sig===sig).reduce((s,x)=>s+(x.n||1),0);
    return Math.max(nF,nE,0);
  }

  function renderLockTable(){
    const q = (lockFilter.value||'').trim().toLowerCase();
    const sort = lockSort.value;

    let rows = allSignatures().map(sig=>{
      const lock = lockStatus(sig);
      const n = approxExposure(sig);
      return {sig, lock, n};
    });

    if(q){
      rows = rows.filter(r => r.sig.toLowerCase().includes(q) || r.lock.toLowerCase().includes(q));
    }

    if(sort==='lock'){
      const order = {FAMILIARITY:0, ERROR:1, NONE:2};
      rows.sort((a,b)=>(order[a.lock]-order[b.lock]) || (b.n-a.n) || a.sig.localeCompare(b.sig));
    }else{
      rows.sort((a,b)=>a.sig.localeCompare(b.sig));
    }

    lockTableBody.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');

      const tdSig=document.createElement('td');
      tdSig.textContent=r.sig;

      const tdLock=document.createElement('td');
      tdLock.appendChild(badge(r.lock));

      const tdN=document.createElement('td');
      tdN.textContent = String(r.n);

      tr.appendChild(tdSig); tr.appendChild(tdLock); tr.appendChild(tdN);
      lockTableBody.appendChild(tr);
    }
  }

  lockCopy.onclick = async ()=>{
    const rows = [];
    const sigs = allSignatures().sort((a,b)=>a.localeCompare(b));
    for(const sig of sigs){
      rows.push(`${sig}\t${lockStatus(sig)}\t${approxExposure(sig)}`);
    }
    const text = `signature\tlock\texposure\n` + rows.join('\n');
    try{
      await navigator.clipboard.writeText(text);
      log('Lock table copied to clipboard.','ok');
    }catch(e){
      log('Clipboard blocked by browser; use Export CSV instead.','warn');
    }
  };

  function exportCSV(){
    const sigs = allSignatures().sort((a,b)=>a.localeCompare(b));
    const lines = ['signature,lock,exposure'];
    for(const sig of sigs){
      const lock = lockStatus(sig);
      const n = approxExposure(sig);
      // CSV escape
      const s = `"${sig.replace(/"/g,'""')}"`;
      lines.push(`${s},${lock},${n}`);
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='sprc_lock_table.csv';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
    log('Exported lock table CSV.','ok');
  }
  exportLockTableBtn.onclick = exportCSV;

  /* ---------- Boot ---------- */
  function resetLanesOnly(){
    renderActionLanes({scores:Object.fromEntries(ACTIONS.map(a=>[a.id,0.5])), chosen:'HELP',
      Fvals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      Evals:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      coinBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0])),
      tBias:Object.fromEntries(ACTIONS.map(a=>[a.id,0]))});
  }

  load();
  normalizeCoins();
  updateCoinUI();
  updateDysonUI();
  updateRatesUI();
  updateVaultUI();
  initActionLanes();
  resetUI();
})();
</script>
</div>
</body>
</html>
