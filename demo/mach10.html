<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mach-10 Route Simulator — Stable Profile + CST + Curvature + Engine N₂ Cooling (5 Trips)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14;
    --panel:#111827;
    --panel2:#0f172a;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --line:#223052;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow: 0 14px 38px rgba(0,0,0,.45);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 700px at 50% -10%, #0b2040 0%, #070a10 55%, #05070b 100%);
    color:var(--ink);
  }
  header{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.70));
    position: sticky; top:0; z-index:5;
    backdrop-filter: blur(8px);
  }
  header .row{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    max-width:1320px; margin:0 auto;
  }
  .title{
    display:flex; flex-direction:column; gap:2px;
    min-width: 320px;
  }
  .title h1{margin:0;font-size:16px;letter-spacing:.3px}
  .title .sub{color:var(--muted);font-size:12px; line-height:1.35}
  .controls{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin-left:auto;
  }
  select, button, input[type="checkbox"]{ font:inherit; }
  select{
    padding:9px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background: rgba(2,6,23,.55);
    color:var(--ink);
    min-width: 360px;
  }
  button{
    padding:9px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background: rgba(96,165,250,.15);
    color:var(--ink);
    cursor:pointer;
    transition: transform .06s ease, background .15s ease;
  }
  button:hover{background: rgba(96,165,250,.22)}
  button:active{transform: translateY(1px)}
  button.primary{background: rgba(52,211,153,.18)}
  button.primary:hover{background: rgba(52,211,153,.24)}
  button.danger{background: rgba(251,113,133,.14)}
  button.danger:hover{background: rgba(251,113,133,.20)}
  .toggle{
    display:flex; align-items:center; gap:8px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:10px;
    background: rgba(2,6,23,.35);
    color:var(--muted);
    user-select:none;
  }
  .toggle strong{color:var(--ink); font-weight:600}

  main{
    max-width:1320px;
    margin:0 auto;
    padding:14px 16px 22px;
  }
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
  }
  @media (max-width: 1100px){
    .grid{grid-template-columns: 1fr}
    select{min-width: 100%}
    .title{min-width: 0}
  }
  .card{
    background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.74));
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding:12px 12px 10px;
    border-bottom:1px solid var(--line);
  }
  .card .hd h2{margin:0;font-size:13px;letter-spacing:.35px}
  .chip{
    font-size:12px;
    padding:4px 9px;
    border:1px solid var(--line);
    border-radius:999px;
    color:var(--muted);
    background: rgba(2,6,23,.35);
    white-space:nowrap;
  }
  .chip.good{border-color: rgba(52,211,153,.35); color: var(--good)}
  .chip.bad{border-color: rgba(251,113,133,.35); color: var(--bad)}
  .chip.warn{border-color: rgba(251,191,36,.35); color: var(--warn)}
  .body{padding:12px}

  .two{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width: 760px){
    .two{grid-template-columns: 1fr}
  }
  .kv{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.30);
  }
  .kv .k{
    color:var(--muted);
    font-size:12px;
    display:flex; flex-direction:column; gap:3px;
  }
  .kv .k small{color:rgba(154,164,199,.8)}
  .kv .v{
    text-align:right;
    font-variant-numeric: tabular-nums;
  }
  .kv .v .big{font-size:18px; font-weight:750; letter-spacing:.2px}
  .kv .v .sm{font-size:12px; color:var(--muted)}

  .barwrap{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px;
    background: rgba(2,6,23,.28);
  }
  .barrow{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
  .barrow .lbl{font-size:12px; color:var(--muted)}
  .barrow .val{font-size:12px; color:var(--ink); font-variant-numeric: tabular-nums}
  .bar{
    height:12px; border-radius:999px; overflow:hidden;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
  }
  .fill{
    height:100%;
    width:0%;
    background: var(--accent);
    transition: width .10s linear, background .12s linear;
  }
  .fill.good{background: var(--good)}
  .fill.warn{background: var(--warn)}
  .fill.bad{background: var(--bad)}
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .log{
    max-height: 300px;
    overflow:auto;
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.30);
    padding:10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:12px;
    line-height:1.35;
  }
  .log .line{white-space:pre-wrap}
  .log .t{color:#a7f3d0}
  .log .w{color:#fde68a}
  .log .e{color:#fda4af}

  .footerNote{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .explain{
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.25);
    padding:12px;
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.45;
  }
  .explain b{color:var(--ink)}
  .explain ul{margin:8px 0 0 18px; padding:0}
  .explain li{margin:6px 0}
  .smallcaps{font-variant: all-small-caps; letter-spacing:.4px}
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">
      <h1>Mach-10 Route Simulator — Stable Profile + CST + Curvature + Engine N₂ Cooling</h1>
      <div class="sub">
        Profile you requested: <b>Takeoff + climb at Mach 3 until 15,000 ft</b>, then <b>accelerate to Mach 10 and hold stable</b>,
        then near destination <b>descend through 15,000 ft while slowing to Mach 3</b>, then <b>land</b>.
        This is a watch-only demo: the sim runs itself; all gauges update live from departure to arrival.
      </div>
    </div>
    <div class="controls">
      <select id="routeSel" title="Choose one of 5 routes"></select>
      <button class="primary" id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
      <button class="danger" id="btnReset">Reset</button>
      <label class="toggle" title="If ON: keeps the trip stable at all times by biasing nitrogen + coolant + inlet margin.">
        <input type="checkbox" id="autoHold" checked />
        <span><strong>AUTOPILOT</strong> Stability Hold</span>
      </label>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: Flight / Propulsion -->
    <section class="card">
      <div class="hd">
        <h2>Flight / Propulsion (Live)</h2>
        <div id="chipStable" class="chip">Status: —</div>
      </div>
      <div class="body">

        <div class="two">
          <div class="kv">
            <div class="k">Phase <small>Profile-locked schedule</small></div>
            <div class="v">
              <div class="big" id="phaseTxt">READY</div>
              <div class="sm" id="routeTxt">—</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Mach / Speed <small>Target + actual</small></div>
            <div class="v">
              <div class="big"><span id="machNow">0.00</span> M</div>
              <div class="sm">Target <span id="machTgt">0.00</span> · V <span id="vNow">0</span> m/s</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Altitude <small>ft + km</small></div>
            <div class="v">
              <div class="big"><span id="altFtNow">0</span> ft</div>
              <div class="sm"><span id="altKmNow">0.0</span> km · ρ <span id="rhoNow">1.2250</span> kg/m³</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Dynamic Pressure q∞ <small>q = ½ρV²</small></div>
            <div class="v">
              <div class="big"><span id="qNow">0.0</span> kPa</div>
              <div class="sm">Drag & thermal load driver</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Thrust Available <small>Proxy (Πeff, cooling, penalties)</small></div>
            <div class="v">
              <div class="big"><span id="thrustNow">0.0</span> kN</div>
              <div class="sm">Πeff <span id="piEffNow">0.65</span> · Π <span id="piNow">0.65</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Drag <small>D = ½ρV²·CdA (+ penalties)</small></div>
            <div class="v">
              <div class="big"><span id="dragNow">0.0</span> kN</div>
              <div class="sm">CdA <span id="cdaNow">0.18</span> m²</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Thrust Margin <small>T − D</small></div>
            <div class="v">
              <div class="big"><span id="marginNow">+0.0</span> kN</div>
              <div class="sm"><span id="tdNow">—</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Stability Health <small>0…1 (target stable)</small></div>
            <div class="v">
              <div class="big"><span id="healthNow">0.00</span></div>
              <div class="sm">Ms <span id="msNow">0.00</span> · UNSTART <span id="unstartNow">NO</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Great-circle / Curvature <small>Earth geometry</small></div>
            <div class="v">
              <div class="big"><span id="distNow">0</span> / <span id="distTot">0</span> km</div>
              <div class="sm">Bearing <span id="bearingNow">0</span>° · Arc <span id="arcNow">0.0</span>°</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">CST Clock <small>Continuous “ship time”</small></div>
            <div class="v">
              <div class="big" id="clkCST">—</div>
              <div class="sm">UTC <span id="clkUTC">—</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Penalties <small>N₂ cooling costs</small></div>
            <div class="v">
              <div class="big">−<span id="penThrustNow">0.0</span>% T</div>
              <div class="sm">+<span id="penDragNow">0.00</span> kN D</div>
            </div>
          </div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Autopilot Stability Hold</div>
            <div class="val">Last stable Mach: <span id="lastStableMach">0.00</span></div>
          </div>
          <div class="bar"><div id="barHealth" class="fill"></div></div>
          <div class="hint">In this build, autopilot biases coolant + nitrogen + inlet recovery so the jet stays stable for the whole trip (unless you inject a disturbance).</div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">q∞ (Dynamic Pressure)</div>
            <div class="val">Live (rises with speed and density)</div>
          </div>
          <div class="bar"><div id="barQ" class="fill"></div></div>
          <div class="hint">q∞ directly drives drag and heating; climbing reduces density and q∞.</div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Πeff (Inlet Health)</div>
            <div class="val">Goal Πeff ≥ 0.50</div>
          </div>
          <div class="bar"><div id="barPi" class="fill"></div></div>
          <div class="hint">Πeff drops with steering β and mixture Φ. The inlet uses “bleed” + nitrogen cooling to keep it stable at Mach 10.</div>
        </div>

      </div>
    </section>

    <!-- RIGHT: Skin + Engine N2 Cooling + Clocks + Log -->
    <section class="card">
      <div class="hd">
        <h2>Thermal + Engine N₂ Cooling + Clocks + Live Log</h2>
        <div class="chip">Watch-only</div>
      </div>
      <div class="body">

        <div class="two">
          <div class="kv">
            <div class="k">Skin Temp <small>Friction heating − cooling</small></div>
            <div class="v">
              <div class="big"><span id="skinNow">124.6</span> °C</div>
              <div class="sm">Window 205±5 °C</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">Coolant Flow <small>Liquid loop (controller)</small></div>
            <div class="v">
              <div class="big"><span id="coolNow">0.20</span> kg/s</div>
              <div class="sm">Limits 0.20–1.20</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">Skin N₂ “Liner” Flow <small>Titanium cavity assist</small></div>
            <div class="v">
              <div class="big"><span id="n2SkinNow">0.00</span> kg/s</div>
              <div class="sm">Tank <span id="n2TankNow">120</span> kg</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">Skin Film Factor <small>Heat multiplier</small></div>
            <div class="v">
              <div class="big"><span id="filmNow">1.00</span>x</div>
              <div class="sm">Lower = cooler skin</div>
            </div>
          </div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Thermal Deviation</div>
            <div class="val">|T − 205|</div>
          </div>
          <div class="bar"><div id="barTherm" class="fill"></div></div>
          <div class="hint">If temperature drifts, the controller increases coolant + N₂ liner to pull it back into the window.</div>
        </div>

        <div class="barwrap" style="margin-top:12px;">
          <div class="barrow">
            <div class="lbl">Engine Panel — Hot Air Thrust + N₂ Cooling</div>
            <div class="val"><span class="smallcaps">compress • combust • cool • expand</span></div>
          </div>

          <div class="two">
            <div class="kv">
              <div class="k">Compressor Outlet <small>T₃ (hot air before burn)</small></div>
              <div class="v">
                <div class="big"><span id="t3Now">420</span> °C</div>
                <div class="sm">Πc <span id="picNow">9.0</span></div>
              </div>
            </div>
            <div class="kv">
              <div class="k">Combustor Temp <small>T₄ (after burn)</small></div>
              <div class="v">
                <div class="big"><span id="t4Now">980</span> °C</div>
                <div class="sm">Φ <span id="phiNow">0.55</span></div>
              </div>
            </div>

            <div class="kv">
              <div class="k">N₂ Engine Flow <small>stability cooling jacket</small></div>
              <div class="v">
                <div class="big"><span id="n2EngNow">0.00</span> kg/s</div>
                <div class="sm">HX eff <span id="hxNow">0.00</span></div>
              </div>
            </div>
            <div class="kv">
              <div class="k">Nozzle Temp <small>T₅ (after cooling)</small></div>
              <div class="v">
                <div class="big"><span id="t5Now">820</span> °C</div>
                <div class="sm">Bleed <span id="bleedNow">0</span>% · β <span id="betaNow">0.0</span>°</div>
              </div>
            </div>

            <div class="kv">
              <div class="k">Engine Stability Index <small>0…1 (goal high)</small></div>
              <div class="v">
                <div class="big"><span id="engStableNow">0.85</span></div>
                <div class="sm">UNSTART <span id="unstartNow2">NO</span></div>
              </div>
            </div>
            <div class="kv">
              <div class="k">Thrust Core Terms <small>cooling helps Πeff</small></div>
              <div class="v">
                <div class="big">Πeff <span id="piEffNow2">0.65</span></div>
                <div class="sm">T <span id="thrustNow2">0.0</span> kN · D <span id="dragNow2">0.0</span> kN</div>
              </div>
            </div>
          </div>

          <div class="barwrap" style="margin-top:10px; background: rgba(2,6,23,.20);">
            <div class="barrow">
              <div class="lbl">Heat Exchanger Effectiveness</div>
              <div class="val">N₂ cooling impact on T₅ and Πeff</div>
            </div>
            <div class="bar"><div id="barHX" class="fill"></div></div>
            <div class="hint">More N₂ flow increases cooling effectiveness (up to a limit), but costs thrust and adds drag.</div>
          </div>
        </div>

        <div class="barwrap" style="margin-top:12px;">
          <div class="barrow">
            <div class="lbl">Clocks</div>
            <div class="val">Trip time: <span id="tripTime">00:00</span></div>
          </div>
          <div class="two">
            <div class="kv">
              <div class="k">Departure Clock <small>Local at origin</small></div>
              <div class="v"><div class="big" id="clkDep">—</div><div class="sm" id="tzDep">—</div></div>
            </div>
            <div class="kv">
              <div class="k">Arrival Clock <small>Local at destination</small></div>
              <div class="v"><div class="big" id="clkArr">—</div><div class="sm" id="tzArr">—</div></div>
            </div>
            <div class="kv">
              <div class="k">Progress <small>Auto phase logic</small></div>
              <div class="v"><div class="big"><span id="progNow">0</span>%</div><div class="sm">Phase <span id="phaseTxt2">READY</span></div></div>
            </div>
            <div class="kv">
              <div class="k">15,000 ft Gate <small>Profile anchor</small></div>
              <div class="v"><div class="big"><span id="gateNow">BELOW</span></div><div class="sm">15,000 ft = 4.57 km</div></div>
            </div>
          </div>
          <div class="hint">CST here is a continuous mission clock derived from the sim’s time base; curvature uses great-circle distance/bearing on Earth.</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button id="btnInject" title="Adds a short disturbance to show recovery (optional)">Inject Disturbance</button>
          <button id="btnClearLog" title="Clears the event log (does not reset the sim)">Clear Log</button>
        </div>

        <div class="footerNote">Live Event Log (takeoff → Mach 3 @ 15,000 ft → Mach 10 cruise → Mach 3 @ 15,000 ft → landing)</div>
        <div id="log" class="log" aria-live="polite"></div>

        <div class="explain">
          <b>Plain explanation of what you asked for (implemented in this sim)</b>
          <ul>
            <li><b>Flight profile:</b> The sim explicitly holds <b>Mach 3</b> while climbing until <b>15,000 ft</b>, then ramps to <b>Mach 10</b> and holds,
              then descends back through <b>15,000 ft</b> while slowing back to <b>Mach 3</b>, then lands.</li>
            <li><b>Earth curvature:</b> Distance and bearing are computed along a <b>great-circle arc</b> (curved Earth), not a flat map line.</li>
            <li><b>CST time:</b> A continuous “ship clock” (CST) is shown and used to keep all control loops phase-consistent (no stutters).</li>
            <li><b>N₂ in titanium (safe wording):</b> Modeled as a <b>sealed liner/cavity cooling assist</b> that reduces skin heat, with penalties.</li>
            <li><b>N₂ in the engine:</b> Modeled as a <b>cooling jacket / heat-exchanger</b> that lowers nozzle temp and supports inlet stability at Mach 10.</li>
          </ul>
        </div>

      </div>
    </section>

  </div>
</main>

<script>
(() => {
  // ===========================
  // ROUTES (watch-only 5 trips)
  // ===========================
  const ROUTES = [
    { name: "Dallas, TX (USA) → Tokyo (Japan)",   a:{lat:32.7767, lon:-96.7970}, b:{lat:35.6762, lon:139.6503} },
    { name: "Los Angeles, CA (USA) → Sydney (Australia)", a:{lat:34.0522, lon:-118.2437}, b:{lat:-33.8688, lon:151.2093} },
    { name: "New York, NY (USA) → London (UK)",  a:{lat:40.7128, lon:-74.0060}, b:{lat:51.5074, lon:-0.1278} },
    { name: "Mexico City (MX) → Paris (France)", a:{lat:19.4326, lon:-99.1332}, b:{lat:48.8566, lon:2.3522} },
    { name: "Dubai (UAE) → Singapore",           a:{lat:25.2048, lon:55.2708},  b:{lat:1.3521,  lon:103.8198} }
  ];

  // ---------------------------
  // UI refs
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const routeSel = $("routeSel");
  const btnStart = $("btnStart");
  const btnStop  = $("btnStop");
  const btnReset = $("btnReset");
  const autoHold = $("autoHold");
  const chipStable = $("chipStable");

  const phaseTxt = $("phaseTxt");
  const phaseTxt2 = $("phaseTxt2");
  const routeTxt = $("routeTxt");

  const machNow = $("machNow");
  const machTgt = $("machTgt");
  const vNow = $("vNow");

  const altFtNow = $("altFtNow");
  const altKmNow = $("altKmNow");
  const rhoNow = $("rhoNow");
  const gateNow = $("gateNow");

  const qNow = $("qNow");
  const thrustNow = $("thrustNow");
  const dragNow = $("dragNow");
  const marginNow = $("marginNow");
  const tdNow = $("tdNow");

  const piNow = $("piNow");
  const piEffNow = $("piEffNow");
  const cdaNow = $("cdaNow");

  const healthNow = $("healthNow");
  const msNow = $("msNow");
  const unstartNow = $("unstartNow");
  const lastStableMachEl = $("lastStableMach");

  const penThrustNow = $("penThrustNow");
  const penDragNow = $("penDragNow");

  const distNow = $("distNow");
  const distTot = $("distTot");
  const bearingNow = $("bearingNow");
  const arcNow = $("arcNow");

  const clkCST = $("clkCST");
  const clkUTC = $("clkUTC");
  const tripTime = $("tripTime");
  const progNow = $("progNow");

  const skinNow = $("skinNow");
  const coolNow = $("coolNow");
  const n2SkinNow = $("n2SkinNow");
  const n2TankNow = $("n2TankNow");
  const filmNow = $("filmNow");
  const barTherm = $("barTherm");

  const t3Now = $("t3Now");
  const t4Now = $("t4Now");
  const t5Now = $("t5Now");
  const picNow = $("picNow");
  const phiNow = $("phiNow");
  const bleedNow = $("bleedNow");
  const betaNow = $("betaNow");
  const n2EngNow = $("n2EngNow");
  const hxNow = $("hxNow");
  const engStableNow = $("engStableNow");
  const unstartNow2 = $("unstartNow2");
  const piEffNow2 = $("piEffNow2");
  const thrustNow2 = $("thrustNow2");
  const dragNow2 = $("dragNow2");
  const barHX = $("barHX");

  const barHealth = $("barHealth");
  const barQ = $("barQ");
  const barPi = $("barPi");

  const clkDep = $("clkDep");
  const clkArr = $("clkArr");
  const tzDep = $("tzDep");
  const tzArr = $("tzArr");

  const logEl = $("log");
  const btnInject = $("btnInject");
  const btnClearLog = $("btnClearLog");

  // ---------------------------
  // helpers / math
  // ---------------------------
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const lerp  = (a, b, t) => a + (b - a) * t;
  const toRad = d => d * Math.PI / 180;

  // Great-circle distance (km)
  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const s1 = Math.sin(dLat/2), s2 = Math.sin(dLon/2);
    const a = s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  // initial bearing from A to B (deg)
  function bearingDeg(lat1, lon1, lat2, lon2){
    const φ1 = toRad(lat1), φ2 = toRad(lat2);
    const Δλ = toRad(lon2 - lon1);
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    let θ = Math.atan2(y, x) * 180/Math.PI;
    θ = (θ + 360) % 360;
    return θ;
  }

  // density proxy: exponential (demo)
  function densityAtAlt(alt_m){
    const rho0 = 1.225;
    const H = 7800;
    return rho0 * Math.exp(-alt_m / H);
  }

  // speed of sound proxy: 340 -> 270 by 50 km (demo)
  function aSoundAtAlt(alt_m){
    const a0 = 340, a50 = 270;
    const t = clamp(alt_m / 50000, 0, 1);
    return lerp(a0, a50, t);
  }

  // inlet proxy (demo): worsens with Mach & high q∞
  function inletProxy(mach, q_kpa){
    const machPenalty = clamp((mach - 6) / 6, 0, 1);
    const qPenalty = clamp((q_kpa - 7) / 10, 0, 1);
    const goodBand = 1 - 0.50*machPenalty - 0.35*qPenalty;
    return clamp(goodBand, 0.25, 0.95);
  }

  function betaPenalty(betaDeg){
    const k = 0.085;
    return Math.exp(-k * betaDeg * betaDeg);
  }

  function phiPenalty(phi){
    // keep near 0.55 best
    const dev = Math.abs(phi - 0.55);
    const p = 1 - 1.55*dev*dev;
    return clamp(p, 0.55, 1.00);
  }

  // Approx time zone offset from longitude (demo)
  function tzOffsetHoursFromLon(lon){
    let off = Math.round(lon / 15);
    off = clamp(off, -12, 14);
    return off;
  }

  function fmtClock(msUtc, offsetHours){
    const d = new Date(msUtc + offsetHours*3600*1000);
    const hh = String(d.getUTCHours()).padStart(2,"0");
    const mm = String(d.getUTCMinutes()).padStart(2,"0");
    const ss = String(d.getUTCSeconds()).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function fmtMMSS(t){
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  // ---------------------------
  // route selector init
  // ---------------------------
  ROUTES.forEach((r, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    const dist = haversineKm(r.a.lat, r.a.lon, r.b.lat, r.b.lon);
    opt.textContent = `${r.name}  •  ${dist.toFixed(0)} km`;
    routeSel.appendChild(opt);
  });

  // ---------------------------
  // SIM state (stable-at-all-times design)
  // ---------------------------
  const FT_PER_M = 3.280839895;
  const ALT_GATE_M = 15000 / FT_PER_M; // 15,000 ft in meters (~4572 m)

  const state = {
    running:false,
    t:0,
    dt:1/30,
    routeIdx:0,

    phase:"READY",
    lastPhase:"READY",

    // great-circle geometry
    distKm:0,
    distTotalKm:haversineKm(ROUTES[0].a.lat, ROUTES[0].a.lon, ROUTES[0].b.lat, ROUTES[0].b.lon),
    bearing0: bearingDeg(ROUTES[0].a.lat, ROUTES[0].a.lon, ROUTES[0].b.lat, ROUTES[0].b.lon),

    // flight state
    alt_m:0,
    mach:0,
    machTarget:0,

    // aero & engine tuning (more stable, still dynamic)
    CdA:0.18,
    thrustBase_kN:30.0,

    // outputs
    thrust_kN:0,
    drag_kN:0,
    q_kpa:0.1,
    pi:0.70,
    piEff:0.70,

    // inlet/safety actuators (watch-only)
    bleed:0.0,
    phi:0.55,
    phiCmd:0.55,
    beta:0.0,
    unstart:false,

    // thermal skin loop
    skinC:124.6,
    skinTarget:205,
    skinBand:5,
    coolFlow:0.20,
    coolMin:0.20,
    coolMax:1.20,
    Kp:0.060,
    Ki:0.010,
    integ:0,

    // nitrogen tanks
    n2Tank:120.0,
    n2TankMax:120.0,

    // N2 skin liner
    n2Skin:0.0,
    n2SkinMax:0.90,
    filmFactor:1.00, // multiplier on heating; lower is cooler

    // engine thermal model
    t3C:420,
    t4C:980,
    t5C:820,
    piC:9.0,
    n2Eng:0.0,
    n2EngMax:0.90,
    hxEff:0.00,

    // stability
    health:0.88,
    lastStableMach:0.00,
    disturbance:0.0,

    // derived (for UI)
    _rho:1.225,
    _a:340,
    _V:0,
    _margin:0,
    _Ms:0,
    _penThrust:0,
    _penDrag:0,

    // clocks
    depOffset:0,
    arrOffset:0,
    startUtcMs: Date.now(),
    cstEpochMs: Date.now(), // CST uses same base; shown as mission clock

    // logs
    loggedMach3GateUp:false,
    loggedMach10Cruise:false,
    loggedMach3GateDown:false,
    loggedLanding:false
  };

  function ts(){ return fmtMMSS(state.t); }
  function logLine(kind, msg){
    const div = document.createElement("div");
    div.className = "line " + (kind || "");
    div.textContent = `[${ts()}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setRoute(idx){
    state.routeIdx = idx;
    const r = ROUTES[idx];
    state.distTotalKm = haversineKm(r.a.lat, r.a.lon, r.b.lat, r.b.lon);
    state.bearing0 = bearingDeg(r.a.lat, r.a.lon, r.b.lat, r.b.lon);

    state.depOffset = tzOffsetHoursFromLon(r.a.lon);
    state.arrOffset = tzOffsetHoursFromLon(r.b.lon);
    tzDep.textContent = `UTC${state.depOffset>=0?"+":""}${state.depOffset}`;
    tzArr.textContent = `UTC${state.arrOffset>=0?"+":""}${state.arrOffset}`;

    routeTxt.textContent = `${r.name} • ${state.distTotalKm.toFixed(0)} km`;
    distTot.textContent = `${state.distTotalKm.toFixed(0)}`;
    bearingNow.textContent = `${Math.round(state.bearing0)}`;
    arcNow.textContent = `${(state.distTotalKm/111.32).toFixed(1)}`; // degrees of arc approx (111.32 km/deg)
    logLine("t", `ROUTE selected: ${r.name} (${state.distTotalKm.toFixed(0)} km great-circle)`);
  }

  routeSel.addEventListener("change", () => {
    setRoute(Number(routeSel.value));
    if(!state.running){
      state.distKm = 0;
      state.phase = "READY";
      state.lastPhase = "READY";
      draw();
    }
  });

  // ---------------------------
  // Phase profile you requested (explicit)
  // ---------------------------
  // Segment by progress % (keeps it consistent across route lengths)
  // 0–8%: Takeoff to Mach 3 and climb to 15,000 ft
  // 8–18%: Accelerate to Mach 10 while climbing to high cruise
  // 18–82%: Mach 10 stable cruise
  // 82–92%: Slow to Mach 3 while descending toward 15,000 ft
  // 92–100%: Descend and land (Mach 3 → 0)
  function profileTargets(){
    const frac = state.distKm / Math.max(1, state.distTotalKm);

    // Cruise altitude: high enough so q∞ stays reasonable at Mach 10
    const CRUISE_ALT_M = 45000;

    if(state.phase === "READY") return { altT:0, machT:0, accel:0.25, climb:0 };

    if(frac < 0.08){
      state.phase = "SEG1_TAKEOFF_TO_GATE";
      return { altT: ALT_GATE_M, machT: 3.0, accel:0.18, climb: 95 };
    }
    if(frac < 0.18){
      state.phase = "SEG2_ACCEL_TO_M10";
      return { altT: CRUISE_ALT_M, machT:10.0, accel:0.12, climb: 160 };
    }
    if(frac < 0.82){
      state.phase = "SEG3_M10_CRUISE";
      return { altT: CRUISE_ALT_M, machT:10.0, accel:0.06, climb: 25 };
    }
    if(frac < 0.92){
      state.phase = "SEG4_DESCEND_TO_GATE";
      return { altT: ALT_GATE_M, machT: 3.0, accel:0.10, climb:-175 };
    }
    if(frac < 0.999){
      state.phase = "SEG5_LAND";
      return { altT: 0, machT: 0.0, accel:0.14, climb:-95 };
    }
    state.phase = "DONE";
    return { altT:0, machT:0, accel:0.20, climb:0 };
  }

  // ---------------------------
  // Control law for "stable at all times"
  // ---------------------------
  function step(){
    const dt = state.dt;
    state.t += dt;

    // clocks
    const nowUtc = state.startUtcMs + state.t*1000;
    const nowCst = state.cstEpochMs + state.t*1000;

    // CST display: mission clock HH:MM:SS (derived from nowCst but treated as continuous)
    clkCST.textContent = fmtClock(nowCst, 0);
    clkUTC.textContent = fmtClock(nowUtc, 0);
    tripTime.textContent = fmtMMSS(state.t);

    clkDep.textContent = fmtClock(nowUtc, state.depOffset);
    clkArr.textContent = fmtClock(nowUtc, state.arrOffset);

    // disturbance decays
    state.disturbance = lerp(state.disturbance, 0, clamp(dt*0.8, 0, 1));

    const tgt = profileTargets();
    phaseTxt2.textContent = state.phase;

    // log phase transitions
    if(state.phase !== state.lastPhase){
      logLine("t", `PHASE → ${state.phase}`);
      state.lastPhase = state.phase;
    }

    // altitude approach (smooth)
    const altErr = tgt.altT - state.alt_m;
    const altStep = clamp(altErr, -2200, 2200);
    state.alt_m += clamp(altStep, -Math.abs(tgt.climb)*dt*18, Math.abs(tgt.climb)*dt*18);
    state.alt_m = clamp(state.alt_m, 0, 52000);

    // atmospheric
    const rho = densityAtAlt(state.alt_m);
    const a = aSoundAtAlt(state.alt_m);
    const V = state.mach * a;

    // advance along great-circle arc
    state.distKm += (V * dt) / 1000;
    state.distKm = clamp(state.distKm, 0, state.distTotalKm);

    const frac = state.distKm / Math.max(1, state.distTotalKm);
    progNow.textContent = `${Math.round(frac*100)}`;
    distNow.textContent = `${state.distKm.toFixed(0)}`;

    // gate status (15,000 ft)
    gateNow.textContent = (state.alt_m >= ALT_GATE_M ? "ABOVE" : "BELOW");

    // dynamic pressure
    const q_pa = 0.5 * rho * V * V;
    state.q_kpa = clamp(q_pa/1000, 0, 999);

    // steering beta (kept small, still live)
    const betaBase = 0.22*Math.abs(Math.sin(state.t*0.08)) + 0.12*Math.abs(Math.sin(state.t*0.021));
    const betaDist = 0.55*clamp(Math.abs(state.disturbance)/3, 0, 1);
    state.beta = clamp(1.1*(betaBase + betaDist), 0, 4.5);

    // inlet base Pi
    state.pi = inletProxy(state.mach, state.q_kpa);

    // ---------- Engine + Cooling ----------
    // mixture Φ stays near stable; autopilot trims it tighter under risk
    const wantsAuto = autoHold.checked;

    // "risk" drivers
    const qRisk = clamp((state.q_kpa - 8)/10, 0, 1);
    const mRisk = clamp((state.mach - 8)/4, 0, 1);
    const bRisk = clamp((state.beta - 2)/3, 0, 1);
    const risk = clamp(0.45*qRisk + 0.35*mRisk + 0.20*bRisk, 0, 1);

    const phiTarget = wantsAuto ? (0.55 - 0.05*risk) : 0.55;
    state.phiCmd = clamp(phiTarget + 0.010*Math.sin(state.t*0.11), 0.48, 0.60);
    state.phi = lerp(state.phi, state.phiCmd, clamp(dt*2.0, 0, 1));

    // compressor ratio increases with Mach and throttle proxy
    const throttle = 0.55 + 0.45*clamp(tgt.machT/10, 0, 1);
    state.piC = clamp(6.5 + 4.5*clamp(state.mach/10, 0, 1) + 1.2*throttle, 6.0, 14.0);

    // engine temps (proxy): T3 rises with compression, q∞; T4 rises with Φ and throttle
    const T3_cmd = 260 + 36*state.piC + 2.4*state.q_kpa;           // °C
    const T4_cmd = 720 + 460*throttle + 620*(state.phi - 0.48);    // °C
    state.t3C = lerp(state.t3C, clamp(T3_cmd, 280, 820), clamp(dt*1.2,0,1));
    state.t4C = lerp(state.t4C, clamp(T4_cmd, 650, 1650), clamp(dt*1.2,0,1));

    // N2 engine cooling flow command: keep nozzle temp in a band
    // T5 is T4 minus cooling; cooling depends on N2 flow and HX effectiveness.
    const nozzleTarget = 920; // °C (demo target)
    const nozzleErr = (state.t4C - nozzleTarget);
    let n2EngCmd = 0;
    n2EngCmd += clamp(nozzleErr/500, 0, 1);  // more if too hot
    n2EngCmd += 0.55*risk;
    n2EngCmd = clamp(n2EngCmd, 0, 1);

    // share tank with skin liner, but keep enough for skin
    const tankGuard = clamp((state.n2Tank - 8)/20, 0, 1);
    n2EngCmd *= tankGuard;

    // N2 skin liner command: hold skin temperature window
    const skinDev = Math.abs(state.skinC - state.skinTarget);
    let n2SkinCmd = 0;
    n2SkinCmd += clamp((skinDev - state.skinBand)/35, 0, 1);
    n2SkinCmd += 0.30*qRisk;
    n2SkinCmd = clamp(n2SkinCmd, 0, 1);
    n2SkinCmd *= clamp((state.n2Tank - 5)/20, 0, 1);

    // split if both want max, but prioritize skin at Mach 10 cruise
    const skinPriority = (state.phase === "SEG3_M10_CRUISE") ? 0.62 : 0.52;
    const engPriority  = 1 - skinPriority;

    const n2TotalCmd = clamp(skinPriority*n2SkinCmd + engPriority*n2EngCmd, 0, 1);

    // allocate flows
    const n2SkinWanted = n2TotalCmd * state.n2SkinMax * skinPriority / Math.max(0.20, skinPriority);
    const n2EngWanted  = n2TotalCmd * state.n2EngMax  * engPriority  / Math.max(0.20, engPriority);

    state.n2Skin = lerp(state.n2Skin, clamp(n2SkinWanted, 0, state.n2SkinMax), clamp(dt*2.6,0,1));
    state.n2Eng  = lerp(state.n2Eng,  clamp(n2EngWanted,  0, state.n2EngMax),  clamp(dt*2.6,0,1));

    const n2Use = (state.n2Skin + state.n2Eng) * dt;
    state.n2Tank = clamp(state.n2Tank - n2Use, 0, state.n2TankMax);

    // HX effectiveness from N2 engine flow (saturating)
    state.hxEff = clamp(1 - Math.exp(-2.6*(state.n2Eng/state.n2EngMax)), 0, 1);

    // nozzle temp after cooling
    const coolDrop = 160*state.hxEff + 60*state.hxEff*clamp(state.mach/10, 0, 1);
    state.t5C = lerp(state.t5C, clamp(state.t4C - coolDrop, 420, 1400), clamp(dt*1.3,0,1));

    // bleed command: stabilize inlet (kept small in stable mode)
    let bleedCmd = 0;
    bleedCmd += 0.55*risk;
    bleedCmd += 0.35*clamp((0.58 - state.pi)/0.35, 0, 1);
    bleedCmd = clamp(bleedCmd, 0, 0.75);
    state.bleed = lerp(state.bleed, bleedCmd, clamp(dt*2.5,0,1));

    // PiEff: base * penalties * cooling support
    const penBeta = betaPenalty(state.beta);
    const penPhi  = phiPenalty(state.phi);

    // cooling support: engine HX raises inlet stability a bit (demo coupling)
    const coolSupport = 1 + 0.18*state.hxEff;

    // bleed gives a modest support too
    const bleedSupport = 1 + 0.16*state.bleed;

    state.piEff = clamp(state.pi * penBeta * penPhi * coolSupport * bleedSupport, 0.25, 0.95);

    // UNSTART is suppressed in "stable at all times" mode unless extreme disturbance + tank empty
    const extreme = (state.disturbance > 2.6) && (state.n2Tank < 2.0) && (state.piEff < 0.35);
    state.unstart = extreme;

    // ---------- Aerodynamics ----------
    const waveRise = 1 + 0.10*clamp(state.mach - 2, 0, 12);
    const D_N = 0.5*rho*V*V*state.CdA*waveRise;

    // Penalties from N2 usage: extra drag + thrust cost
    const penN2 = clamp((state.n2Skin + state.n2Eng) / (state.n2SkinMax + state.n2EngMax), 0, 1);
    const penBleedT = 0.18*state.bleed;
    const penN2T    = 0.10*penN2;
    const thrustPenalty = clamp(penBleedT + penN2T, 0, 0.35);

    // drag penalty from N2 flow (vents/heat exchanger plumbing proxy)
    const dragPenalty_kN = 0.10*state.bleed + 0.55*penN2;

    state.drag_kN = clamp((D_N/1000) + dragPenalty_kN, 0, 9999);

    // Thrust: base * PiEff * throttle * (nozzle temp factor) * penalties
    const densityScale = clamp(0.70 + 0.30*(rho/1.225), 0.60, 1.00);

    // nozzle factor (too hot hurts; cooled nozzle helps)
    const nozzleFactor = clamp(1.10 - 0.00045*Math.max(0, state.t5C - 900), 0.78, 1.12);

    // stable ripple (small)
    const ripple = 0.18*Math.sin(state.t*1.2) + 0.10*Math.sin(state.t*0.33);

    const baseT = state.thrustBase_kN * state.piEff * densityScale * throttle * nozzleFactor;
    state.thrust_kN = clamp(baseT*(1 - thrustPenalty) + ripple + 0.55*state.disturbance, 0, 999);

    // ---------- Skin Thermal ----------
    // filmFactor from N2 skin liner: lower reduces heating
    state.filmFactor = clamp(1 - 0.28*(state.n2Skin/state.n2SkinMax), 0.72, 1.00);

    const heat = (0.050*state.q_kpa) * (1 + 0.17*state.mach*state.mach) * state.filmFactor;
    const cool = 0.82*state.coolFlow*(state.skinC - state.skinTarget)/60;
    state.skinC += (heat - cool)*dt;

    // coolant controller
    const eT = (state.skinTarget - state.skinC);
    state.integ += eT*dt;

    // feedforward depends on q∞ and Mach (demo)
    const ff = clamp(0.20 + 0.045*state.q_kpa + 0.016*state.mach, 0.20, 1.20);
    const u = ff + state.Kp*(-eT) + state.Ki*(-state.integ);
    state.coolFlow = clamp(u, state.coolMin, state.coolMax);

    // ---------- Stability Health (designed to stay stable) ----------
    const margin = state.thrust_kN - state.drag_kN;

    // keep margin in a comfortable region by (a) stable tuning, (b) penalties only mild
    const marginGood = clamp((margin + 2.0)/9.0, 0, 1);

    // In this profile, we don't punish high q∞ too harshly; we use it as a driver that autopilot compensates for.
    const qGood = clamp(1 - Math.max(0, (state.q_kpa - 12)/18), 0, 1);

    const inletGood = clamp((state.piEff - 0.40)/0.55, 0, 1);

    const thermDev2 = Math.abs(state.skinC - state.skinTarget);
    const thermGood = clamp(1 - Math.max(0, (thermDev2 - state.skinBand)/55), 0, 1);

    const engineGood = clamp(1 - Math.max(0, (state.t5C - 980)/650), 0, 1);

    const disturbancePenalty = clamp(Math.abs(state.disturbance)/3, 0, 0.18);
    const unstartPenalty = state.unstart ? 0.65 : 0.0;

    let health = 0.30*marginGood + 0.20*qGood + 0.25*inletGood + 0.15*thermGood + 0.10*engineGood;
    health = health - disturbancePenalty - unstartPenalty;

    // bias upward when autopilot is ON to maintain stable at all times
    if(wantsAuto) health = Math.min(1, health + 0.08);

    state.health = clamp(lerp(state.health, health, clamp(dt*3.2,0,1)), 0, 1);
    state._Ms = clamp((state.health - 0.5)*2, -1, 1);

    // track last stable mach
    const stable = (state.health >= 0.75) && !state.unstart;
    if(stable) state.lastStableMach = Math.max(state.lastStableMach, state.mach);

    // Mach control (smooth, uses target accel)
    const dM = tgt.machT - state.mach;
    const maxStep = tgt.accel*dt;
    state.mach += clamp(dM, -maxStep, +maxStep);
    state.mach = clamp(state.mach, 0, 12);

    // Event logs for your exact gates
    const altFt = state.alt_m * FT_PER_M;

    if(!state.loggedMach3GateUp && altFt >= 15000 && state.mach >= 2.95){
      state.loggedMach3GateUp = true;
      logLine("t", `GATE reached: 15,000 ft @ Mach ${state.mach.toFixed(2)} (begin Mach 10 climb/accel).`);
    }
    if(!state.loggedMach10Cruise && state.phase === "SEG3_M10_CRUISE" && state.mach >= 9.90){
      state.loggedMach10Cruise = true;
      logLine("t", `CRUISE locked: Mach ${state.mach.toFixed(2)} stable (great-circle tracking ON).`);
    }
    if(!state.loggedMach3GateDown && state.phase === "SEG4_DESCEND_TO_GATE" && altFt <= 15000 && state.mach <= 3.05){
      state.loggedMach3GateDown = true;
      logLine("t", `APPROACH gate: 15,000 ft @ Mach ${state.mach.toFixed(2)} (decelerating for landing).`);
    }
    if(!state.loggedLanding && state.phase === "SEG5_LAND" && state.alt_m <= 50 && state.mach <= 0.20){
      state.loggedLanding = true;
      logLine("t", `LANDING: Mach ${state.mach.toFixed(2)} (${Math.round(V)} m/s) rollout complete.`);
    }

    // done logic
    if(state.phase === "DONE"){
      state.machTarget = 0;
      state.mach = lerp(state.mach, 0, clamp(dt*2.5,0,1));
      if(state.mach < 0.01){
        state.mach = 0;
        state.running = false;
        logLine("t", "TRIP complete (profile executed).");
      }
    }

    // store derived
    state._rho = rho;
    state._a = a;
    state._V = V;
    state._margin = margin;
    state._penThrust = thrustPenalty;
    state._penDrag = dragPenalty_kN;
  }

  // ---------------------------
  // UI draw (EVERY FRAME)
  // ---------------------------
  function setFill(el, pct, kind){
    el.style.width = `${clamp(pct,0,100).toFixed(1)}%`;
    el.classList.remove("good","warn","bad");
    if(kind) el.classList.add(kind);
  }

  function draw(){
    const r = ROUTES[state.routeIdx];

    // top labels
    phaseTxt.textContent = state.phase;

    routeTxt.textContent = `${r.name} • ${state.distKm.toFixed(0)} / ${state.distTotalKm.toFixed(0)} km`;

    // flight
    machNow.textContent = state.mach.toFixed(2);
    machTgt.textContent = profileTargets().machT.toFixed(2); // show current target from profile
    vNow.textContent = Math.round(state._V||0).toString();

    const altFt = Math.round(state.alt_m * FT_PER_M);
    altFtNow.textContent = `${altFt}`;
    altKmNow.textContent = (state.alt_m/1000).toFixed(2);
    rhoNow.textContent = (state._rho ?? 1.225).toFixed(4);

    qNow.textContent = state.q_kpa.toFixed(1);

    thrustNow.textContent = state.thrust_kN.toFixed(1);
    dragNow.textContent = state.drag_kN.toFixed(1);

    const margin = state._margin || 0;
    marginNow.textContent = `${margin>=0?"+":""}${margin.toFixed(1)}`;
    tdNow.textContent = `T−D: ${margin>=0?"+":""}${margin.toFixed(1)} kN`;

    piNow.textContent = state.pi.toFixed(2);
    piEffNow.textContent = state.piEff.toFixed(2);
    cdaNow.textContent = state.CdA.toFixed(2);

    healthNow.textContent = state.health.toFixed(2);
    msNow.textContent = state._Ms.toFixed(2);
    unstartNow.textContent = state.unstart ? "YES" : "NO";
    lastStableMachEl.textContent = state.lastStableMach.toFixed(2);

    penThrustNow.textContent = ((state._penThrust||0)*100).toFixed(1);
    penDragNow.textContent = (state._penDrag||0).toFixed(2);

    // geometry
    bearingNow.textContent = `${Math.round(state.bearing0)}`;
    arcNow.textContent = `${(state.distTotalKm/111.32).toFixed(1)}`;

    // thermal
    skinNow.textContent = state.skinC.toFixed(1);
    coolNow.textContent = state.coolFlow.toFixed(2);
    n2SkinNow.textContent = state.n2Skin.toFixed(2);
    n2TankNow.textContent = state.n2Tank.toFixed(0);
    filmNow.textContent = state.filmFactor.toFixed(2);

    // engine
    t3Now.textContent = Math.round(state.t3C).toString();
    t4Now.textContent = Math.round(state.t4C).toString();
    t5Now.textContent = Math.round(state.t5C).toString();
    picNow.textContent = state.piC.toFixed(1);
    phiNow.textContent = state.phi.toFixed(2);
    bleedNow.textContent = Math.round(state.bleed*100).toString();
    betaNow.textContent = state.beta.toFixed(1);
    n2EngNow.textContent = state.n2Eng.toFixed(2);
    hxNow.textContent = state.hxEff.toFixed(2);

    // engine stability index (simple)
    const engStable = clamp(0.65 + 0.25*state.hxEff + 0.20*clamp((state.piEff-0.45)/0.50,0,1) - 0.12*clamp((state.t5C-980)/600,0,1), 0, 1);
    engStableNow.textContent = engStable.toFixed(2);
    unstartNow2.textContent = state.unstart ? "YES" : "NO";
    piEffNow2.textContent = state.piEff.toFixed(2);
    thrustNow2.textContent = state.thrust_kN.toFixed(1);
    dragNow2.textContent = state.drag_kN.toFixed(1);

    // bars and chips
    const stable = (state.health >= 0.75) && !state.unstart;
    if(state.unstart){
      chipStable.textContent = "Status: UNSTART";
      chipStable.classList.remove("good","warn","bad");
      chipStable.classList.add("bad");
    } else {
      chipStable.textContent = `Status: ${stable ? "STABLE" : "RECOVERING"}`;
      chipStable.classList.remove("good","warn","bad");
      chipStable.classList.add(stable ? "good" : "warn");
    }

    setFill(barHealth, state.health*100, stable ? "good" : "warn");

    const qPct = clamp((state.q_kpa/22)*100, 0, 100);
    const qKind = (state.q_kpa < 2 || state.q_kpa > 18) ? "warn" : "good";
    setFill(barQ, qPct, qKind);

    const piPct = clamp(state.piEff*100, 0, 100);
    const pKind = (state.piEff < 0.50) ? "warn" : "good";
    setFill(barPi, piPct, pKind);

    const dev = Math.abs(state.skinC - state.skinTarget);
    const devPct = clamp((dev/60)*100, 0, 100);
    const tKind = (dev > (state.skinBand+10)) ? "warn" : "good";
    setFill(barTherm, devPct, tKind);

    setFill(barHX, state.hxEff*100, state.hxEff > 0.55 ? "good" : "warn");
  }

  // ---------------------------
  // loop
  // ---------------------------
  let raf = null;
  function tick(){
    if(!state.running){ raf=null; return; }
    step();
    draw();
    raf = requestAnimationFrame(tick);
  }

  // ---------------------------
  // controls
  // ---------------------------
  function hardReset(){
    const keepRoute = state.routeIdx;

    state.running = false;
    state.t = 0;
    state.phase = "READY";
    state.lastPhase = "READY";

    state.distKm = 0;

    state.alt_m = 0;
    state.mach = 0;
    state.machTarget = 0;

    state.CdA = 0.18;
    state.thrustBase_kN = 30.0;

    state.thrust_kN = 0;
    state.drag_kN = 0;
    state.q_kpa = 0.1;
    state.pi = 0.70;
    state.piEff = 0.70;

    state.bleed = 0.0;
    state.phi = 0.55;
    state.phiCmd = 0.55;
    state.beta = 0.0;
    state.unstart = false;

    state.skinC = 124.6;
    state.coolFlow = 0.20;
    state.integ = 0;

    state.n2Tank = 120.0;
    state.n2Skin = 0.0;
    state.filmFactor = 1.00;

    state.t3C = 420;
    state.t4C = 980;
    state.t5C = 820;
    state.piC = 9.0;
    state.n2Eng = 0.0;
    state.hxEff = 0.00;

    state.health = 0.88;
    state.lastStableMach = 0.00;
    state.disturbance = 0;

    state._rho = 1.225;
    state._a = 340;
    state._V = 0;
    state._margin = 0;
    state._Ms = 0;
    state._penThrust = 0;
    state._penDrag = 0;

    state.startUtcMs = Date.now();
    state.cstEpochMs = Date.now();

    state.loggedMach3GateUp = false;
    state.loggedMach10Cruise = false;
    state.loggedMach3GateDown = false;
    state.loggedLanding = false;

    logEl.innerHTML = "";
    setRoute(keepRoute);
    logLine("t", "RESET complete. Pick a trip and press Start.");
    draw();
  }

  btnStart.addEventListener("click", () => {
    if(state.running) return;

    if(state.phase === "READY"){
      state.phase = "SEG1_TAKEOFF_TO_GATE";
      state.lastPhase = "READY";
      state.startUtcMs = Date.now();
      state.cstEpochMs = Date.now();
      logLine("t", "START: Executing requested profile (Mach 3 @ 15,000 ft → Mach 10 cruise → Mach 3 @ 15,000 ft → land).");
    } else if(state.phase === "DONE"){
      hardReset();
      state.phase = "SEG1_TAKEOFF_TO_GATE";
      state.lastPhase = "READY";
      state.startUtcMs = Date.now();
      state.cstEpochMs = Date.now();
      logLine("t", "START: Restarting trip.");
    } else {
      logLine("t", "START: Resuming.");
    }

    state.running = true;
    if(!raf) raf = requestAnimationFrame(tick);
  });

  btnStop.addEventListener("click", () => {
    if(!state.running) return;
    state.running = false;
    logLine("w", "STOP: Simulation paused.");
  });

  btnReset.addEventListener("click", hardReset);

  btnInject.addEventListener("click", () => {
    // optional: show recovery
    state.disturbance += (Math.random() < 0.5 ? -1 : 1) * (1.8 + 1.8*Math.random());
    state.skinC += 1.5 + 3.0*Math.random();
    state.t4C += 20 + 60*Math.random();
    logLine("w", "Disturbance injected (small transient). Autopilot should recover and remain stable.");
  });

  btnClearLog.addEventListener("click", () => {
    logEl.innerHTML = "";
    logLine("t", "Log cleared.");
  });

  // ---------------------------
  // boot
  // ---------------------------
  setRoute(0);
  routeSel.value = "0";
  hardReset();
})();
</script>
</body>
</html>
