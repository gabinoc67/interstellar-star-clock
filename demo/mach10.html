<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mach-10 Route Simulator — 15,000 ft Profile • Always-Stable Demo • Live Gauges + Clocks (5 Trips)</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14;
    --panel:#111827;
    --panel2:#0f172a;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --line:#223052;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow: 0 14px 38px rgba(0,0,0,.45);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 700px at 50% -10%, #0b2040 0%, #070a10 55%, #05070b 100%);
    color:var(--ink);
  }
  header{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.70));
    position: sticky; top:0; z-index:5;
    backdrop-filter: blur(8px);
  }
  header .row{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    max-width:1320px; margin:0 auto;
  }
  .title{
    display:flex; flex-direction:column; gap:2px;
    min-width: 320px;
  }
  .title h1{margin:0;font-size:16px;letter-spacing:.3px}
  .title .sub{color:var(--muted);font-size:12px; line-height:1.35}
  .controls{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin-left:auto;
  }
  select, button, input[type="checkbox"]{ font:inherit; }
  select{
    padding:9px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background: rgba(2,6,23,.55);
    color:var(--ink);
    min-width: 340px;
  }
  button{
    padding:9px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background: rgba(96,165,250,.15);
    color:var(--ink);
    cursor:pointer;
    transition: transform .06s ease, background .15s ease;
  }
  button:hover{background: rgba(96,165,250,.22)}
  button:active{transform: translateY(1px)}
  button.primary{background: rgba(52,211,153,.18)}
  button.primary:hover{background: rgba(52,211,153,.24)}
  button.danger{background: rgba(251,113,133,.14)}
  button.danger:hover{background: rgba(251,113,133,.20)}
  .toggle{
    display:flex; align-items:center; gap:8px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:10px;
    background: rgba(2,6,23,.35);
    color:var(--muted);
    user-select:none;
  }
  .toggle strong{color:var(--ink); font-weight:600}

  main{
    max-width:1320px;
    margin:0 auto;
    padding:14px 16px 22px;
  }
  .grid{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:14px;
  }
  @media (max-width: 1060px){
    .grid{grid-template-columns: 1fr}
    select{min-width: 100%}
    .title{min-width: 0}
  }
  .card{
    background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.74));
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding:12px 12px 10px;
    border-bottom:1px solid var(--line);
  }
  .card .hd h2{margin:0;font-size:13px;letter-spacing:.35px}
  .chip{
    font-size:12px;
    padding:4px 9px;
    border:1px solid var(--line);
    border-radius:999px;
    color:var(--muted);
    background: rgba(2,6,23,.35);
    white-space:nowrap;
  }
  .chip.good{border-color: rgba(52,211,153,.35); color: var(--good)}
  .chip.bad{border-color: rgba(251,113,133,.35); color: var(--bad)}
  .chip.warn{border-color: rgba(251,191,36,.35); color: var(--warn)}
  .body{padding:12px}

  .two{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width: 760px){
    .two{grid-template-columns: 1fr}
  }
  .kv{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.30);
  }
  .kv .k{
    color:var(--muted);
    font-size:12px;
    display:flex; flex-direction:column; gap:3px;
  }
  .kv .k small{color:rgba(154,164,199,.8)}
  .kv .v{
    text-align:right;
    font-variant-numeric: tabular-nums;
  }
  .kv .v .big{font-size:18px; font-weight:750; letter-spacing:.2px}
  .kv .v .sm{font-size:12px; color:var(--muted)}

  .barwrap{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px;
    background: rgba(2,6,23,.28);
  }
  .barrow{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
  .barrow .lbl{font-size:12px; color:var(--muted)}
  .barrow .val{font-size:12px; color:var(--ink); font-variant-numeric: tabular-nums}
  .bar{
    height:12px; border-radius:999px; overflow:hidden;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
  }
  .fill{
    height:100%;
    width:0%;
    background: var(--accent);
    transition: width .10s linear, background .12s linear;
  }
  .fill.good{background: var(--good)}
  .fill.warn{background: var(--warn)}
  .fill.bad{background: var(--bad)}
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .log{
    max-height: 300px;
    overflow:auto;
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.30);
    padding:10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:12px;
    line-height:1.35;
  }
  .log .line{white-space:pre-wrap}
  .log .t{color:#a7f3d0}
  .log .w{color:#fde68a}
  .log .e{color:#fda4af}

  .footerNote{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .explain{
    border:1px solid var(--line);
    border-radius:12px;
    background: rgba(2,6,23,.25);
    padding:12px;
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.45;
  }
  .explain b{color:var(--ink)}
  .explain ul{margin:8px 0 0 18px; padding:0}
  .explain li{margin:6px 0}
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">
      <h1>Mach-10 Route Simulator — 15,000 ft Profile • Always-Stable Demo</h1>
      <div class="sub">
        Pick 1 of 5 trips and press <b>Start</b>. Watch-only: autopilot runs the full mission.
        Profile: <b>takeoff → climb to 15,000 ft → accelerate to Mach 10 → cruise stable → slow to Mach 3 → descend → land</b>.
        Status label stays <b>STABLE</b> in flight (no “recovering” state).
      </div>
    </div>
    <div class="controls">
      <select id="routeSel" title="Choose one of 5 routes"></select>
      <button class="primary" id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
      <button class="danger" id="btnReset">Reset</button>
      <label class="toggle" title="If ON: autopilot runs the mission automatically (recommended)">
        <input type="checkbox" id="autoHold" checked />
        <span><strong>AUTOPILOT</strong> Mission Hold</span>
      </label>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: Flight / Propulsion -->
    <section class="card">
      <div class="hd">
        <h2>Flight / Propulsion (Live)</h2>
        <div id="chipStable" class="chip good">Status: STABLE</div>
      </div>
      <div class="body">

        <div class="two">
          <div class="kv">
            <div class="k">Phase <small>Auto schedule</small></div>
            <div class="v">
              <div class="big" id="phaseTxt">READY</div>
              <div class="sm" id="routeTxt">—</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Mach / Speed <small>Target + actual</small></div>
            <div class="v">
              <div class="big"><span id="machNow">0.00</span> M</div>
              <div class="sm">Target <span id="machTgt">0.00</span> · V <span id="vNow">0</span> m/s</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Altitude <small>Target 15,000 ft peak</small></div>
            <div class="v">
              <div class="big"><span id="altNow">0.0</span> ft</div>
              <div class="sm">ρ <span id="rhoNow">1.2250</span> kg/m³</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Dynamic Pressure q∞ <small>q = ½ρV²</small></div>
            <div class="v">
              <div class="big"><span id="qNow">0.0</span> kPa</div>
              <div class="sm">Live (moves with ρ and V)</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Thrust Available <small>Proxy (Πeff, Φ, penalties)</small></div>
            <div class="v">
              <div class="big"><span id="thrustNow">0.0</span> kN</div>
              <div class="sm">Πeff <span id="piEffNow">0.65</span> · Π <span id="piNow">0.65</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Drag <small>D = ½ρV²·CdA</small></div>
            <div class="v">
              <div class="big"><span id="dragNow">0.0</span> kN</div>
              <div class="sm">CdA <span id="cdaNow">0.22</span> m²</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Thrust Margin <small>T − D</small></div>
            <div class="v">
              <div class="big"><span id="marginNow">+0.0</span> kN</div>
              <div class="sm">T&gt;D: <span id="tdNow">—</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Stability Health <small>0…1 (kept green)</small></div>
            <div class="v">
              <div class="big"><span id="healthNow">0.92</span></div>
              <div class="sm">Ms <span id="msNow">0.84</span> · UNSTART <span id="unstartNow">NO</span></div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Engine Actuators <small>Auto safety layer</small></div>
            <div class="v">
              <div class="big">Bleed <span id="bleedNow">0</span>%</div>
              <div class="sm">Fuel Φ <span id="phiNow">0.55</span> · β <span id="betaNow">0.0</span>°</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">Penalties <small>N₂ liner + bleed effects</small></div>
            <div class="v">
              <div class="big">−<span id="penThrustNow">0.0</span>% T</div>
              <div class="sm">+<span id="penDragNow">0.00</span> kN D</div>
            </div>
          </div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Stability (always stable demo)</div>
            <div class="val">Target band: 0.85–0.98</div>
          </div>
          <div class="bar"><div id="barHealth" class="fill good"></div></div>
          <div class="hint">This build is intentionally tuned so the jet stays stable through the whole profile (no “recovering” label).</div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">q∞ (Dynamic Pressure)</div>
            <div class="val">Live: rises with speed, falls with altitude</div>
          </div>
          <div class="bar"><div id="barQ" class="fill"></div></div>
          <div class="hint">Even with the simplified physics, q∞ now clearly moves during climb/accel/cruise/descent.</div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Πeff (Inlet After Effects)</div>
            <div class="val">Kept in safe band</div>
          </div>
          <div class="bar"><div id="barPi" class="fill good"></div></div>
          <div class="hint">Πeff moves slightly (β + Φ), but safety layer prevents collapse.</div>
        </div>

      </div>
    </section>

    <!-- RIGHT: Thermal + Clocks + Log + Explanation -->
    <section class="card">
      <div class="hd">
        <h2>Thermal + Clocks + Live Log</h2>
        <div class="chip">Watch-only</div>
      </div>
      <div class="body">

        <div class="two">
          <div class="kv">
            <div class="k">Skin Temp <small>Heating − Cooling</small></div>
            <div class="v">
              <div class="big"><span id="tempNow">124.6</span> °C</div>
              <div class="sm">Target 205±5 °C</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">Coolant Flow <small>Controller output</small></div>
            <div class="v">
              <div class="big"><span id="flowNow">0.20</span> kg/s</div>
              <div class="sm">Limits 0.20–1.20</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">N₂ Liner Flow <small>“Donut” skin heat-sink</small></div>
            <div class="v">
              <div class="big"><span id="n2Now">0.00</span> kg/s</div>
              <div class="sm">Tank <span id="n2TankNow">100</span> kg</div>
            </div>
          </div>
          <div class="kv">
            <div class="k">Liner Factor <small>Heat reduction</small></div>
            <div class="v">
              <div class="big"><span id="filmNow">1.00</span>x</div>
              <div class="sm">Lower is cooler</div>
            </div>
          </div>
        </div>

        <div class="barwrap">
          <div class="barrow">
            <div class="lbl">Thermal Deviation</div>
            <div class="val">|T − 205|</div>
          </div>
          <div class="bar"><div id="barTherm" class="fill"></div></div>
          <div class="hint">Coolant + N₂ liner actively keep temperature near the target window during Mach 10 cruise.</div>
        </div>

        <!-- CLOCKS PANEL -->
        <div class="barwrap" style="margin-top:12px;">
          <div class="barrow">
            <div class="lbl">Clocks</div>
            <div class="val">Trip time: <span id="tripTime">00:00</span></div>
          </div>
          <div class="two">
            <div class="kv">
              <div class="k">Departure Clock <small>Local at origin</small></div>
              <div class="v"><div class="big" id="clkDep">—</div><div class="sm" id="tzDep">—</div></div>
            </div>
            <div class="kv">
              <div class="k">Arrival Clock <small>Local at destination</small></div>
              <div class="v"><div class="big" id="clkArr">—</div><div class="sm" id="tzArr">—</div></div>
            </div>
            <div class="kv">
              <div class="k">UTC Clock <small>Reference</small></div>
              <div class="v"><div class="big" id="clkUTC">—</div><div class="sm">UTC</div></div>
            </div>
            <div class="kv">
              <div class="k">Progress <small>Distance</small></div>
              <div class="v"><div class="big"><span id="progNow">0</span>%</div><div class="sm"><span id="distNow">0</span> / <span id="distTot">0</span> km</div></div>
            </div>
          </div>
          <div class="hint">Time zones are approximated from longitude for an offline demo (no APIs).</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button id="btnInject" title="Adds a gentle disturbance (still kept stable)">Inject Disturbance</button>
          <button id="btnClearLog" title="Clears the event log (does not reset the sim)">Clear Log</button>
        </div>

        <div class="footerNote">Live Event Log (takeoff, Mach 3, Mach 10, descent, landing)</div>
        <div id="log" class="log" aria-live="polite"></div>

        <div class="explain">
          <b>Your “nitrogen inside titanium like a donut” idea (implemented conservatively)</b>
          <ul>
            <li>Modeled as a <b>sealed internal liner volume</b> with nitrogen flow acting like a controllable heat-sink.</li>
            <li>When heating rises, <b>N₂ liner flow increases</b> → <b>Liner Factor</b> drops below 1.00 → heating reduces.</li>
            <li>It also creates small <b>penalties</b> (extra drag + slight thrust loss) so it’s not “free cooling.”</li>
          </ul>
          This is still a simulator (not real scramjet CFD), but it behaves like a real cockpit: every gauge moves and the aircraft stays stable through the mission.
        </div>

      </div>
    </section>

  </div>
</main>

<script>
(() => {
  // ===========================
  // ROUTES (5 trips)
  // ===========================
  const ROUTES = [
    { name: "Dallas, TX (USA) → Tokyo (Japan)",   a:{lat:32.7767, lon:-96.7970}, b:{lat:35.6762, lon:139.6503} },
    { name: "Los Angeles, CA (USA) → Sydney (Australia)", a:{lat:34.0522, lon:-118.2437}, b:{lat:-33.8688, lon:151.2093} },
    { name: "New York, NY (USA) → London (UK)",  a:{lat:40.7128, lon:-74.0060}, b:{lat:51.5074, lon:-0.1278} },
    { name: "Mexico City (MX) → Paris (France)", a:{lat:19.4326, lon:-99.1332}, b:{lat:48.8566, lon:2.3522} },
    { name: "Dubai (UAE) → Singapore",           a:{lat:25.2048, lon:55.2708},  b:{lat:1.3521,  lon:103.8198} }
  ];

  // ---------------------------
  // UI refs
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const routeSel = $("routeSel");
  const btnStart = $("btnStart");
  const btnStop  = $("btnStop");
  const btnReset = $("btnReset");
  const autoHold = $("autoHold");
  const chipStable = $("chipStable");

  const phaseTxt = $("phaseTxt");
  const routeTxt = $("routeTxt");

  const machNow = $("machNow");
  const machTgt = $("machTgt");
  const vNow = $("vNow");

  const altNow = $("altNow");
  const rhoNow = $("rhoNow");

  const qNow = $("qNow");
  const thrustNow = $("thrustNow");
  const dragNow = $("dragNow");
  const marginNow = $("marginNow");
  const tdNow = $("tdNow");

  const piNow = $("piNow");
  const piEffNow = $("piEffNow");
  const cdaNow = $("cdaNow");

  const healthNow = $("healthNow");
  const msNow = $("msNow");
  const unstartNow = $("unstartNow");

  const bleedNow = $("bleedNow");
  const phiNow = $("phiNow");
  const betaNow = $("betaNow");
  const penThrustNow = $("penThrustNow");
  const penDragNow = $("penDragNow");

  const tempNow = $("tempNow");
  const flowNow = $("flowNow");
  const n2Now = $("n2Now");
  const n2TankNow = $("n2TankNow");
  const filmNow = $("filmNow");

  const barHealth = $("barHealth");
  const barQ = $("barQ");
  const barPi = $("barPi");
  const barTherm = $("barTherm");

  const clkDep = $("clkDep");
  const clkArr = $("clkArr");
  const clkUTC = $("clkUTC");
  const tzDep = $("tzDep");
  const tzArr = $("tzArr");
  const tripTime = $("tripTime");
  const progNow = $("progNow");
  const distNow = $("distNow");
  const distTot = $("distTot");

  const logEl = $("log");
  const btnInject = $("btnInject");
  const btnClearLog = $("btnClearLog");

  // ---------------------------
  // helpers / math
  // ---------------------------
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const lerp  = (a, b, t) => a + (b - a) * t;
  const toRad = d => d * Math.PI / 180;

  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const s1 = Math.sin(dLat/2), s2 = Math.sin(dLon/2);
    const a = s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  // atmosphere proxies
  function densityAtAlt(alt_m){
    const rho0 = 1.225;
    const H = 8500;
    return rho0 * Math.exp(-alt_m / H);
  }
  function aSoundAtAlt(alt_m){
    const a0 = 340, a15 = 315, a30 = 300;
    const t = clamp(alt_m / 9000, 0, 1); // only to 15kft region for this profile
    return lerp(a0, a15, t);
  }

  // inlet proxy
  function inletProxy(mach, q_kpa){
    // keep it gentle so it moves but doesn't collapse
    const mPen = clamp((mach - 6)/6, 0, 1);
    const qPen = clamp((q_kpa - 25)/50, 0, 1);
    return clamp(0.88 - 0.20*mPen - 0.10*qPen, 0.55, 0.95);
  }

  // time zone from longitude (offline demo)
  function tzOffsetHoursFromLon(lon){
    let off = Math.round(lon / 15);
    return clamp(off, -12, 14);
  }
  function fmtClock(msUtc, offsetHours){
    const d = new Date(msUtc + offsetHours*3600*1000);
    const hh = String(d.getUTCHours()).padStart(2,"0");
    const mm = String(d.getUTCMinutes()).padStart(2,"0");
    const ss = String(d.getUTCSeconds()).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function fmtMMSS(t){
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  // smooth response (Laplace-like 1st/2nd order feel)
  function smoothToward(x, xTgt, tau, dt){
    const a = 1 - Math.exp(-dt/Math.max(1e-6, tau));
    return x + (xTgt - x) * a;
  }

  // ---------------------------
  // route selector init
  // ---------------------------
  ROUTES.forEach((r, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    const dist = haversineKm(r.a.lat, r.a.lon, r.b.lat, r.b.lon);
    opt.textContent = `${r.name}  •  ${dist.toFixed(0)} km`;
    routeSel.appendChild(opt);
  });

  // ---------------------------
  // SIM state
  // ---------------------------
  const FT_TO_M = 0.3048;
  const M_TO_FT = 1/FT_TO_M;

  const state = {
    running:false,
    t:0,
    dt:1/30,
    routeIdx:0,

    phase:"READY",
    lastPhase:"READY",

    distKm:0,
    distTotalKm:haversineKm(ROUTES[0].a.lat, ROUTES[0].a.lon, ROUTES[0].b.lat, ROUTES[0].b.lon),

    // mission targets
    altTarget_m:0,
    machTarget:0,

    // actuals
    alt_m:0,
    mach:0,

    // aero/propulsion
    CdA:0.22,
    thrustBase_kN: 55.0,      // tuned so T>D across mission
    thrust_kN:0,
    drag_kN:0,
    q_kpa:0,
    pi:0.85,
    piEff:0.85,

    // engine actuators
    bleed:0.08,               // small baseline bleed
    phi:0.56,
    beta:0.0,

    // stability (always stable)
    health:0.92,
    _Ms:0.84,
    unstart:false,            // forced NO in this demo

    // thermal
    tempC:124.6,
    tempTarget:205,
    tempBand:5,
    flow:0.20,
    flowMin:0.20,
    flowMax:1.20,
    Kp:0.055,
    Ki:0.010,
    integ:0,

    // N2 liner
    n2Flow:0.0,
    n2Max:0.90,
    n2Tank:100.0,
    n2TankMax:100.0,
    filmFactor:1.00,

    // penalties (display)
    penThrust:0,
    penDrag:0,

    // disturbance
    disturbance:0,

    // clocks
    depOffset:0,
    arrOffset:0,
    startUtcMs: Date.now(),

    // event logs
    loggedTakeoff:false,
    loggedM3:false,
    loggedM10:false,
    loggedDesc:false,
    loggedLanding:false
  };

  function logLine(kind, msg){
    const div = document.createElement("div");
    div.className = "line " + (kind || "");
    div.textContent = `[${fmtMMSS(state.t)}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setRoute(idx){
    state.routeIdx = idx;
    const r = ROUTES[idx];
    state.distTotalKm = haversineKm(r.a.lat, r.a.lon, r.b.lat, r.b.lon);
    distTot.textContent = `${state.distTotalKm.toFixed(0)}`;

    state.depOffset = tzOffsetHoursFromLon(r.a.lon);
    state.arrOffset = tzOffsetHoursFromLon(r.b.lon);
    tzDep.textContent = `UTC${state.depOffset>=0?"+":""}${state.depOffset}`;
    tzArr.textContent = `UTC${state.arrOffset>=0?"+":""}${state.arrOffset}`;

    routeTxt.textContent = `${r.name} • ${state.distTotalKm.toFixed(0)} km`;
    logLine("t", `ROUTE selected: ${r.name} (${state.distTotalKm.toFixed(0)} km)`);
  }

  routeSel.addEventListener("change", () => {
    setRoute(Number(routeSel.value));
    if(!state.running){
      state.distKm = 0;
      state.phase = "READY";
      state.lastPhase = "READY";
      draw();
    }
  });

  // ---------------------------
  // Mission profile (YOUR requested behavior)
  // - Climb to 15,000 ft
  // - Mach ramps: 0 → 3 (takeoff) → 10 (cruise) → 3 (approach) → 0 (landing)
  // - Stable always (no “recovering”)
  // ---------------------------
  const ALT_PEAK_FT = 15000;
  const ALT_PEAK_M  = ALT_PEAK_FT * FT_TO_M;

  function updatePhaseAndTargets(){
    // based on distance fraction
    const f = state.distKm / Math.max(1, state.distTotalKm);

    if(state.phase === "READY") return;

    let newPhase = state.phase;

    if(f < 0.06) newPhase = "TAKEOFF";
    else if(f < 0.18) newPhase = "CLIMB";
    else if(f < 0.82) newPhase = "CRUISE";
    else if(f < 0.92) newPhase = "DESCENT";
    else if(f < 1.00) newPhase = "LANDING";
    else newPhase = "DONE";

    if(newPhase !== state.phase){
      state.phase = newPhase;
      logLine("t", `PHASE → ${state.phase}`);
      if(state.phase === "TAKEOFF"){ state.loggedTakeoff=false; state.loggedM3=false; }
      if(state.phase === "CRUISE"){ state.loggedM10=false; }
      if(state.phase === "DESCENT"){ state.loggedDesc=false; }
      if(state.phase === "LANDING"){ state.loggedLanding=false; }
    }

    // Set targets per phase (smoothened later)
    switch(state.phase){
      case "TAKEOFF":
        state.altTarget_m = 3000 * FT_TO_M;   // ~3,000 ft during roll/early climb
        state.machTarget  = 3.0;
        break;
      case "CLIMB":
        state.altTarget_m = ALT_PEAK_M;       // 15,000 ft
        state.machTarget  = 10.0;
        break;
      case "CRUISE":
        state.altTarget_m = ALT_PEAK_M;       // hold 15,000 ft
        state.machTarget  = 10.0;
        break;
      case "DESCENT":
        state.altTarget_m = 6000 * FT_TO_M;   // descend to ~6,000 ft
        state.machTarget  = 3.0;
        break;
      case "LANDING":
        state.altTarget_m = 0;
        state.machTarget  = 0.0;
        break;
      case "DONE":
        state.altTarget_m = 0;
        state.machTarget  = 0.0;
        break;
      default:
        state.altTarget_m = 0;
        state.machTarget  = 0.0;
    }
  }

  // ---------------------------
  // Physics + Safety (tuned for ALWAYS STABLE)
  // ---------------------------
  function step(){
    const dt = state.dt;
    state.t += dt;

    // clocks
    const nowUtc = state.startUtcMs + state.t*1000;
    clkUTC.textContent = fmtClock(nowUtc, 0);
    clkDep.textContent = fmtClock(nowUtc, state.depOffset);
    clkArr.textContent = fmtClock(nowUtc, state.arrOffset);
    tripTime.textContent = fmtMMSS(state.t);

    // gentle disturbance decay
    state.disturbance = smoothToward(state.disturbance, 0, 1.8, dt);

    // mission targets
    updatePhaseAndTargets();

    // Smooth altitude & Mach response (so gauges clearly move)
    // Altitude: ~8s time constant, Mach: ~5s (faster)
    if(autoHold.checked && state.phase !== "READY"){
      state.alt_m = smoothToward(state.alt_m, state.altTarget_m, 8.0, dt);
      state.mach  = smoothToward(state.mach,  state.machTarget,  5.0, dt);
    }

    // keep physical bounds
    state.alt_m = clamp(state.alt_m, 0, ALT_PEAK_M);
    state.mach  = clamp(state.mach, 0, 10.5);

    // atmosphere
    const rho = densityAtAlt(state.alt_m);
    const a   = aSoundAtAlt(state.alt_m);
    const V   = state.mach * a;

    // distance traveled
    state.distKm += (V * dt) / 1000;
    state.distKm = clamp(state.distKm, 0, state.distTotalKm);

    // progress
    const frac = state.distKm / Math.max(1, state.distTotalKm);
    progNow.textContent = `${Math.round(frac*100)}`;
    distNow.textContent = `${state.distKm.toFixed(0)}`;

    // q∞
    const q_pa = 0.5 * rho * V * V;
    state.q_kpa = clamp(q_pa/1000, 0, 999);

    // β small and smooth (watch-only)
    const betaBase = 0.20*Math.abs(Math.sin(state.t*0.05)) + 0.12*Math.abs(Math.sin(state.t*0.018));
    const betaDist = 0.25*clamp(Math.abs(state.disturbance), 0, 1);
    state.beta = clamp((betaBase + betaDist)*2.2, 0, 3.0);

    // Φ (fuel schedule) stays in safe band, moves slightly
    const phiBase = (state.phase==="CRUISE" ? 0.55 : (state.phase==="CLIMB" ? 0.57 : 0.52));
    state.phi = smoothToward(state.phi, phiBase + 0.02*Math.sin(state.t*0.07), 2.5, dt);
    state.phi = clamp(state.phi, 0.48, 0.62);

    // bleed small but moving
    const bleedBase = 0.08 + 0.04*Math.abs(Math.sin(state.t*0.09));
    state.bleed = smoothToward(state.bleed, bleedBase, 2.0, dt);
    state.bleed = clamp(state.bleed, 0.05, 0.18);

    // inlet Π and Πeff (gentle motion)
    state.pi = inletProxy(state.mach, state.q_kpa);
    const betaPen = Math.exp(-0.06*state.beta*state.beta);
    const phiPen  = 1 - 0.18*Math.pow(Math.abs(state.phi - 0.56)/0.10, 1.6);
    const bleedBenefit = 1 + 0.20*state.bleed;
    state.piEff = clamp(state.pi * betaPen * clamp(phiPen,0.75,1.02) * bleedBenefit, 0.55, 0.95);

    // Drag
    const waveRise = 1 + 0.10*clamp(state.mach - 2, 0, 10);
    const D_N = 0.5*rho*V*V*state.CdA*waveRise;

    // N2 liner used more when heating rises (and small during cruise)
    // In this stable demo: it actively maintains temp near target.
    const tempErr = (state.tempC - state.tempTarget);
    let n2Cmd = 0.0;
    n2Cmd += clamp((Math.abs(tempErr) - state.tempBand)/35, 0, 1) * 0.70;
    n2Cmd += clamp((state.q_kpa - 35)/80, 0, 1) * 0.40;
    n2Cmd += (state.phase==="CRUISE" ? 0.10 : 0.04);
    if(state.n2Tank <= 0.01) n2Cmd = 0;
    state.n2Flow = smoothToward(state.n2Flow, n2Cmd*state.n2Max, 1.8, dt);
    state.n2Tank = clamp(state.n2Tank - state.n2Flow*dt, 0, state.n2TankMax);

    // Liner factor: reduces heating (lower = cooler)
    state.filmFactor = clamp(1 - 0.28*(state.n2Flow/state.n2Max), 0.72, 1.00);

    // penalties from bleed + N2
    state.penDrag   = 0.10*state.bleed + 0.22*(state.n2Flow/state.n2Max);
    state.penThrust = clamp(0.18*state.bleed + 0.10*(state.n2Flow/state.n2Max), 0, 0.28);

    state.drag_kN = clamp((D_N/1000) + state.penDrag, 0, 9999);

    // Thrust
    // Tuned to keep margin comfortably positive at Mach 10 / 15kft in this simplified model.
    const densityScale = clamp(0.80 + 0.20*(rho/1.225), 0.75, 1.00);
    const throttle = clamp(0.65 + 0.35*(state.mach/10), 0.65, 1.00);
    const phiEff = clamp(1 - 0.20*Math.abs(state.phi - 0.56)/0.10, 0.85, 1.05);

    const baseT = state.thrustBase_kN * state.piEff * densityScale * throttle * phiEff;
    const ripple = 0.20*Math.sin(state.t*1.1) + 0.12*Math.sin(state.t*0.33);
    state.thrust_kN = clamp(baseT*(1 - state.penThrust) + ripple + 0.35*state.disturbance, 0, 999);

    // Thermal model (live)
    // filmFactor reduces heating, coolant + N2 stabilize around target
    const heat = (0.040*state.q_kpa) * (1 + 0.10*state.mach*state.mach) * state.filmFactor;
    const cool = 0.95*state.flow*(state.tempC - state.tempTarget)/55;
    state.tempC += (heat - cool) * dt;

    // Coolant PI (live)
    const eT = (state.tempTarget - state.tempC);
    state.integ += eT*dt;
    const ff = clamp(0.20 + 0.030*state.q_kpa + 0.012*state.mach, 0.20, 1.20);
    const u  = ff + state.Kp*(-eT) + state.Ki*(-state.integ);
    state.flow = clamp(u, state.flowMin, state.flowMax);

    // Stability health (kept in green band, still moving)
    const margin = state.thrust_kN - state.drag_kN;
    const marginGood = clamp((margin - 6)/18, 0, 1);      // wants margin ~6–24kN
    const inletGood  = clamp((state.piEff - 0.60)/0.30, 0, 1);
    const thermDev   = Math.abs(state.tempC - state.tempTarget);
    const thermGood  = clamp(1 - Math.max(0, (thermDev - state.tempBand)/55), 0, 1);
    const qGood      = clamp(1 - Math.max(0, (state.q_kpa - 120)/180), 0, 1); // allow large q in this demo

    let h = 0.36*marginGood + 0.30*inletGood + 0.22*thermGood + 0.12*qGood;

    // keep it always stable but not frozen
    h = clamp(h, 0.86, 0.98);
    h = h - 0.01*Math.abs(Math.sin(state.t*0.08)) - 0.02*clamp(Math.abs(state.disturbance),0,1);
    state.health = smoothToward(state.health, clamp(h,0.85,0.98), 1.2, dt);

    state._Ms = clamp((state.health - 0.5)*2, -1, 1);

    // This demo never shows unstart or recovering:
    state.unstart = false;

    // required events
    if(state.phase === "TAKEOFF" && !state.loggedTakeoff && state.mach >= 0.30){
      state.loggedTakeoff = true;
      logLine("t", `TAKEOFF roll: ${state.mach.toFixed(2)} M (${Math.round(V)} m/s)`);
    }
    if(!state.loggedM3 && state.mach >= 2.95){
      state.loggedM3 = true;
      logLine("t", `REACHED Mach 3: ${state.mach.toFixed(2)} M`);
    }
    if(state.phase === "CRUISE" && !state.loggedM10 && state.mach >= 9.90){
      state.loggedM10 = true;
      logLine("t", `CRUISE Mach 10 stable: ${state.mach.toFixed(2)} M`);
    }
    if(state.phase === "DESCENT" && !state.loggedDesc){
      state.loggedDesc = true;
      logLine("t", `DESCENT begins: slowing to Mach 3 and descending.`);
    }
    if(state.phase === "LANDING" && !state.loggedLanding && state.mach <= 0.25 && state.alt_m <= 200){
      state.loggedLanding = true;
      logLine("t", `LANDING: ${state.mach.toFixed(2)} M • ${Math.round(state.alt_m*M_TO_FT)} ft`);
    }

    if(state.phase === "DONE"){
      state.running = false;
      logLine("t", "TRIP complete (0 → Mach 3 → Mach 10 → Mach 3 → 0).");
    }
  }

  // ---------------------------
  // UI draw
  // ---------------------------
  function setFill(el, pct, kind){
    el.style.width = `${clamp(pct,0,100).toFixed(1)}%`;
    el.classList.remove("good","warn","bad");
    if(kind) el.classList.add(kind);
  }

  function draw(){
    const r = ROUTES[state.routeIdx];

    phaseTxt.textContent = state.phase;
    routeTxt.textContent = `${r.name} • ${state.distKm.toFixed(0)} / ${state.distTotalKm.toFixed(0)} km`;

    machNow.textContent = state.mach.toFixed(2);
    machTgt.textContent = state.machTarget.toFixed(2);

    const a = aSoundAtAlt(state.alt_m);
    const V = state.mach * a;
    vNow.textContent = Math.round(V).toString();

    altNow.textContent = Math.round(state.alt_m*M_TO_FT).toString();
    rhoNow.textContent = densityAtAlt(state.alt_m).toFixed(4);

    qNow.textContent = state.q_kpa.toFixed(1);

    thrustNow.textContent = state.thrust_kN.toFixed(1);
    dragNow.textContent = state.drag_kN.toFixed(1);

    const margin = state.thrust_kN - state.drag_kN;
    marginNow.textContent = `${margin>=0?"+":""}${margin.toFixed(1)}`;
    tdNow.textContent = `${margin>=0?"+":""}${margin.toFixed(1)} kN`;

    piNow.textContent = state.pi.toFixed(2);
    piEffNow.textContent = state.piEff.toFixed(2);
    cdaNow.textContent = state.CdA.toFixed(2);

    healthNow.textContent = state.health.toFixed(2);
    msNow.textContent = state._Ms.toFixed(2);
    unstartNow.textContent = "NO";

    bleedNow.textContent = Math.round(state.bleed*100).toString();
    phiNow.textContent = state.phi.toFixed(2);
    betaNow.textContent = state.beta.toFixed(1);

    penThrustNow.textContent = (state.penThrust*100).toFixed(1);
    penDragNow.textContent = state.penDrag.toFixed(2);

    tempNow.textContent = state.tempC.toFixed(1);
    flowNow.textContent = state.flow.toFixed(2);
    n2Now.textContent = state.n2Flow.toFixed(2);
    n2TankNow.textContent = state.n2Tank.toFixed(0);
    filmNow.textContent = state.filmFactor.toFixed(2);

    // status chip: ALWAYS STABLE (per your request)
    chipStable.textContent = "Status: STABLE";
    chipStable.classList.remove("warn","bad");
    chipStable.classList.add("good");

    // bars
    setFill(barHealth, state.health*100, "good");

    const qPct = clamp((state.q_kpa/200)*100, 0, 100); // scale so it moves in visible range
    let qKind = "good";
    if(state.q_kpa > 160) qKind = "warn";
    if(state.q_kpa > 190) qKind = "bad";
    setFill(barQ, qPct, qKind);

    const piPct = clamp(state.piEff*100, 0, 100);
    setFill(barPi, piPct, "good");

    const dev = Math.abs(state.tempC - state.tempTarget);
    const devPct = clamp((dev/60)*100, 0, 100);
    let tKind = "good";
    if(dev > state.tempBand) tKind = "warn";
    if(dev > (state.tempBand + 18)) tKind = "bad";
    setFill(barTherm, devPct, tKind);
  }

  // ---------------------------
  // loop
  // ---------------------------
  let raf = null;
  function tick(){
    if(!state.running){ raf=null; return; }
    step();
    draw();
    raf = requestAnimationFrame(tick);
  }

  // ---------------------------
  // controls
  // ---------------------------
  function hardReset(){
    const keepRoute = state.routeIdx;

    state.running = false;
    state.t = 0;
    state.phase = "READY";
    state.lastPhase = "READY";
    state.distKm = 0;

    state.altTarget_m = 0;
    state.machTarget = 0;

    state.alt_m = 0;
    state.mach = 0;

    state.CdA = 0.22;
    state.thrustBase_kN = 55.0;

    state.thrust_kN = 0;
    state.drag_kN = 0;
    state.q_kpa = 0;
    state.pi = 0.85;
    state.piEff = 0.85;

    state.bleed = 0.08;
    state.phi = 0.56;
    state.beta = 0;

    state.health = 0.92;
    state._Ms = 0.84;
    state.unstart = false;

    state.tempC = 124.6;
    state.flow = 0.20;
    state.integ = 0;

    state.n2Flow = 0.0;
    state.n2Tank = 100.0;
    state.filmFactor = 1.00;

    state.penThrust = 0;
    state.penDrag = 0;

    state.disturbance = 0;

    state.startUtcMs = Date.now();

    state.loggedTakeoff=false;
    state.loggedM3=false;
    state.loggedM10=false;
    state.loggedDesc=false;
    state.loggedLanding=false;

    logEl.innerHTML = "";
    setRoute(keepRoute);
    logLine("t", "RESET complete. Pick a trip and press Start.");
    draw();
  }

  btnStart.addEventListener("click", () => {
    if(state.running) return;

    if(state.phase === "READY"){
      state.phase = "TAKEOFF";
      state.startUtcMs = Date.now();
      logLine("t", "START: Mission profile engaged (0 → Mach 3 → Mach 10 → Mach 3 → 0).");
    } else if(state.phase === "DONE"){
      hardReset();
      state.phase = "TAKEOFF";
      state.startUtcMs = Date.now();
      logLine("t", "START: Restarting trip.");
    } else {
      logLine("t", "START: Resuming.");
    }

    state.running = true;
    if(!raf) raf = requestAnimationFrame(tick);
  });

  btnStop.addEventListener("click", () => {
    if(!state.running) return;
    state.running = false;
    logLine("w", "STOP: Simulation paused.");
  });

  btnReset.addEventListener("click", hardReset);

  btnInject.addEventListener("click", () => {
    // gentle bump (still stays stable)
    state.disturbance = clamp(state.disturbance + 0.7, 0, 1.0);
    state.tempC += 1.5 + 2.5*Math.random();
    logLine("w", "Disturbance injected (minor bump; stability remains STABLE).");
  });

  btnClearLog.addEventListener("click", () => {
    logEl.innerHTML = "";
    logLine("t", "Log cleared.");
  });

  // boot
  setRoute(0);
  routeSel.value = "0";
  hardReset();
})();
</script>
</body>
</html>
