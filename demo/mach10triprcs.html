<!-- ======================= PART 1 / 3 ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan → Paris Trip Simulator — Hotspot Compression + Zoned Assist</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1100px 700px at 25% -10%, rgba(96,165,250,.20), transparent 50%),
      radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.14), transparent 55%),
      linear-gradient(180deg, #050814 0%, #03050c 100%);
    color:var(--ink);
  }
  .wrap{max-width:1500px;margin:0 auto;padding:18px 14px 42px}
  header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}
  .row{display:grid;grid-template-columns: 480px 1fr;gap:14px;margin-top:14px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.92));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    padding:12px 14px 10px;
    border-bottom:1px solid var(--line);
    display:flex;justify-content:space-between;gap:10px;align-items:center;
  }
  .card .hd .t{font-weight:800;font-size:.98rem}
  .card .bd{padding:14px}

  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.24);font-size:.85rem;color:var(--muted);background:rgba(2,6,23,.35)}
  .mono{font-family:var(--mono)}
  .small{font-size:.90rem;color:var(--muted);line-height:1.25}
  .stat{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .k{color:var(--muted);font-size:.82rem}
  .v{font-family:var(--mono);font-size:1.05rem;margin-top:4px}
  .controls{display:grid;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  button{
    appearance:none;border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.55); color:var(--ink);
    padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;
  }
  button:hover{border-color:rgba(96,165,250,.55)}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.45;cursor:not-allowed}

  input[type="range"]{width:100%}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}

  .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.12);overflow:hidden;border:1px solid rgba(148,163,184,.16)}
  .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85))}

  .eq{
    font-family:var(--mono);
    font-size:.86rem;
    background:rgba(2,6,23,.35);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
    white-space:pre-wrap;
  }

  /* Lights */
  .lights{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .light{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    min-width:160px;
  }
  .bulb{width:14px;height:14px;border-radius:999px;background:rgba(148,163,184,.25);box-shadow:0 0 0 rgba(0,0,0,0)}
  .light .lbl{font-weight:800}
  .light .sub{font-size:.80rem;color:var(--muted);margin:0}
  .on-good .bulb{background:rgba(52,211,153,.95);box-shadow:0 0 18px rgba(52,211,153,.55)}
  .on-warn .bulb{background:rgba(251,191,36,.95);box-shadow:0 0 18px rgba(251,191,36,.55)}
  .on-bad  .bulb{background:rgba(251,113,133,.95);box-shadow:0 0 18px rgba(251,113,133,.55)}
  @keyframes blink { 0%, 49% {opacity:1} 50%, 100% {opacity:.25} }
  .blink{animation:blink .7s infinite}

  /* Chips */
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);color:var(--muted);font-size:.86rem
  }
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.5)}

  /* Map */
  .mapWrap{
    background:
      radial-gradient(900px 420px at 30% 0%, rgba(96,165,250,.18), transparent 55%),
      radial-gradient(700px 380px at 90% 25%, rgba(52,211,153,.12), transparent 60%),
      rgba(2,6,23,.25);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  canvas{display:block;width:100%;height:250px;border-radius:12px}
  .mapLegend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:.78rem;line-height:1.15;color:var(--muted)}
  .miniPill{padding:5px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.35);color:var(--muted);font-size:.78rem;max-width:100%}

  /* Timeline table */
  .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
  table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(2,6,23,.25)}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
  th{text-align:left;color:var(--muted);font-size:.85rem;position:sticky;top:0;background:rgba(7,10,20,.85);backdrop-filter: blur(6px)}
  tr.active{outline:2px solid rgba(96,165,250,.55);background:rgba(96,165,250,.08)}

  /* Hotspot panel (kept inside) */
  .hotWrap{border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.25);padding:10px}
  .hotTopLine{font-size:.82rem;color:var(--muted);line-height:1.2;margin-top:6px;word-break:break-word}
  .hotControls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;font-size:.82rem;color:var(--muted)}
  .hotControls label{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.16);background:rgba(2,6,23,.25)}
  .hotLegend{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;font-size:.78rem;color:var(--muted)}
  @media (max-width:520px){.hotLegend{grid-template-columns:1fr}}
  .hotLegend .lg{padding:6px 8px;border-radius:12px;border:1px solid rgba(148,163,184,.16);background:rgba(2,6,23,.25)}
  .swatch{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;vertical-align:middle}
  .swGray{background:rgba(148,163,184,.35)}
  .swHot{background:rgba(251,113,133,.95); box-shadow:0 0 12px rgba(251,113,133,.35)}
  .swAssist{background:rgba(96,165,250,.95); box-shadow:0 0 12px rgba(96,165,250,.35)}
  .hotSvgBox{margin-top:10px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:linear-gradient(180deg, rgba(2,6,23,.18), rgba(2,6,23,.30));overflow:hidden}
  .hotSvgBox svg{display:block;width:100%;height:auto;max-height:220px}
  .hotTable{margin-top:10px;border:1px solid rgba(148,163,184,.18);border-radius:14px;background:rgba(2,6,23,.22);overflow:hidden}
  .hotTable .hd2{padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.14);font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
  .hotScroll{max-height:140px;overflow:auto}
  .hotRow{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.10);font-size:.82rem}
  .hotRow:last-child{border-bottom:none}
  .hotRow .val{font-family:var(--mono);color:var(--muted)}
  .hotFooter{margin-top:8px;font-size:.80rem;color:var(--muted);line-height:1.2}

  /* Hotspot styles */
  .hsOff{fill:rgba(148,163,184,.22);stroke:rgba(148,163,184,.18);stroke-width:1}
  .hsHot{fill:rgba(251,113,133,.65);stroke:rgba(251,113,133,.95);stroke-width:1.2}
  .hsAssist{fill:rgba(96,165,250,.65);stroke:rgba(96,165,250,.95);stroke-width:1.2}
  .hsBlinkHot{animation: blink 0.7s infinite;}
  .hsBlinkAssist{animation: blink 0.7s infinite;}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Japan → Paris Trip Simulator (Live Readout)</h1>
      <div class="sub">
        Hotspot panel fixed to stay inside its card (smaller text + scroll list). Hotspot risk uses live
        <b>Mach</b>, <b>q</b>, <b>skin ΔT</b>, and <b>compression index</b>.
      </div>
    </div>
    <div class="legend">
      <span class="pill">Trip length: <b id="tripLen">—</b></span>
      <span class="pill">Playback: <b id="spdLbl">—</b></span>
      <span class="pill">Mass factor: <b id="massFactorLbl">—</b></span>
      <span class="pill">Status: <b id="statusLbl">—</b></span>
    </div>
  </header>

  <div class="row">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <div class="t">Controls • Instruments</div>
        <div class="pill mono">t = <span id="tNow">0.00</span> min</div>
      </div>
      <div class="bd">
        <div class="controls">
          <div class="btnrow">
            <button id="btnStart" type="button">Start</button>
            <button id="btnStop" type="button" disabled>Stop</button>
            <button id="btnReset" type="button">Reset</button>
          </div>

          <div class="stat">
            <div class="k">Playback speed (sim minutes per real second)</div>
            <input id="spd" type="range" min="1" max="240" value="60"/>
            <div class="small mono" style="margin-top:6px">
              Effective: <span id="effSpeedLbl">—</span> sim-min/s • ETA (real): <span id="etaRealLbl">—</span>
            </div>
          </div>

          <div class="stat">
            <div class="k">Trip progress</div>
            <div class="bar"><i id="prog"></i></div>
            <div class="small mono"><span id="progPct">0</span>% • step <span id="stepNow">—</span> • <span id="phaseNow">—</span></div>
          </div>

          <div class="split">
            <div class="stat"><div class="k">Mach (actual)</div><div class="v"><span id="mach">0.00</span></div></div>
            <div class="stat"><div class="k">Altitude (actual)</div><div class="v"><span id="alt">0.0</span> km</div></div>

            <div class="stat"><div class="k">Medium type</div><div class="v"><span id="medium">—</span></div></div>
            <div class="stat"><div class="k">Cold index</div><div class="v"><span id="cold">0.00</span></div></div>

            <div class="stat"><div class="k">Ambient temp</div><div class="v"><span id="Tamb">—</span> K</div></div>
            <div class="stat"><div class="k">Density</div><div class="v"><span id="rho">—</span> kg/m³</div></div>

            <div class="stat"><div class="k">Speed</div><div class="v"><span id="V">—</span> m/s</div></div>
            <div class="stat"><div class="k">Dynamic pressure</div><div class="v"><span id="q">—</span> kPa</div></div>

            <div class="stat"><div class="k">Heating proxy</div><div class="v"><span id="H">—</span></div></div>
            <div class="stat"><div class="k">Skin temperature</div><div class="v"><span id="Tskin">—</span> K</div></div>

            <div class="stat"><div class="k">Coolant flow (actual)</div><div class="v"><span id="cool">—</span> kg/s</div></div>
            <div class="stat"><div class="k">Stability score</div><div class="v"><span id="stab">—</span></div></div>
          </div>

          <div class="stat">
            <div class="k">Compression proxy</div>
            <div class="split" style="margin-top:10px">
              <div class="stat"><div class="k">Compression factor C</div><div class="v"><span id="compC">—</span></div></div>
              <div class="stat"><div class="k">Compression index (0..1)</div><div class="v"><span id="compIdx">—</span></div></div>
            </div>
            <div class="small" id="compNote" style="margin-top:8px">—</div>
          </div>

          <div class="stat">
            <div class="k">Stability annunciator</div>
            <div class="lights">
              <div class="light" id="lightStable"><div class="bulb"></div><div><div class="lbl">STABLE</div><p class="sub">Stab ≥ 0.70</p></div></div>
              <div class="light" id="lightCaution"><div class="bulb"></div><div><div class="lbl">CAUTION</div><p class="sub">0.45–0.70</p></div></div>
              <div class="light" id="lightUnstable"><div class="bulb"></div><div><div class="lbl">UNSTABLE</div><p class="sub">Stab &lt; 0.45</p></div></div>
            </div>
            <div class="small" id="annNote" style="margin-top:8px">—</div>
          </div>

          <div class="stat">
            <div class="k">CST discipline (from row)</div>
            <div class="small" id="cstNote">—</div>
          </div>

          <div class="stat">
            <div class="k">Quick status</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
              <span class="chip"><span class="dot" id="dotTherm"></span>Thermal</span>
              <span class="chip"><span class="dot" id="dotLoad"></span>Loads</span>
              <span class="chip"><span class="dot" id="dotNav"></span>Nav/INS</span>
              <span class="chip"><span class="dot" id="dotComm"></span>Comm/Plasma</span>
            </div>
            <div class="small" id="riskTxt" style="margin-top:8px">—</div>
          </div>

        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="hd">
        <div class="t">Explanation • Map • Hotspots • Mass & Fuel</div>
        <div class="pill mono">Live verified</div>
      </div>
      <div class="bd">

        <div class="eq"><b>Equations (core)</b>
Plan interpolation:
  s = clamp((t - t0)/(t1 - t0), 0..1)
  Mach_plan = Mach0 + s·(Mach1 - Mach0)
  Alt_plan  = Alt0  + s·(Alt1  - Alt0)

Mass-dependent lag:
  Mach += (Mach_plan - Mach) · (1 - exp(-dt/τMach))
  Alt  += (Alt_plan  - Alt ) · (1 - exp(-dt/τAlt))

Speed and pressure:
  V = Mach · a(Alt)
  q = ½ρV²

Heating proxy:
  H = q/q_ref

Compression proxy:
  C = 1 + (q/q_comp) + 0.12·Mach
  compIndex = clamp((C-1)/(C_bad-1), 0..1)

Thermal ODE:
  T' = k_heat·H·(Target - T) - k_cool_eff·(T - Tamb)

Hotspot risk (per zone):
  risk = wM·MachGate + wQ·qGate + wT·ΔTgate + wC·compIndex</div>

        <div class="stat" style="margin-top:12px">
          <div class="k">A → B Track (curved route) • moving aircraft icon • compression glow</div>
          <div class="mapWrap" style="margin-top:8px">
            <canvas id="map" width="900" height="320"></canvas>
            <div class="mapLegend">
              <span class="miniPill">A: Tokyo area</span>
              <span class="miniPill">B: Paris</span>
              <span class="miniPill">Glow increases with compression proxy</span>
            </div>
          </div>
        </div>

        <div class="stat" style="margin-top:12px">
          <div class="k"><b style="color:var(--ink)">Hotspot Compression + Cooling Map</b></div>
          <div class="hotWrap" style="margin-top:8px">
            <div class="hotTopLine" id="hotSummary">Hotspot system is IDLE.</div>

            <div class="hotControls">
              <label><input id="assistOn" type="checkbox" checked/> Zoned assist (ON/OFF)</label>
            </div>

            <div class="hotSvgBox">
              <svg viewBox="0 0 920 320" role="img" aria-label="Aircraft outline">
                <path d="M110 165 C170 120, 290 105, 420 110 C520 114, 610 135, 690 165 C610 195, 520 216, 420 220 C290 226, 170 210, 110 165Z"
                      fill="rgba(148,163,184,.08)" stroke="rgba(148,163,184,.22)" stroke-width="2"/>
                <path d="M330 160 L130 85 L140 78 L360 140 Z"
                      fill="rgba(148,163,184,.06)" stroke="rgba(148,163,184,.18)" stroke-width="2"/>
                <path d="M360 190 L140 252 L130 244 L330 170 Z"
                      fill="rgba(148,163,184,.06)" stroke="rgba(148,163,184,.18)" stroke-width="2"/>

                <circle id="hsNose" cx="115" cy="165" r="22" class="hsOff"/>
                <path id="hsLE" d="M210 118 L138 86 L366 142 L320 156 Z" class="hsOff"/>
                <path id="hsInlet" d="M230 150 C255 140, 290 140, 310 150 C290 163,255 165,230 150 Z" class="hsOff"/>
                <circle id="hsJunction" cx="330" cy="165" r="18" class="hsOff"/>
                <circle id="hsGaps" cx="700" cy="165" r="18" class="hsOff"/>
              </svg>
            </div>

            <div class="hotLegend">
              <div class="lg"><span class="swatch swGray"></span>OFF (gray)</div>
              <div class="lg"><span class="swatch swHot"></span>HOT (red blink)</div>
              <div class="lg"><span class="swatch swAssist"></span>ASSIST (blue blink)</div>
            </div>

            <div class="hotTable">
              <div class="hd2">
                <span>Per-zone status (risk %)</span>
                <span class="mono" id="assistApplied">Assist: none</span>
              </div>
              <div class="hotScroll">
                <div class="hotRow"><span>Nose / stagnation</span><span class="val" id="riskNose">0%</span></div>
                <div class="hotRow"><span>Leading edges</span><span class="val" id="riskLE">0%</span></div>
                <div class="hotRow"><span>Inlet / forebody</span><span class="val" id="riskInlet">0%</span></div>
                <div class="hotRow"><span>Wing-body junction</span><span class="val" id="riskJunc">0%</span></div>
                <div class="hotRow"><span>Control-surface gaps</span><span class="val" id="riskGaps">0%</span></div>
              </div>
            </div>

            <div class="hotFooter" id="hotNote">—</div>
          </div>
        </div>

        <div class="stat" style="margin-top:12px">
          <div class="k">Mass & Fuel (sliders)</div>
          <div class="split" style="margin-top:10px">
            <div class="stat"><div class="k">Airframe mass</div><input id="mAir" type="range" min="10000" max="120000" step="500" value="52000"/><div class="small mono"><span id="mAirLbl">52000</span> kg</div></div>
            <div class="stat"><div class="k">Scram system mass</div><input id="mScramSys" type="range" min="500" max="20000" step="100" value="4500"/><div class="small mono"><span id="mScramSysLbl">4500</span> kg</div></div>
            <div class="stat"><div class="k">Jet fuel (capacity)</div><input id="mJetFuel" type="range" min="0" max="60000" step="250" value="18000"/><div class="small mono"><span id="mJetFuelLbl">18000</span> kg</div></div>
            <div class="stat"><div class="k">Scram fuel (capacity)</div><input id="mScramFuel" type="range" min="0" max="40000" step="250" value="9000"/><div class="small mono"><span id="mScramFuelLbl">9000</span> kg</div></div>
            <div class="stat"><div class="k">Coolant (capacity)</div><input id="mCoolant" type="range" min="0" max="12000" step="50" value="2200"/><div class="small mono"><span id="mCoolantLbl">2200</span> kg</div></div>
            <div class="stat"><div class="k">Unmanned</div><label class="small" style="display:flex;gap:10px;align-items:center;margin-top:8px"><input id="unmanned" type="checkbox" checked/> Unmanned flight</label><div class="small mono" style="margin-top:6px">Total mass: <span id="mTotalLbl">—</span> kg</div></div>
          </div>

          <div class="split" style="margin-top:10px">
            <div class="stat">
              <div class="k">Remaining tanks</div>
              <div class="small mono" style="margin-top:8px">Jet fuel: <span id="jetRemainLbl">—</span> / <span id="jetCapLbl">—</span> kg</div>
              <div class="bar" style="margin-top:6px"><i id="jetBar"></i></div>
              <div class="small mono" style="margin-top:10px">Scram fuel: <span id="scramRemainLbl">—</span> / <span id="scramCapLbl">—</span> kg</div>
              <div class="bar" style="margin-top:6px"><i id="scramBar"></i></div>
              <div class="small mono" style="margin-top:10px">Coolant: <span id="coolRemainLbl">—</span> / <span id="coolCapLbl">—</span> kg</div>
              <div class="bar" style="margin-top:6px"><i id="coolBar"></i></div>
            </div>
            <div class="stat">
              <div class="k">Medium type (altitude bands)</div>
              <div class="eq" style="margin-top:8px">0–12 km: Troposphere
12–50 km: Stratosphere
50–85 km: Mesosphere
85+ km: Thermosphere</div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <div style="height:14px"></div>

  <section class="card">
    <div class="hd">
      <div class="t">Row-by-row Timeline</div>
      <div class="pill mono">Active row highlights while running</div>
    </div>
    <div class="bd">
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Step</th><th>Phase</th><th>Start–End (min)</th><th>Speed plan</th><th>Alt band (km)</th>
              <th>Distance (km)</th><th>Fuel / Mode</th><th>EM</th><th>Plasma</th><th>INS reliance</th><th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div><!-- wrap -->
<!-- ======================= PART 2 / 3 ======================= -->
<script>
/* ===================== DATA (trip + atmosphere) ===================== */
const TRIP_LEN_MIN = 146.0;

const STEPS = [
  {"step":1,"phase":"Takeoff + initial climb","t0":0.0,"t1":15.0,"mach0":0.0,"mach1":1.0,"alt0":0.0,"alt1":12.0,"speedPlan":"0 → ~Mach 1","distKm":123.0,"fuelMode":"Jet fuel","notes":"Runway to high climb","em":"LOW (surface)","plasma":"NONE","ins":"LOW","cst":"Initialize CST baseline; timestamp discipline begins at takeoff."},
  {"step":2,"phase":"Climb + accelerate to Mach 3 corridor","t0":15.0,"t1":40.0,"mach0":1.0,"mach1":3.0,"alt0":12.0,"alt1":30.0,"speedPlan":"Mach 1 → Mach 3","distKm":926.0,"fuelMode":"Jet fuel","notes":"Transition into thinner air; heating begins to rise.","em":"LOW→MOD","plasma":"NONE→MAYBE","ins":"LOW→MOD","cst":"Monitor time drift; tighten timing discipline as heating increases."},
  {"step":3,"phase":"Ramp up (controlled)","t0":40.0,"t1":50.0,"mach0":3.0,"mach1":10.0,"alt0":30.0,"alt1":45.0,"speedPlan":"Mach 3 → Mach 10","distKm":1338.0,"fuelMode":"Scramjet / mixed-mode","notes":"Peak heating window; plasma and comm risk increases.","em":"MOD→HIGH","plasma":"MAYBE→LIKELY","ins":"HIGH","cst":"Mode switch: predict blackout; increase INS weight; keep logs coherent."},
  {"step":4,"phase":"Mach-10 cruise window","t0":50.0,"t1":60.0,"mach0":10.0,"mach1":10.0,"alt0":45.0,"alt1":55.0,"speedPlan":"Mach 10 steady","distKm":2058.0,"fuelMode":"Scramjet (steady)","notes":"Short Mach-10 window; most sensitive to thermal margins.","em":"HIGH","plasma":"LIKELY","ins":"HIGH","cst":"Hold time coherence through sensor dropouts; deterministic logging."},
  {"step":5,"phase":"Ramp down (controlled)","t0":60.0,"t1":70.0,"mach0":10.0,"mach1":3.0,"alt0":55.0,"alt1":35.0,"speedPlan":"Mach 10 → Mach 3","distKm":1338.0,"fuelMode":"Scramjet → turbine/ram","notes":"Recover comms; reduce heating; stabilize inlet margin.","em":"HIGH→MOD","plasma":"LIKELY→MAYBE","ins":"HIGH→MOD","cst":"Reacquire clocks; smooth handoff back to comm-aided nav."},
  {"step":6,"phase":"Long midcourse at Mach 3","t0":70.0,"t1":126.0,"mach0":3.0,"mach1":3.0,"alt0":25.0,"alt1":30.0,"speedPlan":"Mach 3 steady","distKm":4138.0,"fuelMode":"Ramjet / turbine","notes":"Main distance segment; optimize range.","em":"MOD","plasma":"MAYBE","ins":"MOD","cst":"Maintain long-term timing stability; periodic sync checks."},
  {"step":7,"phase":"Descent + landing","t0":126.0,"t1":146.0,"mach0":3.0,"mach1":0.0,"alt0":30.0,"alt1":0.0,"speedPlan":"Mach 3 → 0","distKm":540.0,"fuelMode":"Turbine + landing","notes":"Thermal cooldown; return to dense air.","em":"MOD→LOW","plasma":"NONE","ins":"LOW","cst":"Finalize logs; archive mission timeline."}
];

const ATM = [
  {alt_km:0, T:288.15, rho:1.2250, a:340.29},
  {alt_km:5, T:255.65, rho:0.7361, a:320.53},
  {alt_km:10,T:223.15, rho:0.4127, a:299.46},
  {alt_km:15,T:216.65, rho:0.1937, a:295.07},
  {alt_km:20,T:216.65, rho:0.0880, a:295.10},
  {alt_km:25,T:221.65, rho:0.0395, a:298.50},
  {alt_km:30,T:226.65, rho:0.0180, a:301.80},
  {alt_km:35,T:237.05, rho:0.0082, a:308.60},
  {alt_km:40,T:251.05, rho:0.0039, a:317.60},
  {alt_km:45,T:265.05, rho:0.0019, a:326.40},
  {alt_km:50,T:270.65, rho:0.0010, a:329.80},
  {alt_km:55,T:259.45, rho:0.00054,a:322.90},
  {alt_km:60,T:245.45, rho:0.00029,a:314.10},
  {alt_km:65,T:231.45, rho:0.00015,a:305.00}
];

/* ===================== HELPERS ===================== */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const el = (id)=>document.getElementById(id);
function fmt(x,d){ if(!isFinite(x)) return "—"; return Number(x).toFixed(d==null?2:d); }
function fmtInt(x){ if(!isFinite(x)) return "—"; return String(Math.round(x)); }
function interp1(x,x0,y0,x1,y1){ if(x1===x0) return y0; const s=(x-x0)/(x1-x0); return y0+s*(y1-y0); }

function atmAt(altKm){
  const x = clamp(altKm, ATM[0].alt_km, ATM[ATM.length-1].alt_km);
  for(let i=0;i<ATM.length-1;i++){
    const a0=ATM[i], a1=ATM[i+1];
    if(x>=a0.alt_km && x<=a1.alt_km){
      return {
        T:   interp1(x,a0.alt_km,a0.T,  a1.alt_km,a1.T),
        rho: interp1(x,a0.alt_km,a0.rho,a1.alt_km,a1.rho),
        a:   interp1(x,a0.alt_km,a0.a,  a1.alt_km,a1.a)
      };
    }
  }
  return {T:ATM[0].T,rho:ATM[0].rho,a:ATM[0].a};
}

function stepAt(tMin){
  for(const s of STEPS) if(tMin>=s.t0 && tMin<s.t1) return s;
  return STEPS[STEPS.length-1];
}

function mediumType(altKm){
  if(altKm<12) return "Troposphere";
  if(altKm<50) return "Stratosphere";
  if(altKm<85) return "Mesosphere";
  return "Thermosphere";
}
function coldIndex(TambK){
  const T_warm=288.15, T_cold=216.65;
  return clamp((T_warm-TambK)/(T_warm-T_cold),0,1);
}
function escapeHtml(str){
  return String(str??"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* ===================== TABLE BUILD ===================== */
const tbody = el("tbody");
const rowEls = new Map();

function buildTable(){
  tbody.innerHTML="";
  for(const s of STEPS){
    const tr=document.createElement("tr");
    tr.dataset.step=String(s.step);
    tr.innerHTML = `
      <td class="mono">${s.step}</td>
      <td>${escapeHtml(s.phase)}</td>
      <td class="mono">${fmt(s.t0,0)}–${fmt(s.t1,0)}</td>
      <td>${escapeHtml(s.speedPlan)}</td>
      <td class="mono">${fmt(s.alt0,0)}→${fmt(s.alt1,0)}</td>
      <td class="mono">${fmt(s.distKm,0)}</td>
      <td>${escapeHtml(s.fuelMode)}</td>
      <td>${escapeHtml(s.em)}</td>
      <td>${escapeHtml(s.plasma)}</td>
      <td>${escapeHtml(s.ins)}</td>
      <td>${escapeHtml(s.notes)}</td>
    `;
    tbody.appendChild(tr);
    rowEls.set(s.step,tr);
  }
}
function highlightStep(step){
  for(const [k,tr] of rowEls.entries()){
    tr.classList.toggle("active", step===k);
  }
}

/* ===================== UI REFS ===================== */
const btnStart=el("btnStart"), btnStop=el("btnStop"), btnReset=el("btnReset");
const spd=el("spd"), spdLbl=el("spdLbl");
const tripLen=el("tripLen"), statusLbl=el("statusLbl");
const massFactorLbl=el("massFactorLbl"), effSpeedLbl=el("effSpeedLbl"), etaRealLbl=el("etaRealLbl");

const tNow=el("tNow"), prog=el("prog"), progPct=el("progPct"), stepNow=el("stepNow"), phaseNow=el("phaseNow");
const machEl=el("mach"), altEl=el("alt"), mediumEl=el("medium"), coldEl=el("cold");
const TambEl=el("Tamb"), rhoEl=el("rho"), VEl=el("V"), qEl=el("q"), HEl=el("H"), TskinEl=el("Tskin");
const coolEl=el("cool"), stabEl=el("stab");

const compCEl=el("compC"), compIdxEl=el("compIdx"), compNote=el("compNote");
const cstNote=el("cstNote");

const lightStable=el("lightStable"), lightCaution=el("lightCaution"), lightUnstable=el("lightUnstable");
const annNote=el("annNote");

const dotTherm=el("dotTherm"), dotLoad=el("dotLoad"), dotNav=el("dotNav"), dotComm=el("dotComm");
const riskTxt=el("riskTxt");

const mapCanvas=el("map");
const ctx=mapCanvas.getContext("2d");

/* Mass & tank refs */
const mAir=el("mAir"), mScramSys=el("mScramSys"), mJetFuel=el("mJetFuel"), mScramFuel=el("mScramFuel"), mCoolant=el("mCoolant"), unmanned=el("unmanned");
const mAirLbl=el("mAirLbl"), mScramSysLbl=el("mScramSysLbl"), mJetFuelLbl=el("mJetFuelLbl"), mScramFuelLbl=el("mScramFuelLbl"), mCoolantLbl=el("mCoolantLbl"), mTotalLbl=el("mTotalLbl");
const jetRemainLbl=el("jetRemainLbl"), scramRemainLbl=el("scramRemainLbl"), coolRemainLbl=el("coolRemainLbl");
const jetCapLbl=el("jetCapLbl"), scramCapLbl=el("scramCapLbl"), coolCapLbl=el("coolCapLbl");
const jetBar=el("jetBar"), scramBar=el("scramBar"), coolBar=el("coolBar");

/* Hotspot refs */
const assistOn=el("assistOn"), hotSummary=el("hotSummary"), hotNote=el("hotNote"), assistApplied=el("assistApplied");
const riskNose=el("riskNose"), riskLE=el("riskLE"), riskInlet=el("riskInlet"), riskJunc=el("riskJunc"), riskGaps=el("riskGaps");
const hsNose=el("hsNose"), hsLE=el("hsLE"), hsInlet=el("hsInlet"), hsJunction=el("hsJunction"), hsGaps=el("hsGaps");
</script>
<!-- ======================= PART 3 / 3 ======================= -->
<script>
/* ===================== TUNABLES ===================== */
const q_ref_kPa = 50.0;
const q_bad_kPa = 120.0;
const H_bad = 2.0;

const q_comp_kPa = 35.0;
const C_bad = 6.0;

const k_heat = 0.35;
const k_cool = 0.08;
const deltaHot = 50.0;

const m_min = 0.20;
const m_max = 1.20;
const gH = 0.55, gCold = 0.18, gMach = 0.15;

const wq=0.33, wH=0.33, wRamp=0.18, wBand=0.10, wTrack=0.06;

const burnJet_takeoff=55, burnJet_mid=40, burnJet_land=30;
const burnScram_ramp=85, burnScram_cruise=110;

const refMass = 75000;
const tauMach_base = 10.0;
const tauAlt_base  = 14.0;

/* Hotspot tunables */
const HOT_ARM_MACH = 1.2;
const HOT_STRONG_MACH = 3.0;
const HOT_ON = 0.62;
const HOT_ENGAGE = 0.72;

const ASSIST_FLOW_BUMP_PER_ZONE = 0.05;
const ASSIST_MAX_FLOW_BUMP = 0.18;
const ASSIST_DELTAHOT_RELIEF_PER_ZONE = 4.0;
const ASSIST_MAX_DELTAHOT_RELIEF = 18.0;

/* ===================== STATE ===================== */
let running=false;
let tMin=0.0;
let lastTs=null;

let MachAct=0.0, AltAct=0.0;
let Tskin=atmAt(0).T;
let lastCoolFlow=0.0;

let jetCap=0, scramCap=0, coolCap=0;
let jetFuelRemain=0, scramFuelRemain=0, coolantRemain=0;

let unstableHoldSec=0.0;

/* ===================== UTILS ===================== */
function setStatus(txt){
  statusLbl.textContent = txt;
  statusLbl.style.color = (txt==="Running") ? "var(--good)" : (txt==="Ended") ? "var(--warn)" : "var(--warn)";
}
function setButtons(){
  btnStart.disabled = running;
  btnStop.disabled  = !running;
}
function dotColor(dotEl, level){
  const c = (level<0.33) ? "rgba(52,211,153,.85)" : (level<0.66) ? "rgba(251,191,36,.85)" : "rgba(251,113,133,.85)";
  dotEl.style.background=c;
}

function totalMass(){
  return Number(mAir.value)+Number(mScramSys.value)+Number(mJetFuel.value)+Number(mScramFuel.value)+Number(mCoolant.value);
}
function massFactor(){
  const tm=Math.max(1,totalMass());
  return clamp(Math.sqrt(refMass/tm),0.65,1.10);
}
function effectiveSpeedSimMinPerSec(){
  return Number(spd.value)*massFactor();
}
function tauMachSec(){
  const tm=Math.max(1,totalMass());
  return tauMach_base*Math.pow(tm/refMass,0.70);
}
function tauAltSec(){
  const tm=Math.max(1,totalMass());
  return tauAlt_base*Math.pow(tm/refMass,0.70);
}

function rampMetric(step){
  const dt=Math.max(1e-9, step.t1-step.t0);
  const dMach=Math.abs(step.mach1-step.mach0)/dt;
  const dAlt=Math.abs(step.alt1-step.alt0)/dt;
  return clamp(dMach/1.0 + 0.6*(dAlt/2.0),0,1);
}
function bandPenalty(step){
  let p=0;
  const plasma=String(step.plasma||"").toUpperCase();
  const ins=String(step.ins||"").toUpperCase();
  if(plasma.indexOf("LIKELY")>=0) p+=0.6;
  else if(plasma.indexOf("MAYBE")>=0) p+=0.3;
  if(ins.indexOf("HIGH")>=0) p+=0.5;
  else if(ins.indexOf("MOD")>=0) p+=0.25;
  return clamp(p/1.2,0,1);
}
function stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen){
  const qn=clamp(q_kPa/q_bad_kPa,0,1);
  const Hn=clamp(H/H_bad,0,1);
  const score=1-(wq*qn + wH*Hn + wRamp*ramp + wBand*bandPen + wTrack*trackPen + inertiaPen);
  return clamp(score,0,1);
}
function coolantCommand(H, Cold, Mach){
  return clamp(m_min + gH*H + gCold*Cold + gMach*(Mach/10.0), m_min, m_max);
}
function burnRatesForStep(step){
  const st=step.step;
  if(st===1||st===2) return {jet:burnJet_takeoff, scram:0};
  if(st===6) return {jet:burnJet_mid, scram:0};
  if(st===7) return {jet:burnJet_land, scram:0};
  if(st===3||st===5) return {jet:0, scram:burnScram_ramp};
  if(st===4) return {jet:0, scram:burnScram_cruise};
  return {jet:0, scram:0};
}

/* ===================== HOTSPOT MODEL ===================== */
function machGate(M){
  if(M < HOT_ARM_MACH) return 0;
  if(M < HOT_STRONG_MACH){
    return clamp((M - HOT_ARM_MACH)/(HOT_STRONG_MACH - HOT_ARM_MACH),0,1)*0.6;
  }
  return 0.6 + 0.4*clamp((M - HOT_STRONG_MACH)/(10 - HOT_STRONG_MACH),0,1);
}
function qGate(q_kPa){ return clamp(q_kPa/120.0,0,1); }
function dTGate(TskinK, TambK){
  const dT=Math.max(0, TskinK - TambK);
  return clamp(dT/180.0,0,1);
}
function zoneRisk(w, mG,qG,tG,compIdx){
  return clamp(w.wM*mG + w.wQ*qG + w.wT*tG + w.wC*compIdx, 0, 1);
}
function setHS(elm, mode){
  elm.classList.remove("hsOff","hsHot","hsAssist","hsBlinkHot","hsBlinkAssist");
  if(mode==="HOT") elm.classList.add("hsHot","hsBlinkHot");
  else if(mode==="ASSIST") elm.classList.add("hsAssist","hsBlinkAssist");
  else elm.classList.add("hsOff");
}
function pctTxt(x){ return String(Math.round(clamp(x,0,1)*100)) + "%"; }

/* ===================== MAP DRAW ===================== */
const Apos={x:0.18,y:0.62}, Bpos={x:0.78,y:0.40};
function drawMap(progress01, compIndex01){
  const W=mapCanvas.width, H=mapCanvas.height;
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle="rgba(2,6,23,0.20)";
  ctx.fillRect(0,0,W,H);

  ctx.lineWidth=1;
  for(let i=0;i<=12;i++){
    const x=(i/12)*W;
    ctx.strokeStyle="rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for(let j=0;j<=6;j++){
    const y=(j/6)*H;
    ctx.strokeStyle="rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  const ax=Apos.x*W, ay=Apos.y*H;
  const bx=Bpos.x*W, by=Bpos.y*H;
  const cx1=W*0.42, cy1=H*0.10;
  const cx2=W*0.58, cy2=H*0.08;

  ctx.strokeStyle="rgba(52,211,153,0.35)";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(ax,ay);
  ctx.bezierCurveTo(cx1,cy1,cx2,cy2,bx,by);
  ctx.stroke();

  function dot(x,y,r,c){
    ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  dot(ax,ay,6,"rgba(96,165,250,0.95)");
  dot(bx,by,6,"rgba(251,191,36,0.95)");

  const t=clamp(progress01,0,1);

  function bezPoint(tt){
    const omt = 1-tt;
    const omt2 = omt*omt;
    const tt2 = tt*tt;
    const x = (omt2*omt)*ax + 3*(omt2)*tt*cx1 + 3*omt*(tt2)*cx2 + (tt2*tt)*bx;
    const y = (omt2*omt)*ay + 3*(omt2)*tt*cy1 + 3*omt*(tt2)*cy2 + (tt2*tt)*by;
    return {x,y};
  }
  const p=bezPoint(t);
  const p2=bezPoint(clamp(t+0.01,0,1));
  const ang=Math.atan2(p2.y-p.y, p2.x-p.x);

  const glow=clamp(compIndex01||0,0,1);
  if(glow>0.02){
    ctx.save();
    ctx.globalAlpha=0.6*glow;
    ctx.strokeStyle="rgba(96,165,250,1)";
    ctx.lineWidth=7;
    ctx.beginPath();
    ctx.arc(p.x,p.y,16+18*glow,0,Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  ctx.save();
  ctx.translate(p.x,p.y);
  ctx.rotate(ang);
  ctx.fillStyle="rgba(251,113,133,0.92)";
  ctx.beginPath();
  ctx.moveTo(10,0);
  ctx.lineTo(-8,6);
  ctx.lineTo(-5,0);
  ctx.lineTo(-8,-6);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ===================== RENDER ===================== */
function updateMassLabels(){
  mAirLbl.textContent=String(Number(mAir.value));
  mScramSysLbl.textContent=String(Number(mScramSys.value));
  mJetFuelLbl.textContent=String(Number(mJetFuel.value));
  mScramFuelLbl.textContent=String(Number(mScramFuel.value));
  mCoolantLbl.textContent=String(Number(mCoolant.value));
  mTotalLbl.textContent=String(Math.round(totalMass()));
  massFactorLbl.textContent=fmt(massFactor(),2)+"×";
}

function syncCapsFromSliders(){
  jetCap=Number(mJetFuel.value);
  scramCap=Number(mScramFuel.value);
  coolCap=Number(mCoolant.value);
  jetCapLbl.textContent=fmt(jetCap,0);
  scramCapLbl.textContent=fmt(scramCap,0);
  coolCapLbl.textContent=fmt(coolCap,0);
}

function setTankBars(){
  jetRemainLbl.textContent=fmt(jetFuelRemain,0);
  scramRemainLbl.textContent=fmt(scramFuelRemain,0);
  coolRemainLbl.textContent=fmt(coolantRemain,0);

  const jp=jetCap>0?clamp(jetFuelRemain/jetCap,0,1):0;
  const sp=scramCap>0?clamp(scramFuelRemain/scramCap,0,1):0;
  const cp=coolCap>0?clamp(coolantRemain/coolCap,0,1):0;

  jetBar.style.width=(jp*100).toFixed(1)+"%";
  scramBar.style.width=(sp*100).toFixed(1)+"%";
  coolBar.style.width=(cp*100).toFixed(1)+"%";
}

function setAnnunciator(stab){
  const STABLE_T=0.70, UNSTABLE_T=0.45;
  lightStable.className="light";
  lightCaution.className="light";
  lightUnstable.className="light";

  if(!running){
    annNote.textContent="Stopped: annunciator idle.";
    return;
  }

  let state="STABLE";
  if(stab<UNSTABLE_T) state="UNSTABLE";
  else if(stab<STABLE_T) state="CAUTION";

  if(state==="UNSTABLE") unstableHoldSec=2.5;
  if(unstableHoldSec>0 && state!=="UNSTABLE") state="CAUTION";

  if(state==="STABLE"){
    lightStable.classList.add("on-good");
    annNote.textContent="Stable.";
  }else if(state==="CAUTION"){
    lightCaution.classList.add("on-warn","blink");
    annNote.textContent="Caution (recovering / marginal).";
  }else{
    lightUnstable.classList.add("on-bad","blink");
    annNote.textContent="Unstable.";
  }
}

function plannedAt(t){
  const s=stepAt(t);
  const span=Math.max(1e-9, (s.t1-s.t0));
  const frac=clamp((t-s.t0)/span,0,1);
  return {
    s,
    MachPlan: s.mach0 + frac*(s.mach1-s.mach0),
    AltPlan:  s.alt0  + frac*(s.alt1 -s.alt0)
  };
}

function render(){
  const P=plannedAt(tMin);
  const s=P.s;

  const A=atmAt(AltAct);
  const V=MachAct*A.a;
  const q_kPa=0.5*A.rho*V*V/1000.0;
  const H=q_kPa/q_ref_kPa;

  const med=mediumType(AltAct);
  const Cold=coldIndex(A.T);

  const ramp=rampMetric(s);
  const bandPen=bandPenalty(s);

  const eMach=Math.abs(P.MachPlan-MachAct);
  const eAlt=Math.abs(P.AltPlan-AltAct);
  const trackPen=clamp((eMach/2.5) + 0.35*(eAlt/12.0),0,1);

  const tm=totalMass();
  let inertiaPen=0.09*clamp((tm/refMass)-1.0,0,1.0);
  if(unmanned.checked) inertiaPen*=0.75;

  const stab=stabilityScore(q_kPa,H,ramp,bandPen,inertiaPen,trackPen);

  const C=1 + (q_kPa/q_comp_kPa) + 0.12*MachAct;
  const compIdx=clamp((C-1)/(C_bad-1),0,1);

  tNow.textContent=fmt(tMin,2);
  const pct=clamp((tMin/TRIP_LEN_MIN)*100,0,100);
  prog.style.width=pct.toFixed(1)+"%";
  progPct.textContent=pct.toFixed(0);

  stepNow.textContent=String(s.step);
  phaseNow.textContent=s.phase;

  machEl.textContent=fmt(MachAct,2);
  altEl.textContent=fmt(AltAct,1);
  mediumEl.textContent=med;
  coldEl.textContent=fmt(Cold,2);

  TambEl.textContent=fmt(A.T,2);
  rhoEl.textContent=fmt(A.rho,4);
  VEl.textContent=fmtInt(V);
  qEl.textContent=fmt(q_kPa,1);
  HEl.textContent=fmt(H,2);
  TskinEl.textContent=fmt(Tskin,2);

  coolEl.textContent=fmt(lastCoolFlow,2);
  stabEl.textContent=fmt(stab,2);

  compCEl.textContent=fmt(C,2);
  compIdxEl.textContent=fmt(compIdx,2);
  compNote.textContent="q="+fmt(q_kPa,1)+" kPa • Mach="+fmt(MachAct,2)+" • C="+fmt(C,2)+" • compIndex="+fmt(compIdx,2);

  cstNote.textContent=s.cst||"—";

  const thermRisk=clamp((Tskin-A.T)/120.0,0,1);
  const loadRisk=clamp(q_kPa/q_bad_kPa,0,1);
  const navRisk=bandPen;
  const plasma=String(s.plasma||"").toUpperCase();
  const commRisk=plasma.indexOf("LIKELY")>=0 ? 1 : plasma.indexOf("MAYBE")>=0 ? 0.5 : 0.1;

  dotColor(dotTherm,thermRisk);
  dotColor(dotLoad,loadRisk);
  dotColor(dotNav,navRisk);
  dotColor(dotComm,commRisk);

  riskTxt.innerHTML =
    "PlanMach=<span class='mono'>"+fmt(P.MachPlan,2)+"</span> • "+
    "LagMach=<span class='mono'>"+fmt(eMach,2)+"</span> • "+
    "LagAlt=<span class='mono'>"+fmt(eAlt,1)+"km</span> • "+
    "Stability=<span class='mono'>"+fmt(stab,2)+"</span>";

  highlightStep(s.step);
  drawMap(tMin/TRIP_LEN_MIN, compIdx);

  updateMassLabels();
  syncCapsFromSliders();
  setTankBars();
  setAnnunciator(stab);

  /* ===== Hotspot rendering ===== */
  const armed = (MachAct >= HOT_ARM_MACH);
  const mG=machGate(MachAct), qG=qGate(q_kPa), tG=dTGate(Tskin,A.T);

  const wN={wM:0.18,wQ:0.34,wT:0.34,wC:0.14};
  const wL={wM:0.20,wQ:0.30,wT:0.35,wC:0.15};
  const wI={wM:0.24,wQ:0.30,wT:0.26,wC:0.20};
  const wJ={wM:0.18,wQ:0.26,wT:0.34,wC:0.22};
  const wG={wM:0.16,wQ:0.22,wT:0.28,wC:0.34};

  const rN = armed ? zoneRisk(wN,mG,qG,tG,compIdx) : 0;
  const rL = armed ? zoneRisk(wL,mG,qG,tG,compIdx) : 0;
  const rI = armed ? zoneRisk(wI,mG,qG,tG,compIdx) : 0;
  const rJ = armed ? zoneRisk(wJ,mG,qG,tG,compIdx) : 0;
  const rG = armed ? zoneRisk(wG,mG,qG,tG,compIdx) : 0;

  riskNose.textContent=pctTxt(rN);
  riskLE.textContent=pctTxt(rL);
  riskInlet.textContent=pctTxt(rI);
  riskJunc.textContent=pctTxt(rJ);
  riskGaps.textContent=pctTxt(rG);

  const aOn = !!assistOn.checked;
  let active=0, engaged=0;

  function applyZone(elm, risk){
    const isHot = risk>=HOT_ON;
    const isEng = aOn && risk>=HOT_ENGAGE;
    if(isHot) active++;
    if(isEng) engaged++;
    if(!armed || (!isHot && !isEng)) setHS(elm,"OFF");
    else if(isEng) setHS(elm,"ASSIST");
    else setHS(elm,"HOT");
  }
  applyZone(hsNose,rN);
  applyZone(hsLE,rL);
  applyZone(hsInlet,rI);
  applyZone(hsJunction,rJ);
  applyZone(hsGaps,rG);

  const modeTxt = !armed ? "IDLE" : (active===0 ? "ARMED" : "ACTIVE");
  hotSummary.innerHTML = "Hotspot system is <b>"+modeTxt+"</b>. Arms near <b>Mach "+HOT_ARM_MACH.toFixed(1)+"</b>. Active zones: <b>"+active+"</b> • Engaged zones: <b>"+engaged+"</b> • Assist: <b>"+(aOn?"ON":"OFF")+"</b>";
  assistApplied.textContent = (aOn && engaged>0) ? ("Assist: "+engaged+" zone(s)") : "Assist: none";
  hotNote.textContent = !armed ? ("IDLE (Mach < "+HOT_ARM_MACH.toFixed(1)+")") : ("Red=hot; Blue=assist. Stronger after Mach ~"+HOT_STRONG_MACH.toFixed(1)+".");
}

/* ===================== SIM LOOP ===================== */
function loop(ts){
  if(!running) return;
  if(lastTs==null) lastTs=ts;

  const dtReal=(ts-lastTs)/1000.0;
  lastTs=ts;

  const eff=effectiveSpeedSimMinPerSec();
  const dtMin=eff*dtReal;
  tMin += dtMin;

  const P=plannedAt(tMin);
  const s=P.s;
  const dtSimSec = dtMin*60.0;

  const aMach = 1 - Math.exp(-dtSimSec/Math.max(0.5,tauMachSec()));
  const aAlt  = 1 - Math.exp(-dtSimSec/Math.max(0.5,tauAltSec()));
  MachAct += (P.MachPlan - MachAct)*aMach;
  AltAct  += (P.AltPlan  - AltAct )*aAlt;

  const A=atmAt(AltAct);
  const V=MachAct*A.a;
  const q_kPa=0.5*A.rho*V*V/1000.0;
  const H=q_kPa/q_ref_kPa;
  const Cold=coldIndex(A.T);

  const C=1 + (q_kPa/q_comp_kPa) + 0.12*MachAct;
  const compIdx=clamp((C-1)/(C_bad-1),0,1);

  /* Determine engaged zones for assist physics */
  let engagedZones=0;
  const armed = (MachAct>=HOT_ARM_MACH);
  if(armed && assistOn.checked){
    const mG=machGate(MachAct), qG=qGate(q_kPa), tG=dTGate(Tskin,A.T);
    const weights=[ {wM:0.18,wQ:0.34,wT:0.34,wC:0.14},{wM:0.20,wQ:0.30,wT:0.35,wC:0.15},{wM:0.24,wQ:0.30,wT:0.26,wC:0.20},{wM:0.18,wQ:0.26,wT:0.34,wC:0.22},{wM:0.16,wQ:0.22,wT:0.28,wC:0.34} ];
    for(const w of weights){
      if(zoneRisk(w,mG,qG,tG,compIdx) >= HOT_ENGAGE) engagedZones++;
    }
  }

  /* Coolant */
  let mDotCmd=coolantCommand(H,Cold,MachAct);
  if(engagedZones>0){
    const bump=clamp(engagedZones*ASSIST_FLOW_BUMP_PER_ZONE,0,ASSIST_MAX_FLOW_BUMP);
    mDotCmd=clamp(mDotCmd*(1+bump),m_min,m_max);
  }
  let mDot=mDotCmd;
  if(coolantRemain<=0) mDot=0;
  else{
    const maxPossible=coolantRemain/Math.max(1e-9,dtSimSec);
    mDot=Math.min(mDotCmd,maxPossible);
  }
  lastCoolFlow=mDot;
  coolantRemain=Math.max(0, coolantRemain - mDot*dtSimSec);

  /* Thermal ODE with bounded assist relief */
  const coolFrac = (m_max>m_min) ? clamp((mDot-m_min)/(m_max-m_min),0,1) : 0;
  const kCoolEff = k_cool*(1 + 1.6*coolFrac);
  const relief = (engagedZones>0) ? clamp(engagedZones*ASSIST_DELTAHOT_RELIEF_PER_ZONE,0,ASSIST_MAX_DELTAHOT_RELIEF) : 0;
  const target = A.T + (deltaHot - relief);

  const dT = (k_heat*H*(target - Tskin)) - (kCoolEff*(Tskin - A.T));
  Tskin += dT*(dtSimSec/60.0);

  /* Fuel burn */
  const burns=burnRatesForStep(s);
  jetFuelRemain=Math.max(0, jetFuelRemain - burns.jet*dtMin);
  scramFuelRemain=Math.max(0, scramFuelRemain - burns.scram*dtMin);

  if(unstableHoldSec>0) unstableHoldSec=Math.max(0, unstableHoldSec-dtReal);

  if(tMin>=TRIP_LEN_MIN){
    tMin=TRIP_LEN_MIN;
    running=false;
    setStatus("Ended");
    setButtons();
  }

  render();
  if(running) requestAnimationFrame(loop);
}

/* ===================== INIT / EVENTS ===================== */
function resetAll(){
  running=false; lastTs=null; tMin=0;
  MachAct=0; AltAct=0; Tskin=atmAt(0).T; lastCoolFlow=0;
  unstableHoldSec=0;

  syncCapsFromSliders();
  jetFuelRemain=jetCap;
  scramFuelRemain=scramCap;
  coolantRemain=coolCap;

  setStatus("Stopped");
  setButtons();
  updateMassLabels();
  setTankBars();
  highlightStep(null);
  drawMap(0,0);
  render();
}

btnStart.addEventListener("click", ()=>{
  if(tMin>=TRIP_LEN_MIN) tMin=0;
  running=true; lastTs=null;
  setStatus("Running");
  setButtons();
  requestAnimationFrame(loop);
});
btnStop.addEventListener("click", ()=>{
  running=false; lastTs=null;
  setStatus("Stopped");
  setButtons();
  render();
});
btnReset.addEventListener("click", resetAll);

spd.addEventListener("input", ()=>{
  spdLbl.textContent = spd.value + "×";
  effSpeedLbl.textContent = fmt(effectiveSpeedSimMinPerSec(),1);
});

[mAir,mScramSys,mJetFuel,mScramFuel,mCoolant,unmanned].forEach(inp=>{
  inp.addEventListener("input", ()=>{
    updateMassLabels();
    syncCapsFromSliders();
    if(!running){
      jetFuelRemain=jetCap;
      scramFuelRemain=scramCap;
      coolantRemain=coolCap;
      setTankBars();
    }
    render();
  });
});

assistOn.addEventListener("change", render);

/* boot */
buildTable();
tripLen.textContent = String(TRIP_LEN_MIN.toFixed(0)) + " min";
spdLbl.textContent = spd.value + "×";
syncCapsFromSliders();
resetAll();
</script>
</body>
</html>
