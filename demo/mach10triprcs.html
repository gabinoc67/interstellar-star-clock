<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan → Paris Trip Simulator (Live Readout) — Time Zones + Mass/Fuel + Compression + Stability Lights</title>
<style>
  :root {
    color-scheme: dark;
    --bg:#070b14;
    --panel:#0f172a;
    --panel2:#0b1222;
    --ink:#e5e7eb;
    --muted:#9aa4c7;
    --accent:#60a5fa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --line:rgba(148,163,184,.22);
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1100px 700px at 25% -10%, rgba(96,165,250,.20), transparent 50%),
                radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.14), transparent 55%),
                linear-gradient(180deg, #050814 0%, #03050c 100%);
    color:var(--ink);
  }
  .wrap{max-width:1500px;margin:0 auto;padding:18px 14px 42px}
  header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px;line-height:1.25}

  .row{display:grid;grid-template-columns: 480px 1fr;gap:14px;margin-top:14px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,34,.92));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
  .card .hd .t{font-weight:800}
  .card .bd{padding:14px}

  .controls{display:grid;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  button{
    appearance:none;border:1px solid rgba(148,163,184,.28);
    background:rgba(2,6,23,.55); color:var(--ink);
    padding:10px 12px;border-radius:12px;font-weight:700;
    cursor:pointer;
  }
  button:hover{border-color:rgba(96,165,250,.55)}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.45;cursor:not-allowed}

  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.24);font-size:.85rem;color:var(--muted);background:rgba(2,6,23,.35)}
  .legend{display:flex;gap:8px;flex-wrap:wrap}

  .stat{background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .k{color:var(--muted);font-size:.82rem}
  .v{font-family:var(--mono);font-size:1.05rem;margin-top:4px}
  .mono{font-family:var(--mono)}
  .small{font-size:.92rem;color:var(--muted);line-height:1.25}
  .eq{font-family:var(--mono);font-size:.92rem;background:rgba(2,6,23,.35);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px;white-space:pre-wrap}

  .bar{height:10px;border-radius:999px;background:rgba(148,163,184,.12);overflow:hidden;border:1px solid rgba(148,163,184,.16)}
  .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85))}

  .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}

  input[type="range"]{width:100%}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .bad{color:var(--bad)}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);color:var(--muted);font-size:.86rem
  }
  .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.5)}

  .extrasGrid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:12px}
  @media (max-width:1100px){.extrasGrid{grid-template-columns:1fr}}
  .extrasStack{display:grid;gap:10px}

  /* Time panel */
  .timeGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  @media (max-width:520px){.timeGrid{grid-template-columns:1fr}}
  .timeBox{background:rgba(2,6,23,.30);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:10px}
  .timeLbl{color:var(--muted);font-size:.82rem}
  .timeVal{font-family:var(--mono);font-size:1.0rem;margin-top:6px;line-height:1.12;white-space:pre-line}
  .timeSub{color:var(--muted);font-size:.82rem;margin-top:6px}

  /* Mass/Fuel meters */
  .meter{display:grid;gap:8px}
  .meterline{display:flex;justify-content:space-between;gap:10px;font-family:var(--mono);font-size:.92rem}
  .meterbar{height:10px;border-radius:999px;background:rgba(148,163,184,.10);border:1px solid rgba(148,163,184,.16);overflow:hidden}
  .meterbar > b{display:block;height:100%;width:0%}
  .bFuel{background:linear-gradient(90deg, rgba(96,165,250,.95), rgba(96,165,250,.45))}
  .bScram{background:linear-gradient(90deg, rgba(251,191,36,.95), rgba(251,191,36,.45))}
  .bCool{background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(52,211,153,.45))}

  /* Map */
  .mapWrap{
    background: radial-gradient(900px 420px at 30% 0%, rgba(96,165,250,.18), transparent 55%),
                radial-gradient(700px 380px at 90% 25%, rgba(52,211,153,.12), transparent 60%),
                rgba(2,6,23,.25);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  canvas{display:block;width:100%;height:260px;border-radius:12px}
  .mapLegend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .miniPill{padding:5px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.35);color:var(--muted);font-size:.82rem}

  /* Timeline table */
  .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
  table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(2,6,23,.25)}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
  th{text-align:left;color:var(--muted);font-size:.85rem;position:sticky;top:0;background:rgba(7,10,20,.85);backdrop-filter: blur(6px)}
  tr.active{outline:2px solid rgba(96,165,250,.55);background:rgba(96,165,250,.08)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.18);font-size:.78rem;color:var(--muted)}

  /* Stability lights */
  .lights{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .light{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    min-width:160px;
  }
  .bulb{
    width:14px;height:14px;border-radius:999px;
    background:rgba(148,163,184,.25);
    box-shadow:0 0 0 rgba(0,0,0,0);
  }
  .light .lbl{font-weight:800}
  .light .sub{font-size:.82rem;color:var(--muted);margin:0}
  .on-good .bulb{background:rgba(52,211,153,.95);box-shadow:0 0 18px rgba(52,211,153,.55)}
  .on-warn .bulb{background:rgba(251,191,36,.95);box-shadow:0 0 18px rgba(251,191,36,.55)}
  .on-bad  .bulb{background:rgba(251,113,133,.95);box-shadow:0 0 18px rgba(251,113,133,.55)}
  @keyframes blink { 0%, 49% {opacity:1} 50%, 100% {opacity:.25} }
  .blink{animation:blink .7s infinite}

  /* Compression panel */
  .compGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.compGrid{grid-template-columns:1fr}}

  /* ===================== NEW: Hotspot Map Panel (SVG) ===================== */
  .hotWrap{
    background: radial-gradient(700px 320px at 25% 0%, rgba(251,191,36,.12), transparent 55%),
                radial-gradient(700px 320px at 85% 30%, rgba(96,165,250,.12), transparent 60%),
                rgba(2,6,23,.25);
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    padding:10px;
  }
  .hotHdr{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .hotHdr .miniPill{user-select:none}
  .hotNote{margin-top:8px}
  .hotGrid{display:grid;grid-template-columns: 1fr; gap:10px; margin-top:10px}
  .hotLegend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}

  svg{width:100%;height:260px;display:block;border-radius:12px}
  .airOutline{fill:rgba(148,163,184,.10);stroke:rgba(148,163,184,.35);stroke-width:2}
  .zone{
    fill:rgba(148,163,184,.18);
    stroke:rgba(148,163,184,.25);
    stroke-width:1;
    transition: fill .18s ease, stroke .18s ease, filter .18s ease;
  }
  .zoneLabel{
    font: 12px var(--mono);
    fill: rgba(229,231,235,.85);
    opacity:.85;
    pointer-events:none;
  }
  .zoneOff{fill:rgba(148,163,184,.14);stroke:rgba(148,163,184,.20)}
  .zoneHot{
    fill:rgba(251,113,133,.78);
    stroke:rgba(251,113,133,.92);
    filter: drop-shadow(0 0 10px rgba(251,113,133,.45));
  }
  .zoneCool{
    fill:rgba(96,165,250,.78);
    stroke:rgba(96,165,250,.95);
    filter: drop-shadow(0 0 10px rgba(96,165,250,.45));
  }
  .zoneBlink{animation: blink .7s infinite;}
  .hotTable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:.85rem}
  .hotTable td{padding:6px 6px;border-bottom:1px solid rgba(148,163,184,.12)}
  .hotTable td:first-child{color:rgba(229,231,235,.86)}
  .hotTable td:last-child{text-align:right}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Japan → Paris Trip Simulator (Live Readout)</h1>
      <div class="sub">
        Live step playback with stable gauges. Fixes: <b>fuel burn meters now always decrease live</b>, adds <b>compression proxy</b>,
        adds <b>blinking stability lights</b>, and adds a <b>zoned-skin hotspot map</b> (red = hotspot, blue = local assist engaged).
      </div>
    </div>
    <div class="legend">
      <span class="pill">Trip length: <b id="tripLen">146 min</b></span>
      <span class="pill">Playback: <b id="spdLbl">60×</b></span>
      <span class="pill">Mass factor: <b id="massFactorLbl">1.00×</b></span>
      <span class="pill">Status: <b id="statusLbl" class="warn">Stopped</b></span>
    </div>
  </header>

  <div class="row">
    <!-- LEFT: Controls + instruments -->
    <section class="card">
      <div class="hd">
        <div class="t">Controls • Instruments</div>
        <div class="pill mono">t = <span id="tNow">0.00</span> min</div>
      </div>
      <div class="bd">
        <div class="controls">
          <div class="btnrow">
            <button id="btnStart" type="button">Start</button>
            <button id="btnStop" type="button" disabled>Stop</button>
            <button id="btnReset" type="button">Reset</button>
          </div>

          <div class="stat">
            <div class="k">Playback speed (sim minutes per real second)</div>
            <input id="spd" type="range" min="1" max="240" value="60"/>
            <div class="small">
              Effective speed = slider × mass factor. <b>Mass also affects the vehicle response lag</b> (heavier craft accelerates/slows more sluggishly).
            </div>
            <div class="small mono" style="margin-top:6px">
              Effective: <span id="effSpeedLbl">60.0</span> sim-min/s • ETA (real): <span id="etaRealLbl">—</span>
            </div>
          </div>

          <div class="stat">
            <div class="k">Trip progress</div>
            <div class="bar"><i id="prog"></i></div>
            <div class="small mono"><span id="progPct">0</span>% • step <span id="stepNow">—</span> • <span id="phaseNow">—</span></div>
          </div>

          <div class="split">
            <div class="stat">
              <div class="k">Mach (actual)</div>
              <div class="v"><span id="mach">0.00</span></div>
              <div class="small">Tracks the plan with a mass-dependent response lag.</div>
            </div>
            <div class="stat">
              <div class="k">Altitude (actual)</div>
              <div class="v"><span id="alt">0.0</span> km</div>
              <div class="small">Tracks the plan with a mass-dependent response lag.</div>
            </div>

            <div class="stat">
              <div class="k">Medium type</div>
              <div class="v"><span id="medium">Troposphere</span></div>
              <div class="small">Altitude-banded.</div>
            </div>
            <div class="stat">
              <div class="k">Cold index</div>
              <div class="v"><span id="cold">0.00</span></div>
              <div class="small">From ambient temperature (0..1).</div>
            </div>

            <div class="stat">
              <div class="k">Ambient temp</div>
              <div class="v"><span id="Tamb">288.15</span> K</div>
              <div class="small">Interpolated by altitude.</div>
            </div>
            <div class="stat">
              <div class="k">Density</div>
              <div class="v"><span id="rho">1.2250</span> kg/m³</div>
              <div class="small">Interpolated by altitude.</div>
            </div>

            <div class="stat">
              <div class="k">Speed</div>
              <div class="v"><span id="V">0</span> m/s</div>
              <div class="small">V = Mach · a(alt).</div>
            </div>
            <div class="stat">
              <div class="k">Dynamic pressure</div>
              <div class="v"><span id="q">0.0</span> kPa</div>
              <div class="small">q = ½ρV².</div>
            </div>

            <div class="stat">
              <div class="k">Heating proxy</div>
              <div class="v"><span id="H">0.00</span></div>
              <div class="small">H = q/q_ref.</div>
            </div>
            <div class="stat">
              <div class="k">Skin temperature</div>
              <div class="v"><span id="Tskin">288.15</span> K</div>
              <div class="small">Thermal ODE (heating vs cooling).</div>
            </div>

            <div class="stat">
              <div class="k">Coolant flow (actual)</div>
              <div class="v"><span id="cool">0.20</span> kg/s</div>
              <div class="small">Tank-limited; shows actual flow after cap.</div>
            </div>
            <div class="stat">
              <div class="k">Stability score</div>
              <div class="v"><span id="stab">1.00</span></div>
              <div class="small">Loads + heating + ramps + plasma/INS + mass.</div>
            </div>
          </div>

          <div class="stat">
            <div class="k">Compression around aircraft (proxy)</div>
            <div class="compGrid" style="margin-top:10px">
              <div class="stat">
                <div class="k">Compression factor C</div>
                <div class="v"><span id="compC">1.00</span></div>
                <div class="small mono">C = 1 + (q/q_comp) + 0.12·Mach</div>
              </div>
              <div class="stat">
                <div class="k">Compression index (0..1)</div>
                <div class="v"><span id="compIdx">0.00</span></div>
                <div class="small">Scaled from C to drive visual effects.</div>
              </div>
            </div>
            <div class="small" id="compNote" style="margin-top:8px">—</div>
          </div>

          <div class="stat">
            <div class="k">Stability annunciator (can flip during flight)</div>
            <div class="lights">
              <div class="light" id="lightStable">
                <div class="bulb"></div>
                <div>
                  <div class="lbl">STABLE</div>
                  <p class="sub">Stab ≥ 0.70</p>
                </div>
              </div>
              <div class="light" id="lightCaution">
                <div class="bulb"></div>
                <div>
                  <div class="lbl">CAUTION</div>
                  <p class="sub">0.45–0.70</p>
                </div>
              </div>
              <div class="light" id="lightUnstable">
                <div class="bulb"></div>
                <div>
                  <div class="lbl">UNSTABLE</div>
                  <p class="sub">Stab &lt; 0.45</p>
                </div>
              </div>
            </div>
            <div class="small" id="annNote" style="margin-top:8px">—</div>
          </div>

          <div class="stat">
            <div class="k">CST discipline (from row)</div>
            <div class="small" id="cstNote">—</div>
          </div>

          <div class="stat">
            <div class="k">Quick status</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
              <span class="chip"><span class="dot" id="dotTherm"></span>Thermal</span>
              <span class="chip"><span class="dot" id="dotLoad"></span>Loads</span>
              <span class="chip"><span class="dot" id="dotNav"></span>Nav/INS</span>
              <span class="chip"><span class="dot" id="dotComm"></span>Comm/Plasma</span>
            </div>
            <div class="small" id="riskTxt" style="margin-top:8px">—</div>
          </div>

        </div>
      </div>
    </section>

    <!-- RIGHT: Explanation + extra panels -->
    <section class="card">
      <div class="hd">
        <div class="t">Explanation • Equations • Tunables • Extra Panels</div>
        <div class="tag">Verified: Start/Stop/Reset • Live burn • Lights • Hotspot Map</div>
      </div>
      <div class="bd">
        <div class="small">
          The simulator advances simulation time <span class="mono">t</span>, selects the active step, and computes the <b>planned</b> Mach/altitude.
          Then it applies a <b>mass-dependent response lag</b> so heavy vehicles accelerate/decelerate more slowly, which can change stability temporarily.
          Fuel/coolant are burned from tanks every frame, and the remaining meters always update live.
        </div>

        <div style="height:10px"></div>

        <div class="eq"><b>Equations used</b>
1) Step plan (linear interpolation):
   s = clamp((t - t0)/(t1 - t0), 0..1)
   Mach_plan(t) = Mach0 + s·(Mach1 - Mach0)
   Alt_plan(t)  = Alt0  + s·(Alt1  - Alt0)

2) Mass-dependent response lag (first-order tracking):
   Mach_actual += (Mach_plan - Mach_actual) · (1 - exp(-dtSimSec/τMach))
   Alt_actual  += (Alt_plan  - Alt_actual ) · (1 - exp(-dtSimSec/τAlt))
   τMach, τAlt increase with totalMass/refMass.

3) Atmosphere (table interpolation):
   Tamb(Alt), rho(Alt), a(Alt)

4) Speed:
   V = Mach_actual · a(Alt_actual)

5) Dynamic pressure:
   q = ½ · rho · V²

6) Heating proxy:
   H = q_kPa / q_ref_kPa

7) Cold index:
   Cold = clamp((T_warm - Tamb)/(T_warm - T_cold), 0..1)

8) Coolant flow (kg/s), tank-limited (actual shown):
   mDot_cmd = clamp(m_min + gH·H + gCold·Cold + gMach·(Mach/10), m_min..m_max)
   mDot = min(mDot_cmd, coolantRemaining / dtSimSec)

9) Skin temperature ODE:
   Tskin' = k_heat·H·( (Tamb+Δhot) - Tskin )  -  k_cool_eff·(Tskin - Tamb)
   k_cool_eff increases with mDot.

10) Compression proxy:
   C = 1 + (q_kPa / q_comp_kPa) + 0.12·Mach_actual
   compIndex = clamp((C-1)/(C_bad-1), 0..1)

11) Stability (0..1):
   Uses q, H, ramp, plasma/INS band penalty + a mass/inertia penalty
   (plus a small extra penalty when tracking error is large).</div>

        <div class="small" style="margin-top:10px">
          Tunables are inside the script (q_ref, τ bases, weights, burn rates). This remains a stable demo: it’s a consistent instrument cluster + timing.
        </div>

        <div class="extrasGrid">
          <div class="extrasStack">
            <div class="stat">
              <div class="k">Departure & Arrival clocks (browser time)</div>
              <div class="timeGrid">
                <div class="timeBox">
                  <div class="timeLbl">Departure (locked when Start is pressed)</div>
                  <div class="timeVal" id="depTimes">—</div>
                  <div class="timeSub" id="depNote">Press Start to lock departure time.</div>
                </div>
                <div class="timeBox">
                  <div class="timeLbl">Arrival (ETA from effective speed)</div>
                  <div class="timeVal" id="arrTimes">—</div>
                  <div class="timeSub" id="arrNote">Updates live from current time + ETA.</div>
                </div>
              </div>
            </div>

            <div class="stat">
              <div class="k">Mass & Fuel (live burn always visible)</div>

              <div class="split" style="margin-top:10px">
                <div class="stat">
                  <div class="k">Airframe (dry) mass</div>
                  <input id="mAir" type="range" min="10000" max="120000" step="500" value="52000"/>
                  <div class="small mono"><span id="mAirLbl">52000</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Scramjet system mass</div>
                  <input id="mScramSys" type="range" min="500" max="20000" step="100" value="4500"/>
                  <div class="small mono"><span id="mScramSysLbl">4500</span> kg</div>
                </div>

                <div class="stat">
                  <div class="k">Jet fuel mass (capacity)</div>
                  <input id="mJetFuel" type="range" min="0" max="60000" step="250" value="18000"/>
                  <div class="small mono"><span id="mJetFuelLbl">18000</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Scram fuel mass (capacity)</div>
                  <input id="mScramFuel" type="range" min="0" max="40000" step="250" value="9000"/>
                  <div class="small mono"><span id="mScramFuelLbl">9000</span> kg</div>
                </div>

                <div class="stat">
                  <div class="k">Coolant mass (capacity)</div>
                  <input id="mCoolant" type="range" min="0" max="12000" step="50" value="2200"/>
                  <div class="small mono"><span id="mCoolantLbl">2200</span> kg</div>
                </div>
                <div class="stat">
                  <div class="k">Unmanned</div>
                  <div class="small">
                    <label style="display:flex;gap:10px;align-items:center">
                      <input id="unmanned" type="checkbox" checked />
                      Unmanned flight (slightly lower inertia penalty)
                    </label>
                  </div>
                  <div class="small mono" style="margin-top:6px">Total mass: <span id="mTotalLbl">—</span> kg</div>
                </div>
              </div>

              <div class="split" style="margin-top:10px">
                <div class="stat">
                  <div class="k">Remaining tanks (live burn)</div>
                  <div class="meter" style="margin-top:8px">
                    <div class="meterline"><span>Jet fuel</span><span><span id="jetRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bFuel" id="jetBar"></b></div>
                    <div class="small mono" style="margin-top:6px">Cap: <span id="jetCapLbl">—</span> kg</div>

                    <div style="height:6px"></div>

                    <div class="meterline"><span>Scram fuel</span><span><span id="scramRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bScram" id="scramBar"></b></div>
                    <div class="small mono" style="margin-top:6px">Cap: <span id="scramCapLbl">—</span> kg</div>

                    <div style="height:6px"></div>

                    <div class="meterline"><span>Coolant</span><span><span id="coolRemainLbl">—</span> kg</span></div>
                    <div class="meterbar"><b class="bCool" id="coolBar"></b></div>
                    <div class="small mono" style="margin-top:6px">Cap: <span id="coolCapLbl">—</span> kg</div>
                  </div>
                  <div class="small" style="margin-top:8px">
                    Coolant depletion caps flow (actual flow shown in the Coolant gauge).
                  </div>
                </div>

                <div class="stat">
                  <div class="k">Mass factor + response lag</div>
                  <div class="eq" style="margin-top:8px">
refMass = 75,000 kg
massFactor = clamp( sqrt(refMass / totalMass), 0.65 .. 1.10 )
effectiveSpeed = sliderSpeed × massFactor

Response lag:
τMach = τMach_base · (totalMass/refMass)^0.70
τAlt  = τAlt_base  · (totalMass/refMass)^0.70</div>
                </div>
              </div>
            </div>
          </div>

          <div class="extrasStack">

            <!-- ===================== NEW PANEL: Hotspot Compression + Cooling Map ===================== -->
            <div class="stat">
              <div class="hotHdr">
                <div class="k">Hotspot Compression + Cooling Map (generic outline)</div>
                <span class="miniPill">
                  <label style="display:flex;gap:10px;align-items:center">
                    <input id="zonedOn" type="checkbox" checked />
                    Zoned skin assist ON
                  </label>
                </span>
              </div>

              <div class="hotWrap" style="margin-top:8px">
                <svg viewBox="0 0 900 320" aria-label="Generic aircraft hotspot map">
                  <!-- simple generic hypersonic craft silhouette -->
                  <path class="airOutline"
                        d="M120,170
                           C170,150 220,140 280,135
                           C350,128 420,125 480,128
                           C560,132 640,145 720,168
                           C760,180 790,195 820,215
                           C780,220 730,225 660,228
                           C610,230 560,232 500,232
                           C420,232 345,225 280,214
                           C220,205 175,196 120,170 Z"/>
                  <!-- wing-ish/strake hint -->
                  <path class="airOutline"
                        d="M360,175 L520,175 L580,210 L430,210 Z"
                        style="fill:rgba(148,163,184,.07);stroke:rgba(148,163,184,.22)"/>

                  <!-- Zones (ids referenced in JS) -->
                  <circle id="z_nose" class="zone zoneOff" cx="135" cy="168" r="18"/>
                  <rect   id="z_le"   class="zone zoneOff" x="240" y="144" width="470" height="18" rx="9"/>
                  <ellipse id="z_inlet" class="zone zoneOff" cx="270" cy="198" rx="28" ry="18"/>
                  <ellipse id="z_junc"  class="zone zoneOff" cx="470" cy="192" rx="34" ry="22"/>
                  <ellipse id="z_hinge" class="zone zoneOff" cx="690" cy="205" rx="30" ry="18"/>

                  <!-- Labels -->
                  <text class="zoneLabel" x="105" y="138">Nose / stagnation</text>
                  <text class="zoneLabel" x="380" y="130">Leading edges</text>
                  <text class="zoneLabel" x="240" y="240">Inlet / forebody</text>
                  <text class="zoneLabel" x="430" y="250">Wing-body junction</text>
                  <text class="zoneLabel" x="640" y="250">Control-surface gaps</text>
                </svg>

                <div class="hotLegend">
                  <span class="miniPill">OFF = gray</span>
                  <span class="miniPill">HOT = red blink</span>
                  <span class="miniPill">ASSIST = blue blink</span>
                </div>
              </div>

              <div class="small hotNote" id="hotNote">—</div>

              <div class="stat" style="margin-top:10px">
                <div class="k">Per-zone status (risk %)</div>
                <table class="hotTable">
                  <tbody>
                    <tr><td>Nose</td><td id="p_nose">—</td></tr>
                    <tr><td>Leading edges</td><td id="p_le">—</td></tr>
                    <tr><td>Inlet / forebody</td><td id="p_inlet">—</td></tr>
                    <tr><td>Wing-body junction</td><td id="p_junc">—</td></tr>
                    <tr><td>Control gaps</td><td id="p_hinge">—</td></tr>
                  </tbody>
                </table>
                <div class="small" style="margin-top:8px" id="hotAssistLbl">—</div>
              </div>
            </div>
            <!-- ===================== END NEW PANEL ===================== -->

            <div class="stat">
              <div class="k">A → B Track (curved route) • moving aircraft icon • compression glow</div>
              <div class="mapWrap" style="margin-top:8px">
                <canvas id="map" width="900" height="320"></canvas>
                <div class="mapLegend">
                  <span class="miniPill">A: Tokyo area</span>
                  <span class="miniPill">B: Paris</span>
                  <span class="miniPill">Glow increases with compression proxy</span>
                </div>
              </div>
            </div>

            <div class="stat">
              <div class="k">Medium type (altitude bands)</div>
              <div class="eq" style="margin-top:8px">0–12 km: Troposphere
12–50 km: Stratosphere
50–85 km: Mesosphere
85+ km: Thermosphere</div>
            </div>

          </div>
        </div>

      </div>
    </section>
  </div>

  <div style="height:14px"></div>

  <section class="card">
    <div class="hd">
      <div class="t">Event Log • Row-by-row Timeline (from Excel)</div>
      <div class="pill mono">Active row highlights as the trip runs</div>
    </div>
    <div class="bd">
      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Step</th>
              <th>Phase</th>
              <th>Start–End (min)</th>
              <th>Speed plan</th>
              <th>Alt band (km)</th>
              <th>Distance (km)</th>
              <th>Fuel / Mode</th>
              <th>EM</th>
              <th>Plasma</th>
              <th>INS reliance</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

</div><!-- wrap -->
<script>
/* ===================== DATA (from your Excel) ===================== */
const TRIP_LEN_MIN = 146.0;

const STEPS = [
  {"step":1,"phase":"Takeoff + initial climb","t0":0.0,"t1":15.0,"mach0":0.0,"mach1":1.0,"alt0":0.0,"alt1":12.0,"speedPlan":"0 → ~Mach 1","avgSpeed":137.0,"distKm":123.0,"fuelMode":"Jet fuel","notes":"Runway to high climb","em":"LOW (surface)","plasma":"NONE","ins":"LOW","cst":"Initialize CST baseline; timestamp discipline begins at takeoff."},
  {"step":2,"phase":"Climb + accelerate to Mach 3 corridor","t0":15.0,"t1":40.0,"mach0":1.0,"mach1":3.0,"alt0":12.0,"alt1":30.0,"speedPlan":"Mach 1 → Mach 3","avgSpeed":617.0,"distKm":926.0,"fuelMode":"Jet fuel","notes":"Transition into thinner air; heating begins to rise.","em":"LOW→MOD (ionosphere begins)","plasma":"NONE→MAYBE (at top)","ins":"LOW→MOD","cst":"Monitor time drift; tighten sensor-fusion timing as heating increases."},
  {"step":3,"phase":"Ramp up (controlled)","t0":40.0,"t1":50.0,"mach0":3.0,"mach1":10.0,"alt0":30.0,"alt1":45.0,"speedPlan":"Mach 3 → Mach 10","avgSpeed":2230.0,"distKm":1338.0,"fuelMode":"Scramjet / mixed-mode","notes":"Peak heating window; plasma and comm risk increases.","em":"MOD→HIGH","plasma":"MAYBE→LIKELY","ins":"HIGH","cst":"Mode switch: predict blackout; increase INS weight; keep clock sync coherent."},
  {"step":4,"phase":"Mach-10 cruise window","t0":50.0,"t1":60.0,"mach0":10.0,"mach1":10.0,"alt0":45.0,"alt1":55.0,"speedPlan":"Mach 10 steady","avgSpeed":3430.0,"distKm":2058.0,"fuelMode":"Scramjet (steady)","notes":"Short Mach-10 window; most sensitive to thermal/structural margins.","em":"HIGH","plasma":"LIKELY","ins":"HIGH","cst":"Hold time coherence through sensor dropouts; deterministic logging."},
  {"step":5,"phase":"Ramp down (controlled)","t0":60.0,"t1":70.0,"mach0":10.0,"mach1":3.0,"alt0":55.0,"alt1":35.0,"speedPlan":"Mach 10 → Mach 3","avgSpeed":2230.0,"distKm":1338.0,"fuelMode":"Scramjet → turbine/ram","notes":"Recover comms; reduce heating; stabilize inlet margin.","em":"HIGH→MOD","plasma":"LIKELY→MAYBE","ins":"HIGH→MOD","cst":"Reacquire/re-sync clocks; smooth handoff back to comm-aided nav."},
  {"step":6,"phase":"Long midcourse at Mach 3","t0":70.0,"t1":126.0,"mach0":3.0,"mach1":3.0,"alt0":25.0,"alt1":30.0,"speedPlan":"Mach 3 steady","avgSpeed":1000.0,"distKm":4138.0,"fuelMode":"Ramjet / turbine","notes":"Main distance segment; lower heating than Mach-10; optimize range.","em":"MOD","plasma":"MAYBE (sporadic)","ins":"MOD","cst":"Maintain long-term timing stability; periodic sync checks."},
  {"step":7,"phase":"Descent + landing","t0":126.0,"t1":146.0,"mach0":3.0,"mach1":0.0,"alt0":30.0,"alt1":0.0,"speedPlan":"Mach 3 → 0","avgSpeed":450.0,"distKm":540.0,"fuelMode":"Turbine + landing","notes":"Thermal cooldown; return to dense air; control authority increases.","em":"MOD→LOW","plasma":"NONE","ins":"LOW","cst":"Finalize logs; compute drift summary; archive mission timeline."}
];

const ATM = [
  {"alt_km":0.0,"T":288.15,"P":101325.0,"rho":1.225000018124288,"a":340.293988026089},
  {"alt_km":5.0,"T":255.65,"P":54019.888188145786,"rho":0.736115547399152,"a":320.5293944425378},
  {"alt_km":10.0,"T":223.15,"P":26436.2425926916,"rho":0.41270613707277716,"a":299.46316487458036},
  {"alt_km":15.0,"T":216.65,"P":12044.552806598,"rho":0.1936734512461432,"a":295.0694935090715},
  {"alt_km":20.0,"T":216.65,"P":5474.9,"rho":0.088035,"a":295.1},
  {"alt_km":25.0,"T":221.65,"P":2511.0,"rho":0.039466,"a":298.5},
  {"alt_km":30.0,"T":226.65,"P":1171.9,"rho":0.018012,"a":301.8},
  {"alt_km":35.0,"T":237.05,"P":558.9,"rho":0.008214,"a":308.6},
  {"alt_km":40.0,"T":251.05,"P":277.5,"rho":0.003851,"a":317.6},
  {"alt_km":45.0,"T":265.05,"P":143.1,"rho":0.001881,"a":326.4},
  {"alt_km":50.0,"T":270.65,"P":75.9,"rho":0.000978,"a":329.8},
  {"alt_km":55.0,"T":259.45,"P":40.0,"rho":0.000537,"a":322.9},
  {"alt_km":60.0,"T":245.45,"P":20.3,"rho":0.000288,"a":314.1},
  {"alt_km":65.0,"T":231.45,"P":9.9,"rho":0.000149,"a":305.0}
];

/* ===================== HELPERS ===================== */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const el = (id)=>document.getElementById(id);
const lerp = (a,b,t)=>a + (b-a)*t;
function smoothstep(a,b,x){
  const t = clamp((x-a)/(b-a), 0, 1);
  return t*t*(3-2*t);
}

function fmt(x, d=2) { if (!isFinite(x)) return "—"; return Number(x).toFixed(d); }
function fmtInt(x) { if (!isFinite(x)) return "—"; return String(Math.round(x)); }
function interp1(x, x0, y0, x1, y1) { if (x1===x0) return y0; const s=(x-x0)/(x1-x0); return y0+s*(y1-y0); }

function atmAt(altKm) {
  const x = clamp(altKm, ATM[0].alt_km, ATM[ATM.length-1].alt_km);
  for (let i=0;i<ATM.length-1;i++){
    const a0=ATM[i], a1=ATM[i+1];
    if (x>=a0.alt_km && x<=a1.alt_km){
      return {
        T:   interp1(x,a0.alt_km,a0.T,  a1.alt_km,a1.T),
        P:   interp1(x,a0.alt_km,a0.P,  a1.alt_km,a1.P),
        rho: interp1(x,a0.alt_km,a0.rho,a1.alt_km,a1.rho),
        a:   interp1(x,a0.alt_km,a0.a,  a1.alt_km,a1.a),
      };
    }
  }
  return {T:ATM[0].T,P:ATM[0].P,rho:ATM[0].rho,a:ATM[0].a};
}

function stepAt(tMin){
  for (const s of STEPS){ if (tMin>=s.t0 && tMin<s.t1) return s; }
  return STEPS[STEPS.length-1];
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

function mediumType(altKm){
  if (altKm < 12) return "Troposphere";
  if (altKm < 50) return "Stratosphere";
  if (altKm < 85) return "Mesosphere";
  return "Thermosphere";
}

function coldIndex(TambK){
  const T_warm = 288.15;
  const T_cold = 216.65;
  return clamp((T_warm - TambK)/(T_warm - T_cold), 0, 1);
}

function fmtHMS(totalSeconds){
  if (!isFinite(totalSeconds) || totalSeconds < 0) return "—";
  const s = Math.max(0, Math.round(totalSeconds));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}

/* ===================== TABLE BUILD ===================== */
const tbody = el("tbody");
const rowEls = new Map();

function buildTable(){
  tbody.innerHTML = "";
  for (const s of STEPS){
    const tr = document.createElement("tr");
    tr.dataset.step = String(s.step);
    tr.innerHTML = `
      <td class="mono">${s.step}</td>
      <td>${escapeHtml(s.phase)}</td>
      <td class="mono">${fmt(s.t0,0)}–${fmt(s.t1,0)}</td>
      <td>${escapeHtml(s.speedPlan)}</td>
      <td class="mono">${fmt(s.alt0,0)}→${fmt(s.alt1,0)}</td>
      <td class="mono">${fmt(s.distKm,0)}</td>
      <td>${escapeHtml(s.fuelMode)}</td>
      <td>${escapeHtml(s.em)}</td>
      <td>${escapeHtml(s.plasma)}</td>
      <td>${escapeHtml(s.ins)}</td>
      <td>${escapeHtml(s.notes)}</td>
    `;
    tbody.appendChild(tr);
    rowEls.set(s.step, tr);
  }
}
function highlightStep(step){
  for (const [k,tr] of rowEls.entries()){
    tr.classList.toggle("active", step === k);
  }
}
</script>

<script>
/* ===================== UI REFS ===================== */
const btnStart = el("btnStart");
const btnStop  = el("btnStop");
const btnReset = el("btnReset");
const spd = el("spd");
const spdLbl = el("spdLbl");
const statusLbl = el("statusLbl");

const massFactorLbl = el("massFactorLbl");
const effSpeedLbl = el("effSpeedLbl");
const etaRealLbl = el("etaRealLbl");

const tNow = el("tNow");
const prog = el("prog");
const progPct = el("progPct");
const stepNow = el("stepNow");
const phaseNow = el("phaseNow");

const machEl = el("mach");
const altEl = el("alt");
const mediumEl = el("medium");
const coldEl = el("cold");

const TambEl = el("Tamb");
const rhoEl = el("rho");
const VEl = el("V");
const qEl = el("q");
const HEl = el("H");
const TskinEl = el("Tskin");

const coolEl = el("cool");
const stabEl = el("stab");
const cstNote = el("cstNote");

const compCEl = el("compC");
const compIdxEl = el("compIdx");
const compNote = el("compNote");

const lightStable = el("lightStable");
const lightCaution = el("lightCaution");
const lightUnstable = el("lightUnstable");
const annNote = el("annNote");

const dotTherm = el("dotTherm");
const dotLoad  = el("dotLoad");
const dotNav   = el("dotNav");
const dotComm  = el("dotComm");
const riskTxt  = el("riskTxt");

const depTimes = el("depTimes");
const arrTimes = el("arrTimes");
const depNote  = el("depNote");
const arrNote  = el("arrNote");

const mAir = el("mAir");
const mScramSys = el("mScramSys");
const mJetFuel = el("mJetFuel");
const mScramFuel = el("mScramFuel");
const mCoolant = el("mCoolant");
const unmanned = el("unmanned");

const mAirLbl = el("mAirLbl");
const mScramSysLbl = el("mScramSysLbl");
const mJetFuelLbl = el("mJetFuelLbl");
const mScramFuelLbl = el("mScramFuelLbl");
const mCoolantLbl = el("mCoolantLbl");
const mTotalLbl = el("mTotalLbl");

const jetRemainLbl = el("jetRemainLbl");
const scramRemainLbl = el("scramRemainLbl");
const coolRemainLbl = el("coolRemainLbl");
const jetBar = el("jetBar");
const scramBar = el("scramBar");
const coolBar = el("coolBar");
const jetCapLbl = el("jetCapLbl");
const scramCapLbl = el("scramCapLbl");
const coolCapLbl = el("coolCapLbl");

const mapCanvas = el("map");
const ctx = mapCanvas.getContext("2d");

/* ===================== NEW: HOTSPOT PANEL REFS ===================== */
const zonedOn = el("zonedOn");
const hotNote = el("hotNote");
const hotAssistLbl = el("hotAssistLbl");

const z_nose  = el("z_nose");
const z_le    = el("z_le");
const z_inlet = el("z_inlet");
const z_junc  = el("z_junc");
const z_hinge = el("z_hinge");

const p_nose  = el("p_nose");
const p_le    = el("p_le");
const p_inlet = el("p_inlet");
const p_junc  = el("p_junc");
const p_hinge = el("p_hinge");

/* ===================== TUNABLES (checked) ===================== */
const q_ref_kPa = 50.0;
const q_bad_kPa = 120.0;
const H_bad = 2.0;

const q_comp_kPa = 35.0;
const C_bad = 6.0;

const k_heat = 0.35;
const k_cool = 0.08;
const deltaHot = 50.0;

const m_min = 0.20;
const m_max = 1.20;
const gH = 0.55;
const gCold = 0.18;
const gMach = 0.15;

const wq = 0.33;
const wH = 0.33;
const wRamp = 0.18;
const wBand = 0.10;
const wTrack = 0.06;

const burnJet_takeoff = 55;
const burnJet_mid = 40;
const burnJet_land = 30;
const burnScram_ramp = 85;
const burnScram_cruise = 110;

const refMass = 75000;
const tauMach_base = 10.0;
const tauAlt_base  = 14.0;

/* ===================== NEW: Hotspot risk + assist tunables ===================== */
const HOT_ARM_MACH = 1.2;
const HOT_STRONG_MACH = 3.0;
const HOT_THRESH = 0.62;     // zone goes red
const ENGAGE_THRESH = 0.72;  // zone flips blue if zoned assist is ON
const HOT_MAX_TEMPDEV = 180; // K scaling for temp deviation risk

// How much “tiny assist” to apply (kept small so demo stays stable)
const ASSIST_FLOW_PER_ZONE = 0.05;   // kg/s added to coolant command per engaged zone (capped by tank)
const ASSIST_TEMP_RELIEF_PER_ZONE = 0.60; // K per sim minute relief per engaged zone (small)

/* Zone weights: which places heat faster in hypersonic */
const ZONES = [
  {key:"nose",  w:1.25, el:z_nose,  out:p_nose,  name:"Nose / stagnation"},
  {key:"le",    w:1.15, el:z_le,    out:p_le,    name:"Leading edges"},
  {key:"inlet", w:1.10, el:z_inlet, out:p_inlet, name:"Inlet / forebody"},
  {key:"junc",  w:1.00, el:z_junc,  out:p_junc,  name:"Wing-body junction"},
  {key:"hinge", w:0.95, el:z_hinge, out:p_hinge, name:"Control-surface gaps"},
];

/* ===================== STATE ===================== */
let running = false;
let tMin = 0.0;
let lastTs = null;
let Tskin = atmAt(0).T;

let depReal = null;

let jetFuelRemain = 0, scramFuelRemain = 0, coolantRemain = 0;
let jetCap = 0, scramCap = 0, coolCap = 0;

let MachAct = 0.0;
let AltAct  = 0.0;

let lastCoolFlow = 0.0;

let unstableHoldSec = 0.0;
let lastAnn = "STOP";

/* NEW: remember hotspot computations for loop/render consistency */
let lastHot = {
  armed:false,
  base:0,
  activeCount:0,
  engagedCount:0,
  assistFlow:0,
  assistReliefKperMin:0,
  zones: {} // key -> {risk, hot, engaged}
};

/* ===================== DERIVED / MODELS ===================== */
function setStatus(txt, cls){ statusLbl.textContent = txt; statusLbl.className = cls; }
function setButtons(){ btnStart.disabled = running; btnStop.disabled = !running; }
function dotColor(dotEl, level){
  const c = (level < 0.33) ? "rgba(52,211,153,.85)" : (level < 0.66) ? "rgba(251,191,36,.85)" : "rgba(251,113,133,.85)";
  dotEl.style.background = c;
}

function rampMetric(step){
  const dt = Math.max(1e-9, step.t1 - step.t0);
  const dMach = Math.abs(step.mach1 - step.mach0) / dt;
  const dAlt = Math.abs(step.alt1 - step.alt0) / dt;
  const rm = clamp(dMach/1.0, 0, 1);
  const ra = clamp(dAlt/2.0, 0, 1);
  return clamp(rm + 0.6*ra, 0, 1);
}
function bandPenalty(step){
  let p = 0;
  const plasma = String(step.plasma||"").toUpperCase();
  const ins = String(step.ins||"").toUpperCase();
  if (plasma.includes("LIKELY")) p += 0.6;
  else if (plasma.includes("MAYBE")) p += 0.3;
  if (ins.includes("HIGH")) p += 0.5;
  else if (ins.includes("MOD")) p += 0.25;
  return clamp(p/1.2, 0, 1);
}

function coolantCommand(H, Cold, Mach){
  const cmd = m_min + gH*H + gCold*Cold + gMach*(Mach/10);
  return clamp(cmd, m_min, m_max);
}

function stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen){
  const qn = clamp(q_kPa / q_bad_kPa, 0, 1);
  const Hn = clamp(H / H_bad, 0, 1);
  const score = 1 - (wq*qn + wH*Hn + wRamp*ramp + wBand*bandPen + wTrack*trackPen + inertiaPen);
  return clamp(score, 0, 1);
}

function burnRatesForStep(step){
  const st = step.step;
  if (st === 1 || st === 2) return {jet: burnJet_takeoff, scram: 0};
  if (st === 6) return {jet: burnJet_mid, scram: 0};
  if (st === 7) return {jet: burnJet_land, scram: 0};
  if (st === 3 || st === 5) return {jet: 0, scram: burnScram_ramp};
  if (st === 4) return {jet: 0, scram: burnScram_cruise};
  return {jet: 0, scram: 0};
}

/* Mass / time effect */
function totalMass(){
  return Number(mAir.value) + Number(mScramSys.value) + Number(mJetFuel.value) + Number(mScramFuel.value) + Number(mCoolant.value);
}
function massFactor(){
  const tm = Math.max(1, totalMass());
  return clamp(Math.sqrt(refMass / tm), 0.65, 1.10);
}
function effectiveSpeedSimMinPerSec(){
  return Number(spd.value) * massFactor();
}
function tauMachSec(){
  const tm = Math.max(1, totalMass());
  return tauMach_base * Math.pow(tm/refMass, 0.70);
}
function tauAltSec(){
  const tm = Math.max(1, totalMass());
  return tauAlt_base * Math.pow(tm/refMass, 0.70);
}

/* ===================== NEW: HOTSPOT MODEL ===================== */
function computeHotspots(Mach, q_kPa, H, TskinK, TambK, compIndex01, enabled){
  const armed = Mach >= HOT_ARM_MACH;
  const armGain = smoothstep(HOT_ARM_MACH, HOT_STRONG_MACH, Mach); // 0..1

  const qn = clamp(q_kPa / q_bad_kPa, 0, 1);
  const Hn = clamp(H / H_bad, 0, 1);

  const tempDev = Math.max(0, TskinK - (TambK + 10)); // deviation above ambient-ish
  const tn = clamp(tempDev / HOT_MAX_TEMPDEV, 0, 1);

  // Base risk: compression/heating + temp deviation, amplified by “arming”
  const base = armGain * (0.45*qn + 0.35*Hn + 0.20*tn);
  const compBoost = 0.15 * clamp(compIndex01, 0, 1); // small extra emphasis from compression proxy

  let activeCount = 0;
  let engagedCount = 0;

  const zones = {};
  for (const z of ZONES){
    const risk = clamp((base + compBoost) * z.w, 0, 1);
    const hot = armed && (risk >= HOT_THRESH);
    const engaged = hot && enabled && (risk >= ENGAGE_THRESH);

    zones[z.key] = {risk, hot, engaged};
    if (hot) activeCount++;
    if (engaged) engagedCount++;
  }

  // Tiny assist numbers (kept small)
  const assistFlow = enabled ? (engagedCount * ASSIST_FLOW_PER_ZONE) : 0; // kg/s added to command
  const assistReliefKperMin = enabled ? (engagedCount * ASSIST_TEMP_RELIEF_PER_ZONE) : 0; // K per sim minute

  return {armed, base, tempDev, activeCount, engagedCount, assistFlow, assistReliefKperMin, zones};
}

function setZoneClass(elm, hot, engaged){
  if (!elm) return;
  elm.classList.remove("zoneOff","zoneHot","zoneCool","zoneBlink");
  if (!hot){
    elm.classList.add("zoneOff");
  } else if (engaged){
    elm.classList.add("zoneCool","zoneBlink");
  } else {
    elm.classList.add("zoneHot","zoneBlink");
  }
}

function renderHotspots(){
  // classes + % labels
  for (const z of ZONES){
    const st = lastHot.zones[z.key] || {risk:0, hot:false, engaged:false};
    setZoneClass(z.el, st.hot, st.engaged);
    if (z.out) z.out.textContent = `${Math.round(100*st.risk)}%`;
  }

  const enabled = !!(zonedOn && zonedOn.checked);
  const armedTxt = lastHot.armed ? "ARMED" : "IDLE";
  const why =
    (!lastHot.armed)
      ? `Hotspot system is ${armedTxt}. It arms near Mach ${HOT_ARM_MACH.toFixed(1)} (compression starts to matter).`
      : `Hotspot system is ${armedTxt}. Risk rises fast after Mach ${HOT_STRONG_MACH.toFixed(1)} (shock/BL effects grow).`;

  const stateLine =
    `Active zones: ${lastHot.activeCount} • Engaged zones: ${lastHot.engagedCount} • Zoned assist: ${enabled ? "ON" : "OFF"}`;

  hotNote.textContent = `${why} ${stateLine}`;

  const af = lastHot.assistFlow;
  const tr = lastHot.assistReliefKperMin;
  hotAssistLbl.textContent =
    (enabled && lastHot.engagedCount>0)
      ? `Assist applied: +${af.toFixed(2)} kg/s coolant cmd (cap-limited) • ${tr.toFixed(2)} K/min small skin relief (per engaged zones).`
      : `Assist applied: none (either no engaged zones, or assist OFF).`;
}
</script>
<script>
/* ===================== Timezones ===================== */
const TZ_LOCAL = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
const TZ_CENTRAL = "America/Chicago";
const TZ_MOUNTAIN = "America/Denver";
const TZ_PARIS = "Europe/Paris";

function fmtInTZ(date, timeZone){
  try{
    const f = new Intl.DateTimeFormat(undefined, {
      timeZone,
      weekday:"short", year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });
    return f.format(date);
  }catch(e){
    return date.toISOString();
  }
}

function renderDepTimes(){
  if (!depReal){
    depTimes.textContent =
`Local (${TZ_LOCAL}): —
Central (${TZ_CENTRAL}): —
Mountain (${TZ_MOUNTAIN}): —
Paris (${TZ_PARIS}): —`;
    depNote.textContent = "Press Start to lock departure time.";
    return;
  }
  depTimes.textContent =
`Local (${TZ_LOCAL}): ${fmtInTZ(depReal, TZ_LOCAL)}
Central (${TZ_CENTRAL}): ${fmtInTZ(depReal, TZ_CENTRAL)}
Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(depReal, TZ_MOUNTAIN)}
Paris (${TZ_PARIS}): ${fmtInTZ(depReal, TZ_PARIS)}`;
  depNote.textContent = "Departure is locked (does not change).";
}

function renderArrivalETA(){
  const eff = effectiveSpeedSimMinPerSec();
  const remainingMin = Math.max(0, TRIP_LEN_MIN - tMin);
  const etaSec = (eff > 0) ? (remainingMin / eff) : Infinity;

  effSpeedLbl.textContent = fmt(eff, 1);
  etaRealLbl.textContent = isFinite(etaSec) ? `${fmtHMS(etaSec)} (hh:mm:ss)` : "—";

  const now = new Date();
  const arr = new Date(now.getTime() + (isFinite(etaSec) ? etaSec*1000 : 0));
  arrTimes.textContent =
`Local (${TZ_LOCAL}): ${fmtInTZ(arr, TZ_LOCAL)}
Central (${TZ_CENTRAL}): ${fmtInTZ(arr, TZ_CENTRAL)}
Mountain (${TZ_MOUNTAIN}): ${fmtInTZ(arr, TZ_MOUNTAIN)}
Paris (${TZ_PARIS}): ${fmtInTZ(arr, TZ_PARIS)}`;
  arrNote.textContent = "Computed from current time + ETA.";
}

/* ===================== Meters (always live) ===================== */
function updateMassLabels(){
  mAirLbl.textContent = String(Number(mAir.value));
  mScramSysLbl.textContent = String(Number(mScramSys.value));
  mJetFuelLbl.textContent = String(Number(mJetFuel.value));
  mScramFuelLbl.textContent = String(Number(mScramFuel.value));
  mCoolantLbl.textContent = String(Number(mCoolant.value));
  mTotalLbl.textContent = String(Math.round(totalMass()));
  massFactorLbl.textContent = fmt(massFactor(), 2) + "×";
}

function syncCapsFromSliders(){
  jetCap = Number(mJetFuel.value);
  scramCap = Number(mScramFuel.value);
  coolCap = Number(mCoolant.value);
  jetCapLbl.textContent = fmt(jetCap,0);
  scramCapLbl.textContent = fmt(scramCap,0);
  coolCapLbl.textContent = fmt(coolCap,0);
}

function setTankBars(){
  jetRemainLbl.textContent = fmt(jetFuelRemain, 0);
  scramRemainLbl.textContent = fmt(scramFuelRemain, 0);
  coolRemainLbl.textContent = fmt(coolantRemain, 0);

  const jetPct = jetCap>0 ? clamp(jetFuelRemain/jetCap,0,1) : 0;
  const scramPct = scramCap>0 ? clamp(scramFuelRemain/scramCap,0,1) : 0;
  const coolPct = coolCap>0 ? clamp(coolantRemain/coolCap,0,1) : 0;

  jetBar.style.width = (jetPct*100).toFixed(1)+"%";
  scramBar.style.width = (scramPct*100).toFixed(1)+"%";
  coolBar.style.width = (coolPct*100).toFixed(1)+"%";
}

/* ===================== Map drawing ===================== */
const Apos = {x:0.18, y:0.62};
const Bpos = {x:0.78, y:0.40};

function drawMap(progress01, compIndex01){
  const W = mapCanvas.width, H = mapCanvas.height;
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle = "rgba(2,6,23,0.20)";
  ctx.fillRect(0,0,W,H);

  ctx.lineWidth = 1;
  for (let i=0;i<=12;i++){
    const x = (i/12)*W;
    ctx.strokeStyle = "rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for (let j=0;j<=6;j++){
    const y = (j/6)*H;
    ctx.strokeStyle = "rgba(148,163,184,0.08)";
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  ctx.strokeStyle = "rgba(96,165,250,0.18)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const arcY = H*0.92;
  ctx.arc(W*0.5, arcY, W*0.62, Math.PI*1.05, Math.PI*1.95);
  ctx.stroke();

  const ax = Apos.x*W, ay = Apos.y*H;
  const bx = Bpos.x*W, by = Bpos.y*H;
  const cx1 = W*0.42, cy1 = H*0.10;
  const cx2 = W*0.58, cy2 = H*0.08;

  ctx.strokeStyle = "rgba(52,211,153,0.35)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(ax, ay);
  ctx.bezierCurveTo(cx1, cy1, cx2, cy2, bx, by);
  ctx.stroke();

  function dot(x,y, r, color){
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  dot(ax,ay,6,"rgba(96,165,250,0.95)");
  dot(bx,by,6,"rgba(251,191,36,0.95)");

  ctx.fillStyle = "rgba(229,231,235,0.90)";
  ctx.font = "14px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("A", ax+10, ay+5);
  ctx.fillText("B", bx+10, by+5);

  const t = clamp(progress01, 0, 1);
  function bezierPoint(t){
    const x =
      (1-t)**3 * ax +
      3*(1-t)**2*t * cx1 +
      3*(1-t)*t**2 * cx2 +
      t**3 * bx;
    const y =
      (1-t)**3 * ay +
      3*(1-t)**2*t * cy1 +
      3*(1-t)*t**2 * cy2 +
      t**3 * by;
    return {x,y};
  }
  const p = bezierPoint(t);
  const p2 = bezierPoint(clamp(t+0.01,0,1));
  const ang = Math.atan2(p2.y-p.y, p2.x-p.x);

  const glow = clamp(compIndex01||0, 0, 1);
  if (glow > 0.02){
    ctx.save();
    ctx.globalAlpha = 0.6*glow;
    ctx.strokeStyle = "rgba(96,165,250,1)";
    ctx.lineWidth = 8;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 18 + 22*glow, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  ctx.save();
  ctx.translate(p.x, p.y);
  ctx.rotate(ang);
  ctx.fillStyle = "rgba(251,113,133,0.92)";
  ctx.beginPath();
  ctx.moveTo(10,0);
  ctx.lineTo(-8,6);
  ctx.lineTo(-5,0);
  ctx.lineTo(-8,-6);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ===================== RENDER + LOOP ===================== */
function setTripLen(){
  const t = el("tripLen");
  if (t) t.textContent = `${TRIP_LEN_MIN.toFixed(0)} min`;
}

function applySliderCapsWhenStopped(){
  syncCapsFromSliders();
  if (!running){
    jetFuelRemain = jetCap;
    scramFuelRemain = scramCap;
    coolantRemain = coolCap;
    setTankBars();
  }
}

function resetAll(){
  running = false;
  lastTs = null;
  tMin = 0.0;

  MachAct = 0.0;
  AltAct  = 0.0;
  Tskin = atmAt(0).T;
  lastCoolFlow = 0.0;

  depReal = null;

  syncCapsFromSliders();
  jetFuelRemain = jetCap;
  scramFuelRemain = scramCap;
  coolantRemain = coolCap;

  unstableHoldSec = 0.0;
  lastAnn = "STOP";

  lastHot = {armed:false, base:0, activeCount:0, engagedCount:0, assistFlow:0, assistReliefKperMin:0, zones:{}};

  setStatus("Stopped", "warn");
  setButtons();
  updateMassLabels();
  setTankBars();
  renderDepTimes();
  renderArrivalETA();
  render();
  highlightStep(null);
  drawMap(0,0);
}

function setAnnunciator(stab, runningNow){
  const STABLE_T = 0.70;
  const UNSTABLE_T = 0.45;

  lightStable.className = "light";
  lightCaution.className = "light";
  lightUnstable.className = "light";

  if (!runningNow){
    annNote.textContent = "Stopped: lights idle (will update during flight).";
    return;
  }

  let state = "STABLE";
  if (stab < UNSTABLE_T) state = "UNSTABLE";
  else if (stab < STABLE_T) state = "CAUTION";

  if (state === "UNSTABLE") unstableHoldSec = 2.5;
  if (unstableHoldSec > 0 && state !== "UNSTABLE") state = "CAUTION";

  if (state === "STABLE"){
    lightStable.classList.add("on-good");
    annNote.textContent = "Stable: no blink. (If stability dips, lights will switch.)";
  } else if (state === "CAUTION"){
    lightCaution.classList.add("on-warn","blink");
    annNote.textContent = "Caution: blinking while stability is marginal / recovering.";
  } else {
    lightUnstable.classList.add("on-bad","blink");
    annNote.textContent = "Unstable: blinking. Autopilot would normally reduce aggressiveness.";
  }

  lastAnn = state;
}

function plannedAt(t){
  const s = stepAt(t);
  const span = Math.max(1e-9, (s.t1 - s.t0));
  const frac = clamp((t - s.t0)/span, 0, 1);
  const MachPlan = s.mach0 + frac*(s.mach1 - s.mach0);
  const AltPlan  = s.alt0  + frac*(s.alt1  - s.alt0);
  return {s, frac, MachPlan, AltPlan};
}

function render(){
  const {s, MachPlan, AltPlan} = plannedAt(tMin);

  const Aatm = atmAt(AltAct);
  const V = MachAct * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;

  const med = mediumType(AltAct);
  const Cold = coldIndex(Aatm.T);

  const ramp = rampMetric(s);
  const bandPen = bandPenalty(s);

  const eMach = Math.abs(MachPlan - MachAct);
  const eAlt  = Math.abs(AltPlan  - AltAct);
  const trackPen = clamp((eMach/2.5) + 0.35*(eAlt/12.0), 0, 1);

  const tm = totalMass();
  const massOver = clamp((tm/refMass) - 1.0, 0, 1.0);
  let inertiaPen = 0.09 * massOver;
  if (unmanned.checked) inertiaPen *= 0.75;

  const stab = stabilityScore(q_kPa, H, ramp, bandPen, inertiaPen, trackPen);

  const C = 1 + (q_kPa / q_comp_kPa) + 0.12*MachAct;
  const compIdx = clamp((C - 1) / (C_bad - 1), 0, 1);

  // Update hotspot state for render (if loop didn’t run recently)
  const enabled = !!(zonedOn && zonedOn.checked);
  lastHot = computeHotspots(MachAct, q_kPa, H, Tskin, Aatm.T, compIdx, enabled);

  tNow.textContent = fmt(tMin, 2);

  const pct = clamp((tMin/TRIP_LEN_MIN)*100, 0, 100);
  prog.style.width = pct.toFixed(1) + "%";
  progPct.textContent = pct.toFixed(0);

  stepNow.textContent = s.step;
  phaseNow.textContent = s.phase;

  machEl.textContent = fmt(MachAct, 2);
  altEl.textContent = fmt(AltAct, 1);

  mediumEl.textContent = med;
  coldEl.textContent = fmt(Cold, 2);

  TambEl.textContent = fmt(Aatm.T, 2);
  rhoEl.textContent = fmt(Aatm.rho, 4);
  VEl.textContent = fmtInt(V);
  qEl.textContent = fmt(q_kPa, 1);
  HEl.textContent = fmt(H, 2);
  TskinEl.textContent = fmt(Tskin, 2);

  coolEl.textContent = fmt(lastCoolFlow, 2);
  stabEl.textContent = fmt(stab, 2);

  compCEl.textContent = fmt(C, 2);
  compIdxEl.textContent = fmt(compIdx, 2);
  compNote.textContent =
    `q=${fmt(q_kPa,1)} kPa • Mach=${fmt(MachAct,2)} • C=${fmt(C,2)} • compIndex=${fmt(compIdx,2)} (higher = more compression/shock proxy).`;

  cstNote.textContent = s.cst || "—";

  const thermRisk = clamp((Tskin - Aatm.T)/120.0, 0, 1);
  const loadRisk  = clamp(q_kPa / q_bad_kPa, 0, 1);
  const navRisk   = bandPen;
  const commRisk  = clamp((String(s.plasma||"").toUpperCase().includes("LIKELY") ? 1 :
                           String(s.plasma||"").toUpperCase().includes("MAYBE") ? 0.5 : 0.1), 0, 1);

  dotColor(dotTherm, thermRisk);
  dotColor(dotLoad, loadRisk);
  dotColor(dotNav, navRisk);
  dotColor(dotComm, commRisk);

  riskTxt.innerHTML =
    `PlanMach=<span class="mono">${fmt(MachPlan,2)}</span> • ` +
    `LagMach=<span class="mono">${fmt(Math.abs(MachPlan-MachAct),2)}</span> • ` +
    `LagAlt=<span class="mono">${fmt(Math.abs(AltPlan-AltAct),1)}km</span> • ` +
    `BandPen=<span class="mono">${fmt(bandPen,2)}</span> • ` +
    `Mass=<span class="mono">${fmt(tm,0)}kg</span> • ` +
    `Stability=<span class="mono">${fmt(stab,2)}</span>`;

  highlightStep(s.step);
  drawMap(tMin / TRIP_LEN_MIN, compIdx);

  updateMassLabels();
  renderArrivalETA();
  setAnnunciator(stab, running);

  syncCapsFromSliders();
  setTankBars();

  // NEW: hotspot panel visual + table
  renderHotspots();
}

function loop(ts){
  if (!running) return;
  if (lastTs == null) lastTs = ts;

  const dtReal = (ts - lastTs) / 1000.0;
  lastTs = ts;

  const eff = effectiveSpeedSimMinPerSec();
  const dtMin = eff * dtReal;
  tMin += dtMin;

  const {s, MachPlan, AltPlan} = plannedAt(tMin);
  const dtSimSec = dtMin * 60.0;

  const aMach = 1 - Math.exp(-dtSimSec / Math.max(0.5, tauMachSec()));
  const aAlt  = 1 - Math.exp(-dtSimSec / Math.max(0.5, tauAltSec()));
  MachAct += (MachPlan - MachAct) * aMach;
  AltAct  += (AltPlan  - AltAct ) * aAlt;

  const Aatm = atmAt(AltAct);
  const V = MachAct * Aatm.a;
  const q_kPa = 0.5 * Aatm.rho * V * V / 1000.0;
  const H = q_kPa / q_ref_kPa;
  const Cold = coldIndex(Aatm.T);

  // compression index for hotspot model
  const C = 1 + (q_kPa / q_comp_kPa) + 0.12*MachAct;
  const compIdx = clamp((C - 1) / (C_bad - 1), 0, 1);

  // NEW: compute hotspot state (drives visuals + tiny assist)
  const enabled = !!(zonedOn && zonedOn.checked);
  lastHot = computeHotspots(MachAct, q_kPa, H, Tskin, Aatm.T, compIdx, enabled);

  // Coolant: base command + tiny hotspot assist (cap-limited by tank)
  let mDotCmd = coolantCommand(H, Cold, MachAct);
  if (lastHot.engagedCount > 0){
    mDotCmd = clamp(mDotCmd + lastHot.assistFlow, m_min, m_max);
  }

  let mDot = mDotCmd;
  if (coolantRemain <= 0){
    mDot = 0;
  } else {
    const maxPossible = coolantRemain / Math.max(1e-9, dtSimSec);
    mDot = Math.min(mDotCmd, maxPossible);
  }
  lastCoolFlow = mDot;
  coolantRemain = Math.max(0, coolantRemain - (mDot * dtSimSec));

  // Thermal update
  const coolFrac = (m_max > m_min) ? clamp((mDot - m_min)/(m_max - m_min), 0, 1) : 0;
  const coolBoost = 1 + 1.6*coolFrac;
  const kCoolEff = k_cool * coolBoost;

  const heatTarget = Aatm.T + deltaHot;
  const dT = (k_heat * H * (heatTarget - Tskin)) - (kCoolEff * (Tskin - Aatm.T));
  Tskin += dT * (dtSimSec/60.0);

  // NEW: tiny per-zone skin relief (only when engaged)
  if (lastHot.engagedCount > 0 && enabled){
    const reliefK = lastHot.assistReliefKperMin * dtMin; // K
    Tskin = Math.max(Aatm.T, Tskin - reliefK);
  }

  // Fuel burn (always active)
  const burns = burnRatesForStep(s);
  jetFuelRemain = Math.max(0, jetFuelRemain - burns.jet * dtMin);
  scramFuelRemain = Math.max(0, scramFuelRemain - burns.scram * dtMin);

  if (unstableHoldSec > 0) unstableHoldSec = Math.max(0, unstableHoldSec - dtReal);

  if (tMin >= TRIP_LEN_MIN){
    tMin = TRIP_LEN_MIN;
    running = false;
    setStatus("Ended", "warn");
    setButtons();
  }

  render();
  if (running) requestAnimationFrame(loop);
}

/* ===================== EVENTS ===================== */
btnStart.addEventListener("click", ()=>{
  if (tMin >= TRIP_LEN_MIN) tMin = 0;

  if (!depReal) depReal = new Date();
  renderDepTimes();

  syncCapsFromSliders();
  if (tMin === 0){
    MachAct = 0; AltAct = 0; Tskin = atmAt(0).T;
  }

  running = true;
  lastTs = null;
  setStatus("Running", "good");
  setButtons();
  requestAnimationFrame(loop);
});

btnStop.addEventListener("click", ()=>{
  running = false;
  lastTs = null;
  setStatus("Stopped", "warn");
  setButtons();
  render();
});

btnReset.addEventListener("click", resetAll);

spd.addEventListener("input", ()=>{
  spdLbl.textContent = spd.value + "×";
  renderArrivalETA();
});

// toggle update
if (zonedOn){
  zonedOn.addEventListener("input", ()=>{ render(); });
}

[mAir,mScramSys,mJetFuel,mScramFuel,mCoolant,unmanned].forEach(x=>{
  x.addEventListener("input", ()=>{
    updateMassLabels();
    renderArrivalETA();
    if (!running){
      applySliderCapsWhenStopped();
      render();
    } else {
      syncCapsFromSliders();
      render();
    }
  });
});

/* ===================== INIT ===================== */
buildTable();
setTripLen();
spdLbl.textContent = spd.value + "×";

setInterval(()=>{
  updateMassLabels();
  renderArrivalETA();
  if (!running) {
    if (!depReal) renderDepTimes();
    render();
  }
}, 1000);

resetAll();
</script>
</body>
</html>
