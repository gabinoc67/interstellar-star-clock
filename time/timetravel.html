<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CST Time-Machine Simulator — Rings • Photons • 4 Clocks</title>
<style>
  :root{
    --bg:#0b1020; --ink:#eaf0ff; --mut:#9fb0d0; --panel:#121936; --line:#223062;
    --beam-color:rgba(190,245,255,.9);          /* white-cyan = stable */
    --intensity:.25;                             /* 0..1 visual power */
    --vibe:1;                                    /* ring horizontal quiver */
    --bob-amp:10px;                              /* ring vertical bob amplitude */
    --bob-speed:3.6s;                            /* ring vertical bob speed */
    --particle-speed:6s;                         /* orbiters (lower = faster) */
    --photon-speed:3s;                           /* vertical photon streams */
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-weight:900;letter-spacing:.2px}
  .pill{display:inline-block;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;color:#bcd}
  .grid{display:grid;gap:14px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .label{font-size:12px;color:var(--mut)}
  .value{font-weight:800}
  .button{cursor:pointer;font-weight:900;border-radius:14px;border:1px solid var(--line);
          padding:10px 16px;background:#0f1841;color:var(--ink)}
  .button:active{transform:translateY(1px)}
  .button.small{padding:6px 10px;font-size:11px}
  .button.activeBtn{border-color:#8fb4ff;box-shadow:0 0 0 1px #8fb4ff}

  input[type="datetime-local"],
  select{
    width:100%;
    background:#0d1536;
    border:1px solid #243468;
    border-radius:8px;
    padding:6px 8px;
    color:#eaf0ff;
  }

  .clockbox{
    font-family:ui-monospace,Consolas,monospace;
    font-size:16px;
    background:#0d1536;
    border-radius:10px;
    padding:10px;
    border:1px solid #2a3a6e;
    text-align:center
  }
  .clock-title{font-size:12px;color:#9fb0d0;margin-bottom:4px}
  .ok{color:#7cff9e} .bad{color:#ff9090}
  .hidden{display:none !important}

  /* ------ Time-Machine Chamber ------ */
  .chamber{position:relative;overflow:hidden;min-height:380px;border-radius:18px;margin-top:12px}
  .beam{position:absolute;left:50%;top:6%;bottom:10%;transform:translateX(-50%);
    width:22%;background:radial-gradient(ellipse at center,var(--beam-color),transparent 70%);
    opacity:calc(.25 + .75*var(--intensity)); filter:blur(8px); transition:background .3s linear}
  /* Ring wrappers bob up/down; inner rings quiver horizontally */
  .ringWrap{position:absolute;left:50%;transform:translateX(-50%) translateY(0); animation: bob var(--bob-speed) ease-in-out infinite alternate}
  .ringWrap.top{top:8%}
  .ringWrap.bot{bottom:10%}
  @keyframes bob{
    from{ transform:translateX(-50%) translateY(calc(var(--bob-amp)*-1)); }
    to  { transform:translateX(-50%) translateY(var(--bob-amp)); }
  }
  .ring{width:80%;height:74px;border:2px solid #2aa8ff66;border-radius:999px;
        box-shadow:0 0 20px #6ff6ff33 inset,0 0 25px #2aa8ff55;
        transform:scaleX(calc(1 + .03*var(--vibe))); animation:vibe calc(.5s/var(--vibe)) linear infinite;position:relative}
  .ring::after{content:"";position:absolute;inset:0;border-radius:inherit;border:1px dashed #aef7ff7a;animation:dash 8s linear infinite}
  @keyframes dash{to{transform:rotate(360deg)}}
  @keyframes vibe{0%{transform:scaleX(1)}50%{transform:scaleX(1.04)}100%{transform:scaleX(1)}}

  /* Particles in elliptical orbits */
  .orbit{position:absolute;inset:0;pointer-events:none}
  .particle{position:absolute;top:50%;left:50%;width:6px;height:6px;border-radius:50%;
    background:#dfffff;box-shadow:0 0 8px #dfffff,0 0 14px #66e1ff}

  /* Vertical photon streams */
  .photons{position:absolute;left:50%;top:2%;bottom:12%;width:34%;transform:translateX(-50%);pointer-events:none}
  .photon{position:absolute;left:50%;width:3px;height:12px;background:#bfffff;box-shadow:0 0 8px #bfffff,0 0 16px #66e1ff;opacity:.85}
  .photon.up{animation:rise var(--photon-speed) linear infinite}
  .photon.down{animation:fall var(--photon-speed) linear infinite}
  @keyframes rise{from{transform:translate(-50%,100%)} to{transform:translate(-50%,-10%)}}
  @keyframes fall{from{transform:translate(-50%,-10%)} to{transform:translate(-50%,100%)}}

  .floor{position:absolute;left:5%;right:5%;bottom:8%;height:12%;background:linear-gradient(#16244f,#0b1020);border-top:1px solid #2aa8ff33}

  /* Equations block */
  .eq{font-size:14px;line-height:1.6}
  .eq code{background:#0d1536;border:1px solid #2a3a6e;border-radius:8px;padding:2px 6px}
  .bul{margin:6px 0 0 18px}
  .bul li{margin:4px 0}

  /* Reactor core visual (m_equiv bar) */
  .reactor{
    width:46px;
    height:96px;
    border-radius:12px;
    border:1px solid #2a3a6e;
    padding:4px;
    display:flex;
    flex-direction:column;
    justify-content:flex-end;
    background:#050815;
  }
  .reactor-core{
    width:100%;
    height:30%;
    border-radius:8px;
    background:linear-gradient(#8fb4ff,#35e6a2);
    box-shadow:0 0 12px #35e6a280;
    transition:height .25s ease-out;
  }

  .warnBox{
    font-size:12px;
    border-radius:10px;
    padding:6px 8px;
    border:1px solid #ffb3a6;
    background:rgba(120,25,0,0.35);
    color:#ffd5c7;
  }

  /* g_phiphi plot */
  #jrPlot{
    width:100%;
    height:120px;
    border-radius:10px;
    border:1px solid #243468;
    background:#050815;
  }
  .plot-label{
    font-size:11px;
    color:#9fb0d0;
    margin-top:4px;
  }

  /* Energy-condition table */
  .ectable{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
    margin-top:4px;
  }
  .ectable td{
    padding:2px 4px;
  }
  .ectable td:first-child{
    color:#9fb0d0;
  }
  .ectable td:last-child{
    text-align:right;
    font-family:ui-monospace,Consolas,monospace;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>CST Time-Machine Simulator</h1>
  <div class="pill">Two bobbing rings • Orbiting particles • Photon streams • 4 live clocks</div>

  <div class="grid grid-2" style="margin-top:12px">
    <!-- Controls -->
    <div class="card">
      <div class="row"><strong>Destination Control</strong></div>
      <div style="margin-top:8px">
        <label class="label">Destination (Local calendar)</label>
        <input id="destDT" type="datetime-local" />
      </div>
      <div class="row" style="margin-top:12px">
        <button class="button" id="travelBtn">Travel to Destination</button>
        <button class="button" id="resetBtn">Reset</button>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <span class="label">Advanced Physics Layer</span>
        <button class="button" id="advToggle">Advanced: OFF</button>
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end;align-items:flex-end">
        <div class="reactor">
          <div class="reactor-core" id="reactorCore"></div>
        </div>
      </div>
      <div class="label" style="text-align:right;margin-top:4px;font-size:11px">
        Time-Machine Field Core — <code>m_equiv = E_field / c²</code>
      </div>

      <div class="label" id="status" style="margin-top:8px">Status: <span class="ok">STABLE</span></div>

      <div class="clockbox" style="margin-top:8px">
        <div class="clock-title">Time-Machine Field Equation (normalized)</div>
        <div id="tmEqDisplay" style="font-size:13px;line-height:1.4">
          m_equiv ≈ 0.00<br>
          P_TM ≈ 0.00
        </div>
      </div>
    </div>

    <!-- Clocks -->
    <div class="card">
      <div class="grid grid-2">
        <div class="clockbox">
          <div class="clock-title">UTC Cosmic Clock</div>
          <div id="utcClock">—</div>
        </div>
        <div class="clockbox">
          <div class="clock-title">Current Local Time</div>
          <div id="localClock">—</div>
        </div>
        <div class="clockbox">
          <div class="clock-title">Destination Time</div>
          <div id="destClock">—</div>
        </div>
        <div class="clockbox">
          <div class="clock-title">Δt (Difference)</div>
          <div id="diffClock">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Physics Panel -->
  <div class="card hidden" id="advPanel" style="margin-top:12px">
    <div class="row">
      <strong>Advanced Physics Layer — SR • GR • Sidereal Drift</strong>
      <span class="label">These are comparison readouts: CST stays the narrative layer; physics adds the engineering layer.</span>
    </div>
    <div class="grid grid-3" style="margin-top:10px;gap:10px">
      <!-- SR (no slider, fixed example) -->
      <div>
        <div class="label">Special Relativity — Velocity Time Dilation</div>
        <div style="margin-top:4px">
          <span class="label">Example ship velocity (fraction of c)</span>
          <div class="row" style="margin-top:4px;justify-content:space-between">
            <span id="srVelVal" class="value">58.0% c</span>
            <span class="label">γ = <span id="srGamma">1.0000</span></span>
          </div>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">CST Δt (ideal)</div>
          <div id="srDt">—</div>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">Proper Δt′ (SR)</div>
          <div id="srDtPrime">—</div>
        </div>
      </div>

      <!-- GR -->
      <div>
        <div class="label">Gravitational Time Dilation — Deep Wells</div>
        <div style="margin-top:4px">
          <span class="label">Reference body</span>
          <select id="grBody">
            <option value="earth">Earth surface</option>
            <option value="leo">Low Earth orbit (400 km)</option>
            <option value="neutron">Toy neutron star</option>
          </select>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">GR factor √(1 − 2GM/rc²)</div>
          <div id="grFactor">—</div>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">CST Δt baseline</div>
          <div id="grDtBase">—</div>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">Δt′ near body (GR)</div>
          <div id="grDtPrime">—</div>
        </div>
      </div>

      <!-- Sidereal vs Solar -->
      <div>
        <div class="label">Sidereal vs Solar — Star Drift</div>
        <div class="clockbox" style="margin-top:4px">
          <div class="clock-title">Per-day drift (solar−sidereal)</div>
          <div id="sidDaily">—</div>
        </div>
        <div class="clockbox" style="margin-top:6px">
          <div class="clock-title">Accumulated drift over |Δt|</div>
          <div id="sidAccum">—</div>
        </div>
        <p class="label" style="margin-top:6px">
          As |Δt| grows, the sidereal star field slowly slips relative to the Sun-based CST clock, revealing the true galactic rhythm.
        </p>
      </div>
    </div>

    <!-- GR Jump-Rope geometry block driven by CST field -->
    <div class="label" style="margin-top:12px">
      General Relativity — Jump-Rope Loop Geometry (linked to CST field core m_equiv).
      The CTC condition uses the paper’s <code>g_φφ(r) = α(r)² r² − a(r)²</code>.
    </div>

    <div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap">
      <span class="label">Spacetime mode:</span>
      <select id="jrModeSelect">
        <option value="pure">Pure GR Jump-Rope (original)</option>
        <option value="torsion">CST-Warp / Einstein–Cartan (torsion aided)</option>
      </select>
      <button class="button small" id="jrWarnBtn">CTC Warning</button>
      <button class="button small" id="jrFixBtn">Mitigate / Recalculate</button>
    </div>
    <div id="jrWarningBox" class="warnBox hidden" style="margin-top:6px">
      <!-- Filled dynamically when you press “CTC Warning” or “Mitigate” -->
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:8px">
      <div class="clockbox">
        <div class="clock-title">Frame-dragging a₀ (effective)</div>
        <div id="jrA0">—</div>
      </div>
      <div class="clockbox">
        <div class="clock-title">Chronology horizon r_crit</div>
        <div id="jrRCrit">—</div>
      </div>
      <div class="clockbox">
        <div class="clock-title">CTC region</div>
        <div id="jrCTCRegion">—</div>
      </div>
      <div class="clockbox">
        <div class="clock-title">Exotic matter flag</div>
        <div id="jrExotic">—</div>
      </div>
    </div>

    <!-- Energy-condition meter + numeric table -->
    <div class="grid grid-2" style="margin-top:8px;gap:8px">
      <div class="clockbox">
        <div class="clock-title">Energy-condition meter (NEC/WEC)</div>
        <div id="jrECMeter">Idle (no loop)</div>
      </div>
      <div>
        <table class="ectable">
          <tbody id="jrECTableBody">
            <tr><td>min g<sub>φφ</sub></td><td>—</td></tr>
            <tr><td>r at min</td><td>—</td></tr>
            <tr><td>margin from 0</td><td>—</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- g_phiphi(r) plot -->
    <svg id="jrPlot"></svg>
    <div class="plot-label">
      Plot of g<sub>φφ</sub>(r) across the loop radius. Horizontal dashed line is g<sub>φφ</sub>=0.
      If the curve dips below, CTCs appear in that band and NEC/WEC are violated in this toy model.
      Switching to CST-Warp / Einstein–Cartan adds a torsion term that lifts the curve and can remove the CTC zone.
    </div>

    <!-- Temporal Stability & Worldline Lock -->
    <div class="label" style="margin-top:10px">
      Temporal Stability — Worldline Lock (Gloria Sánchez navigation). Less spatial drift ⇒ more stable time field.
    </div>
    <div class="grid grid-3" style="margin-top:6px;gap:8px">
      <div class="clockbox">
        <div class="clock-title">Normalized worldline drift</div>
        <div id="stabDrift">—</div>
      </div>
      <div class="clockbox">
        <div class="clock-title">Temporal stability index S</div>
        <div id="stabIndex">—</div>
      </div>
      <div class="clockbox">
        <div class="clock-title">Stability mode</div>
        <div id="stabMode">—</div>
      </div>
    </div>

    <p class="label" style="margin-top:4px">
      The stability panel treats the jump as a worldline maneuver: very small |Δt| corresponds to almost no drift along
      your cosmic path (Brownsville rides smoothly with Earth and the galaxy), so S ≈ 1. As |Δt| is pushed toward
      geologic or cosmological scales, the normalized drift rises and S falls toward warp-like motion, warning that even a
      “static” lat/long hides large spatial offsets in spacetime.
    </p>

    <p class="label" style="margin-top:4px">
      As the CST field core ramps (m_equiv, P_TM) during a jump, the effective frame-dragging <code>a₀</code> increases.
      When <code>g_φφ(r)</code> turns negative, a CTC region appears and the model signals that macroscopic exotic matter would be required
      (classical NEC/WEC violation). The Energy-condition meter quantifies how deep that violation is, and the Mitigate function + CST-Warp / Einstein–Cartan mode show how torsion and control logic can pull the geometry back out of the exotic-matter regime in this simplified model.
    </p>
  </div>

  <!-- Time-Machine Chamber -->
  <div class="card chamber">
    <div class="ringWrap top"><div class="ring"></div></div>
    <div class="ringWrap bot"><div class="ring"></div></div>
    <div class="beam" id="beam"></div>
    <div class="orbit" id="orbitLayer"></div>
    <div class="photons" id="photonsLayer"></div>
    <div class="floor"></div>
    <div class="label" style="text-align:center;margin-top:6px">
      White = stable equilibrium • Red = traveling • Rings bob faster in transit; particles & photons accelerate
    </div>
  </div>

  <!-- Explanation & Equations -->
  <div class="card" style="margin-top:12px">
    <div class="row"><strong>How This Time Machine Model Works — Clocks, Drive Equation & Equations</strong></div>
    <div class="eq">
      <p><b>Clocks used (always live):</b></p>
      <ul class="bul">
        <li><b>UTC Cosmic Clock</b> — Universal reference for synchronization.</li>
        <li><b>Current Local Clock</b> — Your device’s local time.</li>
        <li><b>Destination Clock</b> — Target local date/time you dial.</li>
        <li><b>Δt Clock</b> — Signed difference from <i>now → destination</i>, which smoothly goes to zero during travel.</li>
      </ul>

      <p style="margin-top:8px"><b>Equilibrium condition (visual demo):</b> The machine holds a stable field when thermal, rotation, and phase terms are small. During travel, energy rises and the beam glows red; upon arrival, it returns to white, indicating equilibrium.</p>

      <p><b>CST + rotation relations (illustrative):</b></p>
      <ul class="bul">
        <li><code>Δt = t_dest − t_now</code></li>
        <li><code>LOD(Δt) ≈ 24 h + (1.7 ms / 100 yr) × (Δt / yr)</code>  (tidal friction trend → future days slightly longer)</li>
        <li><code>rotFactor(Δt) = 24 h / LOD(Δt)</code></li>
        <li><code>ω_⊕(Δt) = 2π / (86400 s · rotFactor)</code></li>
      </ul>

      <p><b>Time-machine drive equation (normalized in the HUD):</b></p>
      <ul class="bul">
        <li>The field core stores energy <code>E_field</code> that behaves like an effective mass: <code>m_equiv = E_field / c²</code>.</li>
        <li>To sustain a time jump over an interval <code>τ_travel</code>, the drive power obeys
          <br><code>P_TM ≈ E_field / τ_travel = m_equiv c² / τ_travel</code>.</li>
        <li>In the simulator, the reactor bar and the numeric readout show <code>m_equiv</code> and <code>P_TM</code> in normalized units as the machine moves through time: larger jumps and faster convergence of Δt give bigger values.</li>
      </ul>

      <p><b>Mass–energy conversion note:</b> In a CST time-machine interpretation, the chamber’s glow stands in for field energy density. Einstein’s relation <code>E = m c²</code> can be read in reverse as <code>m = E / c²</code>, so any stored field energy behaves like an effective mass. In a real particle-based time machine, raising the field energy inside the chamber is equivalent to loading more “mass” into the core; here, that shows up as a taller reactor core bar and changing equation numbers while the jump is in progress.</p>

      <p><b>Time-machine power dimensional check:</b> The expression
        <br><code>P_TM ≈ E_field / τ_travel = m_equiv c² / τ_travel</code>
        has units of power <code>[M L² T⁻³]</code>, just like a conventional engine. The simulator stays qualitative, but it keeps the same structure: you watch how the effective mass <code>m_equiv</code> and drive power <code>P_TM</code> respond as Δt collapses.</p>

      <p><b>Cosmic motion notes:</b> For geologic-scale jumps, you must account for Earth’s rotation change (LOD) and long-term orbital/axial effects. In this demo, the rings’ bob and intensity encode that: larger |Δt| → faster bobbing and brighter beam. Historically, tidal friction slows Earth’s rotation; orbital period changes are smaller but can be modeled if desired.</p>

      <p><b>Temporal stability note:</b> Even if you are “static” at one lat/long, Earth is rotating, orbiting the Sun, and moving through the galaxy. The temporal stability index S tracks, in a simplified way, how much effective worldline drift you accumulate for the chosen |Δt|. Small |Δt| means your worldline is almost coincident with Brownsville’s natural cosmic path (S ≈ 1); enormous |Δt| implies large offsets in spacetime and S drops toward a warp-like, less stable regime.</p>

      <p><b>Interpretation:</b> If the destination is far, |Δt| is large → the simulator shows higher field activity (faster bob, photons, particles). When you press <b>Travel</b>, Δt converges toward zero, the beam transitions red→white, and the rings/particles return to stable rates, indicating synchronized arrival. The field equation readout gives a live numeric view of how a CST time-machine drive would ramp its effective mass and power during that jump.</p>

      <p class="label" style="margin-top:6px">
        When <b>Advanced Physics</b> is ON, the CST ring stays your ideal time layer; the SR/GR & sidereal panels show how a relativistic engineer would compare that ideal against real spacetime slippage.
        The Jump-Rope block adds a finite rotating-loop GR toy model whose CTC region is driven by the same CST field core. The Energy-condition meter and table quantify how close you are to NEC/WEC violation,
        and the Mitigate function + CST-Warp / Einstein–Cartan mode show how torsion and control logic can pull the geometry back out of the exotic-matter regime in this simplified model. The temporal stability
        panel encodes the Gloria Sánchez idea: the less spatial drift you allow while sliding through CST time, the more stable and Einstein-legal the time field remains.
      </p>
    </div>
  </div>
</div>
<script>
(function(){
  const utcClock = document.getElementById('utcClock');
  const localClock = document.getElementById('localClock');
  const destClock = document.getElementById('destClock');
  const diffClock = document.getElementById('diffClock');
  const destDT = document.getElementById('destDT');
  const travelBtn = document.getElementById('travelBtn');
  const resetBtn = document.getElementById('resetBtn');
  const status = document.getElementById('status');
  const orbitLayer = document.getElementById('orbitLayer');
  const photonsLayer = document.getElementById('photonsLayer');

  const advToggle = document.getElementById('advToggle');
  const advPanel = document.getElementById('advPanel');

  const srVelVal = document.getElementById('srVelVal');
  const srGamma = document.getElementById('srGamma');
  const srDt = document.getElementById('srDt');
  const srDtPrime = document.getElementById('srDtPrime');

  const grBody = document.getElementById('grBody');
  const grFactor = document.getElementById('grFactor');
  const grDtBase = document.getElementById('grDtBase');
  const grDtPrime = document.getElementById('grDtPrime');

  const sidDaily = document.getElementById('sidDaily');
  const sidAccum = document.getElementById('sidAccum');

  const reactorCore = document.getElementById('reactorCore');
  const tmEqDisplay = document.getElementById('tmEqDisplay');

  // Jump-Rope GR outputs
  const jrA0 = document.getElementById('jrA0');
  const jrRCrit = document.getElementById('jrRCrit');
  const jrCTCRegion = document.getElementById('jrCTCRegion');
  const jrExotic = document.getElementById('jrExotic');
  const jrWarnBtn = document.getElementById('jrWarnBtn');
  const jrFixBtn = document.getElementById('jrFixBtn');
  const jrWarningBox = document.getElementById('jrWarningBox');
  const jrModeSelect = document.getElementById('jrModeSelect');
  const jrPlot = document.getElementById('jrPlot');
  const jrECMeter = document.getElementById('jrECMeter');
  const jrECTableBody = document.getElementById('jrECTableBody');

  // Temporal stability elements
  const stabDrift = document.getElementById('stabDrift');
  const stabIndex = document.getElementById('stabIndex');
  const stabMode = document.getElementById('stabMode');

  let destination = null;
  let traveling = false;
  let travelStart = 0;
  let travelDuration = 8000;
  const baseTravelDuration = 8000;
  let initialDiff = 0;
  let lastDiffMs = 0;
  let advancedOn = false;
  let lastMNorm = 0;
  let jrMode = 'pure';

  const G = 6.674e-11;
  const C = 299792458;
  const bodies = {
    earth:{ M:5.972e24, r:6.371e6 },
    leo:{ M:5.972e24, r:6.771e6 },
    neutron:{ M:2e30, r:1e4 }
  };

  let jrMitigationFactor = 1.0;
  let lastHasCTC = false;

  const pad = n => String(n).padStart(2,'0');
  const fmtFullLocal = d => `${d.toLocaleDateString()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const fmtFullUTC = d => d.toUTCString().replace('GMT','UTC');
  function fmtDiff(ms){
    if(!Number.isFinite(ms)) return '—';
    const sign = ms>=0?'+':'−';
    const A = Math.abs(ms);
    const d = Math.floor(A/86400000);
    const h = Math.floor((A%86400000)/3600000);
    const m = Math.floor((A%3600000)/60000);
    const s = Math.floor((A%60000)/1000);
    return `${sign}${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  function fmtHMSFromSeconds(sec){
    if(!Number.isFinite(sec)) return '—';
    const sign = sec>=0?'+':'−';
    const A = Math.abs(sec);
    const h = Math.floor(A/3600);
    const m = Math.floor((A%3600)/60);
    const s = Math.floor(A%60);
    return `${sign}${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function buildPhotons(){
    photonsLayer.innerHTML='';
    const n=30;
    for(let i=0;i<n;i++){
      const p=document.createElement('div');
      p.className='photon ' + (i%2===0?'up':'down');
      p.style.left = (18 + (i%15)*4.8) + '%';
      p.style.animationDelay = (-i*0.12)+'s';
      photonsLayer.appendChild(p);
    }
  }
  buildPhotons();

  function buildParticles(){
    orbitLayer.innerHTML='';
    const N=26;
    for(let i=0;i<N;i++){
      const dot=document.createElement('div');
      dot.className='particle';
      dot.dataset.angle0 = (i/N)*Math.PI*2;
      dot.dataset.radius = 44 + (i%13)*7;
      orbitLayer.appendChild(dot);
    }
  }
  buildParticles();

  function animateParticles(sec){
    const dots = orbitLayer.children;
    const t = performance.now()/1000;
    for(let i=0;i<dots.length;i++){
      const el=dots[i];
      const a0=Number(el.dataset.angle0);
      const r =Number(el.dataset.radius);
      const dir=i%2===0?1:-1;
      const ang=a0 + dir*(t/sec)*Math.PI*2;
      const x=Math.cos(ang)*(r+190);
      const y=Math.sin(ang)*(r/2)*0.8;
      el.style.transform=`translate(${x}px,${y}px)`;
    }
  }

  // Compute GR Jump-Rope geometry for a given mitigation factor and mode.
  function computeCTCForFactor(mNorm, mitigationFactor, mode){
    const R = 1.0;
    const k = 3;
    const eps = 0.08;

    const a0Min = 0.15;
    const a0Max = 0.70;
    const clamped = Math.max(0,Math.min(1,mNorm));
    const a0Base = a0Min + (a0Max - a0Min)*clamped;
    const a0Eff = a0Base * mitigationFactor;

    let hasCTC = false;
    let rCrit = null;

    const N = 240;
    let prevR = 0;
    let prevG = null;

    const rSamples = [];
    const gSamples = [];

    let minG = Infinity;
    let maxG = -Infinity;
    let minR = 0;

    for(let i=0;i<=N;i++){
      const r = (R * i)/N;
      let f = 0;
      if(r < R){
        const x = r/R;
        f = Math.pow(1 - Math.pow(x,k),2);
      }
      const alpha = 1 - eps * f;
      const a = a0Eff * f;

      // base GR term
      let gphiphi = alpha*alpha * r*r - a*a;

      // CST-Warp / Einstein–Cartan torsion correction:
      if(mode === 'torsion'){
        const tau0 = 0.4 * clamped;     // torsion strength depends on field
        const torsion = tau0 * f*f;     // concentrated where loop is strongest
        gphiphi += torsion;
      }

      rSamples.push(r);
      gSamples.push(gphiphi);

      if(gphiphi < minG){
        minG = gphiphi;
        minR = r;
      }
      if(gphiphi > maxG){
        maxG = gphiphi;
      }

      if(prevG !== null){
        if(prevG < 0 && gphiphi >= 0){
          const t = prevG / (prevG - gphiphi);
          rCrit = prevR + t * (r - prevR);
          hasCTC = true;
          break;
        }
      }
      prevG = gphiphi;
      prevR = r;
    }

    if(!isFinite(minG)){ minG = 0; }
    if(!isFinite(maxG)){ maxG = 0; }

    return { hasCTC, rCrit, a0Eff, rSamples, gSamples, minG, maxG, minR };
  }

  // Draw g_phiphi(r) as a polyline in SVG
  function plotGphi(rSamples, gSamples){
    while(jrPlot.firstChild) jrPlot.removeChild(jrPlot.firstChild);

    if(!rSamples || rSamples.length === 0){
      return;
    }

    const W = jrPlot.clientWidth || 260;
    const H = jrPlot.clientHeight || 120;
    jrPlot.setAttribute('viewBox', `0 0 ${W} ${H}`);

    let minG = Infinity;
    let maxG = -Infinity;
    for(const g of gSamples){
      if(g < minG) minG = g;
      if(g > maxG) maxG = g;
    }
    // include zero line
    if(minG > 0) minG = 0;
    if(maxG < 0) maxG = 0;
    if(!isFinite(minG) || !isFinite(maxG) || minG === maxG){
      minG = -1;
      maxG = 1;
    }

    const span = maxG - minG;

    // Zero line
    if(minG <= 0 && maxG >= 0){
      const y0 = H * (1 - (0 - minG)/span);
      const zeroLine = document.createElementNS('http://www.w3.org/2000/svg','line');
      zeroLine.setAttribute('x1','0');
      zeroLine.setAttribute('y1',y0);
      zeroLine.setAttribute('x2',W);
      zeroLine.setAttribute('y2',y0);
      zeroLine.setAttribute('stroke','#555e8a');
      zeroLine.setAttribute('stroke-width','1');
      zeroLine.setAttribute('stroke-dasharray','4 3');
      jrPlot.appendChild(zeroLine);
    }

    // Polyline for g_phi_phi
    let pts = '';
    for(let i=0;i<rSamples.length;i++){
      const r = rSamples[i];
      const g = gSamples[i];
      const x = (r / rSamples[rSamples.length-1]) * W;
      const y = H * (1 - (g - minG)/span);
      pts += `${x},${y} `;
    }
    const path = document.createElementNS('http://www.w3.org/2000/svg','polyline');
    path.setAttribute('points',pts.trim());
    path.setAttribute('fill','none');
    path.setAttribute('stroke','#8fb4ff');
    path.setAttribute('stroke-width','2');
    jrPlot.appendChild(path);
  }

  // Update the energy-condition meter + table
  function updateEnergyUI(minG, maxG, minR, active){
    if(!active){
      jrECMeter.textContent = 'Idle (no loop)';
      jrECTableBody.innerHTML =
        '<tr><td>min g<sub>φφ</sub></td><td>—</td></tr>' +
        '<tr><td>r at min</td><td>—</td></tr>' +
        '<tr><td>margin from 0</td><td>—</td></tr>';
      return;
    }

    const margin = minG; // distance from zero in this toy model

    let text;
    if(minG >= 0){
      let descriptor;
      if(margin > 0.5) descriptor = 'comfortable margin';
      else if(margin > 0.1) descriptor = 'moderate margin';
      else descriptor = 'narrow margin';

      text = 'SAFE — no NEC/WEC violation (' + descriptor + ')';
    } else {
      const depth = Math.abs(minG);
      let level;
      if(depth < 0.05) level = 'mild';
      else if(depth < 0.2) level = 'moderate';
      else level = 'severe';
      text = 'VIOLATING — ' + level + ' NEC/WEC breach (g_φφ dips below 0)';
    }
    jrECMeter.textContent = text;

    const fmt = x => Number.isFinite(x) ? x.toExponential(3) : '—';
    const fmtR = x => Number.isFinite(x) ? x.toFixed(3) : '—';

    jrECTableBody.innerHTML =
      '<tr><td>min g<sub>φφ</sub></td><td>' + fmt(minG) + '</td></tr>' +
      '<tr><td>r at min</td><td>' + fmtR(minR) + '</td></tr>' +
      '<tr><td>margin from 0</td><td>' + fmt(margin) + '</td></tr>';
  }

  function updateJumpRopeGeometry(mNorm){
    if(!advancedOn){
      jrA0.textContent = '—';
      jrRCrit.textContent = '—';
      jrCTCRegion.textContent = '—';
      jrExotic.textContent = '—';
      jrExotic.classList.remove('ok','bad');
      lastHasCTC = false;
      plotGphi([],[]);
      updateEnergyUI(0,0,0,false);
      return;
    }

    if(!destination || mNorm <= 0.01){
      jrA0.textContent = '0.000';
      jrRCrit.textContent = '—';
      jrCTCRegion.textContent = 'no CTC (loop below threshold)';
      jrExotic.textContent = 'NO (classically allowed)';
      jrExotic.classList.remove('bad');
      jrExotic.classList.add('ok');
      lastHasCTC = false;
      plotGphi([],[]);
      updateEnergyUI(0,0,0,false);
      return;
    }

    const result = computeCTCForFactor(mNorm, jrMitigationFactor, jrMode);
    const { hasCTC, rCrit, a0Eff, rSamples, gSamples, minG, maxG, minR } = result;

    jrA0.textContent = a0Eff.toFixed(3);
    plotGphi(rSamples, gSamples);
    updateEnergyUI(minG, maxG, minR, true);

    if(hasCTC && rCrit !== null){
      jrRCrit.textContent = rCrit.toFixed(3);
      jrCTCRegion.textContent = `0 ≤ r < ${rCrit.toFixed(3)} (CTCs)`;
      jrExotic.textContent = 'YES (NEC/WEC violated in CTC zone)';
      jrExotic.classList.remove('ok');
      jrExotic.classList.add('bad');
      lastHasCTC = true;
    } else {
      jrRCrit.textContent = '—';
      jrCTCRegion.textContent = 'no CTC (g_φφ ≥ 0)';
      jrExotic.textContent = 'NO (no macroscopic exotic core)';
      jrExotic.classList.remove('bad');
      jrExotic.classList.add('ok');
      lastHasCTC = false;
    }
  }

  function updateFieldHUD(){
    let mNorm = 0;
    let pNorm = 0;

    if(destination && Number.isFinite(initialDiff) && Math.abs(initialDiff) > 0){
      const ratio = 1 - Math.abs(lastDiffMs/initialDiff);
      const f = Math.max(0, Math.min(1, ratio));
      mNorm = 0.1 + 0.9*f;
      pNorm = mNorm * (baseTravelDuration / travelDuration);
    }

    lastMNorm = mNorm;

    reactorCore.style.height = (10 + 80*mNorm).toFixed(0) + '%';
    tmEqDisplay.innerHTML =
      `m_equiv ≈ ${mNorm.toFixed(2)}<br>` +
      `P_TM ≈ ${pNorm.toFixed(2)}`;

    updateJumpRopeGeometry(mNorm);
  }

  // Temporal stability: worldline drift and stability index
  function updateTemporalStability(){
    if(!advancedOn){
      stabDrift.textContent = '—';
      stabIndex.textContent = '—';
      stabMode.textContent = 'Advanced OFF';
      return;
    }
    if(!destination){
      stabDrift.textContent = '—';
      stabIndex.textContent = '—';
      stabMode.textContent = 'No jump set';
      return;
    }

    const dtAbs = Math.abs(lastDiffMs);
    const years = dtAbs / (86400 * 1000 * 365.25); // |Δt| in years
    // Normalize drift: ~0 for small jumps, →1 for ≳100k years in this toy model
    const driftNorm = Math.max(0, Math.min(1, years / 100000));

    const S = 1 - 0.85 * driftNorm; // stability index; 1 = locked, ~0.15 = very unstable

    let mode;
    if(driftNorm < 0.1){
      mode = 'LOCKED (Brownsville worldline anchored)';
    } else if(driftNorm < 0.5){
      mode = 'MARGINAL drift (careful navigation)';
    } else {
      mode = 'UNSTABLE (warp-like spatial motion)';
    }

    stabDrift.textContent = driftNorm.toFixed(3);
    stabIndex.textContent = S.toFixed(3);
    stabMode.textContent = mode;
  }

  function updateAdvancedPanels(){
    if(!advancedOn){
      return;
    }

    const solar = 86400;
    const sid = 86164.1;
    const perDay = solar - sid;
    sidDaily.textContent = '≈ ' + fmtHMSFromSeconds(perDay);

    if(!destination){
      srVelVal.textContent = '58.0% c';
      srGamma.textContent = '1.0000';
      srDt.textContent = '—';
      srDtPrime.textContent = '—';
      grFactor.textContent = '—';
      grDtBase.textContent = '—';
      grDtPrime.textContent = '—';
      sidAccum.textContent = '—';
      updateJumpRopeGeometry(0);
      updateTemporalStability();
      return;
    }

    if(!Number.isFinite(lastDiffMs)) lastDiffMs = 0;

    const beta = 0.58;
    const gamma = 1/Math.sqrt(1 - beta*beta);
    srVelVal.textContent = '58.0% c';
    srGamma.textContent = gamma.toFixed(4);
    srDt.textContent = fmtDiff(lastDiffMs);
    const properMs = lastDiffMs / gamma;
    srDtPrime.textContent = fmtDiff(properMs);

    const body = bodies[grBody.value] || bodies.earth;
    const factor = Math.sqrt(1 - (2*G*body.M)/(body.r*C*C));
    grFactor.textContent = isNaN(factor)?'—':factor.toExponential(6);
    grDtBase.textContent = fmtDiff(lastDiffMs);
    const grMs = lastDiffMs * factor;
    grDtPrime.textContent = fmtDiff(grMs);

    const days = Math.abs(lastDiffMs)/86400000;
    const driftSec = days*perDay;
    const signedDrift = driftSec * (lastDiffMs>=0?1:-1);
    sidAccum.textContent = fmtHMSFromSeconds(signedDrift);

    updateTemporalStability();
  }

  travelBtn.addEventListener('click',()=>{
    if(!destDT.value){ alert('Select a destination date & time.'); return; }
    destination = new Date(destDT.value);
    if(isNaN(destination)){ alert('Invalid date/time.'); return; }
    initialDiff = destination - new Date();
    travelDuration = baseTravelDuration;

    traveling = true;
    travelStart = performance.now();
    status.innerHTML = 'Status: <span class="bad">TRAVELING…</span>';

    document.documentElement.style.setProperty('--bob-amp','28px');
    document.documentElement.style.setProperty('--bob-speed','1.2s');
    document.documentElement.style.setProperty('--vibe','8');
    document.documentElement.style.setProperty('--particle-speed','1.4s');
    document.documentElement.style.setProperty('--photon-speed','0.7s');
    document.documentElement.style.setProperty('--intensity','1');
    document.documentElement.style.setProperty('--beam-color','rgba(255,82,82,.95)');
  });

  resetBtn.addEventListener('click',()=>{
    destination = null;
    traveling = false;
    initialDiff = 0;
    lastDiffMs = 0;
    lastMNorm = 0;
    jrMitigationFactor = 1.0;
    lastHasCTC = false;
    jrWarningBox.classList.add('hidden');
    jrWarningBox.textContent = '';
    jrMode = 'pure';
    jrModeSelect.value = 'pure';

    destDT.value = '';
    destClock.textContent='—';
    diffClock.textContent='—';

    grBody.value = 'earth';
    grFactor.textContent = '—';
    grDtBase.textContent = '—';
    grDtPrime.textContent = '—';
    sidAccum.textContent = '—';
    srDt.textContent = '—';
    srDtPrime.textContent = '—';
    srGamma.textContent = '1.0000';
    srVelVal.textContent = '58.0% c';

    stabDrift.textContent = '—';
    stabIndex.textContent = '—';
    stabMode.textContent = 'Reset';

    status.innerHTML = 'Status: <span class="ok">STABLE</span>';
    document.documentElement.style.setProperty('--bob-amp','10px');
    document.documentElement.style.setProperty('--bob-speed','3.6s');
    document.documentElement.style.setProperty('--vibe','1.4');
    document.documentElement.style.setProperty('--particle-speed','6s');
    document.documentElement.style.setProperty('--photon-speed','3s');
    document.documentElement.style.setProperty('--intensity','.25');
    document.documentElement.style.setProperty('--beam-color','rgba(190,245,255,.9)');

    updateAdvancedPanels();
    updateFieldHUD();
  });

  advToggle.addEventListener('click',()=>{
    advancedOn = !advancedOn;
    advToggle.textContent = advancedOn ? 'Advanced: ON' : 'Advanced: OFF';
    if(advancedOn){
      advPanel.classList.remove('hidden');
    } else {
      advPanel.classList.add('hidden');
      jrWarningBox.classList.add('hidden');
    }
    updateAdvancedPanels();
    updateJumpRopeGeometry(lastMNorm);
  });

  jrModeSelect.addEventListener('change',()=>{
    jrMode = jrModeSelect.value === 'torsion' ? 'torsion' : 'pure';
    jrWarningBox.classList.add('hidden');
    updateJumpRopeGeometry(lastMNorm);
  });

  jrWarnBtn.addEventListener('click',()=>{
    if(!advancedOn){
      jrWarningBox.textContent = 'Turn Advanced ON to see GR / CTC diagnostics.';
      jrWarningBox.classList.remove('hidden');
      return;
    }
    if(!destination){
      jrWarningBox.textContent = 'No destination is set. Geometry is idle; no CTC region to diagnose.';
      jrWarningBox.classList.remove('hidden');
      return;
    }

    if(lastHasCTC){
      jrWarningBox.textContent =
        'CTC region detected in the current mode ("' + (jrMode === "torsion" ? "CST-Warp / EC" : "Pure GR") +
        '"). In the original GR interpretation, this implies NEC/WEC violations and requires exotic matter. ' +
        'The CST-Warp / EC mode uses torsion to try to lift g_φφ(r) and shrink/remove that region.';
    } else {
      jrWarningBox.textContent =
        'No CTC region currently detected in this mode with the present CST field core and torsion settings. ' +
        'In this toy model, a macroscopic exotic core is not required at this drive level.';
    }
    jrWarningBox.classList.remove('hidden');
  });

  jrFixBtn.addEventListener('click',()=>{
    if(!advancedOn){
      jrWarningBox.textContent = 'Turn Advanced ON to run mitigation and GR recalculation.';
      jrWarningBox.classList.remove('hidden');
      return;
    }
    if(!destination){
      jrWarningBox.textContent = 'No destination set. Nothing to recalculate.';
      jrWarningBox.classList.remove('hidden');
      return;
    }

    const current = computeCTCForFactor(lastMNorm, jrMitigationFactor, jrMode);
    if(!current.hasCTC){
      jrWarningBox.textContent =
        'Recalculated geometry: no CTC region present. Mitigation factor = ' +
        jrMitigationFactor.toFixed(3) + '. No additional correction needed.';
      jrWarningBox.classList.remove('hidden');
      updateJumpRopeGeometry(lastMNorm);
      return;
    }

    let factor = jrMitigationFactor;
    let found = false;
    for(let i=0;i<16;i++){
      factor *= 0.7;
      const test = computeCTCForFactor(lastMNorm, factor, jrMode);
      if(!test.hasCTC){
        jrMitigationFactor = factor;
        found = true;
        break;
      }
    }

    if(found){
      jrWarningBox.textContent =
        'Mitigation applied: CST/torsion safety system reduced effective frame-dragging a₀ so that ' +
        'the Jump-Rope loop no longer has a CTC region in this toy model. Classical NEC/WEC violation ' +
        'in the loop core is avoided at the current drive level. Mitigation factor = ' +
        jrMitigationFactor.toFixed(3) + '.';
      jrWarningBox.classList.remove('hidden');
    } else {
      jrWarningBox.textContent =
        'Mitigation attempt could not find a CTC-free configuration without essentially turning the loop off. ' +
        'This reflects the original GR result: a strongly time-machine-like loop wants an exotic core. ' +
        'You may need to lower the jump magnitude (|Δt|) or reset.';
      jrWarningBox.classList.remove('hidden');
    }

    updateJumpRopeGeometry(lastMNorm);
  });

  function tick(){
    const now = new Date();
    utcClock.textContent = fmtFullUTC(now);
    localClock.textContent = fmtFullLocal(now);

    if(destination){
      destClock.textContent = fmtFullLocal(destination);
      let diff = destination - now;

      if(traveling){
        const e = (performance.now() - travelStart)/travelDuration;
        const p = Math.min(Math.max(e,0),1);
        const ease = p<0.5 ? 2*p*p : -1 + (4-2*p)*p;
        diff = initialDiff * (1 - ease);

        const r = Math.floor(255*(1 - ease) + 190*ease);
        const g = Math.floor(82*(1 - ease) + 245*ease);
        const b = Math.floor(82*(1 - ease) + 255*ease);
        document.documentElement.style.setProperty('--beam-color',`rgba(${r},${g},${b},.95)`);
        document.documentElement.style.setProperty('--intensity',(1 - 0.75*ease).toFixed(2));

        if(p >= 1){
          traveling = false;
          status.innerHTML = 'Status: <span class="ok">ARRIVED — STABLE</span>';
          document.documentElement.style.setProperty('--bob-amp','10px');
          document.documentElement.style.setProperty('--bob-speed','3.6s');
          document.documentElement.style.setProperty('--vibe','1.4');
          document.documentElement.style.setProperty('--particle-speed','6s');
          document.documentElement.style.setProperty('--photon-speed','3s');
          document.documentElement.style.setProperty('--intensity','.25');
          document.documentElement.style.setProperty('--beam-color','rgba(190,245,255,.9)');
          diff = 0;
        }
      }

      lastDiffMs = Number.isFinite(diff) ? diff : 0;
      diffClock.textContent = fmtDiff(lastDiffMs);
    } else {
      destClock.textContent = '—';
      diffClock.textContent = '—';
      lastDiffMs = 0;
    }

    updateAdvancedPanels();
    updateFieldHUD();

    const ps = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--particle-speed'));
    animateParticles(isNaN(ps)?6:ps);

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
