<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Warp Drive Clock Sync & Trajectory + IST Orbits (Realistic ETA + Arrival Times)</title>
  <style>
    body { background:black; color:white; font-family:Arial, sans-serif; text-align:center; margin-top:20px; }
    canvas { background:#111; border:2px solid #444; margin:20px 0; }
    table { width:90%; margin:auto; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; border:1px solid white; font-variant-numeric:tabular-nums; }
    .synced { background:#0f0; color:black; }
    .warning { background:#ff0; color:black; }
    .danger  { background:#f00; color:white; }
    button, select, input { padding:10px 15px; margin:10px; font-size:16px; border-radius:6px; border:none; cursor:pointer; }
    #startBtn { background:#00ccff; color:black; }
    #stopBtn  { background:#999;    color:white; }
    #resetBtn { background:#ff6600; color:white; }
    .cfg { width:90%; margin:0 auto 10px auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:8px; align-items:center; justify-items:center; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #555; border-radius:999px; font-size:12px; color:#9fdfff; }
    progress { width:100%; height:10px; border-radius:6px; }
    .subtle { color:#9f9f9f; font-size:12px; }
    .rowwrap { width:90%; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:start; }
    @media (max-width:980px){ .rowwrap { grid-template-columns:1fr; } }
    .legend { font-size:14px; color:#cfcfcf; margin-top:-10px; min-height:1.2em; }
    .warpLaw { width:90%; margin:0 auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:8px; align-items:center; justify-items:center; }
    .warpLaw label { font-size:14px; color:#ddd; }
  </style>
</head>
<body>

<h1>üöÄ Warp Drive Sync + Curve Visualizer</h1>
<h3>Instructions: Step 1: Select Warp Speed & planet  Step 2: Press Engage  Step 3: Click Start  Step 4: Stop any time  Step 5: Reset<br>
C1 ‚Üí Crew SAFE/WARN/UNSAFE ‚Ä¢ C2/C3 ‚Üí Flight SAFE/WARN (C4 anchor) ‚Ä¢ C5 DriftEye: internal time stability (¬±5 WARN, ¬±10 UNSAFE)</h3>

<div class="cfg">
  <div>
    <label>Warp Speed:&nbsp;
      <select id="warpSpeed">
        <option value="1">Warp 1</option><option value="2">Warp 2</option><option value="3">Warp 3</option>
        <option value="4">Warp 4</option><option value="5">Warp 5</option><option value="6">Warp 6</option>
        <option value="7">Warp 7</option><option value="8">Warp 8</option><option value="9">Warp 9</option>
        <option value="10">Warp 10</option>
      </select>
    </label>
  </div>

  <div>
    <label>Destination:&nbsp;
      <select id="destination">
        <option value="Mars">Mars</option>
        <option value="Jupiter">Jupiter</option>
        <option value="Saturn">Saturn</option>
        <option value="Pluto">Pluto</option>
      </select>
    </label>
  </div>

  <div>
    <label>IST Day 0 (years ago):&nbsp;
      <input id="istDay0Years" type="number" step="1" value="45500000000">
    </label>
  </div>

  <div>
    <label>Baseline Days / IST Year:&nbsp;
      <input id="baselineDaysPerYear" type="number" step="0.001" value="365.25">
    </label>
  </div>
</div>

<!-- Warp law controls for realistic ETA -->
<div class="warpLaw">
  <label>Warp Law Exponent (n in v = c ¬∑ warp^n):
    <input id="warpExp" type="number" step="0.1" value="3">
  </label>
  <label>Speed Scale (√óc, multiplies v):
    <input id="warpScale" type="number" step="0.1" value="1">
  </label>
</div>

<button id="startBtn">‚ñ∂Ô∏è Start</button>
<button id="stopBtn">‚è∏Ô∏è Stop</button>
<button id="resetBtn">üîÑ Engage Warp</button>
<button onclick="exportLog()">üìÑ Export Log</button>

<div class="rowwrap">
  <div>
    <canvas id="curveCanvas" width="800" height="300"></canvas>
    <div id="beacon">‚è≥ Waiting for start...</div>
  </div>

  <div>
    <canvas id="orbitCanvas" width="420" height="420"></canvas>
    <div class="legend" id="orbitLegend">‚Äî</div>
  </div>
</div>

<!-- Orbital tracker for the selected destination + Sun age -->
<table>
  <thead>
    <tr><th colspan="6">IST Orbital Tracker (Live)</th></tr>
    <tr>
      <th>Body</th><th>Age Since Creation</th><th>Orbits Completed</th>
      <th>Current Orbit</th><th>Progress</th><th>Days into Orbit / Orbit Length</th>
    </tr>
  </thead>
  <tbody id="orbit-body"></tbody>
</table>
<div class="subtle">Formation offsets (Myr after Day 0): Sun 0; Mercury 5; Venus 30; Earth 27; Mars 10; Jupiter 1; Saturn 3; Uranus 15; Neptune 20; Pluto 30.</div>

<!-- C1‚ÄìC5 table WITH Arrival CST/IST -->
<table>
  <thead>
    <tr>
      <th>Clock ID</th><th>Location</th><th>Purpose</th>
      <th>CST Time</th><th>Local Clock Time</th><th>Œî from CST (ms)</th><th>Status</th>
      <th>Arrival CST</th><th>Arrival IST</th>
    </tr>
  </thead>
  <tbody id="clock-table-body"></tbody>
</table>

<script>
  // =========================
  // Canvas + Warp Visualizer
  // =========================
  const curveCanvas = document.getElementById("curveCanvas");
  const ctx = curveCanvas.getContext("2d");

  let simulationRunning = false;
  let driftInterval = null, beaconInterval = null, orbitInterval = null, animationFrame = null;
  let shipProgress = 0, shipArrived = false;
  const startX = 100, endX = 700, baseY = 220;
  const shipCoords = { x: 0, y: 0, z: 0 };
  let velocity = [0, 0, 0];
  const log = [];

  // =========================
  // Clocks
  // =========================
  const clocks = [
    { id: "C1", location: "Biometric Zone",    purpose: "Medium Crew/Local Systems",      drift: 0 },
    { id: "C2", location: "Warp Shell Edge",   purpose: "Phase Monitor Field Timing",     drift: 3 },
    { id: "C3", location: "AI Core/NavCore",   purpose: "Critical Navigation Timing",     drift: 0 },
    { id: "C4", location: "CST Dome Earth",    purpose: "Top Priority Anchor",            drift: 0 },
    { id: "C5", location: "Mid-Bubble DriftEye",purpose:"High Diagnostics/Protection",    drift: -6 }
  ];
  function getCSTTime() { return new Date().getTime(); }
  function fmtClock(ms)  { return new Date(ms).toISOString().substr(11, 12); } // hh:mm:ss.mmm

  // =========================
  // IST Configuration & Orbits
  // =========================
  const IST_INPUT   = () => Number(document.getElementById("istDay0Years").value || 45500000000);
  const DPY_INPUT   = () => Number(document.getElementById("baselineDaysPerYear").value || 365.25);
  const WEXP_INPUT  = () => Number(document.getElementById("warpExp").value || 3);
  const WSCL_INPUT  = () => Number(document.getElementById("warpScale").value || 1);

  // Formation offsets (Myr after Day 0)
  const formationOffsetMyr = {
    Sun: 0, Mercury: 5, Venus: 30, Earth: 27, Mars: 10, Jupiter: 1, Saturn: 3, Uranus: 15, Neptune: 20, Pluto: 30
  };

  // Sidereal orbital periods (Earth days)
  const orbitalDays = {
    Mercury: 87.969, Venus: 224.701, Earth: 365.256, Mars: 686.980, Jupiter: 4332.59,
    Saturn: 10759.22, Uranus: 30685, Neptune: 60190, Pluto: 90560
  };

  // Mean heliocentric distances (AU) for simple circular, coplanar model
  const orbitAU = { Earth: 1.000, Mars: 1.524, Jupiter: 5.204, Saturn: 9.582, Pluto: 39.48 };

  // Physical constants
  const AU_M   = 1.495978707e11;    // meters
  const C_MPS  = 299792458;         // m/s

  // Age/Orbit math from IST baseline
  let tIST0 = performance.now(); // reset when IST inputs change to keep continuity
  function getISTSnapshot() {
    const dpy = DPY_INPUT();
    const spy = dpy * 86400;                      // seconds per IST year
    const elapsedISTyears = (performance.now() - tIST0) / 1000 / spy;
    const day0YearsAgo = IST_INPUT();
    const istYears = day0YearsAgo + elapsedISTyears;
    const istDays  = istYears * dpy;
    return { istYears, istDays, dpy, spy };
  }

  function planetAgeYears(name, istYears) {
    const offsetYears = (formationOffsetMyr[name] || 0) * 1_000_000;
    return Math.max(0, istYears - offsetYears);
  }

  function trueAnomalyFrac(name, istYears, dpy) {
    const pYears = planetAgeYears(name, istYears);
    const pDays  = pYears * dpy;
    const yearLen = orbitalDays[name];
    if (!yearLen) return 0;
    const totalOrbits = pDays / yearLen;
    return totalOrbits - Math.floor(totalOrbits);
  }

  function orbitsFor(name, pDays) {
    const yearLen = orbitalDays[name];
    if (!yearLen) return null;
    const totalOrbits = pDays / yearLen;
    const completed = Math.max(0, Math.floor(totalOrbits));
    const frac = totalOrbits - completed;
    const daysInto = frac * yearLen;
    return { totalOrbits, completed, frac, daysInto, yearLen };
  }

  // =========================
  // Realistic ETA (distance-based)
  // =========================
  function currentAngles(istYears, dpy) {
    const thetaEarth = trueAnomalyFrac("Earth", istYears, dpy) * Math.PI * 2;
    return thetaEarth;
  }

  function computeRealisticETASeconds() {
    const { istYears, dpy } = getISTSnapshot();
    const dest = document.getElementById("destination").value;
    const warp = parseFloat(document.getElementById("warpSpeed").value) || 1;
    const nExp = WEXP_INPUT();
    const scale = WSCL_INPUT();

    const thetaEarth = currentAngles(istYears, dpy);
    const thetaDest  = trueAnomalyFrac(dest, istYears, dpy) * Math.PI * 2;

    const r1 = orbitAU["Earth"];
    const r2 = orbitAU[dest];

    // Chord distance in AU
    const dAU = Math.sqrt(r1*r1 + r2*r2 - 2*r1*r2*Math.cos(thetaDest - thetaEarth));
    const dM  = dAU * AU_M;

    // Warp velocity
    const v   = C_MPS * scale * Math.pow(warp, nExp);
    const eta = dM / Math.max(v, 1e-6); // seconds

    return { eta, dAU };
  }

  // =========================
  // Orbital Tracker Table
  // =========================
  function updateOrbitTable() {
    const { istYears, dpy } = getISTSnapshot();
    const destination = document.getElementById("destination").value;

    const rows = [];
    // Sun age
    const sunYears = planetAgeYears("Sun", istYears);
    const sunDays = sunYears * dpy;
    rows.push({
      body: "Sun",
      age: `${(sunYears/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(sunYears).toLocaleString()} y ‚Ä¢ ${Math.floor(sunDays).toLocaleString()} d`,
      comp: "‚Äî", curr: "‚Äî", prog: "‚Äî", into: "‚Äî"
    });

    // Destination
    const pYears = planetAgeYears(destination, istYears);
    const pDays  = pYears * dpy;
    const orbits = orbitsFor(destination, pDays);
    let row;
    if (orbits) {
      const completed = orbits.completed;
      const currentOrbit = completed + 1;
      const percent = (orbits.frac*100).toFixed(2) + "%";
      row = {
        body: destination,
        age: `${(pYears/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(pYears).toLocaleString()} y ‚Ä¢ ${Math.floor(pDays).toLocaleString()} d`,
        comp: completed.toLocaleString(),
        curr: currentOrbit.toLocaleString(),
        prog: percent,
        into: `~${Math.floor(orbits.daysInto).toLocaleString()} / ${Math.floor(orbits.yearLen).toLocaleString()} d`
      };
    } else {
      row = { body: destination, age: "‚Äî", comp: "‚Äî", curr: "‚Äî", prog: "‚Äî", into: "‚Äî" };
    }

    const tbody = document.getElementById("orbit-body");
    tbody.innerHTML = `
      <tr>
        <td>${rows[0].body}</td><td>${rows[0].age}</td><td>${rows[0].comp}</td>
        <td>${rows[0].curr}</td><td>${rows[0].prog}</td><td>${rows[0].into}</td>
      </tr>
      <tr>
        <td>${row.body}</td><td>${row.age}</td><td>${row.comp}</td><td>${row.curr}</td>
        <td><div class="pill">${row.prog}</div></td><td>${row.into}</td>
      </tr>
    `;

    drawOrbitView(); // keep polar view fresh
  }

  // =========================
  // Polar Orbit View (Realistic ETA)
  // =========================
  const orbitCanvas = document.getElementById("orbitCanvas");
  const octx = orbitCanvas.getContext("2d");
  const orbitLegend = document.getElementById("orbitLegend");
  const orbitRadiiPx = { Mars:90, Jupiter:140, Saturn:180, Pluto:210 }; // visual only

  function drawOrbitView() {
    const { istYears, dpy } = getISTSnapshot();
    const dest = document.getElementById("destination").value;

    const w = orbitCanvas.width, h = orbitCanvas.height;
    const cx = w/2, cy = h/2;

    octx.clearRect(0,0,w,h);

    // Sun
    octx.beginPath();
    octx.arc(cx, cy, 10, 0, Math.PI*2);
    octx.fillStyle = "#ffaa00";
    octx.shadowColor = "#ffaa00";
    octx.shadowBlur = 12;
    octx.fill();
    octx.shadowBlur = 0;
    octx.fillStyle = "white";
    octx.fillText("Sun", cx-14, cy-16);

    // Orbits (visual)
    ["Mars","Jupiter","Saturn","Pluto"].forEach(p=>{
      const r = orbitRadiiPx[p];
      octx.beginPath();
      octx.arc(cx, cy, r, 0, Math.PI*2);
      octx.strokeStyle = p===dest ? "#ffffff" : "#555";
      octx.lineWidth = p===dest ? 2 : 1;
      octx.stroke();
      octx.fillStyle = "#aaa";
      octx.fillText(p, cx + r + 6, cy - 2);
    });

    // Now position (blue)
    const fracNow = trueAnomalyFrac(dest, istYears, dpy);
    const thetaNow = fracNow * Math.PI * 2;
    const rPx = orbitRadiiPx[dest];
    const px = cx + rPx * Math.cos(thetaNow);
    const py = cy + rPx * Math.sin(thetaNow);

    octx.beginPath();
    octx.arc(px, py, 6, 0, Math.PI*2);
    octx.fillStyle = "#00e5ff";
    octx.shadowColor = "#00e5ff";
    octx.shadowBlur = 10;
    octx.fill();
    octx.shadowBlur = 0;

    // Realistic ETA + arrival anomaly (green)
    const { eta, dAU } = computeRealisticETASeconds();
    const yearLenDays = orbitalDays[dest];
    const deltaFrac = eta / (yearLenDays * 86400);
    const thetaArrive = (thetaNow + deltaFrac * Math.PI * 2) % (Math.PI * 2);

    const ax = cx + rPx * Math.cos(thetaArrive);
    const ay = cy + rPx * Math.sin(thetaArrive);

    octx.beginPath();
    octx.arc(ax, ay, 6, 0, Math.PI*2);
    octx.fillStyle = "#00ff66"; // solid green
    octx.shadowColor = "#00ff66";
    octx.shadowBlur = 12;
    octx.fill();
    octx.shadowBlur = 0;

    // Radials
    octx.beginPath(); octx.moveTo(cx, cy); octx.lineTo(px, py);
    octx.strokeStyle = "#6aa9ff"; octx.lineWidth = 1; octx.stroke();
    octx.beginPath(); octx.moveTo(cx, cy); octx.lineTo(ax, ay);
    octx.strokeStyle = "#00ff66"; octx.lineWidth = 1.5; octx.stroke();

    // Legend
    const angleNowDeg = (thetaNow * 180 / Math.PI + 360) % 360;
    const angleArrDeg = (thetaArrive * 180 / Math.PI + 360) % 360;
    let deltaDeg = angleArrDeg - angleNowDeg; if (deltaDeg < 0) deltaDeg += 360;
    const etaStr = (eta>=3600) ? `${(eta/3600).toFixed(2)} h` : `${eta.toFixed(1)} s`;

    orbitLegend.innerHTML =
      `${dest} ‚Ä¢ Now: ${angleNowDeg.toFixed(2)}¬∞ ‚Ä¢ ETA: ${angleArrDeg.toFixed(2)}¬∞ `
      + `‚Ä¢ Œî: ${deltaDeg.toFixed(2)}¬∞ ‚Ä¢ Dist: ${dAU.toFixed(3)} AU ‚Ä¢ ETA: ${etaStr}`;
  }

  // =========================
  // Drawing & Animation (curve)
  // =========================
  function drawCurveWithShip() {
    const warp = parseInt(document.getElementById("warpSpeed").value) || 1;
    const arcHeight = 80 / warp;
    const destination = document.getElementById("destination").value;

    ctx.clearRect(0, 0, curveCanvas.width, curveCanvas.height);

    // Earth
    ctx.beginPath();
    ctx.arc(startX, baseY, 12, 0, Math.PI * 2);
    ctx.fillStyle = "blue"; ctx.fill();
    ctx.fillStyle = "white"; ctx.fillText("Earth", startX - 20, baseY + 25);

    // Destination
    ctx.beginPath();
    ctx.arc(endX, baseY, 10, 0, Math.PI * 2);
    ctx.fillStyle = "orange"; ctx.fill();
    ctx.fillStyle = "white"; ctx.fillText(destination, endX - 30, baseY + 25);

    // Arc
    ctx.beginPath();
    ctx.moveTo(startX, baseY);
    ctx.quadraticCurveTo((startX + endX) / 2, baseY - arcHeight * 3, endX, baseY);
    ctx.strokeStyle = "red"; ctx.lineWidth = 2; ctx.stroke();

    // Ship
    const t = shipProgress;
    const cxm = (startX + endX) / 2;
    const sx = (1 - t) ** 2 * startX + 2 * (1 - t) * t * cxm + t ** 2 * endX;
    const sy = (1 - t) ** 2 * baseY + 2 * (1 - t) * t * (baseY - arcHeight * 3) + t ** 2 * baseY;

    ctx.beginPath();
    ctx.arc(sx, sy, 8, 0, Math.PI * 2);
    ctx.fillStyle = shipArrived ? "lime" : "cyan";
    ctx.shadowColor = shipArrived ? "lime" : "cyan";
    ctx.shadowBlur = 10; ctx.fill(); ctx.shadowBlur = 0;
  }

  function animateShip() {
    if (!simulationRunning || shipArrived) return;
    const warp = parseInt(document.getElementById("warpSpeed").value);
    shipProgress += 0.0005 * warp;               // visual animation only
    if (shipProgress >= 1) { shipProgress = 1; shipArrived = true; stopAll(); }
    drawCurveWithShip();
    drawOrbitView(); // keep arrival marker responsive
    animationFrame = requestAnimationFrame(animateShip);
  }

  // =========================
  // Clocks / Beacon WITH Arrival CST/IST
  // =========================
  function updateClocks() {
    const tbody = document.getElementById("clock-table-body");
    tbody.innerHTML = "";
    const base = getCSTTime();

    // Compute shared ETA once for display
    const { eta } = computeRealisticETASeconds(); // seconds
    const arrivalCSTms = base + eta * 1000;

    // Arrival IST
    const { istYears, dpy, spy } = getISTSnapshot();
    const arrivalISTYears = istYears + eta / spy;
    const arrivalISTStr   = `${(arrivalISTYears/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(arrivalISTYears).toLocaleString()} y`;

    let totalDrift = 0;

    clocks.forEach(clock => {
      if (simulationRunning) clock.drift += Math.random() * 2 - 1;
      const local = base + clock.drift;
      const delta = clock.drift.toFixed(2);
      totalDrift += Math.abs(clock.drift);

      let cls = "synced", status = "‚úÖ Synced";
      if (Math.abs(clock.drift) > 5)  { cls = "warning"; status = "‚ö†Ô∏è Drift"; }
      if (Math.abs(clock.drift) > 10) { cls = "danger";  status = "‚ùå Unsafe"; }

      tbody.innerHTML += `
        <tr class="${cls}">
          <td>${clock.id}</td>
          <td>${clock.location}</td>
          <td>${clock.purpose}</td>
          <td>${fmtClock(base)}</td>
          <td>${fmtClock(local)}</td>
          <td>${delta}</td>
          <td>${status}</td>
          <td>${fmtClock(arrivalCSTms)}</td>
          <td>${arrivalISTStr}</td>
        </tr>`;
    });

    const avgDrift = totalDrift / clocks.length;
    const warp = parseInt(document.getElementById("warpSpeed").value);
    const destination = document.getElementById("destination").value;
    const safe = avgDrift < 10 / warp;

    document.getElementById("beacon").textContent =
      `üõ∞Ô∏è Warp ${warp} ‚Üí ${destination} | Avg Drift: ${avgDrift.toFixed(2)} ‚Üí ${safe ? "‚úÖ SAFE" : "‚ùå UNSAFE"} ` +
      `| ETA: ${eta >= 3600 ? (eta/3600).toFixed(2)+' h' : eta.toFixed(1)+' s'}`;

    log.push({
      time: new Date().toISOString(),
      warp, destination,
      avgDrift: avgDrift.toFixed(2),
      coords: `${shipCoords.x.toFixed(1)},${shipCoords.y.toFixed(1)},${shipCoords.z.toFixed(1)}`,
      velocity: velocity.map(v => v.toFixed(1)).join(","),
      status: safe ? "SAFE" : "UNSAFE"
    });
  }

  // =========================
  // Start/Stop/Reset
  // =========================
  function startAll() {
    if (simulationRunning) return;
    simulationRunning = true;
    shipArrived = false;
    shipProgress = 0;
    driftInterval  = setInterval(updateClocks, 500);
    beaconInterval = setInterval(() => { clocks.forEach(c => { if (c.id !== "C4") c.drift *= 0.1; }); }, 2000);
    orbitInterval  = setInterval(() => { updateOrbitTable(); drawOrbitView(); }, 500);
    animationFrame = requestAnimationFrame(animateShip);
  }
  function stopAll() {
    simulationRunning = false;
    clearInterval(driftInterval);
    clearInterval(beaconInterval);
    clearInterval(orbitInterval);
    cancelAnimationFrame(animationFrame);
  }
  function resetAll() {
    stopAll();
    shipProgress = 0; shipArrived = false;
    log.length = 0; clocks.forEach(c => c.drift = 0);
    document.getElementById("beacon").textContent = "‚è≥ Waiting for start...";
    tIST0 = performance.now(); // rebase IST when parameters change
    updateClocks(); updateOrbitTable(); drawCurveWithShip(); drawOrbitView();
  }

  function exportLog() {
    const csv = [
      ["Time","Warp","Destination","Avg Drift","Coords","Velocity","Status"],
      ...log.map(e => [e.time,e.warp,e.destination,e.avgDrift,e.coords,e.velocity,e.status])
    ].map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "warp_log.csv"; link.click();
  }

  document.getElementById("startBtn").onclick  = startAll;
  document.getElementById("stopBtn").onclick   = stopAll;
  document.getElementById("resetBtn").onclick  = resetAll;

  // Recompute when inputs change
  ["istDay0Years","baselineDaysPerYear","warpExp","warpScale","destination","warpSpeed"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      tIST0 = performance.now(); // keeps IST continuity fresh
      updateOrbitTable(); drawOrbitView(); updateClocks();
    });
  });

  window.onload = () => { updateClocks(); updateOrbitTable(); drawCurveWithShip(); drawOrbitView(); };
</script>
</body>
</html>
