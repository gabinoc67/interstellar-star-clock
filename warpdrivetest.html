<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Warp Control Center ‚Äî Compact/Responsive</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#070b12; --panel:#0c1424; --glass:#0d1a31cc; --edge:#27406b;
    --text:#eaf2ff; --muted:#a7b9df; --good:#22c55e; --warn:#facc15; --bad:#ef4444;
    --ui-scale: 1;           /* JS updates this 0.7‚Äì1.2 */
    --fs: 16px;              /* base font size (compact toggles this) */
    --pad: 12px;             /* base padding  (compact toggles this) */
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1200px 800px at 10% -10%, #112240 0%, transparent 60%),
      radial-gradient(900px 900px at 120% -20%, #0b1b33 0%, transparent 50%),
      var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    font-size:var(--fs);
  }
  .viewportScale{
    transform: scale(var(--ui-scale));
    transform-origin: top left;             /* scale from top-left */
    width: calc(100% / var(--ui-scale));    /* keep layout inside window */
  }
  .wrap{max-width:1350px;margin:0 auto;padding:var(--pad)}
  .glass{
    background:linear-gradient(180deg, #0b1528aa, #0b152880),
               radial-gradient(600px 200px at 20% -30%, #15305f55, transparent 60%);
    backdrop-filter: blur(6px);
  }
  .panel{
    border:1px solid var(--edge);border-radius:12px;padding:calc(var(--pad) - 2px);
    box-shadow:0 12px 28px rgba(0,0,0,.45)
  }
  h1,h2,h3{margin:.4rem 0}
  .grid{display:grid;gap:10px}
  .rowTop{display:grid;grid-template-columns:1.1fr 1fr 1.1fr;gap:10px}
  @media (max-width:1200px){ .rowTop{grid-template-columns:1fr} }
  .controls label{display:flex;align-items:center;gap:8px;margin:6px 0;color:var(--muted);font-size:.95rem}
  select,input[type="number"],input[type="range"]{
    background:#0b1220;color:#eaf2ff;border:1px solid #34425f;border-radius:8px;padding:6px 8px;font-size:.95rem
  }
  input[type="range"]{width:200px}
  button{background:#1b2a44;border:1px solid #304166;color:#e6eefc;padding:8px 10px;margin:4px;border-radius:8px;cursor:pointer}
  #startBtn{background:#00ccff;color:#00131a;border:none} #stopBtn{background:#64748b}
  #resetBtn{background:#fb923c;border:none} #exportBtn{background:#7c3aed;border:none}
  .lights{display:flex;gap:8px;flex-wrap:wrap}
  .light{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:.88rem}
  .dot{width:10px;height:10px;border-radius:50%}
  .good .dot{background:var(--good)} .warn .dot{background:var(--warn)} .bad .dot{background:var(--bad)}
  .meter{display:flex;align-items:center;gap:8px;margin:4px 0}
  .bar{height:10px;background:#0b1220;border:1px solid #334155;border-radius:6px;overflow:hidden;flex:1}
  .fill{height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  .stat{font-variant-numeric:tabular-nums;font-size:.88rem;color:var(--muted)}
  canvas{background:linear-gradient(180deg,#091323,#0a1322);border:1px solid #2b3a5a;border-radius:10px;max-width:100%}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #2b3a5a;padding:6px;font-size:.9rem}
  th{background:#0e1627;color:#cfe2ff}
  .pill{display:inline-block;padding:.1rem .4rem;border:1px solid #36507d;border-radius:999px;font-size:.8rem;color:#a5f3fc}
  .legend{color:var(--muted);font-size:.88rem;margin-top:6px}
  .hdrline{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .toggle{display:flex;align-items:center;gap:10px;color:#a7b9df;font-size:.9rem}
  .badge{border:1px solid #3b4f77;border-radius:999px;padding:2px 8px;color:#93c5fd;background:#0b1220}
  /* Compact mode tweaks (JS toggles .compact on <body>) */
  body.compact{
    --fs: 14px;
    --pad: 8px;
  }
  body.compact input[type="range"]{width:160px}
  body.compact button{padding:6px 8px}
</style>
</head>
<body>
<div id="root" class="viewportScale">
  <div class="wrap grid">
    <div class="hdrline">
      <h1>üöÄ Warp Control Center</h1>
      <div class="toggle">
        <label>UI Scale
          <input id="uiScale" type="range" min="70" max="120" value="95">
          <span id="uiScaleVal" class="badge">95%</span>
        </label>
        <label>Compact <input id="compact" type="checkbox" checked></label>
        <label>Engineer Mode <input id="engMode" type="checkbox"></label>
        <label>Sound <input id="soundOn" type="checkbox" checked></label>
        <span class="badge">GV Panel v2.1</span>
      </div>
    </div>

    <div class="rowTop">
      <!-- LEFT: Flight Plan -->
      <div class="panel glass">
        <h2>Flight Plan</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <label>Warp Speed
            <select id="warpSpeed">
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            </select>
          </label>
          <label>Destination
            <select id="destination"><option>Mars</option><option>Jupiter</option><option>Saturn</option><option>Pluto</option></select>
          </label>
          <label>Warp Law Exponent (n) <input id="warpExp" type="number" step="0.1" value="3"></label>
          <label>Speed Scale (√óc) <input id="warpScale" type="number" step="0.1" value="1"></label>
          <label>IST Day 0 (years ago) <input id="istDay0Years" type="number" step="1" value="45500000000"></label>
          <label>Baseline Days / IST Year <input id="baselineDaysPerYear" type="number" step="0.001" value="365.25"></label>
        </div>

        <div class="lights" id="statusLights">
          <div class="light good" id="lightBubble"><span class="dot"></span>Bubble Stability</div>
          <div class="light good" id="lightPower"><span class="dot"></span>Power Margin</div>
          <div class="light good" id="lightVector"><span class="dot"></span>Vector Balance</div>
          <div class="light good" id="lightNav"><span class="dot"></span>Nav Solution</div>
        </div>

        <div style="margin-top:6px">
          <button id="startBtn">‚ñ∂Ô∏è Start</button>
          <button id="stopBtn">‚è∏Ô∏è Stop</button>
          <button id="resetBtn">üîÑ Engage Warp</button>
          <button id="exportBtn">üìÑ Export Log</button>
        </div>
        <div class="legend" id="beacon">‚è≥ Waiting for start‚Ä¶</div>
      </div>

      <!-- CENTER: Gravity Vectoring -->
      <div class="panel glass">
        <h2>Gravity Vectoring Engine</h2>
        <div class="controls">
          <label>Reactor Output (MW) <input id="reactorMW" type="number" value="5000" step="50"></label>
          <label>Front Contraction % <input id="frontPct" type="range" min="0" max="100" value="35"><span class="stat" id="frontLbl"></span></label>
          <label>Rear Expansion % <input id="rearPct" type="range" min="0" max="100" value="65"><span class="stat" id="rearLbl"></span></label>
          <label>Left / Right Bias % <input id="lrBias" type="range" min="-50" max="50" value="0"><span class="stat" id="lrLbl"></span></label>
          <label>Up / Down Bias % <input id="udBias" type="range" min="-50" max="50" value="0"><span class="stat" id="udLbl"></span></label>
          <label>Intake Mode
            <select id="intakeMode">
              <option value="balanced">Balanced (¬±)</option>
              <option value="positive">Positive Gravity Capture</option>
              <option value="negative">Negative Gravity Capture</option>
            </select>
          </label>
        </div>

        <h3>Power Allocation</h3>
        <div class="meter"><span class="stat" style="width:140px">Field Coils</span><div class="bar"><div id="mCoils" class="fill" style="width:48%"></div></div><span class="stat" id="mCoilsVal"></span></div>
        <div class="meter"><span class="stat" style="width:140px">Vectoring Vanes</span><div class="bar"><div id="mVanes" class="fill" style="width:32%"></div></div><span class="stat" id="mVanesVal"></span></div>
        <div class="meter"><span class="stat" style="width:140px">Containment</span><div class="bar"><div id="mContain" class="fill" style="width:20%"></div></div><span class="stat" id="mContainVal"></span></div>

        <!-- Engineer Mode subpanel -->
        <div id="engPanel" style="display:none;margin-top:8px;border-top:1px solid #2b3a5a;padding-top:8px">
          <h3>Engineer Readouts</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <div class="stat" id="rdGradient">GradientFactor: ‚Äî</div>
            <div class="stat" id="rdStability">Bubble Stability: ‚Äî</div>
            <div class="stat" id="rdCoilI">Coil Current (arb): ‚Äî</div>
            <div class="stat" id="rdContain">Containment Margin: ‚Äî</div>
            <div class="stat" id="rdWall">Wall Thickness (m est.): ‚Äî</div>
            <div class="stat" id="rdNegE">Neg. Energy Density (J/m¬≥ est.): ‚Äî</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Trajectory -->
      <div class="panel glass">
        <h2>Trajectory & Field Vectors</h2>
        <canvas id="curveCanvas"></canvas>
        <div class="legend" id="curveLegend">‚Äî</div>
      </div>
    </div>

    <!-- Polar Map -->
    <div class="panel glass">
      <h2>Heliocentric Polar Map (Now vs Arrival)</h2>
      <canvas id="orbitCanvas"></canvas>
      <div class="legend" id="orbitLegend">‚Äî</div>
    </div>

    <!-- Orbit Table -->
    <div class="panel glass">
      <h2>IST Orbital Tracker (Live)</h2>
      <table>
        <thead>
          <tr><th>Body</th><th>Age Since Creation</th><th>Orbits Completed</th><th>Current Orbit</th><th>Progress</th><th>Days into Orbit / Orbit Length</th></tr>
        </thead>
        <tbody id="orbit-body"></tbody>
      </table>
      <div class="legend">Formation offsets (Myr after Day 0): Sun 0; Mercury 5; Venus 30; Earth 27; Mars 10; Jupiter 1; Saturn 3; Uranus 15; Neptune 20; Pluto 30.</div>
    </div>

    <!-- Clocks -->
    <div class="panel glass">
      <h2>Clock Sync (C1‚ÄìC5) + Arrival CST/IST</h2>
      <table>
        <thead>
          <tr>
            <th>Clock ID</th><th>Location</th><th>Purpose</th>
            <th>CST Time</th><th>Local Clock Time</th><th>Œî from CST (ms)</th><th>Status</th>
            <th>Arrival CST</th><th>Arrival IST</th>
          </tr>
        </thead>
        <tbody id="clock-table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ====== Base data & helpers (same physics as last build) ====== */
const AU_M=1.495978707e11, C_MPS=299792458;
const orbitAU={ Earth:1.0, Mars:1.524, Jupiter:5.204, Saturn:9.582, Pluto:39.48 };
const orbitalDays={ Mercury:87.969, Venus:224.701, Earth:365.256, Mars:686.980, Jupiter:4332.59, Saturn:10759.22, Uranus:30685, Neptune:60190, Pluto:90560 };
const formationOffsetMyr={ Sun:0, Mercury:5, Venus:30, Earth:27, Mars:10, Jupiter:1, Saturn:3, Uranus:15, Neptune:20, Pluto:30 };
const $=id=>document.getElementById(id);
let simulationRunning=false, shipProgress=0, shipArrived=false;
let driftInterval=null, beaconInterval=null, orbitInterval=null, animationFrame=null;
let tIST0=performance.now();

/* ====== AUDIO (optional) ====== */
let ac=null; function tone(type="good"){ if(!$("soundOn").checked) return;
  if(!ac){ try{ ac=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(!ac) return;
  const o=ac.createOscillator(), g=ac.createGain(); const f= type==="good"?880:type==="warn"?520:320;
  o.frequency.value=f; o.type="sine"; g.gain.setValueAtTime(0.001, ac.currentTime);
  g.gain.exponentialRampToValueAtTime(0.07, ac.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+0.18);
  o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.2);
}
function setLight(el,level){ const was=el.dataset.level||"good"; if(was!==level){ el.dataset.level=level; el.classList.remove("good","warn","bad"); el.classList.add(level); tone(level==="good"?"good":level==="warn"?"warn":"bad"); } }

/* ====== IST ====== */
function IST_INPUT(){ return Number($("istDay0Years").value||45500000000); }
function DPY_INPUT(){ return Number($("baselineDaysPerYear").value||365.25); }
function IST_snapshot(){
  const dpy=DPY_INPUT(), spy=dpy*86400;
  const elapsed=(performance.now()-tIST0)/1000/spy;
  const istYears=IST_INPUT()+elapsed, istDays=istYears*dpy;
  return {istYears, istDays, dpy, spy};
}
function planetAgeYears(name,iy){ return Math.max(0, iy - (formationOffsetMyr[name]||0)*1e6); }
function trueAnomalyFrac(name,iy,dpy){ const py=planetAgeYears(name,iy), pd=py*dpy, T=orbitalDays[name]; if(!T) return 0; const N=pd/T; return N-Math.floor(N); }
function orbitsFor(name,pd){ const T=orbitalDays[name]; if(!T) return null; const tot=pd/T, comp=Math.max(0,Math.floor(tot)), frac=tot-comp, daysInto=frac*T; return {totalOrbits:tot,completed:comp,frac,daysInto,yearLen:T}; }

/* ====== Warp & Engine ====== */
function warpInputs(){ return { warp:Number($("warpSpeed").value||1), exp:Number($("warpExp").value||3), scale:Number($("warpScale").value||1) }; }
function engineInputs(){
  const reactorMW=Number($("reactorMW").value||5000);
  const front=Number($("frontPct").value||0)/100, rear=Number($("rearPct").value||0)/100;
  const lr=Number($("lrBias").value||0)/100, ud=Number($("udBias").value||0)/100;
  const mode=$("intakeMode").value;

  // power split (heuristic, compact)
  const vecDemand=Math.min(1, 0.4 + 0.6*(Math.abs(lr)+Math.abs(ud)+Math.abs(rear-front)));
  const coilsPct=Math.max(0.35, 0.55 - 0.25*vecDemand);
  const containPct=Math.max(0.20, 0.25 - 0.10*(rear-front<0?1:0));
  const vanesPct=Math.min(0.35, 1 - coilsPct - containPct);

  $("mCoils").style.width=`${coilsPct*100}%`; $("mCoilsVal").textContent=`${(coilsPct*reactorMW).toFixed(0)} MW`;
  $("mVanes").style.width=`${vanesPct*100}%`; $("mVanesVal").textContent=`${(vanesPct*reactorMW).toFixed(0)} MW`;
  $("mContain").style.width=`${containPct*100}%`; $("mContainVal").textContent=`${(containPct*reactorMW).toFixed(0)} MW`;

  let stability=1.0;
  if(containPct<0.22) stability -= 0.25*(0.22-containPct)/0.22;
  const biasMag=Math.hypot(lr,ud); stability -= 0.3*Math.max(0, biasMag-0.3)/0.7;
  if(rear<front) stability -= 0.2*(front-rear);
  if(mode==="positive" && rear<front) stability -= 0.05;
  if(mode==="negative" && rear>front) stability -= 0.05;
  stability=Math.max(0,Math.min(1,stability));

  const grad=Math.max(0,(rear-front));
  const gradBoost=coilsPct*(0.5+0.5*grad);
  const gradientFactor=stability*(0.35+0.9*gradBoost);

  setLight($("lightBubble"), stability>0.75?"good":stability>0.45?"warn":"bad");
  setLight($("lightPower"), "good");
  setLight($("lightVector"), Math.hypot(lr,ud)<0.6?"good":Math.hypot(lr,ud)<0.85?"warn":"bad");

  if($("engMode").checked){
    $("engPanel").style.display="block";
    const coilI=(coilsPct*reactorMW)*5, wallM = 1/(0.25+gradientFactor)*4, containMargin=(containPct-0.22)*100, negE=-(gradientFactor*reactorMW)*1.2e3;
    $("rdGradient").textContent=`GradientFactor: ${gradientFactor.toFixed(3)}`;
    $("rdStability").textContent=`Bubble Stability: ${stability.toFixed(3)}`;
    $("rdCoilI").textContent=`Coil Current (arb): ${coilI.toFixed(0)}`;
    $("rdContain").textContent=`Containment Margin: ${containMargin.toFixed(1)}%`;
    $("rdWall").textContent=`Wall Thickness (est): ${wallM.toFixed(2)} m`;
    $("rdNegE").textContent=`Neg. Energy Density (est): ${negE.toExponential(3)} J/m¬≥`;
  } else { $("engPanel").style.display="none"; }

  $("frontLbl").textContent=Math.round(front*100)+"%";
  $("rearLbl").textContent =Math.round(rear*100)+"%";
  $("lrLbl").textContent   =Math.round(lr*100)+"%";
  $("udLbl").textContent   =Math.round(ud*100)+"%";

  return {reactorMW, front, rear, lr, ud, coilsPct, containPct, vanesPct, gradientFactor, stability, mode};
}

/* ====== ETA ====== */
function computeETASeconds(){
  const { istYears, dpy } = IST_snapshot();
  const dest=$("destination").value;
  const { warp, exp, scale } = warpInputs();
  const eng=engineInputs();

  const thE=trueAnomalyFrac("Earth",istYears,dpy)*Math.PI*2;
  const thD=trueAnomalyFrac(dest, istYears,dpy)*Math.PI*2;
  const r1=orbitAU.Earth, r2=orbitAU[dest];
  const dAU=Math.sqrt(r1*r1+r2*r2-2*r1*r2*Math.cos(thD-thE));
  const v=C_MPS*scale*Math.pow(warp,exp)*Math.max(0.05,eng.gradientFactor);
  const eta = (dAU*AU_M)/Math.max(v,1e-3);

  setLight($("lightNav"), isFinite(eta)?(eta<86400?"good":"warn"):"bad");
  return { eta, dAU, v };
}

/* ====== Orbit & Polar Map ====== */
const orbitCanvas=$("orbitCanvas"), octx=orbitCanvas.getContext("2d");
const orbitRadiiPx={Mars:130,Jupiter:185,Saturn:230,Pluto:270};
function updateOrbitTable(){
  const {istYears,dpy}=IST_snapshot(); const dest=$("destination").value;
  const sY=planetAgeYears("Sun",istYears), sD=sY*dpy;
  const pY=planetAgeYears(dest,istYears), pD=pY*dpy, o=orbitsFor(dest,pD)||{};
  $("orbit-body").innerHTML=`
    <tr><td>Sun</td><td>${(sY/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(sY).toLocaleString()} y ‚Ä¢ ${Math.floor(sD).toLocaleString()} d</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>
    <tr><td>${dest}</td><td>${(pY/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(pY).toLocaleString()} y ‚Ä¢ ${Math.floor(pD).toLocaleString()} d</td>
      <td>${o.completed!=null?o.completed.toLocaleString():"‚Äî"}</td>
      <td>${o.completed!=null?(o.completed+1).toLocaleString():"‚Äî"}</td>
      <td><span class="pill">${o.frac!=null?(o.frac*100).toFixed(2)+"%":"‚Äî"}</span></td>
      <td>${o.daysInto!=null?("~"+Math.floor(o.daysInto).toLocaleString()+" / "+Math.floor(o.yearLen).toLocaleString()+" d"):"‚Äî"}</td></tr>`;
  drawOrbitView();
}
function drawOrbitView(){
  const {istYears,dpy}=IST_snapshot(); const dest=$("destination").value;
  const w=orbitCanvas.width,h=orbitCanvas.height,cx=w/2,cy=h/2;
  octx.clearRect(0,0,w,h);
  // Sun
  octx.beginPath(); octx.arc(cx,cy,12,0,Math.PI*2); octx.fillStyle="#ffb703"; octx.shadowColor="#ffb703"; octx.shadowBlur=14; octx.fill(); octx.shadowBlur=0;
  octx.fillStyle="#cfe2ff"; octx.fillText("Sun",cx-14,cy-18);
  ["Mars","Jupiter","Saturn","Pluto"].forEach(p=>{
    const r=orbitRadiiPx[p]; octx.beginPath(); octx.arc(cx,cy,r,0,Math.PI*2);
    octx.strokeStyle=p===dest?"#ffffff":"#3c4a6a"; octx.lineWidth=p===dest?2:1; octx.stroke();
    octx.fillStyle="#98a9cc"; octx.fillText(p,cx+r+8,cy-2);
  });
  const fracNow=trueAnomalyFrac(dest,istYears,dpy), thNow=fracNow*Math.PI*2, rPx=orbitRadiiPx[dest]||200;
  const px=cx+rPx*Math.cos(thNow), py=cy+rPx*Math.sin(thNow);
  octx.beginPath(); octx.arc(px,py,6,0,Math.PI*2); octx.fillStyle="#22d3ee"; octx.shadowColor="#22d3ee"; octx.shadowBlur=10; octx.fill(); octx.shadowBlur=0;
  octx.beginPath(); octx.moveTo(cx,cy); octx.lineTo(px,py); octx.strokeStyle="#6aa9ff"; octx.lineWidth=1; octx.stroke();

  const {eta,dAU}=computeETASeconds();
  const T=orbitalDays[dest], dFrac=eta/(T*86400), thArr=(thNow+dFrac*Math.PI*2)%(Math.PI*2);
  const ax=cx+rPx*Math.cos(thArr), ay=cy+rPx*Math.sin(thArr);
  octx.beginPath(); octx.arc(ax,ay,6,0,Math.PI*2); octx.fillStyle="#22c55e"; octx.shadowColor="#22c55e"; octx.shadowBlur=12; octx.fill(); octx.shadowBlur=0;
  octx.beginPath(); octx.moveTo(cx,cy); octx.lineTo(ax,ay); octx.strokeStyle="#22c55e"; octx.lineWidth=1.5; octx.stroke();

  const degNow=(thNow*180/Math.PI+360)%360, degArr=(thArr*180/Math.PI+360)%360; let d=degArr-degNow; if(d<0)d+=360;
  $("orbitLegend").textContent=`${dest} ‚Ä¢ Now: ${degNow.toFixed(2)}¬∞ ‚Ä¢ ETA: ${degArr.toFixed(2)}¬∞ ‚Ä¢ Œî: ${d.toFixed(2)}¬∞ ‚Ä¢ Dist: ${dAU.toFixed(3)} AU`;
}

/* ====== Curve & Vectors ====== */
const curveCanvas=$("curveCanvas"), ctx=curveCanvas.getContext("2d");
let baseCurveSize={w:820,h:320}, baseOrbitSize={w:520,h:520};
function drawCurve(){
  const warp=Number($("warpSpeed").value||1); const eng=engineInputs();
  const arcHeight=90/Math.max(1, warp*(0.8+0.6*eng.stability));
  const startX=90, endX=curveCanvas.width-80, baseY=curveCanvas.height-80;

  ctx.clearRect(0,0,curveCanvas.width,curveCanvas.height);
  const dest=$("destination").value;
  // Earth & Dest
  ctx.beginPath(); ctx.arc(startX,baseY,10,0,Math.PI*2); ctx.fillStyle="#3b82f6"; ctx.fill();
  ctx.fillStyle="#cfe2ff"; ctx.fillText("Earth", startX-22, baseY+22);
  ctx.beginPath(); ctx.arc(endX,baseY,9,0,Math.PI*2); ctx.fillStyle="#f59e0b"; ctx.fill();
  ctx.fillStyle="#cfe2ff"; ctx.fillText(dest, endX-25, baseY+22);

  // Arc
  ctx.beginPath(); ctx.moveTo(startX,baseY);
  ctx.quadraticCurveTo((startX+endX)/2, baseY-arcHeight*3, endX, baseY);
  ctx.strokeStyle="#ef4444"; ctx.lineWidth=2; ctx.stroke();

  // Ship
  const t=shipProgress, mx=(startX+endX)/2, ctrlY=baseY-arcHeight*3;
  const sx=(1-t)**2*startX + 2*(1-t)*t*mx + t**2*endX;
  const sy=(1-t)**2*baseY   + 2*(1-t)*t*ctrlY + t**2*baseY;
  ctx.beginPath(); ctx.arc(sx,sy,7,0,Math.PI*2);
  ctx.fillStyle = shipArrived ? "#22c55e" : "#67e8f9"; ctx.shadowColor=ctx.fillStyle; ctx.shadowBlur=8; ctx.fill(); ctx.shadowBlur=0;

  // Vectors
  const arrow=(x,y,dx,dy,color)=>{ const L=Math.hypot(dx,dy)||1; const ux=dx/L, uy=dy/L; const ex=x+dx, ey=y+dy;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(ex,ey); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(ex,ey); ctx.lineTo(ex-6*ux+3*uy,ey-6*uy-3*ux); ctx.lineTo(ex-6*ux-3*uy,ey-6*uy+3*ux); ctx.closePath(); ctx.fillStyle=color; ctx.fill();
  };
  const f=$("frontPct").value/100, r=$("rearPct").value/100, lr=$("lrBias").value/100, ud=$("udBias").value/100;
  const k=Math.min(60, curveCanvas.height*0.18);
  arrow(sx,sy, 0,-k*r,"#22c55e"); // rear
  arrow(sx,sy, 0, k*f,"#f97316"); // front
  arrow(sx,sy, k*lr,0,"#8b5cf6"); // LR
  arrow(sx,sy, 0,-k*ud,"#38bdf8"); // UD

  $("curveLegend").textContent=`Vectors ‚Äî Rear ${Math.round(r*100)}% | Front ${Math.round(f*100)}% | LR ${Math.round(lr*100)}% | UD ${Math.round(ud*100)}%`;
}

/* ====== Animation & Clocks ====== */
function animate(){
  if(!simulationRunning || shipArrived) return;
  const {warp}=warpInputs(); const eng=engineInputs();
  const speed=Math.max(0.05,eng.gradientFactor)*Math.min(1,0.6+0.7*eng.stability);
  shipProgress += 0.00045*Math.pow(warp,0.85)*(0.8+0.6*speed);
  if(shipProgress>=1){ shipProgress=1; shipArrived=true; tone("good"); stopAll(); }
  drawCurve(); drawOrbitView(); animationFrame=requestAnimationFrame(animate);
}

const clocks=[
  { id:"C1", location:"Biometric Zone", purpose:"Medium Crew/Local Systems", drift:0 },
  { id:"C2", location:"Warp Shell Edge", purpose:"Phase Monitor Field Timing", drift:3 },
  { id:"C3", location:"AI Core/NavCore", purpose:"Critical Navigation Timing", drift:0 },
  { id:"C4", location:"CST Dome Earth", purpose:"Top Priority Anchor", drift:0 },
  { id:"C5", location:"Mid-Bubble DriftEye", purpose:"High Diagnostics/Protection", drift:-6 }
];
function fmtClock(ms){ return new Date(ms).toISOString().substr(11,12); }

const flightLog=[];
function updateClocks(){
  const tbody=$("clock-table-body"); tbody.innerHTML="";
  const base=Date.now(); const {eta,dAU,v}=computeETASeconds(); const arr=base+eta*1000;
  const {istYears,spy}=IST_snapshot(); const arrIST=istYears + eta/spy;
  const arrISTstr=`${(arrIST/1e9).toFixed(6)} Ga ‚Ä¢ ${Math.floor(arrIST).toLocaleString()} y`;

  let total=0;
  clocks.forEach(c=>{
    if(simulationRunning) c.drift += Math.random()*2 - 1;
    const local=base + c.drift; const d=c.drift.toFixed(2); total += Math.abs(c.drift);
    let cls="good", status="‚úÖ Synced"; if(Math.abs(c.drift)>5){cls="warn"; status="‚ö†Ô∏è Drift";} if(Math.abs(c.drift)>10){cls="bad"; status="‚ùå Unsafe";}
    tbody.innerHTML += `<tr class="${cls}">
      <td>${c.id}</td><td>${c.location}</td><td>${c.purpose}</td>
      <td>${fmtClock(base)}</td><td>${fmtClock(local)}</td><td>${d}</td><td>${status}</td>
      <td>${fmtClock(arr)}</td><td>${arrISTstr}</td></tr>`;
  });
  const avg=total/clocks.length;
  const warp=Number($("warpSpeed").value||1), dest=$("destination").value;
  const etaStr=eta>=3600 ? (eta/3600).toFixed(2)+" h" : eta.toFixed(1)+" s";
  $("beacon").textContent=`üõ∞Ô∏è Warp ${warp} ‚Üí ${dest} | Dist ${dAU.toFixed(3)} AU | v ${(v/C_MPS).toFixed(2)} c | ETA ${etaStr} | Avg Drift ${avg.toFixed(2)} ms`;
  flightLog.push({t:new Date().toISOString(), warp, dest, eta:etaStr, distAU:dAU.toFixed(3), vOverC:(v/C_MPS).toFixed(2)});
}

/* ====== Controls ====== */
function startAll(){
  if(simulationRunning) return;
  simulationRunning=true; shipArrived=false; shipProgress=0; tone("good");
  driftInterval=setInterval(updateClocks,500);
  beaconInterval=setInterval(()=>{ clocks.forEach(c=>{ if(c.id!=="C4") c.drift*=0.1; }); },2000);
  orbitInterval=setInterval(()=>{ updateOrbitTable(); drawOrbitView(); },600);
  animationFrame=requestAnimationFrame(animate);
}
function stopAll(){ simulationRunning=false; clearInterval(driftInterval); clearInterval(beaconInterval); clearInterval(orbitInterval); cancelAnimationFrame(animationFrame); tone("warn"); }
function resetAll(){ stopAll(); shipProgress=0; shipArrived=false; clocks.forEach(c=>c.drift=0); tIST0=performance.now();
  $("beacon").textContent="‚è≥ Waiting for start‚Ä¶"; updateClocks(); updateOrbitTable(); drawCurve(); drawOrbitView(); }
function exportLog(){ const rows=[["Time","Warp","Destination","ETA","Distance(AU)","v/c"], ...flightLog.map(e=>[e.t,e.warp,e.dest,e.eta,e.distAU,e.vOverC])];
  const csv=rows.map(r=>r.join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="warp_log.csv"; a.click(); }

/* ====== UI SCALE / COMPACT ====== */
const rootEl=document.documentElement, scaleEl=$("uiScale");
function applyScale(){
  const pct = Number(scaleEl.value||100);
  rootEl.style.setProperty('--ui-scale', (pct/100).toString());
  $("uiScaleVal").textContent = pct+"%";
  // Resize canvases pixel-accurately to avoid blur
  const s = pct/100;
  // Base sizes -> scaled
  const cw = Math.round(baseCurveSize.w * s), ch = Math.round(baseCurveSize.h * s);
  const ow = Math.round(baseOrbitSize.w * s), oh = Math.round(baseOrbitSize.h * s);
  curveCanvas.width=cw; curveCanvas.height=ch;
  orbitCanvas.width=ow; orbitCanvas.height=oh;
  drawCurve(); drawOrbitView();
}
$("compact").addEventListener("change", (e)=>{
  if(e.target.checked) document.body.classList.add("compact");
  else document.body.classList.remove("compact");
  drawCurve(); drawOrbitView();
});
scaleEl.addEventListener("input", applyScale);

/* Bindings */
$("startBtn").onclick=startAll; $("stopBtn").onclick=stopAll; $("resetBtn").onclick=resetAll; $("exportBtn").onclick=exportLog;
["warpSpeed","warpExp","warpScale","destination","istDay0Years","baselineDaysPerYear","reactorMW","frontPct","rearPct","lrBias","udBias","intakeMode","engMode","soundOn"]
  .forEach(id=> $(id).addEventListener("input", ()=>{ tIST0=performance.now(); updateClocks(); updateOrbitTable(); drawCurve(); drawOrbitView(); }));

/* Init */
window.onload=()=>{
  // Initial canvas sizes (before scaling)
  baseCurveSize={w:820,h:320}; baseOrbitSize={w:520,h:520};
  // compact by default for smaller screens
  document.body.classList.add("compact");
  // Apply initial scale
  applyScale();
  updateClocks(); updateOrbitTable(); drawCurve(); drawOrbitView();
};
</script>
</body>
</html>
