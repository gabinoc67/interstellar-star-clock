<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Word Problem Solver — Type, Upload Diagram, Step-by-Step & Print</title>
<style>
  :root{
    --bg:#0b1220;--panel:#121a2e;--ink:#e8eeff;--muted:#aab4d6;--accent:#7aa7ff;--ok:#34e6a2;--warn:#ffd166;--bad:#ff6b8b;--border:#22325e;
    --btn:#182241;--btnOp:#253268;--btnAct:#3b82f6;--card:#0f162c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1400px 900px at 70% 0%,#121a2e 0%,#0b1220 60%,#08101d 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:16px}
  h1{margin:0 0 10px;font-size:clamp(22px,3.2vw,32px)}
  p.lead{margin:0 0 16px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
  @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#121a2e,#0e1529);border:1px solid var(--border);border-radius:14px;padding:14px}
  .card h3{margin:0 0 8px;font-size:16px;color:#d9e4ff}
  textarea{width:100%;min-height:180px;border-radius:10px;border:1px solid var(--border);background:#0b1122;color:var(--ink);padding:10px 12px;font-size:15px;resize:vertical}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{border:1px solid var(--border);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.act{background:var(--btnAct)}
  .btn.op{background:var(--btnOp)}
  .muted{color:var(--muted)}
  .steps{max-height:420px;overflow:auto;line-height:1.45}
  .step{background:var(--card);border:1px dashed var(--border);padding:8px;border-radius:8px;margin:6px 0;color:#cfe1ff;white-space:pre-wrap}
  .preview{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;margin-top:8px}
  .thumb{width:220px;max-width:100%;border-radius:10px;border:1px solid var(--border);background:#0b1122;padding:6px}
  .kv{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;margin-top:6px}
  .kv strong{color:#d9e4ff}
  .sandbox{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .sandbox input{flex:1;min-width:220px;border-radius:10px;border:1px solid var(--border);background:#0b1122;color:var(--ink);padding:8px 10px}
  .printable{background:#fff;color:#111;border-radius:12px;padding:12px}
  .printable h2{margin:0 0 6px}
  .printable pre{white-space:pre-wrap}
  @media print{ .actions{display:none} .wrap{margin:0;max-width:none} .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Word Problem Solver</h1>
  <p class="lead">Write the problem (or paste text), optionally upload a diagram image, then click <b>Solve Problem</b>. You’ll get a clean step-by-step solution you can print.</p>

  <div class="grid">
    <!-- LEFT: Input -->
    <section class="card">
      <h3>1) Enter Word Problem</h3>
      <label for="problem" class="muted" style="display:block;margin-bottom:6px">Type or paste the problem here</label>
      <textarea id="problem" placeholder="Example:
A car travels at 60 mph for 2.5 hours. How far does it go?

Or:
Solve for x: 3x + 7 = 40

Or:
A right triangle has legs 6 and 8. Find the hypotenuse.
"></textarea>

      <div class="preview">
        <div>
          <h3 style="margin:8px 0 6px">2) (Optional) Upload Diagram</h3>
          <label for="file" class="muted" style="display:block;margin-bottom:6px">Attach an image for reference (PNG/JPG/WebP)</label>
          <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />
          <div class="muted" style="font-size:12px;margin-top:6px">Image appears in the steps/printout (no OCR performed).</div>
        </div>
        <img id="thumb" class="thumb" style="display:none" alt="diagram preview"/>
      </div>

      <div class="actions" aria-label="Actions">
        <button id="solveBtn" class="btn act" aria-label="Solve Problem">Solve Problem</button>
        <button id="printBtn" class="btn" aria-label="Print Step-by-Step">Print Step-by-Step</button>
        <button id="resetBtn" class="btn op" aria-label="Reset or Clear">Reset / Clear</button>
      </div>

      <div class="kv" aria-live="polite">
        <strong>Status:</strong> <span id="status" class="muted">Waiting for input…</span>
        <strong>Detected Type:</strong> <span id="ptype" class="muted">—</span>
      </div>
    </section>

    <!-- RIGHT: Steps & printable -->
    <aside class="card">
      <h3>Step-by-Step Solution</h3>
      <div id="steps" class="steps" aria-live="polite"></div>

      <h3 style="margin-top:14px">Printable Summary</h3>
      <div id="printArea" class="printable">
        <h2>Problem Solution</h2>
        <div><strong>Problem:</strong> <span id="pProblem">—</span></div>
        <div><strong>Detected Type:</strong> <span id="pType">—</span></div>
        <div><strong>Answer:</strong> <span id="pAnswer">—</span></div>
        <h3>Steps</h3>
        <pre id="pSteps">(Solve to populate this section.)</pre>
        <div id="pImgWrap" style="margin-top:8px;display:none">
          <h3>Diagram</h3>
          <img id="pImg" style="max-width:100%;border:1px solid #ddd;border-radius:8px"/>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const $ = (id) => document.getElementById(id);
  const problemEl = $('problem');
  const fileEl    = $('file');
  const thumbEl   = $('thumb');
  const solveBtn  = $('solveBtn');
  const printBtn  = $('printBtn');
  const resetBtn  = $('resetBtn');
  const stepsEl   = $('steps');
  const statusEl  = $('status');
  const ptypeEl   = $('ptype');

  // Printable refs
  const pProblem  = $('pProblem');
  const pType     = $('pType');
  const pAnswer   = $('pAnswer');
  const pSteps    = $('pSteps');
  const pImgWrap  = $('pImgWrap');
  const pImg      = $('pImg');

  let lastImageDataURL = null;

  // Image preview
  fileEl.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f){ thumbEl.style.display='none'; lastImageDataURL = null; pImgWrap.style.display='none'; return; }
    const reader = new FileReader();
    reader.onload = () => {
      lastImageDataURL = reader.result;
      thumbEl.src = reader.result; thumbEl.style.display='block';
      pImg.src = reader.result; pImgWrap.style.display='block';
    };
    reader.readAsDataURL(f);
  });

  // Reset
  resetBtn.addEventListener('click', ()=>{
    problemEl.value = '';
    fileEl.value = '';
    thumbEl.src = ''; thumbEl.style.display='none';
    lastImageDataURL = null; pImgWrap.style.display='none'; pImg.removeAttribute('src');
    stepsEl.innerHTML = '';
    statusEl.textContent = 'Cleared. Enter a new problem.';
    ptypeEl.textContent  = '—';
    // printable
    pProblem.textContent = '—';
    pType.textContent    = '—';
    pAnswer.textContent  = '—';
    pSteps.textContent   = '(Solve to populate this section.)';
  });

  // Solve
  solveBtn.addEventListener('click', ()=>{
    const text = (problemEl.value || '').trim();
    stepsEl.innerHTML = '';
    if(!text){ setStatus('Please enter a word problem to solve.', 'warn'); return; }

    let res = solveWordProblem(text);
    renderSolution(text, res);
  });

  // Print
  printBtn.addEventListener('click', ()=>{
    const html = buildPrintHtml();
    const iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    iframe.srcdoc = html;
    iframe.onload = ()=>{ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch{} setTimeout(()=>iframe.remove(), 500); };
    document.body.appendChild(iframe);
  });

  function setStatus(msg, kind=''){
    statusEl.textContent = msg;
    if(kind==='warn'){ statusEl.style.color = '#ffd166'; } else if(kind==='ok'){ statusEl.style.color='#34e6a2'; } else { statusEl.style.color=''; }
  }

  function addStep(s){ const d=document.createElement('div'); d.className='step'; d.textContent=s; stepsEl.appendChild(d); stepsEl.scrollTop = stepsEl.scrollHeight; }

  // Main solver – tries several detectors; returns {type, answer, steps[], meta}
  function solveWordProblem(text){
    const t = normalize(text);
    // Try in order from specific to general
    return detectLinearEq(t)
        || detectQuadraticStd(t)
        || detectPercent(t)
        || detectDistance(t)
        || detectPythagorean(t)
        || fallbackPlan(t);
  }

  function normalize(s){
    return s
      .replace(/[“”]/g,'"').replace(/[’]/g,"'").replace(/–|—/g,'-')
      .replace(/×/g,'*').replace(/÷/g,'/').replace(/π/g,'pi').replace(/√/g,'sqrt')
      .replace(/\s+/g,' ')
      .trim();
  }

  // -------- DETECTORS --------

  // 1) Linear equation in one variable, e.g., 3x + 7 = 40
  function detectLinearEq(t){
    // Find the first equality with x (or y)
    const eqMatch = t.match(/([-+*/^().\d\s]*[xy][^=]*)=([^=]+)/i);
    if(!eqMatch) return null;
    const left = eqMatch[1]; const right = eqMatch[2];
    // Try simple ax + b = c pattern
    const varMatch = left.match(/([+-]?\d*\.?\d*)\s*([xy])\s*([+-]\s*\d+\.?\d*)?/i);
    if(!varMatch) return null;

    const variable = (varMatch[2] || 'x');
    const aRaw = varMatch[1]; let a = (aRaw===''||aRaw==='+'||aRaw==='-') ? (aRaw==='-' ? -1 : 1) : parseFloat(aRaw);
    const b = varMatch[3] ? parseFloat(varMatch[3].replace(/\s+/g,'')) : 0;
    const c = parseFloat(right.replace(/\s+/g,''));

    if(!isFinite(a) || !isFinite(b) || !isFinite(c)) return null;

    const steps=[];
    steps.push(`Given linear equation: ${a}·${variable} ${b>=0?'+':'-'} ${Math.abs(b)} = ${c}`);
    // ax + b = c  =>  ax = c - b
    const rhs = c - b; steps.push(`Move constant to RHS: ${a}·${variable} = ${c} − ${b} = ${rhs}`);
    // x = (c - b)/a
    const x = rhs / a; steps.push(`Divide both sides by ${a}: ${variable} = ${rhs} / ${a} = ${fmt(x)}`);
    return {type:'Linear equation', answer:`${variable} = ${fmt(x)}`, steps, meta:{variable, a, b, c}};
  }

  // 2) Quadratic in standard form: ax^2 + bx + c = 0
  function detectQuadraticStd(t){
    // Look for x^2 and '= 0'
    if(!/x\s*\^\s*2|x2|x\s*\*\s*x/i.test(t)) return null;
    if(!/=\s*0\b/.test(t)) return null;

    const s = t.replace(/\s+/g,'').replace(/x\^2/g,'x2');
    const eq = s.match(/([^=]+)=0/);
    if(!eq) return null;
    const poly = eq[1];

    const a = coef(poly,'x2');
    const b = coef(poly,'x(?!\d)'); // single x
    const c = constTerm(poly);

    if([a,b,c].some(v=>!isFinite(v))) return null;
    const steps=[];
    steps.push(`Quadratic in standard form: ${a}x² + ${b}x + ${c} = 0`);
    const disc = b*b - 4*a*c; steps.push(`Discriminant: Δ = b² − 4ac = ${b}² − 4·${a}·${c} = ${fmt(disc)}`);
    if(disc < 0){ steps.push('Δ < 0 → no real roots.'); return {type:'Quadratic (standard form)', answer:'No real solution', steps, meta:{a,b,c,disc}}; }
    const sqrtD = Math.sqrt(disc); steps.push(`√Δ = ${fmt(sqrtD)}`);
    const x1 = (-b + sqrtD) / (2*a);
    const x2 = (-b - sqrtD) / (2*a);
    steps.push(`x = (−b ± √Δ) / (2a)`);
    steps.push(`x₁ = (−${b} + ${fmt(sqrtD)}) / (2·${a}) = ${fmt(x1)}`);
    steps.push(`x₂ = (−${b} − ${fmt(sqrtD)}) / (2·${a}) = ${fmt(x2)}`);
    return {type:'Quadratic (standard form)', answer:`x₁ = ${fmt(x1)}, x₂ = ${fmt(x2)}`, steps, meta:{a,b,c,disc}};
  }

  // 3) Percent & proportion
  function detectPercent(t){
    // Case A: "what is p% of n"
    let m = t.match(/(\d+(?:\.\d+)?)\s*%\s*of\s*(\d+(?:\.\d+)?)/i);
    if(m){
      const p = parseFloat(m[1]); const n = parseFloat(m[2]);
      const steps=[`Convert percent to decimal: ${p}% = ${fmt(p/100)}`, `Multiply by the base: ${fmt(p/100)} × ${n} = ${fmt((p/100)*n)}`];
      return {type:'Percent of a number', answer: fmt((p/100)*n), steps, meta:{p,n}};
    }
    // Case B: "p is q% of n"
    m = t.match(/(\d+(?:\.\d+)?)\s*is\s*(\d+(?:\.\d+)?)\s*%\s*of\s*(\d+(?:\.\d+)?)/i);
    if(m){
      const p = parseFloat(m[1]), q = parseFloat(m[2]), n = parseFloat(m[3]);
      const lhs = (q/100)*n;
      const steps=[`Compute ${q}% of ${n}: (${q}/100) × ${n} = ${fmt(lhs)}`, `Compare with stated value ${p}.`];
      return {type:'Percent statement', answer:`${fmt(p)} vs computed ${fmt(lhs)} (difference ${fmt(p-lhs)})`, steps, meta:{p,q,n}};
    }
    return null;
  }

  // 4) Distance / rate / time
  function detectDistance(t){
    // “travels at 60 mph for 2.5 hours”
    const m = t.match(/(?:at|speed\s*:\s*|speed\s*)(\d+(?:\.\d+)?)\s*(?:mph|km\/h|kph|miles per hour|kilometers per hour)?\s*(?:for|over)\s*(\d+(?:\.\d+)?)\s*(?:hours|hrs|h)/i);
    if(!m) return null;
    const v = parseFloat(m[1]), time = parseFloat(m[2]);
    const d = v * time;
    const steps=[`Use d = r × t`, `r = ${v}, t = ${time}`, `d = ${v} × ${time} = ${fmt(d)}`];
    return {type:'Distance (d = r × t)', answer:`d = ${fmt(d)}`, steps, meta:{v,time}};
  }

  // 5) Right triangle (legs → hypotenuse)
  function detectPythagorean(t){
    const m = t.match(/(?:legs?\s*|sides?\s*)(\d+(?:\.\d+)?)\D+(\d+(?:\.\d+)?)/i);
    if(!m) return null;
    const a = parseFloat(m[1]), b = parseFloat(m[2]);
    if(!isFinite(a) || !isFinite(b)) return null;
    const c2 = a*a + b*b; const c = Math.sqrt(c2);
    const steps=[`Use a² + b² = c²`, `${a}² + ${b}² = ${a*a} + ${b*b} = ${c2}`, `c = √(${c2}) = ${fmt(c)}`];
    return {type:'Right triangle (Pythagorean)', answer:`c = ${fmt(c)}`, steps, meta:{a,b,c}};
  }

  // Fallback plan when no pattern matched
  function fallbackPlan(t){
    const steps = [];
    steps.push('Could not auto-detect a specific template. Plan:');
    steps.push('1) Identify the quantity to solve for and define variables.');
    steps.push('2) Translate sentences into equations (e.g., distance, percent, mixture, linear).');
    steps.push('3) Solve the equation(s) algebraically.');
    steps.push('4) Check units and reasonableness.');
    return {type:'General plan', answer:'—', steps, meta:{}};
  }

  // -------- Helpers for quadratic parsing --------
  function coef(poly, termRegex){
    const re = new RegExp('([+-]?\\d*\\.?\\d*)'+termRegex,'i');
    const m = poly.match(re); if(!m) return 0;
    const s = m[1]; if(s==='' || s==='+') return 1; if(s==='-') return -1; return parseFloat(s);
  }
  function constTerm(poly){
    const parts = poly.replace(/([+-]?\\d*\\.?\\d*)x2/ig,'').replace(/([+-]?\\d*\\.?\\d*)x(?!\\d)/ig,'').match(/[+-]?\\d*\\.?\\d+/g);
    if(!parts) return 0;
    return parts.map(parseFloat).reduce((a,b)=>a+b,0);
  }
  function fmt(x){
    if(typeof x!=='number' || !isFinite(x)) return String(x);
    const ax = Math.abs(x);
    if(ax!==0 && (ax<1e-6 || ax>=1e9)) return x.toExponential(6);
    return Number(x.toFixed(10)).toString();
  }

  // -------- Render solution --------
  function renderSolution(text, res){
    const steps = res.steps || [];
    const header = `Detected: ${res.type}`;
    setStatus('Solved '+ (res.type || ''), 'ok');
    ptypeEl.textContent = res.type || '—';

    addStep(header);
    steps.forEach(s=> addStep('• '+s));
    if(res.answer){ addStep('Answer: '+res.answer); }

    // Printable
    pProblem.textContent = text;
    pType.textContent    = res.type || '—';
    pAnswer.textContent  = res.answer || '—';
    pSteps.textContent   = [header, ...steps, res.answer? ('Answer → '+res.answer):''].join('\n');

    if(lastImageDataURL){ pImgWrap.style.display='block'; pImg.src = lastImageDataURL; }
  }

  // -------- Printing HTML (Unicode-safe via iframe srcdoc) --------
  function buildPrintHtml(){
    const googleFonts = '<link rel="preconnect" href="https://fonts.googleapis.com">\\n<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\\n<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Noto+Sans+Math&display=swap" rel="stylesheet">';
    const styles = `
      <style>
        :root{ --mono: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; --sym: 'Noto Sans Math','Noto Sans','Segoe UI Symbol','DejaVu Sans','Arial Unicode MS', system-ui, sans-serif; }
        body{font-family:var(--sym); margin:20px; color:#111}
        h2{margin:0 0 8px}
        pre{white-space:pre-wrap;background:#f7f7f9;border:1px solid #e5e7eb;border-radius:8px;padding:12px;font-family:var(--mono)}
        .meta{margin:6px 0}
        .meta strong{display:inline-block;min-width:110px}
        img{max-width:100%;border:1px solid #e5e7eb;border-radius:8px}
      </style>`;
    const safe = (s)=> String(s||'').replace(/[&<>]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    const imgHtml = lastImageDataURL ? `<h3>Diagram</h3><img src="${lastImageDataURL}"/>` : '';
    return `<!doctype html><html><head><meta charset="utf-8">${googleFonts}${styles}</head><body>`+
           `<h2>Problem Solution</h2>`+
           `<div class="meta"><strong>Problem:</strong> ${safe(pProblem.textContent||'')}</div>`+
           `<div class="meta"><strong>Detected Type:</strong> ${safe(pType.textContent||'')}</div>`+
           `<div class="meta"><strong>Answer:</strong> ${safe(pAnswer.textContent||'')}</div>`+
           `<h3>Steps</h3><pre>${safe(pSteps.textContent||'')}</pre>`+
           imgHtml +
           `</body></html>`;
  }
});
</script>
</body>
</html>
